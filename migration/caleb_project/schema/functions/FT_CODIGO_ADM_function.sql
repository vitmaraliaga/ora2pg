-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = caleb,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION caleb.ft_codigo_adm ( V_ID_PERSONA_INSCRIPCION bigint ) RETURNS varchar AS $body$
DECLARE


p_codigo varchar(20);
p_cantidad bigint;

BEGIN
   select codigo, cantidad into STRICT p_codigo , p_cantidad
   from (
        SELECT UPPER(SUBSTR(coalesce(p.nombre,'Z') ,1,1)) || UPPER(SUBSTR(coalesce(p.paterno,'Z') ,1,1)) || to_char(clock_timestamp(),'DDMMYY') || '0' || SUBSTR(coalesce(ac.nombre,'0'),-1,1) as codigo,
            (SELECT count(pi.id_persona_inscripcion) from caleb.adm_persona_inscripcion pi inner join caleb.adm_convocatoria_det cd on pi.id_convocatoria_det=cd.id_convocatoria_det where pi.id_persona=api.id_persona and cd.id_convocatoria = ac.id_convocatoria)  as cantidad
        from caleb.adm_persona_inscripcion api
        inner join genesis.persona p on api.id_persona=p.id_persona
        inner join caleb.adm_convocatoria_det acd on api.id_convocatoria_det=acd.id_convocatoria_det
        inner join caleb.adm_convocatoria ac on acd.id_convocatoria=ac.id_convocatoria
        where api.id_persona_inscripcion = V_ID_PERSONA_INSCRIPCION
        ) alias12 LIMIT 1;

  if p_cantidad < 10 then
    p_codigo := p_codigo || '0'|| p_cantidad;
  else
    p_codigo := p_codigo || p_cantidad;
  end if;
  return p_codigo;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION caleb.ft_codigo_adm ( V_ID_PERSONA_INSCRIPCION bigint ) FROM PUBLIC;

