-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = caleb,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE caleb.pcd_actualizar_becas ( p_id_convocatoria text, p_id_convocatoria_detalle text, p_id_tipo_beca text) AS $body$
DECLARE

l_id_persona_inscripcion varchar(10);

   becas CURSOR FOR
       SELECT
		abc.ID_BECADO_CONVOCATORIA,
		abc.ID_CONVOCATORIA_DETALLE,
		abc.ID_TIPO_BECA ,
		abc.NUMERO_DOCUMENTO 
	FROM caleb.ADM_BECADO_CONVOCATORIA abc
	INNER JOIN caleb.ADM_CONVOCATORIA_DET acd ON abc.ID_CONVOCATORIA_DETALLE = acd.ID_CONVOCATORIA_DET 
	WHERE 
	acd.ID_CONVOCATORIA  = coalesce(p_id_convocatoria, acd.ID_CONVOCATORIA)
	AND abc.ID_CONVOCATORIA_DETALLE = coalesce(p_id_convocatoria_detalle, abc.ID_CONVOCATORIA_DETALLE)
	AND abc.ID_TIPO_BECA  = coalesce(p_id_tipo_beca, abc.ID_TIPO_BECA) 
	ORDER BY abc.NUMERO_DOCUMENTO;

BEGIN
	for bc in becas LOOP
		l_id_persona_inscripcion := NULL;
	   SELECT (
				SELECT  ID_PERSONA_INSCRIPCION
				FROM (
						SELECT api.ID_PERSONA_INSCRIPCION
						FROM caleb.ADM_PERSONA_INSCRIPCION api 
						INNER JOIN genesis.PERSONA_DOCUMENTO pd ON api.ID_PERSONA = pd.ID_PERSONA 
						WHERE pd.ES_ACTIVO = '1'
						AND pd.NUM_DOCUMENTO = bc.NUMERO_DOCUMENTO
						AND api.ID_CONVOCATORIA_DET = bc.ID_CONVOCATORIA_DETALLE
						ORDER BY api.ID_PERSONA_INSCRIPCION DESC
					) alias0  LIMIT 1) into STRICT l_id_persona_inscripcion
		;
		
		IF (l_id_persona_inscripcion IS NOT NULL AND l_id_persona_inscripcion::text <> '') THEN
		
			update caleb.ADM_BECADO_CONVOCATORIA set
	        ID_PERSONA_INSCRIPCION  = l_id_persona_inscripcion
	        where ID_BECADO_CONVOCATORIA = bc.ID_BECADO_CONVOCATORIA;
	
	       update caleb.ADM_PERSONA_INSCRIPCION set 
	        ID_TIPO_BECA_ESTATAL  = bc.ID_TIPO_BECA
	        where ID_PERSONA_INSCRIPCION  = l_id_persona_inscripcion;
			
	        commit;
	
		END IF;
		
		
	end LOOP;
END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE caleb.pcd_actualizar_becas ( p_id_convocatoria text, p_id_convocatoria_detalle text, p_id_tipo_beca text) FROM PUBLIC;

