-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = caleb,public;
\set ON_ERROR_STOP ON

PROCEDURE       pcd_postulante_inscrito (p_id_perosona_inscripcion integer) IS
     
   l_exist_paso number:=0;
   l_count_pasos number:=0;
   l_count_pasos_pi number:=0;
   l_id_conv_det_config varchar2(10);



BEGIN
    -- buscar el paso de pago
    select 
        nvl((select cdc.id_conv_det_config 
            from CALEB.adm_persona_inscripcion pi 
            inner join CALEB.adm_convocatoria_det cd on pi.id_convocatoria_det = cd.id_convocatoria_det
            inner join CALEB.adm_conv_det_config cdc on cd.id_convocatoria_det = cdc.id_convocatoria_det 
            where pi.id_persona_inscripcion = p_id_perosona_inscripcion
            and cdc.router = 'pay'
            and ROWNUM =1 ), '' ) INTO l_id_conv_det_config
    from dual;

    if (l_id_conv_det_config is not null) THEN


        --count de los pasos configurados como obligatorios
        select  count (DISTINCT cdc2.id_conv_det_config) into l_count_pasos
        from CALEB.adm_conv_det_config cdc
        inner join CALEB.adm_conv_det_config cdc2 on cdc.id_parent = cdc2.id_parent
        where cdc2.es_obligatorio = 'S' and cdc.id_conv_det_config = l_id_conv_det_config ;
        --pasos del postulante
        select count(pp.id_postulante_paso) into l_count_pasos_pi
        from CALEB.adm_postulante_paso pp
        inner join CALEB.adm_conv_det_config cdc on pp.id_conv_det_config = cdc.id_conv_det_config
        where cdc.es_obligatorio = 'S' AND pp.completado = 'S' and pp.id_persona_inscripcion =p_id_perosona_inscripcion ;

        if l_count_pasos=l_count_pasos_pi then
            update CALEB.adm_persona_inscripcion set estado = '1' where id_persona_inscripcion = p_id_perosona_inscripcion;
            --update CALEB.adm_postulante_paso set completado = 'S' where id_persona_inscripcion = p_id_perosona_inscripcion and id_conv_det_config = l_id_conv_det_config;
            commit;
        end if;

    end if;
END;

