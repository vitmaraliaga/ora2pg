-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_change_notes_others (id_nivel_ensenanza, semestre, id_semestre, id_carga_curso, id_carga_evaluacion, id_persona, fecha, fecha_registro, hora_registro, ip, sede, nombre_facultad, nombre_escuela, ciclo, grupo, nombre_curso, estudiante, codigo, evaluacion, nota_anterior, nota_actual, nombre_docente, registrador, usuario, id_programa_estudio) AS select distinct aca.Id_Nivel_Ensenanza,aca.SEMESTRE,aca.Id_Semestre,aca.Id_Carga_Curso,ace.Id_Carga_Evaluacion,aca.id_persona,er.Fecha_Registro fecha,
to_char(er.Fecha_Registro,'DD/MM/YYYY') FECHA_REGISTRO,
to_char(er.Fecha_Registro,'HH24:MI:SS') HORA_REGISTRO,er.ip,
aca.Sede,aca.Nombre_Facultad,aca.Nombre_Escuela,aca.Ciclo,aca.Grupo,acc.Nombre_Curso, pa.Apellido_Nombre as estudiante,pa.codigo,
nvl(nvl(ace.Descripcion,ace.Rau),Ae.Nombre) evaluacion,
er.Nota_Anterior,er.Nota_Actual,to_char(nvl(d.Nombre_Docente,'NO REGISTRADO')) Nombre_Docente,PC.Apellido_Nombre registrador,
u.email usuario,aca.ID_PROGRAMA_ESTUDIO
FROM david.vw_acad_curso_alumno aca 
inner join david.ACAD_AL_EVAL_RASTREO er on er.id_persona=aca.id_persona and er.Id_Carga_Curso=aca.Id_Carga_Curso 
inner join david.Vw_Persona_Alumno pa on pa.id_persona=aca.id_persona
inner join david.vw_acad_carga_academica acc on acc.id_carga_curso=aca.id_carga_curso and acc.origen='O' and acc.Id_tipo_contrato in (1,2,4,5)
left join david.vw_persona_comun pc on PC.id_persona=er.Id_Usuario_Reg
left join eliseo.users u on u.id=PC.id_persona
left join david.Acad_Carga_Evaluacion ace on ace.Id_Carga_Evaluacion=er.Id_Carga_Evaluacion
left join david.Acad_Estrategia ae on Ae.Id_Estrategia=ace.Id_Estrategia
LEFT JOIN (select accd.Id_Carga_Curso,WM_CONCAT( DISTINCT PC.APELLIDO_NOMBRE) nombre_docente
            from david.acad_carga_curso_docente accd INNER JOIN david.VW_PERSONA_COMUN PC ON PC.ID_PERSONA= accd.id_PERSONA
            GROUP BY accd.Id_Carga_Curso) d on d.id_carga_curso=aca.id_carga_curso
where not Exists (select 1 from david.acad_carga_curso acc inner join david.acad_carga_curso_docente accd on accd.id_carga_curso=acc.id_carga_curso
                  where acc.id_carga_curso=aca.id_carga_curso and accd.id_persona=er.Id_Usuario_Reg);

