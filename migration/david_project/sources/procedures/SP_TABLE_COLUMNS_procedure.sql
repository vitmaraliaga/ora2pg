-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

PROCEDURE       SP_TABLE_COLUMNS (P_SCHEMA VARCHAR2, P_COLUMN VARCHAR2, P_VALOR VARCHAR2, CURSOR OUT SYS_REFCURSOR)IS
    L_SCHEMA VARCHAR2(50); 
    L_TABLE VARCHAR2(50);
    L_COLUMN VARCHAR2(50); 
    L_CANT NUMBER;
    P_SQL_STMT VARCHAR2(500);
    
    CURSOR C_TABLES IS
    SELECT OWNER,TABLE_NAME, COLUMN_NAME
    FROM ALL_TAB_COLUMNS A
    WHERE TABLE_NAME NOT IN (SELECT VIEW_NAME FROM USER_VIEWS)
    AND COLUMN_NAME = UPPER (P_COLUMN)
    AND TABLE_NAME NOT IN 'BIN$v3XaQc2vhk/gQKjAcA1FLg==$0'
    AND OWNER = P_SCHEMA;

BEGIN
    DELETE FROM TT_TABLES;
    OPEN C_TABLES;
        FETCH C_TABLES INTO L_SCHEMA,L_TABLE,L_COLUMN;
            WHILE C_TABLES%FOUND LOOP
                P_SQL_STMT := 'SELECT COUNT(*) ';
                P_SQL_STMT := P_SQL_STMT || ' FROM '||L_SCHEMA||'.'||L_TABLE;
                P_SQL_STMT := P_SQL_STMT || ' WHERE '||L_COLUMN;
                P_SQL_STMT := P_SQL_STMT ||' = '||P_VALOR;
                P_SQL_STMT := REPLACE(P_SQL_STMT,'"',CHR(39));
                EXECUTE IMMEDIATE P_SQL_STMT INTO L_CANT ;
                IF L_CANT > 0 THEN
                    INSERT INTO TT_TABLES(SCHEMAS,TABLA,COLUMNA,VALOR,CANTIDAD)VALUES(L_SCHEMA,L_TABLE,L_COLUMN,P_VALOR,L_CANT);
                END IF;
            FETCH C_TABLES INTO L_SCHEMA,L_TABLE,L_COLUMN;
            END LOOP;
    CLOSE C_TABLES;
 
    OPEN CURSOR FOR 
    SELECT * FROM TT_TABLES;
END;

