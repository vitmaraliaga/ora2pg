-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure pcd_ins_temp_perc_docente ( pval in integer) AS 

begin 

  EXECUTE IMMEDIATE 'truncate table aatemp_percepcion_docente';
    commit; 
    
  INSERT INTO aatemp_percepcion_docente
    SELECT
    b.fecha_prog ,
    b.hora_prog,
    b.fecha_hasta,
    b.hora_hasta,
    b.ID_ASISTENCIA_CARGA,
    b.SEMESTRE ,
    b.docente,
    b.promedio,
    b.ID_CARGA_CURSO_DOCENTE ,
    b.ID_PROGRAMA_ESTUDIO ,
    b.id_sede,
    b.ID_UNIDAD_ACADEMICA ,
    b.ID_NIVEL_ENSENANZA,
    b.id_tipo_contrato,
    b.nombre_curso,
    b.ciclo,
    b.grupo,
    b.poblacion_esperada,
    count(ed2.id_asistencia_carga)  as poblacion_real,
    b.fecha_inicio ,
    b.fecha_fin
    FROM (
    SELECT a.fecha_prog,
    a.hora_prog,
    a.fecha_hasta,
    a.hora_hasta,
    a.id_asistencia_carga,
    a.semestre,
    a.docente,
    a.promedio,
    a.id_carga_curso_docente,
    a.id_programa_estudio,
    a.id_sede,
    a.id_unidad_academica,
    a.id_nivel_ensenanza,
    a.id_tipo_contrato,
    a.nombre_curso,
    a.ciclo,
    a.grupo,
    count(aca2.ID_CURSO_ALUMNO) AS poblacion_esperada ,
    a.fecha_inicio,
    a.fecha_fin
    FROM (
        SELECT
        to_char(ed.fecha,'DD/MM/YYYY') AS fecha_prog,
        to_char(pac.DESDE_PROG,'HH24:MI') AS hora_prog,
        to_char(pac.HASTA_PROG ,'DD/MM/YYYY') AS fecha_hasta,
        to_char(pac.HASTA_PROG ,'HH24:MI') AS hora_hasta,
        ed.id_asistencia_carga,
        vaca.SEMESTRE ,
        pe.PATERNO || ' ' || pe.MATERNO ||' ' || pe.NOMBRE AS docente,
        ed.ID_CARGA_CURSO_DOCENTE , round(avg(ir.VALOR_RESPUESTA)) AS promedio ,
        vaca.ID_PROGRAMA_ESTUDIO ,
        vaca.ID_SEDE ,
        vaca.ID_UNIDAD_ACADEMICA ,
        vaca.ID_NIVEL_ENSENANZA ,
        vaca.id_tipo_contrato,
        vaca.nombre_curso,
        vaca.ciclo,
        vaca.grupo,
        ed.fecha  AS fecha_inicio,
        pac.HASTA_PROG  AS fecha_fin
        FROM EVALUACION_DIARIA ed
        INNER JOIN acad_curso_alumno aca ON aca.ID_CURSO_ALUMNO =ed.ID_CURSO_ALUMNO
        INNER JOIN  lucas.INSTRUMENTO_CUESTIONARIO ic ON ed.ID_CUESTIONARIO = ic.ID_CUESTIONARIO
        INNER JOIN lucas.INSTRUMENTO_RESPUESTA ir ON ir.ID_CUESTIONARIO =ic.ID_CUESTIONARIO
        INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE =ed.ID_CARGA_CURSO_DOCENTE
        INNER JOIN moises.persona pe ON pe.ID_PERSONA =accd.ID_PERSONA
        INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO = accd.ID_CARGA_CURSO
        INNER JOIN enoc.PLLA_ASISTENCIA_CARGA pac ON pac.ID_ASISTENCIA_CARGA = ed.ID_ASISTENCIA_CARGA
        AND vaca.ORIGEN ='O'
        WHERE ir.VALOR_RESPUESTA IS NOT NULL
        AND vaca.SEMESTRE ='2023-2'
        and vaca.id_sede = nvl('',vaca.id_sede)
        and vaca.id_nivel_ensenanza = nvl('',vaca.id_nivel_ensenanza)
        and vaca.id_tipo_contrato = nvl('',vaca.id_tipo_contrato)
        and vaca.id_unidad_academica = nvl('',vaca.id_unidad_academica)
        and vaca.id_programa_estudio = nvl('',vaca.id_programa_estudio)
        GROUP BY to_char(ed.fecha,'DD/MM/YYYY') ,
        to_char(pac.DESDE_PROG,'HH24:MI') ,
        to_char(pac.HASTA_PROG ,'DD/MM/YYYY') ,
        to_char(pac.HASTA_PROG ,'HH24:MI') ,
        ED.ID_ASISTENCIA_CARGA,
        vaca.SEMESTRE ,
        pe.PATERNO || ' ' || pe.MATERNO ||' ' || pe.NOMBRE  ,
        ed.ID_CARGA_CURSO_DOCENTE ,
        vaca.ID_PROGRAMA_ESTUDIO ,
        vaca.id_sede,
        vaca.ID_UNIDAD_ACADEMICA ,
        vaca.ID_NIVEL_ENSENANZA,
        vaca.id_tipo_contrato,
        vaca.nombre_curso,
        vaca.ciclo,
        vaca.grupo,
        ed.fecha,
        pac.HASTA_PROG
        ORDER BY 1,2,3
    ) a
    INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd2 ON accd2.ID_CARGA_CURSO_DOCENTE =a.id_carga_curso_docente
    INNER JOIN david.ACAD_CARGA_CURSO acc ON acc.ID_CARGA_CURSO =accd2.ID_CARGA_CURSO
    INNER JOIN david.ACAD_CURSO_ALUMNO aca2 ON aca2.ID_CARGA_CURSO =acc.ID_CARGA_CURSO
    AND aca2.ESTADO ='1'
    GROUP BY
    a.fecha_prog ,
    a.hora_prog,
    a.fecha_hasta,
    a.hora_hasta,
    a.ID_ASISTENCIA_CARGA,
    a.SEMESTRE ,
    a.docente,
    a.promedio,
    a.ID_CARGA_CURSO_DOCENTE ,
    a.ID_PROGRAMA_ESTUDIO ,
    a.id_sede,
    a.ID_UNIDAD_ACADEMICA ,
    a.ID_NIVEL_ENSENANZA,
    a.id_tipo_contrato,
    a.nombre_curso,
    a.ciclo,
    a.grupo,
    a.fecha_inicio,
    a.fecha_fin
    )
b
INNER JOIN david.EVALUACION_DIARIA ed2
ON ed2.ID_CARGA_CURSO_DOCENTE =b.id_carga_curso_docente
AND ed2.ID_ASISTENCIA_CARGA = b.id_asistencia_carga
INNER JOIN lucas.INSTRUMENTO_CUESTIONARIO ic2 ON ic2.ID_CUESTIONARIO =ed2.ID_CUESTIONARIO
AND ic2.ID_ESTADO_EVALUACION = 3
GROUP BY
b.fecha_prog ,
    b.hora_prog,
    b.fecha_hasta,
    b.hora_hasta,
    b.ID_ASISTENCIA_CARGA,
    b.SEMESTRE ,
    b.docente,
    b.promedio,
    b.ID_CARGA_CURSO_DOCENTE ,
    b.ID_PROGRAMA_ESTUDIO ,
    b.id_sede,
    b.ID_UNIDAD_ACADEMICA ,
    b.ID_NIVEL_ENSENANZA,
    b.id_tipo_contrato,
    b.nombre_curso,
    b.ciclo,
    b.grupo,
    b.poblacion_esperada,
    b.fecha_inicio,
    b.fecha_fin
    ORDER BY 1 desc,2 DESC;
    COMMIT;

end;

