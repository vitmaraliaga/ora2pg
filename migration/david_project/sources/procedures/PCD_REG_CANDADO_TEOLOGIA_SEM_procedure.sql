-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure pcd_reg_candado_teologia_sem(v_id_semestre integer)
is
begin

  insert into acad_candado(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
  select id_persona,67,v_id_semestre,'Bloqueo por cese de estudias por 2 ciclos acad√©micos',1,247620,sysdate
  from vw_acad_alumno_contrato  aac inner join Vw_Acad_Programa_Estudio ape on Ape.Id_Programa_Estudio=Aac.Id_Programa_Estudio 
  where aac.estado='1' and ape.Id_escuela in (221,220,223,224,222,112)
  and not Exists ( select 1
                  from vw_acad_alumno_contrato  aac2 inner join Vw_Acad_Programa_Estudio ape on Ape.Id_Programa_Estudio=Aac2.Id_Programa_Estudio 
                  inner join (select asm.id_semestre,asm.semestre,Asm.Id_Semestre_Ant,Asm.Semestre_Ant,
                              Asm2.Id_Semestre_Ant Id_Semestre_Ant_Ant,Asm2.Semestre_Ant Semestre_Ant_Ant
                              from acad_semestre asm inner join acad_semestre asm2 on Asm2.Id_Semestre=Asm.Id_Semestre_Ant
                              where asm.id_semestre=v_id_semestre) rr on aac2.Id_Semestre in (Rr.Id_Semestre_Ant,Rr.Id_Semestre_Ant_Ant)
                  where aac2.estado='1' and ape.Id_escuela in (221,220,223,224,222,112)
                  and Aac2.Id_Persona=Aac.Id_Persona and Aac2.Id_Plan_Programa=Aac.Id_Plan_Programa and Aac2.Id_Semestre=Aac.Id_Semestre)
  and not Exists (select 1 
                  from MOISES.Persona_Natural_Egresado pne inner join vw_plan_programa pp on Pp.Id_Plan_Programa=Pne.Id_Plan_Programa
                  where Pp.Id_escuela in (221,220,223,224,222,112)
                  and pne.id_persona=aac.id_persona)
  and not Exists (select 1 from acad_candado where id_tipo_candado=67 and id_semestre=v_id_semestre and id_persona=aac.id_persona)
  and Exists(select 1 from Vw_Alumno_Plan_Programa
            where Id_escuela in (221,220,223,224,222,112) and estado=1
            and id_persona=aac.id_persona and id_plan_programa=aac.id_plan_programa)
  group by id_persona;

  commit;

end;

