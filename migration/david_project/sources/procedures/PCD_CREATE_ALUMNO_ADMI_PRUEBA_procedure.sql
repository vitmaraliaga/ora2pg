-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure       pcd_create_alumno_admi_prueba(
  V_ID_TIPO_DOCUMENTO integer, 
  V_NUM_DOCUMENTO in varchar2,
  V_NOMBRE in varchar2,
  V_PATERNO in varchar2,
  V_MATERNO in varchar2,
  V_ESTADO_CIVIL in varchar2,
  V_NACIONALIDAD in varchar2,
  V_UBIGEO integer,
  V_COD_RELIGION in varchar2,
  V_SEXO in varchar2,
  V_FECHA_NACIMIENTO date,
  V_CELULAR in varchar2,
  V_CORREO in varchar2,
  V_ID_PLAN_PROGRAMA integer,
  V_ID_TIPO_BECA_ESTATAL integer
)
 is
 
    p_id_persona integer;
    p_res_id_persona integer;
    p_res_persona_documento integer;
    p_res_persona_natural integer;
    p_res_persona_alumno integer;
    p_res_codigo integer;
    p_res_user integer;
    p_id_nivel_ensenanza integer;
    p_codigo_universitario varchar2(20);
    p_res varchar2(1);
    l_contar number:=0;
    l_code varchar2(200);
    l_error varchar2(200);

begin

p_id_persona:=0;

select nvl((select id_persona from moises.persona_documento where Num_Documento=v_num_documento),0) into p_id_persona from dual;

if(p_id_persona=0) then

  select nvl((select id_persona from moises.persona where upper(sintilde(nombre||' '||paterno||' '||materno))=upper(sintilde(v_nombre||' '||v_paterno||' '||v_materno))),0) into p_id_persona from dual;
  
  if(p_id_persona=0) then
    p_res_id_persona:=0;
  else
    p_res_id_persona:=1;
  end if;
  
else

  p_res_id_persona:=1;
  
end if;

if(p_res_id_persona=0) then

  insert into moises.persona(id_persona,Nombre,paterno,materno)
          VALUES((select max(id_persona)+1 from moises.persona),v_nombre,v_paterno,v_materno)
  returning id_persona into p_id_persona;
  
  insert into moises.persona_documento(id_persona,id_tipodocumento,num_documento,es_activo)
          VALUES(p_id_persona,v_id_tipo_documento,v_num_documento,1);
          
  insert into moises.persona_natural (id_persona,id_tipotratamiento,id_tipoestadocivil,id_tipopais,id_ubigeo,id_tiporeligion,id_tipodocumento,num_documento,sexo,fec_nacimiento,celular,correo,id_nacionalidad)
          VALUES(p_id_persona,1,
                  (select id_tipoestadocivil from moises.tipo_estado_civil where nombre_corto=v_estado_civil),
                  (select id_tipopais from moises.tipo_pais where iso_a2=v_nacionalidad),
                  (select id_ubigeo from moises.ubigueo where depto=substr(v_ubigeo,0,2) and pvcia=substr(v_ubigeo,3,2) and ditto=substr(v_ubigeo,-2)),
                  (select id_tiporeligion from moises.tipo_religion where codigo=v_cod_religion),
                  v_id_tipo_documento,v_num_documento,
                  (select sexo from moises.tipo_sexo where codigo=v_sexo),
                  v_fecha_nacimiento,v_celular,v_correo,
                  (select id_tipopais from moises.tipo_pais where iso_a2=v_nacionalidad));
                  
  select ft_max_codigo(1) into p_codigo_universitario from dual;
  
  insert into moises.persona_natural_alumno (id_persona,codigo)
          VALUES(p_id_persona,p_codigo_universitario);

  insert into acad_alumno_plan(id_persona,id_plan_programa,estado,id_usuario_reg,fecha_registro)
          VALUES(p_id_persona,v_id_plan_programa,1,5,SYSDATE);
  
  insert into eliseo.users(ID,EMAIL,CONTRASENHA,NAME,ID_PERFIL,FECHA_CREATE)
          VALUES(p_id_persona,ft_newformat_users(p_id_persona),'3ca413e61535cf2017496b87412aa332072053f8',v_nombre||' '||v_paterno||' '||v_materno,2,SYSDATE);
  
  insert into eliseo.conta_entidad_usuario(ID_ENTIDAD,ID_PERSONA,ESTADO)
          VALUES(7124,p_id_persona,1);
  
  insert into eliseo.LAMB_USERS_DEPTO(ID,ID_ENTIDAD,ID_DEPTO,ESTADO,ACTIVO)
          VALUES(p_id_persona,7124,(select decode(id_sede,2,5,3,6,1) from Vw_Alumno_Plan_Programa where id_persona=p_id_persona),1,1);
  
  insert into eliseo.LAMB_USUARIO_ROL(ID_ROL,ID_PERSONA,ID_ENTIDAD)
          VALUES(44,p_id_persona,7124);
  
   p_res:='S';
    
else

  select nvl((select Distinct 1 from moises.persona_documento where id_persona=p_id_persona),0) into p_res_persona_documento from dual;
  
  if(p_res_persona_documento=0) then
    insert into moises.persona_documento(id_persona,id_tipodocumento,num_documento,es_activo)
            VALUES(p_id_persona,v_id_tipo_documento,v_num_documento,1);
  else
    update moises.persona_documento 
      set id_tipodocumento=v_id_tipo_documento,num_documento=v_num_documento,es_activo=1
    where id_persona=p_id_persona;
  end if;
  
  select nvl((select Distinct 1 from moises.persona_natural where id_persona=p_id_persona),0) into p_res_persona_natural from dual;
  
  if(p_res_persona_natural=0) then
  
    insert into moises.persona_natural (id_persona,id_tipotratamiento,id_tipoestadocivil,id_tipopais,id_ubigeo,id_tiporeligion,id_tipodocumento,num_documento,sexo,fec_nacimiento,celular,correo,id_nacionalidad)
            VALUES(p_id_persona,1,
                    (select id_tipoestadocivil from moises.tipo_estado_civil where nombre_corto=v_estado_civil),
                    (select id_tipopais from moises.tipo_pais where iso_a2=v_nacionalidad),
                    (select id_ubigeo from moises.ubigueo where depto=substr(v_ubigeo,0,2) and pvcia=substr(v_ubigeo,3,2) and ditto=substr(v_ubigeo,-2)),
                    (select id_tiporeligion from moises.tipo_religion where codigo=v_cod_religion),
                    v_id_tipo_documento,v_num_documento,
                    (select sexo from moises.tipo_sexo where codigo=v_sexo),
                    v_fecha_nacimiento,v_celular,v_correo,
                    (select id_tipopais from moises.tipo_pais where iso_a2=v_nacionalidad));
                    
    select ft_max_codigo(1) into p_codigo_universitario from dual;
    
    insert into moises.persona_natural_alumno (id_persona,codigo)
            VALUES(p_id_persona,p_codigo_universitario);
  
    insert into acad_alumno_plan(id_persona,id_plan_programa,estado,id_usuario_reg,fecha_registro)
            VALUES(p_id_persona,v_id_plan_programa,1,5,SYSDATE);
            
  else
  
    update moises.persona_natural 
    set id_tipotratamiento=1,
    id_tipoestadocivil=(select id_tipoestadocivil from moises.tipo_estado_civil where nombre_corto=v_estado_civil),
    id_tipopais=(select id_tipopais from moises.tipo_pais where iso_a2=v_nacionalidad),
    id_ubigeo=(select id_ubigeo from moises.ubigueo where depto=substr(v_ubigeo,0,2) and pvcia=substr(v_ubigeo,3,2) and ditto=substr(v_ubigeo,-2)),
    id_tiporeligion=(select id_tiporeligion from moises.tipo_religion where codigo=v_cod_religion),
    id_tipodocumento=v_id_tipo_documento,num_documento=v_num_documento,
    sexo=(select sexo from moises.tipo_sexo where codigo=v_sexo),
    fec_nacimiento=v_fecha_nacimiento,
    celular=v_celular,correo=v_correo,
    id_nacionalidad=(select id_tipopais from moises.tipo_pais where iso_a2=v_nacionalidad)
    where id_persona=p_id_persona;
    
    select nvl((select Distinct 1 from moises.persona_natural_alumno where id_persona=p_id_persona),0) into p_res_persona_alumno from dual;
    
    if(p_res_persona_alumno=0) then
    
      select ft_max_codigo(1) into p_codigo_universitario from dual;
      
      insert into moises.persona_natural_alumno (id_persona,codigo)
              VALUES(p_id_persona,p_codigo_universitario);
    
      insert into acad_alumno_plan(id_persona,id_plan_programa,estado,id_usuario_reg,fecha_registro)
              VALUES(p_id_persona,v_id_plan_programa,1,5,SYSDATE);
    
    else
    
      select nvl((select IS_NUMBER(codigo) from moises.persona_natural_alumno where id_persona=p_id_persona),0) into p_res_codigo from dual;
      
        if(p_res_codigo=0) then
        
          select ft_max_codigo(1) into p_codigo_universitario from dual;
          update moises.persona_natural_alumno set codigo=p_codigo_universitario where id_persona=p_id_persona;
          
        end if;
        
      select Ape.Id_Nivel_Ensenanza into p_id_nivel_ensenanza from acad_Plan_Programa app inner join Acad_Programa_Estudio ape on Ape.Id_Programa_Estudio=App.Id_Programa_Estudio where Id_Plan_Programa=v_id_plan_programa;
      
      update Acad_Alumno_Plan 
      set estado=0, id_usuario_act=5, fecha_actualizacion=sysdate
      where estado='1' and 
      (id_persona,id_plan_programa) in (select id_persona,id_plan_programa from Vw_Alumno_Plan_Programa where id_persona=p_id_persona and Id_Nivel_Ensenanza=p_id_nivel_ensenanza);
      
      update Acad_Alumno_Plan
      set estado=1, id_usuario_act=5, fecha_actualizacion=sysdate
      where estado='0' and 
      id_persona=p_id_persona and id_plan_programa=v_id_plan_programa;
      
      insert into acad_alumno_plan(id_persona,id_plan_programa,estado,id_usuario_reg,fecha_registro)
      select p_id_persona,v_id_plan_programa,1,5,SYSDATE from dual
      where (p_id_persona,v_id_plan_programa) not in (select id_persona,id_plan_programa from Vw_Alumno_Plan_Programa where id_persona=p_id_persona and Id_Nivel_Ensenanza=p_id_nivel_ensenanza);
      
    
    end if;
  
  end if;
  
  select nvl((select id from eliseo.users where id=p_id_persona),0) into p_res_user from dual;
  
  if(p_res_user=0) then
  
    p_res:='S';
  
    insert into eliseo.users(ID,EMAIL,CONTRASENHA,NAME,ID_PERFIL,FECHA_CREATE)
          VALUES(p_id_persona,ft_newformat_users(p_id_persona),'3ca413e61535cf2017496b87412aa332072053f8',v_nombre||' '||v_paterno||' '||v_materno,2,SYSDATE);
      
  else
  
    p_res:='N';
  
  end if;
  
  insert into eliseo.conta_entidad_usuario(ID_ENTIDAD,ID_PERSONA,ESTADO)
    select 7124,p_id_persona,1
    from dual
    where p_id_persona not in (select id_persona from eliseo.conta_entidad_usuario where ID_PERSONA=p_id_persona and ID_ENTIDAD=7124);
    
  
  update eliseo.LAMB_USERS_DEPTO set estado='0' where id=p_id_persona;
  
  update eliseo.LAMB_USERS_DEPTO set estado='1' where id=p_id_persona and ID_DEPTO=(select min(decode(id_sede,2,5,3,6,1)) from Vw_Alumno_Plan_Programa where id_persona=p_id_persona and estado='1');
  
  insert into eliseo.LAMB_USERS_DEPTO(ID,ID_ENTIDAD,ID_DEPTO,ESTADO,ACTIVO)
    select p_id_persona,7124,(select decode(id_sede,2,5,3,6,1) from Vw_Alumno_Plan_Programa where id_persona=p_id_persona),1,1
    from dual
    where p_id_persona not in (select id from eliseo.users where id=p_id_persona);
  
  insert into eliseo.LAMB_USUARIO_ROL(ID_ROL,ID_PERSONA,ID_ENTIDAD)
    select 44,p_id_persona,7124
    from dual
    where p_id_persona not in (select id_persona from eliseo.LAMB_USUARIO_ROL where ID_PERSONA=p_id_persona and ID_ROL=44 and ID_ENTIDAD=7124);    

end if;

if(v_id_tipo_beca_estatal is not null) then
  insert into ACAD_ALUMNO_BECA (ID_PERSONA,ID_TIPO_REQUISITO_BECA,ID_TIPO_BECA_ESTATAL,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select p_id_persona,33,v_id_tipo_beca_estatal,1,5,SYSDATE
    from dual
    where p_id_persona not in (select id_persona from ACAD_ALUMNO_BECA where ID_PERSONA=p_id_persona);
end if;

commit;


end;

