-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure pcd_reg_alum_matri(val integer) is

v_id_semestre integer;

begin 

SELECT MAX(ID_SEMESTRE) into v_id_semestre
FROM DAVID.ACAD_SEMESTRE WHERE ESTADO_ADVISER=1;
  
    insert into Aatemp_Alumnos_Matriculados (ID_PERSONA,ID_PLAN_PROGRAMA,NOMBRE_FACULTAD,NOMBRE_ESCUELA,CICLO,LLAMADA,
    ID_ESCUELA,ID_FACULTAD,ID_PROGRAMA_ESTUDIO,ID_SEMESTRE,TIPO,ANIO)
    
    select a.* 
    from(select aac.ID_PERSONA,aac.ID_PLAN_PROGRAMA,aac.NOMBRE_FACULTAD,aac.NOMBRE_ESCUELA,aac.CICLO+1,'N' LLAMADA,
          ape.ID_ESCUELA,ape.ID_FACULTAD,ape.ID_PROGRAMA_ESTUDIO,asm.ID_SEMESTRE,'N'TIPO ,null ANIO
          from vw_acad_alumno_contrato aac inner join Vw_Acad_Programa_Estudio ape on Ape.Id_Programa_Estudio= Aac.Id_Programa_Estudio
          inner join acad_semestre asm on Asm.Id_Semestre_Ant=Aac.Id_Semestre
          where asm.id_semestre=v_id_semestre and aac.estado='1' and aac.Id_Modo_Contrato=1
          and (aac.ID_PERSONA,aac.ID_PLAN_PROGRAMA) not in (select ID_PERSONA,ID_PLAN_PROGRAMA from MOISES.Persona_Natural_Egresado)
          union
          select ID_PERSONA,ID_PLAN_PROGRAMA,Nom_Facultad NOMBRE_FACULTAD,Nom_Escuela NOMBRE_ESCUELA,0 CICLO,'N' LLAMADA,
                  ID_ESCUELA,ID_FACULTAD,ID_PROGRAMA_ESTUDIO,v_id_semestre id_semestre,'N' TIPO ,null ANIO
          from Vw_Alumno_Plan_Programa 
          where Nombre_Plan like '2022%' and estado='1' and Id_Nivel_Ensenanza in (1,2)
          and (id_persona,id_escuela) not in (select id_persona,ape.id_escuela from vw_acad_alumno_contrato aac inner join Vw_Acad_Programa_Estudio ape on Ape.Id_Programa_Estudio= Aac.Id_Programa_Estudio and id_semestre<>v_id_semestre)
          union
          select ID_PERSONA,pne.ID_PLAN_PROGRAMA,Vpp.Nom_Facultad NOMBRE_FACULTAD,Vpp.Nom_Escuela NOMBRE_ESCUELA,10 CICLO,'N' LLAMADA,
                  ID_ESCUELA,ID_FACULTAD,ID_PROGRAMA_ESTUDIO,null id_semestre,'E' TIPO , ANIO
          from MOISES.Persona_Natural_Egresado pne inner join vw_plan_programa vpp on Vpp.Id_Plan_Programa=Pne.Id_Plan_Programa
          where (ID_PERSONA,pne.ID_PLAN_PROGRAMA) not in (select ID_PERSONA,ID_PLAN_PROGRAMA from Aatemp_Alumnos_Matriculados where tipo='E')
          ) a
    where (A.Id_Persona,a.id_plan_programa) not in (select Id_Persona,id_plan_programa from Aatemp_Alumnos_Matriculados where id_semestre=v_id_semestre);
    
    commit;

end;

