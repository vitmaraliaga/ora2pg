-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure pcd_act_ranking
as
p_id_semestre integer;

begin

    SELECT MAX(ID_SEMESTRE) into p_id_semestre
    FROM DAVID.ACAD_SEMESTRE WHERE ESTADO_ADVISER=1;

delete aatemp_poderados_semestre where id_semestre=p_id_semestre;
    COMMIT;

  INSERT INTO aatemp_ranking_semestre
   select a.*, decode(rn,1,'PRIMER PUESTO',2,'SEGUNDO PUESTO',
                      (case when rn<=floor(total/10) then 'DÉSIMO SUPERIOR'
                              else (case when rn<=floor(total/5) then 'QUINTO SUPERIOR'
                                        else (case when rn<=floor(total/3) then 'TERCIO SUPERIOR'
                                                  else (case when rn<=floor(total/2) then 'MEDIO SUPERIOR'
                                                            else 'PUESTO '||rn
                                                            end)
                                                  end)
                                        end)
                            end)) puesto, 'A' TIPO
   from (SELECT 
          ROW_NUMBER() OVER ( PARTITION BY id_semestre,id_programa_estudio,Ciclo
          ORDER BY id_semestre,id_programa_estudio,Ciclo,ponderado_general desc) RN, T.*,
          (select count(*) from aatemp_poderados_semestre a where A.Id_Programa_Estudio=T.Id_Programa_Estudio and a.ciclo=t.ciclo) total
          FROM aatemp_poderados_semestre T
          where id_semestre=p_id_semestre
          order by id_semestre,id_programa_estudio,Ciclo,ponderado_general desc) a;
  commit;
  INSERT INTO aatemp_ranking_semestre
  select a.*, decode(rn,1,'PRIMER PUESTO',2,'SEGUNDO PUESTO',
                      (case when rn<=floor(total/10) then 'DÉSIMO SUPERIOR'
                              else (case when rn<=floor(total/5) then 'QUINTO SUPERIOR'
                                        else (case when rn<=floor(total/3) then 'TERCIO SUPERIOR'
                                                  else (case when rn<=floor(total/2) then 'MEDIO SUPERIOR'
                                                            else 'PUESTO '||rn
                                                            end)
                                                  end)
                                        end)
                            end)) puesto, 'S' TIPO
   from (SELECT 
          ROW_NUMBER() OVER ( PARTITION BY id_semestre,id_programa_estudio,Ciclo
          ORDER BY id_semestre,id_programa_estudio,Ciclo,ponderado_ciclo desc) RN, T.*,
          (select count(*) from aatemp_poderados_semestre a where A.Id_Programa_Estudio=T.Id_Programa_Estudio and a.ciclo=t.ciclo) total
          FROM aatemp_poderados_semestre T
          where id_semestre=p_id_semestre
          order by id_semestre,id_programa_estudio,Ciclo,ponderado_ciclo desc) a
  ;
  commit;
end;

