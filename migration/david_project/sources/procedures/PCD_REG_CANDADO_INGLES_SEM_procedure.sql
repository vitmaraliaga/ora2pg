-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure pcd_reg_candado_ingles_sem(v_id_semestre integer)
is
  begin
  
     --general
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct ID_PERSONA,ID_TIPO_CANDADO,v_id_semestre,min(FECHA_INICIO),min(FECHA_FIN),min(DESCRIPCION),max(ESTADO),min(ID_USUARIO_REG),max(sysdate)
    from acad_candado ac where id_semestre=(select id_semestre_ant from acad_semestre asm where asm.id_semestre=v_id_semestre) and id_tipo_candado Between 13 and 17
    and id_persona not in (select id_persona from acad_candado where id_semestre=v_id_semestre and id_tipo_candado=ac.id_tipo_candado)
    group by ID_PERSONA,ID_TIPO_CANDADO,v_id_semestre;
    commit;
    
    --básico I
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct Aca.Id_Persona,12,v_id_semestre,sysdate,sysdate,'Migrado desde notas del Académico',1,8345,sysdate
    from acad_curso_alumno aca inner join acad_curso_detalle acd on Acd.Id_Curso_Detalle=Aca.Id_Curso_Detalle
    inner join acad_curso ac on Ac.Id_Curso=acd.id_curso
    where id_tipo_condicion=1
    and ac.nombre in ('Inglés Básico I','Inglés I','Inglés Básico II','Inglés II','Inglés Intermedio I','Inglés III','Inglés Intermedio II','Inglés IV','Inglés Avanzado I','Inglés Avanzado','Inglés V','Inglés Avanzado II','Inglés VI')
    and Aca.Id_Persona not in (select ID_PERSONA from acad_candado where ID_TIPO_CANDADO=12 and ID_SEMESTRE=v_id_semestre) ;
    commit;
    
    --básico II
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct Aca.Id_Persona,13,v_id_semestre,sysdate,sysdate,'Migrado desde notas del Académico',1,8345,sysdate
    from acad_curso_alumno aca inner join acad_curso_detalle acd on Acd.Id_Curso_Detalle=Aca.Id_Curso_Detalle
    inner join acad_curso ac on Ac.Id_Curso=acd.id_curso
    where id_tipo_condicion=1
    and ac.nombre in ('Inglés Básico II','Inglés II','Inglés Intermedio I','Inglés III','Inglés Intermedio II','Inglés IV','Inglés Avanzado I','Inglés Avanzado','Inglés V','Inglés Avanzado II','Inglés VI')
    and Aca.Id_Persona not in (select ID_PERSONA from acad_candado where ID_TIPO_CANDADO=13 and ID_SEMESTRE=v_id_semestre) ;
    commit;
    
    --intermedio I
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct Aca.Id_Persona,16,v_id_semestre,sysdate,sysdate,'Migrado desde notas del Académico',1,8345,sysdate
    from acad_curso_alumno aca inner join acad_curso_detalle acd on Acd.Id_Curso_Detalle=Aca.Id_Curso_Detalle
    inner join acad_curso ac on Ac.Id_Curso=acd.id_curso
    where id_tipo_condicion=1
    and ac.nombre in ('Inglés Intermedio I','Inglés III','Inglés Intermedio II','Inglés IV','Inglés Avanzado I','Inglés Avanzado','Inglés V','Inglés Avanzado II','Inglés VI')
    and Aca.Id_Persona not in (select ID_PERSONA from acad_candado where ID_TIPO_CANDADO=16 and ID_SEMESTRE=v_id_semestre) ;
    commit;
    
    --intermedio II
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct Aca.Id_Persona,17,v_id_semestre,sysdate,sysdate,'Migrado desde notas del Académico',1,8345,sysdate
    from acad_curso_alumno aca inner join acad_curso_detalle acd on Acd.Id_Curso_Detalle=Aca.Id_Curso_Detalle
    inner join acad_curso ac on Ac.Id_Curso=acd.id_curso
    where id_tipo_condicion=1
    and ac.nombre in ('Inglés Intermedio II','Inglés IV','Inglés Avanzado I','Inglés Avanzado','Inglés V','Inglés Avanzado II','Inglés VI')
    and Aca.Id_Persona not in (select ID_PERSONA from acad_candado where ID_TIPO_CANDADO=17 and ID_SEMESTRE=v_id_semestre) ;
    commit;
    
    --Avansado I
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct Aca.Id_Persona,14,v_id_semestre,sysdate,sysdate,'Migrado desde notas del Académico',1,8345,sysdate
    from acad_curso_alumno aca inner join acad_curso_detalle acd on Acd.Id_Curso_Detalle=Aca.Id_Curso_Detalle
    inner join acad_curso ac on Ac.Id_Curso=acd.id_curso
    where id_tipo_condicion=1
    and ac.nombre in ('Inglés Avanzado I','Inglés Avanzado','Inglés V','Inglés Avanzado II','Inglés VI')
    and Aca.Id_Persona not in (select ID_PERSONA from acad_candado where ID_TIPO_CANDADO=14 and ID_SEMESTRE=v_id_semestre) ;
    commit;
    
    --Avansado II
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct Aca.Id_Persona,15,v_id_semestre,sysdate,sysdate,'Migrado desde notas del Académico',1,8345,sysdate
    from acad_curso_alumno aca inner join acad_curso_detalle acd on Acd.Id_Curso_Detalle=Aca.Id_Curso_Detalle
    inner join acad_curso ac on Ac.Id_Curso=acd.id_curso
    where id_tipo_condicion=1
    and ac.nombre in ('Inglés Avanzado II','Inglés VI')
    and Aca.Id_Persona not in (select ID_PERSONA from acad_candado where ID_TIPO_CANDADO=15 and ID_SEMESTRE=v_id_semestre) ;
    commit;
    
    --básico I
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct ID_PERSONA,12,v_id_semestre,sysdate,sysdate,'Migrado de Candado',1,8345,sysdate
    from acad_candado ac where id_semestre=v_id_semestre and id_tipo_candado in (13,14,15,16,17)
    and id_persona not in (select id_persona from acad_candado where id_semestre=v_id_semestre and id_tipo_candado=12);
    
    --básico II
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct ID_PERSONA,13,v_id_semestre,sysdate,sysdate,'Migrado de Candado',1,8345,sysdate
    from acad_candado ac where id_semestre=v_id_semestre and id_tipo_candado in (14,15,16,17)
    and id_persona not in (select id_persona from acad_candado where id_semestre=v_id_semestre and id_tipo_candado=13);
    
    --intermedio I
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct ID_PERSONA,16,v_id_semestre,max(sysdate),max(sysdate),'Migrado de Candado',1,8345,max(sysdate)
    from acad_candado ac where id_semestre=v_id_semestre and id_tipo_candado in (14,15,17)
    and id_persona not in (select id_persona from acad_candado where id_semestre=v_id_semestre and id_tipo_candado=16)
    group by ID_PERSONA,16,v_id_semestre,'Migrado de Candado',1,8345;
    
    --intermedio II
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct ID_PERSONA,17,v_id_semestre,max(sysdate),max(sysdate),'Migrado de Candado',1,8345,max(sysdate)
    from acad_candado ac where id_semestre=v_id_semestre and id_tipo_candado in (14,15)
    and id_persona not in (select id_persona from acad_candado where id_semestre=v_id_semestre and id_tipo_candado=17)
    group by ID_PERSONA,17,v_id_semestre,'Migrado de Candado',1,8345;
    
    --Avansado I
    insert into ACAD_CANDADO(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct ID_PERSONA,14,v_id_semestre,sysdate,sysdate,'Migrado de Candado',1,8345,sysdate
    from acad_candado ac where id_semestre=v_id_semestre and id_tipo_candado in (15)
    and id_persona not in (select id_persona from acad_candado where id_semestre=v_id_semestre and id_tipo_candado=14);
    
    commit;
    
    --Carga Centro de Idiomas
    insert into acad_candado(ID_PERSONA,ID_TIPO_CANDADO,ID_SEMESTRE,FECHA_INICIO,FECHA_FIN,DESCRIPCION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
    select Distinct * from(
    select id_persona,decode(nombre_curso,'Básico I',12,'Basic I',12,'Básico II',13,'Basic II',13,'Intermedio I',16,'Intermedio II',17,'Intermedíate II',17,'Avanzado I',14,'Avanzado II',15,0) ID_TIPO_CANDADO,
    v_id_semestre ID_SEMESTRE,sysdate FECHA_INICIO, sysdate FECHA_FIN,'Cursos de carga' DESCRIPCION,ESTADO,8345 ID_USUARIO_REG,sysdate FECHA_REGISTRO
    from vw_acad_curso_alumno where id_facultad=72 and estado='1'
    and nombre_curso in ('Básico I','Basic I','Básico II','Basic II','Intermedio I','Intermedio II','Intermedíate II','Avanzado I','Avanzado II'))
    where (ID_PERSONA,ID_TIPO_CANDADO) not in (select ID_PERSONA,ID_TIPO_CANDADO from acad_candado where id_semestre=v_id_semestre);
    
    commit;
    
  end;

