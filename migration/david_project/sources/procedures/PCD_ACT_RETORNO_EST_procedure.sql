-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure pcd_act_retorno_est
as


begin
  EXECUTE IMMEDIATE 'truncate table aatemp_ultima_matricula_act';
    commit;

  insert into aatemp_ultima_matricula_act
  SELECT A.*,SYSDATE FECHA_REGISTRO 
  FROM(select distinct id_persona,Aac.Id_Escuela,Aac.Id_Programa_Estudio,ciclo,id_semestre,semestre,
       (select max(semestre) from Vw_Acad_Alumno_Contrato 
        where id_persona=aac.id_persona and Id_Escuela=aac.Id_Escuela 
        and semestre<aac.semestre and estado='1' and substr(Semestre,-2) in ('-1','-2')
        and Id_Modo_Contrato in (1,3))ultimo_semestre
        from Vw_Acad_Alumno_Contrato aac
        where aac.estado='1' and Aac.Id_Tipo_Contrato in (1,2)
        and substr(Aac.Semestre,-2) in ('-1','-2')
        and substr(Aac.Semestre,0,4)>2020 and Aac.Id_Modo_Contrato in (1,3)) A;
  commit;
end;

