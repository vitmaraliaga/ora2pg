-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

PROCEDURE       pcd_validacion_becas_cc (p_id_persona integer,p_id_plan_programa integer,p_id_semestre integer,p_id_tipo_requisito_beca integer, cursor out sys_refcursor) IS
   
BEGIN

  open cursor for 
  Select (case when max(promedio)='A' and max(deuda)='A' and max(regular)='A' and max(ciclo)='A' then 'NO' else 'SI' end ) as bloqueo,
  (case when max(promedio)='A' and max(deuda)='A' and max(regular)='A' and max(ciclo)='A' then 'OK' else 
        decode(max(promedio),'A','',max(promedio)||',')||decode(max(deuda),'A','',max(deuda)||',')||
        decode(max(regular),'A','',max(regular)||',')||decode(max(ciclo),'A','',max(ciclo)||',') end ) as mensaje
  
  from (select 'A' promedio, 'A'/*decode(ft_tiene_deuda(p_id_persona,p_id_semestre),1,'El saldo no esta en tu estado de cuenta , no cumple con lo requerido para  avanzar en tu solicitud','A')*/ deuda, 
        'A' regular, 'A' ciclo
        from dual
        union
        select max(promedio) promedio,'A' deuda, max(regular) regular, max(ciclo) ciclo
        from (select decode(automatico,'A2',''||decode(ft_tiene_aprobado(p_id_persona,p_id_plan_programa),1,'El Promedio Ponderado minimo requerido no ha sido alcanzado','A'),'A') promedio,
              decode(automatico,'A4',decode(ft_tiene_desbloqueo(p_id_persona,p_id_plan_programa,p_id_semestre),1,'A',              
              ''||decode(ft_tiene_aprobado_ant(p_id_persona,p_id_plan_programa),
              1,'Tiene uno o más cursos desaprobados el ciclo anterior y su promedio final es menor a 14',
              2,'Tiene uno o más cursos desaprobados el ciclo anterior',
              3,'Tiene el 100% de los créditos aprobados en el semestre académico precedente pero no tien un promedio ponderado mínimo de catorce (14)','A')
              )
              ,'A') regular,
              (case when Id_Tipo_Requisito_Beca in (4,11,17,45,48,57,67) then (case when ft_ciclo_plan_alumno(p_id_persona,p_id_plan_programa)<=2 then 'A'
                                                                                    else ''||decode(ft_tiene_segundociclo(p_id_persona,p_id_plan_programa),1,'Aun no puedes solicitar , pues no estas en el ciclo minimo requerido','A') end ) else
                    decode(automatico,'A7',''||decode(ft_tiene_tercerciclo(p_id_persona,p_id_plan_programa),1,'Aun no puedes solicitar , pues no estas en el ciclo minimo requerido','A'),'A') 
                    end)ciclo
              from acad_requisitos_beca where Id_Tipo_Requisito_Beca=p_id_tipo_requisito_beca and estado='1' and Automatico in ('A2','A4','A1','A7')));
              
END;

