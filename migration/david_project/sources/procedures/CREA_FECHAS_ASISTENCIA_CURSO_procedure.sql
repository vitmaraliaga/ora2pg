-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure CREA_FECHAS_ASISTENCIA_CURSO( p_id_carga_curso in integer) AS 

  val VARCHAR2(100);
  dias VARCHAR(7);
  dias2 VARCHAR(100);
  corte number;
  horas number;
  var VARCHAR2(7);
  fecha_inicio date;
  dia_inicio VARCHAR2(20);
  MSJ VARCHAR2(100);
  fecha_inicio_curso date;
  fecha_inicio2 date;
  
  ref_hor VARCHAR2(400);
  
  hini VARCHAR2(100);
  hfin VARCHAR2(100);
  
  Cursor cursos_carga is
  select Th.Nombre tipo,Accd.Horario,Aca.Id_Carga_Curso,Accd.Id_Carga_Curso_Docente,Amd.Fecha_Inicio,Amd.Fecha_fin,(upper(TO_CHAR(to_date(Amd.Fecha_Inicio,'dd-mm-yy'),'day'))) dia_inicio,
  decode(Aca.Id_Programa_Estudio,1,0,1) no_medicina,aca.id_nivel_ensenanza,aca.id_semestre
  from vw_acad_carga_academica aca inner join acad_carga_curso_docente accd on Accd.Id_Carga_Curso=Aca.Id_Carga_Curso
  inner join Tipo_Horario th on Th.Id_Tipo_Horario=Accd.Id_Tipo_Horario
  inner join Acad_Modulo_Detalle amd on Amd.Id_Modulo_Detalle=Accd.Id_Modulo_Detalle
  where aca.id_curso_modo=1 and aca.origen='O' and Aca.Id_carga_curso= p_id_carga_curso
  ;

  BEGIN
  
  delete acad_doc_asistencia where id_carga_curso_docente in (select id_carga_curso_docente from acad_carga_curso_docente where id_carga_curso=p_id_carga_curso);
  commit;
  
  FOR c_horario IN cursos_carga LOOP
        dias := ' ';
        corte :=1;
        horas :=0;
        
        FOR i IN 1..25 LOOP
            val := SUBSTR(c_horario.HORARIO,corte ,corte+7); 
           FOR y IN 1..7 LOOP
            var := substr(val,y,1);
            IF var ='1' THEN
              IF INSTR(dias,to_char(y)) =0 THEN
                dias :=CONCAT(dias, y);
              END IF;
            END IF;
              
          END LOOP;
            corte:=corte+7;
        END LOOP;
        
       IF LENGTH(TRIM(dias)) >0 THEN
          FOR y IN 1..length(TRIM(dias)) LOOP
            dias2 := '';
            var := substr(trim(dias),y,1);
            CASE
             WHEN var = '1' THEN dias2 :=CONCAT(dias2, 'DOMINGO');
             WHEN var = '2' THEN dias2 :=CONCAT(dias2, 'LUNES');
             WHEN var = '3' THEN dias2 :=CONCAT(dias2, 'MARTES');
             WHEN var = '4' THEN dias2 :=CONCAT(dias2, 'MIÉRCOLES');
             WHEN var = '5' THEN dias2 :=CONCAT(dias2, 'JUEVES');
             WHEN var = '6' THEN dias2 :=CONCAT(dias2, 'VIERNES');
             --WHEN var = '7' THEN dias:=dias+'SATURDAY,';
             ELSE dias2 :=CONCAT(dias2, 'SÁBADO');
            END CASE;
            IF TRIM(dias2)=TRIM(c_horario.dia_inicio) THEN
              fecha_inicio_curso:=c_horario.fecha_inicio;
            ELSE
              select next_day(c_horario.fecha_inicio,dias2) into fecha_inicio2 from dual;
              fecha_inicio_curso:= fecha_inicio2;
            END IF;
            
            select horario_dia_curdoc(c_horario.id_carga_curso_docente,var) into ref_hor from dual;
            
            hini :=substr(ref_hor,0,5);
            hfin :=substr(ref_hor,-5);
            
            Insert into acad_doc_asistencia Values (c_horario.id_carga_curso_docente,c_horario.id_semestre,c_horario.id_nivel_ensenanza,c_horario.no_medicina,fecha_inicio_curso,c_horario.TIPO,'0',hini,hfin);
            commit;
            
            fecha_inicio_curso := fecha_inicio_curso+7;
            
            while fecha_inicio_curso<=c_horario.fecha_fin loop
            
              Insert into acad_doc_asistencia Values (c_horario.id_carga_curso_docente,c_horario.id_semestre,c_horario.id_nivel_ensenanza,c_horario.no_medicina,fecha_inicio_curso,c_horario.TIPO,'0',hini,hfin);
              commit;
              
              fecha_inicio_curso := fecha_inicio_curso+7;
            
            end loop;
                  
          END LOOP;
        END IF;
    END LOOP;
END;

