-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure pcd_copia_plan_new(
  p_id_plan_ant integer, 
  p_id_plan_new integer, 
  p_id_usuario_reg integer
)
 is
begin
  insert into acad_plan_curso (ID_PLAN,ID_CURSO_DETALLE,ID_TIPO_CURSO,ID_PLAN_CURSO_ELECTIVO,CICLO,CODIGO,
                                ESTADO,ID_USUARIO_REG, FECHA_REGISTRO,HTP,HTV,HPP,HPV,MODO,HORA_DIVIDIDA )
  select p_id_plan_new ID_PLAN,ID_CURSO_DETALLE,ID_TIPO_CURSO,ID_PLAN_CURSO_ELECTIVO,CICLO,CODIGO,
  ESTADO,p_id_usuario_reg ID_USUARIO_REG,sysdate FECHA_REGISTRO,HTP,HTV,HPP,HPV,MODO,HORA_DIVIDIDA 
  from acad_plan_curso where Id_Plan=p_id_plan_ant and Id_Plan_Curso_Electivo is null
  order by ciclo,ID_CURSO_DETALLE;
  
  commit;
  
  insert into acad_plan_curso (ID_PLAN,ID_CURSO_DETALLE,ID_TIPO_CURSO,ID_PLAN_CURSO_ELECTIVO,CICLO,CODIGO,
                                ESTADO,ID_USUARIO_REG, FECHA_REGISTRO,HTP,HTV,HPP,HPV,MODO,HORA_DIVIDIDA )
  select p_id_plan_new ID_PLAN,pc.ID_CURSO_DETALLE,pc.ID_TIPO_CURSO,
  b.id_plan_curso ID_PLAN_CURSO_ELECTIVO,
  pc.CICLO,pc.CODIGO,
  pc.ESTADO,p_id_usuario_reg ID_USUARIO_REG,sysdate FECHA_REGISTRO,pc.HTP,pc.HTV,pc.HPP,pc.HPV,pc.MODO,pc.HORA_DIVIDIDA 
  from acad_plan_curso pc left join acad_plan_curso pce on Pce.Id_Plan_Curso=Pc.Id_Plan_Curso_Electivo
  inner join (select b.id_plan_curso,b.id_curso_detalle from acad_plan_curso b where b.id_plan=p_id_plan_new) b on b.id_curso_detalle=pce.id_curso_detalle
  where pc.Id_Plan=p_id_plan_ant and pc.Id_Plan_Curso_Electivo is not null
  order by pc.ciclo,pc.ID_CURSO_DETALLE;
  
  commit;
  
  insert into ACAD_PRE_REQUISITO(ID_PLAN_CURSO,ID_PLAN_CURSO_REQ,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO)
  select B.Id_Plan_Curso ID_PLAN_CURSO,c.Id_Plan_Curso ID_PLAN_CURSO_REQ,
  pr.ESTADO,p_id_usuario_reg ID_USUARIO_REG,sysdate FECHA_REGISTRO
  from Acad_Pre_Requisito pr inner join Acad_Plan_Curso apc on Apc.Id_Plan_Curso=Pr.Id_Plan_Curso
  inner join Acad_Plan_Curso apcr on Apcr.Id_Plan_Curso=Pr.Id_Plan_Curso_Req
  left join (select b.id_plan_curso,b.id_curso_detalle from acad_plan_curso b where b.id_plan=p_id_plan_new) b on b.id_curso_detalle=Apc.id_curso_detalle
  left join (select b.id_plan_curso,b.id_curso_detalle from acad_plan_curso b where b.id_plan=p_id_plan_new) c on c.id_curso_detalle=Apcr.id_curso_detalle
  where Apc.Id_Plan=p_id_plan_ant
  order by B.Id_Plan_Curso,c.Id_Plan_Curso;
  
  commit;
  
end;

