-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

procedure       pcd_update_req_alum(
  v_id_persona integer, 
  v_id_usuario integer, 
  v_id_plan_programa integer, 
  v_id_solicitud_mat_alum integer, 
  v_id_tipo_requisito_beca integer, 
  v_renovacion varchar2
)
 is
 
    p_sem  varchar2(200);
    p_monto number;
    p_creditos number;
    p_id_escuela integer;
    p_id_resp_fin integer;
    p_cod_hermanos varchar2(200);
    p_beca_s_hermano varchar2(200);
    p_estado varchar2(200);
    p_matriculado varchar2(200);
    p_ciclo number;
    p_promedio integer;
    p_obs  varchar2(200);
    p_indisciplina integer;
    p_certificado integer;
    p_residente integer;
    p_residente_observado integer;
    p_id_semestre integer;
    val_comp integer;
    
    --lista los requisitos activos para el descuento al Asociado de la Promotora de la UPeU
    cursor requisitos is
      select id_requisitos_beca,automatico,renovacion, codigo  
      from acad_requisitos_beca 
      where id_tipo_requisito_beca=v_id_tipo_requisito_beca  
      and estado='1'
      and renovacion like '%'||v_renovacion||'%';

begin

  val_comp:=12;
  --semestre
  --test
  select Asm.Semestre,Sma.Id_Semestre into p_sem,p_id_semestre
  from Solicitud_Mat_Alum sma inner join acad_semestre asm on Asm.Id_Semestre=Sma.Id_Semestre
  where id_solicitud_mat_alum=v_id_solicitud_mat_alum;

  -- busca escuela del alumno
  select ap.id_escuela into p_id_escuela
  from acad_plan_programa app inner join Vw_Acad_Plan ap on Ap.Id_Plan=App.Id_Plan
  where id_plan_programa=v_id_plan_programa;
  
  for req in requisitos
  loop
  
    p_obs:='';
    
    if(req.automatico='A1') then
      ---apartado para deuda
      --descomentado por samuel el 11 05 22, a solicitud del ing carlos
      
      select nvl((select substr(deuda,4) monto 
              from (select ft_deuda_alumno(v_id_persona,substr(p_sem,0,4)) deuda from dual)
              where substr(deuda,0,2)='01'),0) into p_monto
      from dual;
      
      if(p_monto>0) then
      
        p_estado:='0';
        p_obs:='Tiene deuda de '||p_monto;
        
      else
      
        p_estado:='1';
        p_obs:='No tiene deuda';
      
      end if;
      
    elsif (req.automatico='A2') then
      
      select decode(ft_desaprobado_ciclo_ant(v_id_persona,p_id_escuela,'t'),'S',2,1),ft_promedio_ant(v_id_persona,p_id_escuela)
      into p_estado,p_promedio
      from dual;
      
      if(p_estado=2 and p_promedio<14) then
        p_estado:='0';
        p_obs:='tiene uno o más cursos desaprobados el ciclo anterior y su promedio final es menor a 14';
      elsif(p_estado=2 and p_promedio>=14) then
        p_estado:='0';
        p_obs:='tiene uno o más cursos desaprobados el ciclo anterior';
      elsif(p_estado=1 and p_promedio>=14) then
        p_estado:='1';
        p_obs:='Ha obtenido un promedio ponderado mínimo de catorce (14) y el 100% de los créditos aprobados en el semestre académico precedente';
      elsif(p_estado=1 and p_promedio<14) then
        p_estado:='0';
        p_obs:='Tiene el 100% de los créditos aprobados en el semestre académico precedente pero no tien un promedio ponderado mínimo de catorce (14)';
      end if;
    
    elsif (req.automatico='A3') then
    
      select decode(ft_desaprobado_ciclo_ant(v_id_persona,p_id_escuela,'c'),'S',2,1),ft_promedio_ant(v_id_persona,p_id_escuela)
        into p_estado,p_promedio
        from dual;
      
      if(p_estado=2 and p_promedio<14) then
        p_obs:='tiene uno o más cursos desaprobados el ciclo anterior y su promedio final es menor a 14';
      end if;
      if(p_estado=2 and p_promedio>=14) then
        p_obs:='tiene uno o más cursos desaprobados el ciclo anterior';
      end if;
    
    elsif (req.automatico='A4') then
    
      select nvl(sum(Vaca.Credito),0) into p_creditos
      from acad_curso_alumno aca inner join Vw_Acad_Carga_Academica vaca on vaca.Id_Carga_Curso=Aca.Id_Carga_Curso and vaca.origen='O'
      inner join Acad_Semestre_Programa asp on Asp.Id_Semestre_Programa=vaca.Id_Semestre_Programa
      inner join Acad_Semestre asm on Asm.Id_Semestre=Asp.Id_Semestre and Asm.Semestre=p_sem
      where aca.id_persona=v_id_persona and aca.id_plan_programa=v_id_plan_programa and Aca.Estado<>'3';
      
      if(p_id_escuela=83) then val_comp:=10;
      else val_comp:=12;
      end if;
    
      if(p_creditos>=val_comp) then
        p_estado:='1';
        p_obs:='';
      else
        p_estado:='0';
        p_obs:='no lleva carga Regular Completa';
      end if;
        
    elsif (req.automatico='A5') then
    
      select nvl ((select Distinct 'S' from vw_acad_alumno_contrato 
                    where id_persona=v_id_persona and id_plan_programa=v_id_plan_programa and Semestre=p_sem 
                    and Estado in ('1','M') and id_modo_contrato=1),'N') into p_matriculado
      from dual;
      
      if(p_matriculado='S') then
        p_estado:='1';
        p_obs:='';
      else
        p_estado:='0';
        p_obs:='no se encuentra matriculado en el semestre '||p_sem;
      end if;
        
    elsif (req.automatico='A6') then
    
      select nvl((select min(Id_Resp_Financiero)
                  from vw_acad_alumno_contrato 
                  where id_persona=v_id_persona and id_plan_programa=v_id_plan_programa and Semestre=p_sem 
                  and Estado in ('1','M') and id_modo_contrato=1),0) into p_id_resp_fin
      from dual;
      
      select nvl((select max(creditos)
                  from (select aca.id_persona,nvl(sum(Vaca.Credito),0) creditos
                        from acad_curso_alumno aca inner join Vw_Acad_Carga_Academica vaca on vaca.Id_Carga_Curso=Aca.Id_Carga_Curso and vaca.origen='O'
                        inner join Acad_Semestre_Programa asp on Asp.Id_Semestre_Programa=vaca.Id_Semestre_Programa
                        inner join Acad_Semestre asm on Asm.Id_Semestre=Asp.Id_Semestre and Asm.Semestre=p_sem
                        where aca.id_persona in (select id_persona from vw_acad_alumno_contrato 
                                                        where Id_Resp_Financiero=p_id_resp_fin and Id_Nivel_Ensenanza=1 and Semestre=p_sem 
                                                        and Estado in ('1','M') and id_modo_contrato=1) 
                        and Vaca.Id_Nivel_Ensenanza=1 and Aca.Estado<>'3'
                        group by aca.id_persona)),0) into p_creditos
      from dual;
      
      select nvl((select wm_concat(codigo)
                  from vw_acad_alumno_contrato 
                  where Id_Resp_Financiero=p_id_resp_fin and Id_Nivel_Ensenanza=1 and Semestre=p_sem 
                  and id_persona<>v_id_persona and Estado in ('1','M') and id_modo_contrato=1),'N') into p_beca_s_hermano
      from dual;
      
      select nvl((select Distinct 'S' from Solicitud_Mat_Alum where Id_Tipo_Requisito_Beca=22 and estado<>'2' and id_semestre=p_sem
                  and id_persona in (select id_persona from vw_acad_alumno_contrato 
                                      where Id_Resp_Financiero=p_id_resp_fin and Id_Nivel_Ensenanza=1 and Semestre=p_sem 
                                      and Estado in ('1','M') and id_modo_contrato=1)),'N') into p_cod_hermanos
      from dual;
      
      if(p_cod_hermanos='N') then
        p_estado:='0';
        p_obs:='No tiene hermanos matriculados en el semestre '||p_sem;
        
      else
      
        if(p_creditos>=12) then
        
          if(p_beca_s_hermano='N') then
          
            p_estado:='1';
            p_obs:='el(los) código(s) del(los) hermano(a)(s) es(son) '||p_cod_hermanos;
          
          else
          
            p_estado:='0';
            p_obs:='ya superaste el límite de solicitudes de para esta beca';
          
          end if;
        
        else
        
        p_estado:='0';
        p_obs:='el primer hermano no tiene la calidad de estudiante regular';
        
        end if;
        
        
      end if;
        
    elsif (req.automatico='A7') then
    
      select nvl ((select Distinct ft_calcular_ciclo_programa(semestre,id_persona,id_plan_programa) from vw_acad_alumno_contrato 
                    where id_persona=v_id_persona and id_plan_programa=v_id_plan_programa and Semestre=p_sem 
                    and Estado in ('1','M') and id_modo_contrato=1),0) into p_ciclo
      from dual;
      
      if(p_ciclo>=3) then
        p_estado:='1';
        p_obs:='';
      else
        p_estado:='0';
        p_obs:='no pertenece a l 3er ciclo o superior';
      end if;
    
    elsif (req.automatico='H21') then
    
      select count(*) into p_indisciplina from acad_candado c inner join tipo_candado tc on c.id_tipo_candado = tc.id_tipo_candado
      where tc.codigo='SSO'  and c.estado='1' and c.id_persona=v_id_persona;
    
      
      if(p_indisciplina>=1) then
        p_estado:='0';
        p_obs:='Tiene una indisciplina registrada.';
      else
        p_estado:='1';
        p_obs:='No tiene indisciplinas registradas.';
      end if;
        
    elsif (req.automatico='G1') then
    
        p_estado:='1';
        p_obs:='El requisito será solicitado en Junio.';
        
    elsif (req.automatico='CC1') then
    
    
      select count(*) into p_certificado 
      from PRESELECCION_SOSTENEDOR_OBRA a inner join moises.persona_natural_alumno pna on trim(pna.codigo)=trim(a.codigo)
      where pna.id_persona=v_id_persona and a.id_semestre=p_id_semestre;
    
      
      if(p_certificado>=1) then
        p_estado:='1';
        p_obs:='Tiene una una constancia de afiliación (feligresía) vigente y no mayor o igual a treinta días de emitida registrada.';
      else
        p_estado:='0';
        p_obs:='No tiene Compromiso de presentar una constancia de afiliación (feligresía) vigente y no mayor o igual a treinta días de emitida registrada.';
      end if;
        
   
    else    
    
      p_estado:='0';
      p_obs:='';
    
    end if;
    
    if (req.codigo='F1') then
    
        select count(*) into p_residente from acad_reserva_residencia where id_semestre=p_id_semestre
        and id_persona=v_id_persona and estado=2;
        
        if p_residente >= 1 then
        
            SELECT COUNT(*) INTO p_residente_observado from acad_candado where id_persona=v_id_persona
            and id_semestre=p_id_semestre and id_tipo_candado=56 and estado='1';
            
            if p_residente_observado >=1 then
                
                  p_estado:='0';
                  p_obs:='Tiene un bloqueo de residencia.';
            else 
                  p_estado:='1';
                  p_obs:='Requisito aprobado.';
                
            end if;
           
        
        else
            CONTINUE;
            
        end if;
           
    
    end if;
    
    
   if (req.codigo='G14') then
    
        select count(*) into p_residente from acad_reserva_residencia where id_semestre=p_id_semestre
        and id_persona=v_id_persona and estado=2;
        
        if p_residente >= 1 then
        
            SELECT COUNT(*) INTO p_residente_observado from acad_candado where id_persona=v_id_persona
            and id_semestre=p_id_semestre and id_tipo_candado=56 and estado='1';
            
            if p_residente_observado >=1 then
                
                  p_estado:='0';
                  p_obs:='Tiene un bloqueo de residencia.';
            else 
                  p_estado:='1';
                  p_obs:='Requisito aprobado.';
                
            end if;
           
        
        else
            CONTINUE;
            
        end if;
           
    
    end if;

    
    
    --registra los requisitos activos al alumno en el semestre activo
    update acad_alumno_requisitos_beca 
    set estado=p_estado , observacion=p_obs ,id_usuario_act=v_id_usuario , fecha_actualizacion=sysdate
    where id_solicitud_mat_alum=v_id_solicitud_mat_alum and id_requisitos_beca=req.id_requisitos_beca;
    commit;
    
  end loop;
  
  update SOLICITUD_MAT_ALUM set estado='2' 
  where id_solicitud_mat_alum=v_id_solicitud_mat_alum and 1=(select (case when count(*)=sum(estado) then 1 else 0 end) 
                                                            from acad_alumno_requisitos_beca 
                                                            where id_solicitud_mat_alum=v_id_solicitud_mat_alum);
  commit;
  
end;

