-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

FUNCTION       ft_ciclo_plan_alumno(p_id_persona INTEGER,p_id_plan_programa INTEGER)
RETURN number IS 

  p_creditos integer;
  p_total_creditos integer;
  p_total_ciclos integer;
  p_res_ciclo  integer;

  CURSOR CredCiclo is
  select Apc.Ciclo,sum(acd.credito) creditos from acad_plan_programa app inner join acad_plan_curso apc on apc.id_plan=app.id_plan
  inner join acad_curso_detalle acd on acd.id_curso_detalle=apc.id_curso_detalle
  where App.Id_Plan_Programa=p_id_plan_programa and Apc.Id_Plan_Curso_Electivo is null
  group by Apc.Ciclo
  order by Apc.Ciclo;
  
BEGIN

  p_total_creditos:=0;
  p_total_ciclos:=0;
  p_res_ciclo:=0;
 
  select nvl((select sum(acp.credito)
                from VW_PLAN_PROGRAMA vpp inner join VW_ACAD_CURSO_PLAN acp on VPP.ID_PLAN=ACP.ID_PLAN
                -- se cambiÃ³ left por inner
                inner join (select aca.Id_Plan_Programa,aca.promedio,aca.id_tipo_condicion,
                            decode(apc.Id_Plan_Curso_Electivo,null,apc.Id_Plan_Curso,apc.Id_Plan_Curso_Electivo) Id_Plan_Curso
                            from Acad_Curso_Alumno aca inner join  acad_plan_curso apc on Apc.Id_Plan_Curso=Aca.Id_Plan_Curso
                            where aca.id_persona=p_id_persona  and aca.estado='1' and aca.Id_Tipo_Condicion not in (3,4,5,7,6,15)) aca
                            on aca.Id_Plan_Programa=Vpp.Id_Plan_Programa and aca.Id_Plan_Curso=Acp.Id_Plan_Curso
                where vpp.id_plan_programa=p_id_plan_programa and acp.ID_PLAN_CURSO_ELECTIVO is null
                and acp.estado='1'),0) into p_creditos
  from dual;
  
  FOR N in CredCiclo LOOP
  p_total_ciclos:=p_total_ciclos+1;
  END LOOP;
  
  FOR cc in CredCiclo LOOP
    
    p_total_creditos:=p_total_creditos+cc.creditos;
    
    if(cc.ciclo=p_total_ciclos) then    
        if(p_creditos>=p_total_creditos) then        
          p_res_ciclo:=cc.ciclo;          
        else          
          p_res_ciclo:=p_res_ciclo+1;          
        end if;
      
    else
      
      if(p_creditos<p_total_creditos) then 
        p_res_ciclo:=cc.ciclo;
        EXIT;
      else
        p_res_ciclo:=p_res_ciclo+1;
      end if;
      
    end if;
    
  end loop;
  
  return p_res_ciclo;
  
END;

