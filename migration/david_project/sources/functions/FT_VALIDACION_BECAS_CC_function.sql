-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

function ft_validacion_becas_cc(p_id_persona integer,p_id_plan_programa integer,p_id_semestre integer)
return varchar2
is
  p_res varchar2(500);
   
BEGIN

  Select (case when max(promedio)='A' and max(deuda)='A' and max(regular)='A' and max(ciclo)='A' then 'NO' else 'SI' end ) ||
        (case when max(promedio)='A' and max(deuda)='A' and max(regular)='A' and max(ciclo)='A' then 'OK' else 
        decode(max(promedio),'A','',max(promedio)||',')||decode(max(deuda),'A','',max(deuda)||',')||
        decode(max(regular),'A','',max(regular)||',')||decode(max(ciclo),'A','',max(ciclo)||',') end ) into p_res
  
  from (select 'A' promedio, decode(ft_tiene_deuda(p_id_persona,p_id_semestre),1,'El saldo no esta en tu estado de cuenta , no cumple con lo requerido para  avanzar en tu solicitud','A') deuda, 
        'A' regular, 'A' ciclo
        from dual
        union
        select max(promedio) promedio,'A' deuda, max(regular) regular, max(ciclo) ciclo
        from (select decode(automatico,'A2',''||decode(ft_tiene_aprobado(p_id_persona,p_id_plan_programa),1,'El Promedio Ponderado minimo requerido no ha sido alcanzado','A'),'A') promedio,
              decode(automatico,'A4',''||decode(ft_tiene_regular(p_id_persona,p_id_plan_programa),1,'La cantidad de creditos minimos requeridos, no ha sido confirmado','A'),'A') regular,
              (case when Id_Tipo_Requisito_Beca in (4,11,17,45,48,57,67) then (case when ft_tiene_max_ciclo(p_id_persona,p_id_plan_programa)<2 then 'Aun no puedes solicitar , pues no estas en el ciclo minimo requerido'
                                                                                    else 'A' end ) else
                    decode(automatico,'A7',''||decode(ft_tiene_tercerciclo(p_id_persona,p_id_plan_programa),1,'Aun no puedes solicitar , pues no estas en el ciclo minimo requerido','A'),'A') 
                    end)ciclo
              from acad_requisitos_beca where Id_Tipo_Requisito_Beca=4 and estado='1' and Automatico in ('A2','A4','A1','A7')));
              
  return p_res;

END;

