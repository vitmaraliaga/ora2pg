-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

function ft_anio_alumno ( v_id_persona in integer, v_id_plan_programa in integer) return varchar2 is

x_creditos number(5); 
p_anio_s  number(5);
a_creditos number(5);	
   
cursor alum_credito is   
  select sum(acd.credito) sum_credito
  from acad_plan_programa app 
  inner join acad_plan_curso apc on apc.id_plan=app.id_plan and app.id_plan_programa=v_id_plan_programa
  inner join (select vce.id_curso_detalle
              from acad_curso_alumno aca inner join vw_curso_equivalente vce on vce.id_curso_detalle=aca.id_curso_detalle 
                                          and aca.id_persona=v_id_persona and aca.id_tipo_condicion=1
              inner join acad_plan_programa app on app.id_plan_programa=aca.id_plan_programa
              inner join acad_plan_curso apc on apc.id_plan=app.id_plan and apc.id_curso_detalle=vce.curso_equiv
              group by vce.id_curso_detalle) cd
      on cd.id_curso_detalle=apc.id_curso_detalle
  inner join acad_curso_detalle acd on acd.id_curso_detalle=apc.id_curso_detalle;

cursor plan_credito is
  select apc.ciclo,decode(apc.ciclo,'1','1','2','1','3','2','4','2','5','3','6','3','7','4','8','4','9','5','10','5','11','6','12','6','13','7','14','7') p_anio,
          sum(ac.credito) p_creditos
  from acad_plan_curso apc inner join acad_curso_detalle ac on ac.id_curso_detalle=apc.id_curso_detalle
  inner join acad_plan_programa app on app.id_plan=apc.id_plan and app.id_plan_programa=v_id_plan_programa
  group by apc.ciclo
  order by apc.ciclo asc;

begin
  
  open alum_credito;
		 fetch alum_credito into a_creditos; 
			 if alum_credito%notfound then
		 	 	a_creditos:=0;
			 end if;
     close alum_credito;	
	 if a_creditos is null then a_creditos:=0; end if;
   
   select sum(acd.credito) into x_creditos
    from acad_plan_programa app 
    inner join acad_plan_curso apc on apc.id_plan=app.id_plan and app.id_plan_programa=v_id_plan_programa and apc.ciclo='1'
    inner join acad_curso_detalle acd on acd.id_curso_detalle=apc.id_curso_detalle;     
    
   if x_creditos is null then x_creditos:=0; end if; 
   
   for reg in plan_credito loop
     
		 if  a_creditos <= x_creditos  then 	 
			 p_anio_s  := to_number(reg.p_anio); 
       dbms_output.put_line (p_anio_s);
			  
			 exit;
		 else
		 	 x_creditos := x_creditos + to_number(reg.p_creditos); 
			 p_anio_s  := '5';
		 end if;
		  
	end loop;
  
  return(p_anio_s);
  
end;

