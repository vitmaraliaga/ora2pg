-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

function ft_ponderado_general_plan_old(p_id_persona in integer,p_id_plan_programa in integer) 
return number
is
  p_plan number;
  p_promedio number;
begin  

  select Id_Plan into p_plan from Vw_Plan_Programa where id_plan_programa=p_id_plan_programa;

  select round((sum(promedio*credito)/decode(sum(credito),0,1,sum(credito))),2) into p_promedio
  from (select Distinct acp.id_curso_detalle,Id_Plan_Curso,ciclo,curso,Aca.Promedio,aca.id_tipo_condicion,Acp.Credito,fecha
        from Vw_Acad_Curso_Plan acp 
        inner join (select Distinct id_carga_curso,Vce.Id_Curso_Detalle,promedio,apc.id_tipo_condicion,min(fecha) fecha
                    from (select id_carga_curso,id_curso_detalle,promedio,id_tipo_condicion,min(fecha) fecha
                        from (
                                select aca.id_carga_curso,nvl(apc.id_curso_detalle,aca.id_curso_detalle) id_curso_detalle,
                                aca.promedio,aca.id_tipo_condicion,nvl(fecha_fin,aca.fecha_registro) fecha
                                from acad_curso_alumno aca inner join acad_plan_programa app
                                                        on app.id_plan_programa=aca.id_plan_programa and aca.id_plan_programa is not null
                                                        and aca.id_persona=p_id_persona and aca.id_tipo_condicion in (1,2) and aca.estado='1'
                                left join acad_plan_curso apc on apc.id_plan=app.id_plan and apc.id_curso_detalle=aca.id_curso_detalle
                                left join (select accd.id_carga_curso,max(amd.fecha_fin) fecha_fin
                                            from acad_carga_curso_docente accd inner join acad_modulo_detalle amd on amd.id_modulo_detalle=accd.id_modulo_detalle
                                            group by accd.id_carga_curso) accd on accd.id_carga_curso=aca.id_carga_curso
                                where Apc.Id_Plan_Curso_Electivo is null
                                union
                                select aca.id_carga_curso,apce.id_curso_detalle,
                                aca.promedio,aca.id_tipo_condicion,nvl(fecha_fin,aca.fecha_registro) fecha
                                from acad_curso_alumno aca inner join acad_plan_programa app on app.id_plan_programa=aca.id_plan_programa
                                                        and aca.id_persona=p_id_persona and aca.id_tipo_condicion in (1,2) and aca.estado='1'
                                left join acad_plan_curso apc on apc.id_plan=app.id_plan and apc.id_curso_detalle=aca.id_curso_detalle
                                left join acad_plan_curso apce on apce.id_plan_curso=apc.id_plan_curso_electivo
                                left join (select accd.id_carga_curso,max(amd.fecha_fin) fecha_fin
                                            from acad_carga_curso_docente accd inner join acad_modulo_detalle amd on amd.id_modulo_detalle=accd.id_modulo_detalle
                                            group by accd.id_carga_curso) accd on accd.id_carga_curso=aca.id_carga_curso
                                where apce.id_curso_detalle is not null)
                        group by id_carga_curso,id_curso_detalle,promedio,id_tipo_condicion
                        union
                        select aca.id_carga_curso,aca.id_curso_detalle,
                                aca.promedio,aca.id_tipo_condicion,aca.fecha_registro fecha
                        from acad_curso_alumno aca
                        where aca.id_persona=p_id_persona and aca.id_tipo_condicion=1 and id_plan_programa is null and aca.estado='1'
                        and id_curso_detalle not in (select vce.id_curso_detalle from acad_curso_alumno aca inner join vw_curso_equivalente vce on vce.curso_equiv=aca.id_curso_detalle
                                                        where id_persona=p_id_persona and id_tipo_condicion=1 and id_plan_programa is not null)) Apc
                    inner join vw_curso_equivalente vce on Vce.Curso_Equiv=Apc.Id_Curso_Detalle
                    group by id_carga_curso,Vce.Id_Curso_Detalle,promedio,apc.id_tipo_condicion
                    ) aca
                on Aca.Id_Curso_Detalle=Acp.Id_Curso_Detalle
        where id_plan=p_plan and Acp.Id_Plan_Curso_Electivo is null);
  
  return p_promedio;
  
end;

