-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

function tpp_varios(p_id_persona in integer,p_id_plan_programa in integer,p_id_plan in integer,p_id_semestre in integer,p_ciclo in integer, p_valor in varchar2) 
return number is
    p_creditos number;
begin
    if(p_valor = 'ALUM') then
        select nvl(sum(vaca.credito),0) into p_creditos
        from david.vw_acad_curso_alumno vaca inner join david.vw_acad_curso_plan vacp on vacp.id_plan_curso = vaca.id_plan_curso and vacp.ciclo < p_ciclo and vacp.id_plan = p_id_plan
        --where vaca.id_persona = p_id_persona and vaca.id_plan_programa = p_id_plan_programa and vaca.estado = '1' and vaca.id_tipo_condicion not in (3,4,5,6,7,15);
        where vaca.id_persona = p_id_persona and vaca.estado = '1' and vaca.id_tipo_condicion not in (2,3,4,5,6,7,15);
    elsif(p_valor = 'PLAN') then
        select nvl(sum(vacp.credito),0) into p_creditos
        from david.vw_acad_curso_plan vacp
        where vacp.id_plan = p_id_plan
        and vacp.modo not in (4)
        and vacp.ciclo < p_ciclo;
    elsif(p_valor = 'CARGA') then
        select (case when c_alum = c_plan then 1 else 0 end) into p_creditos
        from(select fl.c_alum, (select count(id_plan) from david.vw_acad_curso_plan vacp2 where vacp2.id_plan = p_id_plan and vacp2.ciclo = p_ciclo) c_plan
        from (select count(vaca.id_curso_alumno)c_alum
        from david.vw_acad_curso_alumno vaca inner join david.vw_acad_curso_plan vacp on vacp.id_plan_curso = vaca.id_plan_curso and vacp.ciclo = p_ciclo
        where vaca.id_persona = p_id_persona
        and vaca.id_plan_programa = p_id_plan_programa
        and vaca.estado = '1'
        and vaca.id_semestre = p_id_semestre
        and vaca.id_tipo_condicion in (7))fl)ff;
    elsif(p_valor = 'CURSO') then
        select count(vaca.id_curso_alumno) into p_creditos
        from david.vw_acad_curso_alumno vaca
        where vaca.id_persona = p_id_persona and vaca.estado = '1' and vaca.id_plan_programa = p_id_plan_programa and vaca.id_semestre = p_id_semestre and vaca.id_tipo_condicion in (1,7);
    elsif(p_valor = 'PC') then
    ---es para el avance del porcentaje de calificacion por curso p_id_plan_programa=id_carga_curso
        select sum(case when aae.id_carga_evaluacion_detalle is null then ace.ponderado else aced.peso end) into p_creditos
        from david.acad_alumno_evaluacion aae left join david.acad_carga_evaluacion ace on aae.id_carga_curso = ace.id_carga_curso and aae.id_carga_evaluacion_detalle is null and aae.id_carga_evaluacion = ace.id_carga_evaluacion
        left join david.acad_carga_evaluacion_detalle aced on aae.id_carga_evaluacion_detalle = aced.id_carga_evaluacion_detalle
        where aae.id_persona = p_id_persona
        and aae.id_carga_curso = p_id_plan_programa;
    elsif(p_valor = 'PONDERADO')then
    ---ES PARA PONDERADO SIN QUE ESTE CERRADO LOS CURSOS--p_id_plan_programa=p_id_nivel_ensenanza
        select round(sum(nvl(aca.Promedio,0)*aca.Credito)/decode(sum(aca.Credito),0,1,sum(aca.Credito)),2) into p_creditos
        from Vw_Acad_Curso_Alumno  aca inner join Acad_Programa_Estudio ape on Ape.Id_Programa_Estudio=Aca.Id_Programa_Estudio
        inner join acad_carga_curso acc on acc.id_carga_curso=aca.id_carga_curso
        where aca.id_persona=p_id_persona
        and aca.id_semestre=p_id_semestre
        and aca.estado='1' and id_tipo_condicion<>'3' --and acc.cerrado='S'
        and Ape.Id_Nivel_Ensenanza=p_id_plan_programa;
    else
        return null;
    end if;
    return p_creditos;
end;

