-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

function ft_ponderado_anio_plan(p_id_persona in integer,p_id_plan_programa in integer,p_anio in integer) 
return number
is
  p_plan number;
  p_promedio number;
begin  

  select Id_Plan into p_plan from Vw_Plan_Programa where id_plan_programa=p_id_plan_programa;

  select round((sum(promedio*credito)/decode(sum(credito),0,1,sum(credito))),2) into p_promedio
  from (select Distinct acp.id_curso_detalle,acp.Id_Plan_Curso,acp.ciclo,curso,Aca.Promedio,aca.id_tipo_condicion,Acp.Credito
        from acad_plan_programa app inner join Vw_Acad_Curso_Plan acp on Acp.Id_Plan=App.Id_Plan
        inner join acad_curso_alumno aca on aca.id_persona=p_id_persona 
                  and aca.Id_Plan_Curso=decode(acp.Id_Plan_Curso_Electivo,null,acp.Id_Plan_Curso,acp.Id_Plan_Curso_Electivo)
                  and aca.estado='1' and aca.Id_Tipo_Condicion not in (3,7,15)
        where app.ID_PLAN_PROGRAMA=p_id_plan_programa and Acp.Id_Plan_Curso_Electivo is null)
    where floor((ciclo+1)/2)=p_anio;
  
  return p_promedio;
  
end;

