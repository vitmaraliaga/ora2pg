-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

FUNCTION tpp_ponderado_ciclo_test( v_id_persona in integer, v_id_plan_programa in integer, v_id_semestre in integer, v_tipo in varchar2) 
RETURN varchar2 IS

    p_ponderado_acumulado	  number;
  p_ponderado_a_alcanzar	  number;
  p_ponderado_fecha	  number;

BEGIN

    select round(round((sum(ponderado_acumulado*credito)/sum(credito)),2)) ponderado_acumulado, 
    round(round((sum(ponderado_a_alcanzar*credito)/sum(credito)),2)) ponderado_a_alcanzar,
    round(round((sum(ponderado_fecha*credito)/sum(credito)),2)) ponderado_fecha

    into p_ponderado_acumulado, p_ponderado_a_alcanzar, p_ponderado_fecha

    from(
    select Aca.Id_Curso_Alumno,Aca.Nombre_Curso,round(round(((sum(Aae.Nota*Ace.Ponderado)/100)),2)) ponderado_acumulado,
    sum(20*ace.ponderado)/100 ponderado_a_alcanzar,round(round((sum(Aae.Nota*nvl(ace.ponderado,(select sum(aced.peso)from david.acad_carga_evaluacion_detalle aced where aced.id_carga_evaluacion = aae.id_carga_evaluacion and aced.id_tipo_evaluacion = 2)))/sum(nvl(ace.ponderado,(select sum(aced.peso)from david.acad_carga_evaluacion_detalle aced where aced.id_carga_evaluacion = aae.id_carga_evaluacion and aced.id_tipo_evaluacion = 2)))),2)) ponderado_fecha ,credito 
    from Vw_Acad_Curso_Alumno aca inner join Acad_Alumno_Evaluacion aae on Aae.Id_Carga_Curso=Aca.Id_Carga_Curso and Aae.Id_Persona=aca.id_persona
    inner join Acad_Carga_Evaluacion ace on Ace.Id_Carga_Evaluacion=Aae.Id_Carga_Evaluacion
    where aca.id_persona=v_id_persona and aca.Id_Plan_Programa=v_id_plan_programa
    and aca.id_semestre=v_id_semestre and aca.estado='1'
    group by Aca.Id_Curso_Alumno,Aca.Nombre_Curso,credito
    order by Aca.Nombre_Curso);


    if(v_tipo='PA') THEN
      RETURN p_ponderado_acumulado;
    ELSIF(v_tipo='PAA') THEN
      RETURN p_ponderado_a_alcanzar;
    ELSIF(v_tipo='PF') THEN
      RETURN p_ponderado_fecha;
    ELSE
      RETURN NULL;
    END IF;

END;

