-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

function ft_newformat_users(v_id_persona number) RETURN VARCHAR2 AS
  p_users VARCHAR2(200);

BEGIN

select nvl(
    (select decode(decode(sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno)),u.email,
                            sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno||substr(p.codigo,-2))),--2
                            sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno))--1
                        ),u2.email,
                  sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno||substr(p.codigo,-3))),--3
                  decode(sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno)),u.email,
                            sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno||substr(p.codigo,-2))),
                            sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno))
                        )
                )
          
    from (select Distinct p.id_persona,trim(paterno) paterno,trim(materno) materno,trim(nombre) nombres, nvl(nvl(pne.codigo,pn.num_documento),TRUNC(DBMS_RANDOM.VALUE(10000000, 99999999))) codigo
          from moises.persona p inner join moises.persona_natural pn on pn.id_persona=p.id_persona 
          left join moises.persona_natural_alumno pne on pne.id_persona=pn.id_persona where p.id_persona=v_id_persona) p

    left join eliseo.users u on u.email=sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno))

    left join eliseo.users u2 on u2.email=decode(sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno)),u.email,
                                                  sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno||substr(p.codigo,-2))),
                                                  sintilde_con_punto(lower(decode(INSTR(p.nombres,' '),'0',p.nombres,substr(p.nombres,0,INSTR(p.nombres,' ')-1))||'.'||p.paterno)))

    where p.id_persona not in (select id from eliseo.users)),'-1') into p_users
    from dual;

    return replace(p_users,' ','');

end;

