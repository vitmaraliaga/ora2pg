-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

function ft_primer_plan(v_id_persona number,v_id_plan_programa number) RETURN INTEGER AS

  p_res integer;
  p_escuela integer;
  p_nombre_plan varchar2(4000);

BEGIN
select replace(regexp_substr(min(app.nombre_plan||','||app.Id_Plan||',ok'),',[^,]+,'),',','') into p_res
from caleb.Adm_Persona_Inscripcion pi inner join caleb.Adm_Conv_Plan_Programa cpp on Cpp.Id_Conv_Plan_Programa=Pi.Id_Conv_Plan_Programa
inner join caleb.Adm_Convocatoria_Det cd on Cd.Id_Convocatoria_Det=Pi.Id_Convocatoria_Det
inner join caleb.Adm_Convocatoria c on C.Id_Convocatoria=Cd.Id_Convocatoria
inner join david.vw_plan_programa app on app.id_plan_programa=cpp.id_plan_programa
inner join genesis.persona p on p.id_persona=pi.id_persona
inner join MOISES.Persona_Natural_Alumno pa on pa.id_persona=P.Id_Persona_Lamb
where c.nombre=(select min(C.Nombre)
                from caleb.Adm_Persona_Inscripcion pi inner join caleb.Adm_Conv_Plan_Programa cpp2 on Cpp2.Id_Conv_Plan_Programa=Pi.Id_Conv_Plan_Programa
                inner join caleb.Adm_Convocatoria_Det cd on Cd.Id_Convocatoria_Det=Pi.Id_Convocatoria_Det
                inner join caleb.Adm_Convocatoria c on C.Id_Convocatoria=Cd.Id_Convocatoria
                inner join david.vw_plan_programa app2 on app2.id_plan_programa=cpp2.id_plan_programa
                where id_escuela=app.id_escuela and id_persona=p.id_persona)
and pa.id_persona=v_id_persona and id_escuela=(select id_escuela from DAVID.Vw_Plan_Programa where id_plan_programa=v_id_plan_programa);

if(p_res is null) then
  
  select id_escuela,Nombre_Plan into p_escuela,p_nombre_plan
  from Vw_Alumno_Plan_Programa where id_persona=v_id_persona and Id_Plan_Programa=v_id_plan_programa;
  
  select replace(regexp_substr(min(nombre_plan||','||id_plan||',ok'),',[^,]+,'),',','') into p_res
  from Vw_Alumno_Plan_Programa where id_persona=v_id_persona and id_escuela=p_escuela and Nombre_Plan<=p_nombre_plan;
  
end if;

return p_res;

end;

