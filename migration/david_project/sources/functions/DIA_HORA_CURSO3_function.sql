-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON

FUNCTION DIA_HORA_CURSO3(HORARIO VARCHAR2,v_id_horario integer)
RETURN VARCHAR2 IS

dias VARCHAR2(100) := ' ';
dias2 VARCHAR(100);
corte INTEGER :=1;
turno2 varchar2(100);
turno varchar2(100);
val VARCHAR2(100);
var VARCHAR2(100);

tm INTEGER;
tt INTEGER;
tn INTEGER;


BEGIN

select sum(decode(id_tipo_turno,1,1,0)),
sum(decode(id_tipo_turno,1,1,0))+sum(decode(id_tipo_turno,2,1,0)),
sum(decode(id_tipo_turno,1,1,0))+sum(decode(id_tipo_turno,2,1,0))+sum(decode(id_tipo_turno,3,1,0))
into tm,tt,tn
from ACAD_HORARIO_DETALLE where id_horario=v_id_horario
group by id_horario;
        
  FOR i IN 1..30 LOOP
      val := SUBSTR(HORARIO,corte ,corte+7); 
     FOR y IN 1..7 LOOP
      var := substr(val,y,1);
      IF var ='1' THEN
        IF INSTR(dias,to_char(y)) =0 THEN
          dias :=CONCAT(dias, y);
          CASE
             WHEN i<=tm THEN turno :=CONCAT(turno, CONCAT('M',i));
             WHEN i>tm and i<=tt THEN turno :=CONCAT(turno,CONCAT('T',i-tm));
             ELSE
              turno :=CONCAT(turno,CONCAT('N',i-tt));
          END CASE;
          --turno :=CONCAT(turno,turno);
        END IF;
      END IF;
        
    END LOOP;
      corte:=corte+7;
  END LOOP;
  
  corte:=1;
  IF LENGTH(TRIM(dias)) >0 THEN
    FOR y IN 1..length(TRIM(dias)) LOOP
      var := substr(trim(dias),y,1);
      turno2 := substr(trim(turno),corte,2);
      corte :=corte+2;
      CASE
       WHEN var = '1' THEN IF y<length(TRIM(dias)) THEN dias2 :=CONCAT(dias2, CONCAT('D', CONCAT(turno2,','))); ELSE dias2 :=CONCAT(dias2, CONCAT('D',turno2)); END IF ;
       WHEN var = '2' THEN IF y<length(TRIM(dias)) THEN dias2 :=CONCAT(dias2, CONCAT('L',CONCAT(turno2,',')));ELSE dias2 :=CONCAT(dias2, CONCAT('L', turno2)); END IF ;
       WHEN var = '3' THEN IF y<length(TRIM(dias)) THEN dias2 :=CONCAT(dias2, CONCAT('R',CONCAT(turno2,',')));ELSE dias2 :=CONCAT(dias2, CONCAT('R',turno2)); END IF ;
       WHEN var = '4' THEN IF y<length(TRIM(dias)) THEN dias2 :=CONCAT(dias2, CONCAT('W',CONCAT(turno2,',')));ELSE dias2 :=CONCAT(dias2, CONCAT('W',turno2)); END IF ;
       WHEN var = '5' THEN IF y<length(TRIM(dias)) THEN dias2 :=CONCAT(dias2, CONCAT('J',CONCAT(turno2,',')));ELSE dias2 :=CONCAT(dias2, CONCAT('J', turno2)); END IF ;
       WHEN var = '6' THEN IF y<length(TRIM(dias)) THEN dias2 :=CONCAT(dias2, CONCAT('V',CONCAT(turno2,',')));ELSE dias2 :=CONCAT(dias2, CONCAT('V',turno2)); END IF ;
       ELSE IF y<=length(TRIM(dias)) THEN dias2 :=CONCAT(dias2, CONCAT('S',CONCAT(turno2,',')));ELSE dias2 :=CONCAT(dias2, CONCAT('S', turno2)); END IF ;
      END CASE;
    END LOOP;
  END IF;
          

RETURN (trim(dias2));
END;

