-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_max_eap_gradu (v_id_persona integer,v_tipo text) RETURNS varchar AS $body$
DECLARE


  p_res varchar(200);

  p_plan varchar(200);
  p_facultad varchar(200);
  p_escuela varchar(200);
  p_anio varchar(200);
  p_semestre varchar(200);


BEGIN
    select ''||id_plan_programa,Nom_Facultad,Nom_Escuela,''||Anio,semestre into STRICT p_plan,p_facultad,p_escuela,p_anio,p_semestre
    from (SELECT vpp.id_plan_programa,Vpp.Nom_Facultad,Vpp.Nom_Escuela,Pne.Anio,asm.semestre
          from moises.persona_natural_egresado pne
          inner join Vw_Plan_Programa vpp on Vpp.Id_Plan_Programa=Pne.Id_Plan_Programa
          inner join acad_semestre asm on asm.id_semestre=pne.id_semestre
          where pne.id_persona=v_id_persona and Vpp.Id_Nivel_Ensenanza in (1,2) 
          order by Pne.Anio desc,pne.id_semestre desc, vpp.id_plan_programa) alias1 LIMIT 1;

    if (v_tipo='p') then
      p_res:=p_plan;
    elsif (v_tipo='f') then
      p_res:=p_facultad;
    elsif (v_tipo='e') then
      p_res:=p_escuela;
    elsif (v_tipo='a') then
      p_res:=p_anio;
    elsif (v_tipo='t') then
      p_res:=p_facultad||' - '||p_escuela;
    elsif (v_tipo='s') then
      p_res:=p_semestre;
    end if;

    return p_res;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_max_eap_gradu (v_id_persona integer,v_tipo text) FROM PUBLIC;

