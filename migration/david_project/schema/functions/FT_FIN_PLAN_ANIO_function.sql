-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_fin_plan_anio (p_id_persona integer,p_id_plan_programa integer, p_anio integer) RETURNS varchar AS $body$
DECLARE

  p_ciclo bigint;
  res bigint;
  p_res varchar(10);

BEGIN

    select (p_anio*2) into STRICT p_ciclo;

    select coalesce((SELECT count(APCA.ID_PLAN_CURSO)
    FROM ACAD_PLAN_PROGRAMA APP
    INNER JOIN ACAD_PLAN_CURSO APCA ON APCA.ID_PLAN=APP.ID_PLAN AND APP.ID_PLAN_PROGRAMA=p_id_plan_programa
    AND coalesce(APCA.ID_PLAN_CURSO_ELECTIVO::text, '') = '' AND APCA.CICLO <= p_ciclo 
    WHERE NOT EXISTS (SELECT 1
                FROM ACAD_CURSO_ALUMNO ACA 
                INNER JOIN ACAD_PLAN_CURSO APC ON APC.ID_PLAN_CURSO=ACA.ID_PLAN_CURSO
                WHERE ACA.ID_PERSONA=p_id_persona AND ACA.ID_PLAN_PROGRAMA=p_id_plan_programa 
                AND APC.CICLO <= p_ciclo
                AND ACA.ID_TIPO_CONDICION IN (1,13,17) AND ACA.ESTADO='1'
                AND CASE WHEN coalesce(APC.ID_PLAN_CURSO_ELECTIVO::text, '') = '' THEN APC.ID_PLAN_CURSO  ELSE APC.ID_PLAN_CURSO_ELECTIVO END =APCA.ID_PLAN_CURSO ) ),0) into STRICT res
;

    if (res=0) then p_res:='S';
    else p_res:='N';
    end if;

    
  return p_res;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_fin_plan_anio (p_id_persona integer,p_id_plan_programa integer, p_anio integer) FROM PUBLIC;

