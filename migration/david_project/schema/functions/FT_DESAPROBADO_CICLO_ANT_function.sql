-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_desaprobado_ciclo_ant (v_id_persona integer,v_id_escuela integer, v_tipo text) RETURNS varchar AS $body$
DECLARE


	p_semestre	  varchar(800);
  p_num	  varchar(800);
  p_desa	  varchar(800);
  p_res	  varchar(800);
		

BEGIN

  select semestre,num,num_desa into STRICT p_semestre,p_num,p_desa
	from (SELECT vca.semestre,
        count(aca.id_tipo_condicion) num, sum(CASE WHEN aca.id_tipo_condicion=2 THEN 1  ELSE 0 END ) num_desa
        from acad_curso_alumno aca inner join vw_acad_carga_academica vca on Vca.Id_Carga_Curso=Aca.Id_Carga_Curso and aca.id_persona=v_id_persona
                                    and substr(vca.semestre,-2) in ('-1','-2') and aca.estado='1'
        inner join Acad_Plan_Curso apc on Apc.Id_Plan_Curso=Vca.Id_Plan_Curso
        inner join Vw_Acad_Plan vap on Vap.Id_Plan=apc.id_plan and vap.id_escuela=v_id_escuela 
        group by vca.semestre
        order by vca.semestre desc) alias4 LIMIT 1;

  if (v_tipo='t') then
  
    if (p_desa>0) then
      p_res:='S';
    else
      p_res:='N';
    end if;
  else
  
    if (v_tipo='p') then
    
      if(((p_num/2)-p_desa)<0) then
        p_res:='S';
      else
        p_res:='N';
      end if;

    end if;

  end if;

return p_res;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_desaprobado_ciclo_ant (v_id_persona integer,v_id_escuela integer, v_tipo text) FROM PUBLIC;

