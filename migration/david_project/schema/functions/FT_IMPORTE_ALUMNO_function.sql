-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_importe_alumno (v_id_persona integer, v_anio integer,v_id_depto text) RETURNS varchar AS $body$
DECLARE

  importe	  varchar(500);		


BEGIN

select  sum(z.importe) into STRICT importe
            
    from
    (
    SELECT  c.id_depto,
            c.id_deposito  id_documento,   
            c.id_cliente id_cliente,        
            --eliseo.fc_codigo_alumno(c.id_cliente) codigo,
            'DEPOSITO' TIPO_MOV,
            --eliseo.FC_NOMBRE_PERSONA(c.id_cliente) estudiante,
            to_char(c.fecha,'dd/mm/yyyy') fecha,
            to_char(c.fecha,'yyyy-mm') mes,
            c.serie||'-'||c.numero documento,
            c.glosa,
            c.importe*(-1) importe
            
    from ELISEO.caja_deposito c
    where c.id_entidad = 7124
      and c.id_anho = v_anio 
      and c.id_depto = v_id_depto
      and c.id_tipodeposito in (1,2,3)
      and coalesce(c.id_vale::text, '') = ''
      and c.importe <> 0
      and c.estado = 1
      and C.Id_Cliente=v_id_persona
      --and to_char(nvl(c.fecha_operacion, c.fecha), 'yyyymmdd') <= 'v_anio1128'  --MODIFICAR FECHA
     -- and to_char(c.fecha, 'yyyymmdd') <= 'v_anio1128'  --MODIFICAR FECHA
 
    
    
union all

    
    SELECT  c.id_depto,
            c.id_pago  id_documento,   
            cpg.id_cliente id_cliente,
            --eliseo.fc_codigo_alumno(cpg.id_cliente) codigo,
            'DEPOSITO' TIPO_MOV,
            --eliseo.FC_NOMBRE_PERSONA(cpg.id_cliente) estudiante,
            to_char(c.fecha,'dd/mm/yyyy') fecha,
            to_char(c.fecha,'yyyy-mm') mes,
            c.numero documento,
            cpg.detalle glosa,
            cpg.importe importe
            
    from ELISEO.caja_pago c, eliseo.caja_pago_venta cpg
    where c.id_entidad = 7124
      and c.id_anho = v_anio 
      and c.id_depto = v_id_depto
      and c.id_pago = cpg.id_pago
      and cpg.importe <> 0
      and c.estado = 1
      and cpg.id_cliente=v_id_persona
      --and to_char(c.fecha, 'yyyymmdd') <= 'v_anio1128'  --MODIFICAR FECHA
    
    
union all

    
    select  v.id_depto,
            v.id_venta  id_documento,   
            v.id_cliente id_cliente,
            --eliseo.fc_codigo_alumno(v.id_cliente) codigo,
            'COBRANZA' TIPO_MOV,
            --eliseo.FC_NOMBRE_PERSONA(v.id_cliente) estudiante,
            to_char(v.fecha,'dd/mm/yyyy') fecha,
            to_char(v.fecha,'yyyy-mm') mes,
            v.serie||'-'||v.numero documento,
            v.glosa,
            v.total*CASE WHEN v.id_comprobante='07' THEN -1  ELSE 1 END  importe
            
    from ELISEO.venta v
    where v.id_entidad = 7124
      and v.id_anho = v_anio 
      and v.id_depto = v_id_depto
      and v.id_tipoventa not in (5,6)
      and v.total <> 0
      and v.estado = 1      
      and v.id_cliente=v_id_persona
      --and to_char(v.fecha, 'yyyymmdd') <= 'v_anio1128'  --MODIFICAR FECHA
 
      
    
union all

    
    select  vt.id_depto,
            vt.id_transferencia  ,   
            vt.id_cliente,
            --eliseo.fc_codigo_alumno(id_cliente) codigo,
            'COBRANZA' TIPO_MOV,
            --eliseo.FC_NOMBRE_PERSONA(id_cliente) estudiante,
            to_char(vt.fecha,'dd/mm/yyyy') fecha,
            to_char(vt.fecha,'yyyy-mm') mes,
            vt.serie||'-'||vt.numero documento,
            vtd.detalle,
            sum(vtd.importe*CASE WHEN vtd.DC='D' THEN  1  ELSE -1 END ) importe
            
    from ELISEO.venta_transferencia vt, eliseo.venta_transferencia_detalle vtd
    where vt.id_transferencia = vtd.id_transferencia
      and vt.id_entidad = 7124
      and vt.id_anho = v_anio 
      and vt.id_depto = v_id_depto
      --and vt.serie = 'T600'
      and coalesce(vt.id_tipotransaccion, 0) not in (173,174,177)
      and vt.importe <> 0
      and vt.estado = 1      
      and vt.id_cliente=v_id_persona
      --and to_char(vt.fecha, 'yyyymmdd') <= 'v_anio1128'  --MODIFICAR FECHA
    group by vt.id_depto,
            vt.id_transferencia  ,   
            vt.id_cliente,
            --eliseo.fc_codigo_alumno(id_cliente) ,
            'COBRANZA',
            --eliseo.FC_NOMBRE_PERSONA(id_cliente) ,
            to_char(vt.fecha,'dd/mm/yyyy') ,
            to_char(vt.fecha,'yyyy-mm') ,
            vt.serie||'-'||vt.numero ,
            vtd.detalle 
    
    
union all

    
    select  vs.id_depto,
            vs.id_venta,   
            vs.id_cliente,
            --eliseo.fc_codigo_alumno(vs.id_cliente) codigo,
            'COBRANZA' TIPO_MOV,
            --eliseo.FC_NOMBRE_PERSONA(vs.id_cliente) estudiante,
            to_char(vs.fecha,'dd/mm/yyyy') fecha,
            to_char(vs.fecha,'yyyy-mm') mes,
            vs.serie||'-'||vs.numero documento,
            vs.detalle glosa,
            vs.total
    
    from ELISEO.venta_saldo vs
    where vs.id_entidad = 7124
      and vs.id_anho = v_anio 
      and vs.id_depto = v_id_depto
      and vs.total <> 0
      and vs.id_cliente=v_id_persona
      
    
    order by 4 asc
    
    ) z 
    
    where z.id_depto = v_id_depto
    
    group by 
    z.id_depto,
    --eliseo.fc_codigo_alumno(z.id_cliente) 
    z.id_cliente
    --z.estudiante
;
    return importe;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_importe_alumno (v_id_persona integer, v_anio integer,v_id_depto text) FROM PUBLIC;

