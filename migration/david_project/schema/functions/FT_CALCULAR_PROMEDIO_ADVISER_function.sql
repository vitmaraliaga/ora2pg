-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_calcular_promedio_adviser (v_id_carga_curso bigint, v_id_persona bigint, v_id_programa_estudio bigint) RETURNS bigint AS $body$
DECLARE

    promedio_minimo_cat bigint;
    promedio_ponderado bigint;
    promedio_final bigint;
    ponderado bigint;
    promedio_res varchar(200);

BEGIN

    if (v_id_programa_estudio = 77) then

        select round((sum(nota*ponderado)/sum(ponderado))::numeric,2) ,sum(ponderado)
        into STRICT promedio_ponderado,ponderado
        from (SELECT Ace.Descripcion,Ace.Fecha_Evaluacion,Ace.Ponderado ponderado_ref,coalesce(Aae.Nota,0) nota,
              (case when to_date(substr(Ace.Fecha_Evaluacion,0,10),'YYYY-MM-DD')<=to_date(substr(clock_timestamp(),0,10),'YYYY-MM-DD') or (nota IS NOT NULL AND nota::text <> '') then Ace.Ponderado else 0 end) ponderado
              from acad_carga_evaluacion ace 
              left join acad_alumno_evaluacion aae on ace.id_carga_evaluacion = aae.id_carga_evaluacion and aae.id_persona = v_id_persona
              where ace.id_carga_curso = v_id_carga_curso) alias14 
        where ponderado <>0;
        
        select min(round((sum(nota*ponderado)/sum(ponderado))::numeric,2)) into STRICT  promedio_minimo_cat
        from (
        SELECT ae.id_tipo_estrategia,Ace.Descripcion,Ace.Fecha_Evaluacion,Ace.Ponderado ponderado_ref,coalesce(Aae.Nota,0) nota,
        (case when to_date(substr(Ace.Fecha_Evaluacion,0,10),'YYYY-MM-DD')<=to_date(substr(clock_timestamp(),0,10),'YYYY-MM-DD') or (nota IS NOT NULL AND nota::text <> '') then Ace.Ponderado else 0 end) ponderado
        from acad_carga_evaluacion ace 
        left join acad_alumno_evaluacion aae on ace.id_carga_evaluacion = aae.id_carga_evaluacion and aae.id_persona = v_id_persona
        left join acad_estrategia ae on ae.id_estrategia = ace.id_estrategia
        where ace.id_carga_curso = v_id_carga_curso
        ) alias13 
        where ponderado <>0
        group by id_tipo_estrategia;

        if (promedio_minimo_cat < 12.5) then
            promedio_final := promedio_minimo_cat;
        else
            promedio_final := promedio_ponderado;
        end if;

    else
    
        select round((sum(nota*ponderado)/sum(ponderado))::numeric,2) , sum(ponderado)
        into STRICT promedio_final,ponderado
        from (SELECT Ace.Descripcion,Ace.Fecha_Evaluacion,Ace.Ponderado ponderado_ref,coalesce(Aae.Nota,0) nota,
              (case when to_date(substr(Ace.Fecha_Evaluacion,0,10),'YYYY-MM-DD')<=to_date(substr(clock_timestamp(),0,10),'YYYY-MM-DD') or (nota IS NOT NULL AND nota::text <> '') then Ace.Ponderado else 0 end) ponderado
              from acad_carga_evaluacion ace 
              left join acad_alumno_evaluacion aae on ace.id_carga_evaluacion = aae.id_carga_evaluacion and aae.id_persona = v_id_persona
              where ace.id_carga_curso = v_id_carga_curso) alias13 
        where ponderado <>0  LIMIT 1;
        
    end if;

    if (coalesce(promedio_final::text, '') = '') then
      promedio_res:=null;
    elsif (promedio_final=0) then
      promedio_res:='0';
    else
      promedio_res:=promedio_final||' ('||ponderado||'%)';
    end if;

    return promedio_final;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_calcular_promedio_adviser (v_id_carga_curso bigint, v_id_persona bigint, v_id_programa_estudio bigint) FROM PUBLIC;

