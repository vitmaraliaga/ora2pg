-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_total_desa_plan (p_id_persona integer,p_id_plan_programa integer) RETURNS bigint AS $body$
DECLARE

  p_plan bigint;
  p_num bigint;

BEGIN

  select Id_Plan into STRICT p_plan from Vw_Plan_Programa where id_plan_programa=p_id_plan_programa;

  select count(*) into STRICT p_num
  from ( SELECT Id_Plan_Curso,ciclo,curso, count(*) num
        from (select Distinct acp.id_curso_detalle,Id_Plan_Curso,ciclo,curso,Aca.Promedio,aca.id_tipo_condicion,Acp.Credito,fecha
              from Vw_Acad_Curso_Plan acp 
              inner join(select Distinct id_carga_curso,Vce.Id_Curso_Detalle,promedio,apc.id_tipo_condicion,min(fecha) fecha
                          from (select id_carga_curso,id_curso_detalle,promedio,id_tipo_condicion,min(fecha) fecha
                              from (
                                      SELECT aca.id_carga_curso,coalesce(apc.id_curso_detalle,aca.id_curso_detalle) id_curso_detalle,
                                      aca.promedio,aca.id_tipo_condicion,coalesce(fecha_fin,aca.fecha_registro) fecha
                                      from acad_curso_alumno aca inner join acad_plan_programa app
                                                              on app.id_plan_programa=aca.id_plan_programa and (aca.id_plan_programa IS NOT NULL AND aca.id_plan_programa::text <> '')
                                                              and aca.id_persona=p_id_persona and aca.id_tipo_condicion = 2 and aca.estado='1'
                                      left join acad_plan_curso apc on apc.id_plan=app.id_plan and apc.id_curso_detalle=aca.id_curso_detalle
                                      left join(select accd.id_carga_curso,max(amd.fecha_fin) fecha_fin
                                                  from acad_carga_curso_docente accd inner join acad_modulo_detalle amd on amd.id_modulo_detalle=accd.id_modulo_detalle
                                                  group by accd.id_carga_curso) accd on accd.id_carga_curso=aca.id_carga_curso
                                      where coalesce(Apc.Id_Plan_Curso_Electivo::text, '') = '' 
                                      
union

                                      select aca.id_carga_curso,apce.id_curso_detalle,
                                      aca.promedio,aca.id_tipo_condicion,coalesce(fecha_fin,aca.fecha_registro) fecha
                                      from acad_curso_alumno aca inner join acad_plan_programa app on app.id_plan_programa=aca.id_plan_programa
                                                              and aca.id_persona=p_id_persona and aca.id_tipo_condicion = 2 and aca.estado='1'
                                      left join acad_plan_curso apc on apc.id_plan=app.id_plan and apc.id_curso_detalle=aca.id_curso_detalle
                                      left join acad_plan_curso apce on apce.id_plan_curso=apc.id_plan_curso_electivo
                                      left join(select accd.id_carga_curso,max(amd.fecha_fin) fecha_fin
                                                  from acad_carga_curso_docente accd inner join acad_modulo_detalle amd on amd.id_modulo_detalle=accd.id_modulo_detalle
                                                  group by accd.id_carga_curso) accd on accd.id_carga_curso=aca.id_carga_curso
                                      where (apce.id_curso_detalle IS NOT NULL AND apce.id_curso_detalle::text <> '') ) alias14 
                              group by id_carga_curso,id_curso_detalle,promedio,id_tipo_condicion
                              
union

                              select aca.id_carga_curso,aca.id_curso_detalle,
                                      aca.promedio,aca.id_tipo_condicion,aca.fecha_registro fecha
                              from acad_curso_alumno aca
                              where aca.id_persona=p_id_persona and aca.id_tipo_condicion=2 and coalesce(id_plan_programa::text, '') = '' and aca.estado='1'
                              and id_curso_detalle not in (select vce.id_curso_detalle from acad_curso_alumno aca inner join vw_curso_equivalente vce on vce.curso_equiv=aca.id_curso_detalle
                                                              where id_persona=p_id_persona and id_tipo_condicion=2 and (id_plan_programa IS NOT NULL AND id_plan_programa::text <> '') ) ) Apc
                          inner join vw_curso_equivalente vce on Vce.Curso_Equiv=Apc.Id_Curso_Detalle 
                          group by id_carga_curso,Vce.Id_Curso_Detalle,promedio,apc.id_tipo_condicion
                          ) aca
                      on Aca.Id_Curso_Detalle=Acp.Id_Curso_Detalle
              where id_plan=p_plan and coalesce(Acp.Id_Plan_Curso_Electivo::text, '') = '' ) alias21 
          group by Id_Plan_Curso,ciclo,curso) alias22;

  return p_num;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_total_desa_plan (p_id_persona integer,p_id_plan_programa integer) FROM PUBLIC;

