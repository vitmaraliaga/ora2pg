-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_primer_plan (v_id_persona bigint,v_id_plan_programa bigint) RETURNS integer AS $body$
DECLARE


  p_res integer;
  p_escuela integer;
  p_nombre_plan varchar(4000);


BEGIN
select replace((SELECT array_to_string(a, '') FROM regexp_matches(min(app.nombre_plan||','||app.Id_Plan||',ok'), ',[^,]+,', 'g') AS foo(a) LIMIT 1 OFFSET (1 - 1) ),',','') into STRICT p_res
from caleb.Adm_Persona_Inscripcion pi inner join caleb.Adm_Conv_Plan_Programa cpp on Cpp.Id_Conv_Plan_Programa=Pi.Id_Conv_Plan_Programa
inner join caleb.Adm_Convocatoria_Det cd on Cd.Id_Convocatoria_Det=Pi.Id_Convocatoria_Det
inner join caleb.Adm_Convocatoria c on C.Id_Convocatoria=Cd.Id_Convocatoria
inner join david.vw_plan_programa app on app.id_plan_programa=cpp.id_plan_programa
inner join genesis.persona p on p.id_persona=pi.id_persona
inner join MOISES.Persona_Natural_Alumno pa on pa.id_persona=P.Id_Persona_Lamb
where c.nombre=(SELECT min(C.Nombre)
                from caleb.Adm_Persona_Inscripcion pi inner join caleb.Adm_Conv_Plan_Programa cpp2 on Cpp2.Id_Conv_Plan_Programa=Pi.Id_Conv_Plan_Programa
                inner join caleb.Adm_Convocatoria_Det cd on Cd.Id_Convocatoria_Det=Pi.Id_Convocatoria_Det
                inner join caleb.Adm_Convocatoria c on C.Id_Convocatoria=Cd.Id_Convocatoria
                inner join david.vw_plan_programa app2 on app2.id_plan_programa=cpp2.id_plan_programa
                where id_escuela=app.id_escuela and id_persona=p.id_persona)
and pa.id_persona=v_id_persona and id_escuela=(select id_escuela from DAVID.Vw_Plan_Programa where id_plan_programa=v_id_plan_programa);

if (coalesce(p_res::text, '') = '') then

  select id_escuela,Nombre_Plan into STRICT p_escuela,p_nombre_plan
  from Vw_Alumno_Plan_Programa where id_persona=v_id_persona and Id_Plan_Programa=v_id_plan_programa;

  select replace((SELECT array_to_string(a, '') FROM regexp_matches(min(nombre_plan||','||id_plan||',ok'), ',[^,]+,', 'g') AS foo(a) LIMIT 1 OFFSET (1 - 1) ),',','') into STRICT p_res
  from Vw_Alumno_Plan_Programa where id_persona=v_id_persona and id_escuela=p_escuela and Nombre_Plan<=p_nombre_plan;

end if;

return p_res;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_primer_plan (v_id_persona bigint,v_id_plan_programa bigint) FROM PUBLIC;

