-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_graduado_plan_fecha (p_id_persona integer,p_id_plan_programa integer,p_fecha text) RETURNS bigint AS $body$
DECLARE

  p_plan bigint;
  p_area bigint;
  p_anio bigint;
  res bigint;

BEGIN

  
    select coalesce((SELECT count(APCA.ID_PLAN_CURSO)
    FROM ACAD_PLAN_PROGRAMA APP
    INNER JOIN ACAD_PLAN_CURSO APCA ON APCA.ID_PLAN=APP.ID_PLAN AND APP.ID_PLAN_PROGRAMA=p_id_plan_programa
    AND coalesce(APCA.ID_PLAN_CURSO_ELECTIVO::text, '') = ''
    WHERE APCA.estado='1'
    and NOT EXISTS (SELECT 1
                FROM ACAD_CURSO_ALUMNO ACA 
                INNER JOIN ACAD_PLAN_CURSO APC ON APC.ID_PLAN_CURSO=ACA.ID_PLAN_CURSO
                WHERE ACA.ID_PERSONA=p_id_persona AND ACA.ID_PLAN_PROGRAMA=p_id_plan_programa 
                AND ACA.ID_TIPO_CONDICION IN (1,/*7,*/
13,17) AND ACA.ESTADO='1' and Aca.Fecha_Registro<=p_fecha
                AND CASE WHEN coalesce(APC.ID_PLAN_CURSO_ELECTIVO::text, '') = '' THEN APC.ID_PLAN_CURSO  ELSE APC.ID_PLAN_CURSO_ELECTIVO END =APCA.ID_PLAN_CURSO ) ),0) into STRICT res
;

  return res;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_graduado_plan_fecha (p_id_persona integer,p_id_plan_programa integer,p_fecha text) FROM PUBLIC;

