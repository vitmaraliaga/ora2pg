-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.fc_tiene_reserva_residencia (P_ID_PERSONA MOISES.PERSONA_NATURAL_ALUMNO.ID_PERSONA%TYPE) RETURNS varchar AS $body$
DECLARE

    R_ESTADO varchar(1);


BEGIN


    SELECT (CASE
                WHEN EXISTS (SELECT ARR.ID_RESERVA_RESIDENCIA
                            FROM ACAD_RESERVA_RESIDENCIA ARR
                            where ARR.ID_PERSONA = P_ID_PERSONA
                              and ARR.ID_SEMESTRE IN (SELECT A2.ID_SEMESTRE
                                                      FROM ACAD_SEMESTRE A2
                                                      WHERE A2.SEMESTRE IN (SELECT MAX(ASM.SEMESTRE) SEMESTRE
                                                                            FROM ACAD_ALUMNO_CONTRATO AAC
                                                                                     INNER JOIN ACAD_SEMESTRE_PROGRAMA ASP
                                                                                                ON ASP.ID_SEMESTRE_PROGRAMA =
                                                                                                   AAC.ID_SEMESTRE_PROGRAMA
                                                                                                    AND AAC.ID_PERSONA =
                                                                                                        P_ID_PERSONA
                                                                                                    AND AAC.ESTADO = '1'
                                                                                     INNER JOIN ACAD_SEMESTRE ASM ON ASM.ID_SEMESTRE = ASP.ID_SEMESTRE
                                                                            WHERE SUBSTR(ASM.SEMESTRE, -2) IN ('-1', '-2') )   LIMIT 1) ) THEN 1
                ELSE 0
        END)
    INTO STRICT R_ESTADO
;


    return R_ESTADO;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.fc_tiene_reserva_residencia (P_ID_PERSONA MOISES.PERSONA_NATURAL_ALUMNO.ID_PERSONA%TYPE) FROM PUBLIC;

