-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_always_user (v_id_persona bigint, v_opcion bigint) RETURNS varchar AS $body$
DECLARE




  p_users varchar(200);




BEGIN



    select
    
    CASE 
	    WHEN 
	       v_opcion=1 THEN 
    coalesce(

CASE WHEN coalesce(u4.email::text, '') = '' THEN  CASE WHEN coalesce(u3.email::text, '') = '' THEN  CASE WHEN coalesce(u2.email::text, '') = '' THEN  CASE WHEN coalesce(u.email::text, '') = '' THEN /*1*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))/*1*/
  ELSE /*2*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||'.'||SUBSTR(p.paterno,0,1)))/*2*/
 END   ELSE /*3*/
sintilde_con_punto(replace(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ||'.'||p.paterno),' ',''))/*3*/
 END   ELSE /*4*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||substr(p.paterno,0,1)||'.'||p.materno))/*4*/
 END   ELSE /*5*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||substr(p.paterno,0,1)||'.'||p.materno))||round(dbms_random.value(1, 9))/*5*/
 END ,

                        sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))||round(dbms_random.value(1, 9))) 
                        
                        WHEN v_opcion=2
                         	THEN documentos
                        ELSE 'null'  
	END INTO STRICT p_users
    from (SELECT Distinct p.id_persona,paterno,materno,nombre nombres, p.codigo codigo_personal,pn.num_documento documentos,id_tipodocumento tipo_documento 



          from moises.persona p inner join moises.persona_natural pn on pn.id_persona=p.id_persona where p.id_persona=v_id_persona) p

 
    left join eliseo.users u on u.email=sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))

    left join eliseo.users u2 on u2.email=CASE WHEN coalesce(u.email::text, '') = '' THEN /*1*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))/*1*/
  ELSE /*2*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||'.'||SUBSTR(p.paterno,0,1)))/*2*/
 END 

    left join eliseo.users u3 on u3.email=CASE WHEN coalesce(u2.email::text, '') = '' THEN  CASE WHEN coalesce(u.email::text, '') = '' THEN /*1*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))/*1*/
  ELSE /*2*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||'.'||SUBSTR(p.paterno,0,1)))/*2*/
 END   ELSE /*3*/
sintilde_con_punto(replace(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ||'.'||p.paterno),' ',''))/*3*/
 END 

    left join eliseo.users u4 on u4.email=CASE WHEN coalesce(u3.email::text, '') = '' THEN  CASE WHEN coalesce(u2.email::text, '') = '' THEN  CASE WHEN coalesce(u.email::text, '') = '' THEN /*1*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))/*1*/
  ELSE /*2*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||'.'||SUBSTR(p.paterno,0,1)))/*2*/
 END   ELSE /*3*/
sintilde_con_punto(replace(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ||'.'||p.paterno),' ',''))/*3*/
 END   ELSE /*4*/
sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||substr(p.paterno,0,1)||'.'||p.materno))/*4*/
 END;



    return p_users;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_always_user (v_id_persona bigint, v_opcion bigint) FROM PUBLIC;

