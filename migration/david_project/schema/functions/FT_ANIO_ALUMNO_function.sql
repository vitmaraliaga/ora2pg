-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_anio_alumno ( v_id_persona integer, v_id_plan_programa integer) RETURNS varchar AS $body$
DECLARE


x_creditos integer;
p_anio_s  integer;
a_creditos integer;	

alum_credito CURSOR FOR   
  SELECT sum(acd.credito) sum_credito
  from acad_plan_programa app 
  inner join acad_plan_curso apc on apc.id_plan=app.id_plan and app.id_plan_programa=v_id_plan_programa
  inner join(SELECT vce.id_curso_detalle
              from acad_curso_alumno aca inner join vw_curso_equivalente vce on vce.id_curso_detalle=aca.id_curso_detalle 
                                          and aca.id_persona=v_id_persona and aca.id_tipo_condicion=1
              inner join acad_plan_programa app on app.id_plan_programa=aca.id_plan_programa
              inner join acad_plan_curso apc on apc.id_plan=app.id_plan and apc.id_curso_detalle=vce.curso_equiv
              group by vce.id_curso_detalle) cd
      on cd.id_curso_detalle=apc.id_curso_detalle
  inner join acad_curso_detalle acd on acd.id_curso_detalle=apc.id_curso_detalle;

plan_credito CURSOR FOR
  SELECT apc.ciclo,CASE WHEN apc.ciclo='1' THEN '1' WHEN apc.ciclo='2' THEN '1' WHEN apc.ciclo='3' THEN '2' WHEN apc.ciclo='4' THEN '2' WHEN apc.ciclo='5' THEN '3' WHEN apc.ciclo='6' THEN '3' WHEN apc.ciclo='7' THEN '4' WHEN apc.ciclo='8' THEN '4' WHEN apc.ciclo='9' THEN '5' WHEN apc.ciclo='10' THEN '5' WHEN apc.ciclo='11' THEN '6' WHEN apc.ciclo='12' THEN '6' WHEN apc.ciclo='13' THEN '7' WHEN apc.ciclo='14' THEN '7' END  p_anio,
          sum(ac.credito) p_creditos
  from acad_plan_curso apc inner join acad_curso_detalle ac on ac.id_curso_detalle=apc.id_curso_detalle
  inner join acad_plan_programa app on app.id_plan=apc.id_plan and app.id_plan_programa=v_id_plan_programa
  group by apc.ciclo
  order by apc.ciclo asc;

BEGIN

  open alum_credito;
		 fetch alum_credito into a_creditos;
			 if NOT FOUND then
		 	 	a_creditos:=0;
			 end if;
     close alum_credito;	
	 if coalesce(a_creditos::text, '') = '' then a_creditos:=0;end if;

   select sum(acd.credito) into STRICT x_creditos
    from acad_plan_programa app 
    inner join acad_plan_curso apc on apc.id_plan=app.id_plan and app.id_plan_programa=v_id_plan_programa and apc.ciclo='1'
    inner join acad_curso_detalle acd on acd.id_curso_detalle=apc.id_curso_detalle;
    
   if coalesce(x_creditos::text, '') = '' then x_creditos:=0;end if;
   
   for reg in plan_credito loop
     
		 if  a_creditos <= x_creditos  then 	 
			 p_anio_s  := (reg.p_anio)::numeric;
       RAISE NOTICE '%', p_anio_s;
			
			 exit;
		 else
		 	 x_creditos := x_creditos + (reg.p_creditos)::numeric;
			 p_anio_s  := '5';
		 end if;
		
	end loop;

  return(p_anio_s);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_anio_alumno ( v_id_persona integer, v_id_plan_programa integer) FROM PUBLIC;

