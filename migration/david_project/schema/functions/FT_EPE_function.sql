-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_epe ( p_id_persona bigint, p_id_semestre bigint, p_id_nivel_ensenanza bigint, p_id_tipo_contrato bigint, p_id_unidad_academica bigint, p_id_programa_estudio bigint, p_id_sede bigint, p_bimestre bigint ) RETURNS bigint AS $body$
DECLARE


    r_puntaje bigint := 0;


BEGIN


	SELECT avg(epe) * 0.45 / 20 * 100 AS epe INTO STRICT r_puntaje   FROM (

SELECT 
        programa_estudio,
        unidad_academica,sede,
        id_persona,bimestre, paterno,materno,nombre,
        num_documento,
        avg(epe) as epe
        
         FROM (SELECT 
        programa_estudio,
        unidad_academica,sede,
        id_persona,paterno,materno,nombre,
                bimestre, num_documento,
                coalesce(sum( 0  + promedio_des_doc  + promedio_percepcion),0) * 20 / 100 AS epe
                FROM (
                        select  
                    vape.nombre as programa_estudio,
                    vape.nombre_facultad as unidad_academica,
                    ose.nombre as sede,
                    pe.id_persona,
                    pe.PATERNO,
                    pe.MATERNO,
                    pe.NOMBRE,
                    redm.bimestre,
                     avg(Redm.promedio_desempenio_doc) /20  * 1 * 100 AS promedio_des_doc,  avg(redm.percepcion ) * 0 AS promedio_percepcion, 
                    pn.NUM_DOCUMENTO 

                    FROM reportbi.REPORTE_EVALUACION_DOC_MES redm 
                    INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE =redm.ID_CARGA_CURSO_DOCENTE 
                    INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO =accd.ID_CARGA_CURSO  AND origen='O'
                    INNER JOIN moises.persona pe ON pe.ID_PERSONA =accd.ID_PERSONA 
                    INNER JOIN MOISES.PERSONA_NATURAL pn ON pn.ID_PERSONA = pe.ID_PERSONA 
                    INNER JOIN DAVID.ACAD_PERSONA_CONTRATO PC on PC.id_semestre = 175 and pc.id_persona=pe.id_persona
                     inner join david.vw_acad_programa_estudio vape on vape.id_programa_estudio=pc.id_programa_estudio
                     inner join eliseo.org_sede_area sa on sa.id_Sedearea=vape.id_unidad_academica
                     inner join eliseo.org_Sede ose on ose.id_Sede=sa.id_sede
	               WHERE accd.ID_PERSONA = coalesce(p_id_persona,accd.id_persona)
	                and PC.id_Semestre=coalesce(p_id_semestre,PC.id_semestre)
	                AND vape.id_nivel_ensenanza =coalesce(p_id_nivel_ensenanza, vape.ID_NIVEL_ENSENANZA)
	                AND vape.ID_TIPO_CONTRATO =coalesce(p_id_tipo_contrato,vape.ID_TIPO_CONTRATO)
	                AND vape.ID_UNIDAD_ACADEMICA =coalesce(p_id_unidad_academica,vape.ID_UNIDAD_ACADEMICA)
	                AND vape.id_programa_estudio =coalesce(p_id_programa_estudio,vape.id_programa_estudio)
	                AND vape.ID_SEDE =coalesce(p_id_sede,vape.ID_SEDE)
	                AND redm.bimestre = coalesce(p_bimestre,redm.bimestre) 
                    GROUP BY 
                    vape.nombre ,
                    vape.nombre_facultad ,
                    ose.nombre ,
                    pe.id_persona, 
                    pe.PATERNO ,pe.MATERNO ,pe.NOMBRE,pn.NUM_DOCUMENTO 
                    ,redm.bimestre

               
                ) alias14 
                GROUP BY
                programa_estudio,
                unidad_academica,sede,
                id_persona, bimestre,
                paterno,
                materno,
                nombre,
                num_documento ) alias15 
               
                GROUP BY  programa_estudio,
                unidad_academica,sede,
                id_persona ,bimestre, paterno,materno,nombre,
                num_documento
               
                ) alias16;

    RETURN r_puntaje;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_epe ( p_id_persona bigint, p_id_semestre bigint, p_id_nivel_ensenanza bigint, p_id_tipo_contrato bigint, p_id_unidad_academica bigint, p_id_programa_estudio bigint, p_id_sede bigint, p_bimestre bigint ) FROM PUBLIC;

