-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_curso_docente_horario (HORARIO text,NUM_DIA text,P_ID_HORARIO integer,P_HORAS integer,P_TIPO text) RETURNS varchar AS $body$
DECLARE


NUM bigint;
INI bigint;
NVAL bigint;
VAL varchar(1000);
T_HORARIO varchar(1000);
T_TURNO varchar(1000);
T_PERIODO varchar(1000);
P_HORA_INICIO varchar(1000);
P_HORA_FIN varchar(1000);
RES varchar(1000);


BEGIN

  SELECT ''||CEIL((LENGTH(REPLACE(HORARIO,'-','')))/3) INTO STRICT NUM;
  
  INI:=1;
  NVAL:=1;

  WHILE INI <= NUM
  LOOP
  
    SELECT SUBSTR(HORARIO,NVAL,1) INTO STRICT VAL;

    IF (VAL=NUM_DIA) THEN
      T_HORARIO:=SUBSTR(HORARIO,NVAL+1,2);
      INI:=5000;
    END IF;

    INI:=INI+1;
    NVAL:=NVAL+4;

  END LOOP;

  --RES ;
  
  T_TURNO:=SUBSTR(T_HORARIO,0,1);
  T_PERIODO:=SUBSTR(T_HORARIO,2,1);

  IF (P_TIPO='I') THEN
  
    SELECT HORA_INICIO INTO STRICT RES FROM ACAD_HORARIO_DETALLE WHERE ID_HORARIO=P_ID_HORARIO AND ID_TIPO_TURNO=T_TURNO AND PERIODO=T_PERIODO;

  ELSIF (P_TIPO='F') THEN    
  
    SELECT coalesce((SELECT HORA_FIN FROM ACAD_HORARIO_DETALLE WHERE ID_HORARIO=P_ID_HORARIO AND ID_TIPO_TURNO=T_TURNO AND PERIODO=T_PERIODO+(P_HORAS-1) ),'X')INTO RES;

    IF (RES='X') THEN
    
      SELECT coalesce((SELECT (HORA_FIN) FROM ACAD_HORARIO_DETALLE WHERE ID_HORARIO=P_ID_HORARIO AND ID_TIPO_TURNO=(T_TURNO+1) AND PERIODO=P_HORAS-(FTMAX_PERIODO(P_ID_HORARIO,T_TURNO)-T_PERIODO) ),'Z')INTO RES;
      T_TURNO:=(T_TURNO+1);
   
      IF (RES='Z') THEN
      
        SELECT (HORA_FIN) INTO STRICT RES FROM ACAD_HORARIO_DETALLE WHERE ID_HORARIO=P_ID_HORARIO AND ID_TIPO_TURNO=(T_TURNO+1) AND PERIODO=P_HORAS-((FTMAX_PERIODO(P_ID_HORARIO,T_TURNO-1)+FTMAX_PERIODO(P_ID_HORARIO,T_TURNO))-T_PERIODO);
        T_TURNO:=(T_TURNO+1);
      
      END IF;

    END IF;

  END IF;

  
  IF (T_TURNO=1) THEN
    SELECT (CASE WHEN(SUBSTR(RES,0,2))=1 THEN (SUBSTR(RES,0,2))::numeric +12 ELSE (SUBSTR(RES,0,2))::numeric  END)||SUBSTR(RES,-3) INTO STRICT RES;
  ELSE
    SELECT (CASE WHEN(SUBSTR(RES,0,2))<12 THEN (SUBSTR(RES,0,2))::numeric +12 ELSE (SUBSTR(RES,0,2))::numeric  END)||SUBSTR(RES,-3) INTO STRICT RES;
  END IF;

  
  
  
  RETURN RES;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_curso_docente_horario (HORARIO text,NUM_DIA text,P_ID_HORARIO integer,P_HORAS integer,P_TIPO text) FROM PUBLIC;

