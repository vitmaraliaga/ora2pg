-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_calcular_promedio_teo (v_id_carga_curso bigint, v_id_persona bigint, v_id_programa_estudio bigint) RETURNS bigint AS $body$
DECLARE

    promedio_minimo_cat bigint;
    promedio_ponderado bigint;
    promedio_final bigint;

BEGIN

        select round((round((sum(aae.nota*ace.ponderado/100))::numeric,2))::numeric,0) into STRICT promedio_ponderado
        from acad_alumno_evaluacion aae
        inner join acad_carga_evaluacion ace on ace.id_carga_evaluacion = aae.id_carga_evaluacion
        where aae.id_carga_curso = v_id_carga_curso and aae.id_persona = v_id_persona;

        select min(round((sum(coalesce(aae.nota,0)*ace.ponderado)/CASE WHEN sum(ace.ponderado)=0 THEN 1  ELSE sum(ace.ponderado) END )::numeric,2))  into STRICT promedio_minimo_cat
        from acad_carga_evaluacion ace 
        INNER join acad_alumno_evaluacion aae on ace.id_carga_evaluacion = aae.id_carga_evaluacion and aae.id_persona = v_id_persona
        inner join acad_estrategia ae on ae.id_estrategia = ace.id_estrategia and ae.codigo like 'ASPF%'
        where ace.id_carga_curso = v_id_carga_curso
        group by ae.id_tipo_estrategia;

        if (promedio_minimo_cat < 12.5) then
            promedio_final := round((promedio_minimo_cat)::numeric,0);
        /*elsif(promedio_minimo_cat = 12.5) then
            promedio_final := 12;*/
        else
            promedio_final := promedio_ponderado;
        end if;

    return promedio_final;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_calcular_promedio_teo (v_id_carga_curso bigint, v_id_persona bigint, v_id_programa_estudio bigint) FROM PUBLIC;

