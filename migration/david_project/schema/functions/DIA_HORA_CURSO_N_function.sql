-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.dia_hora_curso_n (HORARIO text,DIA text,p_id_horario integer) RETURNS varchar AS $body$
DECLARE


dias varchar(100) := ' ';
dias2 varchar(100);
corte integer :=1;
turno2 varchar(100);
turno varchar(100);
val varchar(200);
var varchar(200);

tm integer;
tt integer;
tn integer;
BEGIN

select sum(CASE WHEN id_tipo_turno=1 THEN 1  ELSE 0 END ),
sum(CASE WHEN id_tipo_turno=1 THEN 1  ELSE 0 END )+sum(CASE WHEN id_tipo_turno=2 THEN 1  ELSE 0 END ),
sum(CASE WHEN id_tipo_turno=1 THEN 1  ELSE 0 END )+sum(CASE WHEN id_tipo_turno=2 THEN 1  ELSE 0 END )+sum(CASE WHEN id_tipo_turno=3 THEN 1  ELSE 0 END )
into STRICT tm,tt,tn
from ACAD_HORARIO_DETALLE where id_horario=p_id_horario
group by id_horario;

  FOR i IN 1..30 LOOP
      val := SUBSTR(HORARIO,corte ,corte+7);
     FOR y IN 1..7 LOOP
      var := substr(val,y,1);
      IF var ='1' THEN
        IF position(y::text in dias) =0 THEN
          dias :=CONCAT(dias, y);
          CASE
             WHEN i<=tm THEN turno :=CONCAT(turno, CONCAT('1',i));
             WHEN i>tm and i<=tt THEN turno :=CONCAT(turno,CONCAT('2',i-tm));
             ELSE
              turno :=CONCAT(turno,CONCAT('3',i-tt));
          END CASE;
          --turno :=CONCAT(turno,turno);
        END IF;
      END IF;

    END LOOP;
      corte:=corte+7;
  END LOOP;

  corte:=1;
  IF LENGTH(trim(both dias)) >0 THEN
    FOR y IN 1..length(trim(both dias)) LOOP
      var := substr(trim(both dias),y,1);
      turno2 := substr(trim(both turno),corte,2);
      corte :=corte+2;
      CASE
       WHEN var = '1' THEN IF y<length(trim(both dias)) THEN dias2 :=CONCAT(dias2, CONCAT('1', CONCAT(turno2,'-')));ELSE dias2 :=CONCAT(dias2, CONCAT('1',turno2));END IF;
       WHEN var = '2' THEN IF y<length(trim(both dias)) THEN dias2 :=CONCAT(dias2, CONCAT('2',CONCAT(turno2,'-')));ELSE dias2 :=CONCAT(dias2, CONCAT('2', turno2));END IF;
       WHEN var = '3' THEN IF y<length(trim(both dias)) THEN dias2 :=CONCAT(dias2, CONCAT('3',CONCAT(turno2,'-')));ELSE dias2 :=CONCAT(dias2, CONCAT('3',turno2));END IF;
       WHEN var = '4' THEN IF y<length(trim(both dias)) THEN dias2 :=CONCAT(dias2, CONCAT('4',CONCAT(turno2,'-')));ELSE dias2 :=CONCAT(dias2, CONCAT('4',turno2));END IF;
       WHEN var = '5' THEN IF y<length(trim(both dias)) THEN dias2 :=CONCAT(dias2, CONCAT('5',CONCAT(turno2,'-')));ELSE dias2 :=CONCAT(dias2, CONCAT('5', turno2));END IF;
       WHEN var = '6' THEN IF y<length(trim(both dias)) THEN dias2 :=CONCAT(dias2, CONCAT('6',CONCAT(turno2,'-')));ELSE dias2 :=CONCAT(dias2, CONCAT('6',turno2));END IF;
       ELSE IF y<=length(trim(both dias)) THEN dias2 :=CONCAT(dias2, CONCAT('7',CONCAT(turno2,'-')));ELSE dias2 :=CONCAT(dias2, CONCAT('7', turno2));END IF;
      END CASE;
    END LOOP;
  END IF;


RETURN(trim(both dias2));
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.dia_hora_curso_n (HORARIO text,DIA text,p_id_horario integer) FROM PUBLIC;

