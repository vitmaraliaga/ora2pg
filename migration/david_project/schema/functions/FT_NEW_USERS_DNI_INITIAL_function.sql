-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_new_users_dni_initial (v_id_persona bigint) RETURNS varchar AS $body$
DECLARE


  p_users varchar(250);


BEGIN

    select
    CONCAT(
        sintilde_con_punto(
            CASE WHEN                 sintilde_con_punto(                    replace(                        CASE WHEN                             sintilde_con_punto(                                CASE WHEN                                     sintilde_con_punto(                                        lower(                                            substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                            ||p.paterno                                        )                                    )=u.email THEN                                     lower(                                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                                        ||p.paterno                                    )  ELSE sintilde_con_punto(                                        lower(                                            substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                            ||p.paterno                                        )                                    ) END                             )=u2.email THEN                             sintilde_con_punto(                                lower(                                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                                    ||p.paterno||substr(p.materno,0,1)                                )                            )  ELSE sintilde_con_punto(                                CASE WHEN                                     lower(                                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                        ||p.paterno                                    )=u.email THEN                                     lower(                                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                                        ||p.paterno                                    )  ELSE lower(                                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                        ||p.paterno                                    ) END                             ) END ,                        ' ',                        ''                    )                )=u3.email THEN                 lower(replace(substr(p.nombres,1,1)||p.paterno||substr(p.materno,0,1),' ',''))  ELSE sintilde_con_punto(                    replace(                        CASE WHEN                             CASE WHEN                                 lower(                                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                    ||p.paterno                                )=u.email THEN                                 lower(                                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                                    ||p.paterno                                )  ELSE lower(                                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                    ||p.paterno                                ) END =u2.email THEN                             lower(                                substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                                ||p.paterno||substr(p.materno,0,1)                            )  ELSE CASE WHEN                                 lower(                                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                    ||p.paterno                                )=u.email THEN                                 lower(                                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                                    ||p.paterno                                )  ELSE lower(                                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                                    ||substr(p.paterno,0,1)||p.materno                                ) END  END ,                        ' ',                        ''                    )                ) END 
        ),
        substr(p.documentos,-4)
    ) into STRICT p_users
    from (
        SELECT Distinct 
            p.id_persona,
            trim(both paterno) paterno,
            trim(both materno) materno,
            trim(both nombre) nombres, 
            p.codigo codigo_personal,
            pn.num_documento documentos,
            id_tipodocumento tipo_documento 
        from moises.persona p 
        inner join moises.persona_natural pn on pn.id_persona=p.id_persona 
        where p.id_persona=v_id_persona
    ) p
    left join datos_personales@dbl_noe dp on dp.codigo_personal=p.Codigo_Personal
    left join eliseo.users u on u.email=sintilde_con_punto(
        lower(
            substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)
            ||p.paterno
        )
    )
    left join eliseo.users u2 on u2.email=sintilde_con_punto(
        CASE WHEN             lower(                substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                ||p.paterno            )=u.email THEN             lower(                substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                ||p.paterno            ) WHEN             lower(                substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                ||p.paterno            )=lower(                substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                ||p.paterno            ) THEN             lower(                substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                ||p.paterno            )         END 
    )
    left join eliseo.users u3 on u3.email=sintilde_con_punto(
        replace(
            CASE WHEN                 CASE WHEN                     lower(                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                        ||p.paterno                    )=u.email THEN                     lower(                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                        ||p.paterno                    )                 END =u2.email THEN                 lower(                    substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                    ||p.paterno||substr(p.materno,0,1)                )  ELSE CASE WHEN                     lower(                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                        ||p.paterno                    )=u.email THEN                     lower(                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,position(' ' in p.nombres)+1) END ,1,1)                        ||p.paterno                    )  ELSE lower(                        substr(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ,1,1)                        ||p.paterno                    ) END  END ,
            ' ',
            ''
        )
    )
    where p.id_persona not in (SELECT id from eliseo.users);

    return replace(p_users,' ','');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_new_users_dni_initial (v_id_persona bigint) FROM PUBLIC;

