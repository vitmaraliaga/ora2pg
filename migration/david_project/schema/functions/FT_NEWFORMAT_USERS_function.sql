-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_newformat_users (v_id_persona bigint) RETURNS varchar AS $body$
DECLARE

  p_users varchar(200);


BEGIN

select coalesce(
    (select CASE WHEN CASE WHEN sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))=u.email THEN                             sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||substr(p.codigo,-2)))  ELSE --2
                            sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))--1
 END =u2.email THEN                   sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||substr(p.codigo,-3)))  ELSE --3
                  CASE WHEN sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))=u.email THEN                             sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||substr(p.codigo,-2)))  ELSE sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno)) END  END
          
-- -- -- --     from (select Distinct p.id_persona,trim(both paterno) paterno,trim(both materno) materno,trim(both nombre) nombres, coalesce(coalesce(pne.codigo,pn.num_documento),date_trunc('day', DBMS_RANDOM.VALUE(10000000, 99999999))) codigo
          from moises.persona p inner join moises.persona_natural pn on pn.id_persona=p.id_persona 
          left join moises.persona_natural_alumno pne on pne.id_persona=pn.id_persona where p.id_persona=v_id_persona) p

    left join eliseo.users u on u.email=sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))

    left join eliseo.users u2 on u2.email=CASE WHEN sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno))=u.email THEN                                                   sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno||substr(p.codigo,-2)))  ELSE sintilde_con_punto(lower(CASE WHEN position(' ' in p.nombres)='0' THEN p.nombres  ELSE substr(p.nombres,0,position(' ' in p.nombres)-1) END ||'.'||p.paterno)) END 

    where p.id_persona not in (select id from eliseo.users) ),'-1') into STRICT p_users
;

    return replace(p_users,' ','');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_newformat_users (v_id_persona bigint) FROM PUBLIC;

