-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION david.ft_validacion_becas_cc (p_id_persona integer,p_id_plan_programa integer,p_id_semestre integer) RETURNS varchar AS $body$
DECLARE

  p_res varchar(500);


BEGIN

  Select (case when max(promedio)='A' and max(deuda)='A' and max(regular)='A' and max(ciclo)='A' then 'NO' else 'SI' end ) ||
        (case when max(promedio)='A' and max(deuda)='A' and max(regular)='A' and max(ciclo)='A' then 'OK' else 
        CASE WHEN max(promedio)='A' THEN ''  ELSE max(promedio)||',' END ||CASE WHEN max(deuda)='A' THEN ''  ELSE max(deuda)||',' END ||
        CASE WHEN max(regular)='A' THEN ''  ELSE max(regular)||',' END ||CASE WHEN max(ciclo)='A' THEN ''  ELSE max(ciclo)||',' END  end ) into STRICT p_res
  
  from (SELECT 'A' promedio, CASE WHEN ft_tiene_deuda(p_id_persona,p_id_semestre)=1 THEN 'El saldo no esta en tu estado de cuenta , no cumple con lo requerido para  avanzar en tu solicitud'  ELSE 'A' END  deuda, 
        'A' regular, 'A' ciclo
        
        
union

        SELECT max(promedio) promedio,'A' deuda, max(regular) regular, max(ciclo) ciclo
        from (select CASE WHEN automatico='A2' THEN ''||CASE WHEN ft_tiene_aprobado(p_id_persona,p_id_plan_programa)=1 THEN 'El Promedio Ponderado minimo requerido no ha sido alcanzado'  ELSE 'A' END   ELSE 'A' END  promedio,
              CASE WHEN automatico='A4' THEN ''||CASE WHEN ft_tiene_regular(p_id_persona,p_id_plan_programa)=1 THEN 'La cantidad de creditos minimos requeridos, no ha sido confirmado'  ELSE 'A' END   ELSE 'A' END  regular,
              (case when Id_Tipo_Requisito_Beca in (4,11,17,45,48,57,67) then (case when ft_tiene_max_ciclo(p_id_persona,p_id_plan_programa)<2 then 'Aun no puedes solicitar , pues no estas en el ciclo minimo requerido'
                                                                                    else 'A' end ) else
                    CASE WHEN automatico='A7' THEN ''||CASE WHEN ft_tiene_tercerciclo(p_id_persona,p_id_plan_programa)=1 THEN 'Aun no puedes solicitar , pues no estas en el ciclo minimo requerido'  ELSE 'A' END   ELSE 'A' END  
                    end)ciclo
              from acad_requisitos_beca where Id_Tipo_Requisito_Beca=4 and estado='1' and Automatico in ('A2','A4','A1','A7') ) alias30 ) alias31;

  return p_res;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION david.ft_validacion_becas_cc (p_id_persona integer,p_id_plan_programa integer,p_id_semestre integer) FROM PUBLIC;

