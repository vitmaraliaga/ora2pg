-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_tr_validation,public;




CREATE OR REPLACE PROCEDURE david.pk_tr_validation_sp_complete_english ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) AS $body$
DECLARE


        P_STATUS    smallint;
        P_MESSAGE   text;
        P_RET       text;
        P_PERSON_ID numeric(30);
        P_PLAN_ID   numeric(30);


BEGIN

        IF (P_STUDENT_PLAN_ID IS NOT NULL AND P_STUDENT_PLAN_ID::text <> '') THEN

            SELECT AAP.ID_PERSONA,
                   APP.ID_PLAN
            INTO STRICT P_PERSON_ID, P_PLAN_ID
            FROM DAVID.ACAD_ALUMNO_PLAN AAP
                     INNER JOIN DAVID.ACAD_PLAN_PROGRAMA APP ON AAP.ID_PLAN_PROGRAMA = APP.ID_PLAN_PROGRAMA
            WHERE AAP.ID_ALUMNO_PLAN = P_STUDENT_PLAN_ID;

            SELECT string_agg(RET.NOMBRE, ', ' ORDER BY RET.ORDEN)
            INTO STRICT P_RET
            FROM (SELECT distinct tc.nombre, tc.ORDEN
                  from Vw_Alumno_Plan_Programa vpp
                           inner join Acad_Candado_Programa cp on Cp.Id_Programa_Estudio = Vpp.Id_Programa_Estudio
                           inner join Tipo_Candado tc on Tc.Id_Tipo_Candado = Cp.Id_Tipo_Candado
                           left join acad_candado ac on ac.id_persona = vpp.id_persona and ac.estado = 1 and
                                                        Ac.Id_Tipo_Candado = Cp.Id_Tipo_Candado
                      and(ac.ID_SEMESTRE IS NOT NULL AND ac.ID_SEMESTRE::text <> '')
                  where vpp.id_persona = P_PERSON_ID
                    and vpp.id_plan = P_PLAN_ID
                    and coalesce(id_candado::text, '') = '' ) RET;


            IF (P_RET IS NOT NULL AND P_RET::text <> '') THEN
                P_STATUS := 0;
                P_MESSAGE
                    := 'Se requiere inglés, ' || P_RET || '.';
            ELSE
                P_STATUS := 1;
                P_MESSAGE
                    := 'Has completado satisfactoriamente los cursos de inglés requeridos';
            END IF;

            OPEN P_CURSOR FOR
                SELECT P_STATUS as STATUS, P_MESSAGE as MESSAGE
;

        ELSE
            OPEN P_CURSOR FOR
                SELECT 0 as STATUS, 'Plan de estudios requerido para validar.' as MESSAGE
;
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            OPEN P_CURSOR FOR
                SELECT 0 as STATUS, 'Se ha producido un error en la base de datos.' as MESSAGE
;


    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_tr_validation_sp_complete_english ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) FROM PUBLIC;
