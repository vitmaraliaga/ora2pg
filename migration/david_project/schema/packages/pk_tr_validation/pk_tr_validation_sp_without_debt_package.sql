-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_tr_validation,public;




CREATE OR REPLACE PROCEDURE david.pk_tr_validation_sp_without_debt ( P_PERSON_ID bigint, P_CURSOR OUT REFCURSOR) AS $body$
DECLARE


        P_TOTAL   numeric(30);
        P_STATUS  smallint;
        P_MESSAGE text;


BEGIN

        IF (P_PERSON_ID IS NOT NULL AND P_PERSON_ID::text <> '') THEN

            SELECT coalesce((SELECT SUBSTR(DE, 4) monto
                        FROM (SELECT DAVID.FT_DEUDA_ALUMNO(P_PERSON_ID, (TO_CHAR(clock_timestamp(), 'YYYY'))::numeric ) DE
                              ) alias6
                        WHERE SUBSTR(DE, 0, 2) = '01' ), 0)
            INTO STRICT P_TOTAL
;

            IF (P_TOTAL > 0) THEN
                P_STATUS := 0;
                P_MESSAGE
                    := 'Tienes una deuda académica pendiente de s/.' || P_TOTAL ||
                       '. Por favor, ponte en contacto con el area financiero para resolverlo.';
            ELSE
                P_STATUS := 1;
                P_MESSAGE
                    := 'No tienes deuda académica. ¡Felicidades!';
            END IF;

            OPEN P_CURSOR FOR
                SELECT P_STATUS as STATUS, P_MESSAGE as MESSAGE
;

        ELSE
            OPEN P_CURSOR FOR
                SELECT 0 as STATUS, 'Identificador de persona requerido para validar.' as MESSAGE
;
        END IF;

    EXCEPTION
        WHEN OTHERS THEN
            OPEN P_CURSOR FOR
                SELECT 0 as STATUS, 'Se ha producido un error en la base de datos.' as MESSAGE
;


    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_tr_validation_sp_without_debt ( P_PERSON_ID bigint, P_CURSOR OUT REFCURSOR) FROM PUBLIC;
