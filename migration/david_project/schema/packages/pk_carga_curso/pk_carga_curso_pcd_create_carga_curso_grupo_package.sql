-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_carga_curso,public;




CREATE OR REPLACE PROCEDURE david.pk_carga_curso_pcd_create_carga_curso_grupo (p_id_carga_curso integer, p_id_usuario_reg integer, out CURSOR REFCURSOR) AS $body$
DECLARE

    
      v_id_carga_curso integer:=0;
      z_id_carga_curso integer:=0;
      v_id_semestre_programa acad_carga_curso.id_semestre_programa%type;
      v_id_curso_modo acad_carga_curso.id_curso_modo%type;
      v_grupo acad_carga_curso.grupo%type;
      v_estado_curso acad_carga_curso.estado_curso%type;
      v_horas_lectivas acad_carga_curso.horas_lectivas%type;
      v_id_tipo_ev acad_carga_curso.id_tipo_ev%type;
      v_cupo acad_carga_curso.cupo%type;
      v_factor acad_carga_curso.factor%type;
      v_firmo_acta acad_carga_curso.firmo_acta%type;
      v_id_plan_curso Acad_Carga_Curso_Det.id_plan_curso%type;
      v_origen Acad_Carga_Curso_Det.origen%type;
      v_id_programa_estudio Acad_Carga_Curso_Det.id_programa_estudio%type;
      l_contar bigint:=0;
      l_error varchar(200);

      
BEGIN
        l_error:= 'No se puede ingresar debido que este programa no cuenta con cursos de planes activos';
        l_error:= '';
        update acad_carga_curso set grupo=coalesce(grupo,1), id_usuario_act=p_id_usuario_reg, fecha_actualizacion=clock_timestamp()
        where Id_Carga_Curso=p_id_carga_curso returning id_carga_curso into z_id_carga_curso;

        
        select acc.id_semestre_programa,acc.id_curso_modo,coalesce(acc.grupo,0)+1 grupo,acc.estado_curso,
                acc.horas_lectivas,acc.id_tipo_ev,acc.cupo,acc.factor,acc.firmo_acta,
                accd.id_plan_curso,accd.origen, Accd.Id_Programa_Estudio 
                into STRICT v_id_semestre_programa,v_id_curso_modo,v_grupo,v_estado_curso,
                      v_horas_lectivas,v_id_tipo_ev,v_cupo,v_factor,v_firmo_acta,
                      v_id_plan_curso,v_origen, v_id_programa_estudio 
        from acad_carga_curso acc inner join Acad_Carga_Curso_Det accd on Accd.Id_Carga_Curso=Acc.Id_Carga_Curso
              and accd.origen='O' and acc.Id_Carga_Curso=z_id_carga_curso;

          
      insert into acad_carga_curso(id_semestre_programa,id_curso_modo,grupo,estado_curso,horas_lectivas,id_tipo_ev,cupo,factor,firmo_acta,id_usuario_reg,fecha_registro)
      VALUES (v_id_semestre_programa,v_id_curso_modo,v_grupo,
            v_estado_curso,v_horas_lectivas,v_id_tipo_ev,v_cupo,v_factor,v_firmo_acta,p_id_usuario_reg,clock_timestamp())
      returning id_carga_curso into v_id_carga_curso;

      insert into acad_carga_curso_det(id_plan_curso,id_carga_curso,origen,id_programa_estudio,id_usuario_reg,fecha_registro)
          values (v_id_plan_curso,v_id_carga_curso,v_origen,v_id_programa_estudio,p_id_usuario_reg,clock_timestamp());

      if (v_id_carga_curso=0) then
        l_error:= 'No se puede ingresar debido que este programa no cuenta con cursos de planes activos';
      end if;

      l_contar :=1;

          
      open CURSOR FOR 
            SELECT l_contar as resultado, l_error as msg_error, v_id_carga_curso id_carga_curso;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_carga_curso_pcd_create_carga_curso_grupo (p_id_carga_curso integer, p_id_usuario_reg integer, out CURSOR REFCURSOR) FROM PUBLIC;
