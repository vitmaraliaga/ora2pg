-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_tr_document,public;




CREATE OR REPLACE PROCEDURE david.pk_tr_document_sp_const_student ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) AS $body$
DECLARE


        P_COLLEGE  varchar(500);
        P_SCHOOL   varchar(500);
        P_CAMPUS   varchar(500);
        P_PROGRAM  varchar(500);
        P_SEMESTER varchar(50);
        P_CYCLE    varchar(3);

BEGIN

        IF (P_STUDENT_PLAN_ID IS NOT NULL AND P_STUDENT_PLAN_ID::text <> '') THEN

            SELECT VAPP.NOM_FACULTAD,
                   VAPP.NOM_ESCUELA,
                   VAPP.SEDE,
                   APE.NOMBRE
            INTO STRICT P_COLLEGE, P_SCHOOL, P_CAMPUS, P_PROGRAM
            FROM DAVID.VW_ALUMNO_PLAN_PROGRAMA VAPP
                     INNER JOIN DAVID.ACAD_PROGRAMA_ESTUDIO APE
                                ON VAPP.ID_PROGRAMA_ESTUDIO = APE.ID_PROGRAMA_ESTUDIO
            WHERE VAPP.ID_ALUMNO_PLAN = P_STUDENT_PLAN_ID;


            BEGIN
                SELECT RET.SEMESTRE, coalesce(RET.CICLO::text, '-')
                INTO STRICT P_SEMESTER, P_CYCLE
                FROM (SELECT A2.SEMESTRE, AAC.CICLO
                      FROM DAVID.ACAD_ALUMNO_PLAN AAP
                               INNER JOIN DAVID.ACAD_ALUMNO_CONTRATO AAC
                                          ON AAP.ID_PERSONA = AAC.ID_PERSONA AND
                                             AAP.ID_PLAN_PROGRAMA = AAC.ID_PLAN_PROGRAMA
                               INNER JOIN DAVID.ACAD_SEMESTRE_PROGRAMA ASP
                                          ON AAC.ID_SEMESTRE_PROGRAMA = ASP.ID_SEMESTRE_PROGRAMA
                               INNER JOIN DAVID.ACAD_SEMESTRE A2 ON ASP.ID_SEMESTRE = A2.ID_SEMESTRE
                      WHERE AAP.ID_ALUMNO_PLAN = P_STUDENT_PLAN_ID
                        AND AAC.ESTADO = '1'
                      ORDER BY AAC.FECHA_REGISTRO DESC) RET LIMIT 1;

            EXCEPTION
                WHEN no_data_found THEN
                    P_SEMESTER := '-';
                    P_CYCLE := '-';
            END;


            OPEN P_CURSOR FOR
                SELECT P_COLLEGE  AS COLLEGE,
                       P_SCHOOL   AS SCHOOL,
                       P_CAMPUS   AS CAMPUS,
                       P_PROGRAM  AS PROGRAM,
                       P_SEMESTER AS SEMESTER,
                       P_CYCLE    AS CYCLE
;

        ELSE

            OPEN P_CURSOR FOR
                SELECT '-' AS COLLEGE,
                       '-' AS SCHOOL,
                       '-' AS CAMPUS,
                       '-' AS PROGRAM,
                       '-' AS SEMESTER,
                       '-' AS CYCLE
;

        END IF;

    EXCEPTION
        WHEN no_data_found THEN
            OPEN P_CURSOR FOR
                SELECT '-' AS COLLEGE,
                       '-' AS SCHOOL,
                       '-' AS CAMPUS,
                       '-' AS PROGRAM,
                       '-' AS SEMESTER,
                       '-' AS CYCLE
;
        WHEN OTHERS THEN
            OPEN P_CURSOR FOR
                SELECT '-' AS COLLEGE,
                       '-' AS SCHOOL,
                       '-' AS CAMPUS,
                       '-' AS PROGRAM,
                       '-' AS SEMESTER,
                       '-' AS CYCLE
;


    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_tr_document_sp_const_student ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) FROM PUBLIC;
