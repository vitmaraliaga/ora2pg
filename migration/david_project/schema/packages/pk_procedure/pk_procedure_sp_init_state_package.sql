-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_procedure,public;




CREATE OR REPLACE PROCEDURE david.pk_procedure_sp_init_state ( P_PERSONAL_PROCEDURE_ID bigint) AS $body$
DECLARE

        P_HAS_PROCEDURE smallint;
        P_HAS_PROCESS   smallint;
        P_STATE_ID      smallint;

BEGIN
        IF (P_PERSONAL_PROCEDURE_ID IS NOT NULL AND P_PERSONAL_PROCEDURE_ID::text <> '') THEN

            SELECT (CASE
                        WHEN EXISTS (SELECT TTT.ID_PROCEDIMIENTO
                                    FROM DAVID.TR_TRAMITE_PERSONA TTP
                                             INNER JOIN DAVID.TR_TIPO_TRAMITE TTT ON TTP.ID_TIPO_TRAMITE = TTT.ID_TIPO_TRAMITE
                                    WHERE TTP.ID_TRAMITE_PERSONA = P_PERSONAL_PROCEDURE_ID
                                      AND (TTT.ID_PROCEDIMIENTO IS NOT NULL AND TTT.ID_PROCEDIMIENTO::text <> '') ) THEN 1
                        ELSE 0 END) AS P1,
                   (CASE
                        WHEN EXISTS (SELECT TTTP.ID_TIPO_TRAMITE_PROCESO
                                    FROM DAVID.TR_TRAMITE_PERSONA TTP
                                             INNER JOIN DAVID.TR_TIPO_TRAMITE TTT ON TTP.ID_TIPO_TRAMITE = TTT.ID_TIPO_TRAMITE
                                             INNER JOIN DAVID.TR_TIPO_TRAMITE_PROCESO TTTP
                                                        ON TTT.ID_TIPO_TRAMITE = TTTP.ID_TIPO_TRAMITE
                                    WHERE TTP.ID_TRAMITE_PERSONA = P_PERSONAL_PROCEDURE_ID) THEN 1
                        ELSE 0 END) AS P2
            INTO STRICT P_HAS_PROCEDURE,P_HAS_PROCESS
;

            IF P_HAS_PROCESS = 0 AND P_HAS_PROCEDURE = 1 THEN
                SELECT TE.ID_ESTADO INTO STRICT P_STATE_ID FROM DAVID.TR_ESTADO TE WHERE TE.CODIGO = 'TR_AUTO';
            ELSE
                SELECT TE.ID_ESTADO INTO STRICT P_STATE_ID FROM DAVID.TR_ESTADO TE WHERE TE.CODIGO = 'TR_APER';
            END IF;

            IF (P_STATE_ID IS NOT NULL AND P_STATE_ID::text <> '') THEN
                UPDATE DAVID.TR_TRAMITE_PERSONA TTP3
                SET TTP3.ID_ESTADO = P_STATE_ID
                WHERE TTP3.ID_TRAMITE_PERSONA = P_PERSONAL_PROCEDURE_ID;
            END IF;

        END IF;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE NOTICE 'ERROR: %', SQLERRM;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_procedure_sp_init_state ( P_PERSONAL_PROCEDURE_ID bigint) FROM PUBLIC;
