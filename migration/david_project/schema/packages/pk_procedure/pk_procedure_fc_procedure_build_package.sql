-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_procedure,public;




CREATE OR REPLACE FUNCTION david.pk_procedure_fc_procedure_build (P_PROCEDURE_ID bigint, P_PARAMS text) RETURNS varchar AS $body$
DECLARE

        P_RET varchar(1000);

BEGIN

        IF
            (P_PROCEDURE_ID IS NOT NULL AND P_PROCEDURE_ID::text <> '')
        THEN
            SELECT TP.CODIGO || '(' ||
                   string_agg(DAVID.PK_PROCEDURE.FC_EXTRACT_VALUE_JSON(P_PARAMS, P.ID_PARAMETRO), ',' ORDER BY TPP.ORDEN) || ',:1)'
            INTO STRICT P_RET
            FROM DAVID.TR_PROCEDIMIENTO TP
                     LEFT JOIN DAVID.TR_PROCEDIMIENTO_PARAMETRO TPP
                               ON TP.ID_PROCEDIMIENTO = TPP.ID_PROCEDIMIENTO
                     LEFT JOIN DAVID.TR_PARAMETRO P ON TPP.ID_PARAMETRO = P.ID_PARAMETRO
            WHERE TP.ID_PROCEDIMIENTO = P_PROCEDURE_ID
              AND TP.ESTADO = 1
            GROUP BY TP.CODIGO;

        END IF;

        RETURN P_RET;


    EXCEPTION
        WHEN no_data_found THEN
            RAISE NOTICE 'ERROR no_data_found';
        WHEN OTHERS THEN
            RAISE NOTICE 'ERROR: %', SQLERRM;

    END;


FUNCTION FC_PROCEDURE_PERCENTAGE(
        P_PERSONAL_PROCEDURE_ID IN bigint)
        RETURN bigint IS
        P_RESULT        bigint;
        P_HAS_PROCEDURE smallint;
        P_HAS_PROCESS   smallint;
    BEGIN

        IF (P_PERSONAL_PROCEDURE_ID IS NOT NULL AND P_PERSONAL_PROCEDURE_ID::text <> '')
        THEN

            SELECT (CASE
                        WHEN EXISTS (SELECT TTT.ID_PROCEDIMIENTO
                                    FROM DAVID.TR_TRAMITE_PERSONA TTP
                                             INNER JOIN DAVID.TR_TIPO_TRAMITE TTT ON TTP.ID_TIPO_TRAMITE = TTT.ID_TIPO_TRAMITE
                                    WHERE TTP.ID_TRAMITE_PERSONA = P_PERSONAL_PROCEDURE_ID
                                      AND (TTT.ID_PROCEDIMIENTO IS NOT NULL AND TTT.ID_PROCEDIMIENTO::text <> '') ) THEN 1
                        ELSE 0 END) AS P1,
                   (CASE
                        WHEN EXISTS (SELECT TTTP.ID_TIPO_TRAMITE_PROCESO
                                    FROM DAVID.TR_TRAMITE_PERSONA TTP
                                             INNER JOIN DAVID.TR_TIPO_TRAMITE TTT ON TTP.ID_TIPO_TRAMITE = TTT.ID_TIPO_TRAMITE
                                             INNER JOIN DAVID.TR_TIPO_TRAMITE_PROCESO TTTP
                                                        ON TTT.ID_TIPO_TRAMITE = TTTP.ID_TIPO_TRAMITE
                                    WHERE TTP.ID_TRAMITE_PERSONA = P_PERSONAL_PROCEDURE_ID) THEN 1
                        ELSE 0 END) AS P2
            INTO STRICT P_HAS_PROCEDURE,P_HAS_PROCESS
;


            IF P_HAS_PROCESS = 0 AND P_HAS_PROCEDURE = 1 THEN
                P_RESULT := 100;

            ELSIF P_HAS_PROCESS = 0 AND P_HAS_PROCEDURE = 0 THEN
                P_RESULT := 0;

            ELSIF P_HAS_PROCESS = 1 AND (P_HAS_PROCEDURE = 0 OR P_HAS_PROCEDURE = 1) THEN

                SELECT ((COUNT(CASE WHEN TTP2.ESTADO = 1 THEN 1 END) / COUNT(TTTP.ID_TIPO_TRAMITE_PROCESO)) * 100)
                INTO STRICT P_RESULT
                FROM DAVID.TR_TRAMITE_PERSONA TTP
                         INNER JOIN DAVID.TR_TIPO_TRAMITE TTT ON TTP.ID_TIPO_TRAMITE = TTT.ID_TIPO_TRAMITE
                         INNER JOIN DAVID.TR_TIPO_TRAMITE_PROCESO TTTP ON TTT.ID_TIPO_TRAMITE = TTTP.ID_TIPO_TRAMITE
                         LEFT JOIN DAVID.TR_TRAMITE_PROCESO TTP2
                                   ON TTP.ID_TRAMITE_PERSONA = TTP2.ID_TRAMITE_PERSONA and
                                      TTTP.ID_ACTIVIDAD = TTP2.ID_ACTIVIDAD
                WHERE TTP.ID_TRAMITE_PERSONA = P_PERSONAL_PROCEDURE_ID;

            ELSE
                P_RESULT := 0;
            END IF;


        END IF;

        RETURN P_RESULT;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE NOTICE 'ERROR: %', SQLERRM;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION david.pk_procedure_fc_procedure_build (P_PROCEDURE_ID bigint, P_PARAMS text) FROM PUBLIC;
