-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_procedure,public;




CREATE OR REPLACE PROCEDURE david.pk_procedure_sp_evaluation_requirement ( P_PERSONAL_PROCEDURE_ID bigint, P_PROCEDURE_TYPE_ID bigint) AS $body$
DECLARE


  P_RET RECORD;

BEGIN

        FOR P_RET IN (SELECT row_number() OVER () AS ORDEN, RET.*
                      FROM (SELECT TR.ID_REQUISITO, TR.NOMBRE
                            FROM DAVID.TR_TIPO_TRAMITE_REQUISITO TTTR
                                     INNER JOIN DAVID.TR_REQUISITO TR ON TTTR.ID_REQUISITO = TR.ID_REQUISITO
                            WHERE TTTR.ID_TIPO_TRAMITE = P_PROCEDURE_TYPE_ID
                              AND TTTR.ESTADO = 1
                              AND TR.ESTADO = 1
                            ORDER BY TTTR.ORDEN) RET )
            LOOP

                MERGE INTO STRICT DAVID.TR_TRAMITE_EVALUACION t
                USING(SELECT P_PERSONAL_PROCEDURE_ID AS ID_TRAMITE_PERSONA,
                              P_RET.ID_REQUISITO      AS ID_REQUISITO,
                              P_RET.NOMBRE            AS REQUISITO,
                              P_RET.ORDEN             AS ORDEN
                       ) s
                ON (t.ID_TRAMITE_PERSONA = s.ID_TRAMITE_PERSONA AND T.ID_REQUISITO = S.ID_REQUISITO)
                WHEN NOT MATCHED THEN
                    INSERT(t.ID_TRAMITE_PERSONA, t.ID_REQUISITO, T.REQUISITO, T.ORDEN)
                    VALUES (s.ID_TRAMITE_PERSONA, s.ID_REQUISITO, S.REQUISITO, S.ORDEN);

            END LOOP;


    EXCEPTION
        WHEN no_data_found THEN
            RAISE NOTICE 'ERROR no_data_found';
        WHEN OTHERS THEN
            RAISE NOTICE 'ERROR: %', SQLERRM;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_procedure_sp_evaluation_requirement ( P_PERSONAL_PROCEDURE_ID bigint, P_PROCEDURE_TYPE_ID bigint) FROM PUBLIC;
