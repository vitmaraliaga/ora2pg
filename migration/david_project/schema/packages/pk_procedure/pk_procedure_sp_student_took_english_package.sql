-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_procedure,public;




CREATE OR REPLACE PROCEDURE david.pk_procedure_sp_student_took_english ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) AS $body$
DECLARE

        P_RET varchar(200) := '';
        P_STATUS
              smallint;
        P_MESSAGE
              text;

BEGIN


        SELECT string_agg(TC.NOMBRE, ', ' ORDER BY TC.ORDEN)
        INTO STRICT P_RET
        FROM DAVID.ACAD_ALUMNO_PLAN AAP
                 INNER JOIN DAVID.ACAD_PLAN_PROGRAMA APP
                            ON AAP.ID_PLAN_PROGRAMA = APP.ID_PLAN_PROGRAMA
                 INNER JOIN DAVID.ACAD_CANDADO_PROGRAMA ACP ON APP.ID_PROGRAMA_ESTUDIO = ACP.ID_PROGRAMA_ESTUDIO
                 INNER JOIN DAVID.TIPO_CANDADO TC ON ACP.ID_TIPO_CANDADO = TC.ID_TIPO_CANDADO
        WHERE AAP.ID_ALUMNO_PLAN = P_STUDENT_PLAN_ID
          AND AAP.ESTADO = 1
          AND NOT EXISTS (SELECT *
                          FROM DAVID.ACAD_CANDADO AC
                          WHERE AAP.ID_PERSONA = AC.ID_PERSONA
                            AND TC.ID_TIPO_CANDADO = AC.ID_TIPO_CANDADO
                            AND AC.ESTADO = 1);

        IF
            (P_RET IS NOT NULL AND P_RET::text <> '') THEN
            P_STATUS := 0;
            P_MESSAGE
                := 'Requisito no aprobado, requiere ' || P_RET || '.';
        ELSE
            P_STATUS := 1;
            P_MESSAGE
                := 'Requisito aprobado.';
        END IF;

        OPEN P_CURSOR FOR
            SELECT P_STATUS as status, P_MESSAGE as message
;

    EXCEPTION
        WHEN no_data_found THEN
            RAISE NOTICE 'ERROR no_data_found';
        WHEN OTHERS THEN
            RAISE NOTICE 'ERROR: %', SQLERRM;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_procedure_sp_student_took_english ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) FROM PUBLIC;
