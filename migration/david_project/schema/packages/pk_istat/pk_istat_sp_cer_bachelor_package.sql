-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = david,pk_istat,public;




CREATE OR REPLACE PROCEDURE david.pk_istat_sp_cer_bachelor ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) AS $body$
DECLARE


        P_CERTIFICATE varchar(400);
        P_CODE_MINEDU varchar(400);

BEGIN


        IF (P_STUDENT_PLAN_ID IS NOT NULL AND P_STUDENT_PLAN_ID::text <> '') THEN

            SELECT APE.NOMBRE_CERTIFICADO
            INTO STRICT P_CERTIFICATE
            FROM DAVID.VW_ALUMNO_PLAN_PROGRAMA VAPP
                     INNER JOIN DAVID.ACAD_PROGRAMA_ESTUDIO APE
                                ON VAPP.ID_PROGRAMA_ESTUDIO = APE.ID_PROGRAMA_ESTUDIO
            WHERE VAPP.ID_ALUMNO_PLAN = P_STUDENT_PLAN_ID;


            SELECT TM.CODIGO
            INTO STRICT P_CODE_MINEDU
            FROM DAVID.TR_MINEDU TM
                     INNER JOIN DAVID.TR_TIPO_TRAMITE TTT ON TM.ID_TIPO_TRAMITE = TTT.ID_TIPO_TRAMITE
            WHERE TM.ID_ALUMNO_PLAN = P_STUDENT_PLAN_ID
              AND TTT.CODIGO = 'CER-BACH'
              AND TM.ESTADO = 1;

            OPEN P_CURSOR FOR SELECT P_CERTIFICATE AS CERTIFICATE, P_CODE_MINEDU AS CODE_MINEDU;

        ELSE
            OPEN P_CURSOR FOR SELECT * LIMIT 1 OFFSET -1;

        END IF;

    EXCEPTION
        WHEN no_data_found THEN
            OPEN P_CURSOR FOR SELECT * LIMIT 1 OFFSET -1;
        WHEN OTHERS THEN
            OPEN P_CURSOR FOR SELECT * LIMIT 1 OFFSET -1;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pk_istat_sp_cer_bachelor ( P_STUDENT_PLAN_ID bigint, P_CURSOR OUT REFCURSOR) FROM PUBLIC;
