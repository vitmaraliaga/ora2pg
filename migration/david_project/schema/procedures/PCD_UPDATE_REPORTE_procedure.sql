-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_update_reporte () AS $body$
DECLARE


sem CURSOR FOR
SELECT id_semestre from acad_semestre where substr(semestre,0,4)>=2021 and substr(semestre,-2) in ('-1','-2','-0','-3');

BEGIN

  /*insert into acad_semana_programa
  select rownum,a.*,
  'S'||row_number() OVER( PARTITION BY Id_Semestre,Id_Programa_Estudio
                          ORDER BY Id_Semestre,Id_Programa_Estudio,Fecha_Inicio) semana
  from (select distinct Id_Semestre,Id_Programa_Estudio,Fecha_Inicio + (level - 1) * 7 AS Fecha_Inicio,(Fecha_Inicio + (level - 1) * 7)+6 AS Fecha_Fin
        from (select Asp.Id_Semestre,Asp.Id_Programa_Estudio,min(Amd.Fecha_Inicio) Fecha_Inicio,max(Amd.Fecha_Fin) Fecha_Fin
              from Acad_Semestre_Programa asp inner join Acad_Modulo_Detalle amd on Amd.Id_Semestre_Programa=Asp.Id_Semestre_Programa
              where asp.id_semestre in (221,199)
              group by Asp.Id_Semestre,Asp.Id_Programa_Estudio)
        CONNECT BY Fecha_Inicio + (level - 1) * 7 <= Fecha_Fin 
        order by Id_Semestre,Id_Programa_Estudio,Fecha_Inicio) a
  order by Id_Semestre,Id_Programa_Estudio,Fecha_Inicio;
  commit;*/
    
    /*insert into aatemp_alumno_ciclo
    select Aac.Id_Persona,Asm.Semestre,Ape.Id_Programa_Estudio,Ape.Nombre_Corto,Pna.Codigo,
    P.Nombre||' '||P.Paterno||' '||P.Materno estudiante,
    nvl(Ft_Calcular_Ciclo(asm.semestre,aac.id_persona,Aac.Id_Nivel_Ensenanza),1) ciclo,
    decode(Ape.Id_Facultad,8,'FACIHED',9,'FIA',10,'FCS',11,'FACTEO',12,'FCE') facultad,
    ft_deuda_alumno(aac.id_persona, substr(asm.semestre,0,4)) deuda,
    nvl(ft_desaprobado_ciclo(aac.id_persona,asp.id_semestre,Ape.Id_Nivel_Ensenanza),0) SD,
    aac.id_plan_programa,1
    from acad_alumno_contrato aac
    inner join acad_semestre_programa asp on Asp.Id_Semestre_Programa=Aac.Id_Semestre_Programa and aac.estado in ('1')
    --inner join acad_semestre asm on asm.id_semestre=asp.id_semestre
    and asp.id_semestre in (select id_semestre from acad_semestre where semestre>='2020-1' and substr(semestre,-2) in('-1','-2'))
    inner join acad_semestre asm on asm.id_semestre=Asp.Id_Semestre
    inner join vw_acad_programa_estudio ape on Ape.Id_Programa_Estudio=Asp.Id_Programa_Estudio
    inner join Acad_Matricula_Detalle amd on Amd.Id_Matricula_Detalle=Aac.Id_Matricula_Detalle and Amd.Id_Modo_Contrato=1
    inner join moises.persona_natural_alumno pna on Pna.Id_Persona=aac.id_persona
    inner join moises.persona_natural pn on Pn.Id_Persona=pna.id_persona
    inner join moises.persona p on P.Id_Persona=pn.id_persona
    where Ape.id_tipo_contrato in (1,2,3,4,5);
    commit;*/
    
    /*update Acad_Curso_Alumno aca 
    set Aca.Fecha_Fin_Curso=
    (select max(Amd.Fecha_Fin) Fecha_Fin
    from Acad_Carga_Curso_Docente accd inner join Acad_Modulo_Detalle amd on Amd.Id_Modulo_Detalle=Accd.Id_Modulo_Detalle
    where Accd.Id_Carga_Curso=aca.Id_Carga_Curso
    group by Accd.Id_Carga_Curso)
    where aca.Id_Carga_Curso is not null
    and Aca.Fecha_Fin_Curso<>
    (select max(Amd.Fecha_Fin) Fecha_Fin
    from Acad_Carga_Curso_Docente accd inner join Acad_Modulo_Detalle amd on Amd.Id_Modulo_Detalle=Accd.Id_Modulo_Detalle
    where Accd.Id_Carga_Curso=aca.Id_Carga_Curso
    group by Accd.Id_Carga_Curso);
    commit;*/
    
    /*UPDATE PLANTILLA_CURSO_TEMA A
    SET CODIGO=(SELECT CODIGO FROM ACAD_CARGA_TEMA B WHERE ''||B.ID_CARGA_TEMA=A.CODIGO)
    WHERE ID_PLANTILLA_CURSO_PLAN in (select ID_PLANTILLA_CURSO_PLAN from aatemp_cursoplan_plantilla_mig);
    commit;
    
    UPDATE PLANTILLA_CURSO_UNIDAD A
    SET CODIGO=(SELECT CODIGO FROM ACAD_CARGA_UNIDAD B WHERE ''||B.ID_CARGA_UNIDAD=A.CODIGO)
    WHERE ID_PLANTILLA_CURSO_PLAN not in (select ID_PLANTILLA_CURSO_PLAN from aatemp_cursoplan_plantilla_mig);
    commit;
    
    UPDATE PLANTILLA_CURSO_UNID_RA_EV A 
    SET ADJUNTO=(SELECT ADJUNTO FROM ACAD_CARGA_UNID_RA_EV B WHERE ''||B.ID_CARGA_UNID_RA_EV=A.ADJUNTO)
    WHERE ID_USUARIO_REG=4;
    commit;
    
    UPDATE PLANTILLA_CURSO_RES_APREND A
    SET RESULTADO=(SELECT RESULTADO FROM ACAD_CARGA_CURSO_RES_AP B WHERE ''||B.ID_CARGA_CURSO_RES_AP=A.RESULTADO)
    WHERE ID_PLANTILLA_CURSO_PLAN not in (select ID_PLANTILLA_CURSO_PLAN from aatemp_cursoplan_plantilla_mig);
    commit;*/
    
    /*update acad_carga_curso_det a
    set A.Id_Semestre_Programa=(select Id_Semestre_Programa from aatemp_act_sem_prog_cd b where b.Id_Carga_Curso_Det=a.Id_Carga_Curso_Det);
    commit;*/
    FOR s IN sem LOOP
      CALL pcd_alumno_ciclo(s.id_semestre);
      commit;
      CALL pcd_ranking_alumno(s.id_semestre);
      commit;
    end loop;

end;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_update_reporte () FROM PUBLIC;

