-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_f_evaluacion_docente (p_id_semestre integer) AS $body$
BEGIN
	
	 DELETE FROM david.EVALUACION_ACTIVIDAD_DOCENTE ead
	WHERE ead.ID_semestre = p_id_semestre;
	DELETE FROM david.evaluacion_capacitacion cp
	WHERE  cp.ID_SEMESTRE =p_id_semestre;
	
    DELETE FROM DAVID.consolidado_grupo_f WHERE ID_SEMESTRE = P_ID_SEMESTRE;
	DELETE FROM david.EVALUACION_OPE_DETALLE WHERE ID_SEMESTRE =p_id_semestre;
	DELETE FROM david.consolidado_grupo_f WHERE id_semestre = p_id_semestre;
	DELETE FROM david.evaluacion_grupo_focal WHERE id_semestre=p_id_semestre;



     INSERT INTO david.EVALUACION_ACTIVIDAD_DOCENTE
		   SELECT
		vaca.id_semestre,
		vape.id_sede,
		vape.id_nivel_ensenanza,
		vape.id_unidad_academica,
		vape.id_programa_estudio,
		pe.id_persona,
		avg(coalesce(PROMEDIO_ASISTENCIA_DOCENTE,0)) * 0.1 AS PROMEDIO_ASISTENCIA_DOCENTE,
		avg(coalesce(promedio_asistencia, 0))*0.1 AS promedio_asistencia,
		avg(coalesce(promedio_notas_semana,0))*0.3 AS promedio_notas_semana,
		avg(coalesce(canvas,0))*0.5 AS canvas,
		1  AS id_ope
		
		FROM reportbi.REPORTE_EVALUACION_DOC_MES redm
		INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE = redm.ID_CARGA_CURSO_DOCENTE 
		INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO = accd.ID_CARGA_CURSO 
		AND vaca.ORIGEN ='O'
		INNER JOIN moises.persona pe ON pe.ID_PERSONA = accd.ID_PERSONA 
		INNER JOIN david.ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA = pe.ID_PERSONA 
		INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO = apc.ID_PROGRAMA_ESTUDIO 
		AND apc.ID_SEMESTRE =vaca.ID_SEMESTRE 
		WHERE apc.ID_SEMESTRE = p_id_semestre
		GROUP BY
		vaca.id_semestre,
		vape.id_sede,
		vape.id_nivel_ensenanza,
		vape.id_unidad_academica,
		vape.id_programa_estudio,
		pe.id_persona;
	
	 INSERT INTO david.EVALUACION_ACTIVIDAD_DOCENTE 
		   SELECT
		vaca.id_semestre,
		vape.id_sede,
		vape.id_nivel_ensenanza,
		vape.id_unidad_academica,
		vape.id_programa_estudio,
		pe.id_persona,
		avg(coalesce(PROMEDIO_ASISTENCIA_DOCENTE,0)) * 0.1 AS PROMEDIO_ASISTENCIA_DOCENTE,
		avg(coalesce(promedio_asistencia, 0))*0.1 AS promedio_asistencia,
		avg(coalesce(promedio_notas_semana,0))*0.3 AS promedio_notas_semana,
		avg(coalesce(canvas,0))*0.5 AS canvas,
		2  AS id_ope
		
		FROM reportbi.REPORTE_EVALUACION_DOC_MES redm
		INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE = redm.ID_CARGA_CURSO_DOCENTE 
		INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO = accd.ID_CARGA_CURSO 
		AND vaca.ORIGEN ='O'
		INNER JOIN moises.persona pe ON pe.ID_PERSONA = accd.ID_PERSONA 
		INNER JOIN david.ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA = pe.ID_PERSONA 
		INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO = apc.ID_PROGRAMA_ESTUDIO 
		AND apc.ID_SEMESTRE =vaca.ID_SEMESTRE 
		WHERE apc.ID_SEMESTRE = p_id_semestre
		GROUP BY
		vaca.id_semestre,
		vape.id_sede,
		vape.id_nivel_ensenanza,
		vape.id_unidad_academica,
		vape.id_programa_estudio,
		pe.id_persona;
	
	
	
INSERT INTO david.evaluacion_capacitacion
SELECT
vaca.id_semestre,
vape.id_sede,
vape.id_nivel_ensenanza,
vape.id_unidad_academica,
vape.id_programa_estudio,
pe.id_persona,
avg(coalesce(redm.capacitacion,0)) * 0.1 AS capacitacion,
 
2 AS id_ope
 FROM reportbi.REPORTE_EVALUACION_DOC_MES redm
INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE = redm.ID_CARGA_CURSO_DOCENTE 
INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO = accd.ID_CARGA_CURSO 
AND vaca.ORIGEN ='O'
INNER JOIN moises.persona pe ON pe.ID_PERSONA = accd.ID_PERSONA 
INNER JOIN david.ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA = pe.ID_PERSONA 
INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO = apc.ID_PROGRAMA_ESTUDIO 
AND apc.ID_SEMESTRE =vaca.ID_SEMESTRE 
WHERE apc.ID_SEMESTRE = p_id_semestre
GROUP BY
vaca.id_semestre,
vape.id_sede,
vape.id_nivel_ensenanza,
vape.id_unidad_academica,
vape.id_programa_estudio,
pe.id_persona;


INSERT INTO david.evaluacion_capacitacion
SELECT
vaca.id_semestre,
vape.id_sede,
vape.id_nivel_ensenanza,
vape.id_unidad_academica,
vape.id_programa_estudio,
pe.id_persona,
avg(coalesce(redm.capacitacion,0)) AS capacitacion, -- * 0.1 AS capacitacion,
 
1 AS id_ope
 FROM reportbi.REPORTE_EVALUACION_DOC_MES redm
INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE = redm.ID_CARGA_CURSO_DOCENTE 
INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO = accd.ID_CARGA_CURSO 
AND vaca.ORIGEN ='O'
INNER JOIN moises.persona pe ON pe.ID_PERSONA = accd.ID_PERSONA 
INNER JOIN david.ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA = pe.ID_PERSONA 
INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO = apc.ID_PROGRAMA_ESTUDIO 
AND apc.ID_SEMESTRE =vaca.ID_SEMESTRE 
WHERE apc.ID_SEMESTRE = p_id_semestre
GROUP BY
vaca.id_semestre,
vape.id_sede,
vape.id_nivel_ensenanza,
vape.id_unidad_academica,
vape.id_programa_estudio,
pe.id_persona;



INSERT INTO EVALUACION_OPE_DETALLE
SELECT
  accd.ID_PERSONA,
  vaca.ID_SEMESTRE ,
vape.id_sede,
vape.ID_NIVEL_ENSENANZA ,
vape.ID_UNIDAD_ACADEMICA ,
vape.ID_PROGRAMA_ESTUDIO, 
 avg(ic.PUNTAJE_CON_FORMULA) AS puntaje_con_formula,

 1 AS id_ope
 FROM david.INS_PARTICIPANTE ip 
 INNER JOIN lucas.INSTRUMENTO_CUESTIONARIO ic ON ic.ID_CUESTIONARIO = ip.ID_CUESTIONARIO
 INNER JOIN david.INS_EJECUCION ie ON ie.ID_EJECUCION =ip.ID_EJECUCION 
 INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE = ip.IDENTIFICADOR
 INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO = accd.ID_CARGA_CURSO AND vaca.ORIGEN='O'
 INNER JOIN david.ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA = accd.ID_PERSONA  
 AND apc.ID_SEMESTRE = vaca.ID_SEMESTRE
 INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO
= apc.ID_PROGRAMA_ESTUDIO 
WHERE ip.ID_EJECUCION IN (300,302,303,304,305) and ic.ID_ESTADO_EVALUACION = 3 AND ic.CONSOLIDADO !='N' 
GROUP BY accd.ID_PERSONA,vaca.ID_SEMESTRE ,
vape.id_sede,
vape.ID_NIVEL_ENSENANZA ,
vape.ID_UNIDAD_ACADEMICA ,
vape.ID_PROGRAMA_ESTUDIO;



INSERT INTO EVALUACION_OPE_DETALLE
 SELECT  accd.ID_PERSONA,
  vaca.ID_SEMESTRE ,
vape.id_sede,
vape.ID_NIVEL_ENSENANZA ,
vape.ID_UNIDAD_ACADEMICA ,
vape.ID_PROGRAMA_ESTUDIO, 
 avg(ic.PUNTAJE_CON_FORMULA) AS puntaje_con_formula,

 2 AS id_ope
 FROM david.INS_PARTICIPANTE ip 
 INNER JOIN lucas.INSTRUMENTO_CUESTIONARIO ic ON ic.ID_CUESTIONARIO = ip.ID_CUESTIONARIO
 INNER JOIN david.INS_EJECUCION ie ON ie.ID_EJECUCION =ip.ID_EJECUCION 
 INNER JOIN david.ACAD_CARGA_CURSO_DOCENTE accd ON accd.ID_CARGA_CURSO_DOCENTE = ip.IDENTIFICADOR
 INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO = accd.ID_CARGA_CURSO AND vaca.ORIGEN='O'
 INNER JOIN david.ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA = accd.ID_PERSONA  
 AND apc.ID_SEMESTRE = vaca.ID_SEMESTRE
 INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO
= apc.ID_PROGRAMA_ESTUDIO 
WHERE ip.ID_EJECUCION = 311 and ic.ID_ESTADO_EVALUACION = 3 AND ic.CONSOLIDADO !='N'
GROUP BY accd.ID_PERSONA,vaca.ID_SEMESTRE ,
vape.id_sede,
vape.ID_NIVEL_ENSENANZA ,
vape.ID_UNIDAD_ACADEMICA ,
vape.ID_PROGRAMA_ESTUDIO;


 	
--LLENANDO EJE Y
	       
MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING(SELECT id_persona,id_ope, puntaje_con_formula FROM david.EVALUACION_OPE_DETALLE eod
    WHERE ID_OPE=1) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND h.id_ope= e.ID_OPE AND e.id_ope=1)
  WHEN MATCHED THEN
    UPDATE SET e.Y= h.puntaje_con_formula;

MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING(SELECT id_persona, id_ope, puntaje_con_formula FROM david.EVALUACION_OPE_DETALLE eod
    WHERE ID_OPE=2) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND h.id_ope= e.ID_OPE AND e.id_ope=2)
  WHEN MATCHED THEN
    UPDATE SET e.Y = h.puntaje_con_formula;

-- LLENANDO EJE X
 
MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING (SELECT ID_PERSONA , id_ope, (PROMEDIO_ASISTENCIA_DOCENTE+PROMEDIO_ASISTENCIA+PROMEDIO_NOTAS_SEMANA+CANVAS) AS 
    puntaje_con_formula FROM david.EVALUACION_ACTIVIDAD_DOCENTE   
    
    ) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=H.ID_OPE)
  WHEN MATCHED THEN
    UPDATE SET e.X = h.puntaje_con_formula;

   
   INSERT INTO consolidado_grupo_f
SELECT t1.*,
(dimension_1 + dimension_2 + dimension_3 + dimension_4) AS puntaje,
(dimension_1 + dimension_2 + dimension_3 + dimension_4)*20/12 AS puntaje_con_formula,
1 AS id_ope

FROM ( 
SELECT 
vaca.id_semestre,
vape.id_sede,
vape.id_nivel_ensenanza,
vape.id_unidad_academica,
vape.id_programa_estudio,
pe.id_persona,
ic.consolidado, ic.id_cuestionario,
  coalesce(ins_seccion_n('34341', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_1,
coalesce(ins_seccion_n('34347', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_2,
coalesce(ins_seccion_n('34354', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_3,
coalesce(ins_seccion_n('34361', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_4

 FROM david.INS_PARTICIPANTE ip 
INNER JOIN lucas.INSTRUMENTO_CUESTIONARIO ic ON ic.ID_CUESTIONARIO = ip.ID_CUESTIONARIO 
INNER JOIN david.acad_carga_curso_docente accd ON accd.ID_CARGA_CURSO_DOCENTE =
ip.identificador
INNER JOIN moises.persona pe ON pe.ID_PERSONA = accd.ID_PERSONA 
INNER JOIN moises.PERSONA_NATURAL pn ON pn.ID_PERSONA = pe.ID_PERSONA 
INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO =
accd.ID_CARGA_CURSO AND vaca.origen='O'
INNER JOIN ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA =accd.ID_PERSONA 
AND apc.ID_SEMESTRE = vaca.ID_SEMESTRE 
INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO =apc.ID_PROGRAMA_ESTUDIO 
WHERE ip.ID_EJECUCION IN (
306,307)  ) t1;

   INSERT INTO consolidado_grupo_f
SELECT t.*,
(dimension_1 + dimension_2 + dimension_3 + dimension_4) AS puntaje,
(dimension_1 + dimension_2 + dimension_3 + dimension_4)*20/12 AS puntaje_con_formula,
2 AS id_ope

FROM (
SELECT 
vaca.id_semestre,
vape.id_sede,
vape.id_nivel_ensenanza,
vape.id_unidad_academica,
vape.id_programa_estudio,
pe.id_persona,
ic.consolidado, ic.id_cuestionario,
  coalesce(ins_seccion_n('34341', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_1,
coalesce(ins_seccion_n('34347', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_2,
coalesce(ins_seccion_n('34354', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_3,
coalesce(ins_seccion_n('34361', ip.IDENTIFICADOR,ip.id_ejecucion), 0) AS dimension_4

 FROM david.INS_PARTICIPANTE ip 
INNER JOIN lucas.INSTRUMENTO_CUESTIONARIO ic ON ic.ID_CUESTIONARIO = ip.ID_CUESTIONARIO 
INNER JOIN david.acad_carga_curso_docente accd ON accd.ID_CARGA_CURSO_DOCENTE =
ip.identificador
INNER JOIN moises.persona pe ON pe.ID_PERSONA = accd.ID_PERSONA 
INNER JOIN moises.PERSONA_NATURAL pn ON pn.ID_PERSONA = pe.ID_PERSONA 
INNER JOIN david.VW_ACAD_CARGA_ACADEMICA vaca ON vaca.ID_CARGA_CURSO =
accd.ID_CARGA_CURSO AND vaca.origen='O'
INNER JOIN ACAD_PERSONA_CONTRATO apc ON apc.ID_PERSONA =accd.ID_PERSONA 
AND apc.ID_SEMESTRE = vaca.ID_SEMESTRE 
INNER JOIN david.VW_ACAD_PROGRAMA_ESTUDIO vape ON vape.ID_PROGRAMA_ESTUDIO =apc.ID_PROGRAMA_ESTUDIO 
WHERE ip.ID_EJECUCION IN (
306,307)  ) t;


INSERT INTO david.evaluacion_grupo_focal
SELECT
id_semestre,
id_sede,
id_nivel_ensenanza,
id_unidad_academica,
id_programa_estudio,
id_persona,
id_ope,
avg(puntaje_con_formula) AS puntaje_con_formula
FROM CONSOLIDADO_GRUPO_F
GROUP BY 
id_semestre,
id_sede,
id_nivel_ensenanza,
id_unidad_academica,
id_programa_estudio,
id_persona,
id_ope;


MERGE INTO david.ACAD_EVALUACION_DOCENTE_PERS  e
    USING (SELECT ID_PERSONA , id_ope, 
    (puntaje_con_formula * 15/20)  AS puntaje_con_formula
   FROM david.evaluacion_grupo_focal   
    ) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=H.ID_OPE)
  WHEN MATCHED THEN
    UPDATE SET e.grupo_focal = h.puntaje_con_formula;

 	       
 MERGE INTO david.ACAD_EVALUACION_DOCENTE_PERS  e
    USING (SELECT ID_PERSONA , id_ope, 
    ((PROMEDIO_ASISTENCIA_DOCENTE+PROMEDIO_ASISTENCIA+PROMEDIO_NOTAS_SEMANA+CANVAS)  * 35/100)  AS puntaje_con_formula
   FROM david.EVALUACION_ACTIVIDAD_DOCENTE    ea 
    ) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=H.ID_OPE)
  WHEN MATCHED THEN
    UPDATE SET e.ACTIVIDAD_DOCENTE  = h.puntaje_con_formula;

   
   MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING (SELECT id_persona,(puntaje_con_formula* 50/20) AS puntaje_con_formula
    FROM david.EVALUACION_OPE_DETALLE eod
    WHERE ID_OPE=1) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=1)
  WHEN MATCHED THEN
    UPDATE SET e.ope = h.puntaje_con_formula;

   
      MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING (SELECT id_persona,(puntaje_con_formula* 50/20) AS puntaje_con_formula
    FROM david.EVALUACION_OPE_DETALLE eod
    WHERE ID_OPE=2) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=2)
  WHEN MATCHED THEN
    UPDATE SET e.ope = h.puntaje_con_formula;


   
  MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING (SELECT id_persona,(puntaje_con_formula* 50/20) AS puntaje_con_formula
    FROM david.EVALUACION_OPE_DETALLE eod
    WHERE ID_OPE=2) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=2)
  WHEN MATCHED THEN
    UPDATE SET e.ope = h.puntaje_con_formula;

  MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING (SELECT id_persona,(eod.CAPACITACION * 0/100) AS puntaje_con_formula
    FROM david.EVALUACION_CAPACITACION  eod
    WHERE ID_OPE=1) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=1)
  WHEN MATCHED THEN
    UPDATE SET e.CAPACITACION_PERMANENTE = h.puntaje_con_formula;

    
    MERGE INTO ACAD_EVALUACION_DOCENTE_PERS e
    USING (SELECT id_persona,(eod.CAPACITACION * 0/100) AS puntaje_con_formula
    FROM david.EVALUACION_CAPACITACION  eod
    WHERE ID_OPE=2) h
    ON (e.ID_PERSONA  = h.ID_PERSONA AND e.ID_OPE=2)
  WHEN MATCHED THEN
    UPDATE SET e.CAPACITACION_PERMANENTE  = h.puntaje_con_formula;

    UPDATE ACAD_EVALUACION_DOCENTE_PERS
    SET x= 0 WHERE coalesce(X::text, '') = '';

    UPDATE ACAD_EVALUACION_DOCENTE_PERS
	SET y=0   WHERE coalesce(Y::text, '') = '';
    commit;
END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_f_evaluacion_docente (p_id_semestre integer) FROM PUBLIC;

