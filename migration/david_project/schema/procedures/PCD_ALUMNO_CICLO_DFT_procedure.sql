-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_alumno_ciclo_dft (val integer) AS $body$
DECLARE


  v_num integer :=0;
   p_id_semestre integer;

 
BEGIN 
 
    SELECT MAX(ID_SEMESTRE) into STRICT p_id_semestre
    FROM DAVID.ACAD_SEMESTRE WHERE ESTADO_ADVISER=1;

    delete FROM aatemp_alumno_ciclo where semestre=(SELECT semestre from acad_semestre where id_semestre=p_id_semestre);
    commit;

    insert into aatemp_alumno_ciclo
    SELECT Aac.Id_Persona,Asm.Semestre,Ape.Id_Programa_Estudio,Ape.Nombre_Corto,Pna.Codigo,
    P.Nombre||' '||P.Paterno||' '||P.Materno estudiante,
    coalesce(Ft_Calcular_Ciclo(asm.semestre,aac.id_persona,Aac.Id_Nivel_Ensenanza),1) ciclo,
    CASE WHEN Ape.Id_Facultad=8 THEN 'FACIHED' WHEN Ape.Id_Facultad=9 THEN 'FIA' WHEN Ape.Id_Facultad=10 THEN 'FCS' WHEN Ape.Id_Facultad=11 THEN 'FACTEO' WHEN Ape.Id_Facultad=12 THEN 'FCE' END  facultad,
    /*ft_deuda_alumno(aac.id_persona, substr(asm.semestre,0,4))*/
 0 deuda,
    coalesce(ft_desaprobado_ciclo(aac.id_persona,asp.id_semestre,Ape.Id_Nivel_Ensenanza),0) SD,
    aac.id_plan_programa,1
    from acad_alumno_contrato aac
    inner join acad_semestre_programa asp on Asp.Id_Semestre_Programa=Aac.Id_Semestre_Programa and aac.estado in ('1')
    and asp.id_semestre=p_id_semestre
    inner join acad_semestre asm on asm.id_semestre=Asp.Id_Semestre
    inner join vw_acad_programa_estudio ape on Ape.Id_Programa_Estudio=Asp.Id_Programa_Estudio
    inner join Acad_Matricula_Detalle amd on Amd.Id_Matricula_Detalle=Aac.Id_Matricula_Detalle and Amd.Id_Modo_Contrato=1
    inner join moises.persona_natural_alumno pna on Pna.Id_Persona=aac.id_persona
    inner join moises.persona_natural pn on Pn.Id_Persona=pna.id_persona
    inner join moises.persona p on P.Id_Persona=pn.id_persona
    where Ape.id_tipo_contrato in (1,2,3,4,5);
    commit;

end;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_alumno_ciclo_dft (val integer) FROM PUBLIC;

