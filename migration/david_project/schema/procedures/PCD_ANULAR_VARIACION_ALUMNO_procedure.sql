-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_anular_variacion_alumno (p_id_alumno_contrato integer) AS $body$
DECLARE


  v_num integer :=0;

 
BEGIN 
 
  EXECUTE 'truncate table aatemp_cursos_a_borrar';
    commit;
    
  update Acad_Curso_Alumno 
  set estado='1', id_tipo_condicion=7
  where Id_Curso_Alumno in (SELECT Aacc.Id_Curso_Alumno from Acad_Alumno_Contrato aac
                            inner join Acad_Alumno_Contrato_Curso aacc on Aacc.Id_Alumno_Contrato=aac.Id_Alumno_Contrato_Asociado
                            where aac.Id_Alumno_Contrato=p_id_alumno_contrato)
  and Id_Tipo_Condicion not in (1,2);
  commit;

  delete FROM acad_curso_variacion
  where  Id_Curso_Alumno in (SELECT Aacc.Id_Curso_Alumno from Acad_Alumno_Contrato aac
                              inner join Acad_Alumno_Contrato_Curso aacc on Aacc.Id_Alumno_Contrato=aac.Id_Alumno_Contrato_Asociado
                              where aac.Id_Alumno_Contrato=p_id_alumno_contrato);
  commit;

  insert into aatemp_cursos_a_borrar

 SELECT Id_Curso_alumno,id_alumno_contrato 
    from acad_curso_variacion
    	where Id_Alumno_Contrato=p_id_alumno_contrato AND (ID_CURSO_ALUMNO IS NOT NULL AND ID_CURSO_ALUMNO::text <> '')  
    	
UNION all

    SELECT 
    aca.ID_CURSO_ALUMNO, aacc.ID_ALUMNO_CONTRATo 
    FROM david.ACAD_ALUMNO_CONTRATO_CURSO aacc 
	INNER JOIN david.ACAD_CURSO_ALUMNO aca ON aca.ID_CURSO_ALUMNO = aacc.ID_CURSO_ALUMNO 
	INNER JOIN david.ACAD_CURSO_VARIACION acv ON acv.ID_CARGA_CURSO 
	= aca.ID_CARGA_CURSO  AND acv.ID_ALUMNO_PLAN_PROGRAMA  = aca.ID_PLAN_PROGRAMA 
	AND acv.ID_ALUMNO_CONTRATO =aacc.ID_ALUMNO_CONTRATO 
	AND acv.ID_TIPO_MOVIMIENTO_VAR =1 
	WHERE 	  acv.Id_Alumno_Contrato=p_id_alumno_contrato;

  commit;

    update eliseo.VENTA_DETALLE set id_alumno_contrato = NULL where id_alumno_contrato=p_id_alumno_contrato;
  commit;

    delete FROM ELISEO.Mat_Alumno_Contrato_Det where id_alumno_contrato=p_id_alumno_contrato;
  commit;

  delete FROM ELISEO.Mat_Concepto_Asign_Alum where id_alumno_contrato=p_id_alumno_contrato;
  commit;

 DELETE FROM eliseo.MAT_ALUMNO_CONTRATO_ASIENTO WHERE id_alumno_contrato  = p_id_alumno_contrato;
  COMMIT;
 
 
 DELETE FROM eliseo.MAT_ALUMNO_CONTRATO_CUOTA WHERE id_alumno_contrato  = p_id_alumno_contrato;
  COMMIT;
  
 DELETE FROM eliseo.MAT_ALUMNO_CONTRATO_DET WHERE id_alumno_contrato  = p_id_alumno_contrato;
  COMMIT;
  
 DELETE FROM eliseo.MAT_ALUMNO_CONTRATO_RECAL WHERE id_alumno_contrato  = p_id_alumno_contrato;
  COMMIT;
 
 
 DELETE FROM eliseo.MAT_ALUMNO_CONTRATO_RECAL WHERE id_alumno_contrato  = p_id_alumno_contrato;
  COMMIT;
 
  delete FROM Acad_Alumno_Contrato_Docs where id_alumno_contrato=p_id_alumno_contrato;
  commit;

  delete FROM ACUERDO_CONTRATO_CURSO where Id_Acuerdo_Contrato=(SELECT Id_Acuerdo_Contrato from ACUERDO_CONTRATO where id_alumno_contrato=p_id_alumno_contrato);
  commit;

  delete FROM ACUERDO_CONTRATO where id_alumno_contrato=p_id_alumno_contrato;
  commit;

  delete FROM Acad_Alumno_Contrato_Curso where id_alumno_contrato=p_id_alumno_contrato;
  commit;

  
  delete FROM ACAD_CURSO_VARIACION where id_alumno_contrato=p_id_alumno_contrato;
  commit;

  delete FROM ACAD_DELEGADO where ID_CURSO_ALUMNO IN (SELECT id_curso_alumno from acad_curso_alumno 
                                                  where  id_curso_alumno in (select id_curso_alumno from aatemp_cursos_a_borrar where id_alumno_contrato=p_id_alumno_contrato)
                                                  and id_tipo_condicion not in ('1','2') );
  commit;
  delete FROM DETALLE_CURSO_TRAMITE where ID_CURSO_ALUMNO IN (SELECT id_curso_alumno from acad_curso_alumno
                                                          where  id_curso_alumno in (select id_curso_alumno from aatemp_cursos_a_borrar where id_alumno_contrato=p_id_alumno_contrato)
                                                          and id_tipo_condicion not in ('1','2') );
  commit;
  delete FROM ACAD_CURSO_ALUMNO_AMBIENTE where ID_CURSO_ALUMNO IN (SELECT id_curso_alumno from acad_curso_alumno
                                                              where  id_curso_alumno in (select id_curso_alumno from aatemp_cursos_a_borrar where id_alumno_contrato=p_id_alumno_contrato)
                                                              and id_tipo_condicion not in ('1','2') );
  commit;
  delete FROM ACAD_SUBGRUPO_ESTUDIANTE where ID_CURSO_ALUMNO IN (SELECT id_curso_alumno from acad_curso_alumno
                                                            where  id_curso_alumno in (select id_curso_alumno from aatemp_cursos_a_borrar where id_alumno_contrato=p_id_alumno_contrato)
                                                            and id_tipo_condicion not in ('1','2') );
  commit;

  delete FROM acad_curso_alumno where  id_curso_alumno in (SELECT id_curso_alumno from aatemp_cursos_a_borrar where id_alumno_contrato=p_id_alumno_contrato)
  and id_tipo_condicion not in ('1','2');
  commit;

    delete FROM ALUM_CONTR_BECA_SEM where id_alumno_contrato=p_id_alumno_contrato;
  commit;

  delete FROM acad_alumno_contrato where id_alumno_contrato=p_id_alumno_contrato;
  commit;

  update acad_alumno_contrato set ID_ALUMNO_CONTRATO_CLON = NULL where ID_ALUMNO_CONTRATO_CLON=p_id_alumno_contrato;
  commit;

  EXECUTE 'truncate table aatemp_cursos_a_borrar';
    commit;

end;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_anular_variacion_alumno (p_id_alumno_contrato integer) FROM PUBLIC;

