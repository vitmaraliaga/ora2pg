-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_ranking_dft_alumno (val integer) AS $body$
DECLARE


p_id_semestre integer;


BEGIN

    SELECT MAX(ID_SEMESTRE) into STRICT p_id_semestre
    FROM DAVID.ACAD_SEMESTRE WHERE ESTADO_ADVISER=1;

    CALL pcd_alumno_ciclo(p_id_semestre);
    COMMIT;

  delete FROM aatemp_poderados_semestre where id_semestre=p_id_semestre;
    COMMIT;

  insert into aatemp_poderados_semestre
  SELECT DISTINCT id_persona,id_plan_programa,id_semestre,id_programa_estudio,ciclo,ponderado_general,ponderado_ciclo 
  from (SELECT distinct aac.id_persona,aac.id_plan_programa,aac.id_semestre,aac.id_programa_estudio,Aac.Ciclo,
        coalesce(ft_n_ponderado_general_plan(aac.id_persona,aac.id_plan_programa),0) ponderado_general,
        coalesce(ft_ponderado_ciclo(aac.id_persona,aac.id_semestre,aac.id_nivel_ensenanza),0) ponderado_ciclo
        from Vw_Acad_Alumno_Contrato aac
        where aac.id_semestre=p_id_semestre 
        and id_modo_contrato=1
        and aac.Id_Tipo_Contrato in (1,2,4,5) and aac.estado='1' 
  ) alias5
  where (id_persona,id_plan_programa,id_semestre,id_programa_estudio,ciclo) not in (select id_persona,id_plan_programa,id_semestre,id_programa_estudio,ciclo from aatemp_poderados_semestre);
  commit;

  delete FROM aatemp_ranking_semestre where id_semestre=p_id_semestre;

   INSERT INTO aatemp_ranking_semestre
   SELECT a.*, CASE WHEN rn=1 THEN 'PRIMER PUESTO' WHEN rn=2 THEN 'SEGUNDO PUESTO'  ELSE (case when rn<=floor(total/10) then 'DÉSIMO SUPERIOR'                              else (case when rn<=floor(total/5) then 'QUINTO SUPERIOR'                                        else (case when rn<=floor(total/3) then 'TERCIO SUPERIOR'                                                  else (case when rn<=floor(total/2) then 'MEDIO SUPERIOR'                                                            else 'PUESTO '||rn                                                            end)                                                  end)                                        end)                            end) END  puesto, 'A' TIPO
   from (SELECT 
          ROW_NUMBER() OVER ( PARTITION BY id_semestre,id_programa_estudio,Ciclo
          ORDER BY id_semestre,id_programa_estudio,Ciclo,ponderado_general desc) RN, T.*,
          (select count(*) from aatemp_poderados_semestre a where A.Id_Programa_Estudio=T.Id_Programa_Estudio and a.ciclo=t.ciclo) total
          FROM aatemp_poderados_semestre T
          where id_semestre=p_id_semestre
          order by id_semestre,id_programa_estudio,Ciclo,ponderado_general desc) a;
  commit;

  INSERT INTO aatemp_ranking_semestre
  SELECT a.*, CASE WHEN rn=1 THEN 'PRIMER PUESTO' WHEN rn=2 THEN 'SEGUNDO PUESTO'  ELSE (case when rn<=floor(total/10) then 'DÉSIMO SUPERIOR'                              else (case when rn<=floor(total/5) then 'QUINTO SUPERIOR'                                        else (case when rn<=floor(total/3) then 'TERCIO SUPERIOR'                                                  else (case when rn<=floor(total/2) then 'MEDIO SUPERIOR'                                                            else 'PUESTO '||rn                                                            end)                                                  end)                                        end)                            end) END  puesto, 'S' TIPO
   from (SELECT 
          ROW_NUMBER() OVER ( PARTITION BY id_semestre,id_programa_estudio,Ciclo
          ORDER BY id_semestre,id_programa_estudio,Ciclo,ponderado_ciclo desc) RN, T.*,
          (select count(*) from aatemp_poderados_semestre a where A.Id_Programa_Estudio=T.Id_Programa_Estudio and a.ciclo=t.ciclo) total
          FROM aatemp_poderados_semestre T
          where id_semestre=p_id_semestre
          order by id_semestre,id_programa_estudio,Ciclo,ponderado_ciclo desc) a 
;
  commit;

end;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_ranking_dft_alumno (val integer) FROM PUBLIC;

