-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_create_copia_plan ( p_id_plan integer, p_id_usuario_reg integer ) AS $body$
DECLARE


    --lista de cursos del m√°ximo plan
    curso_plan CURSOR FOR
      SELECT apc.id_curso_detalle, apc.id_tipo_curso, apc.ciclo, apc.estado, apc.id_plan_curso_electivo, apc.codigo as codigo_new
      from acad_plan ap inner join Acad_Plan_Curso apc on Apc.Id_Plan=Ap.Id_Plan
      and (Id_Area,Nombre) = (SELECT id_area,max(nombre) 
                              from Acad_Plan where id_area=(select id_area from acad_plan where id_plan=p_id_plan) 
                              and id_plan<>p_id_plan 
                              group by id_area)
      and apc.estado='1' 
      order by apc.ciclo, apc.id_curso_detalle;

BEGIN


  for reg in curso_plan
  loop
  
    --registra los requisitos activos al alumno en el semestre activo
    insert into Acad_Plan_Curso(id_plan,
    id_curso_detalle,
    id_tipo_curso,
    ciclo,
    estado,
    id_plan_curso_electivo,
    codigo,
    id_usuario_reg,
    fecha_registro)
    values (p_id_plan,
          reg.id_curso_detalle,
          reg.id_tipo_curso,
          reg.ciclo,
          reg.estado,
          reg.id_plan_curso_electivo,
          reg.codigo_new,
          p_id_usuario_reg,
          clock_timestamp());

  end loop;

  begin
    
    CALL pcd_create_copia_plan_pre(p_id_plan,p_id_usuario_reg);

  end;

  
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE david.pcd_create_copia_plan ( p_id_plan integer, p_id_usuario_reg integer ) FROM PUBLIC;

