-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.sp_table_columns_nn (P_COLUMN text, P_VALOR text) AS $body$
DECLARE

    L_SCHEMA varchar(50);
    L_TABLE varchar(50);
    L_COLUMN varchar(50);
    L_CANT bigint;
    P_SQL_STMT varchar(500);

    C_TABLES CURSOR FOR
    SELECT OWNER,TABLE_NAME, COLUMN_NAME
    FROM ALL_TAB_COLUMNS A
    WHERE TABLE_NAME NOT IN (SELECT VIEW_NAME FROM USER_VIEWS)
    AND COLUMN_NAME = UPPER(P_COLUMN)
    AND TABLE_NAME NOT IN 'BIN$v3XaQc2vhk/gQKjAcA1FLg==$0'
    --AND OWNER <>'JOSUE'
 
;


BEGIN
    EXECUTE 'TRUNCATE TABLE TT_TABLES_NEW';
    commit;

    OPEN C_TABLES;
        FETCH C_TABLES INTO L_SCHEMA,L_TABLE,L_COLUMN;
            WHILE C_TABLES%FOUND LOOP
                P_SQL_STMT := 'SELECT COUNT(*) ';
                P_SQL_STMT := P_SQL_STMT || ' FROM '||L_SCHEMA||'.'||L_TABLE;
                P_SQL_STMT := P_SQL_STMT || ' WHERE '||L_COLUMN;
                P_SQL_STMT := P_SQL_STMT ||' = '|| chr(39)||P_VALOR|| chr(39);
                P_SQL_STMT := REPLACE(P_SQL_STMT,'"',CHR(39));
                EXECUTE P_SQL_STMT INTO STRICT L_CANT;
                IF L_CANT > 0 THEN
                    INSERT INTO TT_TABLES_NEW(SCHEMAS,TABLA,COLUMNA,VALOR,CANTIDAD) VALUES (L_SCHEMA,L_TABLE,L_COLUMN,P_VALOR,L_CANT);
                    COMMIT;
                END IF;
            FETCH C_TABLES INTO L_SCHEMA,L_TABLE,L_COLUMN;
            END LOOP;
    CLOSE C_TABLES;

END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.sp_table_columns_nn (P_COLUMN text, P_VALOR text) FROM PUBLIC;

