-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_temporal_carga_docente (P_ID_SEMESTRE bigint) AS $body$
DECLARE

  l_contar bigint;
  l_error bigint:=0;
  l_msgerror varchar(200):='ok';
  l_id_carga_curso_docente bigint;
  l_horario varchar(400);
  l_horario_tmp varchar(400);
  l_id_tipo_formato_modulo bigint;
  l_dias bigint:=7;
  l_i bigint:=1;
  l_j bigint:=1;
  l_total bigint:=0;
  l_fecha timestamp(0);
  l_hora bigint:=0;
  l_fecha_ini timestamp(0);
  l_num_dia bigint;
  l_n_resta bigint;
  l_id_persona bigint;
  l_item bigint;
  l_costo decimal(10,2);
  l_id_escala_sala_docente_det bigint;
  l_id_tipo_hora_pago bigint;
  l_fecha_inic timestamp(0);
  l_fecha_finc  timestamp(0);
  l_id_solic_reque bigint;

  docentes CURSOR FOR
  SELECT id_persona,amd.fecha_inicio, amd.fecha_fin
  from vw_acad_carga_academica aca inner join acad_carga_curso_docente accd on accd.id_carga_curso=aca.id_carga_curso
  inner join acad_modulo_detalle amd on amd.id_modulo_detalle=accd.id_modulo_detalle 
  where aca.id_semestre=P_ID_SEMESTRE and aca.origen='O'
  GROUP BY id_persona,amd.fecha_inicio, amd.fecha_fin;

  curCab CURSOR FOR
  SELECT ID_CARGA_CURSO_DOCENTE,ID_PROGRAMA_ESTUDIO,MIN(FECHA_INICIO) AS FECHA_INICIO,MIN(FECHA_FIN) AS FECHA_FIN
  FROM DAVID.TB_PCD_CARGA_DOCENTE 
  WHERE ID_PERSONA=l_id_persona 
  AND ID_SEMESTRE=P_ID_SEMESTRE
  GROUP BY ID_CARGA_CURSO_DOCENTE,ID_PROGRAMA_ESTUDIO
  ORDER BY ID_CARGA_CURSO_DOCENTE;

  
  curDet CURSOR FOR
  SELECT 
  ID_MODULO_DETALLE,
  ID_MODULO,
  ID_TIPO_HORARIO,
  FECHA_INICIO,
  FECHA_FIN,
  replace(HORARIO,'G','1') HORARIO,
  ID_SEDEAREA,
  NOMBRE_AREA,
  CURSO,
  CICLO,
  CREDITO,
  HP,
  HT,
  HNP,
  GRUPO
  FROM DAVID.TB_PCD_CARGA_DOCENTE 
  WHERE ID_PERSONA=l_id_persona 
  AND ID_SEMESTRE=P_ID_SEMESTRE
  AND ID_CARGA_CURSO_DOCENTE=l_id_carga_curso_docente
  ORDER BY FECHA_INICIO;

BEGIN

  delete FROM david.tb_pcd_horas_dia_docente where ID_SEMESTRE=P_ID_SEMESTRE;
  commit;
  delete FROM david.tb_pcd_carga_docente;
  commit;
  delete FROM tb_pcd_horas_mes_ccd where ID_SEMESTRE=P_ID_SEMESTRE;
  commit;

  FOR doC in docentes LOOP
    BEGIN

    
      l_id_persona:=doC.id_persona;
      l_fecha_inic:=doC.fecha_inicio;
      l_fecha_finc:=doC.fecha_fin;

      insert into david.tb_pcd_carga_docente 
      SELECT
      amd.id_modulo_detalle,
      accd.id_carga_curso_docente,
      aca.id_programa_estudio,
      amd.id_modulo,
      coalesce(accd.id_tipo_horario,1),
      accd.id_persona,
      aca.id_semestre,
      amd.fecha_inicio,
      amd.fecha_fin,
      accd.horario,
      aca.nom_escuela nombre_area,
      aca.nombre_curso curso,
      aca.ciclo,
      aca.credito,
      aca.hp,
      aca.ht,
      aca.hnp,
      aca.id_unidad_academica id_sedearea,
      aca.grupo
      from  vw_acad_carga_academica aca inner join acad_carga_curso_docente accd on accd.id_carga_curso=aca.id_carga_curso and aca.origen='O'
      inner join acad_modulo_detalle amd on amd.id_modulo_detalle=accd.id_modulo_detalle
      where accd.id_persona=l_id_persona
      and aca.id_semestre=p_id_semestre
      order by amd.fecha_inicio;
      commit;

      
      FOR curC in curCab LOOP
        BEGIN
          l_id_carga_curso_docente:=curC.ID_CARGA_CURSO_DOCENTE;
          FOR curD in curDet LOOP
            BEGIN
              DELETE FROM DAVID.TB_PCD_CARGA_SEMANA;
              commit;
              select id_tipo_formato_modulo into STRICT l_id_tipo_formato_modulo from david.acad_modulo where id_modulo=curD.id_modulo;
              if l_id_tipo_formato_modulo<>2 then
                l_horario:=curD.horario;
                l_total:=length(l_horario);
                l_horario_tmp := l_horario;
                l_j:=1;
                while l_j<=l_total loop
                  l_horario_tmp := substr(l_horario_tmp,0,l_dias);
                  l_i:=1;

                  l_num_dia:= (to_char(curD.fecha_inicio, 'd'))::numeric;
                  l_n_resta:= l_num_dia - 1;
                  l_fecha_ini:= curD.fecha_inicio - l_n_resta;
                  l_fecha:=l_fecha_ini;
                  while l_i<=l_dias LOOP
                    l_hora:= substr(l_horario_tmp,l_i,1);
                    if l_hora = '1' then

                      if l_fecha>=curD.fecha_inicio and l_fecha <=curD.fecha_fin then
                        INSERT INTO DAVID.TB_PCD_CARGA_SEMANA(DIA,HORA,ID_TIPO_HORARIO,FECHA) VALUES (l_i,(l_hora)::numeric ,curD.ID_TIPO_HORARIO, l_fecha);
                        commit;
                     end if;
                    end if;
                    l_fecha:= l_fecha + 1;
                    l_i:=l_i + 1;
                  END LOOP;
                  l_j:=l_j + 7;
                  l_horario_tmp := substr(l_horario,l_j,l_total);

                END LOOP;

                INSERT INTO david.tb_pcd_horas_dia_docente(
                  ID_CARGA_CURSO_DOCENTE,
                  ID_SEMESTRE,
                  ID_PERSONA,
                  ID_TIPO_HORARIO,
                  FECHA,
                  HORAS,
                  ID_PROGRAMA_ESTUDIO,
                  HORARIO,
                  ID_SEDEAREA,
                  NOMBRE_AREA,
                  CURSO,
                  CICLO,
                  CREDITOS,
                  HP,
                  HT,
                  HNP,
                  ID_CONTRATO,
                  GRUPO
                )
                SELECT 
                l_id_carga_curso_docente,
                P_ID_SEMESTRE,
                l_id_persona,
                ID_TIPO_HORARIO, 
                FECHA, 
                SUM(HORA) ,
                curC.ID_PROGRAMA_ESTUDIO,
                curD.HORARIO,
                curD.ID_SEDEAREA,
                curD.NOMBRE_AREA,
                curD.CURSO,
                curD.CICLO,
                curD.CREDITO,
                curD.HP,
                curD.HT,
                curD.HNP,
                P_ID_SEMESTRE,
                curD.GRUPO
                FROM DAVID.TB_PCD_CARGA_SEMANA 
                WHERE HORA>0 GROUP BY FECHA,ID_TIPO_HORARIO 
                ORDER BY FECHA;
                commit;

                l_fecha:= curD.fecha_inicio + 7;
                l_j:=7;
                WHILE l_fecha<curD.fecha_fin loop

                  INSERT INTO david.tb_pcd_horas_dia_docente(
                    ID_CARGA_CURSO_DOCENTE,
                    ID_SEMESTRE,
                    ID_PERSONA,
                    ID_TIPO_HORARIO,
                    FECHA,
                    HORAS,
                    ID_PROGRAMA_ESTUDIO,
                    HORARIO,
                    ID_SEDEAREA,
                    NOMBRE_AREA,
                    CURSO,
                    CICLO,
                    CREDITOS,
                    HP,
                    HT,
                    HNP,
                    ID_CONTRATO,
                    GRUPO
                  )
                  SELECT 
                  l_id_carga_curso_docente,
                  P_ID_SEMESTRE,
                  l_id_persona, 
                  ID_TIPO_HORARIO,
                  FECHA+l_j, 
                  SUM(HORA) ,
                  curC.ID_PROGRAMA_ESTUDIO,
                  curD.HORARIO,
                  curD.ID_SEDEAREA,
                  curD.NOMBRE_AREA,
                  curD.CURSO,
                  curD.CICLO,
                  curD.CREDITO,
                  curD.HP,
                  curD.HT,
                  curD.HNP,
                  P_ID_SEMESTRE,
                  curD.GRUPO
                  FROM DAVID.TB_PCD_CARGA_SEMANA 
                  WHERE HORA>0 GROUP BY FECHA,ID_TIPO_HORARIO 
                  ORDER BY FECHA;
                  l_fecha:= l_fecha + 7;
                  l_j:=l_j+7;
                  commit;
                END LOOP;

              end if;
            END;
          END LOOP;
        END;
      END LOOP;


    END;
  END LOOP;
  
  insert into tb_pcd_horas_mes_ccd 
  SELECT id_semestre,Id_Carga_Curso_Docente,to_char(fecha,'MM') mes,sum(horas) horas_mes 
  from TB_PCD_HORAS_DIA_DOCENTE where id_semestre=P_ID_SEMESTRE
  group by id_semestre,Id_Carga_Curso_Docente,to_char(fecha,'MM');

  commit;

  delete FROM tb_pcd_fecha_hora_cur_doc where id_semestre=P_ID_SEMESTRE;

  commit;

  insert into tb_pcd_fecha_hora_cur_doc
  SELECT distinct a.id_semestre,acd.id_carga_curso_docente,A.Fecha,trim(both to_char(a.Fecha,'DAY')) dia,
  FT_CURSO_DOCENTE_HORARIO(DIA_HORA_CURSO_N(a.horario,''||trim(both to_char(a.Fecha,'DAY')),Asp.Id_Horario),to_char(a.fecha,'D'),Asp.Id_Horario,A.Horas,'I') HORA_INICIO,
  FT_CURSO_DOCENTE_HORARIO(DIA_HORA_CURSO_N(a.horario,''||trim(both to_char(a.Fecha,'DAY')),Asp.Id_Horario),to_char(a.fecha,'D'),Asp.Id_Horario,A.Horas,'F') HORA_FIN
  from TB_PCD_HORAS_DIA_DOCENTE a inner join Acad_Carga_Curso_Docente acd on Acd.Id_Carga_Curso_Docente=A.Id_Carga_Curso_Docente
  inner join Acad_Modulo_Detalle amd on Amd.Id_Modulo_Detalle=Acd.Id_Modulo_Detalle
  inner join Acad_Semestre_Programa asp on Asp.Id_Semestre_Programa=Amd.Id_Semestre_Programa
    where a.id_semestre=P_ID_SEMESTRE
;

  commit;

END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_temporal_carga_docente (P_ID_SEMESTRE bigint) FROM PUBLIC;

