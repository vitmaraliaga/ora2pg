-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_conval_curso_sede_cc (p_id_persona integer,p_id_plan_programa_a integer,p_id_plan_programa_n integer, p_id_usuario_reg integer, out CURSOR REFCURSOR) AS $body$
DECLARE


   l_contar bigint:=0;
   l_error varchar(200);
   l_val_id_plan_curso varchar(4000);

   cursos CURSOR FOR
   SELECT ID_PERSONA,ID_CURSO_DETALLE,ID_TIPO_CONDICION,ID_PLAN_CURSO,PROMEDIO,ALCANZADO,ESTADO,FECHA_FIN_CURSO
    from acad_curso_alumno where id_persona=p_id_persona and id_plan_programa=p_id_plan_programa_a and estado='1'
    and (ID_PERSONA,ID_TIPO_CONDICION,ID_PLAN_CURSO,PROMEDIO,FECHA_FIN_CURSO) 
        not in (SELECT ID_PERSONA,ID_TIPO_CONDICION,ID_PLAN_CURSO,PROMEDIO,FECHA_FIN_CURSO from acad_curso_alumno 
                      where id_persona=p_id_persona and id_plan_programa=p_id_plan_programa_n and estado='1');

BEGIN

    l_contar:=0;
    l_error:='No tiene ning√∫n curso para ingresar';
    l_val_id_plan_curso:='';

  for cc in cursos loop

    insert into acad_curso_alumno(ID_PERSONA,ID_PLAN_PROGRAMA,ID_CURSO_DETALLE,ID_TIPO_TRAMITE,ID_TIPO_CONDICION,ID_PLAN_CURSO,PROMEDIO,ALCANZADO,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO,FECHA_FIN_CURSO)
    values (cc.ID_PERSONA,p_id_plan_programa_n,cc.ID_CURSO_DETALLE,19,cc.ID_TIPO_CONDICION,cc.ID_PLAN_CURSO,cc.PROMEDIO,cc.ALCANZADO,cc.ESTADO,p_id_usuario_reg,clock_timestamp(),cc.FECHA_FIN_CURSO);

    commit;

    l_contar:=1;
    l_error:='';

    if (l_val_id_plan_curso='') then
      l_val_id_plan_curso:=cc.ID_PLAN_CURSO;
    else
      l_val_id_plan_curso:=l_val_id_plan_curso||','||cc.ID_PLAN_CURSO;
    end if;

  
  end loop;

  open CURSOR FOR 
            SELECT l_contar as resultado, l_error as msg_error,l_val_id_plan_curso id_plan_curso;

END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_conval_curso_sede_cc (p_id_persona integer,p_id_plan_programa_a integer,p_id_plan_programa_n integer, p_id_usuario_reg integer, out CURSOR REFCURSOR) FROM PUBLIC;

