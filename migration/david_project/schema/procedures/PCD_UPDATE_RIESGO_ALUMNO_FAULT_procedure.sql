-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = david,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE david.pcd_update_riesgo_alumno_fault (v_id_semestre integer) AS $body$
BEGIN
  
  delete FROM aatemp_nivel_riesgo_alumno where id_semestre=v_id_semestre;
  commit;

  insert into aatemp_nivel_riesgo_alumno
  SELECT distinct asp.id_semestre,Ape.Id_Programa_Estudio,
  Ft_Calcular_Ciclo(asm.semestre,aac.id_persona,Aac.Id_Nivel_Ensenanza) ciclo,
  coalesce(Ft_Calcular_grupo(asm.semestre,aac.id_persona,Aac.Id_Nivel_Ensenanza),'Ãšnico') grupo,
  aac.id_persona,ft_ponderado_ciclo(aac.id_persona,asp.id_semestre,Aac.Id_Nivel_Ensenanza) ponderado,
  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'CNA'),0) CNA,
  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'CRA'),0) CRA,
  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'CD'),0) CD,
  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'TC'),0) TC,
  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'SD'),0) SD,
  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'SA'),0) SA,
  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'TS'),0) TS,
  ft_nivel_riesgo(ft_ponderado_ciclo(aac.id_persona,asp.id_semestre,Aac.Id_Nivel_Ensenanza), 
                  coalesce(ft_cant_estado_cursos_ciclo(aac.id_persona, Aac.Id_Nivel_Ensenanza, Aac.Id_Plan_Programa, Asp.Id_Semestre, 'SD'),0), 'C') riesgo
  from acad_alumno_contrato aac
  inner join acad_semestre_programa asp on Asp.Id_Semestre_Programa=Aac.Id_Semestre_Programa and aac.estado in ('1')
  and asp.id_semestre in (v_id_semestre)
  inner join acad_semestre asm on asm.id_semestre=Asp.Id_Semestre
  inner join vw_acad_programa_estudio ape on Ape.Id_Programa_Estudio=Asp.Id_Programa_Estudio
  inner join Acad_Matricula_Detalle amd on Amd.Id_Matricula_Detalle=Aac.Id_Matricula_Detalle and Amd.Id_Modo_Contrato=1
  where Ape.Id_Tipo_Contrato in (1,2);
  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE david.pcd_update_riesgo_alumno_fault (v_id_semestre integer) FROM PUBLIC;

