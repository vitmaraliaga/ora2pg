-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = enoc,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION enoc.fc_est_aprob_cambio (P_ID_CAMBIOS bigint, P_ID_ESTADO_APRO text) RETURNS varchar AS $body$
DECLARE

l_dato varchar(5):='N';
l_contar integer:=0;
l_id_estado_act varchar(5);
l_id_estado varchar(5);
l_proceso_fin  varchar(5):='N';
l_id_concepto_cambio bigint;
l_orden bigint;

BEGIN

     SELECT ID_ESTADO_CAMBIO, coalesce(PROCESO_FIN,'N') ,ID_CONCEPTO_CAMBIO
     INTO STRICT l_id_estado, l_proceso_fin ,l_id_concepto_cambio
     FROM enoc.PLLA_CAMBIOS
     WHERE ID_CAMBIOS=P_ID_CAMBIOS;

     if l_proceso_fin='N' then

       SELECT COUNT(*) INTO STRICT l_contar 
       FROM enoc.VW_CONCEPTO_ESTADO_CAMBIO 
       WHERE ID_CONCEPTO_CAMBIO=l_id_concepto_cambio
       AND ID_ESTADO_CAMBIO=l_id_estado;

       IF l_contar>0 THEN
          
         SELECT COUNT(*) INTO STRICT l_contar 
         FROM enoc.VW_CONCEPTO_ESTADO_CAMBIO 
         WHERE ID_CONCEPTO_CAMBIO=l_id_concepto_cambio
         AND ID_ESTADO_CAMBIO=P_ID_ESTADO_APRO;

 
         IF l_contar>0 THEN
         
           select orden into STRICT l_orden from ENOC.PLLA_CONCEPTO_ESTADO_CAMBIO
           WHERE ID_CONCEPTO_CAMBIO=l_id_concepto_cambio
           AND ID_ESTADO_CAMBIO=P_ID_ESTADO_APRO;

           SELECT coalesce(MAX(ID_ESTADO_CAMBIO),'-') INTO STRICT l_id_estado_act 
           FROM enoc.VW_CONCEPTO_ESTADO_CAMBIO
           WHERE ID_CONCEPTO_CAMBIO=l_id_concepto_cambio
           AND orden_cambio<l_orden;

           if l_id_estado_act = l_id_estado then
              l_dato:='S';
           end if;
          END IF;
       END IF;
    end if;
	RETURN(l_dato);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION enoc.fc_est_aprob_cambio (P_ID_CAMBIOS bigint, P_ID_ESTADO_APRO text) FROM PUBLIC;

