-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = enoc,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION enoc.fc_est_aprob_req_cand (P_ID_SOLIC_REQ_CANDIDATO bigint, P_ID_ESTADO_REQ_CAND text) RETURNS varchar AS $body$
DECLARE

l_dato varchar(5):='N';
l_contar integer:=0;
l_id_estado_act varchar(5);
l_id_estado varchar(5);
l_id_tipo_paso bigint;
l_orden bigint;
l_id_entidad bigint;
l_id_estado_req varchar(5);

BEGIN

     SELECT A.ID_ESTADO_REQ_CAND, A.ID_PASO_REQUE, B.ID_ENTIDAD,B.ID_ESTADO_REQ
     INTO STRICT l_id_estado, l_id_tipo_paso,l_id_entidad,l_id_estado_req
     FROM enoc.PLLA_SOLIC_REQ_CANDIDATO A, enoc.PLLA_SOLIC_REQUE B
     WHERE A.ID_SOLIC_REQUE=B.ID_SOLIC_REQUE
     AND A.ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO;

     SELECT COUNT(*) INTO STRICT l_contar 
     FROM enoc.PLLA_PASO_REQUE_EST_CAND 
     WHERE ID_PASO_REQUE=l_id_tipo_paso
     AND ID_ESTADO_REQ_CAND=l_id_estado
     AND ID_ENTIDAD =l_id_entidad;

     if P_ID_ESTADO_REQ_CAND='10' and l_id_estado='07' and l_id_estado_req='07' then
      l_dato:='S';
     end if;

     IF l_contar>0 THEN
        
       SELECT COUNT(*) INTO STRICT l_contar 
       FROM enoc.PLLA_PASO_REQUE_EST_CAND 
       WHERE ID_PASO_REQUE=l_id_tipo_paso
       AND ID_ESTADO_REQ_CAND=P_ID_ESTADO_REQ_CAND
       AND ID_ENTIDAD =l_id_entidad;

  
       IF l_contar>0 THEN
       
         select orden into STRICT l_orden from ENOC.PLLA_ESTADO_REQ_CAND
         WHERE ID_ESTADO_REQ_CAND=P_ID_ESTADO_REQ_CAND;

         SELECT COUNT(*) INTO STRICT l_contar  
         FROM enoc.VW_PASO_REQUE_EST_CAND
         WHERE ID_PASO_REQUE=l_id_tipo_paso
         AND ID_ENTIDAD= l_id_entidad
         AND orden<l_orden;

         IF l_contar>0 THEN
            select x.ID_ESTADO_REQ_CAND INTO STRICT l_id_estado_act from ( 
             SELECT ID_ESTADO_REQ_CAND, orden 
             FROM enoc.VW_PASO_REQUE_EST_CAND
             WHERE ID_PASO_REQUE=l_id_tipo_paso
             AND ID_ENTIDAD= l_id_entidad
             AND orden<l_orden
             ORDER BY orden desc
            )x ORDER BY orden desc LIMIT 1;

           if l_id_estado_act = l_id_estado then
              l_dato:='S';
           end if;
         END IF;
        END IF;
     END IF;

	RETURN(l_dato);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION enoc.fc_est_aprob_req_cand (P_ID_SOLIC_REQ_CANDIDATO bigint, P_ID_ESTADO_REQ_CAND text) FROM PUBLIC;

