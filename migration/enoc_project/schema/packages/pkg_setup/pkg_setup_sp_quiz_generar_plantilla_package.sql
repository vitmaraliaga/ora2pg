-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_setup,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_setup_sp_quiz_generar_plantilla (P_ID_CUESTIONARIO_ASIG bigint,P_PATH_IMG text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_plantilla text:='';
        l_parametro  text:='';
        l_longitud bigint:=0;
        l_id_plantilla bigint;
        l_id_cuestionario bigint;
        l_id_entidad bigint;
        l_sql varchar(4000):='';
        curpara CURSOR FOR
        SELECT 
          ID_PARAMETRO_PLANT,
          TIPO,
          PARAMETRO,
          SIGNIFICADO,
          COMENTARIO,
          CAMPO,
          PROCESO,
          VIGENCIA
        from enoc.QUIZ_PARAMETRO_PLANT
        where vigencia=1
        and TIPO_PROC='SP'
        ORDER BY ID_PARAMETRO_PLANT;

      
BEGIN
      
        select A.ID_PLANTILLA,a.id_entidad INTO STRICT l_id_plantilla,l_id_entidad from enoc.QUIZ_CUESTIONARIO a,enoc.QUIZ_CUESTIONARIO_ASIG B 
        WHERE A.ID_CUESTIONARIO=B.ID_CUESTIONARIO 
        AND B.ID_CUESTIONARIO_ASIG=P_ID_CUESTIONARIO_ASIG;

        if coalesce(l_id_plantilla::text, '') = '' then
          l_error:=1;
          l_msgerror:='No se procesa con plantilla';
--           goto salida_gen;
        end if;

        --l_id_plantilla_contrato:=5;
        
        SELECT COUNT(*) INTO STRICT l_contar  from enoc.QUIZ_PLANTILLA where ID_PLANTILLA=l_id_plantilla and coalesce(length(PLANTILLA),0)>0;

        IF l_contar=0 THEN
            l_error:=1;
            l_msgerror:='No esta configurado plantilla';
--             goto salida_gen;
        END IF;

        select PLANTILLA,coalesce(length(PLANTILLA),0) INTO STRICT l_plantilla,l_longitud from enoc.QUIZ_PLANTILLA where ID_PLANTILLA=l_id_plantilla and coalesce(length(PLANTILLA),0)>0;

        
        l_sql:='from ENOC.QUIZ_CUESTIONARIO_ASIG a 
              inner join enoc.vw_persona_natural pn on pn.id_persona=a.id_persona
              inner join moises.tipo_documento td on td.ID_TIPODOCUMENTO=pn.ID_TIPODOCUMENTO
              left join moises.persona_direccion di on di.id_persona=pn.id_persona and di.ID_TIPODIRECCION=4 and coalesce(di.es_activo,0)=1
              left join moises.trabajador t on t.id_trabajador=a.id_trabajador
              left join enoc.vw_perfil_puesto pp on pp.id_perfil_puesto=t.id_perfil_puesto
              left join enoc.VW_ENT_DEP_AREA_CCOSTO ed on ed.id_sedearea=t.id_sedearea
              where a.ID_CUESTIONARIO_ASIG=:P_ID_CUESTIONARIO_ASIG';

        
        FOR cur in curpara LOOP
        BEGIN
          if cur.tipo='F' then
            if cur.parametro='FEC_ACTUAL' then
              l_parametro:=to_char(clock_timestamp(),'DD/MM/YYYY');
            else
              EXECUTE 'SELECT '||cur.campo||' '||l_sql into STRICT l_parametro USING  P_ID_CUESTIONARIO_ASIG;
            end if;

          else
          
            EXECUTE 'BEGIN enoc.PKG_setup.'||cur.proceso||'(:P_ID_CUESTIONARIO_ASIG,:P_PARAMETRO,:P_PATH_IMG,:l_parametro,:l_error,:l_msgerror); end;'
            USING P_ID_CUESTIONARIO_ASIG,cur.parametro,P_PATH_IMG,IN OUT l_parametro,IN OUT l_error,IN OUT l_msgerror;

            
          end if;

          if coalesce(l_parametro::text, '') = '' then
            l_parametro:='{'||cur.parametro||'}';
          end if;
          l_plantilla:=replace(l_plantilla,'['||cur.parametro||']',l_parametro);
        END;
        END LOOP;

        IF l_error=0 THEN
          UPDATE enoc.QUIZ_CUESTIONARIO_ASIG SET
          PLANTILLA = l_plantilla
          WHERE ID_CUESTIONARIO_ASIG=P_ID_CUESTIONARIO_ASIG;
        END IF;

--         <<salida_gen>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_setup_sp_quiz_generar_plantilla (P_ID_CUESTIONARIO_ASIG bigint,P_PATH_IMG text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
