-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_setup,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_setup_sp_ptlla_encuesta (P_ID_CUESTIONARIO_ASIG bigint,P_PARAMETRO text,P_PATH_IMG text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_contar bigint;
      l_error bigint:=0;
      l_msgerror varchar(200):='';
      l_parametro text:='';
      l_id_cuestionario bigint;
      l_id_pregunta bigint;
      l_j bigint:=1;


      curPre CURSOR FOR
      SELECT 
       a.id_pregunta,
       a.id_cuestionario,
       a.nombre,
       a.id_tipo_pregunta,
       a.orientacion,
       a.id_tipo_grafico,
       coalesce(a.tipo_multi,1) as tipo_multi,
       a.orden,
       b.codigo
      from enoc.QUIZ_PREGUNTA a, enoc.QUIZ_TIPO_PREGUNTA b
      where a.id_tipo_pregunta=b.id_tipo_pregunta
      and a.id_cuestionario=l_id_cuestionario
      and a.id_pregunta in (
        SELECT x.id_pregunta from enoc.QUIZ_ALTERNATIVA x,enoc.QUIZ_CUESTIONARIO_RPTA y
        where x.id_alternativa=y.id_alternativa
        and y.ID_CUESTIONARIO_ASIG=P_ID_CUESTIONARIO_ASIG
      ) 
      order by a.orden;

      curAlt CURSOR FOR
      SELECT 
      a.id_alternativa,
      a.id_pregunta,
      a.nombre,
      a.respuesta,
      a.indicacion,
      a.tipo_texto,
      a.orden,
      b.rpta_texto,
      b.rpta_num,
      case when (b.id_alternativa IS NOT NULL AND b.id_alternativa::text <> '') then 1 else 0 end as asignado
      from enoc.QUIZ_ALTERNATIVA a left join enoc.QUIZ_CUESTIONARIO_RPTA b
      on a.id_alternativa=b.id_alternativa and b.ID_CUESTIONARIO_ASIG=P_ID_CUESTIONARIO_ASIG and a.vigencia=1
      where a.id_pregunta=l_id_pregunta
      order by a.orden;

    
BEGIN
      select id_cuestionario into STRICT l_id_cuestionario from enoc.QUIZ_CUESTIONARIO_ASIG where ID_CUESTIONARIO_ASIG=P_ID_CUESTIONARIO_ASIG;

      l_parametro:='<table class="table table-sm">
            <tr>
              <th style="width: 10px ;">#</th>
              <th>Pregunta</th>
              <th style="width: 300px ;">Respuesta</th>
            </tr>';
      FOR pr in curPre LOOP
        BEGIN
          l_id_pregunta:=pr.id_pregunta;
          l_parametro:=l_parametro||'<tr  style="font-size: 12px;">';
            l_parametro:=l_parametro||'<td>'||l_j::text||'</td>';
            l_parametro:=l_parametro||'<td><b>'||pr.nombre||'</b>';
            if pr.codigo = 'MU' and pr.tipo_multi <> 1 then
              l_parametro:=l_parametro||'&nbsp;&nbsp;(MÃ­nimo '||pr.tipo_multi::text||' opciones)';
            end if;
            l_parametro:=l_parametro||'</td>';
            l_parametro:=l_parametro||'<td>';
              if pr.orientacion = 'H' then
                FOR al in curAlt LOOP
                  BEGIN
                    if pr.codigo='UN' or pr.codigo='SN' then
                      if al.asignado=1 then
                        l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/radio.png"/> '||al.nombre||'&nbsp;&nbsp;';
                      else
                        l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/nradio.png"/> '||al.nombre||'&nbsp;&nbsp;';
                      end if;
                    end if;
                    if pr.codigo='MU' then
                      if al.asignado=1 then
                        l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/check.png"/> '||al.nombre||'&nbsp;&nbsp;';
                      else
                        l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/ncheck.png"/> '||al.nombre||'&nbsp;&nbsp;';
                      end if;
                    end if;
                  END;
                END LOOP;
              end if;
            l_parametro:=l_parametro||'</td>';
          l_parametro:=l_parametro||'</tr>';

          if pr.orientacion = 'V' then 
            FOR al in curAlt LOOP
              BEGIN
                l_parametro:=l_parametro||'<tr  style="font-size: 12px;">';
                  l_parametro:=l_parametro||'<td></td>';
                  if pr.codigo = 'LI' then
                    l_parametro:=l_parametro||'<td colspan="2">';
                     if al.tipo_texto='N' then
                        l_parametro:=l_parametro||al.rpta_num::text;
                     else
                        l_parametro:=l_parametro||al.rpta_texto;
                     end if;
                  else
                    l_parametro:=l_parametro||'<td>';
                  end if;
                  if pr.codigo = 'UN' or pr.codigo = 'SN' then
                    if al.asignado=1 then
                      l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/radio.png"/> '||al.nombre;
                    else
                      l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/nradio.png"/> '||al.nombre;
                    end if;
                  end if;
                  if pr.codigo = 'MU' then
                    if al.asignado=1 then
                      l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/check.png"/> '||al.nombre;
                    else
                      l_parametro:=l_parametro||'<img src="'||P_PATH_IMG||'/icon/ncheck.png"/> '||al.nombre;
                    end if;
                  end if;
                  if al.asignado = 1 and pr.codigo <>'LI' and al.respuesta=1 then
                    l_parametro:=l_parametro||'&nbsp;&nbsp;('||al.indicacion||')';
                  end if;
                  l_parametro:=l_parametro||'</td>';
                   if pr.codigo <> 'LI' then
                    l_parametro:=l_parametro||'<td>';
                      if al.asignado = 1 then
                        if al.tipo_texto='N' then
                          l_parametro:=l_parametro||al.rpta_num::text;
                        else
                          l_parametro:=l_parametro||al.rpta_texto;
                        end if;

                      end if;
                    l_parametro:=l_parametro||'</td>';
                  end if;
                l_parametro:=l_parametro||'</tr>';
              END;
            END LOOP;
          end if;
          l_j:=l_j+1;
        END;
      END LOOP;
      l_parametro:=l_parametro||'</table>';

      P_PARAMETRO_RET:= l_parametro;
      P_ERROR:=l_error;
      P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_setup_sp_ptlla_encuesta (P_ID_CUESTIONARIO_ASIG bigint,P_PARAMETRO text,P_PATH_IMG text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
