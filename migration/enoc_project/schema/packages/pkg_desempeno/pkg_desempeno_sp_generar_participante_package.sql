-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_desempeno,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_desempeno_sp_generar_participante (P_ID_DESEMPENO bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_participante bigint;
        l_fecha_inicio timestamp(0);

      
BEGIN
        
        select FECHA_INICIO into STRICT l_fecha_inicio from enoc.DES_DESEMPENO where ID_DESEMPENO=P_ID_DESEMPENO;
        select coalesce(max(id_participante),0)  into STRICT l_id_participante from enoc.des_participante;

        insert into ENOC.DES_PARTICIPANTE(
          ID_PARTICIPANTE,
          ID_DESEMPENO,
          ID_TRABAJADOR,
          ID_SEDEAREA,
          ID_PERFIL_PUESTO,
          ID_CONDICION_LABORAL,
          ID_TIPO_TIEMPO_TRABAJO,
          ID_ESCALA,
          PUNTAJE,
          CERRADO,
          ID_USER_REG,
          FECHA_REG
        )
        SELECT (row_number() OVER ( ORDER BY x.ID_TRABAJADOR ASC )) + l_id_participante as ID_PARTICIPANTE,
        P_ID_DESEMPENO as ID_DESEMPENO,
        x.ID_TRABAJADOR,
        x.ID_SEDEAREA,
        x.ID_PERFIL_PUESTO,
        x.ID_CONDICION_LABORAL,
        x.ID_TIPO_TIEMPO_TRABAJO,
        null ID_ESCALA,
        0 as PUNTAJE,
        0 as CERRADO,
        P_ID_USER_REG,
        clock_timestamp()
        from (
          
          SELECT 
          ID_TRABAJADOR,
          ID_SEDEAREA,
          ID_PERFIL_PUESTO,
          ID_CONDICION_LABORAL,
          ID_TIPO_TIEMPO_TRABAJO
          from moises.trabajador 
          where ID_TRABAJADOR= P_ID_TRABAJADOR 
          and ID_TRABAJADOR not in (
            select ID_TRABAJADOR from enoc.DES_PARTICIPANTE
            where ID_DESEMPENO=P_ID_DESEMPENO
          ) 
          
        )x;

--         <<salida>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_desempeno_sp_generar_participante (P_ID_DESEMPENO bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) FROM PUBLIC;
