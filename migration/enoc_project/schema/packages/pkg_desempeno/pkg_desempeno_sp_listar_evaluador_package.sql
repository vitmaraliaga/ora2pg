-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_desempeno,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_desempeno_sp_listar_evaluador (P_ID_PARTICIPANTE bigint, P_ID_TIPO_EVALUADOR bigint, P_TIPO text,OUT CURSOR REFCURSOR ) AS $body$
DECLARE


        l_query varchar(4000):='';
        l_id_perfil_puesto bigint;
        l_id_desempeno bigint;
        l_id_puesto bigint;
        l_nivel bigint;
        l_id_tipo_jefe bigint;
        l_id_sedearea bigint;

BEGIN
        
        select id_perfil_puesto,id_desempeno,id_sedearea into STRICT l_id_perfil_puesto,l_id_desempeno,l_id_sedearea from enoc.des_participante  where id_participante=P_ID_PARTICIPANTE;
        select id_puesto, nivel,id_tipo_jefe into STRICT l_id_puesto,l_nivel,l_id_tipo_jefe  from enoc.plla_perfil_puesto where id_perfil_puesto=l_id_perfil_puesto;

        delete from enoc.TT_LISTAR_EVALUADOR;

        l_query:='insert into  enoc.tt_listar_evaluador ';
        l_query:=l_query||'select p.id_participante, p.id_trabajador, p.id_perfil_puesto, p.id_sedearea ';
        l_query:=l_query||'from enoc.des_participante p, enoc.plla_perfil_puesto pp where p.id_perfil_puesto=pp.id_perfil_puesto ';
        l_query:=l_query||'and p.id_desempeno=:p1  ';
        l_query:=l_query||'and p.id_participante<>'||P_ID_PARTICIPANTE::text||' ';
        if l_nivel=1 then
          l_query:=l_query||'and p.id_sedearea='||l_id_sedearea::text||' ';
        end if;
        if P_TIPO='T' then
          l_query:=l_query||'and pp.id_tipo_jefe='||l_id_tipo_jefe::text||' ';
        else
          l_query:=l_query||'and pp.id_puesto='||l_id_puesto::text||' ';
        end if;
        l_query:=l_query||'and p.id_participante not in( select id_evaluador from enoc.DES_PARTICIPANTE_EVALUADOR  where id_participante='||P_ID_PARTICIPANTE::text||' and ID_TIPO_EVALUADOR='||P_ID_TIPO_EVALUADOR::text||') ';

        l_query:=l_query||'and p.id_perfil_puesto in(';
          l_query:=l_query||'select a.id_perfil_puesto ';
          l_query:=l_query||'from enoc.des_participante a, enoc.plla_perfil_puesto b ';
          l_query:=l_query||' where a.id_perfil_puesto=b.id_perfil_puesto ';
          l_query:=l_query||'and a.id_desempeno='||l_id_desempeno::text||' ';
          if l_nivel=1 then
            l_query:=l_query||'and a.id_sedearea='||l_id_sedearea::text||' ';
          end if;
          if P_TIPO='T' then
            l_query:=l_query||'and b.id_tipo_jefe='||l_id_tipo_jefe::text||' ';
          else
            l_query:=l_query||'and b.id_puesto='||l_id_puesto::text||' ';
          end if;
        l_query:=l_query||')';


        
        EXECUTE l_query USING l_id_desempeno;

              
        
        OPEN CURSOR FOR 
        SELECT 
        p.id_participante,
        p.id_trabajador,
        p.id_perfil_puesto,
        p.id_sedearea,
        t.apellidonombre,
        pp.puesto,
        sa.depto_padre,
        sa.area,
        tj.nombre as tipojefe
        from enoc.tt_listar_evaluador p, enoc.vw_trabajador t, enoc.vw_perfil_puesto pp, enoc.VW_ENT_DEP_AREA_CCOSTO sa, enoc.plla_tipo_jefe tj
        where p.id_trabajador=t.id_trabajador
        and p.id_perfil_puesto=pp.id_perfil_puesto
        and p.id_sedearea=sa.id_sedearea
        and pp.id_tipo_jefe=tj.id_tipo_jefe
        order by t.apellidonombre;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_desempeno_sp_listar_evaluador (P_ID_PARTICIPANTE bigint, P_ID_TIPO_EVALUADOR bigint, P_TIPO text,OUT CURSOR REFCURSOR ) FROM PUBLIC;
