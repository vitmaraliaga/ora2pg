-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_gen_periodo_vac_trab_adel (P_ID_TRABAJADOR bigint, P_ID_PERIODO_VAC bigint,P_ITEM bigint,P_ID_PERIODO_VAC_TRAB OUT text, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_fecha_inicio timestamp(0);
        l_fecha_fin_previsto timestamp(0);
        l_inicio timestamp(0);
        l_fin timestamp(0);
        l_anho_inicio bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_contar bigint:=0;
        l_contar1 bigint:=0;
        l_dias bigint:=0;
        l_id_periodo_vac_trab varchar(25):='';
          l_dias_anho bigint:=0;
        l_meses_cal  decimal(10,2):=0;
       	l_id_tipo_tiempo_trabajo bigint:=0;

BEGIN
          select fecha_inicio, fecha_fin_previsto,id_tipo_tiempo_trabajo into STRICT l_fecha_inicio,l_fecha_fin_previsto,l_id_tipo_tiempo_trabajo from moises.trabajador  where id_trabajador=P_ID_TRABAJADOR;

          select ANHO_INICIO into STRICT l_anho_inicio from plla_periodo_vac  where ID_PERIODO_VAC=P_ID_PERIODO_VAC;

          select count(*) into STRICT l_contar from PLLA_PERIODO_VAC_TRAB where ID_PERIODO_VAC=P_ID_PERIODO_VAC and ID_TRABAJADOR=P_ID_TRABAJADOR;

           select count(*) into STRICT l_contar1 from PLLA_PERIODO_VAC_TRAB where ID_PERIODO_VAC>P_ID_PERIODO_VAC and ID_TRABAJADOR=P_ID_TRABAJADOR;

          if l_contar=0 and l_contar1=0 then   
            if coalesce(l_fecha_fin_previsto::text, '') = '' then
              
              l_inicio := to_date(to_char(l_fecha_inicio,'DD-MM')||'-'||l_anho_inicio::text,'dd/mm/yyyy');
              select (l_inicio + interval '1' year)-1 into STRICT l_fin;--l_fin    := to_date(to_char(add_months(l_inicio,12)-1 ,'DD-MM')||'-'||to_char(l_anho_inicio+1),'dd/mm/yyyy');
            else
              
              if (to_char(l_fecha_inicio,'YYYY'))::numeric >l_anho_inicio then
                 l_msgerror:='No corresponde';
--                  GOTO salida_vactrab_ade;
              end if;

              if (to_char(l_fecha_fin_previsto,'YYYY'))::numeric <l_anho_inicio then
                 l_msgerror:='No corresponde';
--                  GOTO salida_vactrab_ade;
              end if;

              --select to_date(l_fecha_fin_previsto, 'dd/mm/yyyy') -  to_date(l_fecha_inicio, 'dd/mm/yyyy') into l_dias from dual;
              select l_fecha_fin_previsto - l_fecha_inicio into STRICT l_dias;

              
              l_inicio := to_date(to_char(l_fecha_inicio,'DD-MM')||'-'||l_anho_inicio::text,'dd/mm/yyyy');
              select (l_inicio + interval '1' year)-1 into STRICT l_fin;--l_fin    := to_date(to_char(add_months(l_inicio,12)-1 ,'DD-MM')||'-'||to_char(l_anho_inicio+1),'dd/mm/yyyy');
            end if;
          else
            if l_contar1>0 then
              l_error:=1;
              l_msgerror:='No se puede registrar al periodo anterior';
--               GOTO salida_vactrab_ade;
            end if;
            if l_contar>0 then
              l_error:=0;
              select ID_PERIODO_VAC_TRAB into STRICT l_id_periodo_vac_trab from PLLA_PERIODO_VAC_TRAB where ID_PERIODO_VAC=P_ID_PERIODO_VAC and ID_TRABAJADOR=P_ID_TRABAJADOR;
--               GOTO salida_vactrab_ade;
            end if;

          end if;

          if l_error =0 then
          
           
            select (l_fin - l_inicio)+1 into STRICT l_dias_anho;

            SELECT l_dias_anho/30 INTO STRICT l_meses_cal;


            SELECT floor((l_meses_cal*30)/12) into STRICT l_dias_anho;

           	if l_dias_anho>30 then
              l_dias_anho:=30;
            end if;

           	--Verificamos la jornada laboral del trabajador es tiempo parcial -->por Ulices julca -->2025
            SELECT COUNT(*) INTO STRICT l_contar FROM MOISES.TIPO_TIEMPO_TRABAJO
            WHERE CODIGO = 'TP' AND ID_TIPO_TIEMPO_TRABAJO = l_id_tipo_tiempo_trabajo;
           	
           	IF l_contar > 0 THEN
           		l_dias_anho:=6;--Si labor√≥ 12 meses le corresponde 6 dias de vacaciones
           	END IF;

            select to_char(clock_timestamp(),'YYYYMMDDhh24miss')||P_ITEM::text into STRICT l_id_periodo_vac_trab;
            insert into PLLA_PERIODO_VAC_TRAB(
              ID_PERIODO_VAC_TRAB,
              ID_PERIODO_VAC,
              ID_TRABAJADOR,
              PERIODO_INI,
              PERIODO_FIN,
              TOTAL_DIAS,
              TOTAL_DIAS_EFECT,
              ID_ESTADO_VAC_TRAB,
              DIAS_ANHO
            )values (
              l_id_periodo_vac_trab,
              P_ID_PERIODO_VAC,
              P_ID_TRABAJADOR,
              l_inicio,
              l_fin,
              0,
              0,
              '01',
              l_dias_anho
            );
          end if;
--           <<salida_vactrab_ade>>
          P_ID_PERIODO_VAC_TRAB:=l_id_periodo_vac_trab;
          P_ERROR:=l_error;
          P_MSGERROR:= l_msgerror;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_gen_periodo_vac_trab_adel (P_ID_TRABAJADOR bigint, P_ID_PERIODO_VAC bigint,P_ITEM bigint,P_ID_PERIODO_VAC_TRAB OUT text, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
