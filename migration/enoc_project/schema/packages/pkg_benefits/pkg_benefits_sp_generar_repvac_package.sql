-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_generar_repvac (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_PERIODO_VAC bigint,P_ID_AREA text,P_DATO text,P_ESTADO text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';

        l_query varchar(4000):='';
        l_fecha_ini timestamp(0);
        l_fecha_fin timestamp(0);
        l_fecha_ini_eje timestamp(0);
        curtrab CURSOR FOR
        SELECT
          PERSONA,
          ID_TRABAJADOR,
          ID_PERSONA,
          PERIODO_INI,
          PERIODO_FIN,
          AREA,
          PUESTO
        from TT_REP_VACACION
        order by ID_TRABAJADOR;

        l_vac varchar(2):='N';

      
BEGIN
          delete from TT_REP_VACACION;
          DELETE FROM PLLA_REP_VACACION WHERE ID_USER=P_ID_USER;

           l_query:='INSERT INTO TT_REP_VACACION ';
           l_query:=l_query|| 'select ';
           l_query:=l_query|| 'a.paterno ||'' ''|| a.materno ||'' ''|| a.nombre as persona, ';
           l_query:=l_query|| 'b.id_trabajador,a.id_persona, ';
           l_query:=l_query|| 'min(b.periodo_ini) as periodo_ini, ';
           l_query:=l_query|| 'max(b.periodo_fin) as periodo_fin, ';
           l_query:=l_query|| 'd.nombre as area, ';
           l_query:=l_query|| 'p.nombre as puesto ';
           l_query:=l_query|| 'from vw_trabajador a, ';
           l_query:=l_query|| 'plla_periodo_vac_trab b, ';
           l_query:=l_query|| 'eliseo.org_sede_area c, ';
           l_query:=l_query|| 'eliseo.org_area d, ';
           l_query:=l_query|| 'plla_puesto p ';
           l_query:=l_query|| 'where a.id_trabajador=b.id_trabajador ';
           l_query:=l_query|| 'and a.id_sedearea=c.id_sedearea ';
           l_query:=l_query|| 'and c.id_area=d.id_area ';
           l_query:=l_query|| 'and a.id_puesto=p.id_puesto ';
           l_query:=l_query|| 'and c.id_entidad=:S_ID_ENTIDAD ';
           --l_query:=l_query|| 'and c.id_depto like '''||P_ID_DEPTO||'%'' ';
           l_query:=l_query|| 'and 1 = case when '''||P_ID_DEPTO||'''=''0'' then 1 else case when c.id_depto like '''||P_ID_DEPTO||'%'' then 1 else 0 end end ';
           if (P_ESTADO IS NOT NULL AND P_ESTADO::text <> '') then
             l_query:=l_query|| 'and b.ID_ESTADO_VAC_TRAB = '''||P_ESTADO||''' ';
           end if;
           l_query:=l_query|| 'and b.ID_PERIODO_VAC_TRAB in( ';
             l_query:=l_query|| 'select x.ID_PERIODO_VAC_TRAB from PLLA_ROL_VACACIONAL x ';
             l_query:=l_query|| 'where x.condicion=''P'' ';
             l_query:=l_query|| 'and (to_number(to_char(x.FECHA_INI,''YYYY''))='||P_ID_PERIODO_VAC::text||' or to_number(to_char(x.FECHA_fin,''YYYY''))='||P_ID_PERIODO_VAC::text||')';
           l_query:=l_query|| ') ';

           IF (P_ID_AREA IS NOT NULL AND P_ID_AREA::text <> '') and P_ID_AREA <> '0' THEN
            l_query:=l_query|| 'and c.id_area in ('||P_ID_AREA||')';
           END IF;
           IF (P_DATO IS NOT NULL AND P_DATO::text <> '') THEN
             l_query:=l_query|| ' and (upper(a.nombre) like upper(''%'||P_DATO||'%'') ';
             l_query:=l_query|| 'or upper(a.nombre ||'' ''|| a.paterno ) like upper(''%'||P_DATO||'%'') ';
             l_query:=l_query|| 'or upper(a.paterno ||'' ''|| a.materno ) like upper(''%'||P_DATO||'%'') ';
             l_query:=l_query|| 'or upper(a.nombre ||'' ''|| a.paterno ||'' ''|| a.materno ) like upper(''%'||P_DATO||'%'') ';
             l_query:=l_query|| 'or a.num_documento like ''%'||P_DATO||'%'') ';
           END IF;

           l_query:=l_query|| ' group by a.paterno,a.materno,a.nombre, b.id_trabajador,a.id_persona, d.nombre,p.nombre';

           --dbms_output.put_line(l_query);
               
          EXECUTE l_query USING P_ID_ENTIDAD;--, P_ID_DEPTO;
          SELECT COUNT(*) INTO STRICT l_contar FROM TT_REP_VACACION;

          if l_contar>0 then
          
           -- select min(PERIODO_INI) , max(PERIODO_FIN) into l_fecha_ini,l_fecha_fin from TT_REP_VACACION;
            
            select to_date('01-01-'||P_ID_PERIODO_VAC::text,'dd/mm/yyyy') , to_date('31-12-'||P_ID_PERIODO_VAC::text,'dd/mm/yyyy') 
            into STRICT l_fecha_ini,l_fecha_fin 
;

            /*l_fecha_ini_eje:=l_fecha_ini;
            WHILE l_fecha_ini<=l_fecha_fin LOOP
              INSERT INTO TT_REP_FECHA_VAC(FECHA)VALUES(l_fecha_ini);
              l_fecha_ini:= l_fecha_ini + 1;
            END LOOP;
            */
            
            --l_msgerror:='01-01-'||to_char(P_ID_PERIODO_VAC)||' - '||'31-12-'||to_char(P_ID_PERIODO_VAC)||'vvvv';
            
            FOR cur in curtrab LOOP
              BEGIN
                l_fecha_ini_eje:=l_fecha_ini;

                WHILE l_fecha_ini_eje<=l_fecha_fin LOOP
                
                  /*if l_fecha_ini_eje<cur.PERIODO_INI or l_fecha_ini_eje>cur.PERIODO_FIN then
                    l_vac:='N';
                  else*/
                    select case when  count(*)>0 then '1' else '0' end 
                    into STRICT l_vac
                    from PLLA_ROL_VACACIONAL a, plla_periodo_vac_trab b 
                    where a.ID_PERIODO_VAC_TRAB =b.ID_PERIODO_VAC_TRAB
                    and b.id_trabajador=cur.id_trabajador
                    and a.CONDICION='P'
                    and (l_fecha_ini_eje between FECHA_INI and FECHA_FIN);
                  --end if;
                  insert into PLLA_REP_VACACION(
                    ID_TRABAJADOR,
                    ID_PERSONA,
                    NOMBRE_PERSONA,
                    AREA,
                    PUESTO,
                    ANHO,
                    MES,
                    DIA,
                    VACACION,
                    ID_USER,
                    PERIODO,
                    NOM_DIAS,
                    FECHA
                  )values (
                    cur.id_trabajador,
                    cur.id_persona,
                    cur.persona,
                    cur.area,
                    cur.puesto,
                    (to_char(l_fecha_ini_eje,'YYYY'))::numeric ,
                    (to_char(l_fecha_ini_eje,'MM'))::numeric ,
                    (to_char(l_fecha_ini_eje,'DD'))::numeric ,
                    l_vac,
                    P_ID_USER,
                    to_char(cur.PERIODO_INI,'DD/MM/YYYY')||'-'|| to_char(cur.PERIODO_FIN,'DD/MM/YYYY'),
                    substr(to_char(l_fecha_ini_eje, 'DAY', 'NLS_DATE_LANGUAGE=SPANISH'),1,2),
                    l_fecha_ini_eje
                  );

                  l_fecha_ini_eje:= l_fecha_ini_eje + 1;
                END LOOP;
              end;
            END LOOP;
          end if;

    
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_generar_repvac (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_PERIODO_VAC bigint,P_ID_AREA text,P_DATO text,P_ESTADO text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
