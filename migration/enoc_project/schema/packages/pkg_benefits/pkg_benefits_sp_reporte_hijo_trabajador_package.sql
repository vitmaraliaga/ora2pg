-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_reporte_hijo_trabajador ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONDICION_LABORAL text, P_ID_TIEMPO_TRABAJO bigint, P_ID_SITUACION_TRABAJADOR text, P_ID_AREA bigint, P_ID_AREAS text, P_SEXO bigint, P_EDAD_DESDE bigint, P_EDAD_HASTA bigint, P_DESDE timestamp(0), P_HASTA timestamp(0), P_DATO text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_USER bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE


        l_query varchar(4000):='';
        l_id_tipo_nivel_vista bigint;
        l_contar bigint:=0;
        l_id_conyuge bigint:=0;
        l_sustentoc varchar(150);

        curP CURSOR FOR
        SELECT  
        ID_PERSONA,
        ID_TRABAJADOR,
        SEXO
        FROM ENOC.TT_PADRES 
        ORDER BY SEXO;

BEGIN
      
      if P_RESTRINGIDO='S' then
          select id_tipo_nivel_vista into STRICT l_id_tipo_nivel_vista from eliseo.lamb_acceso_nivel where id_acceso_nivel=P_ID_ACCESO_NIVEL;
      end if;

  --l_query:='(upper(convert(t.nombre||'' ''||t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.num_documento, ''us7ascii'')) like ''%''||replace(replace(upper(convert('''||P_DATO||''' , ''us7ascii'')),'','','' ''),'' '',''%'')||''%'')';
   --DBMS_OUTPUT.PUT_LINE(l_query);   
      l_query:='INSERT INTO ENOC.TT_PADRES(ID_PERSONA,SEXO,ID_TRABAJADOR) ';
      l_query:=l_query||'select a.id_persona,a.sexo, a.id_trabajador from ENOC.VW_TRABAJADOR a , ENOC.VW_ENT_DEP_AREA_CCOSTO AR ';
      l_query:=l_query||'where A.ID_SEDEAREA=AR.ID_SEDEAREA ';
      l_query:=l_query||'AND a.id_entidad='||P_ID_ENTIDAD::text||' ';
      l_query:=l_query||'AND AR.ID_DEPTO_PADRE='''||P_ID_DEPTO||''' ';
      if P_ID_AREA>0 then
        l_query:=l_query||'AND AR.ID_AREA='||P_ID_AREA::text||' ';
      END IF;
      if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
         l_query:=l_query||'AND  A.ID_CONDICION_LABORAL='''||P_ID_CONDICION_LABORAL||''' ';
      END IF;
       if P_ID_TIEMPO_TRABAJO>0 then
        l_query:=l_query||'AND A.ID_TIPO_TIEMPO_TRABAJO='||P_ID_TIEMPO_TRABAJO::text||' ';
      END IF;
      if (P_ID_SITUACION_TRABAJADOR IS NOT NULL AND P_ID_SITUACION_TRABAJADOR::text <> '') then
         l_query:=l_query||'AND  A.id_situacion_trabajador='''||P_ID_SITUACION_TRABAJADOR||''' ';
      END IF;
      if (P_DATO IS NOT NULL AND P_DATO::text <> '') then
       --l_query:=l_query||' (upper(convert(a.nombreapellido||'' ''||a.apellidonombre||'' ''||a.num_documento, ''us7ascii'')) like ''%''||replace(replace(upper(convert('''||P_DATO||''' , ''us7ascii'')),'','','' ''),'' '',''%'')||''%'') ';
       l_query:=l_query||' and (upper(convert(a.nombre||'' ''||a.paterno||'' ''||a.materno||a.nombre||'' ''||a.paterno||'' ''||a.materno||a.nombre||'' ''||a.paterno||'' ''||a.materno||a.num_documento, ''us7ascii'')) like ''%''||replace(replace(upper(convert('''||P_DATO||''' , ''us7ascii'')),'','','' ''),'' '',''%'')||''%'') ';
      END IF;
      if P_RESTRINGIDO='S' then
            
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and AR.ID_DEPTO_PADRE in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||')';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and AR.id_area in('||P_ID_AREAS||')';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and a.id_trabajador='||P_ID_USER::text||' ';
          end if;
      end if;

      if P_RESTRINGIDO='U' then
        l_query:=l_query||'and a.id_trabajador='||P_ID_USER::text||' ';
      end if;

      l_query:=l_query||'and a.id_persona  in( ';
        l_query:=l_query||'select x.id_persona from MOISES.VINCULO_FAMILIAR x , moises.persona_natural pn ';
        l_query:=l_query||'where x.id_registrado=pn.id_persona ';
        l_query:=l_query||'and x.ID_TIPO_VINCULO_FAMILIAR=''05''  ';
        if P_SEXO>0 then
          l_query:=l_query||'AND PN.SEXO='||P_SEXO::text||' ';
        END IF;
        l_query:=l_query||'and x.ID_TIPO_ESTADO_VINCULO in(''01'',''02'') ';
        l_query:=l_query||'and (floor(months_between ( SYSDATE ,pn.fec_nacimiento)/12) between '||P_EDAD_DESDE::text||' and '||P_EDAD_HASTA::text||') ';
      l_query:=l_query||')';

      l_query:=l_query||' union ';

      l_query:=l_query||'select a.id_persona,a.sexo, a.id_trabajador from ENOC.VW_TRABAJADOR a , ENOC.VW_ENT_DEP_AREA_CCOSTO AR ';
      l_query:=l_query||'where A.ID_SEDEAREA=AR.ID_SEDEAREA ';
      l_query:=l_query||'AND a.id_entidad='||P_ID_ENTIDAD::text||' ';
      l_query:=l_query||'AND AR.ID_DEPTO_PADRE='''||P_ID_DEPTO||''' ';
      if P_ID_AREA>0 then
        l_query:=l_query||'AND AR.ID_AREA='||P_ID_AREA::text||' ';
      END IF;
      if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
         l_query:=l_query||'AND  A.ID_CONDICION_LABORAL='''||P_ID_CONDICION_LABORAL||''' ';
      END IF;
       if P_ID_TIEMPO_TRABAJO>0 then
        l_query:=l_query||'AND A.ID_TIPO_TIEMPO_TRABAJO='||P_ID_TIEMPO_TRABAJO::text||' ';
      END IF;
      if (P_ID_SITUACION_TRABAJADOR IS NOT NULL AND P_ID_SITUACION_TRABAJADOR::text <> '') then
         l_query:=l_query||'AND  A.id_situacion_trabajador='''||P_ID_SITUACION_TRABAJADOR||''' ';
      END IF;
      if (P_DATO IS NOT NULL AND P_DATO::text <> '') then
       l_query:=l_query||' and (upper(convert(a.nombre||'' ''||a.paterno||'' ''||a.materno||a.nombre||'' ''||a.paterno||'' ''||a.materno||a.nombre||'' ''||a.paterno||'' ''||a.materno||a.num_documento, ''us7ascii'')) like ''%''||replace(replace(upper(convert('''||P_DATO||''' , ''us7ascii'')),'','','' ''),'' '',''%'')||''%'') ';
      END IF;
      if P_RESTRINGIDO='S' then
            
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and AR.ID_DEPTO_PADRE in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||')';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and AR.id_area in('||P_ID_AREAS||')';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and a.id_trabajador='||P_ID_USER::text||' ';
          end if;
      end if;

      if P_RESTRINGIDO='U' then
        l_query:=l_query||'and a.id_trabajador='||P_ID_USER::text||' ';
      end if;

      l_query:=l_query||'and a.id_persona  in( ';
        l_query:=l_query||'select x.id_persona from MOISES.VINCULO_FAMILIAR x , moises.persona_natural pn,MOISES.VINCULO_FAMILIAR_SUPERIOR z ';
        l_query:=l_query||'where x.id_registrado=pn.id_persona ';
        l_query:=l_query||'AND x.ID_VINCULO_FAMILIAR =z.ID_VINCULO_FAMILIAR ';
        l_query:=l_query||'and x.ID_TIPO_VINCULO_FAMILIAR=''06''  ';
        if P_SEXO>0 then
          l_query:=l_query||'AND PN.SEXO='||P_SEXO::text||' ';
        END IF;
        l_query:=l_query||'and x.ID_TIPO_ESTADO_VINCULO in(''01'',''02'') ';
        l_query:=l_query||'and z.ID_TIPO_ESTADO_VINCULO in(''01'',''02'') ';
        l_query:=l_query||'and (floor(months_between ( SYSDATE ,pn.fec_nacimiento)/12) between '||P_EDAD_DESDE::text||' and '||P_EDAD_HASTA::text||') ';
        if (P_DESDE IS NOT NULL AND P_DESDE::text <> '') then
          l_query:=l_query||'and (to_date('''||to_char(P_DESDE,'YYYY-MM-DD')||''',''YYYY-MM-DD'') BETWEEN z.desde AND z.hasta) ';
        end if;
        if (P_HASTA IS NOT NULL AND P_HASTA::text <> '') then
          l_query:=l_query||'and (to_date('''||to_char(P_HASTA,'YYYY-MM-DD')||''',''YYYY-MM-DD'') BETWEEN z.desde AND z.hasta) ';
        end if;
      l_query:=l_query||') ';
      l_query:=l_query||' order by SEXO ';

     EXECUTE l_query;

      
      FOR cur in curP LOOP
      BEGIN
        l_id_conyuge:=0;
        l_sustentoc:='';
        select count(1) into STRICT l_contar from ENOC.TT_PADRES_CONYUGE_HIJOS
        where ID_CONYUGE=cur.id_persona;
        if l_contar=0 then

          select count(1) into STRICT l_contar from MOISES.VINCULO_FAMILIAR x , moises.persona_natural pn
          where x.id_registrado=pn.id_persona
          and x.ID_TIPO_VINCULO_FAMILIAR='02' 
          and x.id_persona=cur.id_persona
          and x.ID_TIPO_ESTADO_VINCULO in ('01','02');

          if l_contar=1 then
            select x.id_registrado, x.DOC_SUST_VF_URL into STRICT l_id_conyuge,l_sustentoc from MOISES.VINCULO_FAMILIAR x , moises.persona_natural pn
            where x.id_registrado=pn.id_persona
            and x.ID_TIPO_VINCULO_FAMILIAR='02' 
            and x.id_persona=cur.id_persona
            and x.ID_TIPO_ESTADO_VINCULO in ('01','02');
          end if;

          
          l_query:='INSERT INTO ENOC.TT_PADRES_CONYUGE_HIJOS(ID_PADRE,ID_HIJO,ID_CONYUGE, DESDE,HASTA,SUSTENTO,SUSTENTOC,SUSTENTOH) ';
          l_query:=l_query||'select x.id_persona,x.id_registrado,'||l_id_conyuge||',NULL,NULL,NULL,'''||l_sustentoc||''',PN.DOCUMENTO_URL from MOISES.VINCULO_FAMILIAR x , moises.persona_natural pn ';
          l_query:=l_query||'where x.id_registrado=pn.id_persona ';
          l_query:=l_query||'and x.ID_TIPO_VINCULO_FAMILIAR=''05''  ';
          l_query:=l_query||'AND x.id_persona='||cur.id_persona||' ';
          l_query:=l_query||'AND x.id_VINCULO_FAMILIAR NOT IN(SELECT  F.id_VINCULO_FAMILIAR FROM MOISES.VINCULO_FAMILIAR_SUPERIOR F WHERE F.ID_TIPO_ESTADO_VINCULO in(''01'',''02'')) ';
          if P_SEXO>0 then
            l_query:=l_query||'AND PN.SEXO='||P_SEXO||' ';
          END IF;
          l_query:=l_query||'and x.ID_TIPO_ESTADO_VINCULO in(''01'',''02'') ';
          l_query:=l_query||'and (floor(months_between ( SYSDATE ,pn.fec_nacimiento)/12) between '||P_EDAD_DESDE||' and '||P_EDAD_HASTA||') ';
          l_query:=l_query||' union ';
          l_query:=l_query||'select x.id_persona,x.id_registrado,'||l_id_conyuge||',z.desde,z.hasta,z.HIJO_NIVEL_SUPERIOR_URL,'''||l_sustentoc||''',PN.DOCUMENTO_URL  from MOISES.VINCULO_FAMILIAR x , moises.persona_natural pn,MOISES.VINCULO_FAMILIAR_SUPERIOR z ';
          l_query:=l_query||'where x.id_registrado=pn.id_persona ';
          l_query:=l_query||'AND x.ID_VINCULO_FAMILIAR =z.ID_VINCULO_FAMILIAR ';
          l_query:=l_query||'and x.ID_TIPO_VINCULO_FAMILIAR=''05''  ';
          l_query:=l_query||'AND x.id_persona='||cur.id_persona||' ';
          if P_SEXO>0 then
            l_query:=l_query||'AND PN.SEXO='||P_SEXO||' ';
          END IF;
          l_query:=l_query||'and x.ID_TIPO_ESTADO_VINCULO in(''01'',''02'') ';
          l_query:=l_query||'and z.ID_TIPO_ESTADO_VINCULO in(''01'',''02'') ';
          l_query:=l_query||'and (floor(months_between ( SYSDATE ,pn.fec_nacimiento)/12) between '||P_EDAD_DESDE||' and '||P_EDAD_HASTA||') ';
          if (P_DESDE IS NOT NULL AND P_DESDE::text <> '') then
            l_query:=l_query||'and (to_date('''||to_char(P_DESDE,'YYYY-MM-DD')||''',''YYYY-MM-DD'') BETWEEN z.desde AND z.hasta) ';
          end if;
          if (P_HASTA IS NOT NULL AND P_HASTA::text <> '') then
            l_query:=l_query||'and (to_date('''||to_char(P_HASTA,'YYYY-MM-DD')||''',''YYYY-MM-DD'') BETWEEN z.desde AND z.hasta) ';
          end if;
           EXECUTE l_query;
            --DBMS_OUTPUT.PUT_LINE(l_query);
        end if;
      END;
      END LOOP;

      update ENOC.TT_PADRES_CONYUGE_HIJOS set ID_CONYUGE = NULL where ID_CONYUGE=0;

      OPEN CURSOR FOR 
      SELECT 
      A.ID_PADRE,
      T.ID_TRABAJADOR,
      T.APELLIDONOMBRE,
      TC.SIGLAS,
      T.NUM_DOCUMENTO,
      C.AREA,
      CL.NOMBRE AS CONDICION_LABORAL,
      TR.NOMBRE AS TIEMPO_TRABAJO,
      ST.NOMBRE AS SITUACION_TRABAJADOR,
      ST.NOMBRE_CORTO AS SITUACION_TRABAJADOR_CO,
      P.PUESTO,
      TO_CHAR(T.FECHA_INICIO,'DD/MM/YYYY') as FECHA_INICIO,
      TO_CHAR(T.FECHA_FIN_PREVISTO,'DD/MM/YYYY') as FECHA_FIN_PREVISTO,
      TO_CHAR(T.FECHA_FIN_EFECTIVO,'DD/MM/YYYY') as FECHA_FIN_EFECTIVO,
      A.ID_CONYUGE,
      TY.ID_TRABAJADOR AS ID_TRABAJADOR_Y,
      PNTY.APELLIDONOMBRE AS APELLIDONOMBRE_Y,
      TCY.SIGLAS AS SIGLAS_Y,
      PNTY.NUM_DOCUMENTO AS NUM_DOCUMENTO_Y,
      CY.AREA AS AREA_Y,
      CLY.NOMBRE AS CONDICION_LABORAL_Y,
      TRY.NOMBRE AS TIEMPO_TRABAJO_Y,
      STY.NOMBRE AS SITUACION_TRABAJADOR_Y,
      STY.NOMBRE_CORTO AS SITUACION_TRABAJADOR_CO_Y,
      PY.PUESTO AS PUESTO_Y,
      TO_CHAR(TY.FECHA_INICIO,'DD/MM/YYYY') as FECHA_INICIO_Y,
      TO_CHAR(TY.FECHA_FIN_PREVISTO,'DD/MM/YYYY') as FECHA_FIN_PREVISTO_Y,
      TO_CHAR(TY.FECHA_FIN_EFECTIVO,'DD/MM/YYYY') as FECHA_FIN_EFECTIVO_Y,
      
      A.ID_HIJO,
      TH.APELLIDONOMBRE AS APELLIDONOMBRE_H,
      TCH.SIGLAS AS SIGLAS_H,
      TH.NUM_DOCUMENTO AS NUM_DOCUMENTO_H,
      TO_CHAR(TH.fec_nacimiento,'DD/MM/YYYY') AS fec_nacimiento,
      floor(months_between( clock_timestamp() ,TH.fec_nacimiento)/12) AS ANHOS,
      TO_CHAR(A.DESDE,'DD/MM/YYYY') as DESDE,
      TO_CHAR(A.HASTA,'DD/MM/YYYY') as HASTA,
      A.SUSTENTO,
      A.SUSTENTOC,
      A.SUSTENTOH,
      t.celular,
      t.correo
      FROM ENOC.TT_PADRES_CONYUGE_HIJOS A
      INNER JOIN ENOC.VW_TRABAJADOR T ON T.ID_PERSONA =A.ID_PADRE AND T.ID_ENTIDAD=P_ID_ENTIDAD
      INNER JOIN MOISES.TIPO_DOCUMENTO TC ON TC.ID_TIPODOCUMENTO=T.ID_TIPODOCUMENTO
      INNER JOIN MOISES.CONDICION_LABORAL CL ON CL.ID_CONDICION_LABORAL=T.ID_CONDICION_LABORAL
      INNER JOIN ENOC.VW_ENT_DEP_AREA_CCOSTO C ON C.ID_SEDEAREA=T.ID_SEDEAREA
      INNER JOIN ENOC.VW_PERFIL_PUESTO P ON P.ID_PERFIL_PUESTO =T.ID_PERFIL_PUESTO
      INNER JOIN MOISES.TIPO_TIEMPO_TRABAJO TR ON TR.ID_TIPO_TIEMPO_TRABAJO =T.ID_TIPO_TIEMPO_TRABAJO
      INNER JOIN MOISES.SITUACION_TRABAJADOR ST ON ST.ID_SITUACION_TRABAJADOR =T.ID_SITUACION_TRABAJADOR
      LEFT JOIN ENOC.VW_PERSONA_NATURAL PNTY ON PNTY.ID_PERSONA =A.ID_CONYUGE 
      LEFT JOIN ENOC.VW_TRABAJADOR TY ON TY.ID_PERSONA =A.ID_CONYUGE AND TY.ID_ENTIDAD=P_ID_ENTIDAD
      LEFT JOIN MOISES.TIPO_DOCUMENTO TCY ON TCY.ID_TIPODOCUMENTO=PNTY.ID_TIPODOCUMENTO
      LEFT JOIN MOISES.CONDICION_LABORAL CLY ON CLY.ID_CONDICION_LABORAL=TY.ID_CONDICION_LABORAL
      LEFT JOIN ENOC.VW_ENT_DEP_AREA_CCOSTO CY ON CY.ID_SEDEAREA=TY.ID_SEDEAREA
      LEFT JOIN ENOC.VW_PERFIL_PUESTO PY ON PY.ID_PERFIL_PUESTO =TY.ID_PERFIL_PUESTO
      LEFT JOIN MOISES.TIPO_TIEMPO_TRABAJO TRY ON TRY.ID_TIPO_TIEMPO_TRABAJO =TY.ID_TIPO_TIEMPO_TRABAJO
      LEFT JOIN MOISES.SITUACION_TRABAJADOR STY ON STY.ID_SITUACION_TRABAJADOR =TY.ID_SITUACION_TRABAJADOR
      LEFT JOIN ENOC.VW_PERSONA_NATURAL TH ON TH.ID_PERSONA =A.ID_HIJO 
      LEFT JOIN MOISES.TIPO_DOCUMENTO TCH ON TCH.ID_TIPODOCUMENTO=TH.ID_TIPODOCUMENTO
      order by T.APELLIDONOMBRE;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_reporte_hijo_trabajador ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONDICION_LABORAL text, P_ID_TIEMPO_TRABAJO bigint, P_ID_SITUACION_TRABAJADOR text, P_ID_AREA bigint, P_ID_AREAS text, P_SEXO bigint, P_EDAD_DESDE bigint, P_EDAD_HASTA bigint, P_DESDE timestamp(0), P_HASTA timestamp(0), P_DATO text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_USER bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
