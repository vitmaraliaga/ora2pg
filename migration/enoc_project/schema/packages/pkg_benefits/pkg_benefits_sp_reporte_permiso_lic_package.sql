-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_reporte_permiso_lic ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_TIPO_PERM_LIC bigint, P_ID_CONCEPTO_PERM_LIC text, P_ID_TRABAJADOR bigint, P_TIPO text, P_ID_ANHO bigint, P_ID_MES bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREA text, P_ID_USER bigint, P_OPCION text,--A:antiguo: N: nuevo
 OUT CURSOR REFCURSOR ) AS $body$
DECLARE


          l_desdes timestamp(0);
          l_hasta timestamp(0);
          l_mes varchar(5);
          l_trab varchar(100):='';
          l_columna varchar(1500):='';
          l_query varchar(4000):='';
          l_where varchar(1500):='';
          l_id_tipo_nivel_vista bigint;

BEGIN
      
      IF P_TIPO='RA' THEN
        l_desdes:=P_FECHA_DESDE;
        l_hasta:=P_FECHA_HASTA;
      ELSE
        select to_date('01-'||P_ID_MES::text||'-'||P_ID_ANHO::text,'dd/mm/yyyy'),  date_trunc('day', ((date_trunc('month',(to_date('01-'||P_ID_MES::text||'-'||P_ID_ANHO::text,'dd/mm/yyyy'))::timestamp + interval '1 month'))::timestamp(0) - 1))
        into STRICT l_desdes,l_hasta
;

        if P_ID_MES <10 then
          l_mes:='0'||P_ID_MES::text;
        else
          l_mes:=P_ID_MES::text;
        end if;

      END IF;

        if P_RESTRINGIDO='S' then
          select id_tipo_nivel_vista into STRICT l_id_tipo_nivel_vista from eliseo.lamb_acceso_nivel where id_acceso_nivel=P_ID_ACCESO_NIVEL;
        end if;

      
        l_trab:='a.id_trabajador,';
        l_columna:='a.id_tipo_suspension,a.id_entidad,';
        l_columna:=l_columna|| 'a.id_depto,';
        l_columna:=l_columna|| 'a.id_licencia_permiso,';
        l_columna:=l_columna|| 'a.id_tipo_perm_lic,';
        l_columna:=l_columna|| 'a.id_concepto_perm_lic,';
        l_columna:=l_columna|| 'a.tipo_perm_lic,';
        l_columna:=l_columna|| 'a.nombre, ';
        l_columna:=l_columna|| 'a.codsunat,';
        l_columna:=l_columna|| 'a.periodo,';
        l_columna:=l_columna|| 'a.id_estado_lica_per,';
        l_columna:=l_columna|| 'a.fecha_desde,';
        l_columna:=l_columna|| 'a.fecha_hasta,';
        --l_columna:=l_columna|| 'CASE WHEN a.fecha_desde<:S_DESDE THEN :S_DESDE ELSE a.fecha_desde END,';
        --l_columna:=l_columna|| 'CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END,';
        l_columna:=l_columna|| 'CASE WHEN a.fecha_desde<:S_DESDE THEN :S_DESDE ELSE a.fecha_desde END,';
        l_columna:=l_columna|| 'CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END,';
        l_columna:=l_columna|| 'a.dias,';
        l_columna:=l_columna|| 'a.horas,';
        --l_columna:=l_columna|| 'CASE WHEN a.periodo=''H'' THEN 0 ELSE ';
        l_columna:=l_columna|| '((CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END) -  (CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END))+1, ';
        --l_columna:=l_columna|| 'END,';
        l_columna:=l_columna|| 'a.horas ';


        if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
          l_where:=l_where||'and a.id_depto='''||P_ID_DEPTO||''' ';
        end if;
        if P_ID_TIPO_PERM_LIC > 0 then
          l_where:=l_where||'and a.id_tipo_perm_lic='||P_ID_TIPO_PERM_LIC::text||' ';
        end if;
        if (P_ID_CONCEPTO_PERM_LIC IS NOT NULL AND P_ID_CONCEPTO_PERM_LIC::text <> '') then
          l_where:=l_where||'and a.id_concepto_perm_lic in('||P_ID_CONCEPTO_PERM_LIC::text||') ';
        end if;

       l_query:='insert into ENOC.TT_LICENCIA_PERMISO(';
       l_query:=l_query|| 'ID_TRABAJADOR,ID_TIPO_SUSPENSION,ID_ENTIDAD,ID_DEPTO,ID_LICENCIA_PERMISO,ID_TIPO_PERM_LIC,ID_CONCEPTO_PERM_LIC,TIPO_PERM_LIC,NOMBRE,CODSUNAT,PERIODO,ID_ESTADO_LICA_PER,FECHA_DESDE,FECHA_HASTA,FECHA_DESDE_PROC,FECHA_HASTA_PROC,DIAS,HORAS,DIAS_PROC,HORAS_PROC) ';
       l_query:=l_query|| 'select ';
       l_query:=l_query|| l_trab || l_columna;
       l_query:=l_query|| 'from ENOC.VW_LICENCIA_PERMISO_REP a, moises.trabajador t, eliseo.vw_sede_area sa ';
       l_query:=l_query|| 'where a.id_trabajador=t.id_trabajador ';
       l_query:=l_query|| 'and t.id_sedearea=sa.id_sedearea ';
       l_query:=l_query|| 'and a.id_entidad=:S_ID_ENTIDAD ';
       l_query:=l_query|| 'and a.engrupo=''N'' ';
       l_query:=l_query|| 'and a.id_estado_lica_per not in(''00'',''04'') ';
       if P_ID_TRABAJADOR > 0 then
          l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';
       end if;
       l_query:=l_query|| l_where;
       --IF P_TIPO='RA' THEN
        --l_query:=l_query||'and ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) ';
        --l_query:=l_query||'and ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ';
        l_query:=l_query||'and ( ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) or ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ) ';
       /*ELSE
        l_query:=l_query||'and (to_char(a.fecha_desde,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''' or to_char(a.fecha_hasta,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''') ';
       END IF;*/
       if P_RESTRINGIDO='S' then
            
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and sa.id_depto_padre in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||')';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and sa.id_area in('||P_ID_AREA||')';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';
          end if;
        end if;

        if P_RESTRINGIDO='U' then
          l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';
        end if;

       
       l_query:=l_query|| ' union all ';
       l_trab:='b.id_trabajador,';
       l_query:=l_query|| 'select ';
       l_query:=l_query|| l_trab || l_columna;
       l_query:=l_query|| 'from ENOC.VW_LICENCIA_PERMISO_REP a, enoc.plla_licencia_permiso_det b, moises.trabajador t, eliseo.vw_sede_area sa  ';
       l_query:=l_query|| 'where a.id_licencia_permiso=b.id_licencia_permiso ';
       l_query:=l_query|| 'and b.id_trabajador=t.id_trabajador ';
       l_query:=l_query|| 'and t.id_sedearea=sa.id_sedearea ';
       l_query:=l_query|| 'and a.id_entidad=:S_ID_ENTIDAD ';
       l_query:=l_query|| 'and a.engrupo=''S'' ';
       l_query:=l_query|| 'and a.id_estado_lica_per not in(''00'',''04'') ';
       if P_ID_TRABAJADOR > 0 then
          l_query:=l_query||'and b.id_trabajador='||P_ID_TRABAJADOR::text||' ';
       end if;
       l_query:=l_query|| l_where;
       /*IF P_TIPO='RA' THEN
        l_query:=l_query||'and ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) '; 
        --l_query:=l_query||'and ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ';
       ELSE
        l_query:=l_query||'and (to_char(a.fecha_desde,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''' or to_char(a.fecha_hasta,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''') ';
       END IF;*/
       l_query:=l_query||'and ( ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) or ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ) ';

       if P_RESTRINGIDO='S' then
         
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and sa.id_depto_padre in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||')';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and sa.id_area in('||P_ID_AREA||')';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and b.id_trabajador='||P_ID_TRABAJADOR::text||' ';
          end if;
        end if;

        if P_RESTRINGIDO='U' then
          l_query:=l_query||'and b.id_trabajador='||P_ID_TRABAJADOR::text||' ';
        end if;

       /*IF P_TIPO='RA' THEN
        EXECUTE IMMEDIATE l_query USING l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta,
        l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta;
       else
        EXECUTE IMMEDIATE l_query USING l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,--l_desdes, l_hasta,
        l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD;--,l_desdes, l_hasta;
       end if;*/
       
       EXECUTE l_query USING l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta,l_desdes, l_hasta,
        l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta,l_desdes, l_hasta;
     if P_OPCION='N' then
      OPEN CURSOR FOR
      SELECT 
      a.id_entidad,
      a.id_depto,
      a.id_trabajador,
      b.id_persona, 
      b.apellidonombre, 
      td.siglas, 
      b.num_documento, 
      a.id_tipo_perm_lic,
      a.id_concepto_perm_lic,
      a.tipo_perm_lic,
      a.nombre, 
      a.codsunat,
      b.id_condicion_laboral,
      cl.nombre as condicion_laboral,
      b.id_tipo_tiempo_trabajo,
      tt.nombre as tiempo_trabajo,
      a.periodo,
      pp.puesto,
      sa.nombre as area,
      b.ID_TIPODOCUMENTO,
      a.horas,
      a.dias,
      a.id_tipo_suspension,
      case when a.periodo='H' then to_char(a.FECHA_DESDE,'DD/MM/YYYY HH24:MI') else  to_char(a.FECHA_DESDE,'DD/MM/YYYY') end  as FECHA_DESDE,
      case when a.periodo='H' then to_char(a.FECHA_HASTA,'HH24:MI') else  to_char(a.FECHA_HASTA,'DD/MM/YYYY') end  as FECHA_HASTA,
      case when a.periodo='H'  then 'Horas' else 'Días' end as  nomperiodo,
      a.ID_ESTADO_LICA_PER,
      est.nombre as estado_nombre
      from ENOC.TT_LICENCIA_PERMISO a inner join enoc.vw_trabajador b 
      on a.id_trabajador=b.id_trabajador
      inner join moises.tipo_documento td
      on td.ID_TIPODOCUMENTO=b.ID_TIPODOCUMENTO
      inner join enoc.vw_perfil_puesto pp
      on pp.id_perfil_puesto=b.id_perfil_puesto
      inner join eliseo.vw_sede_area sa
      on sa.id_sedearea=b.id_sedearea
      inner join moises.condicion_laboral cl
      on cl.id_condicion_laboral=b.id_condicion_laboral
      inner join moises.tipo_tiempo_trabajo tt
      on tt.id_tipo_tiempo_trabajo=b.id_tipo_tiempo_trabajo
      inner join enoc.PLLA_ESTADO_LICA_PER est
      on est.ID_ESTADO_LICA_PER=a.ID_ESTADO_LICA_PER
      order by a.FECHA_DESDE,b.apellidonombre;

     else 
      OPEN CURSOR FOR 
      SELECT 
      a.id_entidad,
      a.id_depto,
      a.id_trabajador,
      b.id_persona, 
      b.apellidonombre, 
      td.siglas, 
      b.num_documento, 
      a.id_tipo_perm_lic,
      a.id_concepto_perm_lic,
      a.tipo_perm_lic,
      a.nombre, 
      a.codsunat,
      b.id_condicion_laboral,
      cl.nombre as condicion_laboral,
      b.id_tipo_tiempo_trabajo,
      tt.nombre as tiempo_trabajo,
      a.periodo,
      pp.puesto,
      sa.nombre as area,
      b.ID_TIPODOCUMENTO,
      sum(a.horas) as horas,
      sum(a.dias) as dias,
      sum(a.horas_proc) as horas_proc,
      --sum(a.dias_proc) as dias_proc,
      sum(
      case when a.periodo='H' then a.dias else (a.FECHA_HASTA_PROC- a.FECHA_DESDE_PROC)+1
      end 
      ) as dias_proc,
      a.id_tipo_suspension
      from ENOC.TT_LICENCIA_PERMISO a inner join enoc.vw_trabajador b 
      on a.id_trabajador=b.id_trabajador
      inner join moises.tipo_documento td
      on td.ID_TIPODOCUMENTO=b.ID_TIPODOCUMENTO
      inner join enoc.vw_perfil_puesto pp
      on pp.id_perfil_puesto=b.id_perfil_puesto
      inner join eliseo.vw_sede_area sa
      on sa.id_sedearea=b.id_sedearea
      inner join moises.condicion_laboral cl
      on cl.id_condicion_laboral=b.id_condicion_laboral
      inner join moises.tipo_tiempo_trabajo tt
      on tt.id_tipo_tiempo_trabajo=b.id_tipo_tiempo_trabajo
      group by
      a.id_entidad,
      a.id_depto,
      a.id_trabajador,
      b.id_persona, 
      b.apellidonombre, 
      td.siglas, 
      b.num_documento, 
      a.id_tipo_perm_lic,
      a.id_concepto_perm_lic,
      a.tipo_perm_lic,
      a.nombre, 
      a.codsunat,
      b.id_condicion_laboral,
      cl.nombre,
      b.id_tipo_tiempo_trabajo,
      tt.nombre,
      a.periodo,
      pp.puesto,
      sa.nombre,
      b.ID_TIPODOCUMENTO,
      a.id_tipo_suspension
      order by b.apellidonombre;
      end if;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_reporte_permiso_lic ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_TIPO_PERM_LIC bigint, P_ID_CONCEPTO_PERM_LIC text, P_ID_TRABAJADOR bigint, P_TIPO text, P_ID_ANHO bigint, P_ID_MES bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREA text, P_ID_USER bigint, P_OPCION text, OUT CURSOR REFCURSOR ) FROM PUBLIC;
