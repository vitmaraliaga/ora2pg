-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_reporte_permiso_lic_trab ( P_ID_TRABAJADOR bigint, P_TIPO text, P_ID_ANHO bigint, P_ID_MES bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), OUT CURSOR REFCURSOR ) AS $body$
DECLARE


          l_desdes timestamp(0);
          l_hasta timestamp(0);
          l_trab varchar(100):='';
          l_columna varchar(1500):='';
          l_query varchar(4000):='';
          l_where varchar(1500):='';
          l_id_tipo_nivel_vista bigint;

BEGIN
      
      IF P_TIPO='RA' THEN
        l_desdes:=P_FECHA_DESDE;
        l_hasta:=P_FECHA_HASTA;
      ELSE
        select to_date('01-'||P_ID_MES::text||'-'||P_ID_ANHO::text,'dd/mm/yyyy'),  date_trunc('day', ((date_trunc('month',(to_date('01-'||P_ID_MES::text||'-'||P_ID_ANHO::text,'dd/mm/yyyy'))::timestamp + interval '1 month'))::timestamp(0) - 1))
        into STRICT l_desdes,l_hasta
;
      END IF;

      
        l_query:='insert into ENOC.TT_LICENCIA_PERMISO(id_licencia_permiso,id_trabajador)';
        l_query:=l_query|| 'SELECT a.id_licencia_permiso,a.id_trabajador ';
        l_query:=l_query|| 'from ENOC.VW_LICENCIA_PERMISO a, moises.trabajador t ';
        l_query:=l_query|| 'where a.id_trabajador=t.id_trabajador ';
        l_query:=l_query|| 'and a.engrupo=''N'' ';
        l_query:=l_query||'AND ( ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) or ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ) ';
        l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';
        l_query:=l_query|| ' union all ';
        l_query:=l_query|| 'SELECT a.id_licencia_permiso,a.id_trabajador ';
        l_query:=l_query|| 'from ENOC.VW_LICENCIA_PERMISO a, moises.trabajador t,enoc.plla_licencia_permiso_det b ';
        l_query:=l_query|| 'where a.id_trabajador=t.id_trabajador ';
        l_query:=l_query|| 'AND a.id_licencia_permiso=b.id_licencia_permiso ';
        l_query:=l_query|| 'and a.engrupo=''S'' ';
        l_query:=l_query||'AND ( ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) or ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ) ';
        l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';

      
       
       EXECUTE l_query USING l_desdes,l_hasta, l_desdes,l_hasta,l_desdes,l_hasta,l_desdes,l_hasta, l_desdes,l_hasta,l_desdes,l_hasta;


      
      OPEN CURSOR FOR 
      SELECT 
      a.id_licencia_permiso,
      x.id_trabajador,
      a.periodo,
      a.motivo,
      a.fecha_desde,
      a.fecha_hasta,
      a.dias,
      a.horas,
      c.nombre as concepto_perm_lic,
      tpl.nombre as tipo_perm_lic,
      g.nombre_corto as tipo_suspension,
      case when g.tipo = 'SP' then 'S.P.' when g.tipo = 'SI' then 'S.I.' else '' end as tipo,
      f.nombrecorto as estado,
      a.id_estado_lica_per,
      a.periodo,
      case when a.periodo='H' then to_char(a.fecha_desde, 'DD/MM/YYYY HH24:MI') else to_char(a.fecha_desde, 'DD/MM/YYYY') end as fecha_desde, 
      case when a.periodo='H'  then 'Horas' else 'DÃ­as' end as  nomperiodo,
      case when a.periodo='H' then to_char(a.fecha_hasta, 'HH24:MI') else to_char(a.fecha_hasta, 'DD/MM/YYYY') end as fecha_hasta,
      to_char(a.fecha_desde, 'HH24:mm') as hora_inicio, 
      to_char(a.fecha_hasta, 'HH24:mm') as hora_fin
      from ENOC.TT_LICENCIA_PERMISO x  
      INNER JOIN enoc.plla_licencia_permiso  a 
      ON x.id_licencia_permiso=a.id_licencia_permiso
      inner join enoc.plla_concepto_perm_lic c 
      on a.id_concepto_perm_lic=c.id_concepto_perm_lic
      inner join enoc.plla_tipo_perm_lic tpl
      on c.id_tipo_perm_lic=tpl.id_tipo_perm_lic
      inner join enoc.plla_tipo_suspension  g
      on c.id_tipo_suspension=g.id_tipo_suspension
      inner join enoc.plla_estado_lica_per  f
      on a.id_estado_lica_per=f.id_estado_lica_per
      order by a.id_licencia_permiso desc;

      
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_reporte_permiso_lic_trab ( P_ID_TRABAJADOR bigint, P_TIPO text, P_ID_ANHO bigint, P_ID_MES bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), OUT CURSOR REFCURSOR ) FROM PUBLIC;
