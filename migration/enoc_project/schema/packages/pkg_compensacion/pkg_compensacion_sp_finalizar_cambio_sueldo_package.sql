-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_finalizar_cambio_sueldo (P_ID_CAMBIOS bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_concepto_cambio bigint;
        l_codigo varchar(20);
        l_id_trabajador bigint;
        l_sueldo decimal(10,2);
        l_pje_fmra decimal(10,2);
        l_id_remuneracion bigint;
        l_nombre varchar(150);
        l_id_contrato bigint;
        l_id_escala_salarial bigint;
        l_id_max bigint;
        l_id bigint;
        l_fec_desde timestamp(0);


BEGIN
      
        SELECT 
          ID_CONCEPTO_CAMBIO,
          SUELDO,
          PJE_FMR,
          ID_TRABAJADOR,
          ID_ESCALA_SALARIAL,
          FEC_DESDE
        into STRICT 
          l_id_concepto_cambio,
          l_sueldo,
          l_pje_fmra,
          l_id_trabajador,
          l_id_escala_salarial,
          l_fec_desde
        from enoc.PLLA_CAMBIOS 
        where ID_CAMBIOS=P_ID_CAMBIOS;

        SELECT CODIGO,nombre INTO STRICT l_codigo, l_nombre FROM enoc.PLLA_CONCEPTO_CAMBIO WHERE ID_CONCEPTO_CAMBIO=l_id_concepto_cambio;

        IF l_codigo ='INCSG' THEN  
        
                
          UPDATE PLLA_REMUNERACION SET VIGENCIA=0 WHERE id_trabajador in (
            SELECT ID_TRABAJADOR FROM ENOC.PLLA_CAMBIOS_DET WHERE ID_CAMBIOS=P_ID_CAMBIOS
          ) AND VIGENCIA=1;

          select coalesce(max(ID_REMUNERACION),0)   into STRICT l_id_remuneracion  from  PLLA_REMUNERACION;

          INSERT INTO PLLA_REMUNERACION(
            ID_REMUNERACION,
            ID_TRABAJADOR,
            ID_CONTRATO,
            REFERENCIA,
            REFERENCIA_URL,
            FEC_EFECTIVO,
            TIPO_PAGO,
            FMR,
            SUELDO,
            BONIFICACION,
            OBSERVACION,
            ID_ESTADO_REMUNE,
            VIGENCIA,
            ID_USER_REG,
            FECHA_REG,
            ID_ESCALA_SALARIAL
          )
          SELECT (row_number() OVER ( ORDER BY A.ID_CAMBIOS_DET ASC )) + l_id_remuneracion AS ID_REMU,
          A.ID_TRABAJADOR,
          B.ID_CONTRATO,
          l_nombre,
          NULL,
          l_fec_desde,
          'F',
          A.PJE_FMR,
          A.SUELDO,
          0,
          l_nombre,
          '04',
          1,
          P_ID_USER,
          clock_timestamp(),
          A.ID_ESCALA_SALARIAL
          FROM ENOC.PLLA_CAMBIOS_DET A, MOISES.TRABAJADOR B
          WHERE A.ID_TRABAJADOR=B.ID_TRABAJADOR
          AND A.ID_CAMBIOS=P_ID_CAMBIOS
          ORDER BY A.ID_CAMBIOS_DET;

          
        ELSE
          select id_contrato into STRICT l_id_contrato  FROM moises.trabajador where id_trabajador=l_id_trabajador;

          UPDATE PLLA_REMUNERACION SET VIGENCIA=0 WHERE id_trabajador = l_id_trabajador AND VIGENCIA=1;

          select coalesce(max(ID_REMUNERACION),0) + 1  into STRICT l_id_remuneracion  from  PLLA_REMUNERACION;

          INSERT INTO PLLA_REMUNERACION(
            ID_REMUNERACION,
            ID_TRABAJADOR,
            ID_CONTRATO,
            REFERENCIA,
            REFERENCIA_URL,
            FEC_EFECTIVO,
            TIPO_PAGO,
            FMR,
            SUELDO,
            BONIFICACION,
            OBSERVACION,
            ID_ESTADO_REMUNE,
            VIGENCIA,
            ID_USER_REG,
            FECHA_REG,
            ID_ESCALA_SALARIAL
          )values (
            l_id_remuneracion,
            l_id_trabajador,
            l_id_contrato,
            l_nombre,
            NULL,
            clock_timestamp(),
            'F',
            l_pje_fmra,
            l_sueldo,
            0,
            l_nombre,
            '04',
            1,
            P_ID_USER,
            clock_timestamp(),
            l_id_escala_salarial
          );

        end if;

        update enoc.PLLA_CAMBIOS set
        PROCESO_FIN='S'
        where ID_CAMBIOS=P_ID_CAMBIOS;


--        <<salida_fin_cambio>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_finalizar_cambio_sueldo (P_ID_CAMBIOS bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
