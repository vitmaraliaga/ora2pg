-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_reporte_vida_ley ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint, P_ID_CONDICION_LABORAL text, P_ID_TIPO_TIEMPO_TRABAJO bigint, P_ID_ANHO bigint, P_ID_MES bigint, P_DATO text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREAS_USER text, P_ID_USER bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE

       l_query varchar(4000):='';
       l_anhomes varchar(10);
       l_id_tipo_nivel_vista bigint;

BEGIN
      
       if P_RESTRINGIDO='S' then
          select id_tipo_nivel_vista into STRICT l_id_tipo_nivel_vista from eliseo.lamb_acceso_nivel where id_acceso_nivel=P_ID_ACCESO_NIVEL;
      end if;
      --activos
      l_query:='INSERT INTO ENOC.TT_REP_SUELDO_MENSUAL (ID_TRABAJADOR,TOTAL) ';
      l_query:=l_query||'select ';
      l_query:=l_query||'t.id_trabajador,';
      l_query:=l_query||'COALESCE(rem.sueldo,0) ';
      l_query:=l_query||'from ENOC.vw_trabajador t ';
      l_query:=l_query||'inner join enoc.vw_ent_dep_area_ccosto cc on ';
      l_query:=l_query||'cc.ID_SEDEAREA=t.ID_SEDEAREA ';
      l_query:=l_query||'left join ENOC.PLLA_REMUNERACION rem on  ';
      l_query:=l_query||'rem.id_trabajador=t.id_trabajador and rem.vigencia=1 ';
      l_query:=l_query||'where t.id_entidad=:s_entidad ';
      l_query:=l_query||'and t.id_situacion_trabajador=''1'' ';
      l_query:=l_query||'and t.ID_CONDICION_LABORAL not in(''P'',''PP'') ';
      if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
        l_query:=l_query||'and cc.id_depto_padre='''||P_ID_DEPTO||''' ';
      end if;
      if P_ID_AREA > 0 then
        l_query:=l_query||'and cc.id_area ='||P_ID_AREA||' ';
      end if;
      if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
        l_query:=l_query||'and t.ID_CONDICION_LABORAL ='''||P_ID_CONDICION_LABORAL||''' ';
      end if;
      if P_ID_TIPO_TIEMPO_TRABAJO > 0 then
        l_query:=l_query||'and t.ID_TIPO_TIEMPO_TRABAJO ='||P_ID_TIPO_TIEMPO_TRABAJO||' ';
      end if;
      if (P_DATO IS NOT NULL AND P_DATO::text <> '') then
        l_query:=l_query||'and (upper(convert(T.nombre||'' ''||t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.num_documento, ''us7ascii'')) like ''%''||replace(replace(upper(convert('''||P_DATO||''' , ''us7ascii'')),'','','' ''),'' '',''%'')||''%'') ';
      end if;

                  
      if P_RESTRINGIDO='S' then
            
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and cc.id_depto_padre in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||') ';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and cc.id_area in('||P_ID_AREAS_USER||') ';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and t.id_trabajador='||P_ID_USER::text||' ';
          end if;
      end if;

      if P_RESTRINGIDO='U' then
          l_query:=l_query||'and t.id_trabajador='||P_ID_USER::text||' ';
      end if;
      
      RAISE NOTICE '%', l_query;

      EXECUTE l_query USING P_ID_ENTIDAD;

      --cesados
      l_query:='INSERT INTO ENOC.TT_REP_SUELDO_MENSUAL (ID_TRABAJADOR,TOTAL) ';
      l_query:=l_query||'select ';
      l_query:=l_query||'t.id_trabajador,';
      l_query:=l_query||'COALESCE(rem.sueldo,0) ';
      l_query:=l_query||'from ENOC.vw_trabajador t ';
      l_query:=l_query||'inner join enoc.vw_ent_dep_area_ccosto cc on ';
      l_query:=l_query||'cc.ID_SEDEAREA=t.ID_SEDEAREA ';
      l_query:=l_query||'left join ENOC.PLLA_REMUNERACION rem on  ';
      l_query:=l_query||'rem.id_trabajador=t.id_trabajador and rem.vigencia=1 ';
      l_query:=l_query||'where t.id_entidad=:s_entidad ';
      l_query:=l_query||'and t.id_situacion_trabajador=''0'' ';
      l_query:=l_query||'and t.ID_CONDICION_LABORAL not in(''P'',''PP'') ';
      l_query:=l_query||'and to_char(t.FECHA_FIN_efectivo,''YYYYMM'') =:s_anhomes ';
      if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
        l_query:=l_query||'and cc.id_depto_padre='''||P_ID_DEPTO||''' ';
      end if;
      if P_ID_AREA > 0 then
        l_query:=l_query||'and cc.id_area ='||P_ID_AREA||' ';
      end if;
      if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
        l_query:=l_query||'and t.ID_CONDICION_LABORAL ='''||P_ID_CONDICION_LABORAL||''' ';
      end if;
      if P_ID_TIPO_TIEMPO_TRABAJO > 0 then
        l_query:=l_query||'and t.ID_TIPO_TIEMPO_TRABAJO ='||P_ID_TIPO_TIEMPO_TRABAJO||' ';
      end if;
      if (P_DATO IS NOT NULL AND P_DATO::text <> '') then
        l_query:=l_query||'and (upper(convert(T.nombre||'' ''||t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.num_documento, ''us7ascii'')) like ''%''||replace(replace(upper(convert('''||P_DATO||''' , ''us7ascii'')),'','','' ''),'' '',''%'')||''%'') ';
      end if;

      if P_RESTRINGIDO='S' then
            
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and cc.id_depto_padre in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||') ';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and cc.id_area in('||P_ID_AREAS_USER||') ';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and t.id_trabajador='||P_ID_USER::text||' ';
          end if;
      end if;

      if P_RESTRINGIDO='U' then
          l_query:=l_query||'and t.id_trabajador='||P_ID_USER::text||' ';
      end if;
      if P_ID_MES<10 then
        l_anhomes:=P_ID_ANHO::text||'0'||P_ID_MES::text;
      else
        l_anhomes:=P_ID_ANHO::text||P_ID_MES::text;
      end if;

      EXECUTE l_query USING P_ID_ENTIDAD,l_anhomes;

      update ENOC.TT_REP_SUELDO_MENSUAL set adicional=0, importe=0;
      --sueldo mensual
      MERGE INTO ENOC.TT_REP_SUELDO_MENSUAL S
      USING(
        SELECT coalesce(sum(w.importe),0) as total,rr.ID_TRABAJADOR from ENOC.PLLA_REMUNERACION_DET w , ENOC.PLLA_REMUNERACION rr
        where w.ID_REMUNERACION=rr.ID_REMUNERACION
        and rr.ID_TRABAJADOR in (
          SELECT ID_TRABAJADOR from ENOC.TT_REP_SUELDO_MENSUAL
        )
        and w.id_anho=P_ID_ANHO
        and w.id_mes=P_ID_MES 
        group by rr.ID_TRABAJADOR
      )T ON (T.ID_TRABAJADOR=S.ID_TRABAJADOR)
      WHEN  MATCHED THEN UPDATE SET  
      S.importe=T.total;

      --adicional
      MERGE INTO ENOC.TT_REP_SUELDO_MENSUAL S 
      USING(
        SELECT coalesce(sum(q.importe),0) as total,q.ID_TRABAJADOR from ENOC.VW_ADICIONAL_DET q, ENOC.PLLA_CONCEPTO_PLANILLA u
        where q.ID_CONCEPTO_PLANILLA=u.ID_CONCEPTO_PLANILLA
        and  q.ID_TRABAJADOR in (
            SELECT ID_TRABAJADOR from ENOC.TT_REP_SUELDO_MENSUAL
        )
        and u.ID_CONCEPTOAPS=1000
        and q.id_anho=P_ID_ANHO
        and q.id_mes=P_ID_MES 
        group by q.ID_TRABAJADOR
      )T ON (T.ID_TRABAJADOR=S.ID_TRABAJADOR)
      WHEN  MATCHED THEN UPDATE SET  
      S.ADICIONAL=T.total;

     
      
      OPEN CURSOR FOR
      SELECT 
      t.id_persona,
      t.id_trabajador,
      t.paterno,
      t.materno,
      t.nombre,
      t.sexo,
      t.apellidonombre,
      to_char(t.FEC_NACIMIENTO,'DD/MM/YYYY') as FEC_NACIMIENTO,
      t.ID_TIPODOCUMENTO,
      tdc.siglas as tipodocumento,
      t.NUM_DOCUMENTO,
      to_char(t.FECHA_INICIO,'DD/MM/YYYY') as FECHA_INICIO,
      cc.depto_padre,
      cc.ID_DEPTO,
      t.id_perfil_puesto,
      ppp.PUESTO,
      to_char(t.FECHA_FIN_PREVISTO,'DD/MM/YYYY') as FECHA_FIN,
      to_char(t.FECHA_FIN_efectivo,'DD/MM/YYYY') as FECHA_FIN_efectivo,
      tt.importe as sueldo_men,
      tt.adicional,
      tt.total as sueldo_fijo,
      tt.importe+tt.adicional+tt.total as sueldo,
      cc.area,
      cl.nombre as condicion_laboral,
      tr.nombre as tiempo_trabajo,
      P_ID_ANHO as id_anho,
      P_ID_MES as id_mes
      from enoc.vw_trabajador t
      inner join ENOC.TT_REP_SUELDO_MENSUAL tt on tt.id_trabajador=t.id_trabajador
      inner join enoc.vw_ent_dep_area_ccosto cc on cc.ID_SEDEAREA=t.ID_SEDEAREA
      inner join moises.tipo_documento tdc on tdc.ID_TIPODOCUMENTO=t.ID_TIPODOCUMENTO
      inner join enoc.vw_perfil_puesto ppp on ppp.id_perfil_puesto=t.id_perfil_puesto
      inner join moises.condicion_laboral cl on cl.id_condicion_laboral=t.id_condicion_laboral
      inner join moises.tipo_tiempo_trabajo tr on tr.id_tipo_tiempo_trabajo=t.id_tipo_tiempo_trabajo
      order by paterno,materno,NOMBRE;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_reporte_vida_ley ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint, P_ID_CONDICION_LABORAL text, P_ID_TIPO_TIEMPO_TRABAJO bigint, P_ID_ANHO bigint, P_ID_MES bigint, P_DATO text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREAS_USER text, P_ID_USER bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
