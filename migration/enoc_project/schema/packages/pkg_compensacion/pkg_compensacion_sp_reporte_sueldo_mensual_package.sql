-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_reporte_sueldo_mensual (P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint,P_ANHO_ID bigint, P_ID_MES bigint, P_ID_TRABAJADOR bigint, P_ID_CONDICION_LABORAL text,P_ID_TIPO_TIEMPO_TRABAJO bigint,OUT CURSOR REFCURSOR ) AS $body$
DECLARE

  l_query varchar(4000):='';
  l_campos varchar(2000):='';
  l_values varchar(2000):='';
  l_groups varchar(2000):='';
  l_id_concepto_planilla bigint;
  l_mes varchar(50);

BEGIN
  
    delete from enoc.tt_rep_sueldo_mensual;

    l_campos:='ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,ID_ANHO,MES,ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE,IMPORTE,ADICIONAL,ID_CONDICION_LABORAL,horas';
    l_groups:='group by ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,ID_ANHO,MES,ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE,ID_CONDICION_LABORAL';
    --contrato
    l_values:='ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,ID_ANHO,MES,ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE,coalesce(sum(IMPORTE),0) as importe,to_number(0.00) as ADICIONAL,ID_CONDICION_LABORAL, coalesce(sum(HORAS),0) as HORAS';
    l_query:='insert into enoc.tt_rep_sueldo_mensual('||l_campos||') ';
    l_query:=l_query||'select '||l_values||' from enoc.vw_remuneracion_det ';
    l_query:=l_query||' where id_entidad=:s_id_entidad';
    l_query:=l_query||' and id_anho=:s_id_anho';
    l_query:=l_query||' and vigencia_det=1';
    l_query:=l_query||' and id_mes=:s_id_mes';
    if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
      l_query:=l_query||' and id_depto_padre='''||P_ID_DEPTO||''' ';
    end if;
    if P_ID_AREA<>0 then
      l_query:=l_query||' and id_area='||P_ID_AREA::text;
    end if;
    if P_ID_TRABAJADOR<>0 then
      l_query:=l_query||' and id_trabajador='||P_ID_TRABAJADOR::text;
    end if;
    if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
      l_query:=l_query||' and ID_CONDICION_LABORAL='''||P_ID_CONDICION_LABORAL||''' ';
    end if;
    if P_ID_TIPO_TIEMPO_TRABAJO <> 0 then
      l_query:=l_query||' and ID_TIPO_TIEMPO_TRABAJO='||P_ID_TIPO_TIEMPO_TRABAJO::text;
    end if;

    l_query:=l_query||' '||l_groups;

    --DBMS_OUTPUT.PUT_LINE(l_query);
    
    EXECUTE l_query USING P_ID_ENTIDAD,P_ANHO_ID,P_ID_MES;

    
    select id_concepto_planilla into STRICT l_id_concepto_planilla from ENOC.plla_concepto_planilla where codigo='REM_BAS';

    --adicional por trabajador
    l_values:='ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,ID_ANHO,MES,ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE, to_number(0.00) as importe, coalesce(sum(IMPORTE),0) as ADICIONAL,ID_CONDICION_LABORAL,to_number(0.00) as HORAS';
    l_query:='insert into enoc.tt_rep_sueldo_mensual('||l_campos||') ';
    l_query:=l_query||'select '||l_values||' from enoc.vw_adicional_det';
    l_query:=l_query||' where id_entidad=:s_id_entidad';
    l_query:=l_query||' and id_anho=:s_id_anho';
    l_query:=l_query||' and id_mes=:s_id_mes';
    l_query:=l_query||' and vigencia=1';
    l_query:=l_query||' and id_estado_adicional not in(''00'',''05'') ';
    if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
      l_query:=l_query||' and id_depto_padre='''||P_ID_DEPTO||''' ';
    end if;
    if P_ID_AREA<>0 then
      l_query:=l_query||' and id_area='||P_ID_AREA::text;
    end if;
    if P_ID_TRABAJADOR<>0 then
      l_query:=l_query||' and id_trabajador='||P_ID_TRABAJADOR::text;
    end if;
    if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
      l_query:=l_query||' and ID_CONDICION_LABORAL='''||P_ID_CONDICION_LABORAL||''' ';
    end if;
    if P_ID_TIPO_TIEMPO_TRABAJO <> 0 then
      l_query:=l_query||' and ID_TIPO_TIEMPO_TRABAJO='||P_ID_TIPO_TIEMPO_TRABAJO::text;
    end if;
    --l_query:=l_query||' and id_concepto_planilla='||to_char(l_id_concepto_planilla);
    l_query:=l_query||' '||l_groups;

     EXECUTE l_query USING P_ID_ENTIDAD,P_ANHO_ID,P_ID_MES;
    --adicional grupal
    l_values:='ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,ID_ANHO,MES,ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE, to_number(0.00) as importe, coalesce(sum(IMPORTE),0) as ADICIONAL,ID_CONDICION_LABORAL,to_number(0.00) as HORAS';
    l_query:='insert into enoc.tt_rep_sueldo_mensual('||l_campos||') ';
    l_query:=l_query||'select '||l_values||' from enoc.vw_adicional_grupo';
    l_query:=l_query||' where id_entidad=:s_id_entidad';
    l_query:=l_query||' and id_anho=:s_id_anho';
    l_query:=l_query||' and id_mes=:s_id_mes';
    l_query:=l_query||' and vigencia=1';
    l_query:=l_query||' and id_estado_adicional not in(''00'',''05'') ';
    if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
      l_query:=l_query||' and id_depto_padre='''||P_ID_DEPTO||''' ';
    end if;
    if P_ID_AREA<>0 then
      l_query:=l_query||' and id_area='||P_ID_AREA::text;
    end if;
    if P_ID_TRABAJADOR<>0 then
      l_query:=l_query||' and id_trabajador='||P_ID_TRABAJADOR::text;
    end if;
    if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
      l_query:=l_query||' and ID_CONDICION_LABORAL='''||P_ID_CONDICION_LABORAL||''' ';
    end if;
    if P_ID_TIPO_TIEMPO_TRABAJO <> 0 then
      l_query:=l_query||' and ID_TIPO_TIEMPO_TRABAJO='||P_ID_TIPO_TIEMPO_TRABAJO::text;
    end if;
    --l_query:=l_query||' and id_concepto_planilla='||to_char(l_id_concepto_planilla);
    l_query:=l_query||' '||l_groups;

    select nombre into STRICT l_mes from eliseo.conta_mes where id_mes=P_ID_MES;

    insert into enoc.tt_rep_sueldo_mensual(ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,ID_ANHO,MES,ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE,IMPORTE,ADICIONAL,ID_CONDICION_LABORAL,HORAS)
    SELECT ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,
    P_ANHO_ID as ID_ANHO,l_mes as MES,
    ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE,sueldo as importe,(0.00)::numeric  as ADICIONAL,ID_CONDICION_LABORAL ,(0.00)::numeric  as HORAS
    from enoc.VW_REMUNERACION where tipo_pago='F'  AND VIGENCIA=1
    and id_trabajador in (
      SELECT id_trabajador from enoc.tt_rep_sueldo_mensual
    );

    --DBMS_OUTPUT.PUT_LINE(l_query);
    EXECUTE l_query USING P_ID_ENTIDAD,P_ANHO_ID,P_ID_MES;

     
    MERGE INTO enoc.tt_rep_sueldo_mensual S 
    USING(
    SELECT ID_TRABAJADOR, 
    sum(coalesce(importe,0)+ coalesce(adicional,0)) as total 
    from enoc.tt_rep_sueldo_mensual 
    group by ID_TRABAJADOR
    )T ON (T.ID_TRABAJADOR=S.ID_TRABAJADOR)
    WHEN  MATCHED THEN UPDATE SET  
    S.TOTAL=T.total;

    
    OPEN CURSOR FOR  
    SELECT
    a.ID_PERSONA,a.ID_TRABAJADOR,0 as ID_CONTRATO,a.APELLIDONOMBRE,a.NUM_DOCUMENTO,a.SIGLAS,a.AREA,a.PUESTO,a.ID_ANHO,a.MES,a.ID_DEPTO,a.CCOSTO,
    a.ID_AREA,a.ID_ENTIDAD,a.ID_DEPTO_PADRE,coalesce(sum(a.IMPORTE),0) as importe,coalesce(sum(a.ADICIONAL),0) as adicional, a.TOTAL,b.nombre as deptopadre,
    a.id_condicion_laboral, c.nombre as condicion_laboral, t.id_situacion_trabajador, st.nombre_corto as situacion_trabajador,t.ID_TIPO_TIEMPO_TRABAJO,tt.nombre as TIPO_TIEMPO_TRABAJO,
    coalesce(sum(a.HORAS),0) as HORAS
    from enoc.tt_rep_sueldo_mensual a, eliseo.conta_entidad_depto b, moises.condicion_laboral c, moises.trabajador t, moises.situacion_trabajador st,MOISES.TIPO_TIEMPO_TRABAJO  tt
    where a.id_entidad=b.id_entidad
    and a.ID_DEPTO_PADRE=b.id_depto
    and a.id_condicion_laboral=c.id_condicion_laboral
    and a.id_trabajador=t.id_trabajador
    and t.id_situacion_trabajador=st.id_situacion_trabajador
    and tt.ID_TIPO_TIEMPO_TRABAJO=t.ID_TIPO_TIEMPO_TRABAJO
    group by a.ID_PERSONA,a.ID_TRABAJADOR,a.APELLIDONOMBRE,a.NUM_DOCUMENTO,a.SIGLAS,a.AREA,a.PUESTO,a.ID_ANHO,a.MES,a.ID_DEPTO,a.CCOSTO,a.ID_AREA,a.ID_ENTIDAD,a.ID_DEPTO_PADRE, a.TOTAL,b.nombre,
    a.id_condicion_laboral, c.nombre,t.id_situacion_trabajador, st.nombre_corto,t.ID_TIPO_TIEMPO_TRABAJO,tt.nombre
    order by a.APELLIDONOMBRE,a.ID_ANHO,a.MES,IMPORTE desc;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_reporte_sueldo_mensual (P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint,P_ANHO_ID bigint, P_ID_MES bigint, P_ID_TRABAJADOR bigint, P_ID_CONDICION_LABORAL text,P_ID_TIPO_TIEMPO_TRABAJO bigint,OUT CURSOR REFCURSOR ) FROM PUBLIC;
