-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_copiar_periodo_planilla (P_ID_PERIODO_PLANILLA_ANT bigint, P_ID_PERIODO_PLANILLA bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) AS $body$
DECLARE

    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_periodo_proceso bigint;
    curper CURSOR FOR
    SELECT
      ID_PERIODO_PROCESO,
      TIPO,
      FECHA_REGISTRO + '1 month'::interval as FECHA_REGISTRO,
      FECHA_APROBACION + '1 month'::interval as FECHA_APROBACION
    FROM PLLA_PERIODO_PROCESO 
    WHERE ID_PERIODO_PLANILLA=P_ID_PERIODO_PLANILLA_ANT
    AND TIPO=0
    AND VIGENCIA=1
    ORDER BY ID_PERIODO_PROCESO;

BEGIN
    FOR cur in curper LOOP
    BEGIN
      select coalesce(max(ID_PERIODO_PROCESO),0) + 1 into STRICT l_id_periodo_proceso from enoc.PLLA_PERIODO_PROCESO;
      INSERT INTO PLLA_PERIODO_PROCESO(
        ID_PERIODO_PROCESO,
        ID_PERIODO_PLANILLA,
        TIPO,
        FECHA_REGISTRO,
        FECHA_APROBACION,
        VIGENCIA,
        ID_USER_REG,
        FECHA_REG
      )values (
        l_id_periodo_proceso,
        P_ID_PERIODO_PLANILLA,
        cur.tipo,
        cur.FECHA_REGISTRO,
        cur.FECHA_APROBACION,
        1,
        P_ID_USER_REG,
        clock_timestamp()
      );
      insert into PLLA_PERIODO_PROCESO_MOD(
        ID_PERIODO_PROCESO,
        ID_MODULO,
        MODULO,
        VIGENCIA,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT
        l_id_periodo_proceso,
        ID_MODULO,
        MODULO,
        1,
        P_ID_USER_REG,
        clock_timestamp()
      from PLLA_PERIODO_PROCESO_MOD
      where ID_PERIODO_PROCESO=cur.ID_PERIODO_PROCESO;
    END;
    END LOOP;

    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_copiar_periodo_planilla (P_ID_PERIODO_PLANILLA_ANT bigint, P_ID_PERIODO_PLANILLA bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) FROM PUBLIC;
