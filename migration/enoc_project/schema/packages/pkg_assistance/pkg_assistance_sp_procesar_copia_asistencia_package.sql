-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_procesar_copia_asistencia ( P_USER bigint, P_RESULTADO OUT bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

   l_error bigint:=0;
   l_msgerror varchar(200):='';
   l_resultado bigint:=0;
   l_j bigint:=0;
   l_id_entidad bigint;
   l_id_depto varchar(10);
   l_id_trabajador bigint;
   l_desde timestamp(0);
   l_hasta timestamp(0);

   curAsi CURSOR FOR
   SELECT 
    ID_TRABAJADOR,
    IDASISTENCIA,
    FECHA,
    FECHAHORA,
    TIPOINGRESO,
    TIPOMARCACION,
    NUM_MARCADOR,
    NUMDOCUMENTO,
    FOTOCHECK 
    from ENOC.PLLA_ASIST_MARCACION_TMP 
    where (id_trabajador IS NOT NULL AND id_trabajador::text <> '') 
    order by ID_TRABAJADOR,FECHAHORA;

   
BEGIN
   
    FOR cur in curAsi LOOP
     BEGIN
     if l_j>0 then
      if l_id_trabajador<>cur.ID_TRABAJADOR then
      
          select b.id_entidad,c.id_depto_padre,min(to_date(to_char(a.FECHAHORA,'YYYY-MM-DD'),'YYYY-MM-DD')),max(to_date(to_char(a.FECHAHORA,'YYYY-MM-DD'),'YYYY-MM-DD'))
          into STRICT l_id_entidad,l_id_depto,l_desde,l_hasta
          from ENOC.PLLA_ASIST_MARCACION_TMP a,moises.trabajador b, ENOC.VW_ENT_DEP_AREA_CCOSTO c
          where a.ID_TRABAJADOR=b.ID_TRABAJADOR
          and b.id_sedearea=c.id_sedearea
          and a.ID_TRABAJADOR=l_id_trabajador;

          ENOC.CALL pkg_assistance_sp_procesar_marcacion(
            l_desde,
            l_hasta,
            l_id_entidad,
            l_id_depto,
            0,
            l_id_trabajador,
            P_USER,
            l_error,
            l_msgerror
          );
          if l_error =1 then
            l_resultado:=l_resultado +1;
          end if;
      end if;
     end if;
     ENOC.CALL pkg_assistance_sp_registrar_marcacion(
          cur.ID_TRABAJADOR,
          2,--huella
          cur.FECHAHORA, 
          null,
          null,
          null,
          CUR.NUM_MARCADOR,
          cur.FOTOCHECK,
          NULL,
          'A',
          NULL,
          P_USER, 
          l_error,
          l_msgerror
        );
        l_id_trabajador:=cur.ID_TRABAJADOR;
        l_j:= l_j + 1;

     END;
    END LOOP;

    if l_j>0 then

      
        select b.id_entidad,c.id_depto_padre,min(to_date(to_char(a.FECHAHORA,'YYYY-MM-DD'),'YYYY-MM-DD')),max(to_date(to_char(a.FECHAHORA,'YYYY-MM-DD'),'YYYY-MM-DD'))
        into STRICT l_id_entidad,l_id_depto,l_desde,l_hasta
        from ENOC.PLLA_ASIST_MARCACION_TMP a,moises.trabajador b, ENOC.VW_ENT_DEP_AREA_CCOSTO c
        where a.ID_TRABAJADOR=b.ID_TRABAJADOR
        and b.id_sedearea=c.id_sedearea
        and a.ID_TRABAJADOR=l_id_trabajador;

        ENOC.CALL pkg_assistance_sp_procesar_marcacion(
          l_desde,
          l_hasta,
          l_id_entidad,
          l_id_depto,
          0,
          l_id_trabajador,
          P_USER,
          l_error,
          l_msgerror
        );
        if l_error =1 then
            l_resultado:=l_resultado +1;
        end if;

     end if;

     delete from  ENOC.PLLA_ASIST_MARCACION_TMP;
     P_RESULTADO:=l_resultado;
     P_ERROR:=l_error;
     P_MSGERROR := l_msgerror;

   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_procesar_copia_asistencia ( P_USER bigint, P_RESULTADO OUT bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
