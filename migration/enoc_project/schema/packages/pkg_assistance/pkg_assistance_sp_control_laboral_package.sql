-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_control_laboral (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';

        l_id_control_asistencia varchar(25);
        l_item bigint;

        l_fec_actual_as timestamp(0);
        l_fec_desde_as timestamp(0);
        l_fec_hasta_as timestamp(0);


        l_id_motivo_asist varchar(2):='A';

        
 
        l_contar bigint;

      
      
BEGIN
      
      l_fec_actual_as:= current_date;
      l_fec_desde_as := to_date(P_ID_ANHO::text||'-'||P_ID_MES::text||'-01','YYYY-MM-DD');
      l_fec_hasta_as := ((date_trunc('month',(l_fec_desde_as)::timestamp + interval '1 month'))::timestamp(0) - 1);

      if l_fec_desde_as>l_fec_actual_as then
          l_error:=1;
          l_msgerror:='Fecha desde es mayor que fecha actual';
--           GOTO salida_asist;
      end if;

      if l_fec_hasta_as>l_fec_actual_as then
          l_fec_hasta_as := l_fec_actual_as;
      end if;

      
          
      delete from PLLA_CONTROL_ASISTENCIA where (to_char(FECHA,'YYYY'))::numeric =P_ID_ANHO and (to_char(FECHA,'MM'))::numeric =P_ID_MES
      and ID_MOTIVO_ASIST = l_id_motivo_asist AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR
      AND ID_SEDEAREA IN (
        SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
      );

      
      WHILE l_fec_desde_as<=l_fec_hasta_as LOOP
      
        select coalesce(max(ITEM),0)  into STRICT l_item from PLLA_CONTROL_ASISTENCIA where to_char(FECHA,'YYYY-MM-DD')=to_char(l_fec_desde_as,'YYYY-MM-DD') and ID_MOTIVO_ASIST=l_id_motivo_asist;
        /*
       INSERT INTO PLLA_CONTROL_ASISTENCIA(          
          ID_CONTROL_ASISTENCIA,
          ITEM,
          ID_TRABAJADOR,
          ID_SEDEAREA,
          ID_MOTIVO_ASIST,
          FECHA,
          HORA_DESDE_REAL,
          HORA_HASTA_REAL,
          HORA_DESDE_PLA,
          HORA_HASTA_PLA,
          NUM_HORAS_REF,
          NUM_HORAS_REAL,
          NUM_HORAS_PLA,
          ID_ASISTENCIA,
          ID_USER_REG,
          FECHA_REG,
          HORA_ENTRADA_BASE,
          HORA_SALIDA_BASE,
          NUM_HORAS_BASE
        )
      
        select 
          to_char(FECHA,'YYYYMMDD')||l_id_motivo_asist||to_char((row_number() OVER( ORDER BY a.ID_ASISTENCIA ASC ))+l_item) AS ID_CONTROL_ASISTENCIA,
          (row_number() OVER( ORDER BY a.ID_ASISTENCIA ASC ))+l_item AS ITEM,
          a.ID_TRABAJADOR,
          a.ID_SEDEAREA,
          l_id_motivo_asist,
          a.FECHA,
          a.ENTRADA, 
          a.SALIDA,
          a.HORA_ENTRADA_PLA,
          a.HORA_SALIDA_PLA,
          a.NUM_REF_PLA,
          a.NUM_HORAS_FINAL,
          a.NUM_HORAS_PLA,
          a.ID_ASISTENCIA,
          P_ID_USER_REG,
          SYSDATE,
          a.HORA_BASE_ENT,
          a.HORA_BASE_SAL,
          a.NUM_HORAS_BASE
        from VW_ASISTENCIA a
        WHERE TO_CHAR(a.FECHA,'YYYY-MM-DD')= to_char(l_fec_desde_as,'YYYY-MM-DD')
        AND a.ID_TRABAJADOR NOT IN(
          SELECT b.ID_TRABAJADOR from  PLLA_CONTROL_ASISTENCIA  b
          where to_char(b.FECHA,'YYYY-MM-DD')=to_char(l_fec_desde_as,'YYYY-MM-DD') 
          and b.ID_MOTIVO_ASIST in('FA','V','PL','A')
        )
        AND ID_SEDEAREA IN(
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        )
        AND case when P_ID_TRABAJADOR=0 then 0 else a.ID_TRABAJADOR end = P_ID_TRABAJADOR 
        ORDER BY a.ID_ASISTENCIA;
        */
        l_fec_desde_as := l_fec_desde_as + 1;

     END LOOP;

--       <<salida_asist>>
      
      P_ERROR:=l_error;
      P_MSGERROR:= l_msgerror;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_control_laboral (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
