-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_procesar_sobretiempo ( P_DESDE timestamp(0), P_HASTA timestamp(0), P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint, P_ID_ESTADO_SOBRETIEMPO text, P_SEARCH text, P_ID_AREAS text, P_RESTRINGIDO text, P_ID_TIPO_NIVEL_VISTA bigint, P_ID_USER bigint, P_ID_TRABAJADOR bigint DEFAULT 0) AS $body$
DECLARE


       person CURSOR FOR
        SELECT
          S.ID_SOBRETIEMPO,
          t.id_trabajador,
          t.id_persona,
          S.FECHA,
          S.ID_TIPO_HORARIO,
          S.ID_TIPO_SOBRETIEMPO,
          TS.CODIGO,
          S.HORA_DESDE,
          S.HORA_HASTA,
          s.NUM_HORAS,
          to_date(to_char(S.FECHA,'YYYY-MM-DD')||' '||S.HORA_DESDE,'YYYY-MM-DD HH24:MI:SS') AS DESDE,
          to_date(to_char(S.FECHA,'YYYY-MM-DD')||' '||S.HORA_HASTA,'YYYY-MM-DD HH24:MI:SS') AS HASTA
          from ENOC.PLLA_SOBRETIEMPO S, moises.trabajador t, eliseo.vw_sede_area sa,ENOC.PLLA_TIPO_SOBRETIEMPO TS
          where S.ID_TRABAJADOR=T.ID_TRABAJADOR
          AND t.id_sedearea=sa.id_sedearea
          AND S.ID_TIPO_SOBRETIEMPO=TS.ID_TIPO_SOBRETIEMPO
          and s.id_sobretiempo in (SELECT ID_SOBRETIEMPO from ENOC.TT_PROC_SOBRETIEMPO) 
          order  by t.id_trabajador;

      l_contar bigint;
      l_sal_diasig bigint;
      L_HORA_SALIDA_REAL varchar(10);
      L_HORA_SALIDA_REF_REAL varchar(10);
      F_HORA_SALIDA_REAL timestamp(0);
      F_HORA_SALIDA_REF_REAL varchar(10);
      L_HORA_SALIDA_REAL_S varchar(10);
      L_HORA_SALIDA_REAL_A varchar(10);
      L_HORA_SALIDA_BASE_S varchar(10);
      L_HORA_SALIDA_BASE_A varchar(10);
      L_HORA_SALIDA_BASE varchar(10);
      F_HORA_SALIDA_BASE timestamp(0);
      L_HORA_HASTA_REAL varchar(10);
      l_minutos decimal(10,2):=0;
      l_desde timestamp(0);
      l_hasta timestamp(0);
      L_HORA_ENT_BASE varchar(10);
      L_HORA_ENT_REAL varchar(10);

      l_query varchar(4000);

BEGIN
   
      DELETE FROM ENOC.TT_PROC_SOBRETIEMPO;

      
      l_query:='INSERT INTO ENOC.TT_PROC_SOBRETIEMPO(ID_SOBRETIEMPO) ';
      l_query:=l_query||'SELECT ';
      l_query:=l_query||'S.ID_SOBRETIEMPO ';
      l_query:=l_query||'from ENOC.PLLA_SOBRETIEMPO S, moises.trabajador t, eliseo.vw_sede_area sa ';
      l_query:=l_query||'where S.ID_TRABAJADOR=T.ID_TRABAJADOR ';
      l_query:=l_query||'AND t.id_sedearea=sa.id_sedearea ';
      l_query:=l_query||'and S.id_entidad = :p_entidad ';
      l_query:=l_query||'and S.id_depto = :p_depto ';
      IF (P_SEARCH IS NOT NULL AND P_SEARCH::text <> '') THEN
        l_query:=l_query||'and (upper(convert(t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.nombre||'' ''||t.paterno||'' ''||t.materno||t.num_documento, ''us7ascii'')) like ''%''||replace(replace(upper(convert('''||P_SEARCH||''' , ''us7ascii'')),'','','' ''),'' '',''%'')||''%'') ';
      END IF;
      IF P_ID_TRABAJADOR <> 0 AND (P_ID_TRABAJADOR IS NOT NULL AND P_ID_TRABAJADOR::text <> '') THEN
        l_query:=l_query||'and S.ID_TRABAJADOR = '||P_ID_TRABAJADOR||' ';
      END IF;
      IF P_ID_AREA>0 THEN
        l_query:=l_query||'and sa.id_area ='||P_ID_AREA||' ';
      END IF;
      IF (P_ID_ESTADO_SOBRETIEMPO IS NOT NULL AND P_ID_ESTADO_SOBRETIEMPO::text <> '') THEN
        l_query:=l_query||'and S.id_estado_sobretiempo ='||P_ID_ESTADO_SOBRETIEMPO||' ';
      END IF;
      l_query:=l_query||'and (S.fecha between :fdesde and :fhasta) ';
      l_query:=l_query||'and S.ID_ESTADO_SOBRETIEMPO not in(''06'',''00'') ';

      if (P_RESTRINGIDO = 'S') then
            if P_ID_TIPO_NIVEL_VISTA = 4 THEN
               l_query:=l_query||'and sa.id_area in( '||P_ID_AREAS||') ';
            END IF;
            if P_ID_TIPO_NIVEL_VISTA = 5 THEN
                l_query:=l_query||'and t.id_persona = '||P_ID_USER||' ';
            end if;
      end if;

      if P_RESTRINGIDO = 'U' then
            l_query:=l_query||'and t.id_persona = '||P_ID_USER||' ';
      end if;

      --dbms_output.put_line(l_query);
      EXECUTE l_query USING P_ID_ENTIDAD,P_ID_DEPTO,P_DESDE,P_HASTA;

   
    MERGE INTO enoc.PLLA_SOBRETIEMPO x 
    USING(
    SELECT
      s.ID_SOBRETIEMPO
      from ENOC.PLLA_SOBRETIEMPO S, moises.trabajador t, eliseo.vw_sede_area sa
      where S.ID_TRABAJADOR=T.ID_TRABAJADOR
      AND t.id_sedearea=sa.id_sedearea
      and s.id_sobretiempo in (SELECT ID_SOBRETIEMPO from ENOC.TT_PROC_SOBRETIEMPO) 
    )T ON (T.ID_SOBRETIEMPO=x.ID_SOBRETIEMPO)
    WHEN  MATCHED THEN UPDATE SET  
      x.HORA_DESDE_REAL = NULL, 
      x.HORA_HASTA_REAL = NULL, 
      x.HORA_BASE_SAL = NULL,
      x.HORA_BASE_ENT = NULL,
      x.HORA_SAL_REAL  = NULL,
      x.NUM_HORAS_REAL= 0,
      x.ID_USER_MOD=P_ID_USER,
      x.FECHA_MOD=clock_timestamp();

 
    FOR cur in person LOOP
    BEGIN
      if cur.codigo in ('HE','BH') then
      
        select count(*) into STRICT l_contar from ENOC.plla_asistencia 
        where id_trabajador=cur.id_trabajador 
        and fecha =cur.fecha;

        
        if l_contar=1 then
          select  HORA_SALIDA_REAL,HORA_BASE_SAL,HORA_BASE_ENT,HORA_ENTRADA_REAL 
          into STRICT  L_HORA_SALIDA_REAL_A ,L_HORA_SALIDA_BASE_A,L_HORA_ENT_BASE,L_HORA_ENT_REAL
          from ENOC.plla_asistencia 
          where id_trabajador=cur.id_trabajador 
          and fecha =cur.fecha;

          L_HORA_SALIDA_REAL:=L_HORA_SALIDA_REAL_A;
          L_HORA_SALIDA_BASE:=L_HORA_SALIDA_BASE_A;
        ELSE
          select count(*) into STRICT l_contar from ENOC.plla_asistencia
          where id_trabajador=cur.id_trabajador 
          and fecha =cur.fecha - 1;

          IF l_contar=1 THEN
            select coalesce(SAL_DIASIG,0), HORA_SALIDA_REAL ,HORA_BASE_SAL,HORA_BASE_ENT,HORA_ENTRADA_REAL
            into STRICT l_sal_diasig,L_HORA_SALIDA_REAL_S,L_HORA_SALIDA_BASE_S,L_HORA_ENT_BASE,L_HORA_ENT_REAL
            from ENOC.plla_asistencia 
            where id_trabajador=cur.id_trabajador 
            and fecha =cur.fecha - 1;

            IF l_sal_diasig=1 THEN
              L_HORA_SALIDA_REAL:=L_HORA_SALIDA_REAL_S;
              L_HORA_SALIDA_BASE:=L_HORA_SALIDA_BASE_S;
            ELSE
              L_HORA_SALIDA_REAL:=L_HORA_SALIDA_REAL_A;
              L_HORA_SALIDA_BASE:=L_HORA_SALIDA_BASE_A;
            END IF;
          END IF;

        END IF;

        IF (L_HORA_SALIDA_BASE IS NOT NULL AND L_HORA_SALIDA_BASE::text <> '') THEN
          F_HORA_SALIDA_BASE:= to_date(to_char(cur.fecha,'YYYY-MM-DD')||' '||L_HORA_SALIDA_BASE,'YYYY-MM-DD HH24:MI:SS');
        END IF;

        IF (L_HORA_SALIDA_REAL IS NOT NULL AND L_HORA_SALIDA_REAL::text <> '') THEN
          F_HORA_SALIDA_REAL:=to_date(to_char(cur.fecha,'YYYY-MM-DD')||' '||L_HORA_SALIDA_REAL,'YYYY-MM-DD HH24:MI:SS');
        END IF;

       
        
        IF (F_HORA_SALIDA_REAL IS NOT NULL AND F_HORA_SALIDA_REAL::text <> '') AND (F_HORA_SALIDA_BASE IS NOT NULL AND F_HORA_SALIDA_BASE::text <> '') THEN
           --dbms_output.put_line(to_char(F_HORA_SALIDA_REAL,'YYYY-MM-DD HH24:MI:SS')||'*'||to_char(F_HORA_SALIDA_BASE,'YYYY-MM-DD HH24:MI:SS'));
          IF F_HORA_SALIDA_REAL>F_HORA_SALIDA_BASE then
            l_desde:=cur.desde;
            if F_HORA_SALIDA_REAL>cur.hasta then
              l_hasta:=cur.hasta;
            else
              l_hasta:=F_HORA_SALIDA_REAL;
            end if;

            select round((l_hasta -  l_desde)*24,2) into STRICT l_minutos;
            L_HORA_HASTA_REAL:=TO_CHAR(l_hasta,'HH24:MI');
          end if;
        END IF;

        --IF l_minutos>0 THEN
          update ENOC.PLLA_SOBRETIEMPO set
            HORA_DESDE_REAL= cur.HORA_DESDE, 
            HORA_HASTA_REAL= L_HORA_HASTA_REAL,
            HORA_BASE_SAL=L_HORA_SALIDA_BASE,
            HORA_SAL_REAL =L_HORA_SALIDA_REAL,
            HORA_ENT_REAL=L_HORA_ENT_REAL,
            HORA_BASE_ENT=L_HORA_ENT_BASE,
            NUM_HORAS_REAL= l_minutos,
            PROCESADO=1,
            ID_USER_MOD=P_ID_USER,
            FECHA_MOD=clock_timestamp()
          where id_sobretiempo=cur.ID_SOBRETIEMPO;
        --END IF;
      else
        update ENOC.PLLA_SOBRETIEMPO set
          HORA_DESDE_REAL= cur.HORA_DESDE,
          HORA_HASTA_REAL= cur.HORA_HASTA, 
          NUM_HORAS_REAL= cur.NUM_HORAS,
          PROCESADO=1,
          ID_USER_MOD=P_ID_USER,
          FECHA_MOD=clock_timestamp()
        where id_sobretiempo=cur.ID_SOBRETIEMPO;
      end if;
    END;
    END LOOP;

   
   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_procesar_sobretiempo ( P_DESDE timestamp(0), P_HASTA timestamp(0), P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint, P_ID_ESTADO_SOBRETIEMPO text, P_SEARCH text, P_ID_AREAS text, P_RESTRINGIDO text, P_ID_TIPO_NIVEL_VISTA bigint, P_ID_USER bigint, P_ID_TRABAJADOR bigint DEFAULT 0) FROM PUBLIC;
