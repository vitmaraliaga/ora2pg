-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_justificar_asis_docente ( P_ID_ASISTENCIA_CARGA bigint, P_TIPO text,--J=JUSTIFICAR, E:ELIMINAR
 P_MOTIVO text, P_ID_USER bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

     l_error bigint:=0;
     l_msgerror varchar(200):='';
     l_contar bigint;
     l_fecha timestamp(0);
     l_id_trabajador bigint;
     l_id_depto varchar(10);

BEGIN
      
      
      select a.fecha,a.id_trabajador,c.id_depto_padre 
      into STRICT 
      l_fecha,l_id_trabajador,l_id_depto
      FROM  ENOC.PLLA_ASISTENCIA_CARGA  a , moises.trabajador t, ENOC.VW_ENT_DEP_AREA_CCOSTO C
      WHERE  a.id_trabajador=t.id_trabajador
      and t.id_sedearea = c.id_sedearea
      and a.ID_ASISTENCIA_CARGA= P_ID_ASISTENCIA_CARGA;

    
      IF P_TIPO = 'E' THEN
        UPDATE ENOC.PLLA_ASISTENCIA_CARGA SET
          DESDE_JUST  = NULL,
          HASTA_JUST  = NULL,
          JUSTIFICACION = P_MOTIVO,
          ID_USER_JUST=P_ID_USER,
          FECHA_JUST = clock_timestamp(),
          TIPO  = NULL,
          ID_USER_MOD=P_ID_USER,
          FECHA_MOD= clock_timestamp()
        WHERE ID_ASISTENCIA_CARGA= P_ID_ASISTENCIA_CARGA;
      ELSE
        UPDATE ENOC.PLLA_ASISTENCIA_CARGA SET
          DESDE_JUST=DESDE_PROG,
          HASTA_JUST = CASE WHEN  HASTA_PROG < clock_timestamp() THEN CASE WHEN HASTA_REAL = NULL THEN HASTA_PROG ELSE NULL END END,
          JUSTIFICACION = P_MOTIVO,
          ID_USER_JUST=P_ID_USER,
          FECHA_JUST = clock_timestamp(),
          TIPO = 'J',
          ID_USER_MOD=P_ID_USER,
          FECHA_MOD= clock_timestamp()
        WHERE ID_ASISTENCIA_CARGA= P_ID_ASISTENCIA_CARGA;
      END IF;

      enoc.CALL pkg_assistance_sp_procesar_asis_docente(
         l_fecha,--SI P_TIPO=FE OBLIAGATORIO
         l_id_depto,
         0,
         null,
         l_id_trabajador,
         'N',
         0,
         'FE',--AM: AÃ±o y Mes,FE: por fecha
         0, --SI P_TIPO=AM OBLIAGATORIO
         0, --SI P_TIPO=AM OBLIAGATORIO
         P_ID_USER,
         l_error,
         l_msgerror
       );

--       <<SALIDA>>  
      P_ERROR:=l_error;
      P_MSGERROR := l_msgerror;
   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_justificar_asis_docente ( P_ID_ASISTENCIA_CARGA bigint, P_TIPO text, P_MOTIVO text, P_ID_USER bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
