-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_registrar_marcacion ( P_ID_TRABAJADOR bigint, P_ID_TIPO_MARCACION bigint, P_FECHAHORA timestamp(0), P_FECHAHORA_MANUAL timestamp(0), P_LAT text, P_LNG text, P_IIDTERMINAL bigint, P_FOTOCHECK text, P_ID_SOLIC_JUSTIF bigint, P_TIPO text, P_ID_DESCRIP_MARCACION text, P_ID_USER_REG bigint, P_ERROR OUT bigint, P_MSGERROR out text, P_IDASISTENCIA NUMBERDEFAULTNULL ) AS $body$
DECLARE


           l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;
          l_items bigint;
          l_id_marcacion varchar(30);
          l_id_anho bigint;
          l_id_mes bigint;
          l_id_dia bigint;
          l_nro_dia bigint;


          l_num_documento varchar(20);
          l_id_mapa_trabajador bigint;
          l_id_mapa_area bigint;
          l_tipo_hora varchar(10);
          l_id_entidad bigint;
          l_id_depto_padre varchar(10);
          l_id_area bigint;
          l_id_persona bigint;
          l_id_situacion_trabajador varchar(5);
          l_fecha_reg timestamp(0);


BEGIN
        
        l_fecha_reg:=P_FECHAHORA;
        if coalesce(l_fecha_reg::text, '') = '' then
          l_fecha_reg:=P_FECHAHORA_MANUAL;
        end if;

         select 
         (to_char(l_fecha_reg,'YYYY'))::numeric , 
         (to_char(l_fecha_reg,'MM'))::numeric ,
         (to_char(l_fecha_reg,'DD'))::numeric ,
         (TO_CHAR(l_fecha_reg, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))::numeric  
         into STRICT l_id_anho,l_id_mes,l_id_dia,l_nro_dia;

         select count(*) into STRICT l_contar from ENOC.PLLA_ASISTENCIA_HIST
         where ID_ANHO=l_id_anho
         and id_mes=l_id_mes
         and id_dia=l_id_dia
         and id_trabajador=P_ID_TRABAJADOR;

         if l_contar=0 then
          enoc.CALL pkg_assistance_sp_asistencia_historico(P_ID_TRABAJADOR,l_fecha_reg, P_ID_USER_REG,l_error,l_msgerror);
           /* if l_error=1 then
--              GOTO SALIDA;
            end if;*/
         end if;

         select coalesce(max(ITEMS),0) + 1 into STRICT l_items from ENOC.PLLA_MARCACION
         where ID_ANHO=l_id_anho
         and id_mes=l_id_mes
         and id_dia=l_id_dia;

         l_id_marcacion:= to_char(l_fecha_reg,'YYYYMMDD')||l_items::text;

         select num_documento into STRICT l_num_documento  from enoc.vw_trabajador where id_trabajador=P_ID_TRABAJADOR;

         INSERT INTO ENOC.PLLA_MARCACION(
          ID_MARCACION,
          ITEMS,
          ID_TRABAJADOR,
          ID_ANHO,
          ID_MES,
          ID_DIA,
          NRO_DIA,
          ID_TIPO_MARCACION,
          FECHAHORA,
          FECHAHORA_MANUAL,
          LAT,
          LNG,
          ID_SOLIC_JUSTIF,
          NUM_DOCUMENTO,
          IIDTERMINAL,
          FOTOCHECK,
          TIPO,
          ID_DESCRIP_MARCACION,
          ID_USER_REG,
          FECHA_REG,
          IDASISTENCIA
         )VALUES (
          l_id_marcacion,
          l_items,
          P_ID_TRABAJADOR,
          l_id_anho,
          l_id_mes,
          l_id_dia,
          l_nro_dia,
          P_ID_TIPO_MARCACION,
          P_FECHAHORA,
          P_FECHAHORA_MANUAL,
          P_LAT,
          P_LNG,
          P_ID_SOLIC_JUSTIF,
          l_num_documento,
          P_IIDTERMINAL,
          P_FOTOCHECK,
          P_TIPO,
          P_ID_DESCRIP_MARCACION,
          P_ID_USER_REG,
          clock_timestamp(),
          P_IDASISTENCIA
         );
--           <<SALIDA>>
         P_ERROR:=l_error;
         P_MSGERROR:= l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_registrar_marcacion ( P_ID_TRABAJADOR bigint, P_ID_TIPO_MARCACION bigint, P_FECHAHORA timestamp(0), P_FECHAHORA_MANUAL timestamp(0), P_LAT text, P_LNG text, P_IIDTERMINAL bigint, P_FOTOCHECK text, P_ID_SOLIC_JUSTIF bigint, P_TIPO text, P_ID_DESCRIP_MARCACION text, P_ID_USER_REG bigint, P_ERROR OUT bigint, P_MSGERROR out text, P_IDASISTENCIA NUMBERDEFAULTNULL ) FROM PUBLIC;
