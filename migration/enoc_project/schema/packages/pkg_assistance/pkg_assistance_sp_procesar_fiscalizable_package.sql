-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_procesar_fiscalizable ( P_ID_TRABAJADOR bigint, P_FECHA timestamp(0), P_ID_TIPO_HORARIO bigint, P_ID_SEDEAREA bigint, P_ID_MOTIVO_ASIST text, P_NUM_RANGO bigint, P_NUM_RANGO_REF bigint, P_ID_USER bigint ) AS $body$
DECLARE


      l_control bigint:=0;
      f_hora_entrada timestamp(0);
      f_hora_salida timestamp(0);
      f_hora_entrada_ref timestamp(0);
      f_hora_salida_ref timestamp(0);
      l_hora_entrada varchar(10);
      l_hora_salida varchar(10);
      l_hora_entrada_ref varchar(10);
      l_hora_salida_ref varchar(10);
      l_anho bigint:=0;
      l_mes bigint:=0;
      l_dia bigint:=0;
      l_nrodia bigint:=0;
      l_codigo varchar(10);
      l_codigo_asist varchar(10);
      l_contar bigint;
      l_contarh bigint;
      l_desde_rango timestamp(0);
      l_hasta_rango timestamp(0);
      l_id_entidad bigint;
      l_sal_diasig bigint;

      b_hora_entrada timestamp(0);
      b_hora_salida timestamp(0);
      b_hora_entrada_ref timestamp(0);
      b_hora_salida_ref timestamp(0);

      
BEGIN
      
       
        SELECT 
        ID_ENTIDAD
        into STRICT
        l_id_entidad
        FROM eliseo.vw_sede_area
        WHERE ID_SEDEAREA=P_ID_SEDEAREA;

        if P_ID_MOTIVO_ASIST in ('A','PLH') then
          l_control:=1;
        else
          if P_ID_MOTIVO_ASIST in ('FN', 'FNL','FI','SA','DO') then
             select count(*) into STRICT l_contar  from enoc.vw_marcacion
             where id_trabajador=P_ID_TRABAJADOR
             and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD') = to_char(P_FECHA,'YYYY-MM-DD');

             if l_contar>0 then
                l_control:=1;
             end if;
          end if;
        end if;

        if l_control=1 then
        
           select 
           (to_char(P_FECHA,'YYYY'))::numeric ,(to_char(P_FECHA,'MM'))::numeric ,(to_char(P_FECHA,'DD'))::numeric , (TO_CHAR(P_FECHA, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))::numeric 
           into STRICT 
           l_anho,l_mes,l_dia,l_nrodia 
;

           select b.codigo into STRICT l_codigo from enoc.plla_tipo_horario a, ENOC.PLLA_TIPO_CONFIG_HORARIO b
           where a.ID_TIPO_CONFIG_HORARIO=b.ID_TIPO_CONFIG_HORARIO
           and a.id_tipo_horario = P_ID_TIPO_HORARIO;

           if l_codigo ='HM' then
           
             select 
             c.codigo, 
             bl.HORA_ENTRADA,
             bl.HORA_SALIDA,
             bl.HORA_ENTRADA_REF,
             bl.HORA_SALIDA_REF,
             bl.SAL_DIASIG
             into STRICT
             l_codigo_asist,
             l_hora_entrada,
             l_hora_salida,
             l_hora_entrada_ref,
             l_hora_salida_ref,
             l_sal_diasig
             from enoc.plla_horario_mensual m , enoc.plla_horario_mensual_det d, enoc.plla_horario_bloque bl, enoc.plla_control_asist c
             where m.id_horario_mensual=d.id_horario_mensual
             and d.id_horario_bloque=bl.id_horario_bloque
             AND M.ID_TIPO_HORARIO=P_ID_TIPO_HORARIO
             and bl.id_control_asist=c.id_control_asist
             and m.id_anho=l_anho
             and m.id_mes =l_mes
             and d.id_dia=l_dia;

           else
             select  
             c.codigo, 
             a.HORA_ENTRADA,
             a.HORA_SALIDA,
             a.HORA_ENTRADA_REF,
             a.HORA_SALIDA_REF,
             a.SAL_DIASIG
             into STRICT
             l_codigo_asist,
             l_hora_entrada,
             l_hora_salida,
             l_hora_entrada_ref,
             l_hora_salida_ref,
             l_sal_diasig
             from enoc.plla_horario_detalle a, enoc.plla_control_asist c
             where a.id_control_asist=c.id_control_asist
             and a.id_tipo_horario=P_ID_TIPO_HORARIO
             and a.id_dia=l_nrodia;
           end if;

           
           --entrada
           b_hora_entrada:= to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada,'YYYY-MM-DD HH24:MI:SS');
           l_desde_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada,'YYYY-MM-DD HH24:MI:SS') - P_NUM_RANGO / 1440;
           l_hasta_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada,'YYYY-MM-DD HH24:MI:SS') + P_NUM_RANGO / 1440;

           --dbms_output.put_line(P_NUM_RANGO);
           --dbms_output.put_line(TO_CHAR(b_hora_entrada, 'YYYY-MM-DD'));
          -- dbms_output.put_line(TO_CHAR(l_desde_rango, 'YYYY-MM-DD HH24:MI:SS'));
           --dbms_output.put_line(TO_CHAR(l_hasta_rango, 'YYYY-MM-DD HH24:MI:SS'));
           
           if P_ID_MOTIVO_ASIST in ('PLH') then
             select count(*) into STRICT l_contarh from enoc.VW_LICENCIA_PERMISO_ASIST 
             where id_trabajador=P_ID_TRABAJADOR
             and periodo='H'
             and id_estado_lica_per not in ('00','04')
             AND (to_date(TO_CHAR(b_hora_entrada, 'MM/DD/YYYY'),'MM/DD/YYYY') between fecha_desde and fecha_hasta );

             if l_contarh>0 then
              f_hora_entrada:=b_hora_entrada;
             end if;
           end if;

           
           if coalesce(f_hora_entrada::text, '') = '' then  
             select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
             and coalesce(ID_DESCRIP_MARCACION,'X')= '01'
             and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');

             if l_contar>0 then
              select min(FECHAHORAASISTENCIA) into STRICT f_hora_entrada from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
              and coalesce(ID_DESCRIP_MARCACION,'X')= '01'
              and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');
             else
              select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
              and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);

              if l_contar>0 then
                select min(FECHAHORAASISTENCIA) into STRICT f_hora_entrada from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
                and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);
              end if;
             end if;
           end if;

          
           
           if l_codigo_asist in ('REFCMA','DOTU') then
             --salida ref
             b_hora_salida_ref:=to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida_ref,'YYYY-MM-DD HH24:MI:SS');
             l_desde_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida_ref,'YYYY-MM-DD HH24:MI:SS') - P_NUM_RANGO / 1440;--P_NUM_RANGO_REF
             l_hasta_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida_ref,'YYYY-MM-DD HH24:MI:SS') + P_NUM_RANGO_REF / 1440;

             RAISE NOTICE '%', TO_CHAR(l_desde_rango, 'YYYY-MM-DD HH24:MI:SS');
             RAISE NOTICE '%', TO_CHAR(l_hasta_rango, 'YYYY-MM-DD HH24:MI:SS');

             if P_ID_MOTIVO_ASIST in ('PLH') then
              
               select count(*) into STRICT l_contarh from enoc.VW_LICENCIA_PERMISO_ASIST 
               where id_trabajador=P_ID_TRABAJADOR
               and periodo='H'
               and id_estado_lica_per not in ('00','04')
               AND (to_date(TO_CHAR(b_hora_salida_ref, 'MM/DD/YYYY'),'MM/DD/YYYY') between fecha_desde and fecha_hasta );

               if l_contarh>0 then
                 f_hora_salida_ref:=b_hora_salida_ref;
               end if;

             end if;

             if coalesce(f_hora_salida_ref::text, '') = '' then
             
               select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
               and coalesce(ID_DESCRIP_MARCACION,'X')= '02'
               and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');

               if l_contar>0 then
                select max(FECHAHORAASISTENCIA) into STRICT f_hora_salida_ref from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
                and coalesce(ID_DESCRIP_MARCACION,'X')= '02'
                and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');
               else
                 select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
                and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);

                 if l_contar>0 then
                  select max(FECHAHORAASISTENCIA) into STRICT f_hora_salida_ref from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
                  and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);
                 end if;
                end if;
             end if;

             
           
             --entrada ref
             b_hora_entrada_ref:=to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada_ref,'YYYY-MM-DD HH24:MI:SS');
             l_desde_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada_ref,'YYYY-MM-DD HH24:MI:SS') - P_NUM_RANGO_REF / 1440;
             l_hasta_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada_ref,'YYYY-MM-DD HH24:MI:SS') + P_NUM_RANGO / 1440;--P_NUM_RANGO_REF
             
             
             --dbms_output.put_line(TO_CHAR(l_desde_rango, 'YYYY-MM-DD HH24:MI:SS'));
             --dbms_output.put_line(TO_CHAR(l_hasta_rango, 'YYYY-MM-DD HH24:MI:SS'));
             if P_ID_MOTIVO_ASIST in ('PLH') then
              
                select count(*) into STRICT l_contarh from enoc.VW_LICENCIA_PERMISO_ASIST 
                where id_trabajador=P_ID_TRABAJADOR
                and periodo='H'
                and id_estado_lica_per not in ('00','04')
                AND (to_date(TO_CHAR(b_hora_entrada_ref, 'MM/DD/YYYY'),'MM/DD/YYYY') between fecha_desde and fecha_hasta );

                if l_contarh>0 then
                  f_hora_entrada_ref:=b_hora_entrada_ref;
                end if;
             end if;
             if coalesce(f_hora_entrada_ref::text, '') = '' then
               select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
               and coalesce(ID_DESCRIP_MARCACION,'X')= '03'
               and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');

               if l_contar>0 then
                select min(FECHAHORAASISTENCIA) into STRICT f_hora_entrada_ref from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
                and coalesce(ID_DESCRIP_MARCACION,'X')= '03'
                and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');
               else
                 select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
                 and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);

                 if l_contar>0 then
                  select min(FECHAHORAASISTENCIA) into STRICT f_hora_entrada_ref from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
                  and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);
                 end if;
               end if;
            end if;
           end if;
           --salida
           b_hora_salida:= to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida,'YYYY-MM-DD HH24:MI:SS');
           l_desde_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida,'YYYY-MM-DD HH24:MI:SS') - P_NUM_RANGO / 1440;
           l_hasta_rango := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida,'YYYY-MM-DD HH24:MI:SS') + (P_NUM_RANGO + 300) / 1440;
           if l_sal_diasig=1 then
            l_hasta_rango := to_date(TO_CHAR(P_FECHA + 1, 'YYYY-MM-DD')||' '||l_hora_salida,'YYYY-MM-DD HH24:MI:SS') + (P_NUM_RANGO + 300) / 1440;
           end if;

           
           
           if P_ID_MOTIVO_ASIST in ('PLH') then
              
              select count(*) into STRICT l_contarh from enoc.VW_LICENCIA_PERMISO_ASIST 
              where id_trabajador=P_ID_TRABAJADOR
              and periodo='H'
              and id_estado_lica_per not in ('00','04')
              AND (to_date(TO_CHAR(b_hora_salida, 'MM/DD/YYYY'),'MM/DD/YYYY') between fecha_desde and fecha_hasta );

              if l_contarh>0 then
                f_hora_salida:=b_hora_salida;
              end if;
           end if;

           if coalesce(f_hora_salida::text, '') = '' then
               select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
               and coalesce(ID_DESCRIP_MARCACION,'X')= '04'
               and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');

               if l_contar>0 then
                select max(FECHAHORAASISTENCIA) into STRICT f_hora_salida from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
                and coalesce(ID_DESCRIP_MARCACION,'X')= '04'
                and to_char(FECHAHORAASISTENCIA,'YYYY-MM-DD')=to_char(P_FECHA,'YYYY-MM-DD');
               else
                 select count(*) into STRICT l_contar from  enoc.vw_marcacion where id_trabajador= P_ID_TRABAJADOR
                 and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);

                 if l_contar>0 then
                  select max(FECHAHORAASISTENCIA) into STRICT f_hora_salida from  enoc.vw_marcacion where id_trabajador=P_ID_TRABAJADOR  
                  and (FECHAHORAASISTENCIA BETWEEN l_desde_rango AND l_hasta_rango);
                 end if;
              end if;
          end if;

        end if;


        CALL ENOC.pkg_assistance_sp_registrar_asistencia(
                                  l_id_entidad,
                                  P_ID_TRABAJADOR,
                                  P_ID_SEDEAREA,
                                  P_ID_TIPO_HORARIO,
                                  P_ID_MOTIVO_ASIST,
                                  P_FECHA,
                                  f_hora_entrada,
                                  f_hora_salida,
                                  f_hora_entrada_ref,
                                  f_hora_salida_ref,
                                  'F', 
                                  P_ID_USER
                                  );

         
      
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_procesar_fiscalizable ( P_ID_TRABAJADOR bigint, P_FECHA timestamp(0), P_ID_TIPO_HORARIO bigint, P_ID_SEDEAREA bigint, P_ID_MOTIVO_ASIST text, P_NUM_RANGO bigint, P_NUM_RANGO_REF bigint, P_ID_USER bigint ) FROM PUBLIC;
