-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_copiar_marcacion (P_DESDE timestamp(0), P_HASTA timestamp(0)) AS $body$
DECLARE

        asist CURSOR FOR
        SELECT
          a.ID_TRABAJADOR,
          a.IDASISTENCIA,
          a.IDPERSONAL,
          a.FECHA,
          a.FECHAHORA,
          a.TIPOINGRESO,
          a.TIPOMARCACION,
          a.NUM_MARCADOR,
          a.NUMDOCUMENTO,
          a.FOTOCHECK,
          t.id_persona
        from enoc.PLLA_ASIST_MARCACION a, moises.trabajador t
        where a.id_trabajador= t.id_trabajador
        and (a.FECHA BETWEEN P_DESDE AND P_HASTA)
        and a.FECHAHORA not in (
          SELECT FECHAHORA from  enoc.PLLA_MARCACION x
          where x.id_trabajador=a.id_trabajador
        );
        l_error bigint;
        l_msg varchar(200);

      
BEGIN
      
        DELETE FROM enoc.PLLA_ASIST_MARCACION WHERE FECHA BETWEEN  P_DESDE AND P_HASTA;

   
        INSERT INTO enoc.PLLA_ASIST_MARCACION(
          ITEMS,
          ID_TRABAJADOR,
          IDASISTENCIA,
          IDPERSONAL,
          FECHA,
          FECHAHORA,
          TIPOINGRESO,
          TIPOMARCACION,
          NUM_MARCADOR,
          NUMDOCUMENTO,
          FOTOCHECK
        )
        SELECT 
        ROW_NUMBER() OVER (PARTITION BY ID_TRABAJADOR,fecha ORDER BY IDASISTENCIA) AS Items,
        ID_TRABAJADOR,
        IDASISTENCIA,
        IDPERSONAL,
        FECHA,
        FECHAHORA,
        TIPOINGRESO,
        TIPOMARCACION,
        NUM_MARCADOR,
        NUMDOCUMENTO,
        FOTOCHECK
        from enoc.PLLA_ASIST_MARCACION_TMP
        WHERE COALESCE(ID_TRABAJADOR,0)>0 
        ORDER BY ID_TRABAJADOR,FECHAHORA;

        FOR cur in asist LOOP
        BEGIN
            enoc.CALL pkg_assistance_sp_registrar_marcacion(
            cur.id_trabajador, 
            2,
            cur.FECHAHORA, 
            null,
            null,
            null,
            cur.NUM_MARCADOR,
            cur.FOTOCHECK,
            null,
            'A',
            null,
            cur.id_persona, 
            l_error,
            l_msg
          );
        end;
        end loop;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_copiar_marcacion (P_DESDE timestamp(0), P_HASTA timestamp(0)) FROM PUBLIC;
