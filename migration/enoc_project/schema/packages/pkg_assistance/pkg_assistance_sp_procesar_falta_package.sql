-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_procesar_falta ( P_DESDE timestamp(0), P_HASTA timestamp(0), P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint, P_ID_TRABAJADOR bigint, P_ID_USER bigint ) AS $body$
DECLARE


       person CURSOR FOR
        SELECT
          S.id_asistencia,
          t.id_trabajador,
          S.FECHA,
          sa.id_entidad,
          sa.id_depto_padre,
          sa.id_area
          from ENOC.PLLA_ASISTENCIA S, moises.trabajador t, eliseo.vw_sede_area sa
          where S.ID_TRABAJADOR=T.ID_TRABAJADOR
          AND t.id_sedearea=sa.id_sedearea
          and sa.id_entidad=P_ID_ENTIDAD
          and sa.id_depto_padre=P_ID_DEPTO
          and s.ID_MOTIVO_ASIST='A'
          and coalesce(s.num_horas,0)=0
          and coalesce(s.num_horas_real,0)=0
          and s.id_asistencia not in (
            SELECT w.id_asistencia from enoc.PLLA_LICENCIA_PERMISO w
            where w.id_trabajador=s.id_trabajador
          )
          and case when P_ID_AREA=0 then 0 else sa.id_area end = case when P_ID_AREA=0 then 0 else P_ID_AREA end
          and case when P_ID_TRABAJADOR=0 then 0 else s.id_trabajador end = case when P_ID_TRABAJADOR=0 then 0 else P_ID_TRABAJADOR end
          and (S.FECHA between P_DESDE and P_HASTA) 
          order  by t.id_trabajador;

          l_contar bigint;
          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_id_licencia_permiso bigint;
          l_id_licencia_permiso_estado bigint;
          l_id_estado_lica_per varchar(5);
          l_id_concepto_perm_lic bigint;

BEGIN
   
       
 
    FOR cur in person LOOP
    BEGIN
        SELECT id_concepto_perm_lic INTO STRICT  l_id_concepto_perm_lic FROM ENOC.PLLA_CONCEPTO_PERM_LIC WHERE CODIGO='FALTA';
        
        enoc.CALL pkg_benefits_sp_registrar_licencia_permiso(
          l_id_concepto_perm_lic, 	
          cur.id_entidad, 
          cur.id_depto_padre, 
          cur.id_area, 
          cur.id_trabajador, 
          'D', 
          'Falta automatico '||to_char(clock_timestamp(),'YYYY-MM-DD HH24:MI:SS'),	
          cur.fecha, 
          cur.fecha,
          null,
          null,
          null,
          null,
          null,
          P_ID_USER, 
          null,
          'A',
          l_error,
          l_msgerror, 
          l_id_licencia_permiso
        );

        if l_error =0 then
        
          update ENOC.PLLA_LICENCIA_PERMISO set
            id_asistencia= cur.id_asistencia, 
            ID_USER_MOD=P_ID_USER,
            FECHA_MOD=clock_timestamp()
          where id_licencia_permiso=l_id_licencia_permiso;

          --aprobar
          -- 02	Aprobado por Jefe
          -- 03	Aprobado por DTH
          l_id_estado_lica_per:='03';
          select COALESCE(MAX(ID_LICENCIA_PERMISO_ESTADO),0) +1 INTO STRICT   l_id_licencia_permiso_estado from PLLA_LICENCIA_PERMISO_ESTADO;

          INSERT INTO enoc.PLLA_LICENCIA_PERMISO_ESTADO(
             ID_LICENCIA_PERMISO_ESTADO,
             ID_LICENCIA_PERMISO,
             ID_ESTADO_LICA_PER,
             COMENTARIO,
             ID_USER_REG,
             FECHA_REG
           )VALUES (
            l_id_licencia_permiso_estado,
            l_id_licencia_permiso,
            l_id_estado_lica_per,
            null,
            P_ID_USER,
            clock_timestamp()
           );

           update ENOC.PLLA_LICENCIA_PERMISO set
            ID_ESTADO_LICA_PER= l_id_estado_lica_per, 
            ID_USER_MOD=P_ID_USER,
            FECHA_MOD=clock_timestamp()
          where id_licencia_permiso=l_id_licencia_permiso;

        end if;

    END;
    END LOOP;

   
   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_procesar_falta ( P_DESDE timestamp(0), P_HASTA timestamp(0), P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint, P_ID_TRABAJADOR bigint, P_ID_USER bigint ) FROM PUBLIC;
