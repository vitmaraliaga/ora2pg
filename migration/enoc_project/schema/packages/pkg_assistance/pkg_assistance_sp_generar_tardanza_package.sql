-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_generar_tardanza (P_ID_ASISTENCIA text,P_ID_USER_REG bigint) AS $body$
DECLARE


       l_num_tole_tar bigint:=0;
       l_num_tole_tar_ref bigint:=0;
       l_fecha timestamp(0);
       l_id_entidad bigint;

       L_HORA_ENTRADA varchar(10);
       L_HORA_BASE_ENT  varchar(10);
       L_HORA_ENTRADA_REF  varchar(10);
       L_HORA_BASE_ENT_REF  varchar(10);
       L_HORA_SALIDA  varchar(10);
       L_HORA_BASE_SAL  varchar(10);
       L_HORA_SALIDA_REF  varchar(10);
       L_HORA_BASE_SAL_REF  varchar(10);

       F_HORA_ENTRADA timestamp(0);
       F_HORA_BASE_ENT  timestamp(0);
       F_HORA_ENTRADA_REF  timestamp(0);
       F_HORA_BASE_ENT_REF  timestamp(0);
       F_HORA_SALIDA  timestamp(0);
       F_HORA_BASE_SAL  timestamp(0);
       F_HORA_SALIDA_REF  timestamp(0);
       F_HORA_BASE_SAL_REF  timestamp(0);

       N_MINUTOS_TAR_ENT decimal(10,2):= 0;
       N_MINUTOS_TAR_REF decimal(10,2):= 0;
       N_MINUTOS_TAR decimal(10,2):= 0;
       N_MINUTOS_TAR_SAL decimal(10,2):= 0;
       N_MINUTOS_TAR_SAL_REF decimal(10,2):= 0;

       l_contar bigint;
       l_id_trabajador bigint;

      
BEGIN
      
      --Generar tardanza
        select 
        FECHA, 
        HORA_ENTRADA,
        HORA_BASE_ENT,
        HORA_ENTRADA_REF,
        HORA_BASE_ENT_REF,
        HORA_SALIDA,
        HORA_BASE_SAL,
        HORA_SALIDA_REF,
        HORA_BASE_SAL_REF,
        NUM_TOLE_TAR, 
        NUM_TOLE_TAR_REF,
        ID_TRABAJADOR
        into STRICT 
        l_fecha,
        L_HORA_ENTRADA,
        L_HORA_BASE_ENT,
        L_HORA_ENTRADA_REF,
        L_HORA_BASE_ENT_REF,
        L_HORA_SALIDA,
        L_HORA_BASE_SAL,
        L_HORA_SALIDA_REF,
        L_HORA_BASE_SAL_REF,
        l_num_tole_tar,
        l_num_tole_tar_ref,
        l_id_trabajador
        from plla_asistencia 
        where id_asistencia=P_ID_ASISTENCIA;

        
        update PLLA_ASISTENCIA set
            NUM_MINUTOS_TAR_ENT  = 0,
            NUM_MINUTOS_TAR_REF  =  0,
            NUM_MINUTOS_TAR  = 0,
            NUM_MINUTOS_TAR_SAL=0, 
            NUM_MINUTOS_TAR_SAL_REF=0, 
            ID_USER_REG = P_ID_USER_REG,
            FECHA_REG = clock_timestamp()
         WHERE ID_ASISTENCIA= P_ID_ASISTENCIA;


        --TARDANZA ENTRADA
        IF (L_HORA_ENTRADA IS NOT NULL AND L_HORA_ENTRADA::text <> '') THEN
          F_HORA_ENTRADA:=to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_ENTRADA,'YYYY-MM-DD HH24:MI:SS');
          F_HORA_BASE_ENT:=(to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_BASE_ENT,'YYYY-MM-DD HH24:MI:SS') + l_num_tole_tar / 1440);
          IF F_HORA_ENTRADA>F_HORA_BASE_ENT THEN

            N_MINUTOS_TAR_ENT:= round((F_HORA_ENTRADA - F_HORA_BASE_ENT)*1440,2);
            IF N_MINUTOS_TAR_ENT>0  THEN
              update PLLA_ASISTENCIA set
                NUM_TOLE_TAR  = l_num_tole_tar,
                NUM_MINUTOS_TAR_ENT  =  N_MINUTOS_TAR_ENT,
                ID_USER_REG = P_ID_USER_REG,
                FECHA_REG = clock_timestamp()
              WHERE ID_ASISTENCIA= P_ID_ASISTENCIA;
            END IF;
          END IF;
        END IF;

        --ANTES DE SALIDA REF
        IF (L_HORA_SALIDA_REF IS NOT NULL AND L_HORA_SALIDA_REF::text <> '') THEN
          F_HORA_SALIDA_REF:=(to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_SALIDA_REF,'YYYY-MM-DD HH24:MI:SS') + l_num_tole_tar_ref / 1440);
          F_HORA_BASE_ENT_REF:= to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_SALIDA_REF,'YYYY-MM-DD HH24:MI:SS');
          IF F_HORA_SALIDA_REF<F_HORA_BASE_ENT_REF THEN

            N_MINUTOS_TAR_SAL_REF:= round((F_HORA_BASE_ENT-F_HORA_ENTRADA)*1440,2);
            IF N_MINUTOS_TAR_SAL_REF>0 THEN
              update PLLA_ASISTENCIA set
                NUM_TOLE_TAR  = l_num_tole_tar_ref,
                NUM_MINUTOS_TAR_SAL_REF  =  N_MINUTOS_TAR_SAL_REF,
                ID_USER_REG = P_ID_USER_REG,
                FECHA_REG = clock_timestamp()
              WHERE ID_ASISTENCIA= P_ID_ASISTENCIA;
            END IF;
          END IF;
        END IF;

        --TARDANZA ENTRADA REF
        IF (L_HORA_ENTRADA_REF IS NOT NULL AND L_HORA_ENTRADA_REF::text <> '') THEN
          F_HORA_ENTRADA_REF:=to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_ENTRADA_REF,'YYYY-MM-DD HH24:MI:SS');
          F_HORA_BASE_ENT_REF:=(to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_BASE_ENT_REF,'YYYY-MM-DD HH24:MI:SS') + l_num_tole_tar_ref / 1440);
          IF F_HORA_ENTRADA_REF>F_HORA_BASE_ENT_REF THEN

            N_MINUTOS_TAR_REF:= round((F_HORA_ENTRADA_REF - F_HORA_BASE_ENT_REF)*1440,2);
            IF N_MINUTOS_TAR_REF>0  THEN
              update PLLA_ASISTENCIA set
                NUM_TOLE_TAR_REF  = l_num_tole_tar_ref,
                NUM_MINUTOS_TAR_REF  =  N_MINUTOS_TAR_REF,
                ID_USER_REG = P_ID_USER_REG,
                FECHA_REG = clock_timestamp()
              WHERE ID_ASISTENCIA= P_ID_ASISTENCIA;
            END IF;
          END IF;
        END IF;

        --ANTES DE SALIDA 
        
        IF (L_HORA_SALIDA IS NOT NULL AND L_HORA_SALIDA::text <> '') THEN
          F_HORA_SALIDA:=(to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_SALIDA,'YYYY-MM-DD HH24:MI:SS') + l_num_tole_tar / 1440);
          F_HORA_BASE_SAL:= to_date(TO_CHAR(l_fecha, 'YYYY-MM-DD')||' '||L_HORA_BASE_SAL,'YYYY-MM-DD HH24:MI:SS');
          IF F_HORA_SALIDA<F_HORA_BASE_SAL THEN

            N_MINUTOS_TAR_SAL:= round((F_HORA_BASE_SAL-F_HORA_SALIDA)*1440,2);
            IF N_MINUTOS_TAR_SAL>0 THEN
              update PLLA_ASISTENCIA set
                NUM_TOLE_TAR  = l_num_tole_tar,
                NUM_MINUTOS_TAR_SAL  =  N_MINUTOS_TAR_SAL,
                ID_USER_REG = P_ID_USER_REG,
                FECHA_REG = clock_timestamp()
              WHERE ID_ASISTENCIA= P_ID_ASISTENCIA;
            END IF;
          END IF;
        END IF;

        update PLLA_ASISTENCIA set
            NUM_MINUTOS_TAR  = NUM_MINUTOS_TAR_ENT + NUM_MINUTOS_TAR_REF + NUM_MINUTOS_TAR_SAL + N_MINUTOS_TAR_SAL_REF,
            ID_USER_REG = P_ID_USER_REG,
            FECHA_REG = clock_timestamp()
         WHERE ID_ASISTENCIA= P_ID_ASISTENCIA;

        
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_generar_tardanza (P_ID_ASISTENCIA text,P_ID_USER_REG bigint) FROM PUBLIC;
