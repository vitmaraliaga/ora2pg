-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_planilla,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_planilla_sp_gen_planilla_trab (P_ID_PLANILLA bigint,P_ID_TRABAJADOR bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_entidad bigint;
    l_id_depto varchar(10);
    l_id_grupo_planilla bigint;
    l_id_tipo_planilla bigint;
    l_id_anho bigint;
    l_id_mes bigint;
    l_id_planilla_trab varchar(50);
    curtrab CURSOR FOR
    SELECT
    t.id_trabajador
    from moises.trabajador t,ENOC.vw_ent_dep_area_ccosto b
    where t.id_sedearea=b.id_sedearea
    and t.id_entidad     = l_id_entidad
    and b.id_depto_padre = l_id_depto
    and t.id_grupo_planilla = l_id_grupo_planilla
    and t.id_situacion_trabajador in ('1','2') --ACTIVO O SUBSIDIADO, SIN V√çNCULO LABORAL CON CONCEPTOS PENDIENTE DE LIQUIDAR
    and case when P_ID_TRABAJADOR =0 then 0 else  t.id_trabajador end = case when P_ID_TRABAJADOR =0 then 0 else  P_ID_TRABAJADOR end
    order by t.id_trabajador;

    
  
BEGIN
  
    --ELIMINAR
    CALL pkg_planilla_sp_eliminar_planilla_trab(P_ID_PLANILLA,P_ID_TRABAJADOR);

    select 
    a.ID_TIPO_PLANILLA,
    a.ID_GRUPO_PLANILLA,
    a.ID_ENTIDAD,
    a.ID_DEPTO,
    b.ID_ANHO,
    b.ID_MES
    into STRICT
    l_id_tipo_planilla,
    l_id_grupo_planilla,
    l_id_entidad,
    l_id_depto,
    l_id_anho,
    l_id_mes
    FROM ENOC.PLLA_CONFIG_PLANILLA A,ENOC.PLLA_PLANILLA B
    WHERE A.ID_CONFIG_PLANILLA=B.ID_CONFIG_PLANILLA
    AND B.ID_PLANILLA=P_ID_PLANILLA;

    
    FOR curT in curtrab LOOP
    BEGIN
        CALL pkg_planilla_sp_insertar_planilla_trab(curT.id_trabajador,P_ID_PLANILLA,l_id_anho,l_id_mes,P_ID_USER,l_id_planilla_trab, l_error,l_msgerror);
        --dbms_output.put_line(l_error||'*'||l_id_planilla_trab);
        if l_error=0 then
          CALL pkg_planilla_sp_gen_planilla_trab_det(l_id_planilla_trab,P_ID_USER,l_error,l_msgerror);
        end if;
    END;
    END LOOP;
--     <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_planilla_sp_gen_planilla_trab (P_ID_PLANILLA bigint,P_ID_TRABAJADOR bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
