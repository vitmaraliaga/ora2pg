-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_planilla,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_planilla_sp_gen_planilla_trab_det (P_ID_PLANILLA_TRAB text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_config_planilla bigint;
    l_importe decimal(10,2):=0;
    l_num_error bigint:=0;
    i_ingreso decimal(10,2):=0;
    l_apor_empl decimal(10,2):=0;
    l_descuento decimal(10,2):=0;
    l_apor_trab decimal(10,2):=0;
    l_neto decimal(10,2):=0;

  curD RECORD;

BEGIN
    select
    ID_CONFIG_PLANILLA
    into STRICT
    l_id_config_planilla
    from enoc.VW_PLANILLA_TRAB
    where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;

    FOR curD in (SELECT ID_CONFIG_PLANILLA_CONCEPTO, PROCESO
                FROM ENOC.VW_CONFIG_PLANILLA_CONCEPTO B
                WHERE ID_CONFIG_PLANILLA=l_id_config_planilla 
                AND VIGENCIA=1 ORDER BY ORDEN_TIPO,ORDEN ) LOOP
    BEGIN
      RAISE NOTICE '%', P_ID_PLANILLA_TRAB;
      EXECUTE 'BEGIN ENOC.PKG_PLANILLA_PROC.'||curD.PROCESO||'(:P_ID_PLANILLA_TRAB,:P_ID_CONFIG_PLANILLA_CONCEPTO,:P_IMPORTE,:P_ERROR,:P_MSGERROR); end;'
      USING P_ID_PLANILLA_TRAB,curD.ID_CONFIG_PLANILLA_CONCEPTO, IN OUT l_importe, IN OUT l_error,IN OUT l_msgerror;
      if l_error=1 then
        l_num_error:= l_num_error + 1;
      end if;
    END;
    END LOOP;

    --I	INGRESOS
    --A	APORTACIONES DE CARGO DEL EMPLEADOR
    --D	DESCUENTOS AL TRABAJADOR
    --R	APORTACIONES DEL TRABAJADOR / PENSIONISTA
    select
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='I' THEN A.importe ELSE 0 END),0) as INGRESO,
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='A' THEN A.importe ELSE 0 END),0) as APOR_EMPL,
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='D' THEN A.importe ELSE 0 END),0) as DESCUENTO,
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='R' THEN A.importe ELSE 0 END),0) as APOR_TRAB
    INTO STRICT
    i_ingreso,
    l_apor_empl,
    l_descuento,
    l_apor_trab
    from  ENOC.PLLA_PLANILLA_TRAB_DET A, ENOC.PLLA_CONCEPTO_PLANILLA B
    where a.ID_CONCEPTO_PLANILLA=B.ID_CONCEPTO_PLANILLA
    and A.ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    l_neto:=i_ingreso - (l_descuento+l_apor_trab);

    if l_neto<0 then
      l_neto:=0;
    end if;
    update ENOC.PLLA_PLANILLA_TRAB set
    TOTAL_INGRESO = i_ingreso,
    TOTAL_APOR_EMPL = l_apor_empl,
    TOTAL_APOR_TRAB = l_apor_trab,
    TOTAL_DESCUENTO = l_descuento,
    TOTAL_NETO = l_neto,
    TOTAL_PAGAR = l_neto,
    ID_USER_MOD=P_ID_USER,
    FECHA_MOD=clock_timestamp()
    where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;

    if l_num_error>0 then
      l_error:=1;
      l_msgerror:='Detalle generado con '||l_num_error::text||' error ';
    end if;

--     <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_planilla_sp_gen_planilla_trab_det (P_ID_PLANILLA_TRAB text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
