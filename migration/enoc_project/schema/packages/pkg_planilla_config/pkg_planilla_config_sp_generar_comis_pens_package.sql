-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_planilla_config,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_planilla_config_sp_generar_comis_pens (P_ID_ANHO bigint, P_ID_MES bigint,P_ID_USER bigint) AS $body$
DECLARE

     curReg CURSOR FOR
     SELECT  ID_REGIMEN_PENSIONARIA,TIPO 
     from plla_REGIMEN_PENSIONARIA 
     WHERE TIPO IN ('PR','PU')
     AND VIGENCIA=1 
     ORDER BY ID_REGIMEN_PENSIONARIA;

        
     l_mes_ant bigint;
     l_anho_ant bigint;
     l_fec_ant timestamp(0);
     l_id bigint;
     l_contar bigint;
     l_fondo decimal(10,4):=0;
     l_seguro decimal(10,4):=0;
     l_rem_max_ase decimal(10,2):=0;
     l_id_comision_pensionaria_ant bigint:=0;
     l_id_c bigint;

BEGIN
    select to_date(P_ID_ANHO::text||'-'||P_ID_MES::text||'-01','YYYY-MM-DD') + -1*'1 month'::interval into STRICT l_fec_ant;
    select (to_char(l_fec_ant,'YYYY'))::numeric ,(to_char(l_fec_ant,'MM'))::numeric  into STRICT l_anho_ant,l_mes_ant;

    FOR curR in curReg LOOP
    BEGIN
      
      select count(1) into STRICT l_contar from PLLA_COMISION_PENSIONARIA 
      where ID_REGIMEN_PENSIONARIA=curR.ID_REGIMEN_PENSIONARIA
      and ID_ANHO=l_anho_ant
      and ID_MES=l_mes_ant;

      if l_contar=1 then
        select ID_COMISION_PENSIONARIA, FONDO,SEGURO,REM_MAX_ASE into STRICT l_id_comision_pensionaria_ant,l_fondo,l_seguro,l_rem_max_ase from PLLA_COMISION_PENSIONARIA 
        where ID_REGIMEN_PENSIONARIA=curR.ID_REGIMEN_PENSIONARIA
        and ID_ANHO=l_anho_ant
        and ID_MES=l_mes_ant;
      end if;

      select count(1) into STRICT l_contar from PLLA_COMISION_PENSIONARIA 
      where ID_REGIMEN_PENSIONARIA=curR.ID_REGIMEN_PENSIONARIA
      and ID_ANHO=P_ID_ANHO
      and ID_MES=P_ID_MES;

      if l_contar=0 then
        
        
        
        select coalesce(max(ID_COMISION_PENSIONARIA),0) + 1  into STRICT l_id from enoc.PLLA_COMISION_PENSIONARIA;

        insert into PLLA_COMISION_PENSIONARIA(
          ID_COMISION_PENSIONARIA,
          ID_REGIMEN_PENSIONARIA,
          ID_ANHO,
          ID_MES,
          FONDO,
          SEGURO,
          REM_MAX_ASE,
          ID_USER_REG,
          CREATED_AT
        )values (
         l_id,
         curR.ID_REGIMEN_PENSIONARIA,
         P_ID_ANHO,
         P_ID_MES,
         l_fondo,
         l_seguro,
         l_rem_max_ase,
         P_ID_USER,
         clock_timestamp()
        );
      else
        select ID_COMISION_PENSIONARIA into STRICT l_id from PLLA_COMISION_PENSIONARIA
        where ID_REGIMEN_PENSIONARIA=curR.ID_REGIMEN_PENSIONARIA
        and ID_ANHO=P_ID_ANHO
        and ID_MES=P_ID_MES;
      end if;
      if curR.tipo='PR' then
          if l_id_comision_pensionaria_ant>0 then

            select coalesce(max(ID_REG_PENS_COMISION),0)    into STRICT l_id_c from enoc.PLLA_REG_PENS_COMISION;
            insert into PLLA_REG_PENS_COMISION(
              ID_REG_PENS_COMISION,
              ID_COMISION_PENSIONARIA,
              ID_TIPO_COMISION_PENS,
              COMISION,
              ID_USER_REG,
              CREATED_AT
            )
            SELECT (row_number() OVER ( ORDER BY ID_REG_PENS_COMISION ASC )) + l_id_c,
            l_id,
            ID_TIPO_COMISION_PENS,
            COMISION,
            P_ID_USER,
            clock_timestamp()
            from PLLA_REG_PENS_COMISION
            where ID_COMISION_PENSIONARIA=l_id_comision_pensionaria_ant
            and ID_TIPO_COMISION_PENS not in (
              SELECT ID_TIPO_COMISION_PENS from PLLA_REG_PENS_COMISION
              where ID_COMISION_PENSIONARIA=l_id
            );
          end if;

          select coalesce(max(ID_REG_PENS_COMISION),0)    into STRICT l_id_c from enoc.PLLA_REG_PENS_COMISION;
          insert into PLLA_REG_PENS_COMISION(
            ID_REG_PENS_COMISION,
            ID_COMISION_PENSIONARIA,
            ID_TIPO_COMISION_PENS,
            COMISION,
            ID_USER_REG,
            CREATED_AT
          )
          SELECT (row_number() OVER ( ORDER BY ID_TIPO_COMISION_PENS ASC )) + l_id_c,
          l_id,
          ID_TIPO_COMISION_PENS,
          0,
          P_ID_USER,
          clock_timestamp()
          from PLLA_TIPO_COMISION_PENS
          where vigencia=1
          and ID_TIPO_COMISION_PENS not in (
            SELECT ID_TIPO_COMISION_PENS from PLLA_REG_PENS_COMISION
            where ID_COMISION_PENSIONARIA=l_id
          );

        end if;
    END;
    END LOOP;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_planilla_config_sp_generar_comis_pens (P_ID_ANHO bigint, P_ID_MES bigint,P_ID_USER bigint) FROM PUBLIC;
