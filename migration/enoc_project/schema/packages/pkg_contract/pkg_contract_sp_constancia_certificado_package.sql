-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_constancia_certificado (P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, P_TIPO bigint,OUT CURSOR REFCURSOR ) AS $body$
DECLARE

      l_max_contrato bigint:=0;
      l_id_contrato bigint:=0;
      l_id_anho bigint:=0;
      l_id_mes bigint:=0;
      l_depto_cargo varchar(2000):='-';
      curContrato CURSOR FOR
      SELECT ESTADO,id_contrato, fec_inicio, fec_termino from eliseo.aps_empleado 
      where id_entidad=P_ID_ENTIDAD 
      and id_persona=P_ID_PERSONA
      and case when l_max_contrato=0 then 0 else id_contrato end =case when l_max_contrato=0 then 0 else l_max_contrato end
      order by id_contrato;

      curPlanilla CURSOR FOR
      SELECT a.id_anho, a.id_mes,a.id_depto,b.nombre as area,a.nom_cargo as cargo,a.id_depto||a.nom_cargo as depto_cargo
      from eliseo.aps_planilla a, eliseo.conta_entidad_depto b 
      where a.id_entidad=b.id_entidad
      and a.id_depto=b.id_depto
      and a.id_entidad=P_ID_ENTIDAD 
      and a.id_persona=P_ID_PERSONA 
      and a.id_contrato=l_id_contrato
      group by  a.id_anho, a.id_mes,a.id_depto,a.nom_cargo,b.nombre
      order by a.id_anho, a.id_mes;
      l_j bigint:=0;
      l_inicio timestamp(0);
      l_fin timestamp(0);
      l_fin_term timestamp(0);
      l_id bigint:=1;
      l_id_ant bigint:=0;
      l_contar bigint:=0;

BEGIN
    if P_TIPO=3 then
      select max(id_contrato) into STRICT l_max_contrato from eliseo.aps_empleado 
      where id_entidad=P_ID_ENTIDAD 
      and id_persona=P_ID_PERSONA;
    end if;

    delete from ENOC.TT_CONSTANCIA_CERTIFICADO;

    FOR cur in curContrato LOOP
    BEGIN
      l_id_contrato:=cur.id_contrato;
      l_depto_cargo:='-';
      l_j:=1;
      l_id_ant:=0;
      FOR curp in curPlanilla LOOP
      BEGIN
        
        if l_depto_cargo<>curp.depto_cargo then
          if l_j=1 then
            l_inicio:=cur.fec_inicio;
          else
            l_inicio:=to_date(curp.id_anho||'-'||curp.id_mes||'-01','YYYY-MM-DD');
            l_fin:=date_trunc('day', ((date_trunc('month',(to_date(l_id_anho||'-'||l_id_mes||'-01','YYYY-MM-DD'))::timestamp + interval '1 month'))::timestamp(0) - 1));
            update ENOC.TT_CONSTANCIA_CERTIFICADO set FIN=l_fin where id=l_id_ant;
           end if;
          insert into ENOC.TT_CONSTANCIA_CERTIFICADO(
            ID,
            ID_PERSONA,
            ID_CONTRATO,
            ID_DEPTO,
            ID_ANHO,
            ID_MES,
            INICIO,
            FIN,
            AREA,
            PUESTO,
            ESTADO
          )values (
            l_id,
            P_ID_PERSONA,
            cur.id_contrato,
            curp.id_depto,
            curp.id_anho,
            curp.id_mes,
            l_inicio,
            l_fin,
            curp.area,
            curp.cargo,
            cur.estado
          );
          l_id_ant:=l_id;
          l_id:=l_id+1;
        end if;
        l_id_anho:=curp.id_anho;
        l_id_mes:=curp.id_mes;
        l_depto_cargo:=curp.depto_cargo;
        l_j:=l_j+1;
      END;
      END LOOP;
      if l_id_ant>0 then
         l_fin:=null;
        if (cur.fec_termino IS NOT NULL AND cur.fec_termino::text <> '') then
          l_fin:=cur.fec_termino;
        end if;
        update ENOC.TT_CONSTANCIA_CERTIFICADO set FIN=l_fin where id=l_id_ant;
      end if;
    END;
    END LOOP;
    
    select count(1) into STRICT l_contar from ENOC.TT_CONSTANCIA_CERTIFICADO where id=l_id_ant and coalesce(FIN::text, '') = '';
    if l_contar=1 then
      select count(1) into STRICT l_contar from moises.trabajador where id_persona=P_ID_PERSONA and id_entidad=P_ID_ENTIDAD;
      if l_contar=1 then
        select FECHA_FIN_EFECTIVO into STRICT l_fin from moises.trabajador where id_persona=P_ID_PERSONA and id_entidad=P_ID_ENTIDAD;
        update ENOC.TT_CONSTANCIA_CERTIFICADO set FIN=l_fin where id=l_id_ant;
      end if;
    end if;

    OPEN CURSOR FOR 
    SELECT 
    ID,
    ID_PERSONA,
    ID_CONTRATO,
    ID_DEPTO,
    ID_ANHO,
    ID_MES,
    INICIO,
    FIN,
    AREA,
    PUESTO,
    ESTADO,
    to_char(INICIO,'DD/MM/YYYY') as desde,
    case when coalesce(FIN::text, '') = '' then 'A la fecha' else to_char(fin,'DD/MM/YYYY') end as hasta
    from ENOC.TT_CONSTANCIA_CERTIFICADO
    order by id;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_constancia_certificado (P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, P_TIPO bigint,OUT CURSOR REFCURSOR ) FROM PUBLIC;
