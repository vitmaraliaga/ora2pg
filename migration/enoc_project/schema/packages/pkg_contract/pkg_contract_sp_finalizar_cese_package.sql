-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_finalizar_cese (P_ID_CESE bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_persona bigint;
        l_id_entidad bigint;
        l_id_trabajador bigint;
        l_id bigint;
        l_id_perfil_puesto bigint:=0;
        l_id_perfil_puesto_c bigint;
        l_id_max bigint;
        l_fecha_cese timestamp(0);
        l_id_depto varchar(10);
        l_id_estado_cont_depto bigint;


BEGIN
      
       select ID_TRABAJADOR, FECHA_CESE,id_entidad,id_depto INTO STRICT l_id_trabajador,l_fecha_cese,l_id_entidad,l_id_depto  from PLLA_CESE where ID_CESE=P_ID_CESE;

       
       UPDATE MOISES.TRABAJADOR SET
       FECHA_FIN_EFECTIVO = l_fecha_cese,
       ID_SITUACION_TRABAJADOR='0' --PARA ADELANTE HAY QUE CAMBIAR A 2 PENDIENTE DE LIQUIDACION Y EN LA LIQUIDACION SE ASIGNA 0 BAJA
       WHERE ID_TRABAJADOR = l_id_trabajador;

            
      
       SELECT coalesce(MAX(ID_TRABAJADOR_PUESTO),0) INTO STRICT l_id_max FROM MOISES.TRABAJADOR_PUESTO WHERE ID_TRABAJADOR=l_id_trabajador;

       update MOISES.TRABAJADOR_PUESTO set
              HASTA=l_fecha_cese,
              ID_USER_MOD=P_ID_USER
       where ID_TRABAJADOR_PUESTO=l_id_max;

       
        SELECT coalesce(MAX(ID_TRABAJADOR_AREA),0) INTO STRICT l_id_max FROM MOISES.TRABAJADOR_AREA WHERE ID_TRABAJADOR=l_id_trabajador;

       update MOISES.TRABAJADOR_AREA set
              HASTA=l_fecha_cese,
              ID_USER_MOD=P_ID_USER
       where ID_TRABAJADOR_AREA=l_id_max;


        SELECT count(*) INTO STRICT l_contar
         FROM enoc.PLLA_ESTADO_CONT_DEPTO a,  enoc.PLLA_ESTADO_CONT b 
         WHERE a.ID_ESTADO_CONT=b.ID_ESTADO_CONT 
         AND  a.ID_ENTIDAD=l_id_entidad 
         AND a.ID_DEPTO=l_id_depto 
         AND a.TIPO='T' 
         AND b.ID_ESTADO_CONT='07';

         IF l_contar = 0 THEN
            l_error:=1;
            l_msgerror:='No existe asignado paso para cese';
--             goto salida_fin_cese;
        END IF;

         SELECT ID_ESTADO_CONT_DEPTO into STRICT l_id_estado_cont_depto
         FROM enoc.PLLA_ESTADO_CONT_DEPTO a,  enoc.PLLA_ESTADO_CONT b 
         WHERE a.ID_ESTADO_CONT=b.ID_ESTADO_CONT 
         AND  a.ID_ENTIDAD=l_id_entidad 
         AND a.ID_DEPTO=l_id_depto 
         AND a.TIPO='T' 
         AND b.ID_ESTADO_CONT='07';

         update  PLLA_CESE set
         ID_ESTADO_CONT_DEPTO=l_id_estado_cont_depto,
         ID_USER_MOD= P_ID_USER,
         FECHA_MOD=clock_timestamp()
         where ID_CESE=P_ID_CESE;

         --DESACTIVAR VIGENCIAS DE PAGOS DESPUES DE CESE
         MERGE INTO ENOC.PLLA_ADICIONAL_DET S 
          USING(
            SELECT 
            b.id_adicional_det
            FROM ENOC.PLLA_ADICIONAL A, ENOC.PLLA_ADICIONAL_DET B
            WHERE A.ID_ADICIONAL=B.ID_ADICIONAL
            AND A.ID_TRABAJADOR=l_id_trabajador
            AND A.id_estado_adicional not in ('00','05')
            AND B.VIGENCIA=1
            AND to_date(B.id_anho::text||'-'||B.id_mes::text||'-01','YYYY-MM-DD')> to_date(to_char(l_fecha_cese,'YYYY-MM')||'-01','YYYY-MM-DD') 
        )T ON (T.id_adicional_det=S.id_adicional_det)
          WHEN  MATCHED THEN UPDATE SET  
          S.VIGENCIA=0,
          S.id_user_mod=P_ID_USER,
          FECHA_MOD=clock_timestamp();

        MERGE INTO ENOC.PLLA_REMUNERACION_DET S 
          USING(
              SELECT B.ID_REMUNERACION_DET
              FROM ENOC.PLLA_REMUNERACION A, ENOC.PLLA_REMUNERACION_DET B
              WHERE A.ID_REMUNERACION=B.ID_REMUNERACION
              AND A.ID_TRABAJADOR=l_id_trabajador
              AND B.VIGENCIA=1
              AND to_date(B.id_anho::text||'-'||B.id_mes::text||'-01','YYYY-MM-DD')> to_date(to_char(l_fecha_cese,'YYYY-MM')||'-01','YYYY-MM-DD') 
        )T ON (T.ID_REMUNERACION_DET=S.ID_REMUNERACION_DET)
          WHEN  MATCHED THEN UPDATE SET  
          S.VIGENCIA=0,
          S.id_user_mod=P_ID_USER,
          FECHA_MOD=clock_timestamp();

        MERGE INTO ENOC.PLLA_ADICIONAL_PERSONA S 
          USING(
            SELECT B.ID_ADICIONAL_PERSONA FROM ENOC.PLLA_ADICIONAL A, ENOC.PLLA_ADICIONAL_PERSONA B
            WHERE A.ID_ADICIONAL=B.ID_ADICIONAL
            AND B.ID_TRABAJADOR=l_id_trabajador
            AND a.id_estado_adicional not in ('00','05')
            AND B.VIGENCIA=1
            AND to_date(A.id_anho::text||'-'||A.id_mes::text||'-01','YYYY-MM-DD')> to_date(to_char(l_fecha_cese,'YYYY-MM')||'-01','YYYY-MM-DD') 
        )T ON (T.ID_ADICIONAL_PERSONA=S.ID_ADICIONAL_PERSONA)
          WHEN  MATCHED THEN UPDATE SET  
          S.VIGENCIA=0,
          S.id_user_mod=P_ID_USER,
          FECHA_MOD=clock_timestamp();

--         <<salida_fin_cese>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_finalizar_cese (P_ID_CESE bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
