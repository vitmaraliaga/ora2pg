-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_registrar_cambio ( P_ID_CAMBIOS bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONCEPTO_CAMBIO bigint, P_ID_TRABAJADOR bigint, P_ID_SEDEAREA bigint, P_ID_PERFIL_PUESTO bigint, P_ID_CONDICION_LABORAL text, P_ID_TIPO_CONTRATO text, P_ID_TIPO_TIEMPO_TRABAJO bigint, P_FEC_DESDE timestamp(0), P_FEC_HASTA timestamp(0), P_MOD_FMR_SUELDO text, P_ID_ESCALA_SALARIAL bigint, P_SUELDO bigint, P_PJE_FMR bigint, P_COMENTARIO text, P_ACT_INS text, P_PORCENTAJE bigint, P_ID_TIPO_HORARIO bigint, P_ID_USER bigint,P_ID_CAMBIO OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_codigo varchar(20);
        l_id_cambios bigint;
        l_id_sede_area bigint;
        l_id_perfil_puesto bigint;
        l_id_condicion_laboral varchar(10);
        l_id_tipo_contrato  varchar(10);
        l_id_tipo_tiempo_trabajo bigint;
        l_id_estado_cambios varchar(5);
        l_sueldo decimal(10,2):=0;
        l_pje_fmr decimal(10,2):=0;
        l_proceso_fin varchar(1):='N';
        l_id_tipo_horario bigint;

BEGIN
      
        SELECT CODIGO INTO STRICT l_codigo FROM enoc.PLLA_CONCEPTO_CAMBIO WHERE ID_CONCEPTO_CAMBIO=P_ID_CONCEPTO_CAMBIO;

          
                  
        select 
        id_sedearea,id_perfil_puesto, id_condicion_laboral,id_tipo_contrato,id_tipo_tiempo_trabajo,id_tipo_horario 
        into STRICT 
        l_id_sede_area, l_id_perfil_puesto,l_id_condicion_laboral,l_id_tipo_contrato,l_id_tipo_tiempo_trabajo,l_id_tipo_horario 
        from moises.trabajador 
        where id_trabajador=P_ID_TRABAJADOR;

        
        select sueldo, fmr into STRICT l_sueldo,l_pje_fmr  from ENOC.plla_remuneracion where id_trabajador=P_ID_TRABAJADOR and vigencia=1;

        /*if l_codigo in('CCC','CCM') then
          if l_id_condicion_laboral in('M','E') and P_ID_CONDICION_LABORAL in('M','E') then
            l_proceso_fin:='S';
          end if;
        end if;*/
        
        if P_ID_CAMBIOS=0 then
        
          select coalesce(max(id_cambios),0) + 1 into STRICT l_id_cambios from PLLA_CAMBIOS;

          insert into enoc.PLLA_CAMBIOS(
              ID_CAMBIOS,
              ID_ENTIDAD,
              ID_DEPTO,
              ID_CONCEPTO_CAMBIO,
              ID_TRABAJADOR,
              ID_SEDEAREA,
              ID_PERFIL_PUESTO,
              ID_CONDICION_LABORAL,
              ID_TIPO_CONTRATO,
              ID_TIPO_TIEMPO_TRABAJO,
              FEC_DESDE,
              FEC_HASTA,
              MOD_FMR_SUELDO,
              ID_TIPO_HORARIO,
              ID_ESCALA_SALARIAL,
              SUELDO,
              PJE_FMR,
              COMENTARIO,
              ACT_INS,
              PROCESO_FIN,
              PORCENTAJE,
              APS,
              ID_ESTADO_CAMBIO,
              ID_USER_REG,
              FECHA_REG,
              ID_SEDEAREAA,
              ID_PERFIL_PUESTOA,
              ID_CONDICION_LABORALA,
              ID_TIPO_CONTRATOA,
              ID_TIPO_TIEMPO_TRABAJOA,
              SUELDOA,
              PJE_FMRA,
              ID_TIPO_HORARIOA
            )values (
              l_id_cambios,
              P_ID_ENTIDAD,
              P_ID_DEPTO,
              P_ID_CONCEPTO_CAMBIO,
              P_ID_TRABAJADOR,
              case when P_ID_SEDEAREA=0 then null else P_ID_SEDEAREA end,
              case when P_ID_PERFIL_PUESTO=0 then null else P_ID_PERFIL_PUESTO end,
              P_ID_CONDICION_LABORAL,
              P_ID_TIPO_CONTRATO,
              case when P_ID_TIPO_TIEMPO_TRABAJO=0 then null else P_ID_TIPO_TIEMPO_TRABAJO end,
              P_FEC_DESDE,
              P_FEC_HASTA,
              P_MOD_FMR_SUELDO,
              P_ID_TIPO_HORARIO,
              case when P_ID_ESCALA_SALARIAL=0 then null else P_ID_ESCALA_SALARIAL end,
              P_SUELDO,
              P_PJE_FMR,
              P_COMENTARIO,
              P_ACT_INS,
              l_proceso_fin,
              case when P_PORCENTAJE=0 then null else P_PORCENTAJE end,
              '0',
              '01',
              P_ID_USER,
              clock_timestamp(),
              l_id_sede_area,
              l_id_perfil_puesto,
              l_id_condicion_laboral,
              l_id_tipo_contrato,
              l_id_tipo_tiempo_trabajo,
              l_sueldo,
              l_pje_fmr,
              l_id_tipo_horario
            );
        else
          SELECT ID_ESTADO_CAMBIO INTO STRICT l_id_estado_cambios FROM enoc.PLLA_CAMBIOS WHERE ID_CAMBIOS = P_ID_CAMBIOS;
          if l_id_estado_cambios not in ('01','07') then
            l_error:=1;
            l_msgerror:='Si modifica s√≥lo con estado registrado';
--             goto salida_reg_cambio;
          end if;
          update enoc.PLLA_CAMBIOS set
              ID_SEDEAREA = case when P_ID_SEDEAREA=0 then null else P_ID_SEDEAREA end ,
              ID_PERFIL_PUESTO=case when P_ID_PERFIL_PUESTO=0 then null else P_ID_PERFIL_PUESTO end,
              ID_CONDICION_LABORAL=P_ID_CONDICION_LABORAL,
              ID_TIPO_CONTRATO=P_ID_TIPO_CONTRATO,
              ID_TIPO_TIEMPO_TRABAJO=case when P_ID_TIPO_TIEMPO_TRABAJO=0 then null else P_ID_TIPO_TIEMPO_TRABAJO end,
              FEC_DESDE=P_FEC_DESDE,
              FEC_HASTA=P_FEC_HASTA,
              MOD_FMR_SUELDO=P_MOD_FMR_SUELDO,
              ID_TIPO_HORARIO = P_ID_TIPO_HORARIO,
              ID_ESCALA_SALARIAL=case when P_ID_ESCALA_SALARIAL=0 then null else P_ID_ESCALA_SALARIAL end,
              SUELDO=P_SUELDO,
              PJE_FMR=P_PJE_FMR,
              COMENTARIO=P_COMENTARIO,
              ACT_INS=P_ACT_INS,
              PROCESO_FIN=l_proceso_fin,
              PORCENTAJE = case when P_PORCENTAJE=0 then null else P_PORCENTAJE end,
              ID_USER_MOD= P_ID_USER,
              FECHA_MOD=clock_timestamp(),
              ID_SEDEAREAA= l_id_sede_area,
              ID_PERFIL_PUESTOA=l_id_perfil_puesto,
              ID_CONDICION_LABORALA=l_id_condicion_laboral,
              ID_TIPO_CONTRATOA=l_id_tipo_contrato,
              ID_TIPO_TIEMPO_TRABAJOA=l_id_tipo_tiempo_trabajo,
              SUELDOA=l_sueldo,
              PJE_FMRA=l_pje_fmr,
              ID_TIPO_HORARIOA=l_id_tipo_horario
          where ID_CAMBIOS=P_ID_CAMBIOS;

          l_id_cambios:=P_ID_CAMBIOS;
        end if;

--        <<salida_reg_cambio>>
        P_ID_CAMBIO:=l_id_cambios;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_registrar_cambio ( P_ID_CAMBIOS bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONCEPTO_CAMBIO bigint, P_ID_TRABAJADOR bigint, P_ID_SEDEAREA bigint, P_ID_PERFIL_PUESTO bigint, P_ID_CONDICION_LABORAL text, P_ID_TIPO_CONTRATO text, P_ID_TIPO_TIEMPO_TRABAJO bigint, P_FEC_DESDE timestamp(0), P_FEC_HASTA timestamp(0), P_MOD_FMR_SUELDO text, P_ID_ESCALA_SALARIAL bigint, P_SUELDO bigint, P_PJE_FMR bigint, P_COMENTARIO text, P_ACT_INS text, P_PORCENTAJE bigint, P_ID_TIPO_HORARIO bigint, P_ID_USER bigint,P_ID_CAMBIO OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
