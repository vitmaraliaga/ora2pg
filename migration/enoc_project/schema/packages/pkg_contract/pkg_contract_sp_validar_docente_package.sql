-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_validar_docente ( P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(3000):='OK';
        l_contar bigint;
        l_contar1 bigint;
        l_contar2 bigint;
        l_id_situacion_trabajador varchar(5):='-';
        l_id_solic_req_candidato bigint;
        l_msg varchar(3000):='-';

        --l_id_situacion_trabajador  varchar(5);
        l_id_tipo_control_personal bigint;
        l_id_condicion_laboral varchar(5);
        l_id_situacion_educativo varchar(5);
        l_id_tipopais bigint;
        l_id_ubigeo bigint;
        l_id_tiporeligion bigint;
        l_celular varchar(70);
        l_correo varchar(70);
        l_correo_inst varchar(70);
        l_documento_url varchar(150);
        l_id_categoria_docente bigint;
        l_id_tipoestadocivil bigint;
        l_id bigint;
        l_cod_academico varchar(10);
        l_nom_grado varchar(200);


BEGIN
    
    SELECT COUNT(*) INTO STRICT l_contar FROM MOISES.TRABAJADOR WHERE ID_PERSONA=P_ID_PERSONA AND  ID_ENTIDAD=P_ID_ENTIDAD;

    if l_contar>0 then
      SELECT coalesce(id_situacion_trabajador,'0') INTO STRICT l_id_situacion_trabajador FROM MOISES.TRABAJADOR WHERE ID_PERSONA=P_ID_PERSONA AND  ID_ENTIDAD=P_ID_ENTIDAD;
    end if;

    if l_id_situacion_trabajador not in ('1','3') then
      select count(*) into STRICT l_contar from enoc.plla_solic_req_candidato where id_persona=P_ID_PERSONA and ID_ESTADO_REQ_CAND in ('06','08');
      if l_contar=0 then
        l_msgerror:='MENSAJE1: TRABAJADOR NO HA INICIADO CON PROCESO DE CONTRATACIÓN ';
        l_error:=1;
--         goto salida_valdocente;
      end if;

      select max(id_solic_req_candidato) into STRICT l_id_solic_req_candidato from enoc.plla_solic_req_candidato where id_persona=P_ID_PERSONA and ID_ESTADO_REQ_CAND in ('06','08');
      
      select count(*) into STRICT l_contar from enoc.plla_contrato where id_persona = P_ID_PERSONA and id_solic_req_candidato=l_id_solic_req_candidato;

      select count(*) into STRICT l_contar1 from enoc.plla_solic_req_candidato_det where  id_solic_req_candidato=l_id_solic_req_candidato;

      IF l_contar1=0 AND l_contar=1 THEN
     
          select count(*) into STRICT l_contar2 from enoc.plla_contrato a,PLLA_ESTADO_CONT_DEPTO b  
          where a.id_ESTADO_CONT_DEPTO=b.id_ESTADO_CONT_DEPTO
          and a.id_persona = P_ID_PERSONA 
          and a.id_solic_req_candidato=l_id_solic_req_candidato
          and b.ID_ESTADO_CONT in ('08','00');

          if l_contar2>1 then
            l_msgerror:='MENSAJE2: TRABAJADOR NO HA INICIADO CON PROCESO DE CONTRATACIÓN ';
            l_error:=1;
--             goto salida_valdocente;
          end if;
      END IF;
      IF l_contar1>0 THEN
        select count(*) into STRICT l_contar2 from enoc.plla_contrato a,PLLA_ESTADO_CONT_DEPTO b
        where a.id_ESTADO_CONT_DEPTO=b.id_ESTADO_CONT_DEPTO
        and a.id_persona = P_ID_PERSONA 
        and a.id_solic_req_candidato=l_id_solic_req_candidato
        and b.ID_ESTADO_CONT in ('08','00');

        if l_contar1=l_contar2 then
          l_msgerror:='MENSAJE3: TRABAJADOR NO HA INICIADO CON PROCESO DE CONTRATACIÓN ';
          l_error:=1;
--           goto salida_valdocente;
        end if;
      end if;
    else
       case l_id_situacion_trabajador
       when '3' then
        l_msgerror:='MENSAJE4: TRABAJADOR CON SUSPENSIÓN PERFECTA DE LABORES';
        l_error:=1;
--         goto salida_valdocente;
       when '1' then
        
          select
          a.ID_SITUACION_TRABAJADOR,
          a.ID_TIPO_CONTROL_PERSONAL,
          a.ID_CONDICION_LABORAL,
          a.ID_SITUACION_EDUCATIVO,
          a.ID_TIPOPAIS,
          a.ID_UBIGEO,
          a.ID_TIPORELIGION,
          a.CELULAR,
          a.CORREO,
          a.CORREO_INST,
          a.DOCUMENTO_URL,
          (select x.id_categoria_docente from moises.persona_acad_categoria x
            where x.id_categoria in (
              select max(z.id_categoria) from moises.persona_acad_categoria z
              where z.id_persona=a.id_persona
              and z.ESTADO='1'
            ) and x.ESTADO='1' 
          ) as id_categoria_docente,
          id_tipoestadocivil
          into STRICT 
          l_id_situacion_trabajador,
          l_id_tipo_control_personal,
          l_id_condicion_laboral,
          l_id_situacion_educativo,
          l_id_tipopais,
          l_id_ubigeo,
          l_id_tiporeligion,
          l_celular,
          l_correo,
          l_correo_inst,
          l_documento_url,
          l_id_categoria_docente,
          l_id_tipoestadocivil
          from enoc.vw_trabajador a
          where a.id_entidad=P_ID_ENTIDAD
          and a.id_persona=P_ID_PERSONA;

          
          if coalesce(l_id_tipo_control_personal::text, '') = '' then
            l_msg:=l_msg||'Falta registrar jornada laboral. ';
            l_error:=1;
          end if;
          if coalesce(l_id_condicion_laboral::text, '') = '' then
            l_msg:=l_msg||'Falta registrar condición laboral. ';
            l_error:=1;
          end if;

          if coalesce(l_id_tipopais::text, '') = '' then
            l_msg:=l_msg||'Falta registrar país (Nacionalidad). ';
            l_error:=1;
          end if;
          if (l_id_tipopais IS NOT NULL AND l_id_tipopais::text <> '') then
            if l_id_tipopais=176 then
              if coalesce(l_id_ubigeo::text, '') = '' then
                l_msg:=l_msg||'Falta registrar región de nacimiento. ';
                l_error:=1;
              end if;
            end if;
          end if;
          if coalesce(l_id_tiporeligion::text, '') = '' then
            l_msg:=l_msg||'Falta registrar religión. ';
            l_error:=1;
          end if;
          if coalesce(l_celular::text, '') = '' then
            l_msg:=l_msg||'Falta registrar celular. ';
            l_error:=1;
          end if;
          if coalesce(l_correo::text, '') = '' then
            l_msg:=l_msg||'Falta registrar correo personal. ';
            l_error:=1;
          end if;
          if coalesce(l_documento_url::text, '') = '' then
            l_msg:=l_msg||'Falta adjuntar documento de identidad. ';
            l_error:=1;
          end if;

          if coalesce(l_id_tipoestadocivil::text, '') = '' then
            l_msg:=l_msg||'Falta asignar estado civil. ';
            l_error:=1;
          else
            if l_id_tipoestadocivil=1 then

              select count(*) into STRICT l_contar from MOISES.VINCULO_FAMILIAR where id_persona=P_ID_PERSONA and ID_TIPO_VINCULO_FAMILIAR='02';
              if l_contar=0 then
                l_msg:=l_msg||'Falta registrar cónyuge. ';
                l_error:=1;
              end if;
            end if;
          end if;

          
          select count(*) into STRICT l_contar from MOISES.PERSONA_DIRECCION where id_persona=P_ID_PERSONA and es_activo=1;

       
          if l_contar=0 then 
            l_msg:=l_msg||'Falta registrar dirección. ';
            l_error:=1;
          else
            select count(*) into STRICT l_contar from MOISES.PERSONA_DIRECCION where id_persona=P_ID_PERSONA and es_activo=1 and ID_TIPODIRECCION=4;
            if l_contar=0 then
              l_msg:=l_msg||'Falta registrar dirección actual. ';
              l_error:=1;
            end if;
            select count(*) into STRICT l_contar from MOISES.PERSONA_DIRECCION where id_persona=P_ID_PERSONA and es_activo=1 and ID_TIPODIRECCION=5;
            if l_contar=0 then
              l_msg:=l_msg||'Falta registrar dirección legal. ';
              l_error:=1;
            end if;
          end if;
          if coalesce(l_id_situacion_educativo::text, '') = '' then

            l_msg:=l_msg||'Falta registrar grado académico. ';
            l_error:=1;
          else
           select cod_academico, nombre into STRICT l_cod_academico,l_nom_grado from MOISES.SITUACION_EDUCATIVA where id_situacion_educativo = l_id_situacion_educativo;-- and  tipo=2;
           if coalesce(l_cod_academico::text, '') = '' then
            l_msg:=l_msg||'No tiene grado. Situación educativo actual: '||l_nom_grado||'. ';
            l_error:=1;
           end if;

          end if;

          if coalesce(l_id_categoria_docente::text, '') = '' then
            --l_msg:=l_msg||'Falta asignar categoría docente. ';
            --l_error:=1;
            select coalesce(max(id_categoria),0) + 1 into STRICT l_id from moises.persona_acad_categoria;
            insert into moises.persona_acad_categoria(
              ID_CATEGORIA,
              ID_PERSONA,
              ID_CATEGORIA_DOCENTE,
              ESTADO,
              ID_USUARIO_REG,
              FECHA_REGISTRO
            )values (
              l_id,
              P_ID_PERSONA,
              11, --sin categoria
              '1',
              4,--lamb financial
              clock_timestamp()
            );
          end if;

          if l_error=1 then
            l_msgerror:='MENSAJE5: '||l_msg;
          end if;

       end case;
    end if;
--      <<salida_valdocente>>
     P_ERROR:=l_error;
     P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_validar_docente ( P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
