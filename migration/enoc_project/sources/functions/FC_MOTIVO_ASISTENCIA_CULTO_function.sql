-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = enoc,public;
\set ON_ERROR_STOP ON

function            FC_MOTIVO_ASISTENCIA_CULTO(P_ID_TRABAJADOR NUMBER,P_ID_TIPO_HORARIO NUMBER,P_ID_SEDEAREA NUMBER, P_FECHA date) RETURN VARCHAR2
IS
l_dato VARCHAR(10):='A';
l_contar number:=0;
l_contar_fer_ins number:=0;
l_contar_fer number:=0;
l_contar_mar number:=0;
l_fecha date;
l_anho number;
l_mes number;
l_dia number;
l_nrodia number;
l_codigo varchar(10);
l_id_entidad number;
l_id_area number;
l_id_depto varchar2(10);
l_id_tipo_horario number:=0;

BEGIN
    
    l_fecha:= TO_DATE(TO_CHAR(P_FECHA, 'MM/DD/YYYY'), 'MM/DD/YYYY');
    
    select 
    to_number(to_char(l_fecha,'YYYY')),to_number(to_char(l_fecha,'MM')),to_number(to_char(l_fecha,'DD')), to_number(TO_CHAR(l_fecha, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))
    into 
    l_anho,l_mes,l_dia,l_nrodia 
    from dual;
    
    
    
    --licencia y permiso
    select count(*) into l_contar from enoc.VW_LICENCIA_PERMISO_ASIST 
      where id_trabajador=P_ID_TRABAJADOR
      and periodo='D'
      and id_estado_lica_per not in('00','04')
      AND (l_fecha between fecha_desde and fecha_hasta);
    
    if l_contar>0 then
       l_dato:='PLD';
       GOTO SALIDA;
    end if;
    
    --licencia y permiso
    select count(*) into l_contar from enoc.VW_LICENCIA_PERMISO_ASIST 
      where id_trabajador=P_ID_TRABAJADOR
      and periodo='H'
      and id_estado_lica_per not in('00','04')
      AND (l_fecha between TO_DATE(TO_CHAR(fecha_desde, 'MM/DD/YYYY'), 'MM/DD/YYYY')  and TO_DATE(TO_CHAR(fecha_hasta, 'MM/DD/YYYY'), 'MM/DD/YYYY'));

    
    
    if l_contar>0 then
       l_dato:='PLH';
       GOTO SALIDA;
    end if;
    
    --vacaciones
    select count(*) into l_contar from enoc.vw_rol_vacacional
    where id_trabajador=P_ID_TRABAJADOR
    and condicion='P'
    AND (l_fecha between fecha_ini and fecha_fin);
    
    if l_contar>0 then
       l_dato:='V';
       GOTO SALIDA;
    end if;
    
   --feriados
   
   select count(*) into l_contar_fer from enoc.plla_feriados
   where  fecha = l_fecha
   and id_tipo_feriado=1;
   
   if l_contar_fer>0 then
       l_dato:='FN';
       GOTO SALIDA;
   end if;
  
   select count(*) into l_contar_fer from enoc.plla_feriados
   where fecha = l_fecha
   and id_tipo_feriado=2;
   
   if l_contar_fer>0 then
       l_dato:='FNL';
       GOTO SALIDA;
   end if;
   
 
    SELECT
    ID_ENTIDAD,
    ID_AREA,
    ID_DEPTO_PADRE
    INTO 
    l_id_entidad,
    l_id_area,
    l_id_depto
    FROM eliseo.vw_sede_area
    WHERE ID_SEDEAREA=P_ID_SEDEAREA;
     
     select count(*) into l_contar_fer_ins from enoc.plla_feriados
     where fecha = l_fecha
     and id_tipo_feriado=3
     and ID_FERIADO in(
      select id_feriado from enoc.plla_feriado_inst
      where tipo='E'
      and id_entidad=l_id_entidad
      union
      select id_feriado from enoc.plla_feriado_inst
      where tipo='D'
      and id_entidad=l_id_entidad
      and id_depto=l_id_depto
      union
      select id_feriado from enoc.plla_feriado_inst
      where tipo='A'
      and id_entidad=l_id_entidad
      and id_depto=l_id_depto
      and id_area=l_id_area
     );
     
   
   if l_contar_fer_ins>0 then
       l_dato:='FNL';
       GOTO SALIDA;
   end if;
   
   
   SELECT count(*) into l_contar FROM ENOC.PLLA_TIPO_HORARIO A,ENOC.PLLA_TIPO_HORARIO_TRAB B 
   WHERE A.ID_TIPO_HORARIO=B.ID_TIPO_HORARIO 
   AND B.ID_TRABAJADOR=P_ID_TRABAJADOR
   AND l_fecha BETWEEN B.DESDE AND B.HASTA;
   
   if l_contar=1 then
    SELECT A.ID_TIPO_HORARIO into l_id_tipo_horario FROM ENOC.PLLA_TIPO_HORARIO A,ENOC.PLLA_TIPO_HORARIO_TRAB B 
    WHERE A.ID_TIPO_HORARIO=B.ID_TIPO_HORARIO 
    AND B.ID_TRABAJADOR=P_ID_TRABAJADOR
    AND l_fecha BETWEEN B.DESDE AND B.HASTA; 
  else
    l_id_tipo_horario:=P_ID_TIPO_HORARIO;
  end if;
   


   select b.codigo into l_codigo from enoc.plla_tipo_horario a, ENOC.PLLA_TIPO_CONFIG_HORARIO b
   where a.ID_TIPO_CONFIG_HORARIO=b.ID_TIPO_CONFIG_HORARIO
   and a.id_tipo_horario = l_id_tipo_horario;

   if l_codigo ='HM' then
   
    select count(*) into l_contar from enoc.plla_horario_mensual m ,  enoc.plla_horario_mensual_det d
    where m.id_horario_mensual=d.id_horario_mensual
    and m.id_anho=l_anho
    and m.id_mes =l_mes
    and d.id_dia=l_dia;
    
   else
    select count(*) into l_contar from enoc.plla_horario_detalle a
    where a.id_tipo_horario=l_id_tipo_horario
    and a.id_dia=l_nrodia;
    
   end if;
   
   if l_contar> 0 then
    l_dato:='A';
   else
    if l_nrodia = 7 then
      l_dato:='SA';
    elsif l_nrodia = 1 then
      l_dato:='DO';
    else
      l_dato:='NLA';
    end if;
    
   end if;
   
   IF l_dato='A' then
    SELECT count(*) into l_contar FROM ENOC.PLLA_TIPO_HORARIO A,ENOC.PLLA_TIPO_HORARIO_TRAB B 
    WHERE A.ID_TIPO_HORARIO=B.ID_TIPO_HORARIO 
    AND COALESCE(A.CONTROL_CULTO,0)=1
    AND B.ID_TRABAJADOR=P_ID_TRABAJADOR
    AND l_fecha BETWEEN B.DESDE AND B.HASTA;

    if l_contar>0 then
       l_dato:='SCU';
       GOTO SALIDA;
    end if;
   end if;
   
   <<SALIDA>>
	RETURN(l_dato);
END;

