-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = enoc,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE                     PKG_PLANILLA AS 

  /* TODO enter package declarations (types, exceptions, methods etc) here */ 
  PROCEDURE SP_GEN_PLANILLA_TRAB(P_ID_PLANILLA number,P_ID_TRABAJADOR number,P_ID_USER number,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_ELIMINAR_PLANILLA_TRAB(P_ID_PLANILLA number,P_ID_TRABAJADOR number);
   PROCEDURE SP_INSERTAR_PLANILLA_TRAB(P_ID_TRABAJADOR VARCHAR2,P_ID_PLANILLA NUMBER,P_ID_ANHO number,P_ID_MES number,P_ID_USER NUMBER,P_ID_PLANILLA_TRAB OUT VARCHAR2, P_ERROR OUT number,P_MSGERROR out varchar2);
  
  PROCEDURE SP_GEN_PLANILLA_TRAB_DET(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_USER number,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_GEN_PLANILLA_TRAB_PROC(P_ID_PLANILLA_TRAB VARCHAR2,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_GEN_PLANILLA_TRAB_CCOSTO(P_ID_PLANILLA_TRAB VARCHAR2,P_ERROR OUT number,P_MSGERROR out varchar2);
  
  
  PROCEDURE SP_INSMOD_PLANILLA_TRAB_DET(
    P_ID_PLANILLA_TRAB	VARCHAR2,
    P_ID_CONCEPTO_PLANILLA	NUMBER,
    P_IMPORTE	NUMBER,
    P_NUM_DIAS	NUMBER,
    P_NUM_HORAS	NUMBER,
    P_IMPORTE_HORAS	NUMBER,
    P_IMPORTE_DIAS	NUMBER,
    P_IMPORTE_REF	NUMBER,
    P_PJE_REF	NUMBER,
    P_IMPORTE_BASE	NUMBER
  );

END PKG_PLANILLA;


CREATE OR REPLACE PACKAGE BODY                          PKG_PLANILLA AS
  PROCEDURE SP_GEN_PLANILLA_TRAB(P_ID_PLANILLA number,P_ID_TRABAJADOR number,P_ID_USER number,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS

    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_entidad number;
    l_id_depto varchar2(10);
    l_id_grupo_planilla number;
    l_id_tipo_planilla number;
    l_id_anho number;
    l_id_mes number;
    l_id_planilla_trab varchar2(50);
    CURSOR curtrab IS
    select
    t.id_trabajador
    from moises.trabajador t,ENOC.vw_ent_dep_area_ccosto b
    where t.id_sedearea=b.id_sedearea
    and t.id_entidad     = l_id_entidad
    and b.id_depto_padre = l_id_depto
    and t.id_grupo_planilla = l_id_grupo_planilla
    and t.id_situacion_trabajador in('1','2') --ACTIVO O SUBSIDIADO, SIN VÍNCULO LABORAL CON CONCEPTOS PENDIENTE DE LIQUIDAR
    and case when P_ID_TRABAJADOR =0 then 0 else  t.id_trabajador end = case when P_ID_TRABAJADOR =0 then 0 else  P_ID_TRABAJADOR end
    order by t.id_trabajador;
    
    
  BEGIN
  
    --ELIMINAR
    PKG_PLANILLA.SP_ELIMINAR_PLANILLA_TRAB(P_ID_PLANILLA,P_ID_TRABAJADOR);
    
    select 
    a.ID_TIPO_PLANILLA,
    a.ID_GRUPO_PLANILLA,
    a.ID_ENTIDAD,
    a.ID_DEPTO,
    b.ID_ANHO,
    b.ID_MES
    into
    l_id_tipo_planilla,
    l_id_grupo_planilla,
    l_id_entidad,
    l_id_depto,
    l_id_anho,
    l_id_mes
    FROM ENOC.PLLA_CONFIG_PLANILLA A,ENOC.PLLA_PLANILLA B
    WHERE A.ID_CONFIG_PLANILLA=B.ID_CONFIG_PLANILLA
    AND B.ID_PLANILLA=P_ID_PLANILLA;
    
    
    FOR curT in curtrab LOOP
    BEGIN
        PKG_PLANILLA.SP_INSERTAR_PLANILLA_TRAB(curT.id_trabajador,P_ID_PLANILLA,l_id_anho,l_id_mes,P_ID_USER,l_id_planilla_trab, l_error,l_msgerror);
        --dbms_output.put_line(l_error||'*'||l_id_planilla_trab);
        if l_error=0 then
          PKG_PLANILLA.SP_GEN_PLANILLA_TRAB_DET(l_id_planilla_trab,P_ID_USER,l_error,l_msgerror);
        end if;
    END;
    END LOOP;
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_GEN_PLANILLA_TRAB;
  
  PROCEDURE SP_ELIMINAR_PLANILLA_TRAB(P_ID_PLANILLA number,P_ID_TRABAJADOR number)
  AS
  BEGIN
    --ELIMINAR
    IF P_ID_TRABAJADOR = 0 THEN
    
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB_CCOSTO WHERE ID_PLANILLA_TRAB IN(
        SELECT ID_PLANILLA_TRAB FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA
      );
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB_DET WHERE ID_PLANILLA_TRAB IN(
        SELECT ID_PLANILLA_TRAB FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA
      );
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB_PROCESO WHERE ID_PLANILLA_TRAB IN(
        SELECT ID_PLANILLA_TRAB FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA
      );
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA;
      
    ELSE
    
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB_CCOSTO WHERE ID_PLANILLA_TRAB IN(
        SELECT ID_PLANILLA_TRAB FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA AND ID_TRABAJADOR=P_ID_TRABAJADOR
      );
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB_DET WHERE ID_PLANILLA_TRAB IN(
        SELECT ID_PLANILLA_TRAB FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA AND ID_TRABAJADOR=P_ID_TRABAJADOR
      );
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB_PROCESO WHERE ID_PLANILLA_TRAB IN(
        SELECT ID_PLANILLA_TRAB FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA AND ID_TRABAJADOR=P_ID_TRABAJADOR
      );
      DELETE FROM ENOC.PLLA_PLANILLA_TRAB WHERE ID_PLANILLA=P_ID_PLANILLA AND ID_TRABAJADOR=P_ID_TRABAJADOR;
    END IF;
  END SP_ELIMINAR_PLANILLA_TRAB;
  
  PROCEDURE SP_INSERTAR_PLANILLA_TRAB(P_ID_TRABAJADOR VARCHAR2,P_ID_PLANILLA NUMBER,P_ID_ANHO number,P_ID_MES number,P_ID_USER NUMBER,P_ID_PLANILLA_TRAB OUT VARCHAR2, P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_planilla_trab varchar2(40);
    l_num_dias number;
    l_tipo_pago varchar2(5);
    l_id_remuneracion number;
    l_id_anho number;
    l_horas number;
    l_num_vacacion number:=0;
    l_num_faltas  number:=0;
    l_dias number:=30;
    l_num_dias_calc number;
    l_inicio date;
    l_fin date;
    l_inicio_proc date;
    l_fin_proc date;
    l_inicio_mes date;
    l_fin_mes date;
    l_dias_mes number;
  BEGIN
  
    l_inicio_mes:= TO_DATE(to_char(P_ID_ANHO)||'-'||to_char(P_ID_MES)||'-01','YYYY-MM-DD');
    select LAST_DAY(l_inicio_mes) into l_fin_mes from dual;
    
    select fecha_inicio, fecha_fin_previsto 
    into l_inicio,l_fin
    from moises.trabajador
    where id_trabajador=P_ID_TRABAJADOR;
    
    if l_inicio>l_fin_mes then
      l_error:=1;
      l_msgerror:='No corresponde';
      goto salida;
    end if;
    
    if l_inicio<l_inicio_mes then
      l_inicio_proc:=l_inicio_mes;
    else
      l_inicio_proc:=l_inicio;
    end if;
    
    if l_inicio_mes>l_fin then
      l_error:=1;
      l_msgerror:='No corresponde';
      goto salida;
    end if;
    
    if l_fin is not null then
      if l_fin>l_fin_mes then
        l_fin_proc:=l_fin_mes;
      else
        l_fin_proc:=l_fin;
      end if;
    else
      l_fin_proc:=l_fin_mes;
    end if;
    
    select (l_fin_proc - l_inicio_proc)+ 1 into l_dias_mes  from dual;
    
    if to_number(to_char(l_fin_mes,'DD'))=l_dias_mes then
      l_dias:=30;
    else
      l_dias:=l_dias_mes;
    end if;
    
    select 
    tipo_pago
    into
    l_tipo_pago
    from enoc.plla_remuneracion 
    where id_trabajador=P_ID_TRABAJADOR
    and vigencia=1;
    
    if l_tipo_pago='H' then
    
      select coalesce(sum(dias),0) into l_num_dias 
      from ENOC.plla_remuneracion_det 
      where id_remuneracion=l_id_remuneracion 
      and id_anho=P_ID_ANHO 
      and id_mes=P_ID_MES;

      l_num_dias_calc:=l_num_dias;
    
   else
      select
        coalesce(sum(case when ID_MOTIVO_ASIST='V' then NUM_HORAS else 0 end),0) as vacacion,
        coalesce(sum(case when ID_MOTIVO_ASIST in('PLD') and tipo='SI' then NUM_HORAS else 0 end),0) as faltas
        into
        l_num_vacacion,
        l_num_faltas
      from enoc.PLLA_CONTROL_ASISTENCIA
      where id_trabajador=P_ID_TRABAJADOR
      and id_anho=P_ID_ANHO 
      and id_mes=P_ID_MES;
      
      l_num_dias:=l_num_vacacion + l_num_faltas;
      l_num_dias_calc:=l_dias - l_num_dias;
    end if;
    
    if l_num_dias_calc<0 then
      l_num_dias_calc:=0;
      l_error:=1;
      l_msgerror:='Cero días';
      goto salida;
    end if;
    
    l_id_planilla_trab:= TO_CHAR(P_ID_PLANILLA)||TO_CHAR(P_ID_TRABAJADOR);
    
    INSERT INTO ENOC.PLLA_PLANILLA_TRAB(
      ID_PLANILLA_TRAB,
      ID_PLANILLA,
      ID_TRABAJADOR,
      ID_CONTRATO,
      ID_SEDEAREA,
      ID_PERFIL_PUESTO,
      ID_SITUACION_TRABAJADOR,
      ID_CONDICION_LABORAL,
      ID_TIPO_TIEMPO_TRABAJO,
      ID_TIPO_CONTROL_PERSONAL,
      NUM_DIAS,
      NUM_DIAS_VACACION,
      NUM_DIAS_FALTAS,
      ID_PROCESO_BOLETA,
      ID_USER_REG, 
	    FECHA_REG
    )
    SELECT
      l_id_planilla_trab,
      P_ID_PLANILLA,
      ID_TRABAJADOR,
      ID_CONTRATO,
      ID_SEDEAREA,
      ID_PERFIL_PUESTO,
      ID_SITUACION_TRABAJADOR,
      ID_CONDICION_LABORAL,
      ID_TIPO_TIEMPO_TRABAJO,
      ID_TIPO_CONTROL_PERSONAL,
      l_num_dias_calc,
      l_num_vacacion,
      l_num_faltas,
      1,--1	Sin firma,
      P_ID_USER,
      SYSDATE
    FROM MOISES.TRABAJADOR
    WHERE ID_TRABAJADOR=P_ID_TRABAJADOR;
  
    <<salida>>
    P_ID_PLANILLA_TRAB:=l_id_planilla_trab;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_INSERTAR_PLANILLA_TRAB;
  
  
  PROCEDURE SP_GEN_PLANILLA_TRAB_DET(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_USER number,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_config_planilla number;
    l_importe number(10,2):=0;
    l_num_error number:=0;
    i_ingreso number(10,2):=0;
    l_apor_empl number(10,2):=0;
    l_descuento number(10,2):=0;
    l_apor_trab number(10,2):=0;
    l_neto number(10,2):=0;
  BEGIN
    select
    ID_CONFIG_PLANILLA
    into
    l_id_config_planilla
    from enoc.VW_PLANILLA_TRAB
    where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    FOR curD in (SELECT ID_CONFIG_PLANILLA_CONCEPTO, PROCESO
                FROM ENOC.VW_CONFIG_PLANILLA_CONCEPTO B
                WHERE ID_CONFIG_PLANILLA=l_id_config_planilla 
                AND VIGENCIA=1 ORDER BY ORDEN_TIPO,ORDEN ) LOOP
    BEGIN
      dbms_output.put_line(P_ID_PLANILLA_TRAB);
      EXECUTE IMMEDIATE 'BEGIN ENOC.PKG_PLANILLA_PROC.'||curD.PROCESO||'(:P_ID_PLANILLA_TRAB,:P_ID_CONFIG_PLANILLA_CONCEPTO,:P_IMPORTE,:P_ERROR,:P_MSGERROR); end;'
      USING P_ID_PLANILLA_TRAB,curD.ID_CONFIG_PLANILLA_CONCEPTO, IN OUT l_importe, IN OUT l_error,IN OUT l_msgerror;
      if l_error=1 then
        l_num_error:= l_num_error + 1;
      end if;
    END;
    END LOOP;
    
    --I	INGRESOS
    --A	APORTACIONES DE CARGO DEL EMPLEADOR
    --D	DESCUENTOS AL TRABAJADOR
    --R	APORTACIONES DEL TRABAJADOR / PENSIONISTA
    select
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='I' THEN A.importe ELSE 0 END),0) as INGRESO,
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='A' THEN A.importe ELSE 0 END),0) as APOR_EMPL,
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='D' THEN A.importe ELSE 0 END),0) as DESCUENTO,
    coalesce(sum(case when B.ID_TIPO_CONCEPTO='R' THEN A.importe ELSE 0 END),0) as APOR_TRAB
    INTO
    i_ingreso,
    l_apor_empl,
    l_descuento,
    l_apor_trab
    from  ENOC.PLLA_PLANILLA_TRAB_DET A, ENOC.PLLA_CONCEPTO_PLANILLA B
    where a.ID_CONCEPTO_PLANILLA=B.ID_CONCEPTO_PLANILLA
    and A.ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB; 
    
    l_neto:=i_ingreso - (l_descuento+l_apor_trab);
    
    if l_neto<0 then
      l_neto:=0;
    end if;
    update ENOC.PLLA_PLANILLA_TRAB set
    TOTAL_INGRESO = i_ingreso,
    TOTAL_APOR_EMPL = l_apor_empl,
    TOTAL_APOR_TRAB = l_apor_trab,
    TOTAL_DESCUENTO = l_descuento,
    TOTAL_NETO = l_neto,
    TOTAL_PAGAR = l_neto,
    ID_USER_MOD=P_ID_USER,
    FECHA_MOD=sysdate
    where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    if l_num_error>0 then
      l_error:=1;
      l_msgerror:='Detalle generado con '||to_char(l_num_error)||' error ';
    end if;
  
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_GEN_PLANILLA_TRAB_DET;
  PROCEDURE SP_GEN_PLANILLA_TRAB_PROC(P_ID_PLANILLA_TRAB VARCHAR2,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
  BEGIN
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_GEN_PLANILLA_TRAB_PROC;
  PROCEDURE SP_GEN_PLANILLA_TRAB_CCOSTO(P_ID_PLANILLA_TRAB VARCHAR2,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
  BEGIN
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_GEN_PLANILLA_TRAB_CCOSTO;
    
 PROCEDURE SP_INSMOD_PLANILLA_TRAB_DET(
    P_ID_PLANILLA_TRAB	VARCHAR2,
    P_ID_CONCEPTO_PLANILLA	NUMBER,
    P_IMPORTE	NUMBER,
    P_NUM_DIAS	NUMBER,
    P_NUM_HORAS	NUMBER,
    P_IMPORTE_HORAS	NUMBER,
    P_IMPORTE_DIAS	NUMBER,
    P_IMPORTE_REF	NUMBER,
    P_PJE_REF	NUMBER,
    P_IMPORTE_BASE	NUMBER
  )AS
    l_contar number:=0;
    l_id_planilla_trab_det varchar2(50);
  BEGIN
  
    l_id_planilla_trab_det:= P_ID_PLANILLA_TRAB||to_char(P_ID_CONCEPTO_PLANILLA);
    
    select count(1) into l_contar from PLLA_PLANILLA_TRAB_DET where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB and ID_CONCEPTO_PLANILLA=P_ID_CONCEPTO_PLANILLA;
    
    if l_contar=0 then
    
      insert into PLLA_PLANILLA_TRAB_DET(
        ID_PLANILLA_TRAB_DET,
        ID_PLANILLA_TRAB,
        ID_CONCEPTO_PLANILLA,
        IMPORTE,
        NUM_DIAS,
        NUM_HORAS,
        IMPORTE_HORAS,
        IMPORTE_DIAS,
        IMPORTE_REF,
        PJE_REF,
        IMPORTE_BASE
      )values(
        l_id_planilla_trab_det,
        P_ID_PLANILLA_TRAB,
        P_ID_CONCEPTO_PLANILLA,
        P_IMPORTE,
        P_NUM_DIAS,
        P_NUM_HORAS,
        P_IMPORTE_HORAS,
        P_IMPORTE_DIAS,
        P_IMPORTE_REF,
        P_PJE_REF,
        P_IMPORTE_BASE
      );
    ELSE
      UPDATE PLLA_PLANILLA_TRAB_DET SET
        IMPORTE=P_IMPORTE,
        NUM_DIAS=P_NUM_DIAS,
        NUM_HORAS=P_IMPORTE,
        IMPORTE_HORAS=P_NUM_HORAS,
        IMPORTE_DIAS=P_IMPORTE_DIAS,
        IMPORTE_REF=P_IMPORTE_REF,
        PJE_REF=P_PJE_REF,
        IMPORTE_BASE=P_IMPORTE_BASE
      WHERE ID_PLANILLA_TRAB_DET=l_id_planilla_trab_det;
      
    END IF;
  END SP_INSMOD_PLANILLA_TRAB_DET;
END PKG_PLANILLA;