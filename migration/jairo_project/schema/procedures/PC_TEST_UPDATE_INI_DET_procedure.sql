-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = jairo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE jairo.pc_test_update_ini_det ( P_ID_MAPA JAIRO.SGE_MAPA.ID_MAPA%TYPE, P_ID_ANHO bigint DEFAULT NULL) AS $body$
DECLARE


  RET RECORD;

BEGIN


    FOR RET IN (SELECT SMID.ID_INICIATIVA_DETALLE,
                       SMID.ID_MAPA_INICIATIVA,
                       (
                           CASE
                               WHEN SMID.ID_SEMESTRE_I = 1 AND SMID.ID_SEMESTRE_II = 1
                                   THEN 1
                               WHEN SMID.ID_SEMESTRE_I = 1 AND (SMID.ID_SEMESTRE_II = 0 OR coalesce(SMID.ID_SEMESTRE_II::text, '') = '')
                                   THEN 1
                               WHEN(SMID.ID_SEMESTRE_I = 0 OR coalesce(SMID.ID_SEMESTRE_I::text, '') = '') AND SMID.ID_SEMESTRE_II = 1
                                   THEN 2
                               END
                           ) AS SEMESTRE,
                       (
                           CASE
                               WHEN SMID.ID_SEMESTRE_I = 1 AND SMID.ID_SEMESTRE_II = 1
                                   THEN 1
                               ELSE
                                   0
                               END
                           ) AS ES_ANUAL
                FROM JAIRO.SGE_MAPA_INICIATIVA_DETALLE SMID
                         INNER JOIN JAIRO.SGE_MAPA_INICIATIVA SMI ON SMID.ID_MAPA_INICIATIVA = SMI.ID_MAPA_INICIATIVA
                         INNER JOIN JAIRO.SGE_MAPA_OBJETIVO SMO ON SMI.ID_MAPA_OBJETIVO = SMO.ID_MAPA_OBJETIVO
                         INNER JOIN JAIRO.SGE_MAPA_DETALLE SMD ON SMO.ID_DETALLE = SMD.ID_DETALLE
                         INNER JOIN JAIRO.SGE_INICIATIVA SI ON SMI.ID_INICIATIVA = SI.ID_INICIATIVA
                WHERE SMID.TIPO = 1
                  AND SMO.ID_ANHO = P_ID_ANHO
                  AND SMD.ID_MAPA = P_ID_MAPA
                  AND coalesce(SMID.SEMESTRE::text, '') = ''
                  AND coalesce(SMID.ES_ANUAL::text, '') = '' )
        LOOP

            RAISE NOTICE 'ID_INICIATIVA_DETALLE: %, ID_MAPA_INICIATIVA: %, SEMESTRE: %, ES_ANUAL: %', RET.ID_INICIATIVA_DETALLE, RET.ID_MAPA_INICIATIVA, RET.SEMESTRE, RET.ES_ANUAL;


            -- 1. ACTUALIZAR EL DETALLE
            UPDATE JAIRO.SGE_MAPA_INICIATIVA_DETALLE SMID2
            SET SMID2.SEMESTRE=RET.SEMESTRE, -- ACTUALIZA SEMESTRE
                SMID2.ES_ANUAL=RET.ES_ANUAL   -- ACTUALIZA ES_ANUAL
            WHERE SMID2.ID_INICIATIVA_DETALLE = RET.ID_INICIATIVA_DETALLE
              AND SMID2.ID_MAPA_INICIATIVA = RET.ID_MAPA_INICIATIVA
              AND SMID2.TIPO = 1;

            -- 2. ACTUALIZAR EL INDICADOR
            UPDATE JAIRO.SGE_MAPA_INICIATIVA_INDICADOR SMII
            SET SMII.ID_INICIATIVA_DETALLE =RET.ID_INICIATIVA_DETALLE  -- ACTUALIZA ID_INICIATIVA_DETALLE
            WHERE SMII.ID_MAPA_INICIATIVA = RET.ID_MAPA_INICIATIVA
              AND (SMII.ID_MAPA_INDICADOR IS NOT NULL AND SMII.ID_MAPA_INDICADOR::text <> '')
              AND coalesce(SMII.ID_INICIATIVA_DETALLE::text, '') = '';


            -- 3. ACTUALIZAR LA ACTIVIDAD
            UPDATE JAIRO.SGE_ACTIVIDAD SA
            SET SA.ID_INICIATIVA_DETALLE =RET.ID_INICIATIVA_DETALLE  -- ACTUALIZA ID_INICIATIVA_DETALLE
            WHERE SA.ID_MAPA_INICIATIVA = RET.ID_MAPA_INICIATIVA
              AND coalesce(SA.ID_INICIATIVA_DETALLE::text, '') = ''
              AND SA.ID_ANHO = P_ID_ANHO;
            -- OJO
            -- 4. ACTUALIZAR EL FILE
            UPDATE JAIRO.SGE_FILE F
            SET F.ID_INICIATIVA_DETALLE =RET.ID_INICIATIVA_DETALLE  -- ACTUALIZA ID_INICIATIVA_DETALLE
            WHERE F.ID_MAPA_INICIATIVA = RET.ID_MAPA_INICIATIVA
              AND F.TIPO IN (6, 7, 8) -- Archivos de tipo plan iniciativa
              AND coalesce(F.ID_INICIATIVA_DETALLE::text, '') = '';

        END LOOP;


EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE '%', SQLERRM;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE jairo.pc_test_update_ini_det ( P_ID_MAPA JAIRO.SGE_MAPA.ID_MAPA%TYPE, P_ID_ANHO bigint DEFAULT NULL) FROM PUBLIC;

