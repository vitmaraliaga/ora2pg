-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = jairo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION jairo.fc_est_aprob_actividad (P_ID_ACTIVIDAD bigint, P_ID_TIPO_PROCESO bigint) RETURNS varchar AS $body$
DECLARE

l_dato varchar(5):='N';
l_contar integer:=0;
l_orden integer:=0;
l_id_tipo_actividad integer:=0;
l_orden_n integer:=0;
l_t_orden integer:=0;

BEGIN

    select ac.id_tipo_actividad,tp.orden into STRICT l_id_tipo_actividad,l_orden
    from JAIRO.sge_actividad ac 
    join JAIRO.sge_proceso_actividad pa on pa.id_proceso_actividad = ac.id_proceso_actividad
    join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso
    where ac.id_actividad = P_ID_ACTIVIDAD;

    select tp.orden into STRICT l_orden_n
    from JAIRO.sge_proceso_actividad pa
    join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso
    where tp.id_tipo_proceso = P_ID_TIPO_PROCESO
    and pa.id_tipo_actividad = l_id_tipo_actividad;

    select count(*) INTO STRICT l_contar
    from JAIRO.sge_proceso_actividad pa
    join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso and tp.estado = 1
    where pa.id_tipo_actividad = l_id_tipo_actividad;

     IF l_contar>0 THEN
        select count(*) INTO STRICT l_contar
        from JAIRO.sge_proceso_actividad pa
        join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso and tp.estado = 1
        where pa.id_tipo_actividad = l_id_tipo_actividad
        and tp.id_tipo_proceso = P_ID_TIPO_PROCESO;

       IF l_contar>0 THEN

        select max(tp.orden) into STRICT l_t_orden
        from JAIRO.sge_proceso_actividad pa
        join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso and tp.estado = 1
        where pa.id_tipo_actividad = 1
        and tp.orden < l_orden_n;

         if l_t_orden = l_orden then
            l_dato:='S';
         end if;
        END IF;
     END IF;

	RETURN(l_dato);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION jairo.fc_est_aprob_actividad (P_ID_ACTIVIDAD bigint, P_ID_TIPO_PROCESO bigint) FROM PUBLIC;

