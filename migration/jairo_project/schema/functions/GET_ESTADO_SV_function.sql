-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = jairo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION jairo.get_estado_sv (ex_id_iniciativa_detalle bigint) RETURNS varchar AS $body$
DECLARE

    v_id_anho bigint;
    v_es_lider bigint;
    v_id_dexec bigint;
    v_id_paso_actual bigint;
    v_estado_sv varchar(4000); -- Aumentar el tamaño de la variable si es necesario
BEGIN
    -- Obtener datos de la iniciativa
    SELECT id_anho, es_lider, id_dexec
    INTO STRICT v_id_anho, v_es_lider, v_id_dexec
    FROM VW_SV_INI_PROCESS_DATA
    WHERE id_iniciativa_detalle = ex_id_iniciativa_detalle;

    -- Obtener el paso actual
    SELECT id_paso_actual
    INTO STRICT v_id_paso_actual
    FROM VW_SV_INI_PROCESS_EXEC_DATA
    WHERE id_iniciativa_detalle = ex_id_iniciativa_detalle;

    -- Lógica IF y SWITCH
    IF v_id_anho >= 2024 THEN
        IF v_es_lider = 1 THEN
            CASE v_id_paso_actual
                WHEN 8 THEN  v_estado_sv := '{"id_paso": 8, "glosa": "Confirmado por Director de EP", "tipo_proceso": "2024-LIDER"}';
                WHEN 10 THEN v_estado_sv := '{"id_paso": 10, "glosa": "Validado por Tesorería", "tipo_proceso": "2024-LIDER"}';
                WHEN 11 THEN v_estado_sv := '{"id_paso": 11, "glosa": "Aprobado por CF/CU", "tipo_proceso": "2024-LIDER"}';
                ELSE v_estado_sv := '{"id_paso": null, "glosa": "Estado Desconocido", "tipo_proceso": null}';
            END CASE;
        ELSE
            CASE v_id_paso_actual
                WHEN 7 THEN  v_estado_sv := '{"id_paso": 7, "glosa": "Confirmado por Coordinador de EP", "tipo_proceso": "2024"}';
                WHEN 8 THEN  v_estado_sv := '{"id_paso": 8, "glosa": "Confirmado por Director de EP", "tipo_proceso": "2024"}';
                WHEN 10 THEN v_estado_sv := '{"id_paso": 10, "glosa": "Validado por Tesorería", "tipo_proceso": "2024"}';
                WHEN 11 THEN v_estado_sv := '{"id_paso": 11, "glosa": "Aprobado por CF/CU", "tipo_proceso": "2024"}';
                ELSE v_estado_sv := '{"id_paso": null, "glosa": "Estado Desconocido", "tipo_proceso": null}';
            END CASE;
        END IF;
    ELSIF v_id_anho = 2023 THEN
        CASE v_id_paso_actual
            WHEN 7 THEN  v_estado_sv := '{"id_paso": 7, "glosa": "Confirmado por Coordinador/Director de EP", "tipo_proceso": "2023"}';
            WHEN 8 THEN  v_estado_sv := '{"id_paso": 8, "glosa": "VB de Área/Eje Institucional", "tipo_proceso": "2023"}';
            ELSE v_estado_sv := '{"id_paso": null, "glosa": "Estado Desconocido", "tipo_proceso": null}';
        END CASE;
    ELSE
        CASE v_id_paso_actual
            WHEN 7 THEN  v_estado_sv := '{"id_paso": 7, "glosa": "Confirmado por Coordinador/Director de EP", "tipo_proceso": "2022"}';
            WHEN 8 THEN  v_estado_sv := '{"id_paso": 8, "glosa": "VB de Área/Eje Institucional", "tipo_proceso": "2022"}';
            WHEN 9 THEN  v_estado_sv := '{"id_paso": 9, "glosa": "VB de Dirección Académica/Planificación y Gestión de la Calidad", "tipo_proceso": "2022"}';
            WHEN 10 THEN v_estado_sv := '{"id_paso": 10, "glosa": "Validado por Tesorería", "tipo_proceso": "2022"}';
            WHEN 11 THEN v_estado_sv := '{"id_paso": 11, "glosa": "Voto de CF/CU", "tipo_proceso": "2022"}';
            ELSE v_estado_sv := '{"id_paso": null, "glosa": "Estado Desconocido", "tipo_proceso": null}';
        END CASE;
    END IF;

    RETURN v_estado_sv;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION jairo.get_estado_sv (ex_id_iniciativa_detalle bigint) FROM PUBLIC;

