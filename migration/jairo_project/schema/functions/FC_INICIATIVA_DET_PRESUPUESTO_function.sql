-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = jairo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION jairo.fc_iniciativa_det_presupuesto ( P_ID_INICIATIVA_DETALLE integer ) RETURNS bigint AS $body$
DECLARE
 R_PRESUPUESTO decimal(10,2);

BEGIN
   SELECT SUM(cp.cos_valor) into STRICT R_PRESUPUESTO
            FROM JAIRO.SGE_MAPA_INICIATIVA_DETALLE SMID
            INNER JOIN JAIRO.SGE_MAPA_INICIATIVA SMI ON SMI.ID_MAPA_INICIATIVA = SMID.ID_MAPA_INICIATIVA
            INNER JOIN JAIRO.SGE_MAPA_OBJETIVO SMO ON SMO.ID_MAPA_OBJETIVO = SMI.ID_MAPA_OBJETIVO
            INNER JOIN JAIRO.SGE_MAPA_DETALLE SMD ON SMD.ID_DETALLE = SMO.ID_DETALLE
            INNER JOIN JAIRO.SGE_MAPA SM ON SM.ID_MAPA = SMD.ID_MAPA
            INNER JOIN JAIRO.SGE_EJE_DEPTO_MAPA sedm ON sedm.ID_MAPA = SM.ID_MAPA
            INNER JOIN ELISEO.CONTA_PRESUPUESTO cp ON cp.ID_DEPTO = sedm.DEPTO
            INNER JOIN( SELECT sic.id_iniciativa_cuenta, sic.id_iniciativa, sic.id_cuentaaasi,CASE WHEN sic.tiene_ctacte='S' THEN sicc.cta_cte  ELSE 'X' END  cta_cte ,sic.tiene_ctacte from jairo.sge_iniciativa_cuenta sic 
            left join jairo.sge_iniciativa_cuenta_cte sicc on sic.id_iniciativa_cuenta = sicc.id_iniciativa_cuenta
             ) tsic on tsic.id_iniciativa = smi.id_iniciativa AND tsic.id_cuentaaasi =cp.id_cuentaaasi   and tsic.cta_cte = CASE WHEN tsic.tiene_ctacte='S' THEN cp.id_ctacte  ELSE 'X' END 
            WHERE SMID.ID_INICIATIVA_DETALLE = P_ID_INICIATIVA_DETALLE
            AND (
                (coalesce(SMO.ID_ANHO::text, '') = '' AND cp.ID_ANHO = SMO.ID_ANHO)
                OR ((SMO.ID_ANHO IS NOT NULL AND SMO.ID_ANHO::text <> '') AND cp.ID_ANHO = SMO.ID_ANHO)
            )
            AND SMD.ID_EJE = sedm.ID_EJE
            AND (
                (SMID.ID_SEMESTRE_I = 1 AND SMID.ID_SEMESTRE_II = 1)
                OR (SMID.ID_SEMESTRE_I = 1 AND cp.ID_MES BETWEEN 1 AND 6)
                OR (SMID.ID_SEMESTRE_II = 1 AND cp.ID_MES BETWEEN 7 AND 12)
            );

return R_PRESUPUESTO;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION jairo.fc_iniciativa_det_presupuesto ( P_ID_INICIATIVA_DETALLE integer ) FROM PUBLIC;

