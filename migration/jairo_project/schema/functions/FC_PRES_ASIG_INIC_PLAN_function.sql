-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = jairo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION jairo.fc_pres_asig_inic_plan ( P_ID_MAPA_INICIATIVA JAIRO.SGE_MAPA_INICIATIVA.ID_MAPA_INICIATIVA%TYPE, P_SEMESTRE bigint DEFAULT NULL) RETURNS bigint AS $body$
DECLARE


    P_RESULT         bigint := 0.0;
    P_PERIODO_INICIO bigint := NULL;
    P_PERIODO_FIN    bigint := NULL;
    P_ID_EJE         JAIRO.SGE_MAPA_DETALLE.ID_EJE%TYPE;
    P_ID_MAPA        JAIRO.SGE_MAPA_DETALLE.ID_MAPA%TYPE;
    P_ID_ENTIDAD     JAIRO.SGE_MAPA.ID_ENTIDAD%TYPE;
    P_ID_INICIATIVA  JAIRO.SGE_INICIATIVA.ID_INICIATIVA%TYPE;



BEGIN

    IF P_SEMESTRE = 1 THEN
        P_PERIODO_INICIO := 1;
        P_PERIODO_FIN := 6;
    ELSIF P_SEMESTRE = 2 THEN
        P_PERIODO_INICIO := 7;
        P_PERIODO_FIN := 12;
    END IF;


    SELECT SMD.ID_EJE, SMD.ID_MAPA, SM.ID_ENTIDAD, SMI.ID_INICIATIVA
    INTO STRICT P_ID_EJE, P_ID_MAPA, P_ID_ENTIDAD, P_ID_INICIATIVA
    FROM JAIRO.SGE_MAPA_INICIATIVA SMI
             INNER JOIN JAIRO.SGE_MAPA_OBJETIVO SMO ON SMI.ID_MAPA_OBJETIVO = SMO.ID_MAPA_OBJETIVO
             INNER JOIN JAIRO.SGE_MAPA_DETALLE SMD ON SMO.ID_DETALLE = SMD.ID_DETALLE
             INNER JOIN JAIRO.SGE_MAPA SM ON SMD.ID_MAPA = SM.ID_MAPA
    WHERE SMI.ID_MAPA_INICIATIVA = P_ID_MAPA_INICIATIVA;


    SELECT SUM(IMPORTE)
    INTO STRICT P_RESULT
    FROM (SELECT A.ID_MES,
                 ABS(A.COS_VALOR) AS IMPORTE
          FROM ELISEO.CONTA_PRESUPUESTO A
                   JOIN(SELECT X.ID_CUENTAAASI, Y.CTA_CTE
                         FROM JAIRO.SGE_INICIATIVA_CUENTA X
                                  JOIN JAIRO.SGE_INICIATIVA_CUENTA_CTE Y
                                       ON X.ID_INICIATIVA_CUENTA = Y.ID_INICIATIVA_CUENTA
                         WHERE X.ID_INICIATIVA = P_ID_INICIATIVA) B
                        ON A.ID_CUENTAAASI = B.ID_CUENTAAASI AND A.ID_CTACTE = B.CTA_CTE
                   JOIN JAIRO.SGE_EJE_DEPTO_MAPA C ON A.ID_DEPTO = C.DEPTO
          WHERE A.ID_ENTIDAD = P_ID_ENTIDAD
            AND A.ID_ANHO in (SELECT MAX(ID_ANHO) AS ID_ANHO
                              FROM ELISEO.CONTA_ENTIDAD_ANHO_CONFIG
                              WHERE ID_ENTIDAD = P_ID_ENTIDAD
                                AND ACTIVO = '1')
            AND C.ID_EJE = P_ID_EJE
            AND C.ID_MAPA = P_ID_MAPA
          
UNION ALL

          SELECT A.ID_MES,
                 ABS(A.COS_VALOR) AS IMPORTE
          FROM ELISEO.CONTA_PRESUPUESTO A
                   JOIN JAIRO.SGE_INICIATIVA_CUENTA B ON A.ID_CUENTAAASI = B.ID_CUENTAAASI
                   JOIN JAIRO.SGE_EJE_DEPTO_MAPA C ON A.ID_DEPTO = C.DEPTO
          WHERE A.ID_ENTIDAD = P_ID_ENTIDAD
            AND A.ID_ANHO in (SELECT MAX(ID_ANHO) AS ID_ANHO
                              FROM ELISEO.CONTA_ENTIDAD_ANHO_CONFIG
                              WHERE ID_ENTIDAD = P_ID_ENTIDAD
                                AND ACTIVO = '1')
            AND B.ID_INICIATIVA = P_ID_INICIATIVA
            AND B.TIENE_CTACTE = 'N'
            AND C.ID_EJE = P_ID_EJE
            AND C.ID_MAPA = P_ID_MAPA 
          ORDER BY ID_MES) alias8
    WHERE ID_MES IN (WITH RECURSIVE cte AS (
SELECT LEVEL AS VAL  WHERE LEVEL >= P_PERIODO_INICIO LEVEL <= P_PERIODO_FIN  UNION ALL
SELECT LEVEL AS VAL  WHERE LEVEL >= P_PERIODO_INICIO LEVEL <= P_PERIODO_FIN JOIN cte c ON ()

) SELECT * FROM cte);

    RETURN P_RESULT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION jairo.fc_pres_asig_inic_plan ( P_ID_MAPA_INICIATIVA JAIRO.SGE_MAPA_INICIATIVA.ID_MAPA_INICIATIVA%TYPE, P_SEMESTRE bigint DEFAULT NULL) FROM PUBLIC;

