-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = jairo,pkg_planning,public;




CREATE OR REPLACE PROCEDURE jairo.pkg_planning_sp_copy_mapa (P_ID_PLAN bigint,P_ID_MAPA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text,P_ID_MAP OUT bigint) AS $body$
DECLARE

        L_ID_MAPA_1 bigint;
        L_ID_MAPA_2 bigint;
        L_ID_MAPA_3 bigint;
        L_ID_MAPA_OLD bigint;
        L_ID_MAPA_OLD_1 bigint;
        L_ID_PARENT_MAPA bigint;
        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_ID_TIPO_NIVEL bigint;
        L_ID_AREA bigint;
        L_ID_SEDEAREA bigint;
        L_NOMBRE varchar(200);
        L_DESCRIPCION varchar(200);
        L_ESTADO varchar(1);
        --P_ERROR NUMBER;
        --P_MSGERROR VARCHAR2(200);
        --P_ID_MAPA NUMBER;
        C_MAPA_LEVEL_1 CURSOR FOR
        SELECT ID_MAPA,ID_ENTIDAD,ID_DEPTO,ID_TIPO_NIVEL,ID_AREA,ID_SEDEAREA,NOMBRE,DESCRIPCION,ESTADO
        FROM SGE_MAPA WHERE ID_MAPA = P_ID_MAPA;

        C_MAPA_LEVEL_2 CURSOR FOR
        SELECT ID_MAPA,ID_ENTIDAD,ID_DEPTO,ID_TIPO_NIVEL,ID_AREA,ID_SEDEAREA,NOMBRE,DESCRIPCION,ESTADO
        FROM SGE_MAPA WHERE ID_PARENT_MAPA = L_ID_MAPA_OLD;

        C_MAPA_LEVEL_3 CURSOR FOR
        SELECT ID_ENTIDAD,ID_DEPTO,ID_TIPO_NIVEL,ID_AREA,ID_SEDEAREA,NOMBRE,DESCRIPCION,ESTADO
        FROM SGE_MAPA WHERE ID_PARENT_MAPA = L_ID_MAPA_OLD_1;



BEGIN

            OPEN C_MAPA_LEVEL_1;
                    FETCH C_MAPA_LEVEL_1 INTO L_ID_MAPA_OLD,L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO;
                        WHILE C_MAPA_LEVEL_1%FOUND LOOP

                        --INSERT INTO SGE_MAPA(ID_PARENT_MAPA,ID_ENTIDAD,ID_DEPTO,ID_PLAN,ID_TIPO_NIVEL,ID_AREA,ID_SEDEAREA,NOMBRE,DESCRIPCION,ESTADO)
                        --VALUES(L_ID_PARENT_MAPA,L_ID_ENTIDAD,L_ID_DEPTO,P_ID_PLAN,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO) RETURNING ID_MAPA INTO L_ID_MAPA_1;
                        CALL pkg_planning_sp_create_map(L_ID_PARENT_MAPA,L_ID_ENTIDAD,L_ID_DEPTO,P_ID_PLAN,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,P_ERROR,P_MSGERROR,L_ID_MAPA_1);

                        OPEN C_MAPA_LEVEL_2;
                            FETCH C_MAPA_LEVEL_2 INTO L_ID_MAPA_OLD_1,L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO;
                            WHILE C_MAPA_LEVEL_2%FOUND LOOP

                                --INSERT INTO SGE_MAPA(ID_PARENT_MAPA,ID_ENTIDAD,ID_DEPTO,ID_PLAN,ID_TIPO_NIVEL,ID_AREA,ID_SEDEAREA,NOMBRE,DESCRIPCION,ESTADO)
                                --VALUES(L_ID_MAPA_1,L_ID_ENTIDAD,L_ID_DEPTO,P_ID_PLAN,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO) RETURNING ID_MAPA INTO L_ID_MAPA_2;
                                CALL pkg_planning_sp_create_map(L_ID_MAPA_1,L_ID_ENTIDAD,L_ID_DEPTO,P_ID_PLAN,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,P_ERROR,P_MSGERROR,L_ID_MAPA_2);

                                OPEN C_MAPA_LEVEL_3;
                                    FETCH C_MAPA_LEVEL_3 INTO L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO;
                                    WHILE C_MAPA_LEVEL_3%FOUND LOOP

                                    --INSERT INTO SGE_MAPA(ID_PARENT_MAPA,ID_ENTIDAD,ID_DEPTO,ID_PLAN,ID_TIPO_NIVEL,ID_AREA,ID_SEDEAREA,NOMBRE,DESCRIPCION,ESTADO)
                                    --VALUES(L_ID_MAPA_2,L_ID_ENTIDAD,L_ID_DEPTO,P_ID_PLAN,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO);
                                    CALL pkg_planning_sp_create_map(L_ID_MAPA_2,L_ID_ENTIDAD,L_ID_DEPTO,P_ID_PLAN,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,P_ERROR,P_MSGERROR,L_ID_MAPA_3);

                                    FETCH C_MAPA_LEVEL_3 INTO L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO;
                                    END LOOP;
                                CLOSE C_MAPA_LEVEL_3;

                            FETCH C_MAPA_LEVEL_2 INTO L_ID_MAPA_OLD_1,L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO;
                            END LOOP;
                        CLOSE C_MAPA_LEVEL_2;

                    FETCH C_MAPA_LEVEL_1 INTO L_ID_MAPA_OLD,L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,L_NOMBRE,L_DESCRIPCION,L_ESTADO;
                END LOOP;
            CLOSE C_MAPA_LEVEL_1;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE jairo.pkg_planning_sp_copy_mapa (P_ID_PLAN bigint,P_ID_MAPA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text,P_ID_MAP OUT bigint) FROM PUBLIC;
