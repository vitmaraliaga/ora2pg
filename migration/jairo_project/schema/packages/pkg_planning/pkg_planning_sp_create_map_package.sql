-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = jairo,pkg_planning,public;

/******************************************************************************
   NAME:       PKG_PLANNING
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        03/11/2021      digeti       1. Created this package body.
******************************************************************************/
CREATE OR REPLACE PROCEDURE jairo.pkg_planning_sp_create_map (P_ID_PARENT_MAPA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_PLAN bigint,P_ID_TIPO_NIVEL bigint,P_ID_AREA bigint,P_ID_SEDEAREA bigint,P_NOMBRE text,P_DESCRIPCION text, P_ERROR OUT bigint,P_MSGERROR OUT text,P_ID_MAPA OUT bigint) AS $body$
DECLARE

        L_ID_MAPA bigint;
        L_ID_PERSPECTIVA bigint;
        L_ORDEN bigint;
        L_ID_PARENT_MAPA bigint;
        L_ID_DEPTO varchar(10);
        L_ID_AREA bigint;
        L_ID_SEDEAREA bigint;
        L_ID_EJE bigint;
        L_CANT bigint;

        C_PERSPECTIVA CURSOR FOR
        SELECT ID_PERSPECTIVA, ORDEN FROM SGE_PERSPECTIVA WHERE ESTADO = '1';

        C_EJE CURSOR FOR
        SELECT ID_EJE FROM SGE_EJE WHERE ID_PLAN = P_ID_PLAN;

        
BEGIN
            IF P_ID_TIPO_NIVEL = 1 THEN  --NIVEL ESTRATEGICO
                L_ID_PARENT_MAPA := NULL;
                L_ID_DEPTO := '0';--SI ES LA ENTIDAD 7124, DE LAS ENTIDAD VER SU DEPTO CONSOLIDADOR
                L_ID_AREA := NULL;
                L_ID_SEDEAREA := NULL;
            ELSE
                L_ID_PARENT_MAPA := P_ID_PARENT_MAPA;
                L_ID_DEPTO := P_ID_DEPTO;
                L_ID_AREA := P_ID_AREA;
                --L_ID_SEDEAREA := P_ID_SEDEAREA;
                IF P_ID_SEDEAREA = 0 THEN
                    L_ID_SEDEAREA := NULL;
                ELSE
                    L_ID_SEDEAREA := P_ID_SEDEAREA;
                END IF;

            END IF;

            SELECT COUNT(ID_EJE) INTO STRICT L_CANT FROM SGE_EJE WHERE ID_PLAN = P_ID_PLAN;

            IF L_CANT > 0 THEN 
            
                INSERT INTO SGE_MAPA(ID_PARENT_MAPA, ID_ENTIDAD,ID_DEPTO,ID_PLAN,ID_TIPO_NIVEL,ID_AREA,ID_SEDEAREA,NOMBRE,DESCRIPCION,ESTADO)
                VALUES (L_ID_PARENT_MAPA,P_ID_ENTIDAD,L_ID_DEPTO,P_ID_PLAN,P_ID_TIPO_NIVEL,L_ID_AREA,L_ID_SEDEAREA,P_NOMBRE,P_DESCRIPCION,'1')RETURNING ID_MAPA INTO L_ID_MAPA;

                    OPEN C_PERSPECTIVA;
                      FETCH C_PERSPECTIVA INTO L_ID_PERSPECTIVA,L_ORDEN;
                        WHILE C_PERSPECTIVA%FOUND LOOP

                            OPEN C_EJE;
                                FETCH C_EJE INTO L_ID_EJE;
                                WHILE C_EJE%FOUND LOOP
                                    INSERT INTO SGE_MAPA_DETALLE(ID_MAPA,ID_PERSPECTIVA,ID_EJE,ORDEN,ESTADO)VALUES (L_ID_MAPA,L_ID_PERSPECTIVA,L_ID_EJE,L_ORDEN,'1');
                                    FETCH C_EJE INTO L_ID_EJE;
                                END LOOP;
                            CLOSE C_EJE;

                            --INSERT INTO SGE_MAPA_DETALLE(ID_MAPA,ID_PERSPECTIVA,ID_EJE,ORDEN,ESTADO)VALUES(L_ID_MAPA,L_ID_PERSPECTIVA,L_ORDEN);
                            FETCH C_PERSPECTIVA INTO L_ID_PERSPECTIVA,L_ORDEN;
                        END LOOP;
                    CLOSE C_PERSPECTIVA;
                P_ERROR:= 0;
                P_MSGERROR := 'OK';
            ELSE
                P_ERROR:= 1;
                P_MSGERROR := 'ERROR: No existen Ejes para el Plan';
            END IF;

            P_ID_MAPA := L_ID_MAPA;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE jairo.pkg_planning_sp_create_map (P_ID_PARENT_MAPA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_PLAN bigint,P_ID_TIPO_NIVEL bigint,P_ID_AREA bigint,P_ID_SEDEAREA bigint,P_NOMBRE text,P_DESCRIPCION text, P_ERROR OUT bigint,P_MSGERROR OUT text,P_ID_MAPA OUT bigint) FROM PUBLIC;
