-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = jairo,public;
\set ON_ERROR_STOP ON

function FC_EST_APROB_ACTIVIDAD(P_ID_ACTIVIDAD NUMBER, P_ID_TIPO_PROCESO NUMBER) RETURN VARCHAR2
IS
l_dato VARCHAR2(5):='N';
l_contar int:=0;
l_orden int:=0;
l_id_tipo_actividad int:=0;
l_orden_n int:=0;
l_t_orden int:=0;
BEGIN

    select ac.id_tipo_actividad,tp.orden into l_id_tipo_actividad,l_orden 
    from JAIRO.sge_actividad ac 
    join JAIRO.sge_proceso_actividad pa on pa.id_proceso_actividad = ac.id_proceso_actividad
    join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso
    where ac.id_actividad = P_ID_ACTIVIDAD;

    select tp.orden into l_orden_n
    from JAIRO.sge_proceso_actividad pa
    join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso
    where tp.id_tipo_proceso = P_ID_TIPO_PROCESO
    and pa.id_tipo_actividad = l_id_tipo_actividad;

    select count(*) INTO l_contar
    from JAIRO.sge_proceso_actividad pa
    join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso and tp.estado = 1
    where pa.id_tipo_actividad = l_id_tipo_actividad;

     IF l_contar>0 THEN
        select count(*) INTO l_contar
        from JAIRO.sge_proceso_actividad pa
        join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso and tp.estado = 1
        where pa.id_tipo_actividad = l_id_tipo_actividad
        and tp.id_tipo_proceso = P_ID_TIPO_PROCESO;

       IF l_contar>0 THEN

        select max(tp.orden) into l_t_orden
        from JAIRO.sge_proceso_actividad pa
        join jairo.sge_tipo_proceso tp on tp.id_tipo_proceso = pa.id_tipo_proceso and tp.estado = 1
        where pa.id_tipo_actividad = 1
        and tp.orden < l_orden_n;

         if l_t_orden = l_orden then
            l_dato:='S';
         end if;
        END IF;
     END IF;

	RETURN(l_dato);
END;

