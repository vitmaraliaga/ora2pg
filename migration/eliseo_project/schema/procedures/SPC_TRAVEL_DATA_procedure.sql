-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.spc_travel_data ( p_id_entidad integer, p_id_anho integer, p_id_mes integer, p_id_cta_cte text, OUT CURSOR REFCURSOR ) AS $body$
DECLARE


    l_saldo_inicial decimal(38,2);
    l_ppto decimal(38,2);
    l_realizado decimal(38,2);
    l_ppto_adicional decimal(38,2);


BEGIN
    DELETE FROM TT_TABLE_AUX;
    l_saldo_inicial:= 0;
    l_ppto_adicional:= 0;


    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '40444487' THEN
    	l_ppto_adicional := -5945.26;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '45777162' THEN
    	l_ppto_adicional := -2046;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '09765529' THEN
    	l_ppto_adicional := 139.80;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '00668284' THEN
    	l_ppto_adicional := -2311;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '02306602' THEN
    	l_ppto_adicional := -2485.65;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '01817568' THEN
    	l_ppto_adicional := -3034;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '10604098' THEN
    	l_ppto_adicional := -1205;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2019 and p_id_cta_cte = '01781518' THEN
    	l_ppto_adicional := -6280;
    END IF;


    if p_id_entidad = 17112 and p_id_anho=2018 and p_id_cta_cte = '09765529' THEN
    	l_ppto_adicional := 123;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2018 and p_id_cta_cte = '42082304' THEN
    	l_ppto_adicional := 38276.76;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2018 and p_id_cta_cte = '10604098' THEN
    	l_ppto_adicional := 1574.20;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2018 and p_id_cta_cte = '40444487' THEN
    	l_ppto_adicional := 1380.20;
    END IF;
    if p_id_entidad = 17112 and p_id_anho=2018 and p_id_cta_cte = '42250226' THEN
    	l_ppto_adicional := 1426.20;
    END IF;

    IF p_id_entidad = 17112 and p_id_anho < 2019 then

    SELECT (coalesce(sum(saldo_inicial),0) + l_ppto_adicional) into STRICT l_saldo_inicial
        FROM (
        SELECT
            sum(di.COS_VALOR) saldo_inicial
        from VW_CONTA_DIARIO di
        where di.id_ctacte = p_id_cta_cte
        and di.ID_ENTIDAD = p_id_entidad
        and di.ID_ANHO between 2016 and (p_id_anho-1)
        and di.ID_ANHO < 2019
        and di.ID_MES = 12
        AND ID_TIPOASIENTO = 'EA'
        and di.ID_CUENTAAASI in (4113023,4121029,4111070,4111022,4111023,4111073,4111071,4113093)
        and di.ID_DEPTO IN ( 396119, 980319, 127611)
        and di.ID_CTACTE <> 0 
        
UNION

        SELECT
        sum(p.COS_VALOR) *-1 saldo_inicial
        from vw_conta_Presupuesto p
        where p.ID_ENTIDAD = p_id_entidad
        and p.ID_CTACTE=p_id_cta_cte
        and p.ID_ANHO between 2016 and (p_id_anho-1) 
        and p.ID_ANHO < 2019
        and p.ID_MES <= 12
        and p.ID_CUENTAAASI  in (4111022,4111023,4111070,4111071,4111073,4113023,4121029,4113093)
        and p.ID_DEPTO IN ( 396119, 980319, 127611)
        and p.ID_CTACTE <> 0 
        ) a     
;
    ELSE

    l_saldo_inicial := l_ppto_adicional;

    
    END IF;

    select
        coalesce(abs(sum(p.COS_VALOR)),0) into STRICT l_ppto
        from vw_conta_Presupuesto p
        where p.ID_ENTIDAD = p_id_entidad
        and p.ID_CTACTE=p_id_cta_cte
        and p.ID_ANHO IN (p_id_anho)
        and p.ID_MES <= 12
        and p.ID_CUENTAAASI  in (4111022,4111023,4111070,4111071,4111073,4113023,4121029,4113093)
        and p.ID_DEPTO IN ( 396119, 980319, 127611)
        and p.ID_CTACTE <> 0 
;
    select
        coalesce(sum(di.COS_VALOR),0) into STRICT l_realizado
        from VW_CONTA_DIARIO di
        where di.ID_ENTIDAD = p_id_entidad
        and di.ID_CTACTE = p_id_cta_cte
        and di.ID_ANHO = p_id_anho
        --and di.ID_MES <= p_id_mes
        and di.ID_CUENTAAASI  in (4111022,4111023,4111070,4111071,4111073,4113023,4121029,4113093)
        and di.ID_DEPTO IN ( 396119, 980319, 127611)
        and di.ID_CTACTE <> 0
        and di.ID_TIPOASIENTO != 'EA' 
;


    

    INSERT INTO TT_TABLE_AUX(NUM_1, NUM_2, NUM_4) 
    VALUES (l_saldo_inicial, l_ppto, l_realizado);

    update TT_TABLE_AUX set 
    NUM_3 = NUM_1 + NUM_2;

    update TT_TABLE_AUX set 
    NUM_5 = NUM_3 - NUM_4;

    OPEN CURSOR FOR 
    SELECT 
      NUM_1 as saldo_inicial,
      NUM_2 as ppto,
      NUM_3 as total_ppto,
      NUM_4 as realizado,
      NUM_5 as saldo
    from TT_TABLE_AUX 
;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.spc_travel_data ( p_id_entidad integer, p_id_anho integer, p_id_mes integer, p_id_cta_cte text, OUT CURSOR REFCURSOR ) FROM PUBLIC;

