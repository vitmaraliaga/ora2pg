-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.scp_dinamic_replace_by_di ( v_ID_DINAMICA_FROM bigint, v_ID_DINAMICA_TO bigint, v_ERROR OUT bigint, v_MSGERROR OUT text ) AS $body$
DECLARE

    L_ERROR bigint :=0;
    L_MSGERROR varchar(100) :='';
    l_contar bigint := 0;

	
	v_d_a_cursor REFCURSOR;
	d_a_record      CONTA_DINAMICA_ASIENTO%ROWTYPE;
	v_d_a_stmt_str      varchar(200);

	
	v_d_cc_cursor REFCURSOR;
	d_cc_record      CONTA_DINAMICA_CTA_CTE%ROWTYPE;
	v_d_cc_stmt_str      varchar(200);

	
	v_d_d_cursor REFCURSOR;
	d_d_record      CONTA_DINAMICA_DEPTO%ROWTYPE;
	v_d_d_stmt_str      varchar(200);

   l_id_dinamica bigint;
   l_id_asiento bigint;

   l_id_ctabancaria  bigint;
   l_id_almacen bigint;

    l_id_depto_to varchar(20);
    l_id_entidad_to bigint;

    c1 CURSOR FOR
	SELECT * FROM conta_dinamica
	WHERE ID_DINAMICA = v_ID_DINAMICA_FROM
;

BEGIN


    IF L_ERROR = 0 THEN

        l_id_dinamica := v_ID_DINAMICA_TO;
        SELECT id_depto, id_entidad into STRICT l_id_depto_to,l_id_entidad_to FROM conta_dinamica
            WHERE ID_DINAMICA = v_ID_DINAMICA_TO;

        FOR rec_1 in c1
        LOOP

                delete from CONTA_DINAMICA_CTA_CTE where id_asiento in (SELECT t.id_asiento from CONTA_DINAMICA_ASIENTO t where t.id_dinamica = l_id_dinamica);
                delete from CONTA_DINAMICA_DEPTO where id_asiento in (SELECT t.id_asiento from CONTA_DINAMICA_ASIENTO t where t.id_dinamica = l_id_dinamica);
                delete from CONTA_DINAMICA_ASIENTO where id_dinamica = l_id_dinamica;

                v_d_a_stmt_str := 'SELECT * FROM CONTA_DINAMICA_ASIENTO WHERE id_dinamica = :1 order by ID_ASIENTO';

                OPEN v_d_a_cursor FOR EXECUTE EXECUTE v_d_a_stmt_str USING rec_1.ID_DINAMICA;
                    LOOP
                    FETCH v_d_a_cursor INTO d_a_record;
                  EXIT WHEN NOT FOUND;/* apply on v_d_a_cursor */
                    --l_id_asiento := l_id_asiento +1;
                    INSERT INTO CONTA_DINAMICA_ASIENTO(
                                    -- ID_ASIENTO,
                                    ID_PARENT, ID_DINAMICA, ID_TIPOPLAN,
                                    ID_RESTRICCION, ID_CUENTAAASI, ID_CUENTAEMPRESARIAL,
                                    NOMBRE, DC, PORCENTAJE, NRO_ASIENTO,
                                    ACTIVO, DESTINO, ID_INDICADOR,
                                    UNICO, UNICO_CTACTE, AGRUPA, ID_FONDO, PRIMARIO)
                                VALUES (
                                    -- l_id_asiento, 
                                    d_a_record.ID_PARENT, l_id_dinamica, d_a_record.ID_TIPOPLAN, 
                                    d_a_record.ID_RESTRICCION, d_a_record.ID_CUENTAAASI, d_a_record.ID_CUENTAEMPRESARIAL,
                                    d_a_record.NOMBRE, d_a_record.DC, d_a_record.PORCENTAJE, d_a_record.NRO_ASIENTO,
                                    d_a_record.ACTIVO, d_a_record.DESTINO, d_a_record.ID_INDICADOR,
                                    d_a_record.UNICO, d_a_record.UNICO_CTACTE, d_a_record.AGRUPA, d_a_record.ID_FONDO,d_a_record.PRIMARIO)
                                returning ID_ASIENTO INTO l_id_asiento;

                        v_d_cc_stmt_str := 'SELECT * FROM CONTA_DINAMICA_CTA_CTE WHERE id_asiento = :j order by ID_ASIENTO';

                        OPEN v_d_cc_cursor FOR EXECUTE EXECUTE EXECUTE v_d_cc_stmt_str USING d_a_record.ID_ASIENTO;
                            LOOP
                            FETCH v_d_cc_cursor INTO d_cc_record;
                            EXIT WHEN NOT FOUND;/* apply on v_d_cc_cursor */
                            if d_cc_record.ID_CTACTE = rec_1.id_depto then
                                INSERT INTO CONTA_DINAMICA_CTA_CTE(ID_ASIENTO, ID_ENTIDAD, ID_CTACTE)
                                        VALUES (l_id_asiento, l_id_entidad_to, l_id_depto_to);
                            else
                                INSERT INTO CONTA_DINAMICA_CTA_CTE(ID_ASIENTO, ID_ENTIDAD, ID_CTACTE)
                                        VALUES (l_id_asiento, l_id_entidad_to, d_cc_record.ID_CTACTE);
                            end if;
                        END LOOP;
                        CLOSE v_d_cc_cursor;	
                        v_d_d_stmt_str := 'SELECT * FROM CONTA_DINAMICA_DEPTO WHERE id_asiento = :1';
                        OPEN v_d_d_cursor FOR EXECUTE EXECUTE v_d_d_stmt_str USING d_a_record.ID_ASIENTO;
                            LOOP
                            FETCH v_d_d_cursor INTO d_d_record;
                            EXIT WHEN NOT FOUND;/* apply on v_d_d_cursor */

                            INSERT INTO CONTA_DINAMICA_DEPTO(ID_ASIENTO, ID_ENTIDAD, ID_DEPTO)
                                        VALUES (l_id_asiento, l_id_entidad_to, d_d_record.ID_DEPTO);
                        END LOOP;
                        CLOSE v_d_d_cursor;	

                END LOOP;
                CLOSE v_d_a_cursor;
            END LOOP;
        END IF;

-- <<salida_rapida>>

        V_ERROR := L_ERROR;
        V_MSGERROR := L_MSGERROR;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.scp_dinamic_replace_by_di ( v_ID_DINAMICA_FROM bigint, v_ID_DINAMICA_TO bigint, v_ERROR OUT bigint, v_MSGERROR OUT text ) FROM PUBLIC;

