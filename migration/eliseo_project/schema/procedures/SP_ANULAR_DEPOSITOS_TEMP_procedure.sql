-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.sp_anular_depositos_temp (P_ID_DEPOSITO bigint) AS $body$
DECLARE

        P_ERROR bigint;
        P_MSN varchar(200);
        L_ID_VOUCHER bigint;
        L_ACTIVO varchar(1);
        L_ID_KARDEX bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_ID_ANHO bigint;
        L_ID_TIPOORIGEN bigint := 1;
        L_ID_ASIENTO bigint;
        L_DATA varchar(255);

        L_ID_DEPOSITO bigint;
        L_ID_VOUCHER_DEP bigint;
        L_ID_TIPOORIGEN_DEP bigint;
        L_CANT bigint;

        asientos_dep CURSOR FOR
        SELECT
                A.ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN CAJA_DEPOSITO B
        ON A.ID_ORIGEN = B.ID_DEPOSITO
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN_DEP
        AND A.ID_ORIGEN = P_ID_DEPOSITO
        AND A.VOUCHER = L_ID_VOUCHER_DEP;


BEGIN
        -- VALIDAR SI EL VOUCHER ESTÁ CONTABILIZADO
        L_ACTIVO := 'S';

            IF L_ACTIVO = 'S' THEN
                --ANULAR DEPOSITO
                SELECT COUNT(1) INTO STRICT L_CANT FROM CAJA_DEPOSITO_DETALLE
                WHERE ID_DEPOSITO = P_ID_DEPOSITO;

                IF L_CANT > 0 THEN

                    SELECT ID_VOUCHER,ID_TIPOORIGEN INTO STRICT L_ID_VOUCHER_DEP,L_ID_TIPOORIGEN_DEP
                    FROM CAJA_DEPOSITO
                    WHERE ID_DEPOSITO = P_ID_DEPOSITO;

                    OPEN asientos_dep;
                      FETCH asientos_dep INTO L_ID_ASIENTO;
                        WHILE asientos_dep%FOUND LOOP

                            UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                            WHERE ID_ASIENTO = L_ID_ASIENTO;

                            FETCH asientos_dep INTO L_ID_ASIENTO;
                        END LOOP;
                    CLOSE asientos_dep;

                    UPDATE CAJA_DEPOSITO_DETALLE SET IMPORTE = 0, IMPORTE_ME = 0
                    WHERE ID_DEPOSITO = P_ID_DEPOSITO;

                    UPDATE CAJA_DEPOSITO SET IMPORTE = 0, IMPORTE_ME = 0, GLOSA = '<< Anulado >>'
                    WHERE ID_DEPOSITO = P_ID_DEPOSITO;
                END IF;
                P_ERROR := 0;
                P_MSN := 'OK: Anulado con Exito';
            ELSE
                P_ERROR := 1;
                P_MSN := 'El Voucher ya esta CONTABILIZADO';
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.sp_anular_depositos_temp (P_ID_DEPOSITO bigint) FROM PUBLIC;

