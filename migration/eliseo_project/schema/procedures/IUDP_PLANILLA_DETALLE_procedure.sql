-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_planilla_detalle ( v_Modo bigint, v_ID_ENTIDAD bigint, v_ID_ANHO bigint, v_ID_MES bigint, v_ID_CONTRATO bigint, iv_ID_TIPOPLANILLA bigint, v_ID_PLANILLADETALLE bigint, v_ID_CONCEPTOAPS bigint, v_FEC_PAGO text, v_FEC_SALIDA text, v_FEC_RETORNO text, v_COS_VALOR bigint, v_COS_REFERENCIA1 bigint, v_COS_REFERENCIA2 bigint, v_COS_REFERENCIA3 bigint, v_COMENTARIO text ) AS $body$
DECLARE

  v_ID_TIPOPLANILLA bigint := iv_ID_TIPOPLANILLA;

BEGIN
  IF v_Modo = 0 THEN
    DECLARE
      v_ID_PERSONA bigint := 0;
      V_CONTAR bigint := 0;
      V_VALOR decimal(38,2) := 0;
      V_ID_ANHO_NEW bigint := 0;
      V_ID_MES_NEW bigint := 0;
    BEGIN
      SELECT max(ID_PERSONA)
      INTO STRICT v_ID_PERSONA
      FROM APS_Empleado
      WHERE ID_ENTIDAD        = v_ID_ENTIDAD
      AND ID_CONTRATO         = v_ID_CONTRATO;
      IF coalesce(v_ID_PERSONA, 0) > 0 THEN
        BEGIN
          SELECT max(ID_TIPOPLANILLA)
          INTO STRICT v_ID_TIPOPLANILLA
          FROM Tipo_Planilla
          WHERE COD_APS = v_ID_TIPOPLANILLA;

          INSERT
          INTO APS_Planilla_Detalle(
              ID_ENTIDAD,
              ID_ANHO,
              ID_MES,
              ID_TIPOPLANILLA,
              ID_PERSONA,
              ID_CONTRATO,
              ID_PLANILLADETALLE,
              ID_CONCEPTOAPS,
              FEC_PAGO,
              FEC_SALIDA,
              FEC_RETORNO,
              COS_VALOR,
              COS_REFERENCIA1,
              COS_REFERENCIA2,
              COS_REFERENCIA3,
              COMENTARIO
            )
            VALUES (
              v_ID_ENTIDAD,
              v_ID_ANHO,
              v_ID_MES,
              v_ID_TIPOPLANILLA,
              v_ID_PERSONA,
              v_ID_CONTRATO,
              v_ID_PLANILLADETALLE,
              v_ID_CONCEPTOAPS,
              to_date(v_FEC_PAGO,'yyyy-mm-dd HH24:MI:SS'), 
              to_date(v_FEC_SALIDA,'dd/mm/yyyy'), 
              to_date(v_FEC_RETORNO,'dd/mm/yyyy'),
              v_COS_VALOR,
              v_COS_REFERENCIA1,
              v_COS_REFERENCIA2,
              v_COS_REFERENCIA3,
              v_COMENTARIO
            );
        END;
      END IF;
    	IF coalesce(v_ID_PERSONA, 0) > 0 AND v_COS_VALOR > 0 AND v_COS_REFERENCIA2 > 0 AND v_COS_REFERENCIA3 > 0 THEN
	     	V_VALOR := ROUND((v_COS_REFERENCIA2 * v_COS_REFERENCIA3)/100,2);
    		IF V_VALOR = round((v_COS_VALOR)::numeric,2) THEN
		     	SELECT COUNT(1) 
			      INTO STRICT V_CONTAR
			      FROM ELISEO.INFORME_CONCEPTOAPS_PERSONA icp 
			      WHERE ID_ENTIDAD = v_ID_ENTIDAD
			      AND ID_PERSONA = v_ID_PERSONA
			      AND ID_ANHO = v_ID_ANHO
			      AND ID_MES = v_ID_MES
			      AND ID_CONCEPTOAPS = v_ID_CONCEPTOAPS;
			
			     IF V_CONTAR = 0 THEN 
			     	INSERT
			          INTO ELISEO.INFORME_CONCEPTOAPS_PERSONA(
			              ID_ENTIDAD,
			              ID_PERSONA,
			              ID_ANHO,
			              ID_MES,
			              ID_CONCEPTOAPS,
			              TIENE_VARIABLE,
			              TIPO_VALOR,
			              VALOR,
			              TIENE_TOPE,
			              ESTADO 
			            )
			            VALUES (
			              v_ID_ENTIDAD,
			              v_ID_PERSONA,
			              v_ID_ANHO,
			              v_ID_MES,
			              v_ID_CONCEPTOAPS,
			              '0',
			              'P',
			              round((v_COS_REFERENCIA3)::numeric,2),
			              '0',
			              '1'
			            );
			     ELSE
			     	UPDATE ELISEO.INFORME_CONCEPTOAPS_PERSONA
			        SET VALOR = round((v_COS_REFERENCIA3)::numeric,2)
			        WHERE ID_ENTIDAD    = v_ID_ENTIDAD
			        AND ID_ANHO         = v_ID_ANHO
			        AND ID_MES          = v_ID_MES
			        AND ID_PERSONA      = v_ID_PERSONA
			        AND ID_CONCEPTOAPS     = v_ID_CONCEPTOAPS;
			     END IF;
			    V_ID_ANHO_NEW := V_ID_ANHO;
			    v_ID_MES_NEW := v_ID_MES + 1;
			   	IF v_ID_MES = 12 THEN
			   		v_ID_MES_NEW := 1;
			    	V_ID_ANHO_NEW := V_ID_ANHO + 1;
			   	END IF;
			    SELECT COUNT(1)
			      INTO STRICT V_CONTAR
			      FROM ELISEO.INFORME_CONCEPTOAPS_PERSONA icp 
			      WHERE ID_ENTIDAD = v_ID_ENTIDAD
			      AND ID_PERSONA = v_ID_PERSONA
			      AND ID_ANHO = V_ID_ANHO_NEW
			      AND ID_MES = v_ID_MES_NEW
			      AND ID_CONCEPTOAPS = v_ID_CONCEPTOAPS;
			
			     IF V_CONTAR = 0 THEN 
			     	INSERT
			          INTO ELISEO.INFORME_CONCEPTOAPS_PERSONA(
			              ID_ENTIDAD,
			              ID_PERSONA,
			              ID_ANHO,
			              ID_MES,
			              ID_CONCEPTOAPS,
			              TIENE_VARIABLE,
			              TIPO_VALOR,
			              VALOR,
			              TIENE_TOPE,
			              ESTADO 
			            )
			            VALUES (
			              v_ID_ENTIDAD,
			              v_ID_PERSONA,
			              V_ID_ANHO_NEW,
			              v_ID_MES_NEW,
			              v_ID_CONCEPTOAPS,
			              '0',
			              'P',
			              round((v_COS_REFERENCIA3)::numeric,2),
			              '0',
			              '1'
			            );
			     END IF;
	     	END IF;
	    END IF;
    END;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_planilla_detalle ( v_Modo bigint, v_ID_ENTIDAD bigint, v_ID_ANHO bigint, v_ID_MES bigint, v_ID_CONTRATO bigint, iv_ID_TIPOPLANILLA bigint, v_ID_PLANILLADETALLE bigint, v_ID_CONCEPTOAPS bigint, v_FEC_PAGO text, v_FEC_SALIDA text, v_FEC_RETORNO text, v_COS_VALOR bigint, v_COS_REFERENCIA1 bigint, v_COS_REFERENCIA2 bigint, v_COS_REFERENCIA3 bigint, v_COMENTARIO text ) FROM PUBLIC;

