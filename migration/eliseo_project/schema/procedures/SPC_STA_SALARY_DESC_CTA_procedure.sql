-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.spc_sta_salary_desc_cta ( p_id_entidad integer, p_id_anho integer, p_id_mes integer, p_id_ctacte text, p_id_cuentaaasi text, OUT CURSOR REFCURSOR ) AS $body$
DECLARE


    l_ingresos decimal(38,2);
    l_id_persona bigint;


BEGIN
	
	SELECT max(ID_PERSONA) INTO STRICT l_id_persona FROM MOISES.PERSONA_DOCUMENTO WHERE NUM_DOCUMENTO =p_id_ctacte;


    OPEN CURSOR FOR
    SELECT 
                to_char(FEC_ASIENTO,'dd/mm/yy') AS FECHA,
                    COMENTARIO,
                    COS_VALOR as valor
                from VW_CONTA_DIARIO
                where id_entidad = p_id_entidad
                and ID_CUENTAAASI = p_id_cuentaaasi
                and ID_CTACTE = p_id_ctacte
                and ID_MES = p_id_mes
                and ID_ANHO = p_id_anho
                AND NOT COMENTARIO LIKE 'APS%' 
                -- Le estamos agregardo el descuento a la boleta de Ayudas y Viajes(1557, 1558)
                
UNION all

                SELECT TO_CHAR(A.FEC_PAGO,'dd/mm/yy') AS FECHA, B.NOMBRE AS COMENTARIO,
                A.COS_VALOR AS valor
                FROM VW_APS_PLANILLA A INNER JOIN APS_CONCEPTO_PLANILLA B
                 ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
				WHERE A.ID_ENTIDAD = p_id_entidad
				AND A.ID_ANHO = p_id_anho
				AND A.ID_MES = p_id_mes
				AND A.ID_PERSONA = l_id_persona
				AND A.ID_CONCEPTOAPS IN (1557, 1558) -- 
                
               
                
                
                --and not ID_TIPOASIENTO = 'RH'
                
                --and FEC_ASIENTO between (
                --select nvl(max(FEC_ASIENTO),to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')) from VW_CONTA_DIARIO
                --where id_entidad = p_id_entidad
                --and ID_CUENTAAASI = p_id_cuentaaasi
                --and ID_CTACTE = p_id_ctacte
                --and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') - interval '1' month
                --and ID_TIPOASIENTO = 'RH')
                --and 
                --(
                --select nvl(max(FEC_ASIENTO),(to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') + interval '1' month - interval '1' day)) from VW_CONTA_DIARIO
                --where id_entidad = p_id_entidad
                --and ID_CUENTAAASI = p_id_cuentaaasi
                --and ID_CTACTE = p_id_ctacte
                --and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')
                --and ID_TIPOASIENTO = 'RH')
;

             
      
  
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.spc_sta_salary_desc_cta ( p_id_entidad integer, p_id_anho integer, p_id_mes integer, p_id_ctacte text, p_id_cuentaaasi text, OUT CURSOR REFCURSOR ) FROM PUBLIC;

