-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.sp_audit_tabla ( P_tabla text, P_id text, P_idvalor text, p_idpersona integer, P_ip text, P_accion text, P_columna tablastring, P_anterior tablastring, P_actual tablastring ) AS $body$
DECLARE


s_columna varchar(150);
s_anterior varchar(150);
s_actual varchar(150);
s_id varchar(25);
s_id_log varchar(25);
--s_iddet varchar(5);
s_usuario varchar(60);
s_ip varchar(15);
BEGIN

    s_id:= to_char(clock_timestamp(),'YYYYMMDDHH24MISS');

    s_ip:= SYS_CONTEXT('USERENV', 'IP_ADDRESS', 15);

    select SYS_CONTEXT('USERENV', 'OS_USER') into STRICT s_usuario;

    if p_idpersona<>0 then
      s_ip:='';
      s_usuario:='';
    end if;


    FOR i IN P_columna.FIRST .. P_columna.LAST
    LOOP
      s_columna:=P_columna(i);

      s_actual:=P_actual(i);

      if P_accion in ('I','D') then
          s_anterior:='';
      else
          s_anterior:=P_anterior(i);
      end if;
      s_anterior:=coalesce(s_anterior,' ');
      s_actual:=coalesce(s_actual,' ');
      if P_accion in ('I','D') or (s_anterior<>s_actual and P_accion='U') then

-- -- --         --select to_char(cast( dbms_random.value(1,1000) as int)) into s_iddet from dual;
        RAISE NOTICE 'Vitmar doc';

        RAISE NOTICE '%', P_idvalor;
        RAISE NOTICE '% %%', s_id, i::text, P_idvalor;
        RAISE NOTICE '%', i::text;
        insert into audit_log(
          id_log,
          logi,
          desc_id,
          tabla_id,
          tabla,
          columna,
          accion,
          id_persona,
          ip,
          fechahora,
          anterior,
          actual,
          usuario,
          ip_bd
          )values (
          --s_id||to_char(i)||s_iddet,
          s_id||i::text||P_idvalor,
          s_id,
          P_id,
          P_idvalor,
          P_tabla,
          s_columna,
          P_accion,
          coalesce(p_idpersona,0),
          coalesce(P_ip,' '),
          clock_timestamp(),
          s_anterior,
          s_actual,
          s_usuario,
          s_ip
        );

      end if;

    END LOOP;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.sp_audit_tabla ( P_tabla text, P_id text, P_idvalor text, p_idpersona integer, P_ip text, P_accion text, P_columna tablastring, P_anterior tablastring, P_actual tablastring ) FROM PUBLIC;

