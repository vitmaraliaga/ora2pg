-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.spc_mobile_dep_data ( p_id_entidad integer, p_id_anho integer, p_id_persona integer, OUT CURSOR REFCURSOR ) AS $body$
DECLARE


    l_ingresos decimal(38,2);
    l_num_documento varchar(100);


BEGIN
    DELETE FROM TT_TABLE_AUX;
    l_num_documento:= '';



    OPEN CURSOR FOR
    SELECT
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                CASE WHEN(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso)))=0 THEN 1  ELSE (sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))) END 
                )*100,2) porc
            from (
            SELECT
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_DEPTO in (select id_depto from CONTA_ENTIDAD_DEPTO_RESP where id_persona = p_id_persona)
            and ID_ANHO = p_id_anho
            and ID_ANHO < 2019
            and ID_MES between 1 and 12
            and ID_CUENTAAASI in ('2317001','2317005','2317010') 
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            
UNION

            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_DEPTO in (select id_depto from CONTA_ENTIDAD_DEPTO_RESP where id_persona = p_id_persona)
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 12
            and ID_CUENTAAASI like '6%' 
            group by ID_DEPTO,ID_ENTIDAD
            
Union

            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_DEPTO in (select id_depto from CONTA_ENTIDAD_DEPTO_RESP where id_persona = p_id_persona)
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 12
            and (
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              	) OR ID_CUENTAAASI IN ('3196230', '3196298') ) 
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            ) 
            group by ID_DEPTO,ID_ENTIDAD
            
UNION

            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_DEPTO in (select id_depto from CONTA_ENTIDAD_DEPTO_RESP where id_persona = p_id_persona)
            and ID_ANHO = p_id_anho
            and (
	              id_cuentaaasi in (
	                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
	                  where id_cuentaaasi like '3%' 
	                  --and es_grupo = 0
	                  and ES_ACREEDORA = 0
	                  and ID_CUENTAAASI NOT IN ('3196230', '3196298') 
	              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            ) 
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO 
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE
        order by ed.NOMBRE
;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.spc_mobile_dep_data ( p_id_entidad integer, p_id_anho integer, p_id_persona integer, OUT CURSOR REFCURSOR ) FROM PUBLIC;

