-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.sp_anular_transferencia_reg (P_ID_TRANSFERENCIA bigint, P_ID_PERSONA bigint, P_MOTIVO text, P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_VOUCHER bigint;
        L_ACTIVO varchar(1);
        L_ID_KARDEX bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_ID_ANHO bigint;
        L_ID_TIPOORIGEN bigint := 2;
        L_ID_ASIENTO bigint;
        L_DATA varchar(255);

        L_ID_DEPOSITO bigint;
        L_ID_VOUCHER_DEP bigint;
        L_ID_TIPOORIGEN_DEP bigint;
        L_CANT bigint;

        asientos CURSOR FOR
        SELECT
                ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN VENTA_TRANSFERENCIA B
        ON A.ID_ORIGEN = B.ID_TRANSFERENCIA
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND B.ID_TRANSFERENCIA = P_ID_TRANSFERENCIA
        AND A.VOUCHER = L_ID_VOUCHER;



BEGIN
            SELECT ID_VOUCHER, 'SERIE: '||SERIE||', NUMERO: '||NUMERO||', IMPORTE: '||IMPORTE 
            INTO STRICT L_ID_VOUCHER, L_DATA
            FROM VENTA_TRANSFERENCIA WHERE ID_TRANSFERENCIA = P_ID_TRANSFERENCIA;

            SELECT ACTIVO INTO STRICT L_ACTIVO FROM CONTA_VOUCHER  WHERE ID_VOUCHER = L_ID_VOUCHER;
            IF L_ACTIVO = 'S' THEN
                    Insert into ARREGLO(
                    ID_ENTIDAD, ID_DEPTO, ID_TIPOARREGLO, ID_PERSONA, ID_MODULO, ID_ORIGEN, ID_TIPOORIGEN,
                    MOTIVO, FECHA, INFO_BACKUP, ESTADO
                    ) 
                    SELECT ID_ENTIDAD, id_depto, 1 as id_tipoarreglo, P_ID_PERSONA, 13, ID_TRANSFERENCIA, id_tipoorigen, P_MOTIVO, clock_timestamp(), 
                    'IMPORTE: '||IMPORTE||' Glosa: '||glosa, 1
                    from VENTA_TRANSFERENCIA 
                    where ID_TRANSFERENCIA = P_ID_TRANSFERENCIA;

                --ANULA ASIENTO DE LA VENTA
                OPEN asientos;
                  FETCH asientos INTO L_ID_ASIENTO;
                    WHILE asientos%FOUND LOOP

                        UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                        WHERE ID_ASIENTO = L_ID_ASIENTO;

                        FETCH asientos INTO L_ID_ASIENTO;
                    END LOOP;
                CLOSE asientos;

                --ANULAR VENTA
                UPDATE VENTA_TRANSFERENCIA_DETALLE SET    DETALLE = '<< Anulado>>',IMPORTE = 0,IMPORTE_ME = 0
                WHERE ID_TRANSFERENCIA = P_ID_TRANSFERENCIA;

                UPDATE VENTA_TRANSFERENCIA SET    GLOSA = '<< Anulado>>', IMPORTE = 0
                WHERE ID_TRANSFERENCIA = P_ID_TRANSFERENCIA;

                UPDATE ARREGLO SET ESTADO = '2',INFO_BACKUP = L_DATA
                WHERE ID_ORIGEN = P_ID_TRANSFERENCIA
                AND ID_TIPOORIGEN = L_ID_TIPOORIGEN
                AND ESTADO = '1';

                P_ERROR := 0;
                P_MSGERROR := 'OK: Anulado con Exito';
            ELSE
                P_ERROR := 1;
                P_MSGERROR := 'El Voucher ya esta CONTABILIZADO';
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.sp_anular_transferencia_reg (P_ID_TRANSFERENCIA bigint, P_ID_PERSONA bigint, P_MOTIVO text, P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;

