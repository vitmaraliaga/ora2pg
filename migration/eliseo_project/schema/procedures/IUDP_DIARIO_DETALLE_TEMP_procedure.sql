-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_diario_detalle_temp (P_Modo integer, P_ID_ENTIDAD integer, P_COD_AASI integer, P_ID_TIPOASIENTO text, P_FEC_ASIENTO text, P_ID_DEPARTAMENTO text, P_ID_FONDO integer, P_ID_TIPOPLAN integer, P_ID_CUENTAAASI text, P_ID_RESTRICCION text, P_ID_CUENTACTE text, P_NUM_AASI text, P_VALOR text, P_VALOR_DOLAR text, P_COMENTARIO text, P_MEMO text) AS $body$
DECLARE


S_ID_DIARIO         integer;
S_ID_DIARIODETALLE  integer;
S_COS_VALOR         NUMERIC(10,2);
S_COS_DOLAR         NUMERIC(10,2);
S_ID_CUENTACTE      varchar(255);
S_MEMO              varchar(255);
S_COMENTARIO        varchar(1000);
S_CANT              integer;
S_ANHO              integer;
S_MES               integer;


BEGIN  
  
    RAISE NOTICE 'ERROR ........';
    IF P_Modo = 0 THEN
        S_ID_CUENTACTE := CASE WHEN P_ID_CUENTACTE = '@JournalItemSubAccountCode@' OR P_ID_CUENTACTE = '0' THEN '' ELSE P_ID_CUENTACTE END;
        S_COS_VALOR    := TO_NUMBER(P_VALOR,'9999999999.9999');
        S_COS_DOLAR    := CASE WHEN P_VALOR_DOLAR = '@JournalItemAccountValue@' OR P_VALOR_DOLAR = '' THEN 0 ELSE TO_NUMBER(P_VALOR_DOLAR,'9999999999.9999') END;
        S_MEMO         := CASE WHEN P_MEMO = '@JournalItemMemo@' THEN '' ELSE P_MEMO END;
        S_COMENTARIO   := P_COMENTARIO;
        S_ANHO         := TO_CHAR(to_date(P_FEC_ASIENTO,'yyyy-mm-dd"T"HH24:MI:SS'),'YYYY');
        S_MES          := (TO_CHAR(to_date(P_FEC_ASIENTO,'yyyy-mm-dd"T"HH24:MI:SS'),'MM'))::numeric;

        SELECT    
                COUNT(ID_DIARIO), max(id_diario)  INTO STRICT S_CANT, S_ID_DIARIO
        FROM CONTA_DIARIO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_ANHO = S_ANHO
        AND ID_MES = S_MES
        AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
        AND COD_AASI = P_COD_AASI;

        IF S_CANT > 0 THEN
        
            SELECT
                    coalesce(MAX(ID_DIARIO_DETALLE),0)+1 INTO STRICT S_ID_DIARIODETALLE
            FROM CONTA_DIARIO_DETALLE_TEMP
            WHERE ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_DIARIO = S_ID_DIARIO;
          
            INSERT INTO CONTA_DIARIO_DETALLE_TEMP(ID_ENTIDAD, ID_DIARIO, ID_DIARIO_DETALLE, ID_DEPTO, ID_FONDO, ID_TIPOPLAN, ID_CUENTAAASI, ID_RESTRICCION, ID_CTACTE, NUM_AASI, COS_VALOR, COS_DOLAR, OBSERVACION, COMENTARIO)
            VALUES (P_ID_ENTIDAD, S_ID_DIARIO, S_ID_DIARIODETALLE, P_ID_DEPARTAMENTO, P_ID_FONDO, P_ID_TIPOPLAN, P_ID_CUENTAAASI, P_ID_RESTRICCION, coalesce(S_ID_CUENTACTE, ''), REPLACE(P_NUM_AASI, '-', '.'), S_COS_VALOR, S_COS_DOLAR, coalesce(S_MEMO, ''), S_COMENTARIO);
        END IF;
    END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_diario_detalle_temp (P_Modo integer, P_ID_ENTIDAD integer, P_COD_AASI integer, P_ID_TIPOASIENTO text, P_FEC_ASIENTO text, P_ID_DEPARTAMENTO text, P_ID_FONDO integer, P_ID_TIPOPLAN integer, P_ID_CUENTAAASI text, P_ID_RESTRICCION text, P_ID_CUENTACTE text, P_NUM_AASI text, P_VALOR text, P_VALOR_DOLAR text, P_COMENTARIO text, P_MEMO text) FROM PUBLIC;

