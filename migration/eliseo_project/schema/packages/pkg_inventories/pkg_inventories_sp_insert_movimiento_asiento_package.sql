-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_inventories,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_inventories_sp_insert_movimiento_asiento (P_ID_MOVIMIENTO bigint, P_ID_CUENTAAASI bigint, P_ID_RESTRICCION text, P_ID_CTACTE text, P_ID_DEPTO text,P_DC text,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_TIPOPLAN bigint :=1;
        L_ID_FONDO bigint :=10;
        L_PORCENTAJE bigint := 1;
        L_GLOSA varchar(60);
        L_INDICADOR varchar(20) :='COSTO_ALM';
        L_AGRUPA varchar(1) :='N';
        L_NRO_ASIENTO bigint :=1;
        L_DEPARTAMENTO varchar(10);
        L_DC varchar(1);
        L_ID_CUENTAAASI varchar(10);
        L_ID_RESTRICCION varchar(10);
        L_ID_CTACTE varchar(50);
        L_ID_DEPTO varchar(10);
        L_ID_ENTIDAD bigint;

        
    
BEGIN   
        DELETE FROM INVENTARIO_MOVIMIENTO_ASIENTO
        WHERE ID_MOVIMIENTO = P_ID_MOVIMIENTO
        AND ID_MOVIMIENTO IN (SELECT ID_MOVIMIENTO FROM INVENTARIO_MOVIMIENTO WHERE ID_MOVIMIENTO = P_ID_MOVIMIENTO AND ESTADO = '0');

        SELECT 
            A.ID_ENTIDAD,C.ID_DEPTO AS DEPARTAMENTO,A.ID_ENTIDAD||'-'||A.ID_DEPTO||'-Sal.Div.-'||B.NOMBRE||'-'||TO_CHAR(FECHA,'DD/MM/YY') AS GLOSA INTO STRICT
            L_ID_ENTIDAD,L_DEPARTAMENTO,L_GLOSA
        FROM INVENTARIO_MOVIMIENTO A JOIN INVENTARIO_ALMACEN B
        ON A.ID_ALMACEN = B.ID_ALMACEN
        JOIN ORG_SEDE_AREA C
        ON B.ID_SEDEAREA = C.ID_SEDEAREA
        WHERE ID_MOVIMIENTO = P_ID_MOVIMIENTO;
        --DEBITO
        INSERT INTO INVENTARIO_MOVIMIENTO_ASIENTO(ID_MOVIMIENTO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,DC,PORCENTAJE,GLOSA,INDICADOR,AGRUPA,NRO_ASIENTO)
        VALUES (P_ID_MOVIMIENTO,L_ID_TIPOPLAN,P_ID_CUENTAAASI,P_ID_RESTRICCION,L_ID_FONDO,P_ID_CTACTE,P_ID_DEPTO,P_DC,L_PORCENTAJE,L_GLOSA,L_INDICADOR,L_AGRUPA,L_NRO_ASIENTO);
        --CREDITO AGRUPADO POR ALMACEN
        L_DC := 'C';
        L_AGRUPA := 'S';
        --IF L_DEPARTAMENTO = '11010111' THEN --LOGISTICA
            IF L_ID_ENTIDAD = '7124' THEN
                L_ID_CUENTAAASI :='1146001';
                --L_ID_DEPTO := '11010101';
                L_ID_CTACTE :='1';
            ELSE
                L_ID_CUENTAAASI :='1141001';
                --L_ID_DEPTO := '131111';
                L_ID_CTACTE :='9';
            END IF;

            L_ID_RESTRICCION := '0A';
            --L_ID_CTACTE :='1';
            --L_ID_DEPTO := '11010101';
        --END IF;
        IF L_DEPARTAMENTO = '1' THEN
            L_ID_DEPTO := '11010101';
        ELSIF L_DEPARTAMENTO = '4' THEN
            L_ID_DEPTO := '41010101';
        ELSE
            L_ID_DEPTO := '51010101';
        END IF;
        INSERT INTO INVENTARIO_MOVIMIENTO_ASIENTO(ID_MOVIMIENTO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,DC,PORCENTAJE,GLOSA,INDICADOR,AGRUPA,NRO_ASIENTO)
        VALUES (P_ID_MOVIMIENTO,L_ID_TIPOPLAN,L_ID_CUENTAAASI,L_ID_RESTRICCION,L_ID_FONDO,L_ID_CTACTE,L_ID_DEPTO,L_DC,L_PORCENTAJE,L_GLOSA,L_INDICADOR,L_AGRUPA,L_NRO_ASIENTO);

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_inventories_sp_insert_movimiento_asiento (P_ID_MOVIMIENTO bigint, P_ID_CUENTAAASI bigint, P_ID_RESTRICCION text, P_ID_CTACTE text, P_ID_DEPTO text,P_DC text,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
