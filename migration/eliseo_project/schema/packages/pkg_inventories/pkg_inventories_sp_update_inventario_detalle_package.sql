-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_inventories,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_inventories_sp_update_inventario_detalle (P_ID_MOVDETALLE bigint,P_ID_MOVIMIENTO bigint, P_ID_ARTICULO bigint,P_ID_DINAMICA bigint, P_CANTIDAD bigint,P_COSTO bigint,P_ERROR OUT bigint,P_MSN_ERROR OUT text) AS $body$
DECLARE

        L_ID_ALMACEN integer;
        L_ID_ANHO integer;
        L_TIPO varchar(1);
        L_STOCK decimal(10,2);
        L_STOCK_T decimal(10,2);
        L_COSTO decimal(10,2);
        L_MSN varchar(200):='';
        L_MSN_ERROR varchar(200):='';

BEGIN   
        SELECT ID_ALMACEN,TIPO,ID_ANHO INTO STRICT L_ID_ALMACEN,L_TIPO,L_ID_ANHO
        FROM INVENTARIO_MOVIMIENTO  
        WHERE ID_MOVIMIENTO = P_ID_MOVIMIENTO 
        AND ESTADO = '0';

        IF L_TIPO = 'I' THEN  --INGRESO DE ARTICULOS
            P_ERROR := 0;
            L_MSN_ERROR := '';

        ELSE  -- SALIDA DE ARTICULOS
            CALL pkg_inventories_sp_articulo_stock(L_ID_ALMACEN,P_ID_ARTICULO,L_ID_ANHO,L_STOCK,L_COSTO,L_MSN);
            CALL pkg_inventories_sp_articulo_stock_temp(L_ID_ALMACEN,P_ID_ARTICULO,L_ID_ANHO,L_STOCK_T,L_MSN);
            IF L_STOCK > 0 THEN
                IF (L_STOCK-L_STOCK_T) >= P_CANTIDAD THEN
                    P_ERROR := 0;
                    L_MSN_ERROR := 'OK '||L_STOCK;
                ELSE
                    P_ERROR := 1;
                    L_MSN_ERROR := 'Cantidad Mayor que el Stock: '||L_STOCK;
                END IF;
            ELSE
                P_ERROR := 1;
                L_MSN_ERROR := 'Stock Insuficiente: '||L_STOCK;
            END IF;

        END IF;
        IF P_ERROR = 0 THEN
            IF P_CANTIDAD > 0 THEN
                UPDATE INVENTARIO_DETALLE SET   CANTIDAD = P_CANTIDAD,
                                                COSTO = CASE WHEN L_TIPO='I' THEN P_COSTO  ELSE L_COSTO END , 
                                                IMPORTE = round((P_CANTIDAD*CASE WHEN L_TIPO='I' THEN P_COSTO  ELSE L_COSTO END )::numeric,2)
                WHERE ID_MOVDETALLE = P_ID_MOVDETALLE;
            ELSE
                L_MSN_ERROR := 'Ingrese Cantidades positivas: '||P_CANTIDAD;
                P_ERROR := 1;
            END IF;
        END IF;
        P_MSN_ERROR := L_MSN_ERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_inventories_sp_update_inventario_detalle (P_ID_MOVDETALLE bigint,P_ID_MOVIMIENTO bigint, P_ID_ARTICULO bigint,P_ID_DINAMICA bigint, P_CANTIDAD bigint,P_COSTO bigint,P_ERROR OUT bigint,P_MSN_ERROR OUT text) FROM PUBLIC;
