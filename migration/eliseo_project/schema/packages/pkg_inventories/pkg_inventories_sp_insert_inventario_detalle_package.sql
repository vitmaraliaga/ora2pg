-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_inventories,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_inventories_sp_insert_inventario_detalle (P_ID_MOVIMIENTO bigint, P_ID_ARTICULO bigint,P_ID_DINAMICA bigint, P_CANTIDAD bigint,P_COSTO bigint,P_ERROR OUT bigint,P_MSN_ERROR OUT text) AS $body$
DECLARE

        L_ID_MOVDETALLE integer;
        L_ID_ALMACEN integer;
        L_ID_ANHO integer;
        L_TIPO varchar(1);
        L_STOCK decimal(10,2);
        L_STOCK_T decimal(10,2);
        L_COSTO decimal(10,2);
        L_NOMBRE_ARTICULO varchar(200):='';

        L_ERROR bigint := 0;
        L_MSN_ERROR varchar(200):='';

BEGIN   
        SELECT ID_ALMACEN,ID_ANHO,TIPO INTO STRICT L_ID_ALMACEN,L_ID_ANHO,L_TIPO
        FROM INVENTARIO_MOVIMIENTO  
        WHERE ID_MOVIMIENTO = P_ID_MOVIMIENTO 
        AND ESTADO = '0';

        SELECT COALESCE(MAX(NOMBRE),'') INTO STRICT L_NOMBRE_ARTICULO FROM INVENTARIO_ARTICULO WHERE ID_ARTICULO =P_ID_ARTICULO;
            
        IF P_CANTIDAD <= 0 THEN
        	L_ERROR := 1;
            L_MSN_ERROR := 'Alto! Ingrese cantidades positivas: '||P_CANTIDAD;
--             GOTO salida_rapida;
        END IF;

        IF L_TIPO= 'S' THEN  -- SALIDA DE ARTICULOS
        	CALL pkg_inventories_sp_articulo_stock(L_ID_ALMACEN,P_ID_ARTICULO,L_ID_ANHO,L_STOCK,L_COSTO,L_MSN_ERROR);
        	CALL pkg_inventories_sp_articulo_stock_temp(L_ID_ALMACEN,P_ID_ARTICULO,L_ID_ANHO,L_STOCK_T,L_MSN_ERROR);
          	
            IF L_STOCK <= 0 THEN
            	L_ERROR := 1;
            	L_MSN_ERROR := 'Alto! Stock insuficiente en el almacén, del artículo: '||L_NOMBRE_ARTICULO||'; Stock: '||L_STOCK;
--             	GOTO salida_rapida;
            END IF;

            IF (L_STOCK-L_STOCK_T) < P_CANTIDAD THEN
            	L_ERROR := 1;
            	L_MSN_ERROR := 'Alto! Stock insuficiente en el almacén, del artículo: '||L_NOMBRE_ARTICULO||'; Stock: '||(L_STOCK-L_STOCK_T);
--             	GOTO salida_rapida;
            END IF;
        END IF;

        --SELECT NVL(MAX(ID_MOVDETALLE),0)+1 INTO L_ID_MOVDETALLE FROM INVENTARIO_DETALLE;
        INSERT INTO INVENTARIO_DETALLE(ID_MOVIMIENTO,ID_ARTICULO,ID_DINAMICA,CANTIDAD,COSTO,IMPORTE,ESTADO)
           -- VALUES(P_ID_MOVIMIENTO,P_ID_ARTICULO,P_ID_DINAMICA,P_CANTIDAD,DECODE(L_TIPO,'I',P_COSTO,L_COSTO),ROUND(P_CANTIDAD*DECODE(L_TIPO,'I',P_COSTO,L_COSTO),2),'0');
            VALUES (P_ID_MOVIMIENTO,P_ID_ARTICULO,P_ID_DINAMICA,P_CANTIDAD,CASE WHEN L_TIPO='I' THEN P_COSTO  ELSE L_COSTO END ,P_CANTIDAD*CASE WHEN L_TIPO='I' THEN P_COSTO  ELSE L_COSTO END ,'0');

--         <<salida_rapida>>
        P_ERROR := L_ERROR;
        P_MSN_ERROR := L_MSN_ERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_inventories_sp_insert_inventario_detalle (P_ID_MOVIMIENTO bigint, P_ID_ARTICULO bigint,P_ID_DINAMICA bigint, P_CANTIDAD bigint,P_COSTO bigint,P_ERROR OUT bigint,P_MSN_ERROR OUT text) FROM PUBLIC;
