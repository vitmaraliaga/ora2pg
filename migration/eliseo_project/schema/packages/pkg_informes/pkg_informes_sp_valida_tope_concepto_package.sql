-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_informes,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_informes_sp_valida_tope_concepto ( P_ID_CONCEPTOAPS bigint, P_ID_CVARIABLE bigint, P_IMPORTE_DOC bigint, P_ID_PERSONA bigint, P_ID_IAYUDA bigint, P_CURSOR_DATOS OUT REFCURSOR) AS $body$
DECLARE

        L_TIENE_VARIABLE varchar(1);
        L_TIPO_VALOR varchar(1);
        L_VALOR bigint;
       	L_TIENE_TOPE varchar(1);
        L_TOPE_PORCENTAJE bigint;

        L_IMPORTE_AYUDA bigint;
       	L_PASADO_IMPORTE_AYUDA bigint;
        -- L_FMR numeric := 3700; -- VALOR UN FMR 2020
        --L_FMR numeric := 4000; -- VALOR UN FMR 2023
        --L_FMR numeric := 4120; -- VALOR UN FMR 2024
        L_FMR bigint := 4240; -- VALOR UN FMR 2025
       	L_IMPORTE_TOPE bigint;

       	L_ERROR bigint :=0;
       	L_MSM varchar(200):='';

BEGIN 
	        
	        
	        SELECT TIENE_VARIABLE,TIPO_VALOR,VALOR,TIENE_TOPE, TOPE_PORCENTAJE
	        INTO STRICT L_TIENE_VARIABLE,L_TIPO_VALOR,L_VALOR,L_TIENE_TOPE, L_TOPE_PORCENTAJE
			FROM  ELISEO.INFORME_CONCEPTOAPS_CONFIG 
			WHERE ID_CONCEPTOAPS =P_ID_CONCEPTOAPS;
			
			IF L_TIENE_TOPE <>'1' THEN
				L_ERROR := 0;
				L_MSM := 'No tiene tope el concepto.';
-- 				GOTO salida_rapida;
			END IF;
		
			IF L_TIENE_VARIABLE='1' THEN
				IF (P_ID_CVARIABLE IS NOT NULL AND P_ID_CVARIABLE::text <> '')
				THEN 
					SELECT VALOR INTO STRICT L_VALOR FROM ELISEO.CONCEPTO_CONFIG_VARIABLE
					WHERE ID_CVARIABLE  =P_ID_CVARIABLE;
				END IF;
			END IF;
			IF L_TIPO_VALOR='P' THEN  -- porcentaje
				L_IMPORTE_AYUDA:=(L_VALOR/100)*P_IMPORTE_DOC;
			ELSE
				L_IMPORTE_AYUDA:=L_VALOR;
			END IF;
			
			SELECT
			   COALESCE(SUM(A.IMPORTE_AYUDA),0) INTO STRICT L_PASADO_IMPORTE_AYUDA
			FROM ELISEO.INFORME_AYUDA A INNER JOIN
						eliseo.INFORME B ON A.ID_INFORME=B.ID_INFORME
					WHERE A.ID_CONCEPTOAPS = P_ID_CONCEPTOAPS
					AND B.ID_ANHO = TO_CHAR(clock_timestamp(),'YYYY')
					AND A.ID_IAYUDA <> P_ID_IAYUDA
					AND b.ID_PERSONA =P_ID_PERSONA;
			
			L_IMPORTE_TOPE := L_FMR*(L_TOPE_PORCENTAJE/100);
			
			IF (L_PASADO_IMPORTE_AYUDA+L_IMPORTE_AYUDA)>L_IMPORTE_TOPE THEN
				L_ERROR := 1;
				L_MSM := 'Alto! El tope de ayuda anual para el concepto: '||P_ID_CONCEPTOAPS|| ' es S/. '||L_IMPORTE_TOPE::text||'. Usted ya inform√≥ un importe de: S/. '||L_PASADO_IMPORTE_AYUDA::text;
			ELSE
				L_ERROR := 0;
				L_MSM := 'Sin problemas.';
			END IF;
			
-- 			<<salida_rapida>>
			OPEN P_CURSOR_DATOS FOR
            SELECT
                L_ERROR AS ERROR,
                L_MSM AS MSM
;

            
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_informes_sp_valida_tope_concepto ( P_ID_CONCEPTOAPS bigint, P_ID_CVARIABLE bigint, P_IMPORTE_DOC bigint, P_ID_PERSONA bigint, P_ID_IAYUDA bigint, P_CURSOR_DATOS OUT REFCURSOR) FROM PUBLIC;
