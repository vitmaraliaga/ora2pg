-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_informes,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_informes_sp_compra_asiento_igasto ( P_ID_IGASTO bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE


     
        L_IMPORTEASIENTO decimal(10,2);
        L_IMPORTEASIENTO_ME decimal(10,2);

        L_DEPTO varchar(10);
        L_CUENTA_CTE varchar(50);

        L_CONT bigint;

        --DATOS INFORME
        L_ID_OBRERO bigint;
        L_ID_ASIENTO bigint;
        L_ID_TIPOORIGEN bigint;
        L_ID_VOUCHER bigint;
        L_ID_DINAMICA bigint;
        L_ID_ENTIDAD_GASTO bigint;
        L_ID_DEPTO_GASTO varchar(20);
        L_IMPORTE decimal(10,2);
        L_IMPORTE_ME decimal(10,2);

        L_ES_DJ varchar(2);
        L_NOMBRE_CATEGORIA varchar(20);
        L_GLOSA varchar(30);
        L_NOMBRE_TIPOPAIS  varchar(200);
        L_ID_FONDO varchar(3);

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,
        a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA,A.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =L_ID_DINAMICA
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC;

    
BEGIN
    
        P_ERROR :=0;
        IF P_ERROR = 0 THEN

            
            SELECT ID_ENTIDAD, ID_DEPTO, COALESCE(A.IMPORTE,0), COALESCE(A.IMPORTE_ME,0), B.ID_PERSONA, A.ID_DINAMICA, A.ID_TIPOORIGEN, A.ID_VOUCHER, C.NOMBRE, A.ES_DJ, COALESCE(D.NOMBRE,'')
            INTO STRICT L_ID_ENTIDAD_GASTO, L_ID_DEPTO_GASTO, L_IMPORTE, L_IMPORTE_ME, L_ID_OBRERO , L_ID_DINAMICA, L_ID_TIPOORIGEN, L_ID_VOUCHER, L_NOMBRE_CATEGORIA, L_ES_DJ, L_NOMBRE_TIPOPAIS
            FROM ELISEO.INFORME_GASTO A INNER JOIN ELISEO.INFORME B ON A.ID_INFORME=B.ID_INFORME
            INNER JOIN ELISEO.INFORME_CATEGORIA C ON A.ID_ICATEGORIA = C.ID_ICATEGORIA 
            LEFT JOIN ELISEO.TIPO_PAIS D ON B.ID_TIPOPAIS=D.ID_TIPOPAIS
            WHERE ID_IGASTO=P_ID_IGASTO;

            
            FOR a_casi in casi
                LOOP
                BEGIN
                    SELECT CASE a_casi.id_indicador WHEN 'IMPORTE' then (L_IMPORTE)*(a_casi.PORCENTAJE)
                          -- WHEN 'BASE' then
                          --   (L_BASE)*(a_casi.PORCENTAJE)
                          -- WHEN 'IGV' then
                          --      (L_IGV)*(a_casi.PORCENTAJE)
                          ELSE
                          0
                          END INTO STRICT L_IMPORTEASIENTO
;

                    IF L_ES_DJ='0' THEN
                        L_GLOSA := L_NOMBRE_CATEGORIA; -- aqui falta el pais
                    ELSE
                        L_GLOSA := a_casi.NOMBRE;
                    END IF;

                    L_DEPTO:=NULL;
                    L_CUENTA_CTE:=NULL;

                    IF a_casi.UNICO='U' THEN  -- Único
                        -- SELECT MAX(ID_DEPTO) INTO L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ENTIDAD=P_ID_ENTIDAD;
                        SELECT MAX(ID_DEPTO) INTO STRICT L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ASIENTO=a_casi.ID_ASIENTO;
                    --ELSIF(L_UNICO='M') THEN -- Muchos
                        /*
                        SELECT INSTR(l_DEPTOS, '|') INTO L_BUSCAR FROM dual;
                        IF L_BUSCAR>0 THEN
                            SELECT FC_SPLIT(L_CTAS,'|') INTO L_ACTAS  FROM dual;
                            SELECT FC_SPLIT(L_DEPTOS,'|') INTO L_ADEPTOS  FROM dual; 
                            SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ADEPTOS ,L_ID_CUENTAAASI) INTO L_DEPTO FROM dual;
                        ELSE
                            L_DEPTO:=L_DEPTOS;
                        END IF;
                        */
                    ELSIF a_casi.UNICO='X' THEN  -- Si es Personal
                        SELECT COUNT(1) INTO STRICT L_CONT FROM APS_EMPLEADO A WHERE A.ID_PERSONA=L_ID_OBRERO
                        	AND A.ID_ENTIDAD=L_ID_ENTIDAD_GASTO
                            AND (coalesce(A.FEC_TERMINO::text, '') = '' OR TO_CHAR(FEC_TERMINO,'YYYYMMDD') >= TO_CHAR(clock_timestamp(),'YYYYMMDD'));

                        if L_CONT>0 THEN
                            SELECT max(id_depto) into STRICT L_DEPTO FROM APS_EMPLEADO A 
                            WHERE A.ID_PERSONA=L_ID_OBRERO AND A.ID_ENTIDAD=L_ID_ENTIDAD_GASTO
                            AND (coalesce(A.FEC_TERMINO::text, '') = '' OR TO_CHAR(FEC_TERMINO,'YYYYMMDD') >= TO_CHAR(clock_timestamp(),'YYYYMMDD'));
                         END IF;

                    ELSIF a_casi.UNICO='S' THEN  -- Si es sesión
                        L_DEPTO := L_ID_DEPTO_GASTO;
                    END IF;

                    
                    IF a_casi.UNICO_CTACTE='U' THEN
                      SELECT  count(*) INTO STRICT L_CONT FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=a_casi.ID_ASIENTO;
                      if L_CONT>0 THEN
                        SELECT ID_CTACTE INTO STRICT L_CUENTA_CTE FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=a_casi.ID_ASIENTO;
                      END IF;
                    -- ELSIF(a_casi.UNICO_CTACTE='M') THEN
                    /*
                       SELECT INSTR(L_CTATES, '|') INTO L_BUSCAR FROM dual;
                       if l_buscar>0 THEN
                         SELECT FC_SPLIT(L_CTAS,'|') INTO L_ACTAS  FROM dual;
                         SELECT FC_SPLIT(L_CTATES,'|') INTO L_ACTATES  FROM dual; 
                         SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ACTATES ,L_ID_CUENTAAASI) INTO L_CUENTA_CTE FROM dual;
                       ELSE
                        L_CUENTA_CTE:=L_CTATES;
                       END IF;
                       */
                    ELSIF (a_casi.UNICO_CTACTE='X') THEN

                        SELECT  
                            COUNT(1) INTO STRICT L_CONT
                            FROM MOISES.VW_PERSONA_NATURAL
                            WHERE ID_PERSONA=L_ID_OBRERO
                            AND ID_TIPODOCUMENTO =1; -- DNI 
                        if L_CONT>0 THEN
                            SELECT
                                MAX(NUM_DOCUMENTO) INTO STRICT L_CUENTA_CTE
                                FROM MOISES.VW_PERSONA_NATURAL
                                WHERE ID_PERSONA=L_ID_OBRERO
                                AND ID_TIPODOCUMENTO =1;
                         ELSE
                         	SELECT COUNT(1) INTO STRICT L_CONT
                            FROM MOISES.VW_PERSONA_NATURAL
                            WHERE ID_PERSONA=L_ID_OBRERO
                            AND ID_TIPODOCUMENTO =4; -- CARNET DE EXTRANGERIA
                            if L_CONT>0 THEN
                            	SELECT
                                MAX(NUM_DOCUMENTO) INTO STRICT L_CUENTA_CTE
                                FROM MOISES.VW_PERSONA_NATURAL
                                WHERE ID_PERSONA=L_ID_OBRERO
                                AND ID_TIPODOCUMENTO =4;
	                         END IF;
                         END IF;
                    END IF;

                    -- Add fondo del personal segun el aps
                    SELECT COALESCE(MAX(ae.FONDO),a_casi.ID_FONDO::text) INTO STRICT L_ID_FONDO FROM APS_EMPLEADO ae WHERE ID_PERSONA = L_ID_OBRERO
                    AND ID_ENTIDAD = L_ID_ENTIDAD_GASTO;

                    IF a_casi.DC='C' THEN
                        L_IMPORTEASIENTO:=L_IMPORTEASIENTO*(-1);
                        L_IMPORTEASIENTO_ME:=L_IMPORTE_ME*(-1);
                     ELSE
                        L_IMPORTEASIENTO := L_IMPORTEASIENTO;
                        L_IMPORTEASIENTO_ME := L_IMPORTE_ME;
                    END IF;

                    IF L_IMPORTEASIENTO<>0 THEN
                        
                            
                            SELECT coalesce(MAX(ID_ASIENTO),0)+1 INTO STRICT L_ID_ASIENTO FROM CONTA_ASIENTO;

                            INSERT INTO CONTA_ASIENTO(ID_ASIENTO,
                                           ID_TIPOORIGEN, ID_ORIGEN, FONDO, DEPTO,
                                           CUENTA, CUENTA_CTE, RESTRICCION, IMPORTE,IMPORTE_ME,
                                           DESCRIPCION, MEMO,VOUCHER,AGRUPA)
                             VALUES (L_ID_ASIENTO, L_ID_TIPOORIGEN, P_ID_IGASTO,L_ID_FONDO, L_DEPTO,
                                     a_casi.ID_CUENTAAASI, L_CUENTA_CTE, a_casi.ID_RESTRICCION, L_IMPORTEASIENTO,L_IMPORTEASIENTO_ME,
                                     SUBSTR((L_GLOSA || ' - '||L_NOMBRE_TIPOPAIS),1,50), 
                                     L_ID_TIPOORIGEN||'-'||P_ID_IGASTO, L_ID_VOUCHER, a_casi.AGRUPA);

                             
                      END IF;
                END;
            END LOOP;

        END IF;
    --END;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_informes_sp_compra_asiento_igasto ( P_ID_IGASTO bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
