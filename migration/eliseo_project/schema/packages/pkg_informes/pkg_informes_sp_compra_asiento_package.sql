-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_informes,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_informes_sp_compra_asiento ( P_ID_COMPRA bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE


     
        L_IMPORTEASIENTO decimal(10,2);
        L_IMPORTEASIENTO_ME decimal(10,2);

        L_DEPTO varchar(10);
        l_DEPTOS varchar(200) := '';
        L_CUENTA_CTE varchar(50);
        L_CTATES varchar(200);

        L_BUSCAR bigint;

        L_CTAS varchar(200);

        L_ACTAS tablastring;
        L_ADEPTOS tablastring;
        L_ACTATES tablastring;

        --validacion
        L_CONT bigint;

        L_ID_CASIENTO varchar(50);
        --L_ID_FONDO varchar(50);
        L_CORRELATIVO bigint;
        L_ID_COMPROBANTE varchar(20);
        L_ID_COMPROBANTE_NC varchar(25);
        L_ID_DEPTO_COMPRA varchar(20);
        L_ES_CREDITO varchar(1);
        L_ID_PROVEEDOR bigint;
        L_SERIE varchar(50);
        L_NUMERO varchar(50);
        L_ID_DINAMICA bigint;
		L_IMPORTE decimal(10,2);
        L_IMPORTE_ME decimal(10,2);
        L_IGV decimal(10,2);
        L_BASE decimal(10,2);
        L_BASE_SINCREDITO decimal(10,2);
        L_OTROS decimal(10,2);
        L_ID_INFORME bigint;
        L_VIAJE_CIUDAD varchar(300);

        --DATOS INFORME
        L_ID_ENTIDAD bigint;
        L_ID_OBRERO bigint;
        L_ID_FONDO varchar(3);

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,
        a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA,A.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =L_ID_DINAMICA
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC;

    
BEGIN
    
        P_ERROR :=0;
        IF P_ERROR = 0 THEN

            
            -- Datos de la compra.
            SELECT CORRELATIVO, ID_DEPTO, ES_CREDITO, ID_COMPROBANTE, ID_PROVEEDOR, SERIE, NUMERO, ID_DINAMICA,
            	COALESCE(IMPORTE,0), COALESCE(IMPORTE_ME,0), COALESCE(IGV,0), COALESCE(BASE,0),COALESCE(BASE_SINCREDITO,0),COALESCE(OTROS,0), ID_INFORME
            INTO STRICT L_CORRELATIVO, L_ID_DEPTO_COMPRA, L_ES_CREDITO, L_ID_COMPROBANTE, L_ID_PROVEEDOR, L_SERIE, L_NUMERO, L_ID_DINAMICA,
            	L_IMPORTE, L_IMPORTE_ME, L_IGV, L_BASE,L_BASE_SINCREDITO, L_OTROS,L_ID_INFORME
            FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;

            SELECT ID_INFORME INTO STRICT L_ID_INFORME FROM INFORME_COMPRA ic WHERE ID_COMPRA = P_ID_COMPRA;

             RAISE NOTICE '.... P_ID_COMPRA %', P_ID_COMPRA;

            -- Si la ciudad de la compra es nula que saque la ciudad del informe.
            SELECT ID_ENTIDAD, ID_PERSONA, COALESCE(L_VIAJE_CIUDAD, VIAJE_CIUDAD) INTO STRICT L_ID_ENTIDAD, L_ID_OBRERO, L_VIAJE_CIUDAD
           from ELISEO.INFORME where ID_INFORME= L_ID_INFORME;

            SELECT NOMBRE_CORTO INTO STRICT L_ID_COMPROBANTE_NC FROM TIPO_COMPROBANTE WHERE ID_COMPROBANTE=L_ID_COMPROBANTE;

            FOR a_casi in casi
                LOOP
                BEGIN
                    SELECT CASE a_casi.id_indicador WHEN 'IMPORTE' then (L_IMPORTE)*(a_casi.PORCENTAJE)
                          WHEN 'BASE' then (L_BASE+L_BASE_SINCREDITO)*(a_casi.PORCENTAJE)
                          WHEN 'OTROS' then (L_OTROS)*(a_casi.PORCENTAJE)
                          WHEN 'IGV' then (L_IGV)*(a_casi.PORCENTAJE)
                          ELSE
                          0
                          END INTO STRICT L_IMPORTEASIENTO
;

                     RAISE NOTICE '.... importe % % % %', L_IMPORTEASIENTO, a_casi.id_indicador, L_OTROS, a_casi.PORCENTAJE;

                    L_DEPTO:=NULL;
                    L_CUENTA_CTE:=NULL;

                    IF a_casi.UNICO='U' THEN  -- Único
                        -- SELECT MAX(ID_DEPTO) INTO L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ENTIDAD=P_ID_ENTIDAD;
                        SELECT MAX(ID_DEPTO) INTO STRICT L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ASIENTO=a_casi.ID_ASIENTO;
                    --ELSIF(L_UNICO='M') THEN -- Muchos
                        /*
                        SELECT INSTR(l_DEPTOS, '|') INTO L_BUSCAR FROM dual;
                        IF L_BUSCAR>0 THEN
                            SELECT FC_SPLIT(L_CTAS,'|') INTO L_ACTAS  FROM dual;
                            SELECT FC_SPLIT(L_DEPTOS,'|') INTO L_ADEPTOS  FROM dual; 
                            SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ADEPTOS ,L_ID_CUENTAAASI) INTO L_DEPTO FROM dual;
                        ELSE
                            L_DEPTO:=L_DEPTOS;
                        END IF;
                        */
                    ELSIF a_casi.UNICO='X' THEN  -- Si es Personal
                        SELECT COUNT(1) INTO STRICT L_CONT FROM APS_EMPLEADO A WHERE A.ID_PERSONA=L_ID_OBRERO AND A.ID_ENTIDAD=L_ID_ENTIDAD
                            AND (coalesce(A.FEC_TERMINO::text, '') = '' OR TO_CHAR(FEC_TERMINO,'YYYYMMDD') >= TO_CHAR(clock_timestamp(),'YYYYMMDD'));

                        if L_CONT>0 THEN
                            SELECT max(id_depto) into STRICT L_DEPTO FROM APS_EMPLEADO A 
                            WHERE A.ID_PERSONA=L_ID_OBRERO AND A.ID_ENTIDAD=L_ID_ENTIDAD
                            AND (coalesce(A.FEC_TERMINO::text, '') = '' OR TO_CHAR(FEC_TERMINO,'YYYYMMDD') >= TO_CHAR(clock_timestamp(),'YYYYMMDD'));
                         END IF;

                    ELSIF a_casi.UNICO='S' THEN  -- Si es sesión
                        L_DEPTO := L_ID_DEPTO_COMPRA;
                    END IF;

                    IF L_ES_CREDITO = 'S' AND a_casi.UNICO_CTACTE='U' THEN
                        SELECT pkg_purchases_fc_ruc(L_ID_PROVEEDOR) into STRICT L_CUENTA_CTE;
                    ELSE
                        IF a_casi.UNICO_CTACTE='U' THEN
                          SELECT  count(*) INTO STRICT L_CONT FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=a_casi.ID_ASIENTO;
                          if L_CONT>0 THEN
                            SELECT ID_CTACTE INTO STRICT L_CUENTA_CTE FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=a_casi.ID_ASIENTO;
                          END IF;
                        -- ELSIF(a_casi.UNICO_CTACTE='M') THEN
                        /*
                           SELECT INSTR(L_CTATES, '|') INTO L_BUSCAR FROM dual;
                           if l_buscar>0 THEN
                             SELECT FC_SPLIT(L_CTAS,'|') INTO L_ACTAS  FROM dual;
                             SELECT FC_SPLIT(L_CTATES,'|') INTO L_ACTATES  FROM dual; 
                             SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ACTATES ,L_ID_CUENTAAASI) INTO L_CUENTA_CTE FROM dual;
                           ELSE
                            L_CUENTA_CTE:=L_CTATES;
                           END IF;
                           */
                        ELSIF (a_casi.UNICO_CTACTE='X') THEN
                            IF a_casi.ID_CUENTAAASI = '2130101' then
                                SELECT pkg_purchases_fc_ruc(L_ID_PROVEEDOR) into STRICT L_CUENTA_CTE;
                            else
                                SELECT  
		                            COUNT(1) INTO STRICT L_CONT
		                            FROM MOISES.VW_PERSONA_NATURAL
		                            WHERE ID_PERSONA=L_ID_OBRERO
		                            AND ID_TIPODOCUMENTO =1; -- DNI 
		                        if L_CONT>0 THEN
		                            SELECT
		                                MAX(NUM_DOCUMENTO) INTO STRICT L_CUENTA_CTE
		                                FROM MOISES.VW_PERSONA_NATURAL
		                                WHERE ID_PERSONA=L_ID_OBRERO
		                                AND ID_TIPODOCUMENTO =1;
		                         ELSE
		                         	SELECT COUNT(1) INTO STRICT L_CONT
		                            FROM MOISES.VW_PERSONA_NATURAL
		                            WHERE ID_PERSONA=L_ID_OBRERO
		                            AND ID_TIPODOCUMENTO =4; -- CARNET DE EXTRANGERIA
		                            if L_CONT>0 THEN
		                            	SELECT
		                                MAX(NUM_DOCUMENTO) INTO STRICT L_CUENTA_CTE
		                                FROM MOISES.VW_PERSONA_NATURAL
		                                WHERE ID_PERSONA=L_ID_OBRERO
		                                AND ID_TIPODOCUMENTO =4;
			                         END IF;
		                         END IF;
                            end if;
                        END IF;
                    END IF;
                   
                    -- Add fondo del personal segun el aps
                    SELECT COALESCE(MAX(ae.FONDO),a_casi.ID_FONDO::text) INTO STRICT L_ID_FONDO FROM APS_EMPLEADO ae WHERE ID_PERSONA = L_ID_OBRERO
                    AND ID_ENTIDAD = L_ID_ENTIDAD;

                    IF a_casi.DC='C' THEN
                        L_IMPORTEASIENTO:=L_IMPORTEASIENTO*(-1);
                        L_IMPORTEASIENTO_ME:=L_IMPORTE_ME*(-1);
                     ELSE
                        L_IMPORTEASIENTO := L_IMPORTEASIENTO;
                        L_IMPORTEASIENTO_ME := L_IMPORTE_ME;
                    END IF;

                    IF L_IMPORTEASIENTO<>0 THEN
                        --IF L_CONT=0 THEN
                        
                            SELECT coalesce(MAX(ID_CASIENTO),0)+1 INTO STRICT L_ID_CASIENTO FROM COMPRA_ASIENTO;

                            INSERT INTO COMPRA_ASIENTO(
                             ID_CASIENTO,
                             ID_COMPRA, ID_CUENTAAASI, ID_RESTRICCION, ID_CTACTE,
                             ID_FONDO, ID_DEPTO, IMPORTE,
                             DESCRIPCION,EDITABLE, ID_PARENT, ID_TIPOREGISTRO, DC, IMPORTE_ME, FECHA_ACTUALIZACION, AGRUPA
                            ) VALUES(
                             L_ID_CASIENTO,
                             P_ID_COMPRA, a_casi.ID_CUENTAAASI, a_casi.ID_RESTRICCION, L_CUENTA_CTE,
                             L_ID_FONDO, L_DEPTO, L_IMPORTEASIENTO,
                             
                             SUBSTR((L_CORRELATIVO || ' | ' || L_ID_COMPROBANTE_NC || '. ' || L_SERIE || '-' || L_NUMERO || ' | ' || a_casi.NOMBRE)|| ' - '||L_VIAJE_CIUDAD,1,50),
                             
                             'N', NULL, NULL, a_casi.DC, L_IMPORTEASIENTO_ME, statement_timestamp(), a_casi.AGRUPA
                            );
                         -- END IF;
                      END IF;

                END;
            END LOOP;

        END IF;
    --END;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_informes_sp_compra_asiento ( P_ID_COMPRA bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
