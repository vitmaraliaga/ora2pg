-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_sehs,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sehs_sp_iupd_venta_despacho ( P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint, P_ID_ALMACEN bigint,P_ID_VENTA bigint,P_ID_TIPOTRANSACCION bigint,P_ID_PERSONA bigint, P_FECHA_EMISION timestamp(0),P_FECHA_INICIO_TRASLADO timestamp(0),P_DIRECCION_PARTIDA text, P_DIRECCION_LLEGADA text,P_ID_MOTIVOTRASLADO bigint,P_ID_TRANSPORTISTA bigint, P_VEHICULO_MARCA text,P_VEHICULO_PLACA text,P_LICENCIA_TRANSPORTISTA text, P_ID_VDESPACHO INOUT bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        /*
        l_igv numeric(10,2);
        l_tc numeric(10,3);
        l_id_moneda_tc numeric;
        l_automatico varchar(2);
        l_id_voucher numeric;
        l_contar numeric;
        l_id_tipotransaccion numeric :=5;--ventas de almacen por defecto regustra y configurar solo un asiento por lamacen
        L_DOCUMENTO numeric :=0;
       
        l_id_cliente numeric;
        l_totaldescuento numeric;
        
        L_ID_VENTA numeric;
        L_ERROR numeric  := 0;
        L_MSGERROR varchar(100) :='';
       
        CURSOR ARTICULOS IS
        SELECT ID_VDETALLE,CANTIDAD, ID_ARTICULO 
        FROM VENTA_DETALLE
        WHERE ID_VENTA = P_ID_VENTA;
       
       	L_ID_VDETALLE numeric;
        L_CANTIDAD numeric(10,2);
        L_ID_ARTICULO numeric;
        L_ID_ALMACEN numeric;
        */
    	L_ID_MOTIVOTRASLADO bigint;
    	L_ID_TRANSPORTISTA bigint;

    	L_ID_VDESPACHO bigint;
        L_ERROR bigint  := 0;
        L_MSGERROR varchar(200) :='';

        
BEGIN
           
	        IF coalesce(P_ID_MOTIVOTRASLADO::text, '') = '' OR P_ID_MOTIVOTRASLADO = 0 THEN
            	L_ID_MOTIVOTRASLADO:=null;
            END IF;

            IF coalesce(P_ID_TRANSPORTISTA::text, '') = '' OR P_ID_TRANSPORTISTA = 0 THEN
            	L_ID_TRANSPORTISTA:=null;
            END IF;

	        IF P_ID_VDESPACHO = 0 THEN
	        	INSERT INTO VENTA_DESPACHO(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,
	        	ID_ALMACEN,ID_VENTA,ID_TIPOTRANSACCION,ID_PERSONA,ID_MOTIVOTRASLADO,
	        	ID_TRANSPORTISTA,FECHA_EMISION,FECHA_INICIO_TRASLADO,DIRECCION_PARTIDA,
	        	DIRECCION_LLEGADA,VEHICULO_MARCA,VEHICULO_PLACA,LICENCIA_TRANSPORTISTA,ESTADO)
	        	VALUES (P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,
	        	P_ID_ALMACEN,P_ID_VENTA,P_ID_TIPOTRANSACCION,P_ID_PERSONA,L_ID_MOTIVOTRASLADO,
	        	L_ID_TRANSPORTISTA,P_FECHA_EMISION,P_FECHA_INICIO_TRASLADO,P_DIRECCION_PARTIDA,
	        	P_DIRECCION_LLEGADA,P_VEHICULO_MARCA,P_VEHICULO_PLACA,P_LICENCIA_TRANSPORTISTA,'0')
	        	RETURNING ID_VDESPACHO INTO L_ID_VDESPACHO;
	        ELSE
	        	
	        	UPDATE VENTA_DESPACHO
	        	SET ID_MOTIVOTRASLADO=L_ID_MOTIVOTRASLADO,
	        	ID_TRANSPORTISTA=L_ID_TRANSPORTISTA,
	        	FECHA_EMISION=P_FECHA_EMISION,FECHA_INICIO_TRASLADO=P_FECHA_INICIO_TRASLADO,
	        	DIRECCION_PARTIDA=P_DIRECCION_PARTIDA,DIRECCION_LLEGADA=P_DIRECCION_LLEGADA,
	        	VEHICULO_MARCA=P_VEHICULO_MARCA,VEHICULO_PLACA=P_VEHICULO_PLACA,
	        	LICENCIA_TRANSPORTISTA=P_LICENCIA_TRANSPORTISTA
	        	WHERE ID_VDESPACHO = P_ID_VDESPACHO;
	        	L_ID_VDESPACHO := P_ID_VDESPACHO;
	        END IF;
	        /*
            --ACTUALIZA CABECERA
            if  P_ID_CLIENTE <> 0 then
                l_id_cliente := P_ID_CLIENTE;
                l_totaldescuento:=0;
            ELSE 
            	l_id_cliente := null;
                l_totaldescuento:=0;
            end if;
           
           -- IF P_ID_CLIENTE IS NULL OR P_ID_CLIENTE = 0 THEN
            --    l_id_cliente:=null;
            --END IF;
           
            --SELECT COALESCE(MAX(ID_VENTA),0)+1 INTO l_cont FROM VENTA;
            l_id_moneda_tc:=9;
          
            -- Obtiene IGV de la fecha actual
            select FC_IGV(CURRENT_DATE ) into l_igv from dual;
          
            -- Obtiene tipo de cambio del dia
            select FC_TIPOCAMBIO(l_id_moneda_tc,CURRENT_DATE,'D' ) into l_tc from dual;
               
            if l_tc is null then
                l_tc:=0;
            end if;
            
            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,P_ID_COMPROBANTE,P_ID_ENTIDAD,P_ID_DEPTO) INTO L_DOCUMENTO FROM DUAL;
            IF L_DOCUMENTO = 0 THEN
                L_ERROR :=1;
                L_MSGERROR := 'Alto! El usuario no tiene asignado un punto de impresi√≥n para el tipo de documento: ' || P_ID_COMPROBANTE;
--                 GOTO salida_rapida;
            END IF; 
            
            
            
           	IF P_ID_VENTA = 0 THEN 	
           
           		DELETE VENTA_ASIENTO
	            WHERE ID_VENTA IN (
	                SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE = P_ID_COMPROBANTE AND ESTADO = '0'
	            );
	            DELETE VENTA_DETALLE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE = P_ID_COMPROBANTE AND ESTADO = 0);
	            DELETE VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE = P_ID_COMPROBANTE AND ESTADO = 0;
	              
           
                INSERT INTO VENTA(ID_PERSONA,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_COMPROBANTE,ID_IGV,ID_MONEDA,
                ID_LEYENDA,TIPOCAMBIO,ID_TIPOTRANSACCION,SERIE,NUMERO,FECHA,ESTADO, ES_AUTOENTREGA)
                VALUES(P_ID_PERSONA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,P_ID_COMPROBANTE,l_igv,P_ID_MONEDA,
                '1000',l_tc,l_id_tipotransaccion,'-','-',SYSDATE,0, P_ES_AUTOENTREGA) RETURNING ID_VENTA INTO L_ID_VENTA;
            ELSE 
            
            	UPDATE VENTA SET
                                ID_CLIENTE= l_id_cliente,
                                -- ID_SUCURSAL=l_id_sucursal,
                                ID_COMPROBANTE=P_ID_COMPROBANTE,
                                ID_MONEDA=P_ID_MONEDA
                WHERE ID_VENTA=P_ID_VENTA;
               
               	OPEN ARTICULOS;
                    FETCH ARTICULOS INTO L_ID_VDETALLE,L_CANTIDAD,L_ID_ARTICULO;
                    WHILE ARTICULOS%FOUND LOOP
                    	pkg_sales_sehs_sp_iupd_venta_detalle(P_ID_VENTA,L_ID_ARTICULO,L_ID_ALMACEN,L_CANTIDAD,L_ID_VDETALLE,L_ERROR,L_MSGERROR);
                    
                        FETCH ARTICULOS INTO L_ID_VDETALLE,L_CANTIDAD,L_ID_ARTICULO;
                    END LOOP;
                CLOSE ARTICULOS;
               
                pkg_sales_sp_actualizar_total_venta(P_ID_VENTA);
               
               	L_ID_VENTA := P_ID_VENTA;
            END IF;
          */
--         <<salida_rapida>>
        
        P_ID_VDESPACHO := L_ID_VDESPACHO;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sehs_sp_iupd_venta_despacho ( P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint, P_ID_ALMACEN bigint,P_ID_VENTA bigint,P_ID_TIPOTRANSACCION bigint,P_ID_PERSONA bigint, P_FECHA_EMISION timestamp(0),P_FECHA_INICIO_TRASLADO timestamp(0),P_DIRECCION_PARTIDA text, P_DIRECCION_LLEGADA text,P_ID_MOTIVOTRASLADO bigint,P_ID_TRANSPORTISTA bigint, P_VEHICULO_MARCA text,P_VEHICULO_PLACA text,P_LICENCIA_TRANSPORTISTA text, P_ID_VDESPACHO INOUT bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
