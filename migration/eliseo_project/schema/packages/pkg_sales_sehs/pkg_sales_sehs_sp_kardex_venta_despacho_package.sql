-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_sehs,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sehs_sp_kardex_venta_despacho (P_ID_VDESPACHO bigint) AS $body$
DECLARE

        L_ID_ANHO bigint;
        L_ID_ALMACEN bigint;

        L_ID_DDETALLE bigint;
        L_ID_TIPOORIGEN bigint :=17; --VENTAS DESPACHO
        L_ID_ARTICULO bigint;
        L_CANTIDAD bigint;
        L_COSTO bigint;
        L_IMPORTE bigint;

        articulos CURSOR FOR	
        SELECT ID_DDETALLE,ID_ARTICULO,CANTIDAD
        , PRECIO_ALM
        , round((CANTIDAD*PRECIO_ALM)::numeric,2)
        FROM VENTA_DESPACHO_DETALLE
        WHERE ID_VDESPACHO = P_ID_VDESPACHO
        ORDER BY ID_ARTICULO;
        	

BEGIN   
        SELECT ID_ANHO, ID_ALMACEN INTO STRICT L_ID_ANHO, L_ID_ALMACEN
        FROM VENTA_DESPACHO
        WHERE ID_VDESPACHO = P_ID_VDESPACHO;

        OPEN articulos;
          FETCH articulos INTO L_ID_DDETALLE,L_ID_ARTICULO,L_CANTIDAD,L_COSTO,L_IMPORTE;
            WHILE articulos%FOUND LOOP
                CALL pkg_inventories_sp_add_kardex(L_ID_ANHO,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_TIPOORIGEN,L_ID_DDETALLE,L_CANTIDAD,L_COSTO,L_IMPORTE,'S');
                FETCH articulos INTO L_ID_DDETALLE,L_ID_ARTICULO,L_CANTIDAD,L_COSTO,L_IMPORTE;
            END LOOP;
        CLOSE articulos;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sehs_sp_kardex_venta_despacho (P_ID_VDESPACHO bigint) FROM PUBLIC;
