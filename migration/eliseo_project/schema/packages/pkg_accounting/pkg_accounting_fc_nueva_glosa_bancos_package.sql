-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_accounting,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_accounting_fc_nueva_glosa_bancos ( p_id_asiento text ) RETURNS varchar AS $body$
DECLARE


        l_glosa_old        varchar(200);
        l_glosa            varchar(200);
        l_id_tipo_origen   varchar(50);
        l_id_origen        varchar(50);
        l_estado           varchar(5);
        l_estado_c         varchar(5);
        l_importe          decimal(10,2);
        l_cuenta           varchar(10);
        l_asign            bigint;
        l_id_voucher       varchar(10);
        l_id_tipo_voucher  varchar(10);
        l_id_asiento       bigint;
        l_id_det_retencion bigint;

BEGIN
        SELECT
            (SELECT array_to_string(a, '') FROM regexp_matches(p_id_asiento, '[^-]+', 'g') AS foo(a) LIMIT 1 OFFSET (1 - 1) ),
            (SELECT array_to_string(a, '') FROM regexp_matches(p_id_asiento, '[^-]+', 'g') AS foo(a) LIMIT 1 OFFSET (2 - 1) )
        INTO STRICT
            l_id_asiento,
            l_id_det_retencion
;

        SELECT
            id_tipoorigen,
            id_origen,
            descripcion,
            cuenta,
            sign(importe),
            voucher
        INTO STRICT
            l_id_tipo_origen,
            l_id_origen,
            l_glosa_old,
            l_cuenta,
            l_asign,
            l_id_voucher
        FROM
            conta_asiento
        WHERE
            id_asiento = (SELECT array_to_string(a, '') FROM regexp_matches(p_id_asiento, '[^-]+', 'g') AS foo(a) LIMIT 1 OFFSET (1 - 1) );

        SELECT
            id_tipovoucher
        INTO STRICT l_id_tipo_voucher
        FROM
            conta_voucher
        WHERE
            id_voucher = l_id_voucher;

        l_estado_c :=
            CASE l_cuenta
                WHEN '1112001' THEN
                    '1'
                WHEN '1112025' THEN
                    '1'
                WHEN '2162001' THEN
                    '1'
                ELSE '0'
            END;

        IF l_id_tipo_origen = '5' THEN  -- GASTOS  
            IF l_estado_c = '1' THEN
                SELECT
                    cef.id_banco
                    || '-'
                    || coalesce(mp.id_mediopago, '00')
                    || '-'
                    || a.numero
                    || '-'
                    || to_char(a.fecha, 'DD/MM/YYYY')
                    || '-'
                    || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END
                    || '-'
                    || substr(cpga.descripcion, 1, 26)
                INTO STRICT l_glosa
                FROM
                         caja_pago a
                    INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                    INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                    INNER JOIN caja_pago_gasto         cpg ON cpg.id_pago = a.id_pago
                    INNER JOIN caja_pago_gasto_asiento cpga ON cpga.id_pgasto = cpg.id_pgasto
                    LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                               AND mp.id_mediopago IN( '005', '006' ) 
                WHERE
                    cpg.id_pgasto = l_id_origen;

            ELSIF l_estado_c = '0' THEN
                l_glosa := l_glosa_old;
            END IF;
        ELSIF l_id_tipo_origen = '7' THEN  --DEPOSITO   
            IF l_estado_c = '1' THEN
                SELECT
                    coalesce(cef.id_banco, '00')
                    || '-'
                    || CASE WHEN cd.id_tipotarjeta='1' THEN  '01' WHEN cd.id_tipotarjeta='2' THEN  '02' WHEN cd.id_tipotarjeta='3' THEN  '03' WHEN cd.id_tipotarjeta='4' THEN  '05' WHEN cd.id_tipotarjeta='5' THEN                               '07' WHEN cd.id_tipotarjeta='6' THEN  '08'  ELSE '00' END
                    || '-'
                    || cd.nro_operacion
                    || '-'
                    || to_char(cd.fecha_operacion, 'DD/MM/YYYY')
                    || '-'
                    || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                    || '-'
                    || substr(coalesce(cd.documento_dep, fc_documento_cliente(cd.id_cliente))
                              || coalesce(cd.nombre_dep, fc_nombre_cliente(cd.id_cliente)), 1, 26)
                INTO STRICT l_glosa
                FROM
                    caja_deposito           cd
                    LEFT JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = cd.id_ctabancaria
                    LEFT JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                WHERE
                    cd.id_deposito = l_id_origen;

            ELSIF l_estado_c = '0' THEN
                l_glosa := l_glosa_old;
            END IF;
        ELSIF l_id_tipo_origen = '8' THEN  --PAGO COMPRAS  
            IF l_asign = '1' THEN --D 
                l_estado :=
                    CASE l_cuenta
                        WHEN '2130101' THEN
                            '1'
                        ELSE '0'
                    END;
                IF l_estado = '1' THEN
                    SELECT
                        fc_ruc_proveedor(c.id_proveedor)
                        || '/'
                        || coalesce(c.serie, cs.serie)
                        || '-'
                        || lpad(coalesce(c.numero, cs.numero), 8, '0')
                        || '/'
                        || substr(cp.numero
                                  || substr(cef.nombre, 1, 10)
                                  || ' '
                                  || to_char(cp.fecha, 'DD/MM/YY'), 1, 26)
                    INTO STRICT l_glosa
                    FROM
                             caja_pago_compra cpc
                        INNER JOIN caja_pago               cp ON cp.id_pago = cpc.id_pago
                        INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = cp.id_ctabancaria
                        INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                        LEFT JOIN compra_saldo            cs ON cs.id_saldo = cpc.id_saldo
                        INNER JOIN compra                  c ON c.id_compra = cpc.id_compra
                                               OR c.id_compra = cs.id_compra
                    WHERE
                        cpc.id_pcompra = l_id_origen;

                ELSIF l_estado = '0' THEN
                    l_glosa := l_glosa_old;
                END IF;

            ELSIF l_asign = '-1' THEN --C 
                IF l_estado_c = '1' THEN
                    SELECT
                        cef.id_banco
                        || '-'
                        || CASE WHEN mp.id_mediopago='005' THEN  '01' WHEN mp.id_mediopago='006' THEN  '01'  ELSE '00' END
                        || '-'
                        || cp.numero
                        || '-'
                        || to_char(cp.fecha, 'DD/MM/YYYY')
                        || '-'
                        || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                        || '-'
                        || substr(ccb.nombre, 1, 26)
                    INTO STRICT l_glosa
                    FROM
                             caja_pago_compra cpc
                        INNER JOIN caja_pago               cp ON cp.id_pago = cpc.id_pago
                        INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = cp.id_ctabancaria
                        INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                        LEFT JOIN medio_pago              mp ON mp.id_mediopago = cp.id_mediopago
                                                   AND mp.id_mediopago IN( '005', '006' ) 
                    WHERE
                        cpc.id_pcompra = l_id_origen;

                ELSIF l_estado_c = '0' THEN
                    l_glosa := l_glosa_old;
                END IF;
            END IF;
        ELSIF l_id_tipo_origen = '9' THEN  -- TLC
            IF l_asign = '1' THEN --D 
                l_glosa := l_glosa_old;
            ELSIF l_asign = '-1' THEN --C 
                IF l_estado_c = '1' THEN
                    SELECT
                        cef.id_banco
                        || '-'
                        || CASE WHEN mp.id_mediopago='005' THEN  '01' WHEN mp.id_mediopago='006' THEN  '01'  ELSE '00' END
                        || '-'
                        || cp.numero
                        || '-'
                        || to_char(cp.fecha, 'DD/MM/YYYY')
                        || '-'
                        || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                        || '-'
                        || substr(cpv.detalle, 6, 32)
                    INTO STRICT l_glosa
                    FROM
                             caja_pago_venta cpv
                        INNER JOIN caja_pago               cp ON cp.id_pago = cpv.id_pago
                        INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = cp.id_ctabancaria
                        INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                        LEFT JOIN medio_pago              mp ON mp.id_mediopago = cp.id_mediopago
                                                   AND mp.id_mediopago IN( '005', '006' ) 
                    WHERE
                        id_pventa = l_id_origen;

                ELSIF l_estado_c = '0' THEN
                    l_glosa := l_glosa_old;
                END IF;
            END IF;
           ELSIF l_id_tipo_origen = '10' THEN  --CIERRE CAJA DEPOSITO 
            IF l_estado_c = '1' THEN
                SELECT
                    cef.id_banco
                    || '-'
                    || CASE WHEN mp.id_mediopago='005' THEN  '01' WHEN mp.id_mediopago='006' THEN  '01'  ELSE '00' END
                    || '-'
                    || cdb.operacion
                    || '-'
                    || to_char(cdb.fecha, 'DD/MM/YYYY')
                    || '-'
                    || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                    || '-'
                    || substr(cef.nombre, 1, 26)
                INTO STRICT l_glosa
                FROM
                         caja_cierre cc
                    INNER JOIN caja_deposito_banco     cdb ON cdb.id_cierre = cc.id_cierre
                    INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = cdb.id_ctabancaria
                    INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                    LEFT JOIN medio_pago              mp ON mp.id_mediopago = cdb.id_mediopago
                                               AND mp.id_mediopago IN( '005', '006' ) 
                WHERE
                    cdb.id_depbanco = l_id_origen;

            ELSIF l_estado_c = '0' THEN
                l_glosa := l_glosa_old;
            END IF;
        ELSIF l_id_tipo_origen = '11' THEN   --DETRACCION 
            IF l_asign = '1' THEN --D 
                SELECT
                    'DET-'
                    || a.nro_operacion
                    || '/'
                    || fc_ruc_proveedor(a.id_proveedor)
                    || '/'
                    || coalesce(c.serie, cs.serie)
                    || '-'
                    || lpad(coalesce(c.numero, cs.numero), 8, '0')
                    || '/'
                    || substr(tbs.nombre, 1, 26)
                INTO STRICT l_glosa
                FROM
                         caja_detraccion a
                    INNER JOIN caja_detraccion_compra cdc ON cdc.id_detraccion = a.id_detraccion
                    LEFT JOIN compra                 c ON c.id_compra = cdc.id_compra
                    LEFT JOIN compra_saldo           cs ON cs.id_saldo = cdc.id_saldo
                    INNER JOIN tipo_bien_servicio     tbs ON tbs.id_tipobienservicio = a.id_tipobienservicio
                WHERE
                    a.id_detraccion = l_id_origen;

            ELSIF l_asign = '-1' THEN --C 
                IF l_estado_c = '1' THEN
                    SELECT
                        cef.id_banco
                        || '-'
                        || CASE WHEN mp.id_mediopago='005' THEN  '01' WHEN mp.id_mediopago='006' THEN  '01'  ELSE '00' END
                        || '-'
                        || a.nro_operacion
                        || '-'
                        || to_char(a.fecha_emision, 'DD/MM/YYYY')
                        || '-'
                        || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                        || '-'
                        || substr(fc_ruc_proveedor(a.id_proveedor)
                                  || ' '
                                  || c.serie
                                  || '-'
                                  || c.numero
                                  || ' '
                                  || to_char(c.fecha_doc, 'DD/MM'), 1, 26)
                    INTO STRICT l_glosa
                    FROM
                             caja_detraccion a
                        INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                        INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                        INNER JOIN caja_detraccion_compra  cdc ON cdc.id_detraccion = a.id_detraccion
                        LEFT JOIN compra_saldo            cs ON cs.id_saldo = cdc.id_saldo
                        INNER JOIN compra                  c ON c.id_compra = cdc.id_compra
                                               OR c.id_compra = cs.id_compra
                        LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                                   AND mp.id_mediopago IN( '005', '006' ) 
                    WHERE
                        a.id_detraccion = l_id_origen;

                ELSIF l_estado_c = '0' THEN
                    l_glosa := l_glosa_old;
                END IF;
            END IF;
        ELSIF l_id_tipo_origen = '12' THEN  --RETENCION  
            IF l_asign = '1' THEN --D 
                SELECT
                    'RET/'
                    || a.serie
                    || '-'
                    || lpad(a.nro_retencion, 8, '0')
                    || '/'
                    || fc_ruc_proveedor(a.id_proveedor)
                    || '/'
                    || coalesce(c.serie, cs.serie)
                    || '-'
                    || lpad(coalesce(c.numero, cs.numero), 8, '0')
                    || '/'
                    || substr(fc_nombre_cliente(a.id_proveedor), 1, 25)
                INTO STRICT l_glosa
                FROM
                         caja_retencion a
                    INNER JOIN caja_retencion_compra crc ON crc.id_retencion = a.id_retencion
                                                            AND crc.id_retdetalle = l_id_det_retencion
                    LEFT JOIN compra                c ON c.id_compra = crc.id_compra
                    LEFT JOIN compra_saldo          cs ON cs.id_saldo = crc.id_saldo
                WHERE
                    a.id_retencion = l_id_origen;

            ELSIF l_asign = '-1' THEN --C 
                SELECT
                    coalesce(cef.id_banco, '00')
                    || '-'
                    || CASE WHEN mp.id_mediopago='005' THEN  '01' WHEN mp.id_mediopago='006' THEN  '01'  ELSE '00' END
                    || '-'
                    || a.nro_retencion
                    || '-'
                    || to_char(a.fecha_emision, 'DD/MM/YYYY')
                    || '-'
                    || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                    || '-'
                    || substr(fc_ruc_proveedor(a.id_proveedor), 1, 26)
                INTO STRICT l_glosa
                FROM
                    caja_retencion          a
                    LEFT JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                    LEFT JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                    LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                               AND mp.id_mediopago IN( '005', '006' ) 
                WHERE
                    a.id_retencion = l_id_origen;
            END IF;

        ELSIF l_id_tipo_origen = '15' THEN  --VALES 
            IF l_asign = '1' THEN --D 
                l_glosa := l_glosa_old;
            ELSIF l_asign = '-1' THEN --C  
                IF l_estado_c = '1' THEN
                    SELECT
                        cef.id_banco
                        || '-'
                        || CASE WHEN mp.id_mediopago='005' THEN  '01' WHEN mp.id_mediopago='006' THEN  '01'  ELSE '00' END
                        || '-'
                        || a.numero
                        || '-'
                        || to_char(a.fecha, 'DD/MM/YYYY')
                        || '-'
                        || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                        || '-'
                        || a.detalle glosa
                    INTO STRICT l_glosa
                    FROM
                             caja_vale a
                        INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                        INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                        LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                                   AND mp.id_mediopago IN( '005', '006' ) 
                    WHERE
                        a.id_vale = l_id_origen;

                ELSIF l_estado_c = '0' THEN
                    l_glosa := l_glosa_old;
                END IF;
            END IF;
        ELSIF l_id_tipo_origen = '16' THEN  --CIERRE CAJA 
            IF l_estado_c = '1' THEN
                SELECT
                    cef.id_banco
                    || '-'
                    || CASE WHEN mp.id_mediopago='005' THEN  '01' WHEN mp.id_mediopago='006' THEN  '01'  ELSE '00' END
                    || '-'
                    || cdb.operacion
                    || '-'
                    || to_char(cdb.fecha, 'DD/MM/YYYY')
                    || '-'
                    || CASE WHEN l_id_tipo_voucher='4' THEN  'TL' WHEN l_id_tipo_voucher='6' THEN  'RN' WHEN l_id_tipo_voucher='3' THEN  'CH' WHEN l_id_tipo_voucher='5' THEN  'IN' END 
                    || '-'
                    || substr(cef.nombre, 1, 26)
                INTO STRICT l_glosa
                FROM
                         caja_cierre cc
                    INNER JOIN caja_deposito_banco     cdb ON cdb.id_cierre = cc.id_cierre
                    INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = cdb.id_ctabancaria
                    INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                    LEFT JOIN medio_pago              mp ON mp.id_mediopago = cdb.id_mediopago
                                               AND mp.id_mediopago IN( '005', '006' ) 
                WHERE
                    cc.id_cierre = l_id_origen;

            ELSIF l_estado_c = '0' THEN
                l_glosa := l_glosa_old;
            END IF;

        ELSE
            l_glosa := 'XXXX';
        END IF;

        RETURN( l_glosa );
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION eliseo.pkg_accounting_fc_nueva_glosa_bancos ( p_id_asiento text ) FROM PUBLIC;
