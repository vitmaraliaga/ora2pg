-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_payonline,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_payonline_sp_deposito_alumno_upeu_visa ( P_ID_PERSONA bigint, P_OPERACION text, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_IMPORTE bigint, P_IP text, P_ID_DINAMICA bigint, P_COD_TARJETA text, P_ID_ORIGEN text, P_ID_CLIENTE bigint, P_ID_COMPROBANTE text, P_ID_TIPOVENTA bigint, P_ID OUT text, P_ERROR OUT bigint, P_MSGERROR out text) AS $body$
DECLARE

     l_id_anho bigint;
     l_id_mes bigint;
     l_id_mediopago varchar(5):='006';
     l_id_user bigint:=2; --cajero Visa Net Online C/E
     l_ventas varchar(3000):=null;
     l_ventas_imp varchar(3000):=null;
     l_tipo varchar(3000):=null;
     l_id_tipotransaccion integer:=166;
     l_contar bigint:=0;
     l_id_moneda bigint:=7;
     l_fecha timestamp(0);
     l_importe_me bigint:=0;
     l_tipocambio bigint:=0;
     l_glosa varchar(100);
     l_id_tipoasiento varchar(5) := 'MB';

     l_error bigint:=0;
     l_msgerror varchar(200):='';
     l_id_tipovoucher bigint := 5;
     l_id_tipotarjeta bigint;

BEGIN
     
        select 
        (to_char(clock_timestamp(),'YYYY'))::numeric , 
        (to_char(clock_timestamp(),'MM'))::numeric ,
        clock_timestamp(),
        'DEPÓSITO CON VISA'
        into STRICT
        l_id_anho,
        l_id_mes,
        l_fecha,
        l_glosa
;
        
        --valida vouche
      
        SELECT COUNT(1) INTO STRICT l_contar FROM CONTA_VOUCHER_CONFIG
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_ANHO = l_id_anho
        AND ID_TIPOVOUCHER = l_id_tipovoucher;

        if l_contar < 1 then
            l_error:=1;
            l_msgerror:='Alto: No existe tipo de Asiento (RV) ';
--             GOTO salida_dep;
        elsif l_contar > 1 then
            l_error:=1;
            l_msgerror:='Alto: Existe más de una configuración de Tipo de Asiento (RV) '||l_id_anho::text;
--             GOTO salida_dep;
        end if;

        SELECT ID_TIPOASIENTO INTO STRICT l_id_tipoasiento FROM CONTA_VOUCHER_CONFIG
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_ANHO = l_id_anho
        AND ID_TIPOVOUCHER = l_id_tipovoucher;


      
          
        
        SELECT count(1) into STRICT l_contar  
        FROM CONTA_DINAMICA
        WHERE ID_DINAMICA=P_ID_DINAMICA;

        if l_contar>0 then
          SELECT id_tipotransaccion into STRICT l_id_tipotransaccion  
          FROM CONTA_DINAMICA
          WHERE ID_DINAMICA=P_ID_DINAMICA;
        else
          l_error:=1;
          l_msgerror:='Alto: No esta configurado tipo de transacción';
--           GOTO salida_dep;
        end if;

        
        SELECT  count(1) into STRICT l_contar FROM CONTA_VOUCHER_CONFIG
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO =P_ID_DEPTO
        AND ID_MODULO = '14'--modulo tesoreria
        AND ID_ANHO = l_id_anho
        and ID_TIPOASIENTO=l_id_tipoasiento
        AND AUTOMATICO='S'
        AND ID_TIPOVOUCHER = l_id_tipovoucher;

        if l_contar < 1 then
            l_error:=1;
            l_msgerror:='Alto: No existe la configuración de vouchers para los depositos, del periodo '||l_id_anho::text;
--             GOTO salida_dep;
        elsif l_contar > 1 then
            l_error:=1;
            l_msgerror:='Alto: Existe más de una configuración de vouchers para los Depositos, del periodo '||l_id_anho::text;
--             GOTO salida_dep;
        end if;

        
        CALL pkg_payonline_sp_ventas_depositar(
                P_ID_ENTIDAD,
                P_ID_DEPTO,
                l_id_anho,
                P_ID_PERSONA,
                P_IMPORTE,
                l_ventas,
                l_ventas_imp,
                l_tipo
        );

        SELECT COUNT(1) INTO STRICT l_contar FROM CAJA_TIPOTARJETA WHERE codigo=P_COD_TARJETA;
        if l_contar>0 then
           SELECT id_tipotarjeta INTO STRICT l_id_tipotarjeta FROM CAJA_TIPOTARJETA WHERE codigo=P_COD_TARJETA;

        end if;

        
        CALL pkg_payonline_sp_crear_deposito_alum_visa(P_ID_ENTIDAD,P_ID_DEPTO,l_id_anho,l_id_mes,l_id_mediopago,l_id_user,
                                  P_ID_PERSONA,l_ventas,l_ventas_imp,l_tipo,l_id_tipotransaccion,l_id_moneda,
                                  P_ID_DINAMICA,l_id_tipotarjeta,null,P_OPERACION,l_fecha,0,
                                  P_IMPORTE,0,l_importe_me,l_tipocambio,l_glosa,null, null,l_id_tipoasiento,
                                  l_error,l_msgerror);
        IF l_error <> 0 THEN
            ROLLBACK;
        END IF;

--        <<salida_dep>>
       P_ERROR:=l_error;
       P_MSGERROR:=l_msgerror;

     END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_payonline_sp_deposito_alumno_upeu_visa ( P_ID_PERSONA bigint, P_OPERACION text, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_IMPORTE bigint, P_IP text, P_ID_DINAMICA bigint, P_COD_TARJETA text, P_ID_ORIGEN text, P_ID_CLIENTE bigint, P_ID_COMPROBANTE text, P_ID_TIPOVENTA bigint, P_ID OUT text, P_ERROR OUT bigint, P_MSGERROR out text) FROM PUBLIC;
