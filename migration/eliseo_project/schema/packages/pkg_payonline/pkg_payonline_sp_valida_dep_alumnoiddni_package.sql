-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_payonline,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_payonline_sp_valida_dep_alumnoiddni ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_DINAMICA bigint, P_ID_COMPROBANTE text, P_ID_ANHO bigint, P_ID_MES bigint, P_ID_PERSONA bigint, P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';

        l_id_tipoasiento varchar(5) := 'MB';
        l_id_tipovoucher bigint := 5;
        l_serie varchar(4);
        l_correlativo bigint :=0;
        l_contar bigint:=0;
        L_ID_TIPOASIENTOT varchar(5):='RV';
        l_id_dinamica_dep bigint :=0;
        l_id_tipovoucher_venta bigint := 1;

BEGIN
       
        if P_ID_COMPROBANTE='00' then
      
          select count(1) into STRICT l_contar from CONTA_DINAMICA_ASIENTO WHERE ID_DINAMICA=P_ID_DINAMICA;

          IF l_contar<=1 THEN
              l_error:=1;
              l_msgerror:='Alto: Falta configurar los asientos de la dinámica  ('||P_ID_DINAMICA::text||')';
--               GOTO salida_valalumiddni;
          END IF;
        else

          select count(1) into STRICT l_contar from CONTA_DINAMICA_ASIENTO WHERE ID_DINAMICA=P_ID_DINAMICA;

          IF l_contar<=1 THEN
              l_error:=1;
              l_msgerror:='Alto: Falta configurar los asientos de la dinámica  ('||P_ID_DINAMICA::text||')';
--               GOTO salida_valalumiddni;
          END IF;

          select id_parent into STRICT l_id_dinamica_dep from CONTA_DINAMICA  where id_dinamica=P_ID_DINAMICA;

          
          select count(1) into STRICT l_contar from CONTA_DINAMICA_ASIENTO WHERE ID_DINAMICA=l_id_dinamica_dep;

          IF l_contar<=1 THEN
              l_error:=1;
              l_msgerror:='Alto: Falta configurar los asientos de la dinámica depósito  ('||l_id_dinamica_dep::text||')';
--               GOTO salida_valalumiddni;
          END IF;

          --voucher de venta
          SELECT COUNT(1) INTO STRICT l_contar FROM CONTA_VOUCHER_CONFIG
          WHERE ID_ENTIDAD = P_ID_ENTIDAD
          AND ID_DEPTO = P_ID_DEPTO
          AND ID_ANHO = P_ID_ANHO
          AND ID_TIPOVOUCHER = l_id_tipovoucher_venta;

          if l_contar < 1 then
              l_error:=1;
              l_msgerror:='Alto: No existe la configuración de vouchers para las ventas, del periodo ';
--               GOTO salida_valalumiddni;
          elsif l_contar > 1 then
              l_error:=1;
              l_msgerror:='Alto: Existe más de una configuración de vouchers para las ventas, del periodo '||P_ID_ANHO::text;
--               GOTO salida_valalumiddni;
          end if;

          SELECT ID_TIPOASIENTO INTO STRICT l_id_tipoasiento FROM CONTA_VOUCHER_CONFIG
          WHERE ID_ENTIDAD = P_ID_ENTIDAD
          AND ID_DEPTO = P_ID_DEPTO
          AND ID_ANHO = P_ID_ANHO
          AND ID_TIPOVOUCHER = l_id_tipovoucher_venta;

          SELECT   count(1) into STRICT l_contar FROM CONTA_VOUCHER_CONFIG
          WHERE ID_ENTIDAD = P_ID_ENTIDAD
          AND ID_DEPTO =P_ID_DEPTO
          AND ID_MODULO = '13'--modulo ventas
          AND ID_ANHO = P_ID_ANHO
          and ID_TIPOASIENTO=l_id_tipoasiento
          AND AUTOMATICO='S'
          AND ID_TIPOVOUCHER = l_id_tipovoucher_venta;

          if l_contar < 1 then
              l_error:=1;
              l_msgerror:='Alto: No existe tipo de Asiento (RV) ';
--               GOTO salida_valalumiddni;
          elsif l_contar > 1 then
              l_error:=1;
              l_msgerror:='Alto: Existe más de una configuración de Tipo de Asiento (RV) '||P_ID_ANHO::text;
--               GOTO salida_valalumiddni;
          end if;

          
        end if;

      --valida vouche
      
      --voucher de venta
          SELECT COUNT(1) INTO STRICT l_contar FROM CONTA_VOUCHER_CONFIG
          WHERE ID_ENTIDAD = P_ID_ENTIDAD
          AND ID_DEPTO = P_ID_DEPTO
          AND ID_ANHO = P_ID_ANHO
          AND ID_TIPOVOUCHER = l_id_tipovoucher;

          if l_contar < 1 then
              l_error:=1;
              l_msgerror:='Alto: No existe la configuración de vouchers para las ventas, del periodo ';
--               GOTO salida_valalumiddni;
          elsif l_contar > 1 then
              l_error:=1;
              l_msgerror:='Alto: Existe más de una configuración de vouchers para las ventas, del periodo '||P_ID_ANHO::text;
--               GOTO salida_valalumiddni;
          end if;

          SELECT ID_TIPOASIENTO INTO STRICT l_id_tipoasiento FROM CONTA_VOUCHER_CONFIG
          WHERE ID_ENTIDAD = P_ID_ENTIDAD
          AND ID_DEPTO = P_ID_DEPTO
          AND ID_ANHO = P_ID_ANHO
          AND ID_TIPOVOUCHER = l_id_tipovoucher;

      
      
      SELECT  count(1) into STRICT l_contar FROM CONTA_VOUCHER_CONFIG
      WHERE ID_ENTIDAD = P_ID_ENTIDAD
      AND ID_DEPTO =P_ID_DEPTO
      AND ID_MODULO = '14'--modulo tesoreria
      AND ID_ANHO = P_ID_ANHO
      and ID_TIPOASIENTO=l_id_tipoasiento
      AND AUTOMATICO='S'
      AND ID_TIPOVOUCHER = l_id_tipovoucher;

      if l_contar < 1 then
          l_error:=1;
          l_msgerror:='Alto: No existe la configuración de vouchers para los depósitos, en el periodo '||P_ID_ANHO::text;
--           GOTO salida_valalumiddni;
      elsif l_contar > 1 then
          l_error:=1;
          l_msgerror:='Alto: Existe más de una configuración de vouchers para los depósitos, en el periodo '||P_ID_ANHO::text;
--           GOTO salida_valalumiddni;
      end if;

     
      
        SELECT COUNT(1) INTO STRICT l_contar FROM FIN_DOCUMENTO_DEPTO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_COMPROBANTE = P_ID_COMPROBANTE;

      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Alto: No esta configurado el documento para el tipo de comprobante: (FIN: '||P_ID_COMPROBANTE||')';
--           GOTO salida_valalumiddni;
      ELSIF l_contar > 1 THEN
          L_ERROR:=1;
          l_msgerror:='Alto: Existe más de una configuración de documento para el tipo de comprobante: (FIN: '||P_ID_COMPROBANTE||')';
--           GOTO salida_valalumiddni;
      END IF;

    
      
      --valida se esta asignado contador
      SELECT COUNT(1) INTO STRICT l_contar FROM FIN_CONTADOR_DEPTO
      WHERE ID_ENTIDAD = P_ID_ENTIDAD
      AND ID_DEPTO = P_ID_DEPTO;

     if l_contar = 0 then
          l_error:=1;
          l_msgerror:='Alto: No existe asignado un contador para la entidad: ' || P_ID_ENTIDAD || ' y el departamento: ' || P_ID_DEPTO;
--           GOTO salida_valalumiddni;
      end if;

--        <<salida_valalumiddni>>
      
      P_ERROR:=l_error;
      P_MSGERROR:=l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_payonline_sp_valida_dep_alumnoiddni ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_DINAMICA bigint, P_ID_COMPROBANTE text, P_ID_ANHO bigint, P_ID_MES bigint, P_ID_PERSONA bigint, P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
