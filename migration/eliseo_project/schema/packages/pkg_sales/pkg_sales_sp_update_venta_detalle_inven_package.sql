-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_update_venta_detalle_inven (P_ID_VENTA bigint,P_ID_VDETALLE bigint,P_CANTIDAD bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        L_ID_ANHO bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_ID_CLIENTE bigint;
        L_ID_POLITICA bigint;
        l_cont bigint;
        l_precio decimal(10,2);
        l_igv decimal(10,2);
        l_igv_item decimal(10,2);
        l_precio_base decimal(10,2);
        l_precio_alm decimal(10,2);
        l_base decimal(10,2);
        l_descuento decimal(10,2):=0;
        l_totaldescuento decimal(10,2):=0;
        l_importe decimal(10,2);
        l_tc decimal(10,3);
        l_id_tipoigv bigint;
        l_gravado varchar(2);
        l_precio_me decimal(10,2);
        l_igv_me decimal(10,2);
        l_precio_base_me decimal(10,2);
        l_precio_alm_me decimal(10,2);
        l_base_me decimal(10,2);
        l_descuento_me decimal(10,2);
        l_importe_me decimal(10,2);
        l_id_moneda bigint;
        l_contar bigint;
        L_DETALLE varchar(255);
        L_STOCK decimal(10,2);
        L_STOCK_T decimal(10,2);
        L_COSTO_ST decimal(10,2);
        L_MSN varchar(200):='';
        L_ES_DECIMAL varchar(1);
        L_ES_ENTERO decimal(10,2);
        l_otros_cargos decimal(10,2) :=0;
        l_otros_cargos_me decimal(10,2) :=0;
        L_CODIGO varchar(8);

BEGIN
            
            SELECT ID_ANHO,ID_IGV,TIPOCAMBIO,ID_MONEDA,ID_CLIENTE INTO STRICT L_ID_ANHO,l_igv,l_tc,l_id_moneda,l_id_cliente 
            FROM venta WHERE id_venta=P_ID_VENTA;
            SELECT ID_ALMACEN,ID_ARTICULO INTO STRICT L_ID_ALMACEN,L_ID_ARTICULO FROM VENTA_DETALLE WHERE ID_VDETALLE = P_ID_VDETALLE;
            CALL pkg_inventories_sp_articulo_stock(L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO,L_STOCK,L_COSTO_ST,L_MSN);
            CALL pkg_inventories_sp_articulo_stock_temp(L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO,L_STOCK_T,L_MSN);

            SELECT SUBSTR(CODIGO,9,16) INTO STRICT L_CODIGO FROM INVENTARIO_ARTICULO WHERE ID_ARTICULO = L_ID_ARTICULO;

            IF L_STOCK > 0 THEN
                IF (L_STOCK-L_STOCK_T) >= P_CANTIDAD THEN
                    -- VERIFICA SI ACEPTA CANTIDADES DECIMALES
                    SELECT  B.ES_DECIMAL,
                            CEIL((coalesce(P_CANTIDAD,0))::numeric ) AS ES_ENTERO INTO STRICT L_ES_DECIMAL,L_ES_ENTERO
                    FROM INVENTARIO_ARTICULO A JOIN INVENTARIO_UNIDAD_MEDIDA B
                    ON A.ID_UNIDADMEDIDA = B.ID_UNIDADMEDIDA
                    WHERE A.ID_ARTICULO = L_ID_ARTICULO;

                    IF L_ES_DECIMAL = 'N' AND L_ES_ENTERO <> P_CANTIDAD THEN
                        P_ERROR:=1;
                        P_MSGERROR := 'NO SE ACEPTAN CANTIDADES DECIMALES';

                    ELSE
                        --obtiene precio del almacen
                        CALL pkg_sales_sp_precio_articulo(l_id_cliente,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO,l_id_tipoigv,l_precio_alm,l_precio,l_descuento);

                        if coalesce(l_precio_alm::text, '') = '' then
                            l_precio_alm:=0;
                        end if;

                        select count(1) into STRICT l_contar from TIPO_IGV where ID_TIPOIGV=l_id_tipoigv;
                        if l_contar>0 then
                            select GRAVADO into STRICT l_gravado from TIPO_IGV where ID_TIPOIGV=l_id_tipoigv;
                        end if;

                        --IF L_CODIGO = '24111503' THEN --CODIGO PARA IMPUESTO DE BOLSAS
                        IF L_CODIGO IN ('24111586','24111587') THEN 
                            l_precio := l_precio - 0.5;
                            l_otros_cargos := P_CANTIDAD * 0.5;
                        END IF;

                        l_igv:=l_igv/100;
                        l_totaldescuento:=l_descuento*P_CANTIDAD;
                        --l_precio:=P_PRECIO;
                        l_precio_base:=l_precio;
                        l_importe:=((l_precio*P_CANTIDAD)+l_otros_cargos)-(l_totaldescuento);
                        --l_precio_alm:=l_precio_alm;
                        l_base:=l_importe;
                        l_igv_item:=0;
                        if l_gravado in ('G') then
                            l_precio_base:=l_precio/(1+l_igv);
                            l_base:=(l_importe-l_otros_cargos)/(1+l_igv);
                            l_igv_item:=(l_importe-l_otros_cargos)-l_base;
                        end if;
                        l_descuento:=l_totaldescuento;
                        l_precio_me:=0;
                        l_precio_base_me:=0;
                        l_precio_alm_me:=0;
                        l_base_me:=0;
                        l_igv_me:=0;
                        l_descuento_me:=0;
                        l_importe_me:=0;
                      
                        if l_id_moneda=9 then
                            --l_totaldescuento:=l_descuento*P_CANTIDAD;
                            --l_totaldescuento:=l_totaldescuento/l_tc;
                            l_totaldescuento:=l_totaldescuento/l_tc;
                            l_precio_me:=l_precio/l_tc;
                            l_precio_base_me:=l_precio_base/l_tc;
                            l_importe_me:=l_importe/l_tc;
                            l_precio_alm_me:=l_precio_alm/l_tc;
                            l_base_me:=l_base/l_tc;
                            l_igv_me:=l_igv_item/l_tc;
                            l_descuento_me:=l_totaldescuento;
                        end if;
                        UPDATE VENTA_DETALLE SET
                                                CANTIDAD=P_CANTIDAD,
                                                PRECIO=l_precio,
                                                BASE=l_base,
                                                IGV=l_igv_item, 
                                                DESCUENTO=l_descuento, 
                                                IMPORTE=l_importe, 
                                                BASE_ME=l_base_me, 
                                                IGV_ME=l_igv_me, 
                                                DESCUENTO_ME=l_descuento_me, 
                                                IMPORTE_ME=l_importe_me,
                                                OTROS_CARGOS = l_otros_cargos
                        WHERE ID_VENTA=P_ID_VENTA
                        AND ID_VDETALLE=P_ID_VDETALLE;
                        CALL pkg_sales_sp_actualizar_total_venta(P_ID_VENTA);
                        P_ERROR:=0;
                        P_MSGERROR := 'OK';
                    END IF;
                ELSE
                    P_ERROR := 1;
                    P_MSGERROR := 'Stock Insuficiente AA : '||L_STOCK||' - '||L_ID_ANHO;
                END IF;
            ELSE
                P_ERROR := 1;
                P_MSGERROR := 'Stock Insuficiente A : '||L_STOCK;
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_update_venta_detalle_inven (P_ID_VENTA bigint,P_ID_VDETALLE bigint,P_CANTIDAD bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
