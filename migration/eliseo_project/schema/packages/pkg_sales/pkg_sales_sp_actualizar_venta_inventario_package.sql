-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_actualizar_venta_inventario (P_ID_VENTA bigint,P_ID_CLIENTE bigint,P_ID_SUCURSAL bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        L_ID_PERSONA bigint;
        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        l_id_cliente bigint:= null;
        l_id_sucursal bigint;
        l_id_moneda bigint;
        l_tc decimal(10,3);
        l_igv decimal(10,2);
        l_totaldescuento decimal(10,2);
        L_ID_VDETALLE bigint;
        L_CANTIDAD decimal(10,2);
        L_ERROR bigint :=0;
        L_MSGERROR varchar(200) :='OK';
        L_DOCUMENTO bigint :=0;

        ARTICULOS CURSOR FOR
        SELECT ID_VDETALLE,CANTIDAD 
        FROM VENTA_DETALLE
        WHERE ID_VENTA = P_ID_VENTA;

        
BEGIN
            select ID_ENTIDAD,ID_DEPTO,ID_PERSONA,coalesce(ID_CLIENTE,0),TIPOCAMBIO,ID_MONEDA into STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_PERSONA,l_id_cliente,l_tc,l_id_moneda from venta where id_venta=P_ID_VENTA;

            l_id_sucursal:=P_ID_SUCURSAL;
            if P_ID_SUCURSAL=0 then
              l_id_sucursal:=null;
            end if;

            --ACTUALIZA CABECERA
            if l_id_cliente <> P_ID_CLIENTE then
                l_id_cliente := P_ID_CLIENTE;
                l_totaldescuento:=0;
            end if;
            IF coalesce(P_ID_CLIENTE::text, '') = '' OR P_ID_CLIENTE = 0 THEN
                l_id_cliente:=null;
            END IF;

            SELECT pkg_sales_fc_documento_impresion_user(L_ID_PERSONA,P_ID_COMPROBANTE,L_ID_ENTIDAD,L_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                L_ERROR :=1;
                L_MSGERROR := 'Alto! El usuario no tiene asignado un punto de impresi√≥n para el tipo de documento: ' || P_ID_COMPROBANTE;
--                 GOTO salida_rapida;
            END IF;
            
            IF L_ERROR = 0 THEN 
            
                UPDATE VENTA SET
                                ID_CLIENTE= l_id_cliente,
                                ID_SUCURSAL=l_id_sucursal,
                                ID_COMPROBANTE=P_ID_COMPROBANTE,
                                ID_MONEDA=P_ID_MONEDA
                WHERE ID_VENTA=P_ID_VENTA;

                OPEN ARTICULOS;
                    FETCH ARTICULOS INTO L_ID_VDETALLE,L_CANTIDAD;
                    WHILE ARTICULOS%FOUND LOOP
                        CALL pkg_sales_sp_update_venta_detalle_inven(P_ID_VENTA,L_ID_VDETALLE,L_CANTIDAD,L_ERROR,L_MSGERROR);
                        FETCH ARTICULOS INTO L_ID_VDETALLE,L_CANTIDAD;
                    END LOOP;
                CLOSE ARTICULOS;
                CALL pkg_sales_sp_actualizar_total_venta(P_ID_VENTA);
            END IF;

--             <<salida_rapida>>
            --P_ID_VENTA := L_ID_VENTA;
            P_ERROR := L_ERROR;
            P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_actualizar_venta_inventario (P_ID_VENTA bigint,P_ID_CLIENTE bigint,P_ID_SUCURSAL bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
