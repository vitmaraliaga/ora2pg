-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_re_genera_asiento_sales (P_ID_VENTA bigint) AS $body$
DECLARE

        L_ID_VENTA bigint;
        L_ID_VOUCHER bigint;
        L_ERROR bigint;
        L_MSN_ERROR varchar(200);

        ASIENTO CURSOR FOR	
        SELECT ID_VENTA FROM VENTA
        WHERE ID_ANHO = 2020
        AND ID_VENTA = P_ID_VENTA
        --AND SERIE = 'B122'
        --AND TO_CHAR(FECHA,'DD') IN ('08','09','10')
        --AND SERIE = 'B514'
        --AND TO_CHAR(FECHA,'DD')  = '17'
        --AND TOTAL <> 0
        ORDER BY ID_VENTA;

        	
        
BEGIN 
            
            OPEN ASIENTO;
              FETCH ASIENTO INTO L_ID_VENTA;
                WHILE ASIENTO%FOUND LOOP

                    DELETE FROM CONTA_ASIENTO
                    WHERE ID_TIPOORIGEN = 1
                    AND ID_ORIGEN IN (SELECT ID_VDETALLE FROM VENTA_DETALLE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_VENTA = L_ID_VENTA
                    ) );

                    CALL pkg_sales_sp_generar_asiento(L_ID_VENTA,L_ERROR,L_MSN_ERROR);

                    FETCH ASIENTO INTO L_ID_VENTA;
                END LOOP;
            CLOSE ASIENTO;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_re_genera_asiento_sales (P_ID_VENTA bigint) FROM PUBLIC;
