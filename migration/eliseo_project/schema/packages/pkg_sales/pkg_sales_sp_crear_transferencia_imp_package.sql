-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_transferencia_imp (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint,P_ID_TIPOTRANSACCION bigint,P_ID_DINAMICA bigint,P_ID_MONEDA bigint,P_GLOSA text,P_IMPORTE bigint,P_DC text,P_ID_TRANSFERENCIA OUT bigint,P_ERROR OUT bigint) AS $body$
DECLARE

        l_cont bigint;	
        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda_tc bigint;
        l_contar bigint;
        L_DOCUMENTO bigint :=0;
        l_id_empleado bigint;
        P_MSN_ERROR varchar(100);

        
BEGIN
            P_ERROR :=0;
            SELECT COALESCE(MAX(ID_TRANSFERENCIA),0)+1 INTO STRICT l_cont FROM VENTA_TRANSFERENCIA;
            l_id_moneda_tc:=9;

            --obtiene tipo de cambio del dia
            select FC_TIPOCAMBIO(l_id_moneda_tc,CURRENT_DATE,'D' ) into STRICT l_tc;

            if coalesce(l_tc::text, '') = '' then
                l_tc:=0;
            end if;

            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,'00',P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                P_ERROR :=1;
            END IF;

            INSERT INTO VENTA_TRANSFERENCIA(ID_TRANSFERENCIA,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_PERSONA,ID_CLIENTE,ID_TIPOTRANSACCION,ID_DINAMICA,ID_MONEDA,TIPOCAMBIO,SERIE,NUMERO,FECHA,GLOSA,IMPORTE,ESTADO 
            )VALUES (l_cont,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,P_ID_PERSONA,P_ID_CLIENTE,P_ID_TIPOTRANSACCION,P_ID_DINAMICA,P_ID_MONEDA,l_tc,'-','-',clock_timestamp(),P_GLOSA,P_IMPORTE,0);
            P_ID_TRANSFERENCIA:=l_cont;

            SELECT 
            count(*) INTO STRICT l_contar
            FROM VW_SALES_SALDO
            WHERE ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_DEPTO = P_ID_DEPTO
            AND ID_CLIENTE = P_ID_PERSONA;

            IF l_contar = 0 THEN
                CALL pkg_sales_sp_crear_transferencia_detalle(P_ID_TRANSFERENCIA,0,P_IMPORTE,P_DC,'Detalle',P_ERROR,P_MSN_ERROR);
            ELSE
                CALL pkg_sales_sp_ventas_asignar_doc(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_CLIENTE,2,P_ID_TRANSFERENCIA,P_IMPORTE,P_DC);
            END IF;

            EXCEPTION
            WHEN OTHERS THEN
            P_ERROR :=2;

          
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_transferencia_imp (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint,P_ID_TIPOTRANSACCION bigint,P_ID_DINAMICA bigint,P_ID_MONEDA bigint,P_GLOSA text,P_IMPORTE bigint,P_DC text,P_ID_TRANSFERENCIA OUT bigint,P_ERROR OUT bigint) FROM PUBLIC;
