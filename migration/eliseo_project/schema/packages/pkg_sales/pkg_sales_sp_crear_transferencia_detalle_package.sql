-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_transferencia_detalle (P_ID_TRANSFERENCIA bigint,P_ID_VENTA bigint,P_IMPORTE text,P_DC text,P_DETALLE text,P_ERROR OUT bigint,P_MSN_ERROR OUT text) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_ID_ANHO bigint;
        l_cont bigint;
        l_contar bigint := 0;
        L_SALDO decimal(10,2);
        L_TIPO varchar(1);
        L_ID_VENTA bigint;
        L_ID_SALDO bigint;
        L_MSN_ERROR varchar(200);
        L_ID_PERSONA bigint;
        L_GLOSA varchar(200);
        L_ID_TRANSFERENCIA_P bigint;

        
BEGIN
            P_ERROR :=0;

            SELECT ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_CLIENTE,GLOSA INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_ANHO,L_ID_PERSONA,L_GLOSA FROM VENTA_TRANSFERENCIA WHERE ID_TRANSFERENCIA = P_ID_TRANSFERENCIA;

            SELECT COUNT(1) into STRICT l_contar FROM VENTA_TRANSFERENCIA_DETALLE WHERE ID_TRANSFERENCIA = P_ID_TRANSFERENCIA AND ID_VENTA = P_ID_VENTA;

            /*SELECT 
                    TOTAL INTO L_SALDO
            FROM VW_SALES_SALDO
            WHERE ID_VENTA = P_ID_VENTA;*/
            
            SELECT 
                    coalesce(MAX(COUNT(1)),0) INTO STRICT l_contar
            FROM VW_SALES_MOV WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_DEPTO = L_ID_DEPTO  AND ID_ANHO = L_ID_ANHO AND ID_VENTA = P_ID_VENTA AND ID_CLIENTE = L_ID_PERSONA  --AND ID_TIPOVENTA = 1  
            GROUP BY ID_VENTA HAVING SUM(TOTAL)<>0;

            IF l_contar > 0 THEN 
                SELECT 
                        SUM(TOTAL) AS TOTAL,TIPO 
                        INTO STRICT L_SALDO, L_TIPO
                FROM VW_SALES_MOV
                WHERE ID_ENTIDAD = L_ID_ENTIDAD 
                AND ID_DEPTO = L_ID_DEPTO
                AND ID_CLIENTE = L_ID_PERSONA
                AND ID_ANHO = L_ID_ANHO
                --AND ID_TIPOVENTA = 1
                AND ID_VENTA = P_ID_VENTA
                GROUP BY ID_VENTA,TIPO
                HAVING SUM(TOTAL)<>0;

                IF P_DC = 'C' THEN
                    IF P_IMPORTE > L_SALDO THEN
                        l_contar :=1;
                        P_ERROR :=1;
                        L_MSN_ERROR:='El importe NO debe  ser  Mayor al saldo del Documento de referencia';
                    END IF;
                END IF;
                IF L_TIPO  = 'V' THEN
                    L_ID_VENTA := P_ID_VENTA;
                    L_ID_SALDO := NULL;
                    L_ID_TRANSFERENCIA_P := NULL;
                ELSE
                    IF L_TIPO  = 'S' THEN
                        L_ID_SALDO := P_ID_VENTA;
                        L_ID_VENTA := NULL;
                        L_ID_TRANSFERENCIA_P := NULL;
                    ELSE
                        L_ID_TRANSFERENCIA_P := P_ID_VENTA;
                        L_ID_SALDO := NULL;
                        L_ID_VENTA := NULL;
                    END IF;
                END IF;
            ELSE
                L_ID_VENTA := NULL;
                L_ID_SALDO := NULL;
            END IF;

            IF P_ERROR = 0 THEN 
                --SELECT COALESCE(MAX(ID_TDETALLE),0)+1 INTO l_cont FROM VENTA_TRANSFERENCIA_DETALLE;
                INSERT INTO VENTA_TRANSFERENCIA_DETALLE(ID_VENTA,ID_TRANSFERENCIA,DC,IMPORTE,ID_SALDO,DETALLE,ID_TRANSFERENCIA_P
                )VALUES (L_ID_VENTA,P_ID_TRANSFERENCIA,P_DC,P_IMPORTE,L_ID_SALDO,L_GLOSA,L_ID_TRANSFERENCIA_P);
                P_MSN_ERROR:='OK';
            ELSE
                P_ERROR :=1;
                P_MSN_ERROR:=L_MSN_ERROR;
            END IF;
           /* EXCEPTION
            WHEN OTHERS THEN
            P_ERROR :=2;
            P_MSN_ERROR:='ERROR INTERNO';*/
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_transferencia_detalle (P_ID_TRANSFERENCIA bigint,P_ID_VENTA bigint,P_IMPORTE text,P_DC text,P_DETALLE text,P_ERROR OUT bigint,P_MSN_ERROR OUT text) FROM PUBLIC;
