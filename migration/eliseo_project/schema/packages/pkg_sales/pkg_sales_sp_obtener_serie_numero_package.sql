-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_obtener_serie_numero (P_ID_PERSONA bigint,P_ID_COMPROBANTE text,P_ID_ENTIDAD bigint, P_ID_DEPTO text,P_ID_COMPROBANTE_AFECTO text, P_SERIE OUT text,P_NUMERO OUT bigint) AS $body$
DECLARE

        l_serie varchar(4):='-';
        l_numero bigint:=0;
        l_id_documento bigint;
        l_contar bigint;

BEGIN
            
	        
	        IF (P_ID_COMPROBANTE_AFECTO IS NOT NULL AND P_ID_COMPROBANTE_AFECTO::text <> '') THEN  -- AquÃ­ solo va a ingresar cuando es NOTA DE CREDITO/DEBITO
	        
	        	select count(1) into STRICT l_contar 
	            from CONTA_DOCUMENTO_IP a, CONTA_DOCUMENTO_IP_USER b, CONTA_DOCUMENTO c
	            where a.ID_DOCIP=b.ID_DOCIP
	            and a.id_documento=c.id_documento
	            and b.id=P_ID_PERSONA
	            and c.ID_ENTIDAD=P_ID_ENTIDAD
	            and c.ID_DEPTO=P_ID_DEPTO
	            AND c.ID_COMPROBANTE_AFECTO =P_ID_COMPROBANTE_AFECTO
	            and c.id_comprobante=P_ID_COMPROBANTE
                AND A.ESTADO=1;
	
	            if l_contar>0 then
	                select c.id_documento, c.serie,coalesce(c.contador,0) into STRICT l_id_documento,l_serie,l_numero 
	                from CONTA_DOCUMENTO_IP a, CONTA_DOCUMENTO_IP_USER b, CONTA_DOCUMENTO c
	                where a.ID_DOCIP=b.ID_DOCIP
	                and a.id_documento=c.id_documento
	                and b.id=P_ID_PERSONA
	                and c.ID_ENTIDAD=P_ID_ENTIDAD
	                and c.ID_DEPTO=P_ID_DEPTO
	                AND c.ID_COMPROBANTE_AFECTO =P_ID_COMPROBANTE_AFECTO
	                and c.id_comprobante=P_ID_COMPROBANTE
                    AND A.ESTADO=1;
	
	                update CONTA_DOCUMENTO set contador=contador+1
	                where id_documento=l_id_documento;
	
	                select serie,contador into STRICT l_serie,l_numero
	                from CONTA_DOCUMENTO 
	                where id_documento=l_id_documento;
	            end if;

	        ELSE 
	        	select count(*) into STRICT l_contar 
	            from CONTA_DOCUMENTO_IP a, CONTA_DOCUMENTO_IP_USER b, CONTA_DOCUMENTO c
	            where a.ID_DOCIP=b.ID_DOCIP
	            and a.id_documento=c.id_documento
	            and b.id=P_ID_PERSONA
	            and c.ID_ENTIDAD=P_ID_ENTIDAD
	            --and c.ID_DEPTO=P_ID_DEPTO
	            and c.id_comprobante=P_ID_COMPROBANTE
                AND A.ESTADO=1;
	
	            if l_contar>0 then
	                select c.id_documento, c.serie,coalesce(c.contador,0) into STRICT l_id_documento,l_serie,l_numero 
	                from CONTA_DOCUMENTO_IP a, CONTA_DOCUMENTO_IP_USER b, CONTA_DOCUMENTO c
	                where a.ID_DOCIP=b.ID_DOCIP
	                and a.id_documento=c.id_documento
	                and b.id=P_ID_PERSONA
	                and c.ID_ENTIDAD=P_ID_ENTIDAD
	                and c.ID_DEPTO=P_ID_DEPTO
	                and c.id_comprobante=P_ID_COMPROBANTE
                    AND A.ESTADO=1;
	
	                update CONTA_DOCUMENTO set contador=contador+1
	                where id_documento=l_id_documento;
	
	                select serie,contador into STRICT l_serie,l_numero
	                from CONTA_DOCUMENTO 
	                where id_documento=l_id_documento;
	            end if;
	
	        END IF;
        P_SERIE:=l_serie;
        P_NUMERO:=l_numero;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_obtener_serie_numero (P_ID_PERSONA bigint,P_ID_COMPROBANTE text,P_ID_ENTIDAD bigint, P_ID_DEPTO text,P_ID_COMPROBANTE_AFECTO text, P_SERIE OUT text,P_NUMERO OUT bigint) FROM PUBLIC;
