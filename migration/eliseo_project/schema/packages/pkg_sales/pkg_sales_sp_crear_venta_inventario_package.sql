-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_venta_inventario (P_ID_PERSONA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint,P_ES_AUTOENTREGA bigint,P_ID_VENTA OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        --l_cont numeric;	
        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda_tc bigint;
        l_automatico varchar(2);
        l_id_voucher bigint;
        l_contar bigint;
        l_id_tipotransaccion bigint :=5;--ventas de almacen por defecto regustra y configurar solo un asiento por lamacen
        L_DOCUMENTO bigint :=0;

        L_ID_VENTA bigint;
        L_ERROR bigint;
        L_MSGERROR varchar(100) :='';

BEGIN
            L_ERROR := 0;
            /*DELETE VENTA_ASIENTO
            WHERE ID_VENTA IN (
                SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE = P_ID_COMPROBANTE AND ESTADO = '0'
            );
            DELETE VENTA_DETALLE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE = P_ID_COMPROBANTE AND ESTADO = 0);
            DELETE VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE = P_ID_COMPROBANTE AND ESTADO = 0;
            */
    
            --SELECT COALESCE(MAX(ID_VENTA),0)+1 INTO l_cont FROM VENTA;
            l_id_moneda_tc:=9;

            --obtiene IGV de la fecha actual
            select FC_IGV(CURRENT_DATE ) into STRICT l_igv;

            --obtiene tipo de cambio del dia
            select FC_TIPOCAMBIO(l_id_moneda_tc,CURRENT_DATE,'D' ) into STRICT l_tc;

            if coalesce(l_tc::text, '') = '' then
                l_tc:=0;
            end if;

            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,P_ID_COMPROBANTE,P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                L_ERROR :=1;
                L_MSGERROR := 'Alto! El usuario no tiene asignado un punto de impresi√≥n para el tipo de documento: ' || P_ID_COMPROBANTE;
--                 GOTO salida_rapida;
            END IF;
            
            IF L_ERROR = 0 THEN 
            
                INSERT INTO VENTA(ID_PERSONA,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_COMPROBANTE,ID_IGV,ID_MONEDA,
                ID_LEYENDA,TIPOCAMBIO,ID_TIPOTRANSACCION,SERIE,NUMERO,FECHA,ESTADO,ES_AUTOENTREGA)
                VALUES (P_ID_PERSONA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,P_ID_COMPROBANTE,l_igv,P_ID_MONEDA,
                '1000',l_tc,l_id_tipotransaccion,'-','-',clock_timestamp(),0, P_ES_AUTOENTREGA) RETURNING ID_VENTA INTO L_ID_VENTA;

            END IF;

--         <<salida_rapida>>
        
        P_ID_VENTA := L_ID_VENTA;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_venta_inventario (P_ID_PERSONA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint,P_ES_AUTOENTREGA bigint,P_ID_VENTA OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
