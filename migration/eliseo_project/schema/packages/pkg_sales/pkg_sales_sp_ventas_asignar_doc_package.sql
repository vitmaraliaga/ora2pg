-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_ventas_asignar_doc (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_CLIENTE bigint,P_ORIGEN bigint,P_ID_OPERACION bigint,P_IMPORTE bigint,P_DC text) AS $body$
DECLARE

        L_ID_VENTA bigint;
        L_TOTAL decimal(10,2);
        L_PAGO decimal(10,2);
        L_MONTO decimal(10,2);
        L_DETALLE varchar(100) :='TRANSFERENCIA QUE AFECTAN A VENTAS'; --VENTAS
        L_ERROR bigint;
        L_MSN_ERROR varchar(100);

        VENTAS_PENDIENTES CURSOR FOR	
        SELECT 
        ID_VENTA,TOTAL --,TOTAL_ME, 'D' AS DC
        FROM VW_SALES_SALDO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_CLIENTE = P_ID_CLIENTE
        ORDER BY ID_VENTA,SERIE,NUMERO;
        	

BEGIN  
        L_MONTO := P_IMPORTE;
        L_ERROR :=0;
        L_MSN_ERROR := 'OK';
        OPEN VENTAS_PENDIENTES;
          FETCH VENTAS_PENDIENTES INTO L_ID_VENTA,L_TOTAL;
            WHILE VENTAS_PENDIENTES%FOUND LOOP
                WHILE L_MONTO > 0 AND L_TOTAL > 0 LOOP
                    IF P_DC = 'C' THEN
                        IF L_TOTAL >= L_MONTO THEN
                            L_PAGO := L_MONTO;
                            L_MONTO :=0;
                            L_TOTAL :=0;
                        ELSE
                            L_PAGO := L_TOTAL;
                            L_MONTO := L_MONTO-L_TOTAL;
                            L_TOTAL := L_TOTAL-L_MONTO;
                        END IF;
                    ELSE
                        L_PAGO := L_MONTO;
                        L_MONTO :=0;
                    END IF;
                    IF P_ORIGEN = 2 THEN  --TRANSFERENCIA DE VENTAS
                        CALL pkg_sales_sp_crear_transferencia_detalle(P_ID_OPERACION,L_ID_VENTA,L_PAGO,P_DC,L_DETALLE,L_ERROR,L_MSN_ERROR);
                    END IF;
                END LOOP;

                FETCH VENTAS_PENDIENTES INTO L_ID_VENTA,L_TOTAL;
            END LOOP;
        CLOSE VENTAS_PENDIENTES;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_ventas_asignar_doc (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_CLIENTE bigint,P_ORIGEN bigint,P_ID_OPERACION bigint,P_IMPORTE bigint,P_DC text) FROM PUBLIC;
