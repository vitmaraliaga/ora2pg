-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_generar_asiento (P_ID_VENTA bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_id_vdetalle bigint;
        l_dinamica bigint;
        l_asiento bigint;
        l_detalle varchar(400);
        l_base decimal(10,2);
        l_igv decimal(10,2);
        l_descuento decimal(10,2);
        l_importe decimal(10,2);
        l_precio_alm decimal(10,2);
        l_ctas varchar(200);
        l_deptos varchar(200);
        l_ctates varchar(200);

        l_actas tablastring;
        l_adeptos tablastring;
        l_actates tablastring;

        l_id_asiento bigint;
        l_id_parent bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_destino varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);

        l_id_asientod bigint;
        l_id_tipopland bigint;
        l_id_restricciond varchar(50);
        l_id_cuentaaasid varchar(10);
        l_dcd varchar(1);
        l_id_indicadord  varchar(35);
        l_unicod varchar(1);
        l_porcentajed decimal(10,2);
        l_unicoctated varchar(1);

        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_fondo varchar(10);
        l_importeasiento decimal(10,2);
        l_importeasiento_me decimal(10,2);
        l_descripcion varchar(255);
        l_memo varchar(255);
        l_voucher bigint;
        --l_ref_id varchar(100);
        l_id_entidad bigint;
        l_id_depto_venta varchar(20);
        l_buscar bigint;

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_tipoorigen bigint;

        --validacion
        l_contar bigint;
        l_debito decimal(10,2);
        l_credito decimal(10,2);
        l_cont bigint;
        l_serie varchar(5);
        l_numero varchar(15);
        l_fecha timestamp(0);
        l_agrupa varchar(1);
        l_primario varchar(1);
        l_id_cliente bigint;
        l_id_tipoigv varchar(2);
        l_otros_cargos decimal(10,2);
        l_id_comprobante varchar(2);
        L_ID_ANHO bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        l_depto_asi varchar(10);
        cdet CURSOR FOR		
        SELECT  ID_VDETALLE,ID_ARTICULO,ID_DINAMICA,ID_TIPOORIGEN, DETALLE,BASE+coalesce(DESCUENTO,0),IGV,DESCUENTO,IMPORTE,coalesce(CANTIDAD,1)*PRECIO_ALM,ID_TIPOIGV,coalesce(OTROS_CARGOS,0),
        BASE_ME+coalesce(DESCUENTO_ME,0),IGV_ME,DESCUENTO_ME,IMPORTE_ME,coalesce(CANTIDAD,1)*PRECIO_ALM_ME,coalesce(OTROS_CARGOS_ME,0),ID_DEPTO_ASI
        FROM VENTA_DETALLE
        WHERE ID_VENTA=P_ID_VENTA
        ORDER BY ID_VDETALLE;	

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,--a.DC,
        (CASE  WHEN l_id_comprobante = '07' AND a.DC = 'C' THEN 'D' WHEN l_id_comprobante = '07' AND a.DC = 'D' THEN 'C' 
        ELSE a.DC END) AS DC,
        a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA, a.primario
        FROM CONTA_DINAMICA_ASIENTO a,CONTA_DINAMICA d
        WHERE a.ID_DINAMICA=d.ID_DINAMICA 
        --AND coalesce(d.ID_PARENT,0)=0
        AND a.ID_DINAMICA =l_dinamica
        AND a.activo = 'S'
        --AND COALESCE(a.ID_PARENT,0)=0 
        ORDER BY a.NRO_ASIENTO,a.ID_ASIENTO,a.DC desc; -- ESTE ORDEN es clave para que se orden los asientos
        casides CURSOR FOR		
        SELECT ID_ASIENTO,ID_TIPOPLAN,ID_RESTRICCION,ID_CUENTAAASI,DC,ID_INDICADOR,UNICO,UNICO_CTACTE,PORCENTAJE,NOMBRE,AGRUPA, PRIMARIO 
        FROM CONTA_DINAMICA_ASIENTO
        WHERE ID_PARENT=l_asiento
        ORDER BY NRO_ASIENTO,DC desc;

        l_base_me decimal(10,2);
        l_igv_me decimal(10,2);
        l_descuento_me decimal(10,2);
        l_importe_me decimal(10,2);
        l_precio_alm_me decimal(10,2);
        l_otros_cargos_me decimal(10,2);

     
BEGIN
     
     
      l_fondo:='10';
     --OBTIENE DATOS DE LA VENTA
      select ID_ENTIDAD,ID_DEPTO,ID_VOUCHER,ID_COMPROBANTE,SERIE, case when NUMERO='-' then NUMERO else (NUMERO)::numeric ::text end,FECHA,ID_CLIENTE
      --,ID_TIPOORIGEN
                into STRICT l_id_entidad,l_id_depto_venta, l_voucher,l_id_comprobante,l_serie,l_numero,l_fecha,l_id_cliente
                --, l_id_tipoorigen 
      from VENTA where ID_VENTA=P_ID_VENTA;

        SELECT DISTINCT A.ID_ANHO,B.ID_ALMACEN INTO STRICT L_ID_ANHO, L_ID_ALMACEN
        FROM VENTA A JOIN VENTA_DETALLE B ON A.ID_VENTA = B.ID_VENTA WHERE A.ID_VENTA = P_ID_VENTA;


     --DETALLE
      OPEN cdet;
      FETCH cdet INTO l_id_vdetalle,L_ID_ARTICULO, l_dinamica,l_id_tipoorigen, l_detalle,l_base,l_igv,l_descuento,l_importe,l_precio_alm,l_id_tipoigv,l_otros_cargos,l_base_me,l_igv_me,l_descuento_me,l_importe_me,l_precio_alm_me,l_otros_cargos_me,l_depto_asi;

      WHILE cdet%FOUND LOOP

            SELECT (l_id_tipoorigen::text || '-' || l_id_vdetalle::text) INTO STRICT l_memo;

            ---DENAMICA ASIENTO
            OPEN casi;
            FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,
                l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_primario;
            WHILE casi%FOUND LOOP

                select (case when l_id_indicador='COSTO_ALM' then l_precio_alm
                            when l_id_indicador='BASE' then l_base
                            when l_id_indicador='IGV' then l_igv
                            when l_id_indicador='DESCUENTO' then l_descuento
                            when l_id_indicador='IMPORTE' then l_importe
                            when l_id_indicador='PRECIO_TOTAL' then l_importe
                            when l_id_indicador='ICBPER' then l_otros_cargos
                      else 0 end)*(l_porcentaje)  into STRICT l_importeasiento
;
                select (case when l_id_indicador='COSTO_ALM' then l_precio_alm_me
                            when l_id_indicador='BASE' then l_base_me
                            when l_id_indicador='IGV' then l_igv_me
                            when l_id_indicador='DESCUENTO' then l_descuento_me
                            when l_id_indicador='IMPORTE' then l_importe_me
                            when l_id_indicador='PRECIO_TOTAL' then l_importe_me
                            when l_id_indicador='ICBPER' then l_otros_cargos_me
                      else 0 end)*(l_porcentaje)  into STRICT l_importeasiento_me
;

                if l_id_indicador = 'COSTO_ALM' and l_dc = 'C' then
                    l_descripcion := l_descripcion||'-'||l_detalle;
                end if;

                l_depto:=null;
                l_cuenta_cte:=null;

                if l_unico='U' then
                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                elsif (l_unico='M') then
                   SELECT position('|' in l_deptos) into STRICT l_buscar;
                   if l_buscar>0 then
                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                     select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                     select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasi) into STRICT l_depto;
                   else
                    l_depto:=l_deptos;
                   end if;
                elsif (l_unico='X') then
                   select FC_DEPTO_CLIENTE(l_id_cliente) into STRICT l_depto;
                elsif (l_unico='E') then
                   SELECT eliseo.FC_DEPTO_ALUMNO(l_id_cliente, l_id_depto_venta) into STRICT l_depto;
                elsif (l_unico='G') then
                   SELECT eliseo.FC_DEPTO_ALUMNO_ESCUELA(l_id_cliente, l_id_depto_venta) into STRICT l_depto;
                elsif l_unico='P' THEN
                   l_depto := l_depto_asi;
                elsif l_unico='S' THEN  -- Si es sesiÃ³n
                    l_depto := l_id_depto_venta;---
                end if;

                if l_unicoctate='U' then
                  select  count(1) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                  if l_cont>0 then
                    if l_id_tipoigv = '10' and l_id_indicador = 'BASE' then  --GARVADA = CTA_CTE = 4 (10) - bazar
                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                    elsif l_id_tipoigv = '20' and l_id_indicador = 'BASE' then  --EXONERAD = CTA_CTE = 5 (20) -bazar
                        l_cuenta_cte := '5';
                    elsif l_id_tipoigv = '30' and l_id_indicador = 'BASE' then  --INAFECTA = CTA_CTE = 1 (30) -bazar
                        l_cuenta_cte := '1';
                    else
                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                    end if;
                  end if;
                elsif (l_unicoctate='M') then
                   SELECT position('|' in l_ctates) into STRICT l_buscar;
                   if l_buscar>0 then
                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                     select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                     select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                   else
                    l_cuenta_cte:=l_ctates;
                   end if;
                elsif (l_unicoctate='X') then
                    IF l_id_entidad = 9415 THEN  -- ENTIDAD ACES PERU
                        IF l_id_comprobante = '01' THEN   --RUC
                            SELECT MAX(RUC) into STRICT l_cuenta_cte FROM (
                                SELECT ID_RUC AS RUC FROM MOISES.VW_PERSONA_JURIDICA WHERE ID_PERSONA=l_id_cliente

UNION ALL

                                SELECT NUM_DOCUMENTO AS RUC FROM MOISES.VW_PERSONA_NATURAL WHERE ID_PERSONA=l_id_cliente AND ID_TIPODOCUMENTO = 6
                            ) alias2;
                        ELSIF l_id_comprobante = '03' THEN  --DNI
                            SELECT NUM_DOCUMENTO into STRICT l_cuenta_cte FROM MOISES.VW_PERSONA_NATURAL WHERE ID_PERSONA=l_id_cliente AND ID_TIPODOCUMENTO NOT IN (6, 97, 98);
                        END IF;
                    ELSE
                        select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente;
                    END IF;
                elsif (l_unicoctate = 'A') then
                    SELECT ID_CTACTE INTO STRICT l_cuenta_cte
                    FROM INVENTARIO_ALMACEN_ARTICULO WHERE ID_ALMACEN = L_ID_ALMACEN AND ID_ARTICULO = L_ID_ARTICULO AND ID_ANHO = L_ID_ANHO;
                end if;

                if l_dc='C' then
                  l_importeasiento:=l_importeasiento*(-1);
                  l_importeasiento_me:=l_importeasiento_me*(-1);
                end if;

                
                select count(1) into STRICT l_cont from CONTA_ASIENTO
                where ID_TIPOORIGEN=l_id_tipoorigen
                and ID_ORIGEN=l_id_vdetalle
                and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                and CUENTA =l_id_cuentaaasi
                and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                and case when importe>0 then 'D' else 'C' end=l_dc;

                if l_importeasiento<>0 then

                  if l_cont=0 then
                    INSERT INTO CONTA_ASIENTO(
                    ID_TIPOORIGEN,
                    ID_ORIGEN, 
                    FONDO,
                    DEPTO,
                    CUENTA, 
                    CUENTA_CTE,
                    RESTRICCION,
                    IMPORTE,
                    DESCRIPCION,
                    MEMO,
                    VOUCHER, 
                    PARENT_ID,
                    --REF_ID,
                    AGRUPA,
                    PRIMARIO,
                    IMPORTE_ME
                    )VALUES ( 
                    l_id_tipoorigen,
                    l_id_vdetalle,
                    l_fondo,
                    l_depto,
                    l_id_cuentaaasi,
                    l_cuenta_cte,
                    l_id_restriccion,
                    l_importeasiento,
                    '(Doc: '||l_serie||'-'||l_numero||')-'||l_descripcion,
                    l_memo,
                    l_voucher,
                    null,
                    --l_ref_id,
                    l_agrupa,
                    l_primario,
                    l_importeasiento_me
                    );
                  else
                    l_msgerror:='';
                    /*update CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                    where ID_TIPOORIGEN=l_id_tipoorigen
                    and ID_ORIGEN=l_id_vdetalle
                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                    and CUENTA =l_id_cuentaaasi
                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                    and case when importe>0 then 'D' else 'C' end=l_dc;*/
                  end if;
                end if;
                  --DESTINO
                  OPEN casides;
                  FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,
                  l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_primario;
                  WHILE casides%FOUND LOOP

                  
                    select (case when l_id_indicadord='COSTO_ALM' then l_precio_alm
                              when l_id_indicadord='BASE' then l_base
                              when l_id_indicadord='IGV' then l_igv
                              when l_id_indicadord='DESCUENTO' then l_descuento
                              when l_id_indicadord='IMPORTE' then l_importe
                        else 0 end)*(l_porcentaje)  into STRICT l_importeasiento
;

                    select (case when l_id_indicadord='COSTO_ALM' then l_precio_alm_me
                              when l_id_indicadord='BASE' then l_base_me
                              when l_id_indicadord='IGV' then l_igv_me
                              when l_id_indicadord='DESCUENTO' then l_descuento_me
                              when l_id_indicadord='IMPORTE' then l_importe_me
                        else 0 end)*(l_porcentaje)  into STRICT l_importeasiento_me
;

                    l_depto:=null;
                    l_cuenta_cte:=null;

                    if l_unicod='U' then
                      select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                    elsif (l_unicod='M') then
                       SELECT position('|' in l_deptos) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasid) into STRICT l_depto;
                       else
                        l_depto:=l_deptos;
                       end if;
                    elsif (l_unicod='X') then
                       select FC_DEPTO_CLIENTE(l_id_cliente) into STRICT l_depto;
                    end if;

                    if l_unicoctated='U' then
                      select  count(1) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                      if l_cont>0 then
                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                      end if;

                    elsif (l_unicoctated='M') then
                       SELECT position('|' in l_ctates) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasid) into STRICT l_cuenta_cte;
                       else
                        l_cuenta_cte:=l_ctates;
                       end if;
                    elsif (l_unicoctated='X') then
                      select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente;
                    elsif (l_unicoctated='A') then
                        SELECT ID_CTACTE INTO STRICT l_cuenta_cte
                        FROM INVENTARIO_ALMACEN_ARTICULO WHERE ID_ALMACEN = L_ID_ALMACEN AND ID_ARTICULO = L_ID_ARTICULO AND ID_ANHO = L_ID_ANHO;
                    end if;

                    if l_dc='C' then
                      l_importeasiento:=l_importeasiento*(-1);
                      l_importeasiento_me:=l_importeasiento_me*(-1);
                    end if;
                    if l_importeasiento<>0 then

                      select count(1) into STRICT l_cont from CONTA_ASIENTO
                      where ID_TIPOORIGEN=l_id_tipoorigen
                      and ID_ORIGEN=l_id_vdetalle
                      and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                      and CUENTA =l_id_cuentaaasid
                      and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                      and case when importe>0 then 'D' else 'C' end=l_dc;

                      
                                      
                    
                      IF l_agrupa='S' and l_cont>0 THEN
                        /*update  CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                        where ID_TIPOORIGEN=l_id_tipoorigen
                        and ID_ORIGEN=l_id_vdetalle
                        and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                        and CUENTA =l_id_cuentaaasid
                        and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                        and case when importe>0 then 'D' else 'C' end=l_dc;*/
                        l_msgerror:='';
                      ELSE
                        INSERT INTO CONTA_ASIENTO(
                        ID_TIPOORIGEN,
                        ID_ORIGEN,
                        FONDO,
                        DEPTO,
                        CUENTA, 
                        CUENTA_CTE,
                        RESTRICCION,
                        IMPORTE,
                        DESCRIPCION,
                        MEMO,
                        VOUCHER, 
                        PARENT_ID,
                        IMPORTE_ME
                        --REF_ID
                        )VALUES ( 
                        l_id_tipoorigen,
                        l_id_vdetalle,
                        l_fondo,
                        l_depto,
                        l_id_cuentaaasi,
                        l_cuenta_cte,
                        l_id_restriccion,
                        l_importeasiento,
                        case when l_agrupa='N' then  l_detalle||' - (Doc: '||l_serie||'-'||l_numero||')-'||to_char(l_fecha,'DD/MM/YYYY') else l_descripcion||' - (Doc: '||l_serie||'-'||l_numero||')-'||FC_MES_NAME(to_char(l_fecha,'MM')) end,
                        l_memo,
                        l_voucher,
                        null,
                        l_importeasiento_me
                        --l_ref_id 
                        );
                      END IF;

                      
                    end if;
                    FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,
                    l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_primario;
                  END LOOP;
                  CLOSE casides;
                
                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,
                l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_primario;

              END LOOP;
              CLOSE casi;

            FETCH cdet INTO l_id_vdetalle,L_ID_ARTICULO,l_dinamica,l_id_tipoorigen, l_detalle,l_base,l_igv,l_descuento,l_importe,l_precio_alm,l_id_tipoigv,l_otros_cargos,l_base_me,l_igv_me,l_descuento_me,l_importe_me,l_precio_alm_me,l_otros_cargos_me,l_depto_asi;

        END LOOP;
        CLOSE cdet;
        
        
        SELECT COUNT(1) INTO STRICT l_contar 
        FROM CONTA_ASIENTO
        WHERE ID_TIPOORIGEN=L_ID_TIPOORIGEN
        AND ID_ORIGEN IN (SELECT ID_VDETALLE FROM VENTA_DETALLE WHERE ID_VENTA = P_ID_VENTA);
        --ANALIZAR UREGTNE
        if l_contar=0 then
          l_error:=3; --no se ha generado el asiento
          l_msgerror:='ASIENTO VENTA: No se ha generado el asiento';
        else
          select COALESCE(sum(case when IMPORTE>0 then IMPORTE else 0 end),0) as debito,
           COALESCE(sum(case when IMPORTE<0 then IMPORTE*(-1) else 0 end),0) as credito
           into STRICT l_debito,l_credito
          from CONTA_ASIENTO
          where ID_TIPOORIGEN=l_id_tipoorigen
          and ID_ORIGEN IN (SELECT ID_VDETALLE FROM VENTA_DETALLE WHERE ID_VENTA = P_ID_VENTA);

          if l_credito=0 or l_debito=0 then
             l_error:=4; --importe de debito o credito igual a cero
             l_msgerror:='ASIENTO VENTA: Importe de debito o credito igual a cero '||l_credito||'-'||l_debito;
          else
             if l_credito<>l_credito then
              l_error:=5; --descuadre de asiento
              l_msgerror:='ASIENTO VENTA: Descuadre de asiento';
             end if;
          end if;

        end if;

        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

     END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_generar_asiento (P_ID_VENTA bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
