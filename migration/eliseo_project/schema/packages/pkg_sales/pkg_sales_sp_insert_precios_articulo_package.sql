-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_insert_precios_articulo (P_ID_ALMACEN bigint,P_ID_ANHO bigint,P_ID_ARTICULO bigint, P_PRECIO bigint, P_DESCUENTO bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        L_BI decimal(10,2);
        L_IGV decimal(10,2);
        LIGVB decimal(10,2);

        
BEGIN
            
            SELECT 
                    round((ID_IGV/100)::numeric,2) IGV,1+round((ID_IGV/100)::numeric,2) IGVB INTO STRICT L_IGV,LIGVB
            FROM CONTA_IGV
            WHERE TO_DATE(clock_timestamp()) BETWEEN FECHA_INI AND coalesce(FECHA_FIN,TO_DATE(clock_timestamp())) 
            AND ES_VENTA = 'S';

            SELECT CASE WHEN B.ID_TIPOIGV=10 THEN LIGVB  ELSE 1 END  INTO STRICT L_BI
            FROM INVENTARIO_ARTICULO A, INVENTARIO_ALMACEN_ARTICULO B
            WHERE A.ID_ARTICULO = B.ID_ARTICULO
            AND B.ID_ALMACEN = P_ID_ALMACEN
            AND B.ID_ANHO = P_ID_ANHO
            AND B.ID_ARTICULO = P_ID_ARTICULO
            AND B.ESTADO = '1';

            /*UPDATE VENTA_PRECIO SET COSTO = ROUND(P_PRECIO/L_BI,2),
                                    DESCUENTO = P_DESCUENTO,
                                    PRECIO = P_PRECIO
            WHERE ID_ALMACEN = P_ID_ALMACEN
            AND ID_ARTICULO = P_ID_ARTICULO
            AND ID_ANHO = P_ID_ANHO;*/
            
            --PROCEDIMIENTO QUE INSERTO Y/O ATUALIZA LA POITICA GENERAL Y LAS OTRAS, NO BEERIA PERO A PEDIDO DEL USER
            CALL pkg_sales_sp_insert_precios_all(P_ID_ALMACEN,P_ID_ANHO,P_ID_ARTICULO, P_PRECIO, P_DESCUENTO);

            P_ERROR:=0;
            P_MSGERROR:= 'OK';
            EXCEPTION
                WHEN no_data_found THEN
                    P_ERROR:=1;
                    P_MSGERROR:='NO SE HA ACTUALIZADO EL PRECIO';

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_insert_precios_articulo (P_ID_ALMACEN bigint,P_ID_ANHO bigint,P_ID_ARTICULO bigint, P_PRECIO bigint, P_DESCUENTO bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
