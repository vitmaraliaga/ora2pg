-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_serv_creact_venta_detalle (P_ID_VENTA bigint,P_ID_SERVICIO bigint,P_CANTIDAD bigint,P_ID_VDETALLE INOUT bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        l_contar bigint;
        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda bigint;
        l_precio_servicio decimal(10,2);
        l_id_tipoigv varchar(2);
        l_id_articulo bigint;
        l_id_dinamica bigint;
        l_glosa varchar(50) :='';
        l_gravado varchar(2);
        l_igv_item decimal(10,2);

        l_precio decimal(10,2);

        l_precio_base decimal(10,2);
        l_base decimal(10,2);
        l_descuento decimal(10,2):=0;
        l_totaldescuento decimal(10,2):=0;
        l_importe decimal(10,2);

        l_precio_me decimal(10,2);
        l_igv_me decimal(10,2);
        l_precio_base_me decimal(10,2);
        l_precio_alm_me decimal(10,2);
        l_base_me decimal(10,2);
        l_descuento_me decimal(10,2);
        l_importe_me decimal(10,2);

        L_ID_VDETALLE bigint :=0;
        L_ERROR bigint :=0;
        L_MSGERROR varchar(100) :='';

BEGIN
        --L_ERROR := 1;
        --L_MSGERROR := 'HOLA DETALLE';
        select ID_IGV,TIPOCAMBIO,ID_MONEDA into STRICT l_igv,l_tc,l_id_moneda from VENTA where id_venta=P_ID_VENTA;
        select COALESCE(PRECIO,0), ID_TIPOIGV, ID_ARTICULO, ID_DINAMICA, SUBSTR(GLOSA, 0,50)
                into STRICT l_precio_servicio, l_id_tipoigv, l_id_articulo, l_id_dinamica, l_glosa from CAJA_SERVICIO where ID_SERVICIO=P_ID_SERVICIO;

        select count(*) into STRICT l_contar from TIPO_IGV where ID_TIPOIGV=l_id_tipoigv;
        if l_contar>0 then
            select GRAVADO into STRICT l_gravado from TIPO_IGV where ID_TIPOIGV=l_id_tipoigv;
        end if;
        l_igv:=l_igv/100;
        l_totaldescuento:=l_descuento*P_CANTIDAD;
        l_precio:=l_precio_servicio;
        l_importe:=(l_precio_servicio*P_CANTIDAD)-(l_totaldescuento);
        --l_precio_alm:=l_precio_alm;
        l_precio_base:=l_precio_servicio;
        l_base:=l_importe;
        l_igv_item:=0;
        if l_gravado in ('G') then
            l_precio_base:=l_precio_servicio/(1+l_igv);
            l_base:=l_importe/(1+l_igv);
            l_igv_item:=l_importe-l_base;
        end if;

        l_descuento:=l_totaldescuento;
        l_precio_me:=0;
        l_precio_base_me:=0;
        l_precio_alm_me:=0;
        l_base_me:=0;
        l_igv_me:=0;
        l_descuento_me:=0;
        l_importe_me:=0;
        
        if l_id_moneda=9 then
            l_totaldescuento:=l_descuento*P_CANTIDAD;
            l_totaldescuento:=l_totaldescuento/l_tc;
            l_precio_me:=l_precio/l_tc;
            l_precio_base_me:=l_precio_base/l_tc;
            l_importe_me:=l_importe/l_tc;
            --l_precio_alm_me:=l_precio_alm/l_tc;
            l_base_me:=l_base/l_tc;
            l_igv_me:=l_igv_item/l_tc;

            l_descuento_me:=l_totaldescuento;
        end if;

        --L_ERROR := 1;
        --L_MSGERROR := l_id_tipoigv;
        IF L_ERROR = 0 THEN
            IF P_ID_VDETALLE = 0 THEN
                INSERT INTO VENTA_DETALLE(
                    -- ID_VDETALLE,
                    ID_VENTA,
                    ID_TIPOIGV,
                    ID_ARTICULO,
                    ID_ALMACEN,
                    ID_DINAMICA,
                    DETALLE, 
                    CANTIDAD, 
                    PRECIO, 
                    PRECIO_BASE, 
                    --PRECIO_ALM, 
                    BASE, 
                    IGV, 
                    DESCUENTO, 
                    IMPORTE, 
                    PRECIO_ME, 
                    PRECIO_BASE_ME, 
                    --PRECIO_ALM_ME, 
                    BASE_ME, 
                    IGV_ME, 
                    DESCUENTO_ME, 
                    IMPORTE_ME
                    )VALUES (
                    --l_cont,
                    P_ID_VENTA,
                    l_id_tipoigv,
                    l_id_articulo,
                   --case when P_ID_ALMACEN=0 then null else P_ID_ALMACEN end ,
                    NULL,
                    l_id_dinamica,
                    l_glosa,
                    P_CANTIDAD,
                    l_precio,
                    l_precio_base,
                    --l_precio_alm,
                    l_base,
                    l_igv_item,
                    l_descuento,
                    l_importe,
                    l_precio_me,
                    l_precio_base_me,
                    --l_precio_alm_me,
                    l_base_me,
                    l_igv_me,
                    l_descuento_me,
                    l_importe_me
                    );
                    SELECT coalesce(MAX(ID_VDETALLE),0) INTO STRICT L_ID_VDETALLE FROM VENTA_DETALLE;
                    -- ACTUALIZAR TOTAL DE VENTA.
                    CALL pkg_sales_sp_actualizar_total_venta(P_ID_VENTA);
            ELSE
                L_ID_VDETALLE := P_ID_VDETALLE;
            END IF;
        END IF;

        P_ID_VDETALLE := L_ID_VDETALLE;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_serv_creact_venta_detalle (P_ID_VENTA bigint,P_ID_SERVICIO bigint,P_CANTIDAD bigint,P_ID_VDETALLE INOUT bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
