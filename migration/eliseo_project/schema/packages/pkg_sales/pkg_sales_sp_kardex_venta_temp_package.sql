-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_kardex_venta_temp (P_ID_VENTA bigint) AS $body$
DECLARE

        L_ID_VENTA bigint;
        L_FECHA timestamp(0);
        L_ERROR bigint;
        L_MSGERROR varchar(200);

        /*CURSOR ventas IS	
        SELECT 
            A.ID_VENTA,A.FECHA
        FROM VENTA A JOIN VENTA_DETALLE B
        ON A.ID_VENTA = B.ID_VENTA
        --AND A.ID_VENTA = P_ID_VENTA
        AND B.ID_VDETALLE NOT IN (SELECT ID_ORIGEN FROM INVENTARIO_KARDEX WHERE ID_ANHO = 2019 AND ID_ALMACEN = 22 AND ID_TIPOORIGEN = 1)
        AND A.ESTADO = '1'
        --AND TO_CHAR(A.FECHA,'DDMMYYYY') = '15112019'
        GROUP BY A.ID_VENTA,A.FECHA
        ORDER BY A.ID_VENTA;

    BEGIN   
        OPEN ventas;
          FETCH ventas INTO L_ID_VENTA, L_FECHA;
            WHILE ventas%FOUND LOOP
                pkg_sales_sp_kardex_venta(L_ID_VENTA);
                
                UPDATE INVENTARIO_KARDEX SET FECHA = (SELECT A.FECHA FROM VENTA A WHERE ID_VENTA = L_ID_VENTA)
                WHERE ID_ANHO = 2019
                AND ID_ALMACEN = 22
                AND ID_TIPOORIGEN = 1
                AND ID_ORIGEN IN (SELECT ID_VDETALLE FROM VENTA_DETALLE WHERE ID_VENTA = L_ID_VENTA);
                
                FETCH ventas INTO L_ID_VENTA,L_FECHA;
            END LOOP;
        CLOSE ventas;*/
        
        ventas CURSOR FOR	
        SELECT A.ID_VENTA FROM VENTA A JOIN VENTA_DETALLE B
        ON A.ID_VENTA = B.ID_VENTA
        WHERE A.ID_ENTIDAD = 7124
        --AND A.ID_VENTA = P_ID_VENTA
        AND B.ID_VDETALLE NOT IN (SELECT ID_ORIGEN FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = 1 ) 
        GROUP BY A.ID_VENTA
        ORDER BY A.ID_VENTA;


BEGIN   
        OPEN ventas;
          FETCH ventas INTO L_ID_VENTA;
            WHILE ventas%FOUND LOOP
                CALL pkg_sales_sp_generar_asiento(L_ID_VENTA, L_ERROR,L_MSGERROR);

                FETCH ventas INTO L_ID_VENTA;
            END LOOP;
        CLOSE ventas;

        
            
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_kardex_venta_temp (P_ID_VENTA bigint) FROM PUBLIC;
