-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_venta_fa (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint,P_ID_SUCURSAL bigint,P_ID_CLIENTE_LEGAL bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint, P_AGRUPADO text,P_GLOSA text,P_ID_TIPOVENTA bigint,P_ID_VENTA OUT bigint,P_ERROR OUT bigint,P_MSN OUT text) AS $body$
DECLARE

        L_ID_VENTA bigint;
        L_IGV decimal(10,2);
        L_TC decimal(10,3);
        L_CONTAR bigint;
        L_DOCUMENTO bigint :=0;
        L_ID_CLIENTE_LEGAL bigint;
        L_ID_SUCURSAL bigint;

        
BEGIN
            P_ERROR :=0;
            DELETE FROM VENTA_ASIENTO WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
            DELETE FROM VENTA_DETALLE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
            DELETE FROM VENTA_FILE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
            DELETE FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0;

            -- Obtiene IGV de la fecha actual
            SELECT FC_IGV(CURRENT_DATE ) INTO STRICT L_IGV;

            -- Obtiene tipo de cambio del dia
            SELECT FC_TIPOCAMBIO(P_ID_MONEDA,CURRENT_DATE,'D' ) INTO STRICT L_TC;

            IF coalesce(L_TC::text, '') = '' THEN
                L_TC:=0;
            END IF;

            
            IF coalesce(P_ID_SUCURSAL::text, '') = '' OR P_ID_SUCURSAL = 0 THEN
                L_ID_SUCURSAL := NULL;
            ELSE
                L_ID_SUCURSAL:=P_ID_SUCURSAL;
            END IF;
            IF coalesce(P_ID_CLIENTE_LEGAL::text, '') = '' OR P_ID_CLIENTE_LEGAL = 0 THEN
                L_ID_CLIENTE_LEGAL := NULL;
            ELSE
                L_ID_CLIENTE_LEGAL := P_ID_CLIENTE_LEGAL;
            END IF;
            --SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,'03',P_ID_ENTIDAD,P_ID_DEPTO) INTO L_DOCUMENTO FROM DUAL;
            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,P_ID_COMPROBANTE,P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                P_ERROR :=1;
                P_MSN := 'Elija Documento de Impresion';
            ELSE
                INSERT INTO VENTA(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_PERSONA,ID_CLIENTE,ID_SUCURSAL,ID_CLIENTE_LEGAL,ID_COMPROBANTE,ID_IGV,ID_MONEDA,ID_LEYENDA,TIPOCAMBIO,SERIE,NUMERO,FECHA,AGRUPADO,GLOSA,ESTADO,ID_TIPOVENTA)
                VALUES (P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,P_ID_PERSONA,P_ID_CLIENTE,L_ID_SUCURSAL,L_ID_CLIENTE_LEGAL,P_ID_COMPROBANTE,L_IGV,P_ID_MONEDA,'1000',L_TC,'-','-',clock_timestamp(),P_AGRUPADO,P_GLOSA,0,P_ID_TIPOVENTA)
                RETURNING ID_VENTA INTO L_ID_VENTA;
                P_ERROR :=0;
                P_MSN := 'OK';
                P_ID_VENTA := L_ID_VENTA;
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_venta_fa (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint,P_ID_SUCURSAL bigint,P_ID_CLIENTE_LEGAL bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint, P_AGRUPADO text,P_GLOSA text,P_ID_TIPOVENTA bigint,P_ID_VENTA OUT bigint,P_ERROR OUT bigint,P_MSN OUT text) FROM PUBLIC;
