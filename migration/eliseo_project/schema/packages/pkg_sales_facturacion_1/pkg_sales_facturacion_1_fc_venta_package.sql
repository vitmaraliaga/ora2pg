-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_facturacion_1,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_facturacion_1_fc_venta (P_ID_VENTA bigint) RETURNS varchar AS $body$
DECLARE

        S_DETALLE       varchar(4000);
        --S_DETALLE       LONG;
        S_VENTA         varchar(4000);
        --S_VENTA         LONG;
        S_CONTA         integer;
        S_TIPODOC       varchar(2);
        L_ID_TIPOVENTA bigint;

        S_ID_RUC      varchar(20);


        VENTA REFCURSOR;


BEGIN  
    S_CONTA:=0;
    SELECT COALESCE(MAX(M.ID_RUC),'') INTO STRICT S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
    AND E.ID_EMPRESA = M.ID_EMPRESA
    AND V.ID_VENTA = P_ID_VENTA;

    --SELECT ID_COMPROBANTE,ID_TIPOVENTA INTO S_TIPODOC, L_ID_TIPOVENTA FROM VENTA WHERE ID_VENTA=P_ID_VENTA;
   		SELECT TC.COD_ELECTRONICO,V.ID_TIPOVENTA INTO STRICT S_TIPODOC, L_ID_TIPOVENTA 
		FROM VENTA V 
		INNER JOIN ELISEO.TIPO_COMPROBANTE TC ON V.ID_COMPROBANTE = TC.ID_COMPROBANTE 
		WHERE ID_VENTA=P_ID_VENTA; --Agregado por Ulices
		
        IF S_TIPODOC='03' THEN  -- BOLETA
                open VENTA FOR
                SELECT distinct'CB'||'|'||'0101'||
                    '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
                    '|'||'03'|| 
                    '|'||A.SERIE||'-'||A.NUMERO||
                    '|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
                    '|'||S_ID_RUC|| 
                    '|'||CASE WHEN LENGTH(FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)))=8 THEN 1  ELSE 0 END ||
                    '|'||coalesce(FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
                    '|'||FC_NOMBRE_PERSONA(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
                    '|'||REGEXP_REPLACE(coalesce(trim(both pkg_sales_facturacion_fc_cliente_direccion(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Sin Direccion'),'-','', 'g')|| 
                    '|'||''|| 
                    '|'||trim(both coalesce(FC_EMAIL(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END) END ||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END) END ||
                    '|'||'0.00'|| 
                    '|'||CASE WHEN b.id_tipoigv='40' THEN CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END   ELSE '0.00' END ||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
                    '|'||'0.00'||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
                    '|'||'1000'|| 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''||    
                    '|' CAB 
                FROM VENTA A, VENTA_DETALLE B  
                WHERE A.ID_VENTA = B.ID_VENTA   
                AND A.ID_VENTA = P_ID_VENTA 
                AND A.ESTADO = 1 		
                
UNION ALL
 
                SELECT  'DB'||	
                    '|'||ROWNUM||
                    '|'||''|| 
                        (SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
                    '|86121503'|| 
                    '|'||'NIU'|| 
                    '|'||trim(both to_char(b.cantidad,'990.99'))|| 
                    '|'||coalesce(b.detalle,'Venta')|| 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999990D99')),',','.') END) END ||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END) END ||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
                    '|'||b.ID_TIPOIGV|| 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||''|| 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN B.DESCUENTO >0 THEN TO_CHAR(B.BASE,'999999,9999.99') ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.BASE_ME,'999999,9999.99') ELSE '0.00' END))||    
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2),'9999999990D99')),',','.') END) END || 
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IMPORTE,0) = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END) END ||			
                    '|'||''|| 
                    '|'||''||
                    '|' DET 			
                FROM VENTA A, VENTA_DETALLE B  
                WHERE A.ID_VENTA = B.ID_VENTA    
                AND A.ID_VENTA = P_ID_VENTA  
                AND B.IMPORTE > 0
                AND A.ESTADO = 1;

ELSIF S_TIPODOC = '01' THEN   -- FACTURA
open VENTA FOR
    SELECT distinct'CF'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'01'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
		'|'||S_ID_RUC||'|6'||
		'|'||coalesce(FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
    --'|'||DECODE(LENGTH(FC_DOCUMENTO_CLIENTE(A.ID_CLIENTE)),8,1,0)||
    '|'||FC_NOMBRE_PERSONA(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		'|'||REGEXP_REPLACE(coalesce(trim(both pkg_sales_facturacion_fc_cliente_direccion(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Sin Direccion'),'-','', 'g')|| 
		'|'||''|| 
		-- '|'||trim(FC_EMAIL(A.ID_CLIENTE_LEGAL))|| 
        '|'||trim(both coalesce(FC_EMAIL(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END) END ||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END) END ||
		'|'||'0.00'|| 
		'|'||CASE WHEN b.id_tipoigv='40' THEN CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END   ELSE '0.00' END ||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce((A.GRAVADA+A.INAFECTA),0) = 0 THEN '0.00' WHEN(A.GRAVADA+A.INAFECTA) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR((A.GRAVADA+A.INAFECTA),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((A.GRAVADA+A.INAFECTA),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN(A.GRAVADA_ME+A.INAFECTA_ME) = 0 THEN '0.00' WHEN(A.GRAVADA_ME+A.INAFECTA_ME) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR((A.GRAVADA_ME+A.INAFECTA_ME),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((A.GRAVADA_ME+A.INAFECTA_ME),'9999999990D99')),',','.') END) END || 
        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		'|'||'0.00'||  -- total descuento, va 0.00 porque 
		'|'||'0.00'||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
        '|'||'1000'|| 
        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM VENTA A, VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA   
        AND A.ID_VENTA = P_ID_VENTA 
        AND B.IMPORTE > 0
        AND A.ESTADO = 1 		
       
UNION ALL
 
 SELECT  'DF'||	'|'||ROWNUM||
			'|'||''|| 
            (SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
			-- '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)||
            '|86121503'|| 
			'|'||'NIU'|| 
			'|'||trim(both to_char(b.cantidad,'990.99'))|| 
			'|'||coalesce(b.detalle,'Venta')|| 
            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IMPORTE,0) = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
			'|'||b.ID_TIPOIGV|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN TO_CHAR(B.PRECIO_BASE,'9999999990.00') ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.PRECIO_BASE_ME,'9999999990.00') ELSE '0.00' END) END ||    
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.PRECIO_BASE,0))::numeric,4)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.PRECIO_BASE,0))::numeric,4) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.PRECIO_BASE,0))::numeric,4),'90D9999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.PRECIO_BASE,0))::numeric,4),'9999999990D9999')),',','.') END)  ELSE (CASE  WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.PRECIO_BASE_ME,0))::numeric,4)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.PRECIO_BASE_ME,0))::numeric,4) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.PRECIO_BASE_ME,0))::numeric,4),'90D9999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.PRECIO_BASE_ME,0))::numeric,4),'9999999990D9999')),',','.') END) END || 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IMPORTE,0) = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END) END ||			
			'|'||''|| 
			'|'||''||
			'|' DET 			
        FROM VENTA A, VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA  
        AND B.IMPORTE > 0
        AND A.ESTADO = 1;

         END IF;

        -- open VENTA;
        fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                --S_DETALLE :='';
            END IF;

            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	

        RETURN(S_DETALLE);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_facturacion_1_fc_venta (P_ID_VENTA bigint) FROM PUBLIC;
