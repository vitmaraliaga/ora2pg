-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_deposito (P_ID_DEPOSITO bigint,P_ID_DINAMICA bigint,P_ID_DINAMICA_CLI_SALDO_INI bigint,P_ID_CTABANCARIA bigint,P_IMPORTE bigint,P_IMPORTE_TARJETA bigint ,P_IMPORTE_TRANS bigint,P_DETALLE text,P_ERROR OUT bigint,P_MSGERROR out text, P_DEP_B text default null) AS $body$
DECLARE


        l_dinamica bigint;
        l_asiento bigint;
        l_detalle varchar(100);
        l_base decimal(10,2);
        l_igv decimal(10,2);
        l_descuento decimal(10,2);
        l_importe decimal(10,2);
        l_precio_alm decimal(10,2);
        l_ctas varchar(200);
        l_deptos varchar(200);
        l_ctates varchar(200);

        l_actas tablastring;
        l_adeptos tablastring;
        l_actates tablastring;

        l_id_asiento bigint;
        l_id_parent bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_destino varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);

        l_id_asientod bigint;
        l_id_tipopland bigint;
        l_id_restricciond varchar(50);
        l_id_cuentaaasid varchar(10);
        l_dcd varchar(1);
        l_id_indicadord  varchar(35);
        l_unicod varchar(1);
        l_porcentajed decimal(10,2);
        l_unicoctated varchar(1);

        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_fondo varchar(10);
        l_importeasiento decimal(10,2);
        l_importe_tarjeta decimal(10,2);
        l_importe_trans decimal(10,2);
        l_descripcion varchar(255);
        l_memo varchar(255);
        l_voucher bigint;
        l_id_depto_deposito varchar(20);
        l_ref_id varchar(100);

        l_importe_comision_visa decimal(10,2);
        l_importe_tarjeta_voucher_sum decimal(10,2);
        l_importe_comision_deposito decimal(10,2);

        l_id_entidad bigint;
        l_buscar bigint;

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        --l_id_operorigen numeric:=5;
        l_id_tipoorigen bigint;
        l_serie varchar(5);
        l_numero varchar(15);
        l_doc_anticipo varchar(30);
        l_glosa varchar(200):='';
        --validacion
        l_contar bigint;
        l_debito decimal(10,2);
        l_credito decimal(10,2);
        l_cont bigint;
        l_id_cliente bigint;
        l_agrupa varchar(1);
        l_nro_operacion varchar(200):='';
        l_fecha_operacion varchar(200):='';
        l_cliente varchar(200):='';
        l_glosa_dep varchar(200):='';
        /*
        l_cont numeric;
        l_serie varchar(5);
        l_numero varchar(15);
        l_fecha timestamp;
        */
        L_CC varchar(8);
        L_DIA bigint;

        l_id_venta bigint;
        l_id_anho bigint;
        l_importe_ddet decimal(10,2);

        ddet CURSOR FOR	
        SELECT dd.ID_VENTA, d.id_anho, dd.IMPORTE, d.NRO_OPERACION, 
        to_char(d.FECHA_OPERACION,'dd/mm') AS FECHA_OPERACION,
        p.NOMBRE || ' ' || p.PATERNO AS clinte,
        d.glosa
        FROM eliseo.CAJA_DEPOSITO_DETALLE dd
        INNER JOIN eliseo.CAJA_DEPOSITO d ON d.ID_DEPOSITO = dd.ID_DEPOSITO 
        INNER JOIN moises.PERSONA p ON p.ID_PERSONA = d.ID_CLIENTE 
        WHERE d.ID_DEPOSITO = P_ID_DEPOSITO;

        cdet_sal_ini CURSOR FOR	
        SELECT  ID_DINAMICA,ID_ENTIDAD
        FROM CONTA_DINAMICA
        WHERE ID_DINAMICA=P_ID_DINAMICA_CLI_SALDO_INI;


        cdet CURSOR FOR	
        SELECT  ID_DINAMICA,ID_ENTIDAD
        FROM CONTA_DINAMICA 
        WHERE ID_DINAMICA=P_ID_DINAMICA;

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =l_dinamica
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        casides CURSOR FOR		
        SELECT ID_ASIENTO,ID_TIPOPLAN,ID_RESTRICCION,ID_CUENTAAASI,DC,ID_INDICADOR,UNICO,UNICO_CTACTE,PORCENTAJE,NOMBRE,AGRUPA 
        FROM CONTA_DINAMICA_ASIENTO
        WHERE ID_PARENT=l_asiento
        ORDER BY NRO_ASIENTO,DC desc;


BEGIN
     
        l_detalle:=P_DETALLE;
        l_importe:= P_IMPORTE;
        l_importe_tarjeta:=P_IMPORTE_TARJETA;
        l_importe_trans:=P_IMPORTE_TRANS;
        l_fondo:='10';
        l_importe_comision_visa := 0;
        l_importe_tarjeta_voucher_sum := 0;
        l_importe_comision_deposito := 0;

        --VALIDA EL TIPO DE PAGO PARA GENERAR EL ASIENTO
        IF P_IMPORTE > 0 THEN  --PAGO CON EFECTIVO
            l_importe_tarjeta := 0;
            l_importe_trans :=0;
        ELSIF P_IMPORTE_TARJETA > 0 THEN  --PAGO CON TARJETA
            l_importe := 0;
            l_importe_trans :=0;
        ELSE  --PAGO A CUENTA PERSONAL
             l_importe := 0;
            l_importe_tarjeta :=0;
        END IF;

        if (P_ID_DEPOSITO IS NOT NULL AND P_ID_DEPOSITO::text <> '') then
            IF P_DEP_B = 'S' THEN 
                SELECT COUNT(1) INTO STRICT l_cont FROM CAJA_DEPOSITO_BANCO WHERE ID_DEPBANCO = P_ID_DEPOSITO;
                IF l_cont > 0 THEN
                    SELECT ID_DEPTO, ID_VOUCHER, ID_TIPOORIGEN, '-' AS SERIE, OPERACION AS NUMERO into STRICT l_id_depto_deposito, l_voucher,l_id_tipoorigen, l_serie, l_numero
                    FROM CAJA_DEPOSITO_BANCO
                    WHERE ID_DEPBANCO = P_ID_DEPOSITO;
                END IF;
            ELSE
                SELECT COUNT(1) INTO STRICT l_cont FROM CAJA_DEPOSITO  WHERE ID_DEPOSITO = P_ID_DEPOSITO;
                IF l_cont > 0 THEN
                    select ID_DEPTO, ID_CLIENTE,ID_VOUCHER, ID_TIPOORIGEN, SERIE, NUMERO into STRICT l_id_depto_deposito, l_id_cliente,l_voucher,l_id_tipoorigen, l_serie, l_numero
                    from CAJA_DEPOSITO 
                    WHERE ID_DEPOSITO = P_ID_DEPOSITO;
                END IF;

            END IF;

            
            -- obtener el importe de la comisión
            
            SELECT COALESCE(cvcv.IMPORTE,0) into STRICT l_importe_comision_visa
            FROM CONTA_VOUCHER cv
            LEFT OUTER JOIN CONTA_VOUCHER_COMISION_VISA cvcv ON cvcv.ID_VOUCHER = cv.ID_VOUCHER 
            WHERE cv.ID_VOUCHER = l_voucher;
            
            -- Obtener el importe total de las operaciones con tarjeta (visa)
            
            select 
            COALESCE(sum(importe),0) into STRICT l_importe_tarjeta_voucher_sum       
            from eliseo.caja_deposito
            where id_VOUCHER = l_voucher
            AND id_mediopago = '006'
            AND ESTADO = '1';

                        
            /*SELECT COUNT(1) INTO l_cont FROM CAJA_DEPOSITO  WHERE ID_DEPOSITO = P_ID_DEPOSITO;
            IF l_cont > 0 THEN 
                select ID_DEPTO, ID_CLIENTE,ID_VOUCHER, ID_TIPOORIGEN, SERIE, NUMERO into l_id_depto_deposito, l_id_cliente,l_voucher,l_id_tipoorigen, l_serie, l_numero
                from CAJA_DEPOSITO 
                WHERE ID_DEPOSITO = P_ID_DEPOSITO;
            ELSE
                SELECT COUNT(1) INTO l_cont FROM CAJA_DEPOSITO_BANCO WHERE ID_DEPBANCO = P_ID_DEPOSITO;
                IF l_cont > 0 THEN 
                    SELECT ID_DEPTO, ID_VOUCHER, ID_TIPOORIGEN, '-' AS SERIE, OPERACION AS NUMERO into l_id_depto_deposito, l_voucher,l_id_tipoorigen, l_serie, l_numero
                    FROM CAJA_DEPOSITO_BANCO
                    WHERE ID_DEPBANCO = P_ID_DEPOSITO;
                END IF;
            END IF;*/
            --IDENTIFICO EL CENTRO DEL COSTO DEL PERSONAL
            SELECT COUNT(1) INTO STRICT l_cont
            FROM CAJA_DEPOSITO A JOIN APS_TRABAJADOR B
            ON A.ID_CLIENTE = B.ID_PERSONA
            WHERE A.ID_DEPOSITO = P_ID_DEPOSITO
            AND A.ID_MEDIOPAGO = '999';
            IF l_cont > 0 THEN
                SELECT SUBSTR(B.ID_DEPTO,1,1) INTO STRICT L_CC
                FROM CAJA_DEPOSITO A JOIN APS_TRABAJADOR B
                ON A.ID_CLIENTE = B.ID_PERSONA
                WHERE A.ID_DEPOSITO = P_ID_DEPOSITO
                AND A.ID_MEDIOPAGO = '999';
            END IF;
        end if;
        IF coalesce(l_voucher::text, '') = '' OR l_voucher = 0 THEN
            l_error :=1;
            l_msgerror:='No existe Voucher-'||P_ID_DEPOSITO;
            --goto salida_rapida;
        END IF;

        SELECT l_id_tipoorigen::text || '-' || P_ID_DEPOSITO::text INTO STRICT l_memo;

        --l_detalle := '(Dep: '|| COALESCE(l_serie,'-') || '-' || COALESCE(l_numero,'-') || ') ' || l_detalle;
        
     --OBTIENE DATOS DE LA VENTA
      --select ID_ENTIDAD,SERIE,NUMERO,FECHA,ID_CLIENTE into l_id_entidad,l_serie,l_numero,l_fecha,l_id_cliente from VENTA where ID_VENTA=P_ID_VENTA;
    -- Insertando las cuentas Cliente:
    
        OPEN ddet; -- ddet.nro_operacion||' '||ddet.fecha_operacion||' '||ddet.cliente
        FETCH ddet INTO l_id_venta,l_id_anho, l_importe_ddet, l_nro_operacion, l_fecha_operacion, l_cliente, l_glosa_dep;
        WHILE ddet%FOUND LOOP

        -- Si la venta es de anticipo jalar el asiento cliente de anticipo
        
            SELECT count(1) into STRICT l_contar FROM VENTA_SALDO s
            WHERE ID_VENTA = l_id_venta
            AND EXISTS (
            SELECT 1 FROM CAJA_DEPOSITO d
            WHERE d.ID_ANHO = s.ID_ANHO
            AND d.ID_ENTIDAD = s.ID_ENTIDAD
            AND d.ID_DEPTO = s.ID_DEPTO
            AND d.ID_DEPOSITO = P_ID_DEPOSITO
            );

            RAISE NOTICE 'anticipo l_contar=%', l_contar;
            RAISE NOTICE 'anticipo l_id_venta=%', l_id_venta;

            if l_contar > 0 then 

                    OPEN cdet_sal_ini;
                    FETCH cdet_sal_ini INTO l_dinamica,l_id_entidad;

                    WHILE cdet_sal_ini%FOUND LOOP
                    
                        ---DINAMICA ASIENTO
                        OPEN casi;
                        FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                        WHILE casi%FOUND LOOP

                           SELECT max('('||serie||'-'||numero||')') into STRICT l_doc_anticipo FROM VENTA_SALDO s
                            WHERE ID_VENTA = l_id_venta
                            and s.id_anho = l_id_anho;

                            select case when l_id_indicador='IMPORTE' then (l_importe_ddet)*(l_porcentaje)
                                      else
                                      0
                                      end into STRICT l_importeasiento
;

                            l_depto:=null;
                            l_cuenta_cte:=null;

                            if l_importeasiento<>0 then
                            
                                if l_unico='U' then
                                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                                elsif (l_unico='M') then
                                   SELECT position('|' in l_deptos) into STRICT l_buscar;
                                   if l_buscar>0 then
                                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                     select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                                     select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasi) into STRICT l_depto;
                                   else
                                    l_depto:=l_deptos;
                                   end if;
                                elsif (l_unico='X') then
                                   select pkg_sales_school_fc_depto_alumno_school_inst(l_id_cliente, l_id_entidad, l_id_depto_deposito) into STRICT l_depto;
                                elsif l_unico='S' THEN  -- Si es sesión
                                    l_depto := l_id_depto_deposito;
                                end if;

                                if l_unicoctate='U' then
                                  select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                                  if l_cont>0 then
                                    select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                                  end if;
                                elsif (l_unicoctate='M') then
                                   SELECT position('|' in l_ctates) into STRICT l_buscar;
                                   if l_buscar>0 then
                                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                     select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                                     select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                                   else
                                    l_cuenta_cte:=l_ctates;
                                   end if;
                                elsif (l_unicoctate='X') then
                                    select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente and id_tipodocumento = 1;
                                elsif (l_unicoctate='B') then --LA CTA CTE SE OBTIENE DEL LA CTA BANCARIA
                                    --SELECT ID_TIPOCTACTE into l_cuenta_cte FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = P_ID_CTABANCARIA;
                                    SELECT ID_TIPOCTACTE, ID_CUENTAAASI into STRICT l_cuenta_cte, l_id_cuentaaasi FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = P_ID_CTABANCARIA;
                                end if;
                                if l_dc='C' then
                                  l_importeasiento:=l_importeasiento*(-1);
                                end if;

                                select count(1) into STRICT l_cont from CONTA_ASIENTO
                                where ID_TIPOORIGEN=l_id_tipoorigen
                                and ID_ORIGEN=P_ID_DEPOSITO
                                and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                                and CUENTA =l_id_cuentaaasi
                                and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                                and case when importe>0 then 'D' else 'C' end=l_dc;

                                --== LA CUENTA 1135001 SOLO ES PARA SEDE, PARA LOS CENTROS DE COSTO ES LA CTA PUENTE
                                SELECT (TO_CHAR(clock_timestamp(),'DD'))::numeric  INTO STRICT L_DIA;
                                IF L_DIA < 25 THEN
                                    IF (L_CC = '2' AND l_id_cuentaaasi = '1135001') THEN
                                        l_id_cuentaaasi := '1136080';
                                        l_cuenta_cte := '21010101';
                                        l_depto := '11010101';
                                    ELSIF (L_CC = '3' AND l_id_cuentaaasi = '1135001') THEN
                                        l_id_cuentaaasi := '1136080';
                                        l_cuenta_cte := '31010101';
                                        l_depto := '11010101';
                                    ELSIF (L_CC = '4' AND l_id_cuentaaasi = '1135001') THEN
                                        l_id_cuentaaasi := '1136080';
                                        l_cuenta_cte := '41010101';
                                        l_depto := '11010101';
                                    ELSE
                                        l_cont := 0;
                                    END IF;
                                ELSE  --VENTAS AL CREDITO A PARTIR DEL 26
                                    IF l_id_cuentaaasi = '1135001' THEN
                                        l_id_cuentaaasi := '1139090';
                                        l_cuenta_cte := '21';
                                        l_depto := '11010101';
                                    END IF;
                                END IF;

                              if l_cont=0 then
                                INSERT INTO CONTA_ASIENTO(
                                ID_TIPOORIGEN,
                                ID_ORIGEN, 
                                FONDO,
                                DEPTO,
                                CUENTA, 
                                CUENTA_CTE,
                                RESTRICCION,
                                IMPORTE,
                                DESCRIPCION,
                                MEMO,
                                VOUCHER, 
                                PARENT_ID,
                                REF_ID,
                                AGRUPA
                                )VALUES ( 
                                l_id_tipoorigen,
                                P_ID_DEPOSITO,
                                l_fondo,
                                l_depto,
                                l_id_cuentaaasi,
                                l_cuenta_cte,
                                l_id_restriccion,
                                l_importeasiento,
                                l_doc_anticipo||'-'||l_descripcion,
                                l_memo,
                                l_voucher,
                                null,
                                l_ref_id ,
                                l_agrupa
                                );
                              else

                                update CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                                where ID_TIPOORIGEN=l_id_tipoorigen
                                and ID_ORIGEN=P_ID_DEPOSITO
                                and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                                and CUENTA =l_id_cuentaaasi
                                and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                                and case when importe>0 then 'D' else 'C' end=l_dc;

                              end if;
                            end if;
                              --DESTINO
                              OPEN casides;
                              FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                              WHILE casides%FOUND LOOP

                              
                                select case when l_id_indicadord='IMPORTE' then (l_importe_ddet)*(l_porcentaje)
                                      else
                                      0
                                      end into STRICT l_importeasiento
;

                                l_depto:=null;
                                l_cuenta_cte:=null;

                                if l_unicod='U' then
                                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                                elsif (l_unicod='M') then
                                   SELECT position('|' in l_deptos) into STRICT l_buscar;
                                   if l_buscar>0 then
                                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                     select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                                     select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasid) into STRICT l_depto;
                                   else
                                    l_depto:=l_deptos;
                                   end if;
                                elsif (l_unicod='X') then
                                   select pkg_sales_school_fc_depto_alumno_school_inst(l_id_cliente, l_id_entidad, l_id_depto_deposito) into STRICT l_depto;
                                end if;

                                if l_unicoctated='U' then
                                  select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                                  if l_cont>0 then
                                    select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                                  end if;

                                elsif (l_unicoctated='M') then
                                   SELECT position('|' in l_ctates) into STRICT l_buscar;
                                   if l_buscar>0 then
                                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                     select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                                     select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasid) into STRICT l_cuenta_cte;
                                   else
                                    l_cuenta_cte:=l_ctates;
                                   end if;
                                elsif (l_unicoctated='X') then
                                  select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente;
                                end if;

                                if l_dc='C' then
                                  l_importeasiento:=l_importeasiento*(-1);
                                end if;
                                if l_importeasiento<>0 then

                                  select count(*) into STRICT l_cont from CONTA_ASIENTO
                                  where ID_TIPOORIGEN=l_id_tipoorigen
                                  and ID_ORIGEN=P_ID_DEPOSITO
                                  and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                                  and CUENTA =l_id_cuentaaasid
                                  and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                                  and case when importe>0 then 'D' else 'C' end=l_dc;

                                
                                  IF l_agrupa='S' and l_cont>0 THEN
                                    update  CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                                    where ID_TIPOORIGEN=l_id_tipoorigen
                                    and ID_ORIGEN=P_ID_DEPOSITO
                                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                                    and CUENTA =l_id_cuentaaasid
                                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                                    and case when importe>0 then 'D' else 'C' end=l_dc;

                                  ELSE
                                    INSERT INTO CONTA_ASIENTO(
                                    ID_TIPOORIGEN,
                                    ID_ORIGEN, 
                                    FONDO,
                                    DEPTO,
                                    CUENTA, 
                                    CUENTA_CTE,
                                    RESTRICCION,
                                    IMPORTE,
                                    DESCRIPCION,
                                    MEMO,
                                    VOUCHER, 
                                    PARENT_ID,
                                    REF_ID
                                    )VALUES ( 
                                    l_id_tipoorigen,
                                    P_ID_DEPOSITO,
                                    l_fondo,
                                    l_depto,
                                    l_id_cuentaaasid,
                                    l_cuenta_cte,
                                    l_id_restricciond,
                                    l_importeasiento,
                                    l_detalle,
                                    l_memo,
                                    l_voucher,
                                    null,
                                    l_ref_id 
                                    );
                                  END IF;

                                end if;
                                FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                              END LOOP;
                              CLOSE casides;
                            
                            FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                          END LOOP;
                          CLOSE casi;
                        FETCH cdet_sal_ini INTO l_dinamica,l_id_entidad;
                        END LOOP;
                        CLOSE cdet_sal_ini;
            else 
            -- Si la venta es del año en curso, jalar el asiento primario de la venta
            RAISE NOTICE '==================================';
            RAISE NOTICE 'Si la venta es del año en curso, jalar el asiento primario de la venta';
            RAISE NOTICE 'l_id_venta=%', l_id_venta;

            
                    INSERT INTO CONTA_ASIENTO(
                    ID_TIPOORIGEN,
                    ID_ORIGEN, 
                    FONDO,
                    DEPTO,
                    CUENTA, 
                    CUENTA_CTE,
                    RESTRICCION,
                    IMPORTE,
                    DESCRIPCION,
                    MEMO,
                    VOUCHER, 
                    PARENT_ID,
                    REF_ID,
                    AGRUPA
                    )
                    SELECT l_id_tipoorigen, P_ID_DEPOSITO,
                    ca.FONDO, ca.DEPTO, ca.CUENTA, ca.CUENTA_CTE, ca.RESTRICCION, 
                    case when max(v.TOTAL) = 0 then 0 else  round((sum(vd.IMPORTE) / max(v.TOTAL) * l_importe_ddet)::numeric,2)*-1 end,
                    ca.DESCRIPCION, l_memo, l_voucher, null, ca.REF_ID, ca.AGRUPA
                    FROM VENTA v, VENTA_DETALLE vd, CONTA_ASIENTO ca
                    WHERE v.ID_VENTA = vd.ID_VENTA 
                    AND vd.ID_VDETALLE = ca.ID_ORIGEN
                    AND vd.ID_TIPOORIGEN = ca.ID_TIPOORIGEN
                    AND vd.ID_VENTA = l_id_venta
                    AND ca.PRIMARIO = 'S'
                    AND v.TOTAL >= 0
                    GROUP BY ca.FONDO, ca.DEPTO, ca.CUENTA, ca.CUENTA_CTE, ca.RESTRICCION, ca.PARENT_ID, ca.REF_ID, ca.AGRUPA,ca.DESCRIPCION;
            end if;

            
        
        FETCH ddet INTO l_id_venta,l_id_anho, l_importe_ddet, l_nro_operacion, l_fecha_operacion, l_cliente, l_glosa_dep;
        END LOOP;
        CLOSE ddet;
        
     --DETALLE
        OPEN cdet;
        FETCH cdet INTO l_dinamica,l_id_entidad;

        WHILE cdet%FOUND LOOP

            ---DINAMICA ASIENTO
            
            RAISE NOTICE '-- DETALLE --';

            OPEN casi;
            FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
            WHILE casi%FOUND LOOP

                l_importe_comision_deposito := 0;
                if l_importe_tarjeta_voucher_sum <> 0 then
                    l_importe_comision_deposito := (l_importe_tarjeta)*(l_porcentaje)/l_importe_tarjeta_voucher_sum*l_importe_comision_visa;
                end if;

                select case when l_id_indicador='IMPORTE' then (l_importe)*(l_porcentaje)
                          when l_id_indicador='IMPORTE_TARJETA' then (l_importe_tarjeta)*(l_porcentaje) - l_importe_comision_deposito
                          when l_id_indicador='IMPORTE_TRANS' then (l_importe_trans)*(l_porcentaje)
                          when l_id_indicador='COMISION_VISA_COLEGIOS' then
                               l_importe_comision_deposito                       
                          else
                          0
                          end into STRICT l_importeasiento
;


                
                l_depto:=null;
                l_cuenta_cte:=null;
                --select 'Dep:'||max(glosa) into l_descripcion from caja_deposito where ID_DEPOSITO = P_ID_DEPOSITO;
                select (
                    CASE ID_MEDIOPAGO WHEN '006' THEN
                        CASE WHEN ID_PERSONA = 2 THEN
                            'APP:'||serie||'-'||(numero)::numeric ||'-'||CASE WHEN ID_TIPOTARJETA=1 THEN 'VISA' WHEN ID_TIPOTARJETA=2 THEN 'MASTERCARD' WHEN ID_TIPOTARJETA=3 THEN 'DINERS CLUB' WHEN ID_TIPOTARJETA=4 THEN 'AMERICAN EXPRESS' END ||'-Oper:'||NRO_OPERACION||'-'||TO_CHAR(FECHA_OPERACION,'DD/MM/YY')
                        ELSE
                            'POS:'||serie||'-'||(numero)::numeric ||'-'||CASE WHEN ID_TIPOTARJETA=1 THEN 'VISA' WHEN ID_TIPOTARJETA=2 THEN 'MASTERCARD' WHEN ID_TIPOTARJETA=3 THEN 'DINERS CLUB' WHEN ID_TIPOTARJETA=4 THEN 'AMERICAN EXPRESS' END ||'-Oper:'||NRO_OPERACION||'-'||TO_CHAR(FECHA_OPERACION,'DD/MM/YY')
                        END
                    WHEN '001' THEN
                    'DREC:'||serie||'-'||(numero)::numeric ||'-'||TO_CHAR(fecha,'DD/MM/YY')||'-Oper:'||NRO_OPERACION
                    WHEN '008' THEN
                    'EFEC:'||serie||'-'||(numero)::numeric ||'-'||TO_CHAR(fecha,'DD/MM/YY')
                    WHEN '999' THEN
                    '-Dep:'||serie||'-'||(numero)::numeric ||'-'||TO_CHAR(fecha,'DD/MM/YY')
                    ELSE 'DEPOSITO CLIENTES' END )
                     into STRICT l_descripcion
                     from caja_deposito 
                     where ID_DEPOSITO = P_ID_DEPOSITO;

                
                if l_id_indicador='COMISION_VISA_COLEGIOS' then 
                    l_descripcion := 'Comisión Visa '||l_fecha_operacion;
                end if;
                if l_id_indicador='IMPORTE_TARJETA' then
                    l_descripcion := 'Importe Tarjeta Día: '||l_fecha_operacion;
                end if;

                RAISE NOTICE 'l_importeasiento %', l_importeasiento;

                if l_importeasiento<>0 then
                -- if true then
                
                    if l_unico='U' then
                      select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                    elsif (l_unico='M') then
                       SELECT position('|' in l_deptos) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasi) into STRICT l_depto;
                       else
                        l_depto:=l_deptos;
                       end if;
                    elsif (l_unico='X') then
                       select pkg_sales_school_fc_depto_alumno_school_inst(l_id_cliente, l_id_entidad, l_id_depto_deposito) into STRICT l_depto;
                    elsif l_unico='S' THEN  -- Si es sesión
                        l_depto := l_id_depto_deposito;
                    end if;

                    if l_unicoctate='U' then
                      select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                      if l_cont>0 then
                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                      end if;
                    elsif (l_unicoctate='M') then
                       SELECT position('|' in l_ctates) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                       else
                        l_cuenta_cte:=l_ctates;
                       end if;
                    elsif (l_unicoctate='X') then
                        select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente and id_tipodocumento = 1;
                    elsif (l_unicoctate='B') then --LA CTA CTE SE OBTIENE DEL LA CTA BANCARIA
                        -- SELECT ID_TIPOCTACTE into l_cuenta_cte FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = P_ID_CTABANCARIA;
                        SELECT max(ID_TIPOCTACTE), max(ID_CUENTAAASI) into STRICT l_cuenta_cte, l_id_cuentaaasi FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = P_ID_CTABANCARIA;
                        l_descripcion := 'Trs: '||l_nro_operacion||' '||l_fecha_operacion||' '||l_cliente;
                        --l_descripcion := l_glosa_dep;
                    end if;
                    if l_dc='C' then
                      l_importeasiento:=l_importeasiento*(-1);
                    end if;

                    select count(1) into STRICT l_cont from CONTA_ASIENTO
                    where ID_TIPOORIGEN=l_id_tipoorigen
                    and ID_ORIGEN=P_ID_DEPOSITO
                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                    and CUENTA =l_id_cuentaaasi
                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                    and case when importe>0 then 'D' else 'C' end=l_dc;

                    --== LA CUENTA 1135001 SOLO ES PARA SEDE, PARA LOS CENTROS DE COSTO ES LA CTA PUENTE
                    SELECT (TO_CHAR(clock_timestamp(),'DD'))::numeric  INTO STRICT L_DIA;
                    IF L_DIA < 25 THEN
                        IF (L_CC = '2' AND l_id_cuentaaasi = '1135001') THEN
                            l_id_cuentaaasi := '1136080';
                            l_cuenta_cte := '21010101';
                            l_depto := '11010101';
                        ELSIF (L_CC = '3' AND l_id_cuentaaasi = '1135001') THEN
                            l_id_cuentaaasi := '1136080';
                            l_cuenta_cte := '31010101';
                            l_depto := '11010101';
                        ELSIF (L_CC = '4' AND l_id_cuentaaasi = '1135001') THEN
                            l_id_cuentaaasi := '1136080';
                            l_cuenta_cte := '41010101';
                            l_depto := '11010101';
                        ELSE
                            l_cont := 0;
                        END IF;
                    ELSE  --VENTAS AL CREDITO A PARTIR DEL 26
                        IF l_id_cuentaaasi = '1135001' THEN
                            l_id_cuentaaasi := '1139090';
                            l_cuenta_cte := '21';
                            l_depto := '11010101';
                        END IF;
                    END IF;

                  if l_cont=0 then
                    INSERT INTO CONTA_ASIENTO(
                    ID_TIPOORIGEN,
                    ID_ORIGEN, 
                    FONDO,
                    DEPTO,
                    CUENTA, 
                    CUENTA_CTE,
                    RESTRICCION,
                    IMPORTE,
                    DESCRIPCION,
                    MEMO,
                    VOUCHER, 
                    PARENT_ID,
                    REF_ID,
                    AGRUPA
                    )VALUES ( 
                    l_id_tipoorigen,
                    P_ID_DEPOSITO,
                    l_fondo,
                    l_depto,
                    l_id_cuentaaasi,
                    l_cuenta_cte,
                    l_id_restriccion,
                    l_importeasiento,
                    l_descripcion,
                    l_memo,
                    l_voucher,
                    null,
                    l_ref_id ,
                    l_agrupa
                    );
                  else

                    update CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                    where ID_TIPOORIGEN=l_id_tipoorigen
                    and ID_ORIGEN=P_ID_DEPOSITO
                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                    and CUENTA =l_id_cuentaaasi
                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                    and case when importe>0 then 'D' else 'C' end=l_dc;

                  end if;
                end if;
                  --DESTINO
                  OPEN casides;
                  FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                  WHILE casides%FOUND LOOP

                  RAISE NOTICE 'DESTINOOOOOOOOOOOOOOOOOOOOOO';

                    select case when l_id_indicadord='IMPORTE' then (l_importe)*(l_porcentaje)
                          when l_id_indicadord='IMPORTE_TARJETA' then (l_importe_tarjeta)*(l_porcentaje)
                          when l_id_indicadord='IMPORTE_TRANS' then (l_importe_trans)*(l_porcentaje)
                          else
                          0
                          end into STRICT l_importeasiento
;

                    l_depto:=null;
                    l_cuenta_cte:=null;

                    if l_unicod='U' then
                      select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                    elsif (l_unicod='M') then
                       SELECT position('|' in l_deptos) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasid) into STRICT l_depto;
                       else
                        l_depto:=l_deptos;
                       end if;
                    elsif (l_unicod='X') then
                       select pkg_sales_school_fc_depto_alumno_school_inst(l_id_cliente, l_id_entidad, l_id_depto_deposito) into STRICT l_depto;
                    end if;

                    if l_unicoctated='U' then
                      select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                      if l_cont>0 then
                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                      end if;

                    elsif (l_unicoctated='M') then
                       SELECT position('|' in l_ctates) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasid) into STRICT l_cuenta_cte;
                       else
                        l_cuenta_cte:=l_ctates;
                       end if;
                    elsif (l_unicoctated='X') then
                      select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente;
                    end if;

                    if l_dc='C' then
                      l_importeasiento:=l_importeasiento*(-1);
                    end if;
                    if l_importeasiento<>0 then
                    --if true then
                      select count(*) into STRICT l_cont from CONTA_ASIENTO
                      where ID_TIPOORIGEN=l_id_tipoorigen
                      and ID_ORIGEN=P_ID_DEPOSITO
                      and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                      and CUENTA =l_id_cuentaaasid
                      and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                      and case when importe>0 then 'D' else 'C' end=l_dc;

                    
                      IF l_agrupa='S' and l_cont>0 THEN
                        update  CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                        where ID_TIPOORIGEN=l_id_tipoorigen
                        and ID_ORIGEN=P_ID_DEPOSITO
                        and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                        and CUENTA =l_id_cuentaaasid
                        and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                        and case when importe>0 then 'D' else 'C' end=l_dc;

                      ELSE
                        INSERT INTO CONTA_ASIENTO(
                        ID_TIPOORIGEN,
                        ID_ORIGEN, 
                        FONDO,
                        DEPTO,
                        CUENTA, 
                        CUENTA_CTE,
                        RESTRICCION,
                        IMPORTE,
                        DESCRIPCION,
                        MEMO,
                        VOUCHER, 
                        PARENT_ID,
                        REF_ID
                        )VALUES ( 
                        l_id_tipoorigen,
                        P_ID_DEPOSITO,
                        l_fondo,
                        l_depto,
                        l_id_cuentaaasid,
                        l_cuenta_cte,
                        l_id_restricciond,
                        l_importeasiento,
                        l_detalle,
                        l_memo,
                        l_voucher,
                        null,
                        l_ref_id 
                        );
                      END IF;

                      
                    end if;
                    FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                  END LOOP;
                  CLOSE casides;
                
                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;

              END LOOP;
              CLOSE casi;

            FETCH cdet INTO l_dinamica,l_id_entidad;

        END LOOP;
        CLOSE cdet;
        
        
        select count(1) into STRICT l_contar from CONTA_ASIENTO
        where ID_TIPOORIGEN=l_id_tipoorigen
        and ID_ORIGEN=P_ID_DEPOSITO;

        RAISE NOTICE 'l_contar=%', l_contar;

        if l_contar=0 then
          l_error:=3; --no se ha generado el asiento
          l_msgerror:='Asiento Depósito: No se ha generado el asiento';
        else
          select COALESCE(sum(case when IMPORTE>0 then IMPORTE else 0 end),0) as debito,
           COALESCE(sum(case when IMPORTE<0 then IMPORTE*(-1) else 0 end),0) as credito
           into STRICT l_debito,l_credito
          from CONTA_ASIENTO
          where ID_TIPOORIGEN=l_id_tipoorigen
          and ID_ORIGEN=P_ID_DEPOSITO;

            
          
          if l_credito=0 or l_credito=0 THEN
          	NULL;
             --l_error:=4; --importe de debito o credito igual a cero
             --l_msgerror:='Asiento Depósito: Importe de débito o crédito igual a cero dinamica:'||l_dinamica||'  l_id_cliente: '|| l_id_cliente||'  l_debito: '|| l_debito||'  l_credito: '|| l_credito|| ' P_ID_DEPOSITO: '||P_ID_DEPOSITO;
          else
             if l_credito<>l_credito then
              l_error:=5; --descuadre de asiento
              l_msgerror:='Asiento Depósito: Descuadre de asiento';
             end if;
          end if;

        end if;


       -- <<salida_rapida>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_deposito (P_ID_DEPOSITO bigint,P_ID_DINAMICA bigint,P_ID_DINAMICA_CLI_SALDO_INI bigint,P_ID_CTABANCARIA bigint,P_IMPORTE bigint,P_IMPORTE_TARJETA bigint ,P_IMPORTE_TRANS bigint,P_DETALLE text,P_ERROR OUT bigint,P_MSGERROR out text, P_DEP_B text default null) FROM PUBLIC;
