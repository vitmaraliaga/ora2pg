-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_crear_deposito (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_MEDIOPAGO text,P_ID_PERSONA bigint, P_ID_CLIENTE bigint,P_VENTAS text,P_IMP_VENTAS text, P_ARTICULOS text, P_ID_TIPOTRANSACCION bigint,P_ID_MONEDA bigint,P_ID_DINAMICA bigint,P_ID_TIPOTARJETA bigint,P_ID_CTABANCARIA bigint, P_OPERACION text,P_FECHA_OP timestamp(0),P_IMPORTE bigint,P_IMPORTE_TARJETA bigint,P_IMPORTE_TRANS bigint,P_IMPORTE_ME bigint,P_TIPOCAMBIO bigint,P_GLOSA text,P_NOMBRE_DEP text, P_DOCUMENTO_DEP text,P_ID_TIPOASIENTO text,P_ERROR out bigint,P_MSGERROR out text,P_ID_VALE integer default NULL,P_ID_DEPOSITO OUT bigint) AS $body$
DECLARE


        l_serie varchar(4);
        l_numero varchar(8);
        l_deposito bigint:=0;
        l_estado varchar(1):='0'; --1:vigente, 0:Proceso; 2-Anulado
        l_id_voucher bigint :=0;

        l_correlativo bigint :=0;
        l_id_comprobante varchar(3):='00';  --deposito
        l_automatico varchar(2);
        l_contar bigint;
        l_fecha timestamp(0);
        --l_id_ctabancaria numeric;
        l_importedet decimal(10,2);
        l_importeasiento decimal(10,2);
        L_ID_VALE bigint;
        L_ID_TIPOTARJETA bigint;
        L_ID_CTABANCARIA bigint;
        L_GLOSA varchar(100);
        L_ID_TIPOVOUCHER bigint:=5;
        l_cuenta_bancaria varchar(300):='';

        l_id_dinamica_cli_sal_ini bigint;

        l_id_documento_fin bigint := NULL;

        l_id_tipopais bigint;

        l_error bigint:=0;
        l_msgerror varchar(200):='';

        
BEGIN
            select clock_timestamp() into STRICT l_fecha;
            IF P_ID_VALE = 0 THEN
                L_ID_VALE := NULL;
            ELSE
                L_ID_VALE := P_ID_VALE;
            END IF;
            IF P_ID_TIPOTARJETA = 0 THEN
                L_ID_TIPOTARJETA := NULL;
            ELSE
                L_ID_TIPOTARJETA := P_ID_TIPOTARJETA;
            END IF;
            IF P_ID_CTABANCARIA = 0 THEN
                L_ID_CTABANCARIA := NULL;
            ELSE
                L_ID_CTABANCARIA := P_ID_CTABANCARIA;
            END IF;

           SELECT COALESCE(max(NOMBRE),'')
           INTO STRICT l_cuenta_bancaria
           FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA=L_ID_CTABANCARIA;

            
           --obteniendo el id_tipopais
	       	SELECT A.ID_TIPOPAIS INTO STRICT l_id_tipopais FROM CONTA_EMPRESA A,CONTA_ENTIDAD B
			WHERE A.ID_EMPRESA = B.ID_EMPRESA AND B.ID_ENTIDAD = P_ID_ENTIDAD  LIMIT 1; --Agregado por Ulices
			--obteniendo el id_comprobante con el codigo '00' de deposito
			SELECT ID_COMPROBANTE INTO STRICT l_id_comprobante FROM TIPO_COMPROBANTE WHERE ID_TIPOPAIS = l_id_tipopais AND CODIGO = '00'; --Agregado por Ulices
           
             --========================= CONFIG TO VISA ONLINE=====================================
            IF P_ID_PERSONA = 2 THEN  -- USUARIO VISA ONLINE
	            SELECT COUNT(1), max(id_documento) INTO STRICT l_contar, l_id_documento_fin FROM FIN_DOCUMENTO_DEPTO
		        WHERE ID_ENTIDAD = P_ID_ENTIDAD
		        AND ID_DEPTO = P_ID_DEPTO
		        AND ID_COMPROBANTE = l_id_comprobante;
		
		         if l_contar <> 1 THEN
		         	l_error := 1;
                	l_msgerror := 'Alto! Solo debe haber un documento activo de depósitos para el usuario VISA. [tipo de documento: '||l_id_comprobante||']';
--                 	GOTO salida_rapida;
		         END IF;
		
            ELSE 
            	l_contar := pkg_sales_fc_verificar_serie_numero(P_ID_PERSONA,l_id_comprobante,P_ID_ENTIDAD, P_ID_DEPTO);
             	if l_contar <> 1 THEN
		         	l_error := 1;
                	l_msgerror := 'Alto! Solo debe haber un punto de impresión activo de depósitos para el usuario. (Cantidad: '||l_contar || '); [tipo de documento: '||l_id_comprobante||']';
--                 	GOTO salida_rapida;
		         END IF;
            END IF;
            --========================= CONFIG TO VISA ONLINE=====================================
            
                    SELECT 
                count(1), max(din.ID_DINAMICA)
                into STRICT l_contar, l_id_dinamica_cli_sal_ini
                FROM eliseo.CONTA_DINAMICA din, eliseo.TIPO_TRANSACCION tra, eliseo.TIPO_GRUPO_CONTA conta
                WHERE din.ID_TIPOTRANSACCION = tra.ID_TIPOTRANSACCION
                AND tra.ID_TIPOGRUPOCONTA = conta.ID_TIPOGRUPOCONTA
                AND din.ID_ENTIDAD = P_ID_ENTIDAD
                AND din.ID_ANHO = P_ID_ANHO
                AND din.ID_DEPTO IN ('0',P_ID_DEPTO)
                AND din.ID_MODULO = 14
                AND conta.CODIGO = 'DS';

                if l_contar <> 1
                then
                    L_ERROR :=1;
                    L_MSGERROR := 'Alto! La cantidad de dinámicas configuradas para Clientes Saldo Inicial debe de ser 1 ('||l_contar||' dinámicas)';
--                     GOTO salida_rapida;
                end if;
            
            SELECT   count(*) into STRICT l_contar FROM CONTA_VOUCHER_CONFIG
                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                AND ID_DEPTO =P_ID_DEPTO
                AND ID_MODULO = '14' -- módulo tesorería
                -- AND ID_MODULO = '13'--modulo ventas
                AND ID_ANHO = P_ID_ANHO
                and ID_TIPOASIENTO=P_ID_TIPOASIENTO
                AND AUTOMATICO='S'
                AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;

            if l_contar < 1 then
                l_error:=1;
                l_msgerror:='Alto: No existe la configuración de vouchers para los depósitos, del periodo '||P_ID_ANHO::text||'-'||P_ID_TIPOASIENTO;
--                 GOTO salida_rapida;
            elsif l_contar > 1 then
                l_error:=1;
                l_msgerror:='Alto: Existe más de una configuración de vouchers para los depósitos, del periodo '||P_ID_ANHO::text;
--                 GOTO salida_rapida;
            end if;

          --goto salida_rapida;
          if l_error=0 then
            select lpad(l_correlativo::text,8,'0') into STRICT l_numero;
            SELECT (
                    CASE P_ID_MEDIOPAGO WHEN '006' THEN
                        CASE WHEN P_ID_PERSONA = 2 THEN
                            'APP:'||l_serie||'-'||(l_numero)::numeric ||'-'||CASE WHEN L_ID_TIPOTARJETA=1 THEN 'VISA' WHEN L_ID_TIPOTARJETA=2 THEN 'MASTERCARD' WHEN L_ID_TIPOTARJETA=3 THEN 'DINERS CLUB' WHEN L_ID_TIPOTARJETA=4 THEN 'AMERICAN EXPRESS' END ||'-Oper:'||P_OPERACION||'-'||TO_CHAR(clock_timestamp(),'DD/MM/YY')||'-'||P_GLOSA
                        ELSE
                            'POS:'||l_serie||'-'||(l_numero)::numeric ||'-'||CASE WHEN L_ID_TIPOTARJETA=1 THEN 'VISA' WHEN L_ID_TIPOTARJETA=2 THEN 'MASTERCARD' WHEN L_ID_TIPOTARJETA=3 THEN 'DINERS CLUB' WHEN L_ID_TIPOTARJETA=4 THEN 'AMERICAN EXPRESS' END ||'-Oper:'||P_OPERACION||'-'||TO_CHAR(clock_timestamp(),'DD/MM/YY')||'-'||P_GLOSA
                        END
                    WHEN '001' THEN
                    'DREC:'||l_serie||'-'||(l_numero)::numeric ||'-'||TO_CHAR(clock_timestamp(),'DD/MM/YY')||'-(Oper:'||P_OPERACION||'-'||TO_CHAR(P_FECHA_OP,'DD/MM/YY')||'-'||COALESCE(l_cuenta_bancaria,'')||')-'||P_GLOSA
                    WHEN '008' THEN
                    'EFEC:'||l_serie||'-'||(l_numero)::numeric ||'-'||TO_CHAR(clock_timestamp(),'DD/MM/YY')||'-'||P_GLOSA
                    WHEN '999' THEN
                    '-Dep:'||l_serie||'-'||(l_numero)::numeric ||'-'||TO_CHAR(clock_timestamp(),'DD/MM/YY')||'-'||'A/C-'||P_GLOSA
                    ELSE 'DEPOSITO CLIENTES' END )
                     as GLOSA INTO STRICT L_GLOSA
;

            --========================= CONFIG TO VISA ONLINE=====================================
            -- Obtiene numero y serie y actualiza correlativo
           IF P_ID_PERSONA = 2 THEN  -- USUARIO VISA ONLINE
           		CALL pkg_sales_sp_obtener_serie_numero_fijo(l_id_documento_fin,l_serie,l_correlativo);
           ELSE
           		pkg_sales_school_sp_obtener_serie_numero(P_ID_PERSONA,l_id_comprobante,P_ID_ENTIDAD,P_ID_DEPTO, l_serie,l_correlativo);
           END IF;
          --========================= CONFIG TO VISA ONLINE=====================================
           
            -- Obtener voucher.
            CALL pkg_accounting_sp_crear_voucher(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,clock_timestamp(),P_ID_TIPOASIENTO,L_ID_TIPOVOUCHER,null, 'S', P_ID_PERSONA, l_id_voucher);

      
            /*
            if l_id_voucher=0 then
                l_error:=2; --no existe voucher
                l_msgerror:='Depósito:--> No existe voucher'||P_ID_ENTIDAD||' - '||P_ID_DEPTO||' - '||P_ID_ANHO||' - '||P_ID_MES||' - '||P_ID_TIPOASIENTO||' - '||P_ID_PERSONA;
            end if;
            */
            
            INSERT INTO CAJA_DEPOSITO(
              ID_ENTIDAD, 
              ID_DEPTO, 
              ID_ANHO, 
              ID_MES, 
              ID_VOUCHER, 
              ID_MEDIOPAGO, 
              ID_PERSONA, 
              ID_CLIENTE, 
              ID_TIPOTRANSACCION,
              ID_MONEDA,
              ID_DINAMICA,
              ID_VALE,
              ID_TIPOTARJETA,
              ID_CTABANCARIA,
              SERIE,
              NUMERO,
              FECHA,
              IMPORTE, 
              IMPORTE_ME,
              TIPOCAMBIO,
              GLOSA, 
              NOMBRE_DEP, 
              DOCUMENTO_DEP,
              ESTADO,
              FECHA_OPERACION,
              NRO_OPERACION
            )VALUES ( 
              P_ID_ENTIDAD, 
              P_ID_DEPTO, 
              P_ID_ANHO, 
              P_ID_MES, 
              l_id_voucher, 
              P_ID_MEDIOPAGO, 
              P_ID_PERSONA, 
              P_ID_CLIENTE, 
              P_ID_TIPOTRANSACCION,
              P_ID_MONEDA,
              P_ID_DINAMICA,
              L_ID_VALE,
              L_ID_TIPOTARJETA,
              L_ID_CTABANCARIA,
              l_serie,
              l_numero,
              l_fecha,
              P_IMPORTE, 
              P_IMPORTE_ME,
              P_TIPOCAMBIO,
              --P_GLOSA,
              SUBSTR(L_GLOSA,0,1000), 
              SUBSTR(P_NOMBRE_DEP,0,50), 
              P_DOCUMENTO_DEP,
              l_estado,
              P_FECHA_OP,
              P_OPERACION
            ) RETURNING ID_DEPOSITO INTO l_deposito;

            /*
            SELECT MAX(ID_DEPOSITO) INTO l_deposito FROM CAJA_DEPOSITO 
                WHERE ID_ENTIDAD= P_ID_ENTIDAD 
                    AND ID_DEPTO=P_ID_DEPTO AND ID_ANHO=P_ID_ANHO 
                    AND ID_MES=P_ID_MES AND ID_VOUCHER=l_id_voucher 
                    AND ID_PERSONA=P_ID_PERSONA;*/
            
            --l_error:=1; --no existe voucher
            --l_msgerror:=l_deposito;
            --goto salida_rapida;
            
            /*if P_IMPORTE_TARJETA>0 and l_error=0 then --ya no se usa, solo se registra en caja_deposito
                pkg_caja_sp_crear_deposito_banco(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO , P_ID_MES ,l_deposito, P_ID_DINAMICA ,P_ID_MONEDA,P_ID_CTABANCARIA, P_ID_TIPOTARJETA,
                                    P_ID_PERSONA,P_ID_MEDIOPAGO,P_OPERACION,l_fecha,P_IMPORTE_TARJETA,P_IMPORTE_ME,P_TIPOCAMBIO,
                                    P_GLOSA,P_ID_TIPOASIENTO,l_estado,l_error,l_msgerror);
            end if;*/
            
            if coalesce(length(P_VENTAS),0)>0 and l_error=0 then
                RAISE NOTICE 'P_VENTAS = %', P_VENTAS;
                RAISE NOTICE 'P_IMP_VENTAS = %', P_IMP_VENTAS;
                RAISE NOTICE 'P_ID_MONEDA = %', P_ID_MONEDA;
                RAISE NOTICE 'P_TIPOCAMBIO = %', P_TIPOCAMBIO;
                RAISE NOTICE 'P_ID_DINAMICA = %', P_ID_DINAMICA;

                
                pkg_caja_school_sp_crear_deposito_detalle(l_deposito,P_VENTAS,P_IMP_VENTAS,P_ARTICULOS, P_ID_MONEDA,P_TIPOCAMBIO,P_ID_DINAMICA,l_error,l_msgerror);

                if l_error = 1 then 
--                     GOTO salida_rapida;
                end if;

                select coalesce(sum(importe),0) into STRICT l_importedet from caja_deposito_detalle
                where id_deposito=l_deposito;


                if P_IMPORTE<>l_importedet then
                    l_error:=1;
                    l_msgerror:='Depósito: Importe depósito('||P_IMPORTE::text||') es diferente a la suma de importe de los doc ('||l_importedet::text||') pagados';
--                     goto salida_rapida;
                end if;

            end if;

            l_importeasiento:=P_IMPORTE;

            if coalesce(P_IMPORTE_TARJETA,0)>0 then
                l_importeasiento:=0;
            end if;

            if coalesce(P_IMPORTE_TRANS,0)>0 then
                l_importeasiento:=0;
            end if;
            if l_error=0  then

                update caja_deposito set estado = '1', SERIE = l_serie, NUMERO = l_correlativo, ID_VOUCHER = l_id_voucher
            where id_deposito=l_deposito;

               pkg_caja_school_sp_generar_asiento_deposito(l_deposito,P_ID_DINAMICA,l_id_dinamica_cli_sal_ini,P_ID_CTABANCARIA,l_importeasiento,P_IMPORTE_TARJETA,P_IMPORTE_TRANS,L_GLOSA,l_error,l_msgerror);

            end if;

          end if;

--           <<salida_rapida>>
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;
         P_ID_DEPOSITO:= l_deposito;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_crear_deposito (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_MEDIOPAGO text,P_ID_PERSONA bigint, P_ID_CLIENTE bigint,P_VENTAS text,P_IMP_VENTAS text, P_ARTICULOS text, P_ID_TIPOTRANSACCION bigint,P_ID_MONEDA bigint,P_ID_DINAMICA bigint,P_ID_TIPOTARJETA bigint,P_ID_CTABANCARIA bigint, P_OPERACION text,P_FECHA_OP timestamp(0),P_IMPORTE bigint,P_IMPORTE_TARJETA bigint,P_IMPORTE_TRANS bigint,P_IMPORTE_ME bigint,P_TIPOCAMBIO bigint,P_GLOSA text,P_NOMBRE_DEP text, P_DOCUMENTO_DEP text,P_ID_TIPOASIENTO text,P_ERROR out bigint,P_MSGERROR out text,P_ID_VALE integer default NULL,P_ID_DEPOSITO OUT bigint) FROM PUBLIC;
