-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_dev_venta (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_dinamica bigint;
        l_asiento bigint;
        l_id_persona bigint;
        l_detalle varchar(100);
        l_detalle_in varchar(100);
        l_base decimal(10,2);
        l_igv decimal(10,2);
        l_descuento decimal(10,2);
        l_importe decimal(10,2);
        l_id_articulo decimal(10,2);
        l_correlativo decimal(10,2); --Add by @vitmar
        l_es_credito varchar(1);
        l_precio_alm decimal(10,2);
        l_ctas varchar(200);
        l_deptos varchar(200);
        l_ctates varchar(200);

        l_actas tablastring;
        l_adeptos tablastring;
        l_actates tablastring;

        l_id_asiento bigint;
        l_id_parent bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_destino varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);

        l_id_asientod bigint;
        l_id_tipopland bigint;
        l_id_restricciond varchar(50);
        l_id_cuentaaasid varchar(10);
        l_dcd varchar(1);
        l_id_indicadord  varchar(35);
        l_unicod varchar(1);
        l_porcentajed decimal(10,2);
        l_unicoctated varchar(1);

        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_count_cuenta_cte bigint;
        l_fondo varchar(10);
        l_importeasiento decimal(10,2);
        l_importe_cheque decimal(10,2);
        l_importe_trans decimal(10,2);
        l_descripcion varchar(255);
        l_memo varchar(255);
        l_voucher varchar(10);
        l_ref_id varchar(100);

        l_id_entidad bigint;
        l_id_depto_pago varchar(20);
        l_buscar bigint;

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_operorigen bigint:=5;

        --validacion
        l_contar bigint;
        l_debito decimal(10,2);
        l_credito decimal(10,2);
        l_cont bigint;
        l_serie varchar(5);
        l_numero varchar(15);
        l_fecha timestamp(0);
        l_agrupa varchar(1);
        --l_id_cliente numeric;
        l_id_ctabancaria bigint;
        l_id_mediopago varchar(4);
        l_doc_anticipo varchar(20);
        l_pgasto bigint;
        l_tipoorigen bigint;
        l_id_venta bigint;

        l_id_vdetalle_venta bigint;
        l_id_tipoorigen_venta bigint;

        l_id_dinamica_cli_sal_ini bigint;
        l_id_anho bigint;
        l_id_cliente bigint;

        cdet_sal_ini CURSOR FOR	
        SELECT  ID_DINAMICA,ID_ENTIDAD
        FROM CONTA_DINAMICA 
        WHERE ID_DINAMICA=l_id_dinamica_cli_sal_ini;

        cdet CURSOR FOR	
        SELECT 
        A.ID_PVENTA, A.ID_VENTA AS ID_ORIGEN, A.ID_TIPOORIGEN,A.ID_DINAMICA,A.ID_CLIENTE, SUBSTR((B.ID_ENTIDAD || '-' || ' Clientes'), 1, 50),A.IMPORTE,
        A.ID_ARTICULO,
        0 as CORRELATIVO, 'N' AS ES_CREDITO
        FROM CAJA_PAGO_VENTA A INNER JOIN VENTA B ON A.ID_VENTA=B.ID_VENTA
        WHERE A.ID_PAGO = P_ID_PAGO;

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA, a.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =l_dinamica
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        
BEGIN
            
            l_detalle:='';--P_DETALLE;
            l_detalle_in:='';--P_DETALLE Ya preparado para guardar;
            
            -- OBTIENE DATOS DEL PAGO
            SELECT id_anho, ID_ENTIDAD,ID_DEPTO,ID_CTABANCARIA,ID_VOUCHER,ID_MEDIOPAGO,CASE WHEN ID_MEDIOPAGO='008' THEN 7 WHEN ID_MEDIOPAGO='007' THEN 8 WHEN ID_MEDIOPAGO='001' THEN 9 END
            into STRICT l_id_anho, l_id_entidad,l_id_depto_pago, l_id_ctabancaria,l_voucher,l_id_mediopago,l_id_operorigen 
            FROM CAJA_PAGO WHERE ID_PAGO=P_ID_PAGO;

            select id_cliente into STRICT l_id_cliente from caja_pago_venta where id_pago = P_ID_PAGO;

            -- DINAMICA CLIENTE SALDO ANTERIORO
           SELECT 
            count(1), max(din.ID_DINAMICA)
            into STRICT l_contar, l_id_dinamica_cli_sal_ini
            FROM eliseo.CONTA_DINAMICA din, eliseo.TIPO_TRANSACCION tra, eliseo.TIPO_GRUPO_CONTA conta
            WHERE din.ID_TIPOTRANSACCION = tra.ID_TIPOTRANSACCION
            AND tra.ID_TIPOGRUPOCONTA = conta.ID_TIPOGRUPOCONTA
            AND din.ID_ENTIDAD = l_id_entidad
            AND din.ID_ANHO = l_id_anho
            AND din.ID_DEPTO IN ('0',l_id_depto_pago)
            AND din.ID_MODULO = 14
            AND conta.CODIGO = 'DS';

            if l_contar <> 1
            then
                L_ERROR :=1;
                L_MSGERROR := 'Alto! La cantidad de dinámicas configuradas para Clientes Saldo Inicial debe de ser 1 ('||l_contar||' dinámicas)';
--                 GOTO salida_rapida;
            end if;
                
            -- DETALLE
            OPEN cdet;
            FETCH cdet INTO l_pgasto, l_id_venta, l_tipoorigen,l_dinamica,l_id_persona,l_detalle, l_importe, l_id_articulo, l_correlativo, l_es_credito;
            WHILE cdet%FOUND LOOP
                l_memo :=l_tipoorigen || '-' || l_pgasto;

                OPEN casi;
                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                WHILE casi%FOUND LOOP

                    l_detalle_in := SUBSTR(l_id_entidad || '-' || l_correlativo || '-' || l_detalle || '-' || SUBSTR(FC_NOMBRE_PERSONA(l_id_persona),1,100), 1,50);

                    select case when l_id_indicador='IMPORTE' then (l_importe)*(l_porcentaje)
                              else
                              0
                              end into STRICT l_importeasiento
;

                    l_depto:=null;
                    l_cuenta_cte:=null;

                    if l_unico='U' then
                        select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                    elsif (l_unico='X') then
                        select pkg_sales_school_fc_depto_alumno_school_inst(l_id_cliente, l_id_entidad, l_id_depto_pago) into STRICT l_depto;
                        -- select FC_DEPTO_CLIENTE(l_id_persona) into l_depto from dual;
                    ELSIF l_unico='S' THEN  -- Si es sesión
                        l_depto := l_id_depto_pago;
                    END IF;

                    if l_unicoctate='U' then
                        select  count(1) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                        if l_cont>0 then
                            if l_id_mediopago = '008' then  -- Efectivo
                                select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                            else
                                SELECT ID_TIPOCTACTE, ID_CUENTAAASI into STRICT l_cuenta_cte, l_id_cuentaaasi FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;
                            end if;
                        end if;
                    elsif (l_unicoctate='B') then
                        SELECT ID_TIPOCTACTE, ID_CUENTAAASI into STRICT l_cuenta_cte, l_id_cuentaaasi FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;
                    elsif (l_unicoctate='X') then
                        SELECT pkg_caja_fc_ruc(l_id_persona) into STRICT l_cuenta_cte;
                    end if;
                    
                
                    if l_dc='C' then
                        l_importeasiento:=l_importeasiento*(-1);
                    end if;

                    select count(*) into STRICT l_cont from CONTA_ASIENTO
                    where ID_TIPOORIGEN=l_tipoorigen
                    and ID_ORIGEN=l_pgasto
                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                    and CUENTA =l_id_cuentaaasi
                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                    AND voucher=l_voucher
                    and case when importe>0 then 'D' else 'C' end=l_dc;
                	
                   	RAISE NOTICE '.... l_importeasiento ';
    				RAISE NOTICE 'l_importeasiento = %', l_importeasiento::text;
    				RAISE NOTICE 'l_id_cuentaaasi = %', l_id_cuentaaasi::text;
                    if l_importeasiento<>0 THEN
                    	RAISE NOTICE 'l_cont = %', l_cont::text;
                        if l_cont=0 then
                        --if l_cont=0 and l_agrupa = 'N' then 
                            INSERT INTO CONTA_ASIENTO(
                                ID_TIPOORIGEN,
                                ID_ORIGEN,
                                FONDO,
                                DEPTO,
                                CUENTA, 
                                CUENTA_CTE,
                                RESTRICCION,
                                IMPORTE,
                                DESCRIPCION,
                                MEMO,
                                VOUCHER, 
                                PARENT_ID,
                                REF_ID,
                                AGRUPA
                            )VALUES ( 
                                l_tipoorigen,
                                l_pgasto,
                                l_fondo,
                                l_depto,
                                l_id_cuentaaasi,
                                l_cuenta_cte,
                                l_id_restriccion,
                                l_importeasiento,
                                l_detalle_in,
                                l_memo,
                                l_voucher,
                                null,
                                l_ref_id,
                                l_agrupa
                            );
                        else

                            update CONTA_ASIENTO set IMPORTE=l_importeasiento
                            where ID_TIPOORIGEN=l_tipoorigen
                            and ID_ORIGEN=l_pgasto
                            and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                            and CUENTA =l_id_cuentaaasi
                            and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                            and case when importe>0 then 'D' else 'C' end=l_dc;
                        end if;
                    end if;

                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                END LOOP;
                CLOSE casi;
                
                -- CONTRA PARTIDA
/*
                l_importeasiento := l_importeasiento*-1;
                SELECT ID_VDETALLE, ID_TIPOORIGEN INTO l_id_vdetalle_venta, l_id_tipoorigen_venta FROM VENTA_DETALLE WHERE ID_VENTA=l_id_venta AND ID_ARTICULO=l_id_articulo;

                SELECT CUENTA, FONDO, DEPTO, CUENTA_CTE, RESTRICCION, AGRUPA INTO l_id_cuentaaasi, l_fondo, l_depto, l_cuenta_cte, l_id_restriccion, l_agrupa
                FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = l_id_tipoorigen_venta AND ID_ORIGEN=l_id_vdetalle_venta AND PRIMARIO='S' AND ROWNUM = 1;
                
                INSERT INTO CONTA_ASIENTO (
                    ID_TIPOORIGEN,ID_ORIGEN, FONDO, DEPTO, CUENTA, 
                    CUENTA_CTE, RESTRICCION, IMPORTE, DESCRIPCION,
                    MEMO, VOUCHER, PARENT_ID, REF_ID, AGRUPA
                    )VALUES ( 
                    l_tipoorigen,
                    l_pgasto,
                    l_fondo,
                    l_depto,
                    l_id_cuentaaasi,
                    l_cuenta_cte,
                    l_id_restriccion,
                    l_importeasiento,
                    l_detalle_in,
                    l_memo,
                    l_voucher,
                    null,
                    null,
                    l_agrupa 
                    );
*/
                    
-- *******************************************************
--     INICIO DINAMICA SAL INI
-- *******************************************************
SELECT count(1) into STRICT l_contar FROM VENTA_SALDO s
            WHERE ID_VENTA = l_id_venta
            and s.id_anho = l_id_anho;

            if l_contar > 0 then 
            
                    OPEN cdet_sal_ini;
                    FETCH cdet_sal_ini INTO l_dinamica,l_id_entidad;

                    WHILE cdet_sal_ini%FOUND LOOP
                    
                        ---DINAMICA ASIENTO
                        OPEN casi;

                        FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                        WHILE casi%FOUND LOOP

                           SELECT '('||serie||'-'||numero||')' into STRICT l_doc_anticipo FROM VENTA_SALDO s
                            WHERE ID_VENTA = l_id_venta
                            and s.id_anho = l_id_anho;

                            select case when l_id_indicador='IMPORTE' then (l_importe)*(l_porcentaje)
                                      else
                                      0
                                      end into STRICT l_importeasiento
;

                            l_depto:=null;
                            l_cuenta_cte:=null;

                            if l_importeasiento<>0 then
                            
                                if l_unico='U' then
                                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                                elsif (l_unico='M') then
                                   SELECT position('|' in l_deptos) into STRICT l_buscar;
                                   if l_buscar>0 then
                                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                     select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                                     select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasi) into STRICT l_depto;
                                   else
                                    l_depto:=l_deptos;
                                   end if;
                                elsif (l_unico='X') then
                                   select pkg_sales_school_fc_depto_alumno_school_inst(l_id_cliente, l_id_entidad, l_id_depto_pago) into STRICT l_depto;
                                elsif l_unico='S' THEN  -- Si es sesión
                                    l_depto := l_id_depto_pago;
                                end if;

                                if l_unicoctate='U' then
                                  select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                                  if l_cont>0 then
                                    select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                                  end if;
                                elsif (l_unicoctate='M') then
                                   SELECT position('|' in l_ctates) into STRICT l_buscar;
                                   if l_buscar>0 then
                                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                     select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                                     select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                                   else
                                    l_cuenta_cte:=l_ctates;
                                   end if;
                                elsif (l_unicoctate='X') then
                                    select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente and id_tipodocumento = 1;
                                elsif (l_unicoctate='B') then --LA CTA CTE SE OBTIENE DEL LA CTA BANCARIA
                                    --SELECT ID_TIPOCTACTE into l_cuenta_cte FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = P_ID_CTABANCARIA;
                                    SELECT ID_TIPOCTACTE, ID_CUENTAAASI into STRICT l_cuenta_cte, l_id_cuentaaasi FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;
                                end if;

                                -- Comentado porque genera asientos en el c cuando tambien caja está al crédito
                                -- if l_dc='C' then
                                --  l_importeasiento:=l_importeasiento*(-1);
                                -- end if;
                            
                                select count(1) into STRICT l_cont from CONTA_ASIENTO
                                where ID_TIPOORIGEN=l_tipoorigen
                                and ID_ORIGEN=l_pgasto
                                and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                                and CUENTA =l_id_cuentaaasi
                                and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                                and case when importe>0 then 'D' else 'C' end=l_dc;

                            
                              if l_cont=0 then
                                INSERT INTO CONTA_ASIENTO(
                                ID_TIPOORIGEN,
                                ID_ORIGEN, 
                                FONDO,
                                DEPTO,
                                CUENTA, 
                                CUENTA_CTE,
                                RESTRICCION,
                                IMPORTE,
                                DESCRIPCION,
                                MEMO,
                                VOUCHER, 
                                PARENT_ID,
                                REF_ID,
                                AGRUPA
                                )VALUES ( 
                                l_tipoorigen,
                                l_pgasto,
                                l_fondo,
                                l_depto,
                                l_id_cuentaaasi,
                                l_cuenta_cte,
                                l_id_restriccion,
                                l_importeasiento,
                                l_doc_anticipo||'-'||l_descripcion,
                                l_memo,
                                l_voucher,
                                null,
                                l_ref_id ,
                                l_agrupa
                                );
                              else

                                update CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                                where ID_TIPOORIGEN=l_tipoorigen
                                and ID_ORIGEN=l_pgasto
                                and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                                and CUENTA =l_id_cuentaaasi
                                and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                                and case when importe>0 then 'D' else 'C' end=l_dc;

                              end if;
                            end if;

                            FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                          END LOOP;
                          CLOSE casi;
                        FETCH cdet_sal_ini INTO l_dinamica,l_id_entidad;
                        END LOOP;
                        CLOSE cdet_sal_ini;
                        
                ELSE
                    -- CONTRA PARTIDA ***********
                    l_importeasiento := l_importeasiento*-1;
                    SELECT max(ID_VDETALLE), max(ID_TIPOORIGEN) INTO STRICT l_id_vdetalle_venta, l_id_tipoorigen_venta FROM VENTA_DETALLE WHERE ID_VENTA=l_id_venta AND ID_ARTICULO=l_id_articulo;

                    SELECT CUENTA, FONDO, DEPTO, CUENTA_CTE, RESTRICCION, AGRUPA INTO STRICT l_id_cuentaaasi, l_fondo, l_depto, l_cuenta_cte, l_id_restriccion, l_agrupa
                    FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = l_id_tipoorigen_venta AND ID_ORIGEN=l_id_vdetalle_venta AND PRIMARIO='S'  LIMIT 1;

                    INSERT INTO CONTA_ASIENTO(
                        ID_TIPOORIGEN,ID_ORIGEN, FONDO, DEPTO, CUENTA, 
                        CUENTA_CTE, RESTRICCION, IMPORTE, DESCRIPCION,
                        MEMO, VOUCHER, PARENT_ID, REF_ID, AGRUPA
                        )VALUES ( 
                        l_tipoorigen,
                        l_pgasto,
                        l_fondo,
                        l_depto,
                        l_id_cuentaaasi,
                        l_cuenta_cte,
                        l_id_restriccion,
                        l_importeasiento,
                        l_detalle_in,
                        l_memo,
                        l_voucher,
                        null,
                        null,
                        l_agrupa 
                        );

                END IF;


-- *******************************************************
--     FIN DINAMICA SAL INI
-- *******************************************************
                    

            FETCH cdet INTO l_pgasto, l_id_venta, l_tipoorigen,l_dinamica,l_id_persona,l_detalle, l_importe, l_id_articulo, l_correlativo, l_es_credito;
            END LOOP;
            CLOSE cdet;

            select count(*) into STRICT l_contar from CONTA_ASIENTO
            where ID_TIPOORIGEN=l_tipoorigen
            and ID_ORIGEN=l_pgasto;

--         <<salida_rapida>>
            P_ERROR:=l_error;
            P_MSGERROR:=l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_dev_venta (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
