-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_inter_dev (P_ID_PAGO bigint) AS $body$
DECLARE


        l_contar bigint;
        L_GENERAR_INTER varchar(1);
        L_ID_DEPTO varchar(20);

        pagoventas CURSOR FOR		
        SELECT *
        FROM caja_pago_venta a
        WHERE a.id_pago =P_ID_PAGO;

        
BEGIN
        
        L_GENERAR_INTER := 'S';

        SELECT ID_DEPTO, case when id_entidad in (
        7124,
        7722,
        7322,
        7422,
        7522,
        7022,
        72122,
        7922
        ) then 'N' else 'S' end 
        INTO STRICT L_ID_DEPTO, L_GENERAR_INTER
        FROM CAJA_PAGO
        WHERE ID_PAGO = P_ID_PAGO;

        if L_GENERAR_INTER = 'S' then 
        
            FOR pagoventa in pagoventas
            LOOP
                select count(1) into STRICT l_contar from (
                    SELECT distinct depto from eliseo.conta_asiento 
                    where id_tipoorigen in (9)
                    and id_origen = pagoventa.id_pventa 
                ) alias2;

                if l_contar >1 then 
                    insert into conta_asiento                
                    SELECT id_asiento, id_tipoorigen, id_origen, fondo, L_ID_DEPTO,
                    '2136080', 
                    depto
                    , '0A', 
                    importe as importe, 'Asiento por Interdepartamento', memo, voucher, parent_id, ref_id, 'S', importe_me, 'N'
                    --select *  
                    from conta_asiento a
                    
                    where id_tipoorigen = 9
                    and id_origen = pagoventa.id_pventa
                    and importe > 0
                    and cuenta not in ('1136080','2136080') 
                    
union all
 
                    SELECT id_asiento, id_tipoorigen, id_origen, fondo, depto,
                    '1136080', 
                    L_ID_DEPTO
                    , '0A', 
                    importe*-1, 'Asiento por Interdepartamento', memo, voucher, parent_id, ref_id, 'S', importe_me, 'N'
                    from conta_asiento a
                    
                    where id_tipoorigen = 9
                    and id_origen = pagoventa.id_pventa
                    and importe > 0
                    and cuenta not in ('1136080','2136080') 
                    order by id_origen, importe
;
                end if;
            end loop;
        end if;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_inter_dev (P_ID_PAGO bigint) FROM PUBLIC;
