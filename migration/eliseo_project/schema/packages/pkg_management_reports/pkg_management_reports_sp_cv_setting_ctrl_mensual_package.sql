-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_management_reports,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_management_reports_sp_cv_setting_ctrl_mensual (P_IDS_ARCHIVO_MENSUAL text, P_ID_MES_INI bigint, P_ID_MES_FIN bigint,P_ID_ANHO bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

	
	L_COUNT bigint  := 0;
	L_ERROR bigint  := 0;
    L_MSGERROR varchar(100) :='';
   	L_ID_MES bigint;

   	L_FECHA_LIMITE timestamp(0);
    L_COUNT_EXIST bigint  := 0;

	
  ARCHIVO_MENSUAL RECORD;
  meses RECORD;

BEGIN
	IF coalesce(P_ID_MES_FIN::text, '') = '' OR P_ID_MES_FIN = 0 THEN

    	FOR ARCHIVO_MENSUAL IN (SELECT * FROM ELISEO.ARCHIVO_MENSUAL am
		INNER JOIN(WITH RECURSIVE cte AS (
SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) ID_ARCHIVO_MENSUAL
		 (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) 
		is not NULL  UNION ALL
SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) ID_ARCHIVO_MENSUAL 
		 (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) 
		is not NULL JOIN cte c ON ()

) SELECT * FROM cte)p ON am.ID_ARCHIVO_MENSUAL = p.ID_ARCHIVO_MENSUAL )
        LOOP
        	
			SELECT REPLACE( TO_CHAR( to_date(ARCHIVO_MENSUAL.FECHA_LIMITE,'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD HH24:MI:SS'), 
			CONCAT(CONCAT('-',lpad(EXTRACT(MONTH FROM to_date(ARCHIVO_MENSUAL.FECHA_LIMITE,'YYYY-MM-DD HH24:MI:SS') )::text,2,0)),'-'),
			('-'||lpad(P_ID_MES_INI,2,0)||'-')) INTO STRICT L_FECHA_LIMITE
			;
		
			SELECT pkg_management_reports_fc_total_archivos(ARCHIVO_MENSUAL.ID_EMPRESA,
			P_ID_ANHO, P_ID_MES_INI, ARCHIVO_MENSUAL.ID_TIPOARCHIVO,
			ARCHIVO_MENSUAL.ID_ENTIDAD, ARCHIVO_MENSUAL.ID_DEPTO) INTO STRICT L_COUNT_EXIST
			;
			
			IF L_COUNT_EXIST = 0 THEN 
-- 				<<INSERT_ARCHIVO_MENSUAL>>
	        	BEGIN
		        	INSERT INTO ELISEO.ARCHIVO_MENSUAL(
		        	ID_EMPRESA,ID_ANHO,ID_MES,ID_TIPOARCHIVO,
		        	FECHA_LIMITE,ID_ENTIDAD,ID_DEPTO)
		        	VALUES (ARCHIVO_MENSUAL.ID_EMPRESA,
		        	P_ID_ANHO,P_ID_MES_INI,
		        	ARCHIVO_MENSUAL.ID_TIPOARCHIVO, L_FECHA_LIMITE, 
		        	ARCHIVO_MENSUAL.ID_ENTIDAD, ARCHIVO_MENSUAL.ID_DEPTO);
	        	EXCEPTION WHEN OTHERS THEN
	            L_ERROR := 1;
	            L_MSGERROR := 'Registro Fallido. Copia Archivo Mensual';
	            RETURN;
	        	END;
        	END IF;
        END LOOP ARCHIVO_MENSUAL;

    
    
		
	ELSE
		FOR ARCHIVO_MENSUAL IN (
		SELECT * FROM ELISEO.ARCHIVO_MENSUAL am
		INNER JOIN(WITH RECURSIVE cte AS (
SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) ID_ARCHIVO_MENSUAL 
		 (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) 
		is not NULL  UNION ALL
SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) ID_ARCHIVO_MENSUAL 
		 (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_ARCHIVO_MENSUAL, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (level - 1) ) 
		is not NULL JOIN cte c ON ()

) SELECT * FROM cte)p ON am.ID_ARCHIVO_MENSUAL = p.ID_ARCHIVO_MENSUAL  
        )
        LOOP
        
			FOR meses IN (
			SELECT ID_MES FROM ELISEO.CONTA_MES cm WHERE ID_MES 
			BETWEEN P_ID_MES_INI AND P_ID_MES_FIN ORDER BY cm.ID_MES desc 
			)
			LOOP
				 
				SELECT REPLACE( TO_CHAR( to_date(ARCHIVO_MENSUAL.FECHA_LIMITE,'YYYY-MM-DD HH24:MI:SS'), 'YYYY-MM-DD HH24:MI:SS'), 
				CONCAT(CONCAT('-',lpad(EXTRACT(MONTH FROM to_date(ARCHIVO_MENSUAL.FECHA_LIMITE,'YYYY-MM-DD HH24:MI:SS') )::text,2,0)),'-'),
				('-'||lpad(meses.ID_MES,2,0)||'-')) INTO STRICT L_FECHA_LIMITE
				;
				
				SELECT pkg_management_reports_fc_total_archivos(ARCHIVO_MENSUAL.ID_EMPRESA,
				P_ID_ANHO, meses.ID_MES, ARCHIVO_MENSUAL.ID_TIPOARCHIVO,
				ARCHIVO_MENSUAL.ID_ENTIDAD, ARCHIVO_MENSUAL.ID_DEPTO) INTO STRICT L_COUNT_EXIST
				;
			
				IF L_COUNT_EXIST = 0 THEN
-- 					<<INSERT_ARCHIVO_MENSUAL_OP2>>
	        		BEGIN
						INSERT INTO ELISEO.ARCHIVO_MENSUAL(
			        	ID_EMPRESA,ID_ANHO,ID_MES,ID_TIPOARCHIVO,
			        	FECHA_LIMITE,ID_ENTIDAD,ID_DEPTO)
			        	VALUES (ARCHIVO_MENSUAL.ID_EMPRESA,
			        	P_ID_ANHO,meses.ID_MES,
			        	ARCHIVO_MENSUAL.ID_TIPOARCHIVO, L_FECHA_LIMITE, 
			        	ARCHIVO_MENSUAL.ID_ENTIDAD, ARCHIVO_MENSUAL.ID_DEPTO);
		        	EXCEPTION WHEN OTHERS THEN
	            	L_ERROR := 1;
	            	L_MSGERROR := 'Registro Fallido. Copia Archivo Mensual OP2';
	            	RETURN;
	        		END;
        		END IF;

			END LOOP meses;

        END LOOP ARCHIVO_MENSUAL;
	END IF;
	P_ERROR := L_ERROR;
    P_MSGERROR := L_MSGERROR;
   	END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_management_reports_sp_cv_setting_ctrl_mensual (P_IDS_ARCHIVO_MENSUAL text, P_ID_MES_INI bigint, P_ID_MES_FIN bigint,P_ID_ANHO bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
