-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_management_reports,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_management_reports_fc_gastos_esenciales (P_ID_ENTIDAD bigint,P_ID_ANHO bigint, P_ID_MES bigint) RETURNS bigint AS $body$
DECLARE

   	L_SALDO decimal(10,2):=0.00;
   	
BEGIN
	
	   SELECT sum(GA.SALDO) INTO STRICT L_SALDO FROM (	
	   SELECT ID_ANHO,ID_MES,round((SUM(SALDO))::numeric,2) AS SALDO 
				        FROM (SELECT ID_ANHO,ID_MES, coalesce(SALDO,0) AS SALDO
						        FROM (SELECT ID_ANHO,ID_MES,SAL1+SAL2+SAL3+SAL4+SAL5+SAL6+SAL7+SAL8+SAL9+SAL10+SAL11+SAL12 AS SALDO
						                FROM (SELECT ID_ANHO,ID_MES,SUM(SALDO) AS SAL1,
						                    LAG(SUM(SALDO), 1, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL2,
						                    LAG(SUM(SALDO), 2, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL3,
						                    LAG(SUM(SALDO), 3, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL4,
						                    LAG(SUM(SALDO), 4, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL5,
						                    LAG(SUM(SALDO), 5, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL6,
						                    LAG(SUM(SALDO), 6, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL7,
						                    LAG(SUM(SALDO), 7, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL8,
						                    LAG(SUM(SALDO), 8, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL9,
						                    LAG(SUM(SALDO), 9, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL10,
						                    LAG(SUM(SALDO), 10, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL11,
						                    LAG(SUM(SALDO), 11, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL12
						                    FROM (SELECT ID_ANHO,ID_MES,round((SUM(SALDO))::numeric,2) AS SALDO
						                            FROM (SELECT GAOP.ID_ANHO,GAOP.ID_MES, SUM(GAOP.SALDO) AS SALDO 
						                                FROM (SELECT ID_ANHO,ID_MES,SUM(COS_VALOR)  AS SALDO
						                                        FROM VW_CONTA_DIARIO
						                                        WHERE ID_ENTIDAD = P_ID_ENTIDAD
						                                        AND ID_FONDO =10
						                                        AND ID_TIPOASIENTO NOT IN ('BB','EA')
						                                        AND ID_CUENTAAASI LIKE '41%'
						                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
						                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
						                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
						                                        GROUP BY ID_ANHO,ID_MES
						                                        
UNION ALL

						                                        SELECT ID_ANHO,ID_MES, -1*SUM(COS_VALOR)  AS SALDO
						                                        FROM VW_CONTA_DIARIO_ALL
						                                        WHERE ID_ENTIDAD = P_ID_ENTIDAD
						                                        AND ID_FONDO =10
						                                        AND ID_TIPOASIENTO NOT IN ('BB','EA')
						                                        AND ID_CUENTAAASI LIKE '419%'
						                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
						                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
						                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
						                                        GROUP BY ID_ANHO,ID_MES
						                                        
UNION ALL

						                                        SELECT ID_ANHO,ID_MES, -1*SUM(COS_VALOR)  AS SALDO
						                                        FROM VW_CONTA_DIARIO_ALL
						                                        WHERE ID_ENTIDAD = P_ID_ENTIDAD
						                                        AND ID_FONDO =10
						                                        AND ID_TIPOASIENTO NOT IN ('BB','EA')
						                                        AND ID_CUENTAAASI LIKE '4123%'
						                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
						                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
						                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
						                                        GROUP BY ID_ANHO,ID_MES
						                                        )GAOP 
						                                GROUP BY GAOP.ID_ANHO,GAOP.ID_MES
						                                
						                                
UNION ALL

                                                        SELECT ID_ANHO,ID_MES,SUM(COS_VALOR) AS SALDO
                                                        FROM VW_CONTA_DIARIO
                                                        WHERE ID_ENTIDAD =P_ID_ENTIDAD
                                                        AND ID_FONDO IN (10,25)
                                                        AND ID_TIPOASIENTO NOT IN ('EA')
                                                        AND ID_CUENTAAASI LIKE '4123%'
                                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
                                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
                                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
                                                        GROUP BY ID_ANHO,ID_MES
						                                ) alias85       
						                            GROUP BY ID_ANHO,ID_MES
						                            ) alias86 
						                    GROUP BY ID_ANHO,ID_MES
						                    ) alias87
						                 WHERE (ID_ANHO||LPAD(ID_MES,2,0))::numeric =(P_ID_ANHO || LPAD(P_ID_MES,2,0))::numeric   
						                )GODA 
						
						        
UNION ALL

						            ----subvenciones netas otros fondos (suma los doce ultimos meses y si sale negativo su saldo sera = 0)
						        SELECT ID_ANHO,ID_MES, CASE WHEN SALDO <0 THEN 0 ELSE coalesce(SALDO, 0) END SALDO 
						        FROM (SELECT ID_ANHO,ID_MES,SAL1+SAL2+SAL3+SAL4+SAL5+SAL6+SAL7+SAL8+SAL9+SAL10+SAL11+SAL12 AS SALDO
						                FROM (SELECT ID_ANHO,ID_MES,SUM(SALDO) AS SAL1,
						                    LAG(SUM(SALDO), 1, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL2,
						                    LAG(SUM(SALDO), 2, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL3,
						                    LAG(SUM(SALDO), 3, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL4,
						                    LAG(SUM(SALDO), 4, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL5,
						                    LAG(SUM(SALDO), 5, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL6,
						                    LAG(SUM(SALDO), 6, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL7,
						                    LAG(SUM(SALDO), 7, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL8,
						                    LAG(SUM(SALDO), 8, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL9,
						                    LAG(SUM(SALDO), 9, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL10,
						                    LAG(SUM(SALDO), 10, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL11,
						                    LAG(SUM(SALDO), 11, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL12
						                    FROM (SELECT ID_ANHO,ID_MES,round((SUM(SALDO))::numeric,2) AS SALDO
						                            FROM (SELECT SN.ID_ANHO,SN.ID_MES, SUM(SN.SALDO) AS SALDO 
						                                FROM (SELECT ID_ANHO,ID_MES, SUM(COS_VALOR)  AS SALDO
						                                        FROM VW_CONTA_DIARIO_ALL
						                                        WHERE ID_ENTIDAD = P_ID_ENTIDAD
						                                        AND ID_FONDO =10
						                                        AND ID_TIPOASIENTO NOT IN ('BB','EA')
						                                        AND ID_CUENTAAASI LIKE '419%'
						                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
						                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
						                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
						                                        GROUP BY ID_ANHO,ID_MES
						                                        
UNION ALL

						                                        SELECT ID_ANHO,ID_MES, SUM(COS_VALOR)  AS SALDO
						                                        FROM VW_CONTA_DIARIO_ALL
						                                        WHERE ID_ENTIDAD = P_ID_ENTIDAD
						                                        AND ID_FONDO =10
						                                        AND ID_TIPOASIENTO NOT IN ('BB','EA')
						                                        AND ID_CUENTAAASI LIKE '319%'
						                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
						                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
						                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
						                                        GROUP BY ID_ANHO,ID_MES
						                                    )SN 
						                                GROUP BY SN.ID_ANHO,SN.ID_MES
						                                ) alias153       
						                            GROUP BY ID_ANHO,ID_MES
						                            ) alias154 
						                    GROUP BY ID_ANHO,ID_MES
						                    ) alias155
						                 WHERE (ID_ANHO||LPAD(ID_MES,2,0))::numeric =(P_ID_ANHO || LPAD(P_ID_MES,2,0))::numeric   
						                )SN1 
						
						        
UNION ALL

						            --TRANS netas otros fondos (suma los doce ultimos meses y si sale negativo su saldo sera = 0)
						        SELECT ID_ANHO,ID_MES, CASE WHEN SALDO <0 THEN 0 ELSE coalesce(SALDO,0) END SALDO
						        FROM (SELECT ID_ANHO,ID_MES,SAL1+SAL2+SAL3+SAL4+SAL5+SAL6+SAL7+SAL8+SAL9+SAL10+SAL11+SAL12 AS SALDO
						                FROM (SELECT ID_ANHO,ID_MES,SUM(SALDO) AS SAL1,
						                    LAG(SUM(SALDO), 1, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL2,
						                    LAG(SUM(SALDO), 2, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL3,
						                    LAG(SUM(SALDO), 3, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL4,
						                    LAG(SUM(SALDO), 4, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL5,
						                    LAG(SUM(SALDO), 5, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL6,
						                    LAG(SUM(SALDO), 6, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL7,
						                    LAG(SUM(SALDO), 7, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL8,
						                    LAG(SUM(SALDO), 8, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL9,
						                    LAG(SUM(SALDO), 9, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL10,
						                    LAG(SUM(SALDO), 10, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL11,
						                    LAG(SUM(SALDO), 11, 0) OVER (ORDER BY ID_ANHO,ID_MES) AS SAL12
						                    FROM (SELECT ID_ANHO,ID_MES,round((SUM(SALDO))::numeric,2) AS SALDO
						                            FROM (SELECT TNOF.ID_ANHO,TNOF.ID_MES, SUM(TNOF.SALDO) AS SALDO 
						                                FROM (SELECT ID_ANHO,ID_MES, SUM(COS_VALOR)  AS SALDO
						                                        FROM VW_CONTA_DIARIO_ALL
						                                        WHERE ID_ENTIDAD = P_ID_ENTIDAD
						                                        AND ID_FONDO =10
						                                        AND ID_TIPOASIENTO NOT IN ('BB','EA')
						                                        AND ID_CUENTAAASI = 6400001
						                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
						                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
						                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
						                                        GROUP BY ID_ANHO,ID_MES
						                                        
UNION ALL

						                                        SELECT ID_ANHO,ID_MES, SUM(COS_VALOR)  AS SALDO
						                                        FROM VW_CONTA_DIARIO_ALL
						                                        WHERE ID_ENTIDAD =P_ID_ENTIDAD
						                                        AND ID_FONDO =10
						                                        AND ID_TIPOASIENTO NOT IN ('BB','EA')
						                                        AND ID_CUENTAAASI = 6300001
						                                        AND (ID_ANHO||LPAD(ID_MES,2,0))::numeric  BETWEEN 
						                                        ((P_ID_ANHO)::numeric -1 || LPAD('01',2,0))::numeric  
						                                        AND (P_ID_ANHO||LPAD((P_ID_MES)::numeric ,2,0))::numeric  
						                                        GROUP BY ID_ANHO,ID_MES
						                                        )TNOF 
						                                GROUP BY TNOF.ID_ANHO,TNOF.ID_MES
						                                ) alias221       
						                            GROUP BY ID_ANHO,ID_MES
						                            ) alias222 
						                    GROUP BY ID_ANHO,ID_MES
						                    ) alias223
						                 WHERE (ID_ANHO||LPAD(ID_MES,2,0))::numeric =(P_ID_ANHO || LPAD(P_ID_MES,2,0))::numeric   
						                )TNOF1 
						                ) alias229 GROUP BY ID_ANHO,ID_MES
						               )GA;
						
			RETURN(L_SALDO);
        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_management_reports_fc_gastos_esenciales (P_ID_ENTIDAD bigint,P_ID_ANHO bigint, P_ID_MES bigint) FROM PUBLIC;
