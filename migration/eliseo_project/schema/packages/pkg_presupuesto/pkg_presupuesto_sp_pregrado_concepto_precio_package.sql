-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_pregrado_concepto_precio (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;
    l_id_evento bigint;

BEGIN
  
    SELECT COALESCE(MAX(ID_CONCEPTO_PRECIO),0) INTO STRICT l_contar FROM PSTO_PREGRADO_CONCEPTO_PRECIO;

    select id_evento  into STRICT l_id_evento from psto_evento where id_auxiliar=P_ID_AUXILIAR;

  
    INSERT INTO PSTO_PREGRADO_CONCEPTO_PRECIO(
      ID_CONCEPTO_PRECIO,
      ID_ACTIVIDAD, 
      ID_ENTIDAD,
      ID_DEPTO_PADRE,
      ID_ANHO,
      IMPORTE_I,
      IMPORTE_II,
      IMPORTE_BECA_I,
      IMPORTE_BECA_II,
      TIPO,
      ID_AUXILIAR
    )
    SELECT 
      row_number() OVER () + l_contar AS ID_CONCEPTO_PRECIO,
      M.ID_ACTIVIDAD, 
      P_ID_ENTIDAD,
      P_ID_DEPTO_PADRE,
      P_ID_ANHO,
      M.IMPORTEUNIT1,
      M.IMPORTEUNIT2,
      M.IMPORTEUNIT1,
      M.IMPORTEUNIT2,
      M.TIPO,
      P_ID_AUXILIAR
    FROM (
      SELECT 
      CASE WHEN A.ESDESCUENTO='S' THEN 'D' ELSE 'M' END AS TIPO,
      A.ID_ACTIVIDAD, 
      P_ID_ENTIDAD,
      coalesce(A.IMPORTEUNIT1,0) as IMPORTEUNIT1,
      coalesce(A.IMPORTEUNIT2,0) as IMPORTEUNIT2
      FROM PSTO_ACTIVIDAD A
      WHERE A.ESTADO='1'
      AND ID_EVENTO=l_id_evento
      AND A.ID_ACTIVIDAD NOT IN (
        SELECT B.ID_ACTIVIDAD FROM PSTO_PREGRADO_CONCEPTO_PRECIO B
        WHERE B.ID_ENTIDAD=P_ID_ENTIDAD
        AND B.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
        AND B.ID_ANHO=P_ID_ANHO
        AND B.ID_AUXILIAR=P_ID_AUXILIAR
      )   ORDER BY A.ID_ACTIVIDAD
    )M;

  
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_pregrado_concepto_precio (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
