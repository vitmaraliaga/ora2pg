-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_residencia_proceso (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;

BEGIN
    
      SELECT COALESCE(MAX(ID_PREGRADO_PROCESO),0) INTO STRICT l_contar FROM PSTO_PREGRADO_PROCESO;

      INSERT INTO PSTO_PREGRADO_PROCESO(
      ID_PREGRADO_PROCESO,
      ID_ENTIDAD,
      ID_DEPTO,
      ID_ANHO,
      ID_DEPTO_PADRE,
      ID_EAP_DEPTO_AREA,
      ID_AUXILIAR,
      TOTAL_ENSE_I,--CUOTA I 
      TOTAL_ENSE_II, --CUOTA II
      IMP_MAT,--Costo Diario Resid
      CREDITO_1,--Costo Diario Alim
      CREDITO_2_5,--Costo Diario Lavander√≠a
      TOTAL_HORAS_I,-- DIAS I
      TOTAL_HORAS_II,--DIAS II
      TOTAL_ALUMNO_I,
      TOTAL_ALUMNO_II
      )
      SELECT 
        row_number() OVER () + l_contar AS ID_PREGRADO_PROCESO,
        P_ID_ENTIDAD, 
        ID_DEPTO,
        P_ID_ANHO,
        P_ID_DEPTO_PADRE,
        ID_EAP_DEPTO_AREA,
        P_ID_AUXILIAR,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0
      FROM (
        SELECT
        ID_EAP_DEPTO_AREA,
        ID_DEPTO,
        ID_EAP
        FROM VW_DPTO_EAP 
        WHERE ID_TIPO_DEPTO='RE' 
        AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
        AND ID_ENTIDAD=P_ID_ENTIDAD
        AND ID_EAP_DEPTO_AREA NOT IN (
          SELECT ID_EAP_DEPTO_AREA FROM PSTO_PREGRADO_PROCESO
          WHERE ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_ANHO=P_ID_ANHO
          AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
          AND ID_AUXILIAR=P_ID_AUXILIAR
        ) AND ESTADO='1' 
        ) alias2 
        ORDER BY ID_DEPTO,ID_EAP_DEPTO_AREA;

        
        CALL pkg_presupuesto_sp_residencia_concepto(P_ID_ENTIDAD,P_ID_DEPTO_PADRE,P_ID_ANHO,P_ID_AUXILIAR,l_error,l_msgerror);

      P_ERROR:=l_error;
      P_MSGERROR:=l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_residencia_proceso (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
