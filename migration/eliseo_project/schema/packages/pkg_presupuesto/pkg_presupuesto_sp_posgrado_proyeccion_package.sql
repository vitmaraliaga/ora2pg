-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_posgrado_proyeccion (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ID_DEPTO text,P_ID_EAP bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='';
      l_contar bigint;
      l_nombre varchar(255);
      l_id_proyeccion bigint;
      l_id_pregrado_proceso bigint;

BEGIN
  
      SELECT NOMBRE INTO STRICT l_nombre FROM CONTA_ENTIDAD_DEPTO WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO=P_ID_DEPTO;

      SELECT COUNT(*) INTO STRICT l_contar FROM PSTO_PREGRADO_PROYECCCION
      WHERE ID_ENTIDAD=P_ID_ENTIDAD
      AND ID_ANHO=P_ID_ANHO
      AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
      AND ID_DEPTO=P_ID_DEPTO
      AND ID_EAP=P_ID_EAP
      AND ID_AUXILIAR=P_ID_AUXILIAR;

      IF l_contar=0 THEN
      
        select coalesce(max(ID_PROYECCION),0)+1 into STRICT l_id_proyeccion from PSTO_PREGRADO_PROYECCCION;

        insert into PSTO_PREGRADO_PROYECCCION(
                  ID_PROYECCION,
                  ID_ENTIDAD,
                  ID_DEPTO,
                  ID_ANHO,
                  ID_DEPTO_PADRE,
                  CICLO,
                  INCREMENTO,
                  AFECTA_INCREMENTO,
                  CANTIDAD_I,
                  CANTIDAD_II,
                  CREDITO_I,
                  CREDITO_II,
                  DISERCION_I,
                  DISERCION_II,
                  HORAS_I,
                  HORAS_II,
                  BECA,
                  ID_AUXILIAR,
                  ID_EAP_DEPTO_AREA,
                  ID_EAP,
                  NOM_DEPTO
                )values (
                  l_id_proyeccion,
                  P_ID_ENTIDAD,
                  P_ID_DEPTO,
                  P_ID_ANHO,
                  P_ID_DEPTO_PADRE,
                  0,--CICLO,
                  NULL,--INCREMENTO,
                  NULL,--AFECTA_INCREMENTO,
                  0,--CANTIDAD_I,
                  0,--CANTIDAD_II,
                  0,--CREDITO_I,
                  0,--CREDITO_II,
                  0,--DISERCION_I,
                  0,--DISERCION_II,
                  0,--HORAS_I,
                  0,--HORAS_II,
                  NULL,--BECA,
                  P_ID_AUXILIAR,
                  NULL,--ID_EAP_DEPTO_AREA,
                  P_ID_EAP,
                  l_nombre
                );

    
    
          ----PROCESO PREGRADO
          
          SELECT COUNT(*) INTO STRICT l_contar FROM PSTO_PREGRADO_PROCESO  
          WHERE ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_ANHO=P_ID_ANHO
          AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
          AND ID_DEPTO=P_ID_DEPTO
          AND ID_AUXILIAR=P_ID_AUXILIAR;

          IF l_contar=0 THEN
          
            SELECT COALESCE(MAX(ID_PREGRADO_PROCESO),0)+1 INTO STRICT l_id_pregrado_proceso FROM PSTO_PREGRADO_PROCESO;

            INSERT INTO PSTO_PREGRADO_PROCESO(
              ID_PREGRADO_PROCESO,
              ID_ENTIDAD,
              ID_DEPTO,
              ID_ANHO,
              ID_DEPTO_PADRE,
              ARMADA,
              IMP_MAT,
              CREDITO_1,
              CREDITO_2_5,
              TOTALCREDITO_1_I,
              TOTALCREDITO_2_5_I,
              TOTAL_ALUMNO_I,
              TOTALCREDITO_1_II,
              TOTALCREDITO_2_5_II,
              TOTAL_ALUMNO_II,
              TOTAL_HORAS_I ,
              TOTAL_HORAS_II ,
              CONVOCA,
              ID_AUXILIAR,
              NOM_DEPTO
            )values (
              l_id_pregrado_proceso,
              P_ID_ENTIDAD,
              P_ID_DEPTO,
              P_ID_ANHO,
              P_ID_DEPTO_PADRE,
              0,--ARMADA,
              0,--IMP_MAT,
              0,--CREDITO_1,
              0,--CREDITO_2_5,
              0,--TOTALCREDITO_1_I,
              0,--TOTALCREDITO_2_5_I,
              0,--TOTAL_ALUMNO_I,
              0,--TOTALCREDITO_1_II,
              0,--TOTALCREDITO_2_5_II,
              0,--TOTAL_ALUMNO_II,
              0,--TOTAL_HORAS_I ,
              0,--TOTAL_HORAS_II ,
              null,--CONVOCA,
              P_ID_AUXILIAR,
              l_nombre
            );

            
            INSERT INTO PSTO_PREGRADO_PROCESO_CONCEPTO(
            ID_PREGRADO_PROCESO, 
            ID_CONCEPTO_PRECIO, 
            IMPORTE_I, 
            IMPORTE_II, 
            TOTAL_I, 
            TOTAL_II,
            TIPO
            )
            
             SELECT 
              P.ID_PREGRADO_PROCESO,
              C.ID_CONCEPTO_PRECIO,
              0 AS IMPORTE_I,
              0 AS IMPORTE_II,
              0 AS TOTAL_I,
              0 AS TOTAL_II,
              C.TIPO
              FROM PSTO_PREGRADO_CONCEPTO_PRECIO C,PSTO_PREGRADO_PROCESO P
              WHERE C.ID_ENTIDAD=P.ID_ENTIDAD
              AND C.ID_ANHO=P.ID_ANHO
              AND C.ID_DEPTO_PADRE=P.ID_DEPTO_PADRE
              AND C.ID_ENTIDAD=P_ID_ENTIDAD
              AND C.ID_ANHO=P_ID_ANHO
              AND C.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
              AND P.ID_PREGRADO_PROCESO=l_id_pregrado_proceso
              AND C.ID_AUXILIAR=P.ID_AUXILIAR
              AND P.ID_AUXILIAR=P_ID_AUXILIAR	
              ORDER BY P.ID_DEPTO,P.CONVOCA,C.ID_ACTIVIDAD;

        end if;
      ELSE
        l_error:=1;
        l_msgerror:='Ya esta asignado '||l_nombre;
      END IF;

      P_ERROR:=l_error;
      P_MSGERROR:=SUBSTR(l_msgerror,1,155);

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_posgrado_proyeccion (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ID_DEPTO text,P_ID_EAP bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
