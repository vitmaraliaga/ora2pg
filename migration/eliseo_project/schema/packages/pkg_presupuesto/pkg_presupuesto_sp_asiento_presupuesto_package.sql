-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_asiento_presupuesto (P_ID_PRESUPUESTO bigint,P_ID_PERSONA bigint) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='';
      l_contar bigint;
      l_id_asiento bigint;
      l_id_entidad bigint;
      l_id_anho bigint;
      l_id_persona bigint;
      l_descripcion varchar(200);
      l_total_ingreso decimal(10,2);
      l_total_gasto decimal(10,2);
      l_id_evento bigint;
      l_tipo_asiento varchar(2);

BEGIN
    
       SELECT count(*) into STRICT l_contar FROM PSTO_ASIENTO WHERE ID_PRESUPUESTO=P_ID_PRESUPUESTO  AND ESTADO='1';

       SELECT ID_ENTIDAD,ID_ANHO,DESCRIPCION,ID_EVENTO into STRICT l_id_entidad,l_id_anho,l_descripcion ,l_id_evento
       FROM PSTO_PRESUPUESTO WHERE ID_PRESUPUESTO=P_ID_PRESUPUESTO;

       SELECT COALESCE(TIPO_ASIENTO,'S') INTO STRICT l_tipo_asiento FROM PSTO_EVENTO WHERE ID_EVENTO=l_id_evento;

       if l_contar=0 then
           SELECT COALESCE(MAX(ID_ASIENTO),0)+1 INTO STRICT l_id_asiento FROM PSTO_ASIENTO;

           insert into PSTO_ASIENTO(
            ID_ASIENTO, 
            ID_ENTIDAD,
            ID_PRESUPUESTO,
            ID_ANHO,
            ID_PERSONA,
            DESCRIPCION,
            FECHA,
            ESTADO
           )values (
           l_id_asiento,
           l_id_entidad,
           P_ID_PRESUPUESTO,
           l_id_anho,
           P_ID_PERSONA,
           l_descripcion,
           clock_timestamp(),
           '1'
           );
       else
           SELECT ID_ASIENTO  INTO STRICT l_id_asiento FROM PSTO_ASIENTO WHERE ID_PRESUPUESTO=P_ID_PRESUPUESTO  AND ESTADO='1';

           DELETE FROM PSTO_ASIENTO_DET   WHERE ID_ASIENTO=l_id_asiento;

           update PSTO_ASIENTO set
           ID_PERSONA=l_id_persona,
           DESCRIPCION=l_descripcion,
           FECHA=clock_timestamp()
           where ID_ASIENTO=l_id_asiento;

        end if;

        
        insert into PSTO_ASIENTO_DET(
          ID_ASIENTO_DET,
          ID_ASIENTO, 
          ID_ENTIDAD,
          ID_DEPTO,
          TIPO, 
          ID_MES,
          ID_TIPOPLAN,
          ID_CUENTAAASI,
          ID_RESTRICCION,
          ID_CTACTE,
          ID_TIPOCTACTE,
          GLOSA,
          IMPORTE
        )
        SELECT 
         row_number() OVER () AS ID_ASIENTO_DET,
          l_id_asiento,
          M.ID_ENTIDAD,
          M.ID_DEPTO_ASIENTO,
          M.TIPO,
          M.ID_MES,
          M.ID_TIPOPLAN,
          M.ID_CUENTAAASI,
          M.ID_RESTRICCION,
          M.ID_CTACTE,
          M.ID_TIPOCTACTE, 
          M.NOMBRE,
          M.TOTAL
          FROM (
          SELECT 
            a.ID_ENTIDAD,
            a.ID_DEPTO_ASIENTO,
            a.TIPO,
            d.ID_MES,
            a.ID_TIPOPLAN,
            a.ID_CUENTAAASI,
            a.ID_RESTRICCION,
            a.ID_CTACTE,
            a.ID_TIPOCTACTE, 
            CASE WHEN l_tipo_asiento='S' THEN c.NOMBRE ELSE b.NOMBRE END as NOMBRE,
            COALESCE(sum(d.IMPORTE),0) AS TOTAL
            from PSTO_PRESUPUESTO_DET a,PSTO_PRESUPUESTO_DET_DIST d, PSTO_ACTIVIDAD b,PSTO_EVENTO C
            WHERE a.ID_PRESUPUESTO=D.ID_PRESUPUESTO
            AND a.ID_PRESUPUESTO_DET=D.ID_PRESUPUESTO_DET
            AND a.ID_ACTIVIDAD=b.ID_ACTIVIDAD
            AND b.ID_EVENTO=c.ID_EVENTO
            AND a.ID_PRESUPUESTO=P_ID_PRESUPUESTO
            AND a.TOTAL<>0
            GROUP BY a.ID_ENTIDAD,
            a.ID_DEPTO_ASIENTO,
            a.TIPO,
            d.ID_MES,
            a.ID_TIPOPLAN,
            a.ID_CUENTAAASI,
            a.ID_RESTRICCION,
            a.ID_CTACTE,
            a.ID_TIPOCTACTE, 
            CASE WHEN l_tipo_asiento='S' THEN c.NOMBRE ELSE b.NOMBRE END
            
        )M;

         select 
        coalesce(sum(case when tipo='I' then IMPORTE else 0 end),0),
        coalesce(sum(case when tipo='G' then IMPORTE else 0 end),0)
        into STRICT 
        l_total_ingreso,
        l_total_gasto
        from  PSTO_ASIENTO_DET
        where ID_ASIENTO=l_id_asiento;

        update PSTO_ASIENTO set
        TOTAL_INGRESO=l_total_ingreso,
        TOTAL_GASTO=l_total_gasto
        where ID_ASIENTO=l_id_asiento;
                
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_asiento_presupuesto (P_ID_PRESUPUESTO bigint,P_ID_PERSONA bigint) FROM PUBLIC;
