-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;

    -- 
CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_save_next_paso_run ( in_id_proceso bigint, in_id_operacion bigint, in_id_persona bigint, in_detalle text, in_numero bigint, in_revisado text, in_ip text, in_estado text, out_id_detalle out bigint, out_error out bigint, out_msgerror out text) AS $body$
DECLARE

        var_id_registro bigint;
        var_id_paso bigint;
        var_id_paso_next bigint;
        var_id_paso_next_flu bigint;
        var_error bigint;
        var_msgerror varchar(200);

BEGIN
            out_error := 0;
            out_msgerror := ' ';
            -- 
            select
              procrun.id_registro,
              procpasrun.id_paso,
              procpasrun.id_paso_next,
              procflu.id_paso_next
              into STRICT
              var_id_registro,
              var_id_paso,
              var_id_paso_next,
              var_id_paso_next_flu
            from process_run procrun
              inner join
              process_paso_run procpasrun
              on procrun.id_registro=procpasrun.id_registro
              and procrun.id_paso_actual=procpasrun.id_paso
              left join
              process_flujo procflu
              on procrun.id_proceso=procflu.id_proceso
              and procpasrun.id_paso_next=procflu.id_paso
            where procrun.id_proceso=in_id_proceso
              and procrun.id_operacion=in_id_operacion;
            -- 
            if coalesce(var_id_paso_next::text, '') = '' then
                out_error := 1;
                out_msgerror := 'No hay next-paso.';
--                 goto end_l_save_next_paso_run;
            end if;
            -- 
            CALL pkg_purchases_sp_insert_process_paso_run(
                var_id_registro,
                var_id_paso_next,
                in_id_persona,
                in_detalle,
                in_numero,
                in_revisado,
                in_ip,
                in_estado,
                var_id_paso_next_flu,
                out_id_detalle,
                var_error,
                var_msgerror);
            -- 
            if coalesce(var_id_paso_next::text, '') = '' then
                out_error := out_error+var_error;
                out_msgerror := out_msgerror || var_msgerror;
--                 goto end_l_save_next_paso_run;
            end if;
            -- 
            update process_run set id_paso_actual=var_id_paso_next
            where id_registro=var_id_registro;
            -- 
--             <<end_l_save_next_paso_run>>
            NULL;
            -- 
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_save_next_paso_run ( in_id_proceso bigint, in_id_operacion bigint, in_id_persona bigint, in_detalle text, in_numero bigint, in_revisado text, in_ip text, in_estado text, out_id_detalle out bigint, out_error out bigint, out_msgerror out text) FROM PUBLIC;
