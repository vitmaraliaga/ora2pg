-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_compras_ajustes (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ERROR OUT bigint,P_MSG OUT text) AS $body$
DECLARE


        L_AJUSTE bigint;
        L_ID_ANHO bigint := 2021;
        P_ID_MES bigint := 12;
        P_ID_COMPRA bigint;
        L_ID_COMPRA bigint;
        P_ID_PERSONA bigint :=4;
        L_ID_PROVEEDOR bigint;
        L_NUMERO varchar(8);
        ID_DINAMICA bigint := 4963;
        L_ID_MONEDA bigint;
        P_ID_VOUCHER bigint := 265206;
        L_TIPOORIGEN bigint :=4;
        P_FECHA timestamp(0) :='31/12/2021';
        P_IMPORTE bigint;
        P_IMPORTE_ME bigint;
        P_DC varchar(1) := '';
        P_ESTADO varchar(1) := '1';
        L_ID_SALDO bigint;
        P_DEPTO_D varchar(10);
        P_CUENTA_D varchar(10);
        P_CUENTA_CTE_D varchar(10);
        P_RESTRICCION_D varchar(10);
        P_DEPTO_C varchar(10);
        P_CUENTA_C varchar(10);
        P_CUENTA_CTE_C varchar(10);
        P_RESTRICCION_C varchar(10);
        P_DESCRIPCION varchar(100);
        L_ERROR bigint := 0;
        L_MSG varchar(100) := 'Success';
        L_CANT bigint;
        S_SIGNO bigint;

        COMPRAS CURSOR FOR	
        SELECT
                ID_COMPRA,ID_PROVEEDOR,IMPORTE,IMPORTE_ME
        FROM VW_PURCHASES_SALDO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_ANHO = L_ID_ANHO
        --AND ID_PROVEEDOR = 6890
        AND ID_COMPRA IN (1603)
        AND (IMPORTE+coalesce(IMPORTE_ME,0)) <> 0;

        
BEGIN
	        
            
            --GENERA EL AJUSTE Y SU ASIENTO
            OPEN COMPRAS;
                FETCH COMPRAS INTO P_ID_COMPRA,L_ID_PROVEEDOR,P_IMPORTE,P_IMPORTE_ME;
                WHILE COMPRAS%FOUND LOOP

                    IF coalesce(P_IMPORTE,0)+coalesce(P_IMPORTE_ME,0) > 0 THEN --DEUDA AL PROVEEDOR
                        P_DC := 'C';
                        S_SIGNO := -1;
                        P_DEPTO_D := '11010101';
                        P_CUENTA_D := '2130101';
                        P_CUENTA_CTE_D := '1';
                        P_RESTRICCION_D := '0A';

                        P_DEPTO_C := '11010101';
                        P_CUENTA_C := '2130101';
                        P_CUENTA_CTE_C := '1';
                        P_RESTRICCION_C := '0A';

                    ELSE  --EL PROVEEDOR NOS DEBE
                        P_DC := 'D';
                        S_SIGNO := 1;
                        P_DEPTO_D := '11010101';
                        P_CUENTA_D := '4126025';
                        P_CUENTA_CTE_D := '2';
                        P_RESTRICCION_D := '0E';

                        P_DEPTO_C := '11010101';
                        P_CUENTA_C := '2130101';
                        P_CUENTA_CTE_C := '1';
                        P_RESTRICCION_C := '0A';
                    END IF;

                    SELECT COUNT(1) INTO STRICT L_CANT FROM COMPRA
                    WHERE ID_COMPRA = P_ID_COMPRA
                    AND ID_PROVEEDOR =  L_ID_PROVEEDOR -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Perú
                    AND ID_ANHO = L_ID_ANHO;
                    IF L_CANT > 0 THEN
                        SELECT ID_MONEDA INTO STRICT L_ID_MONEDA FROM COMPRA
                        WHERE ID_COMPRA = P_ID_COMPRA
                        AND ID_PROVEEDOR = L_ID_PROVEEDOR  -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Perú
                        AND ID_ANHO = L_ID_ANHO;
                        L_ID_COMPRA := P_ID_COMPRA;
                        L_ID_SALDO := NULL;
                    ELSE
                        SELECT COUNT(1) INTO STRICT L_CANT FROM COMPRA_SALDO
                        WHERE ID_SALDO = P_ID_COMPRA
                        AND ID_PROVEEDOR = L_ID_PROVEEDOR -- is null then ID_PROVEEDOR else L_ID_PROVEEDOR end -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Perú
                        AND ID_ANHO = L_ID_ANHO;
                        IF L_CANT > 0 THEN
                            SELECT ID_MONEDA INTO STRICT L_ID_MONEDA FROM COMPRA_SALDO
                            WHERE ID_SALDO = P_ID_COMPRA
                            AND ID_PROVEEDOR = L_ID_PROVEEDOR  --is null then ID_PROVEEDOR else L_ID_PROVEEDOR end -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Perú
                            AND ID_ANHO = L_ID_ANHO;
                            L_ID_SALDO := P_ID_COMPRA;
                            L_ID_COMPRA := NULL;
                        ELSE
                            P_ERROR:=1;
                        END IF;
                    END IF;

                    SELECT LPAD(COALESCE(MAX((NUMERO)::numeric ),0)+1,8,0) INTO STRICT L_NUMERO FROM COMPRA_AJUSTE
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD
                    AND ID_DEPTO = P_ID_DEPTO;

                    SELECT COALESCE(MAX(ID_AJUSTE),0)+1 INTO STRICT L_AJUSTE FROM COMPRA_AJUSTE;
                                    
                    INSERT INTO COMPRA_AJUSTE( ID_AJUSTE,  ID_ENTIDAD, ID_DEPTO, ID_ANHO, ID_MES, ID_COMPRA, ID_PERSONA, ID_PROVEEDOR, ID_DINAMICA, ID_MONEDA, ID_VOUCHER, ID_TIPOORIGEN,
                            FECHA,  NUMERO,  IMPORTE, IMPORTE_ME, DC,  ESTADO, ID_SALDO
                    )VALUES (L_AJUSTE,P_ID_ENTIDAD,P_ID_DEPTO,L_ID_ANHO,P_ID_MES,L_ID_COMPRA,P_ID_PERSONA, L_ID_PROVEEDOR,ID_DINAMICA,L_ID_MONEDA, P_ID_VOUCHER,L_TIPOORIGEN,
                            P_FECHA,L_NUMERO,ABS(P_IMPORTE),ABS(P_IMPORTE_ME),P_DC,P_ESTADO,L_ID_SALDO
                    );

                    P_DESCRIPCION := '7124-1 Transf: '||L_NUMERO||', Castigo de Cuenta 2019';

                    --DEBITO
                    INSERT INTO CONTA_ASIENTO(ID_TIPOORIGEN, ID_ORIGEN, FONDO, DEPTO, CUENTA, CUENTA_CTE, RESTRICCION, IMPORTE, DESCRIPCION, VOUCHER, IMPORTE_ME,MEMO,AGRUPA)
                    VALUES (L_TIPOORIGEN, L_AJUSTE, 10, P_DEPTO_D, P_CUENTA_D, P_CUENTA_CTE_D, P_RESTRICCION_D, ABS(P_IMPORTE), P_DESCRIPCION, P_ID_VOUCHER, ABS(P_IMPORTE_ME),'','N');
                    --CRDITO
                    INSERT INTO CONTA_ASIENTO(ID_TIPOORIGEN, ID_ORIGEN, FONDO, DEPTO, CUENTA, CUENTA_CTE, RESTRICCION, IMPORTE, DESCRIPCION, VOUCHER, IMPORTE_ME,MEMO,AGRUPA)
                    VALUES (L_TIPOORIGEN, L_AJUSTE, 10, P_DEPTO_C, P_CUENTA_C, P_CUENTA_CTE_C, P_RESTRICCION_C, ABS(P_IMPORTE)*-1, P_DESCRIPCION, P_ID_VOUCHER, ABS(P_IMPORTE_ME)*-1,'','N');

                    FETCH COMPRAS INTO P_ID_COMPRA,L_ID_PROVEEDOR,P_IMPORTE,P_IMPORTE_ME;
                END LOOP;
            CLOSE COMPRAS;

--             <<salida_rapida>>
            P_ERROR := L_ERROR;
            P_MSG := L_MSG;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_compras_ajustes (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ERROR OUT bigint,P_MSG OUT text) FROM PUBLIC;
