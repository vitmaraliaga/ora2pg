-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_delete_pre_provision (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_PEDIDO bigint,P_ERROR OUT bigint,P_MSG OUT text) AS $body$
DECLARE

        L_ID_PROCESO bigint;
        L_ID_PCOMPRA bigint;
        L_ID_COMPRA bigint;
        L_ID_REGISTRO bigint;
        L_ESTADO varchar(1);
        L_CANT bigint;

        L_ERROR bigint := 0;
        L_MSG varchar(300) := 'Ok';

        
BEGIN
        
            SELECT COUNT(1), MAX(ID_PROCESO) INTO STRICT L_CANT, L_ID_PROCESO FROM PROCESS
            WHERE ID_ENTIDAD = P_ID_ENTIDAD
            AND CODIGO = 7;

            IF L_CANT = 0 THEN 
                L_ERROR :=1;
                L_MSG := 'ERROR: La entidad '|| P_ID_ENTIDAD || ' no tiene un proceso con cÃ³digo 7';
            END IF;

            SELECT 
                    COUNT(1) INTO STRICT L_CANT
            FROM PEDIDO_COMPRA
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            IF L_CANT > 0 THEN
                SELECT 
                    COUNT(1) INTO STRICT L_CANT 
                FROM PEDIDO_COMPRA
                WHERE ID_PEDIDO = P_ID_PEDIDO;
                IF L_CANT = 1 THEN
                    SELECT
                    ID_PCOMPRA,ID_COMPRA INTO STRICT L_ID_PCOMPRA,L_ID_COMPRA
                    FROM PEDIDO_COMPRA
                    WHERE ID_PEDIDO = P_ID_PEDIDO;
                ELSE
                    L_ERROR :=1;
                    L_MSG := 'ERROR: No se puede eliminar, Eliminar la Provision Temporal';
--                     goto salida_rapida;
                END IF;

            END IF;

            IF coalesce(L_ID_COMPRA::text, '') = '' THEN 
                L_CANT :=0;
            ELSE
                SELECT COUNT(1) L_CANT INTO STRICT L_ID_COMPRA
                FROM COMPRA
                WHERE ID_COMPRA = L_ID_COMPRA;
            END IF;

            IF L_CANT <> 0 THEN  --ELIMINAR TODO
                L_ERROR :=1;
                L_MSG := 'ERROR: No se puede eliminar, Eliminar la Provision';
--                 goto salida_rapida;
            END IF;

            
            
            --PEDIDO_COMPRA
            DELETE FROM PEDIDO_COMPRA_DETALLE
            WHERE ID_PCOMPRA = L_ID_PCOMPRA;

            DELETE FROM PROYECTO_COMPRA
            WHERE ID_PCOMPRA = L_ID_PCOMPRA;

            DELETE FROM PEDIDO_COMPRA
            WHERE ID_PCOMPRA = L_ID_PCOMPRA;

            --PEDIDO
            DELETE FROM PEDIDO_DETALLE
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            DELETE FROM PEDIDO_COTIZACION
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            SELECT COUNT(1) INTO STRICT L_CANT
            FROM COMPRA_ORDEN
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            IF L_CANT > 0 THEN
                DELETE FROM COMPRA_ORDEN_DETALLE
                WHERE ID_ORDEN IN (SELECT ID_ORDEN FROM COMPRA_ORDEN WHERE ID_PEDIDO = P_ID_PEDIDO);

                DELETE FROM COMPRA_ORDEN
                WHERE ID_PEDIDO = P_ID_PEDIDO;
            END IF;

            
            DELETE FROM PEDIDO_FILE
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            DELETE FROM PEDIDO_ASIENTO
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            DELETE FROM PEDIDO_REGISTRO
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            -- L_ERROR :=1;
             -- L_MSG := L_ID_PROCESO;
             -- goto salida_rapida;
            
            --PROCESS
            SELECT ID_REGISTRO INTO STRICT L_ID_REGISTRO 
            FROM PROCESS_RUN
            WHERE ID_PROCESO = L_ID_PROCESO
            AND ID_OPERACION = P_ID_PEDIDO;

            DELETE FROM PROCESS_PASO_RUN
            WHERE ID_REGISTRO = L_ID_REGISTRO;

            DELETE FROM PROCESS_RUN
            WHERE ID_PROCESO = L_ID_PROCESO
            AND ID_OPERACION = P_ID_PEDIDO;

--             <<salida_rapida>>
            P_ERROR := L_ERROR;
            P_MSG := L_MSG;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_delete_pre_provision (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_PEDIDO bigint,P_ERROR OUT bigint,P_MSG OUT text) FROM PUBLIC;
