-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_purchases_fc_format_glosa_assinet_ajuste (P_ID_ASIENTO bigint) RETURNS varchar AS $body$
DECLARE

        L_GLOSA_2 varchar(255);
        L_DESCRIPCION_2 varchar(100):='';

BEGIN 
        Begin 
            select  
                      (CASE
                    WHEN LENGTH(pkg_purchases_fc_ruc(Cj.ID_PROVEEDOR)) <= 11 THEN pkg_purchases_fc_ruc(Cj.ID_PROVEEDOR)
                    ELSE SUBSTR(pkg_purchases_fc_ruc(Cj.ID_PROVEEDOR), 1, 11)
                    END || '/' ||
                CASE
                    WHEN LENGTH((select serie||'-'||numero from compra where id_compra = coalesce(cj.id_compra,cs.id_compra) )) <= 13 THEN (select serie||'-'||numero from compra where id_compra = coalesce(cj.id_compra,cs.id_compra) )
                    ELSE SUBSTR(  (select serie||'-'||numero from compra where id_compra = coalesce(cj.id_compra,cs.id_compra) ), 1, 13)
                    END || '/' ||
                CASE
                    WHEN LENGTH(coalesce(cd.DETALLE,(select pr.motivo from pedido_compra pc,pedido_registro pr  where pc.id_compra=coalesce(cj.id_compra,cs.id_compra) and pc.id_pedido=pr.id_pedido  ))) <= 33 THEN SUBSTR(    cd.DETALLE,1,33)
                    ELSE SUBSTR( coalesce(cd.DETALLE,(select pr.motivo from pedido_compra pc,pedido_registro pr  where pc.id_compra=coalesce(cj.id_compra,cs.id_compra) and pc.id_pedido=pr.id_pedido  )), 1, 33)
                    END) 
                  INTO STRICT L_DESCRIPCION_2 
                FROM ELISEO.CONTA_ASIENTO ca
                inner join compra_ajuste cj on ca.id_origen =  cj.id_ajuste
                left join compra cx on cx.id_compra  = cj.id_compra
                left join compra_saldo cs on cs.id_saldo  =  cj.id_saldo
                left join COMPRA_DETALLE cd on cd.id_compra = cx.id_compra or cd.id_compra =  cs.id_compra
                             WHERE  ca.id_asiento = P_ID_ASIENTO
                              AND (ca.CUENTA LIKE '1%' OR ca.CUENTA LIKE '2%')   LIMIT 1;
        EXCEPTION WHEN no_data_found THEN
            L_DESCRIPCION_2 := null;
        END;
        L_GLOSA_2 := L_DESCRIPCION_2;
        RETURN(L_GLOSA_2);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_purchases_fc_format_glosa_assinet_ajuste (P_ID_ASIENTO bigint) FROM PUBLIC;
