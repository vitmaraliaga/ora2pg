-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_delete_compra_kardex (P_ID_COMPRA bigint,P_ERROR OUT bigint,P_MSG OUT text) AS $body$
DECLARE

        L_ID_KARDEX bigint;
        L_ID_ANHO bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_ID_TIPOORIGEN bigint;

        L_ERROR bigint := 0;
        L_MSG varchar(100) := 'Success';

        articulos CURSOR FOR	
        SELECT 
        ID_KARDEX,ID_ALMACEN,ID_ANHO,ID_ARTICULO
        FROM INVENTARIO_KARDEX
        WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND ID_ORIGEN IN (SELECT ID_DETALLE FROM COMPRA_DETALLE WHERE ID_COMPRA = P_ID_COMPRA);

        
BEGIN
	        
	        -- L_ERROR := 1;
	        -- L_MSG := 'Hola mungo';
	        SELECT MAX(ID_TIPOORIGEN) INTO STRICT L_ID_TIPOORIGEN
            FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;

            --ELIMINA KARDEX DE LA COMPRA
            OPEN articulos;
                FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ANHO,L_ID_ARTICULO;
                WHILE articulos%FOUND LOOP
                    DELETE FROM INVENTARIO_KARDEX
                    WHERE ID_KARDEX = L_ID_KARDEX;

                    UPDATE INVENTARIO_ALMACEN_ARTICULO SET ESTADO = '1'
                    WHERE ID_ALMACEN = L_ID_ALMACEN
                    AND ID_ARTICULO = L_ID_ARTICULO
                    AND ID_ANHO = L_ID_ANHO;

                    FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ANHO,L_ID_ARTICULO;
                END LOOP;
            CLOSE articulos;

--             <<salida_rapida>>
            P_ERROR := L_ERROR;
            P_MSG := L_MSG;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_delete_compra_kardex (P_ID_COMPRA bigint,P_ERROR OUT bigint,P_MSG OUT text) FROM PUBLIC;
