-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_compra_costo_vinculado (P_ID_COMPRA bigint) AS $body$
DECLARE

        L_TOTAL_CANTIDAD decimal(10,2);
        L_TOTAL_COSTO_VINCULADO decimal(10,2);
        L_COSTO_VINCULADO decimal(10,2);
        L_ID_DETALLE bigint;
        L_CANTIDAD decimal(10,2);

        CUR_DETALLE CURSOR FOR
        SELECT ID_DETALLE,CANTIDAD 
        FROM COMPRA_DETALLE
        WHERE ID_COMPRA = P_ID_COMPRA
        AND (ID_ARTICULO IS NOT NULL AND ID_ARTICULO::text <> '');
        	

BEGIN   
        --ACTUALIZA COSTOS VINCULADOS
        SELECT SUM(CANTIDAD) INTO STRICT L_TOTAL_CANTIDAD 
        FROM COMPRA_DETALLE
        WHERE ID_COMPRA = P_ID_COMPRA;

        SELECT SUM(BASE) INTO STRICT L_TOTAL_COSTO_VINCULADO
        FROM COMPRA_DETALLE
        WHERE ID_COMPRA = P_ID_COMPRA 
        AND (ES_COSTO_VINCULADO IS NOT NULL AND ES_COSTO_VINCULADO::text <> '');
        
        OPEN CUR_DETALLE;
            FETCH CUR_DETALLE INTO L_ID_DETALLE,L_CANTIDAD;
            WHILE CUR_DETALLE%FOUND LOOP

                SELECT
                        L_CANTIDAD/L_TOTAL_CANTIDAD*L_TOTAL_COSTO_VINCULADO INTO STRICT L_COSTO_VINCULADO
;

                UPDATE COMPRA_DETALLE SET COSTO_VINCULADO = L_COSTO_VINCULADO
                WHERE ID_DETALLE = L_ID_DETALLE;

            FETCH CUR_DETALLE INTO L_ID_DETALLE,L_CANTIDAD;
            END LOOP;
        CLOSE CUR_DETALLE;
        --FIN DE ACTUALIZACION COSTO VINCULADOS
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_compra_costo_vinculado (P_ID_COMPRA bigint) FROM PUBLIC;
