-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_update_ajuste (P_ID_AJUSTE bigint,P_ERROR OUT bigint,P_MSG OUT text) AS $body$
DECLARE

        L_ID_VOUCHER bigint;	
        L_TIPOORIGEN bigint :=4; --COMPRA TRANSFERENCIA O AJUS 
        L_IMPORTE bigint :=0;

        
BEGIN
            P_ERROR :=0;
            SELECT 
                    SUM(IMPORTE) INTO STRICT L_IMPORTE
            FROM CONTA_ASIENTO
            WHERE ID_TIPOORIGEN = L_TIPOORIGEN
            AND ID_ORIGEN = P_ID_AJUSTE;
            IF L_IMPORTE = 0 THEN
                
                SELECT ID_VOUCHER INTO STRICT L_ID_VOUCHER 
                FROM COMPRA_AJUSTE
                WHERE ID_AJUSTE = P_ID_AJUSTE;

                UPDATE COMPRA_AJUSTE SET ESTADO = '1'
                WHERE ID_AJUSTE = P_ID_AJUSTE;

                UPDATE CONTA_ASIENTO SET VOUCHER = L_ID_VOUCHER
                WHERE ID_TIPOORIGEN = L_TIPOORIGEN
                AND ID_ORIGEN = P_ID_AJUSTE;
                P_ERROR:=0;
                P_MSG :='OK';
            ELSE
                P_ERROR:=1;
                P_MSG :='ERROR: Los Asientos NO Cuadran';
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_update_ajuste (P_ID_AJUSTE bigint,P_ERROR OUT bigint,P_MSG OUT text) FROM PUBLIC;
