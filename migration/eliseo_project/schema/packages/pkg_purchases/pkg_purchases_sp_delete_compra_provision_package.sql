-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_delete_compra_provision (P_ID_ARREGLO bigint,P_ERROR OUT bigint,P_MSG OUT text) AS $body$
DECLARE

        L_ID_COMPRA bigint;
        L_ID_VOUCHER bigint;	
        L_CANT bigint :=0;
        L_ESTADO varchar(1) :='0';
        L_ACTIVO varchar(1);
        L_ID_KARDEX bigint;
        L_ID_ANHO bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_ID_TIPOORIGEN bigint;
        L_ID_PCOMPRA bigint;
        L_ID_PEDIDO bigint;
        L_ID_PROCESO bigint;

	    L_ID_ENTIDAD bigint;
        L_TIPOARREGLO bigint;
        L_ID_REGISTRO bigint;
        L_GLOSA varchar(500);
        L_ID_PEDIDO_NEW bigint;

        L_ERROR bigint := 0;
        L_MSG varchar(100) := '';

        L_ID_ORDEN bigint;

        articulos CURSOR FOR	
        SELECT 
        ID_KARDEX,ID_ALMACEN,ID_ANHO,ID_ARTICULO
        FROM INVENTARIO_KARDEX
        WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND ID_ORIGEN IN (SELECT ID_DETALLE FROM COMPRA_DETALLE WHERE ID_COMPRA = L_ID_COMPRA);

        
BEGIN
            SELECT ID_ENTIDAD,
            ID_TIPOARREGLO,ID_ORIGEN INTO STRICT L_ID_ENTIDAD, L_TIPOARREGLO, L_ID_COMPRA
            FROM ARREGLO
            WHERE ID_ARREGLO =P_ID_ARREGLO;

           
            IF L_TIPOARREGLO <> 3 THEN  --TIPO ARREGLO = ELIMINAR
	        	L_ERROR:= 1;
	            L_MSG := 'ERROR: El tipo de Arreglo no es para Eliminar';
-- 	            GOTO salida_rapida;
	        END IF;

            
            SELECT COUNT(1), MAX(ID_VOUCHER), MAX(ESTADO), MAX(ID_TIPOORIGEN) INTO STRICT L_CANT, L_ID_VOUCHER, L_ESTADO, L_ID_TIPOORIGEN
            FROM COMPRA WHERE ID_COMPRA = L_ID_COMPRA;

            IF L_CANT=0 THEN
            	UPDATE ARREGLO SET INFO_BACKUP = 'No existe la compra con ID_COMPRA: ' || L_ID_COMPRA, ESTADO = '2'
                WHERE ID_ARREGLO =P_ID_ARREGLO;

	        	L_ERROR:= 1;
	            L_MSG := 'ERROR: No existe la compra.';
-- 	            GOTO salida_rapida;
	        END IF;
	
            -- P_ERROR :=0;
            
            SELECT ACTIVO INTO STRICT L_ACTIVO FROM CONTA_VOUCHER
            WHERE ID_VOUCHER = L_ID_VOUCHER;

            IF L_ACTIVO <> 'S' THEN 
	        	L_ERROR:= 1;
	            L_MSG := 'ERROR: El voucher ya esta contabilizado.';
-- 	        	GOTO salida_rapida;
	        END IF;
	
	        IF L_ESTADO <> '1' THEN
	        	L_ERROR:= 1;
	            L_MSG := 'ERROR: La compra no esta provisionada.';
-- 	        	GOTO salida_rapida;
	        END IF;

                --ELIMINA KARDEX DE LA COMPRA
            OPEN articulos;
                FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ANHO,L_ID_ARTICULO;
                WHILE articulos%FOUND LOOP
                    DELETE FROM INVENTARIO_KARDEX
                    WHERE ID_KARDEX = L_ID_KARDEX;

                    UPDATE INVENTARIO_ALMACEN_ARTICULO SET ESTADO = '1'
                    WHERE ID_ALMACEN = L_ID_ALMACEN
                    AND ID_ARTICULO = L_ID_ARTICULO
                    AND ID_ANHO = L_ID_ANHO;

                    FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ANHO,L_ID_ARTICULO;
                END LOOP;
            CLOSE articulos;
            --ELIMINA ASIENTO
            DELETE FROM CONTA_ASIENTO
            WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN
            AND ID_ORIGEN = L_ID_COMPRA;
            --ELIMINA DETALLE
            DELETE FROM COMPRA_DETALLE
            WHERE ID_COMPRA = L_ID_COMPRA;

            DELETE FROM COMPRA_ASIENTO
            WHERE ID_COMPRA = L_ID_COMPRA;

            --ELIMINA LA CONSTANCIA DE PAGO
            DELETE FROM CAJA_PAGO_PROCESO WHERE ID_COMPRA = L_ID_COMPRA;

            --ELIMINA PEDIDO
            SELECT COUNT(1) INTO STRICT L_CANT 
            FROM PEDIDO_COMPRA
            WHERE ID_COMPRA = L_ID_COMPRA;
            IF L_CANT > 0 THEN
                SELECT ID_PCOMPRA,ID_PEDIDO INTO STRICT L_ID_PCOMPRA,L_ID_PEDIDO
                FROM PEDIDO_COMPRA
                WHERE ID_COMPRA = L_ID_COMPRA;

                DELETE FROM PEDIDO_COMPRA_DETALLE
                WHERE ID_PCOMPRA = L_ID_PCOMPRA;

                DELETE FROM PROYECTO_COMPRA WHERE ID_PCOMPRA = L_ID_PCOMPRA;

                SELECT COUNT(1) INTO STRICT L_CANT FROM PEDIDO_COMPRA_ITEM WHERE ID_PCOMPRA = L_ID_PCOMPRA;
                IF L_CANT > 0 THEN
                    DELETE FROM PEDIDO_COMPRA_ITEM WHERE ID_PCOMPRA = L_ID_PCOMPRA;
                END IF;

                DELETE FROM PEDIDO_COMPRA WHERE ID_PCOMPRA = L_ID_PCOMPRA;

                SELECT COUNT(1) INTO STRICT L_CANT  FROM PEDIDO_REQUERIMIENTO WHERE ID_REQUERIMIENTO = L_ID_PEDIDO;
	            IF L_CANT > 0 THEN
                    DELETE FROM PEDIDO_REQUERIMIENTO WHERE ID_REQUERIMIENTO = L_ID_PEDIDO;
	            END IF;

	            SELECT COUNT(1) INTO STRICT L_CANT FROM COMPRA_ORDEN WHERE ID_PEDIDO = L_ID_PEDIDO;
	            IF L_CANT > 0 THEN
                    SELECT ID_ORDEN INTO STRICT L_ID_ORDEN FROM COMPRA_ORDEN WHERE ID_PEDIDO = L_ID_PEDIDO;

                    DELETE FROM COMPRA_ORDEN_DETALLE WHERE ID_ORDEN = L_ID_ORDEN;
	
                    DELETE FROM COMPRA_ORDEN WHERE ID_ORDEN = L_ID_ORDEN;
                END IF;
	
	            DELETE FROM PEDIDO_COTIZACION WHERE ID_PEDIDO = L_ID_PEDIDO;
	
	            DELETE FROM PEDIDO_VOTO WHERE ID_PEDIDO = L_ID_PEDIDO;
	
                DELETE FROM PEDIDO_DETALLE
                WHERE ID_PEDIDO = L_ID_PEDIDO;

                DELETE FROM PEDIDO_FILE
                WHERE ID_PEDIDO = L_ID_PEDIDO;

                DELETE FROM PEDIDO_ASIENTO
                WHERE ID_PEDIDO = L_ID_PEDIDO;

                DELETE FROM PEDIDO_REGISTRO
                WHERE ID_PEDIDO = L_ID_PEDIDO;

                SELECT COUNT(1), MAX(ID_PROCESO) INTO STRICT L_CANT, L_ID_PROCESO FROM PROCESS
	            WHERE ID_ENTIDAD = L_ID_ENTIDAD
	            AND CODIGO = 7;
	
	            IF L_CANT > 0 THEN 
		            --PROCEES
		            SELECT COUNT(1) INTO STRICT L_CANT  FROM PROCESS_RUN WHERE ID_PROCESO = L_ID_PROCESO AND ID_OPERACION = L_ID_PEDIDO;
		
		            IF L_CANT > 0 THEN
		            
                        SELECT ID_REGISTRO INTO STRICT L_ID_REGISTRO 
                        FROM PROCESS_RUN
                        WHERE ID_PROCESO = L_ID_PROCESO
                        AND ID_OPERACION = L_ID_PEDIDO;

                        DELETE FROM PROCESS_PASO_RUN
                        WHERE ID_REGISTRO = L_ID_REGISTRO;

                        DELETE FROM PROCESS_RUN
                        WHERE ID_PROCESO = L_ID_PROCESO
                        AND ID_OPERACION = L_ID_PEDIDO;
	                END IF;
	            END IF;
	
    
            END IF;
            SELECT 'SERIE: '||SERIE||', NUMERO: '||NUMERO||', IMPORTE: '||IMPORTE||', FECHA: '||FECHA_PROVISION||', PERSONA:'||ID_PERSONA INTO STRICT L_GLOSA
            FROM COMPRA WHERE ID_COMPRA = L_ID_COMPRA;

            --ELIMINA COMPRA
            DELETE FROM COMPRA
            WHERE ID_COMPRA = L_ID_COMPRA;

            UPDATE ARREGLO SET INFO_BACKUP = L_GLOSA, ESTADO = '2'
            WHERE ID_ARREGLO =P_ID_ARREGLO;
            
            L_ERROR:= 0;
            L_MSG := 'OK';

--             <<salida_rapida>>
            P_ERROR := L_ERROR;
            P_MSG := L_MSG;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_delete_compra_provision (P_ID_ARREGLO bigint,P_ERROR OUT bigint,P_MSG OUT text) FROM PUBLIC;
