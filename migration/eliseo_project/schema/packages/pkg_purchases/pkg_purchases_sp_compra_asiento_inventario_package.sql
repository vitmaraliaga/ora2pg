-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_compra_asiento_inventario (P_ID_COMPRA bigint,P_ID_DINAMICA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ID_ASIENTO bigint;
        L_ID_PARENT bigint;
        L_ID_TIPO_PLAN bigint;
        L_ID_RESTRICCION varchar(50);
        L_ID_CUENTAAASI varchar(10);
        L_ID_CTACTE varchar(10);
        L_DC varchar(1);
        L_ID_INDICADOR varchar(35);
        L_UNICO varchar(1);
        L_UNICOCTACTE varchar(1);
        L_PORCENTAJE decimal(10,2);
        L_DESCRIPCION varchar(255);
        L_ID_CASIENTO varchar(50);
        L_ID_FONDO varchar(50);
        L_BASE decimal(10,2);
        L_IGV decimal(10,2);
        L_IMPORTE decimal(10,2);
        L_IMPORTE_ME decimal(10,2);
        P_IMPORTE decimal(10,2);
        P_IMPORTE_ME decimal(10,2);
        L_DEPTO varchar(10);
        L_CONT bigint;
        L_AGRUPA varchar(1) :='N';
        L_SERIE varchar(4);
        L_NUMERO varchar(8);
        L_CORRELATIVO varchar(20);
        L_EDITABLE varchar(1) :='N';
        L_ESTADO varchar(1);
        L_NRO_ASIENTO bigint;
        L_IMP_DET decimal(10,2);
        L_ARTICULO varchar(255);
        L_COSTO_VINCULADO decimal(10,2);

        L_ID_PEDIDO bigint :=0;
        L_DESTINO varchar(10);
        L_ORIGEN varchar(10);
        L_CTAS varchar(200);
        L_CTATES varchar(200);
        L_ACTAS TABLASTRING;
        L_ACTATES TABLASTRING;
        L_BUSCAR bigint;
        L_UNICOCTATED varchar(1);
        L_ID_ALMACEN bigint;
        L_ID_SEDEAREA bigint;
        L_ID_COMPROBANTE varchar(2);
        L_ID_PROVEEDOR bigint;

        casi CURSOR FOR		
        SELECT
                A.ID_ASIENTO,D.ID_PARENT,A.ID_RESTRICCION,A.ID_CUENTAAASI,A.DC,A.ID_INDICADOR,A.UNICO,A.UNICO_CTACTE,round((A.PORCENTAJE*100)::numeric,2),A.NOMBRE,A.AGRUPA,A.ID_FONDO,A.NRO_ASIENTO
        FROM CONTA_DINAMICA_ASIENTO A,CONTA_DINAMICA D
        WHERE A.ID_DINAMICA=D.ID_DINAMICA 
        AND A.ID_DINAMICA =P_ID_DINAMICA 
        ORDER BY A.NRO_ASIENTO,A.DC DESC,A.ID_ASIENTO;

        CASIDES CURSOR FOR		
        SELECT 
                A.ID_ASIENTO,A.ID_RESTRICCION,A.ID_CUENTAAASI,A.DC,A.ID_INDICADOR,A.UNICO,A.UNICO_CTACTE,round((A.PORCENTAJE*100)::numeric,2),A.NOMBRE,A.AGRUPA,A.ID_FONDO,2 --(ES ASIENTO 2 POR QUE ES DESTINO)
        FROM CONTA_DINAMICA_ASIENTO A,CONTA_DINAMICA D
        WHERE A.ID_DINAMICA=D.ID_DINAMICA 
        AND A.ID_DINAMICA =L_ID_PARENT 
        ORDER BY A.NRO_ASIENTO,A.DC DESC,A.ID_ASIENTO;

        DET CURSOR FOR
        SELECT  --DECODE(L_ID_INDICADOR,'BASE',BASE,IMPORTE),
             (CASE
                 WHEN L_ID_INDICADOR = 'COSTO_ALM' AND coalesce(COSTO_VINCULADO, 0) > 0
                 THEN
                    BASE + coalesce(COSTO_VINCULADO, 0)
                 WHEN L_ID_INDICADOR = 'COSTO_ALM' AND coalesce(COSTO_VINCULADO, 0) = 0
                 THEN
                    CASE WHEN L_ORIGEN='11010111' THEN IMPORTE WHEN L_ORIGEN='51010111' THEN IMPORTE  ELSE BASE END  --SI ES LOGITICA EL COSTO DE MERCADERIA ES EL 100%, SI SON OTRAS AREAS ES IMPORTE-IGV = BASE
                 ELSE
                    IMPORTE+coalesce(COSTO_VINCULADO, 0)
              END),
             pkg_inventories_fc_articulo(ID_ARTICULO)
        FROM COMPRA_DETALLE
        WHERE ID_COMPRA = P_ID_COMPRA AND coalesce(ES_COSTO_VINCULADO::text, '') = '' 
        ORDER BY ID_DETALLE;


BEGIN
        P_ERROR :=0;

        IF P_ERROR = 0 THEN
            SELECT ID_ENTIDAD,ID_PROVEEDOR,SERIE,NUMERO,BASE,IGV,IMPORTE,IMPORTE_ME,ESTADO,ID_COMPROBANTE
            INTO STRICT L_ID_ENTIDAD,L_ID_PROVEEDOR,L_SERIE,L_NUMERO,L_BASE, L_IGV, L_IMPORTE, L_IMPORTE_ME, L_ESTADO, L_ID_COMPROBANTE
            FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;

            SELECT ID_PEDIDO INTO STRICT L_ID_PEDIDO 
            FROM PEDIDO_COMPRA
            WHERE ID_COMPRA = P_ID_COMPRA;
            IF L_ID_PEDIDO <> 0 THEN
                SELECT  A.ID_AREAORIGEN,
                (SELECT X.ID_DEPTO FROM ORG_SEDE_AREA X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_SEDEAREA = coalesce(A.ID_AREAGASTO,A.ID_AREAORIGEN) ) ORIGEN,
                (SELECT X.ID_DEPTO FROM ORG_SEDE_AREA X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_SEDEAREA = ID_AREADESTINO) DESTINO
                INTO STRICT L_ID_SEDEAREA, L_ORIGEN,L_DESTINO
                FROM PEDIDO_REGISTRO A 
                WHERE A.ID_PEDIDO = L_ID_PEDIDO;
            END IF;
            IF L_ESTADO <> '1' THEN
                DELETE FROM COMPRA_ASIENTO
                WHERE ID_COMPRA = P_ID_COMPRA;
            END IF;

            SELECT DISTINCT ID_ALMACEN INTO STRICT L_ID_ALMACEN 
            FROM COMPRA_DETALLE 
            WHERE ID_COMPRA = P_ID_COMPRA;

            --SELECT ID_ALMACEN INTO L_ID_ALMACEN
            --FROM INVENTARIO_ALMACEN
            --WHERE ID_SEDEAREA = L_ID_SEDEAREA;
            
                OPEN casi;
                --FETCH casi INTO L_ID_TIPO_PLAN, L_ID_CUENTAAASI, L_ID_RESTRICCION,L_ID_FONDO, L_ID_CTACTE,L_DEPTO,L_DC, L_PORCENTAJE, L_DESCRIPCION, L_ID_INDICADOR,L_NRO_ASIENTO;
                FETCH casi INTO L_ID_ASIENTO,L_ID_PARENT,L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC,L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA,L_ID_FONDO,L_NRO_ASIENTO;
                WHILE casi%FOUND LOOP
                    L_DEPTO:=null;
                    L_ID_CTACTE:=null;

                    IF L_UNICO='U' THEN
                      SELECT ID_DEPTO INTO STRICT L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_ASIENTO=L_ID_ASIENTO;
                    ELSE
                        IF L_DC = 'C' THEN
                            L_DEPTO := L_DESTINO;
                        ELSE
                            L_DEPTO := L_ORIGEN;
                        END IF;
                    END IF;

                    IF L_UNICOCTACTE='U' THEN
                        SELECT  COUNT(1) INTO STRICT L_CONT FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_ASIENTO = L_ID_ASIENTO;
                        IF L_CONT>0 THEN
                            SELECT ID_CTACTE INTO STRICT L_ID_CTACTE FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_ASIENTO = L_ID_ASIENTO;
                        END IF;
                        --CTA CTE POR TIPO DE ALMACEM E IGV 
                        --22-BAZAR
                        --23-COMEDOR
                        --25-CAFETIN
                        --33-LOGISTICA
                        IF L_ID_CUENTAAASI = '5111010' THEN
                            IF L_ID_ALMACEN = 22 THEN  --BAZAR
                                IF L_ID_COMPROBANTE = '01' AND L_IGV > 0 THEN
                                    L_ID_CTACTE :='1';
                                ELSIF L_ID_COMPROBANTE = '01' AND L_IGV = 0 THEN
                                    L_ID_CTACTE :='13';
                                ELSIF L_ID_COMPROBANTE = '03' THEN
                                    L_ID_CTACTE :='9';
                                END IF;
                            ELSIF L_ID_ALMACEN = 23 THEN  --COMEDOR
                                L_ID_CTACTE :='1';
                            ELSIF L_ID_ALMACEN = 25 THEN  --25
                                L_ID_CTACTE :='1';
                            ELSIF L_ID_ALMACEN = 33 THEN  --LOGISTICA
                                IF L_ID_COMPROBANTE = '01' AND L_IGV > 0 THEN
                                    L_ID_CTACTE :='8';
                                ELSIF L_ID_COMPROBANTE = '01' AND L_IGV = 0 THEN
                                    L_ID_CTACTE :='16';
                                ELSIF L_ID_COMPROBANTE = '03' THEN
                                    L_ID_CTACTE :='12';
                                END IF;
                            END IF;
                        END IF;

                    ELSIF (L_UNICOCTATED='M') THEN
                        SELECT position('|' in L_CTATES) INTO STRICT L_BUSCAR;
                        IF L_BUSCAR>0 THEN
                            SELECT FC_SPLIT(L_CTAS,'|') INTO STRICT L_ACTAS;
                            SELECT FC_SPLIT(L_CTATES,'|') INTO STRICT L_ACTATES;
                            SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ACTATES ,L_ID_CUENTAAASI) INTO STRICT L_ID_CTACTE;
                        ELSE
                            L_ID_CTACTE:=L_CTATES;
                        END IF;
                    END IF;

                    SELECT CASE L_ID_INDICADOR WHEN 'IMPORTE' THEN (L_IMPORTE)--*(L_PORCENTAJE/100)
                          WHEN 'BASE' THEN (L_BASE)--*(L_PORCENTAJE/100)
                          WHEN 'IGV' THEN (L_IGV)--*(L_PORCENTAJE/100)
                          WHEN 'COSTO_ALM' THEN (L_IMPORTE)--*(L_PORCENTAJE/100)
                          ELSE
                          0
                          END INTO STRICT P_IMPORTE
;
                    SELECT CASE WHEN L_ID_INDICADOR = 'IMPORTE' AND L_DC = 'D' then
                            'S'
                          WHEN L_ID_INDICADOR = 'BASE' AND L_DC = 'D' then
                            'S'
                          WHEN L_ID_INDICADOR = 'IGV' then
                               'S'
                          ELSE
                          'S'
                          END INTO STRICT l_EDITABLE
;
                    IF L_DC='C' THEN
                        P_IMPORTE:=P_IMPORTE*(-1);
                        P_IMPORTE_ME:=P_IMPORTE_ME*(-1);
                    ELSE
                        P_IMPORTE := P_IMPORTE;
                        P_IMPORTE_ME := P_IMPORTE_ME;
                    END IF;

                    IF P_IMPORTE<>0 THEN
                        --SELECT NVL(MAX(ID_CASIENTO),0)+1 INTO L_ID_CASIENTO FROM COMPRA_ASIENTO;
                        INSERT INTO COMPRA_ASIENTO(
                        --ID_CASIENTO,
                        ID_COMPRA, ID_CUENTAAASI, ID_RESTRICCION, ID_CTACTE,ID_FONDO, ID_DEPTO, IMPORTE,DESCRIPCION,EDITABLE, ID_PARENT, ID_TIPOREGISTRO, DC, IMPORTE_ME, FECHA_ACTUALIZACION, AGRUPA,NRO_ASIENTO
                        ) VALUES(
                        --L_ID_CASIENTO,
                        P_ID_COMPRA, L_ID_CUENTAAASI, L_ID_RESTRICCION, L_ID_CTACTE,L_ID_FONDO, L_DEPTO, P_IMPORTE,
                            SUBSTR((L_ID_ENTIDAD || '-' || L_CORRELATIVO || ' ' || L_SERIE || '-' || L_NUMERO || ' - ' ||pkg_purchases_fc_ruc(L_ID_PROVEEDOR)||'-'||L_DESCRIPCION||'-'||L_ARTICULO),1,50),l_EDITABLE, NULL, NULL, L_DC, P_IMPORTE_ME, statement_timestamp(), L_AGRUPA,L_NRO_ASIENTO
                        );
                    END IF;

                    FETCH casi INTO L_ID_ASIENTO,L_ID_PARENT,L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC,L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA,L_ID_FONDO,L_NRO_ASIENTO;
                    END LOOP;
                CLOSE casi;
                --Destino
                OPEN CASIDES;
                FETCH CASIDES INTO L_ID_ASIENTO,L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC,L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA,L_ID_FONDO,L_NRO_ASIENTO;
                WHILE CASIDES%FOUND LOOP
                   L_DEPTO:=null;
                    L_ID_CTACTE:=null;

                    IF L_UNICO='U' THEN
                      SELECT ID_DEPTO INTO STRICT L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_ASIENTO=L_ID_ASIENTO;
                    ELSE
                        IF L_DC = 'C' THEN
                            L_DEPTO := L_DESTINO;
                        ELSE
                            L_DEPTO := L_ORIGEN;
                        END IF;
                    END IF;

                    IF L_UNICOCTACTE='U' THEN
                        SELECT  COUNT(1) INTO STRICT L_CONT FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_ASIENTO = L_ID_ASIENTO;
                        IF L_CONT>0 THEN
                            SELECT ID_CTACTE INTO STRICT L_ID_CTACTE FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_ASIENTO = L_ID_ASIENTO;
                        END IF;
                    ELSIF (L_UNICOCTATED='M') THEN
                        SELECT position('|' in L_CTATES) INTO STRICT L_BUSCAR;
                        IF L_BUSCAR>0 THEN
                            SELECT FC_SPLIT(L_CTAS,'|') INTO STRICT L_ACTAS;
                            SELECT FC_SPLIT(L_CTATES,'|') INTO STRICT L_ACTATES;
                            SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ACTATES ,L_ID_CUENTAAASI) INTO STRICT L_ID_CTACTE;
                        ELSE
                            L_ID_CTACTE:=L_CTATES;
                        END IF;
                    END IF;

                    SELECT CASE L_ID_INDICADOR WHEN 'IMPORTE' THEN (L_IMPORTE)--*(L_PORCENTAJE/100)
                          WHEN 'BASE' THEN (L_BASE)--*(L_PORCENTAJE/100)
                          WHEN 'IGV' THEN (L_IGV)--*(L_PORCENTAJE/100)
                          WHEN 'COSTO_ALM' THEN (L_IMPORTE)--*(L_PORCENTAJE/100)
                          ELSE
                          0
                          END INTO STRICT P_IMPORTE
;
                    SELECT CASE WHEN L_ID_INDICADOR = 'IMPORTE' AND L_DC = 'D' then
                            'S'
                          WHEN L_ID_INDICADOR = 'BASE' AND L_DC = 'D' then
                            'S'
                          WHEN L_ID_INDICADOR = 'IGV' then
                               'S'
                          ELSE
                          'S'
                          END INTO STRICT l_EDITABLE
;
                    IF L_DC='C' THEN
                        P_IMPORTE:=P_IMPORTE*(-1);
                        P_IMPORTE_ME:=P_IMPORTE_ME*(-1);
                    ELSE
                        P_IMPORTE := P_IMPORTE;
                        P_IMPORTE_ME := P_IMPORTE_ME;
                    END IF;

                    IF (L_ID_CUENTAAASI = '1141001' OR L_ID_CUENTAAASI = '1146001' OR L_ID_CUENTAAASI = '1144001' ) THEN 
                        OPEN DET;
                            FETCH DET INTO L_IMP_DET, L_ARTICULO;
                            WHILE DET%FOUND LOOP
                                IF L_DC='C' THEN
                                    L_IMP_DET:=L_IMP_DET*(-1);
                                ELSE
                                    L_IMP_DET := L_IMP_DET;
                                END IF;
                                --SELECT NVL(MAX(ID_CASIENTO),0)+1 INTO L_ID_CASIENTO FROM COMPRA_ASIENTO;
                                INSERT INTO COMPRA_ASIENTO(
                                --ID_CASIENTO,
                                ID_COMPRA, ID_CUENTAAASI, ID_RESTRICCION, ID_CTACTE,ID_FONDO, ID_DEPTO, IMPORTE,DESCRIPCION,EDITABLE, ID_PARENT, ID_TIPOREGISTRO, DC, IMPORTE_ME, FECHA_ACTUALIZACION, AGRUPA,NRO_ASIENTO
                                ) VALUES (
                                --L_ID_CASIENTO,
                                P_ID_COMPRA, L_ID_CUENTAAASI, L_ID_RESTRICCION, L_ID_CTACTE,L_ID_FONDO, L_DEPTO, L_IMP_DET,
                                 SUBSTR((L_ID_ENTIDAD || '-' || L_CORRELATIVO || ' ' || L_SERIE || '-' || L_NUMERO || ' - ' || L_ARTICULO||'-'||L_DESCRIPCION),1,50),l_EDITABLE, NULL, NULL, L_DC, P_IMPORTE_ME, statement_timestamp(), L_AGRUPA,L_NRO_ASIENTO
                                );
                            FETCH DET INTO L_IMP_DET, L_ARTICULO;
                            END LOOP;
                        CLOSE DET;
                    ELSE
                        IF (L_ID_CUENTAAASI = '5111011' OR L_ID_CUENTAAASI = '5111015' OR L_ID_CUENTAAASI = '5111009') THEN
                            SELECT CASE WHEN L_ORIGEN='11010111' THEN SUM(IMPORTE) WHEN L_ORIGEN='51010111' THEN SUM(IMPORTE)  ELSE SUM(BASE) END *-1, coalesce(SUM(COSTO_VINCULADO),0)*-1 INTO STRICT L_COSTO_VINCULADO,L_IMP_DET
                            FROM COMPRA_DETALLE
                            WHERE ID_COMPRA = P_ID_COMPRA
                            --AND ES_COSTO_VINCULADO IS NOT NULL
                            ORDER BY ID_DETALLE;
                            P_IMPORTE:=L_IMP_DET+L_COSTO_VINCULADO;
                        END IF;

                        --SELECT NVL(MAX(ID_CASIENTO),0)+1 INTO L_ID_CASIENTO FROM COMPRA_ASIENTO;
                        INSERT INTO COMPRA_ASIENTO(
                        --ID_CASIENTO,
                        ID_COMPRA, ID_CUENTAAASI, ID_RESTRICCION, ID_CTACTE,ID_FONDO, ID_DEPTO, IMPORTE, DESCRIPCION,EDITABLE, ID_PARENT, ID_TIPOREGISTRO, DC, IMPORTE_ME, FECHA_ACTUALIZACION, AGRUPA,NRO_ASIENTO
                        ) VALUES (
                        --L_ID_CASIENTO,
                        P_ID_COMPRA, L_ID_CUENTAAASI, L_ID_RESTRICCION, L_ID_CTACTE,L_ID_FONDO, L_DEPTO, P_IMPORTE,
                         SUBSTR((L_ID_ENTIDAD || '-' || L_CORRELATIVO || ' ' || L_SERIE || '-' || L_NUMERO || ' - ' || L_DESCRIPCION),1,50),l_EDITABLE, NULL, NULL, L_DC, P_IMPORTE_ME, statement_timestamp(), L_AGRUPA,L_NRO_ASIENTO
                        );
                    END IF;

                    FETCH CASIDES INTO L_ID_ASIENTO,L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC,L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA,L_ID_FONDO,L_NRO_ASIENTO;

                END LOOP;
                CLOSE CASIDES;
            P_ERROR :=0;
        END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_compra_asiento_inventario (P_ID_COMPRA bigint,P_ID_DINAMICA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
