-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_importar_saldo_inicial (P_ID_ENTIDAD bigint, P_ID_DEPTO bigint, P_ID_ANHO bigint, P_ID_COMPRA bigint, P_ID_MONEDA bigint, P_ID_PERSONA bigint, P_RUC text, P_ID_COMPROBANTE text, P_SERIE text, P_NUMERO text, P_FECHA_PROVISION timestamp(0), P_FECHA_DOC timestamp(0), P_IMPORTE bigint, P_IMPORTE_ME bigint, P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

    L_ID_PROVEEDOR bigint;
    L_ID_COMPRA bigint;
    L_CANT bigint;
    L_ERROR bigint;
    L_MSGERROR varchar(200);

BEGIN
            
        INSERT INTO TEST(NAME,AGE)VALUES (P_RUC,P_ID_ANHO||'-'||P_ID_ENTIDAD);

        L_ERROR := 0;
        SELECT COUNT(1) INTO STRICT L_CANT
        FROM MOISES.PERSONA_JURIDICA
        WHERE ID_RUC = P_RUC;

        IF L_CANT = 0 THEN
            L_ERROR := 1;
            L_MSGERROR := P_RUC||' No Existe';
        ELSE
            SELECT ID_PERSONA INTO STRICT L_ID_PROVEEDOR
            FROM MOISES.PERSONA_JURIDICA
            WHERE ID_RUC = P_RUC;

            SELECT COUNT(1) INTO STRICT L_CANT
            FROM COMPRA_SALDO
            WHERE ID_DEPTO = P_ID_DEPTO
            AND ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_ANHO = P_ID_ANHO
            AND ID_PROVEEDOR = L_ID_PROVEEDOR
            AND ID_COMPROBANTE = P_ID_COMPROBANTE
            AND SERIE = P_SERIE
            AND NUMERO = P_NUMERO;

            IF L_CANT > 0 THEN
                L_ERROR := 1;
                L_MSGERROR := P_SERIE||'-'||P_NUMERO||' YA Existe';
            END IF;
        END IF;

        IF L_ERROR = 0 THEN
            IF P_ID_COMPRA = 0 THEN 
                L_ID_COMPRA := NULL;
            ELSE
                L_ID_COMPRA := P_ID_COMPRA;
            END IF;
            INSERT INTO COMPRA_SALDO(ID_DEPTO,
                                      ID_ENTIDAD,
                                      ID_ANHO,
                                      ID_COMPRA,
                                      ID_MONEDA,
                                      ID_PERSONA,
                                      ID_PROVEEDOR,
                                      ID_COMPROBANTE,
                                      SERIE,
                                      NUMERO,
                                      FECHA_PROVISION,
                                      FECHA_DOC,
                                      IMPORTE,
                                      IMPORTE_ME)
                 VALUES (P_ID_DEPTO,
                         P_ID_ENTIDAD,
                         P_ID_ANHO,
                         L_ID_COMPRA,
                         P_ID_MONEDA,
                         P_ID_PERSONA,
                         L_ID_PROVEEDOR,
                         P_ID_COMPROBANTE,
                         P_SERIE,
                         P_NUMERO,
                         P_FECHA_PROVISION,
                         P_FECHA_DOC,
                         P_IMPORTE,
                         P_IMPORTE_ME);
            L_MSGERROR := 'OK';

        END IF;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_importar_saldo_inicial (P_ID_ENTIDAD bigint, P_ID_DEPTO bigint, P_ID_ANHO bigint, P_ID_COMPRA bigint, P_ID_MONEDA bigint, P_ID_PERSONA bigint, P_RUC text, P_ID_COMPROBANTE text, P_SERIE text, P_NUMERO text, P_FECHA_PROVISION timestamp(0), P_FECHA_DOC timestamp(0), P_IMPORTE bigint, P_IMPORTE_ME bigint, P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
