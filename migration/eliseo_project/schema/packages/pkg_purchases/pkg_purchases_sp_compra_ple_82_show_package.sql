-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_compra_ple_82_show ( P_ID_EMPRESA bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_MES bigint, P_ID_ANHO bigint, OUT CURSOR REFCURSOR ) AS $body$
BEGIN

    OPEN CURSOR FOR
    
    SELECT
                    fecha_ord, ID_COMPRA,
                    id_entidad,
                    FC_NOMBRE_PERSONA(per_user) as usuario,
                    voucher as voucher,
                    trim(both periodo) as campo1, 
                    trim(both cuo) as campo2,
                    trim(both cuo_correlativo) as campo3,
                    trim(both fecha_doc) as campo4,
					trim(both tipo_doc) as campo5,
					trim(both serie) as campo6,
					trim(both numdoc) as campo7,
					trim(both CASE WHEN importe_e>0 THEN importe_e ELSE importe END -CASE WHEN otros_e>0 THEN otros_e ELSE otros END ) as campo8,
					trim(both CASE WHEN otros_e>0 THEN otros_e ELSE otros END) as campo9,
					trim(both CASE WHEN importe_e>0 THEN importe_e ELSE importe END) as campo10,
					trim(both tipo_doc_parent) AS campo11,
					trim(both serie_parent) AS campo12,
					trim(both anio_parent) AS campo13,
					trim(both numero_parent) AS campo14,
					trim(both igv_total) as campo15,
					trim(both moneda) as campo16,  --moneda
					trim(both tipo_cambio) as campo17,  --tipo de cambio
					codigo_pais AS campo18,
					nombre AS campo19,
					'' AS campo20,
					ruc AS campo21,
					trim(both num_doc_benficiario) AS campo22,
					trim(both nombre_benficiario) AS campo23,
					trim(both cod_pais_benficiario) AS campo24,
					'' AS campo25,
					'' AS campo26,
					'' AS campo27,
					'' AS campo28,
					'' AS campo29,
					'' AS campo30,
					'00' AS campo31,
					'' AS campo32,
					tipo_renta AS campo33,
					'' AS campo34,
					'' AS campo35,
					'0' AS campo36
					from (
                            SELECT 
					A.ID_COMPRA,
                    A.FECHA_DOC as fecha_documento,  
					A.FECHA_PROVISION as fecha_provision, 
                    lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0')||'00' AS periodo, 
                    to_char(A.FECHA_DOC,'MM') as mes_doc,
                    coalesce(ELISEO.FC_CONTA_CUO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo, 
                    coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo_correlativo, 
                    coalesce(to_char(A.FECHA_DOC,'yyyymmdd'),' ') AS fecha_ord, 
                    coalesce(to_char(A.FECHA_DOC,'dd/mm/yyyy'),' ') AS fecha_doc,  
                    coalesce(to_char(A.FECHA_PROVISION,'dd/mm/yyyy'),' ') AS fecha_prov, 
                    coalesce(to_char(A.FECHA_VENCIMIENTO,'dd/mm/yyyy'),' ') AS fecha_venc, 
					coalesce(D.CODIGO,'') AS tipo_doc,  
                    coalesce(A.SERIE,'') AS serie,   
					A.ID_ANHO AS anio,  
                    coalesce(A.NUMERO,'') AS numdoc,   
					to_char(coalesce(A.IMPORTE * case when D.CODIGO like '97' then -1 else 1 end,0),'99999990.99') AS importe,
					to_char(coalesce(A.IMPORTE_ME * case when D.CODIGO like '97' then -1 else 1 end,0),'99999990.99') AS importe_e,    
                    to_char(coalesce(A.IGV * case when D.CODIGO like '97' then -1 else 1 end,0),'99999990.99') AS igv_total,
                    ELISEO.FC_MONEDA_COD_SUNAT(A.ID_MONEDA) AS moneda,
                    to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.OTROS,0),'99999990.99') AS otros,
                    to_char(coalesce(A.OTROS_ME,0),'99999990.99') AS otros_e,
                    coalesce(G.COD_SUNAT::text,'') AS codigo_pais,
                    coalesce(H.CODIGO,'') AS tipo_renta,
					UPPER(coalesce(CASE WHEN coalesce(P.PATERNO::text, '') = '' THEN '' ELSE P.PATERNO||' ' END, '') || coalesce(CASE WHEN coalesce(P.MATERNO::text, '') = '' THEN  '' ELSE P.MATERNO||', ' END , '')) || P.NOMBRE AS nombre,                                        
					B.ID_PERSONA as prv_id,   
					B.ID_RUC AS ruc,
                    A.ID_ENTIDAD as entidad,
                    A.ID_ENTIDAD AS ID_ENTIDAD,
                    A.ID_PERSONA as per_user,
                    A.ID_VOUCHER as voucher,
                    --Parent
                    coalesce(DP.CODIGO,'') AS tipo_doc_parent,
                    coalesce(C.SERIE,'') AS serie_parent,
                    coalesce(to_char(C.FECHA_DOC,'yyyy'),'') AS anio_parent,
                    coalesce(C.NUMERO ,'') AS numero_parent,
                    --Beneficiario
                    coalesce(PNB.NUM_DOCUMENTO,'') AS num_doc_benficiario,
                    UPPER(coalesce(CASE WHEN coalesce(PB.PATERNO::text, '') = '' THEN '' ELSE PB.PATERNO||' ' END, '') || coalesce(CASE WHEN coalesce(PB.MATERNO::text, '') = '' THEN  '' ELSE PB.MATERNO||', ' END, '')) || PB.NOMBRE AS nombre_benficiario,   
                    coalesce(TPB.COD_SUNAT::text,'') AS cod_pais_benficiario
			FROM ELISEO.CONTA_ENTIDAD E 
			INNER JOIN ELISEO.COMPRA A ON  A.ID_ENTIDAD = E.ID_ENTIDAD 
			INNER JOIN MOISES.PERSONA_CONTRIBUYENTE B ON A.ID_PROVEEDOR = B.ID_PERSONA
			INNER JOIN MOISES.PERSONA P ON P.ID_PERSONA = B.ID_PERSONA
			INNER JOIN ELISEO.TIPO_COMPROBANTE D ON D.ID_COMPROBANTE = A.ID_COMPROBANTE
			LEFT JOIN ELISEO.COMPRA C ON (A.ID_PARENT = C.ID_COMPRA )
			LEFT JOIN ELISEO.COMPRA_IMPORTACION F ON A.ID_COMPRA = F.ID_COMPRA
			LEFT JOIN MOISES.TIPO_PAIS G ON G.ID_TIPOPAIS = B.ID_TIPOPAIS
			LEFT JOIN ELISEO.TIPO_RENTA H ON H.ID_TIPORENTA = F.ID_TIPORENTA 
			LEFT JOIN ELISEO.TIPO_COMPROBANTE DP ON C.ID_COMPROBANTE = DP.ID_COMPROBANTE 
			LEFT JOIN MOISES.PERSONA PB ON PB.ID_PERSONA = F.ID_BENEFICIARIO
			LEFT JOIN MOISES.PERSONA_NATURAL PNB ON PNB.ID_PERSONA = PB.ID_PERSONA AND PNB.ID_TIPODOCUMENTO IN ('1','4','7')
			LEFT JOIN MOISES.TIPO_PAIS TPB ON TPB.ID_TIPOPAIS = PNB.ID_TIPOPAIS
			WHERE E.ID_EMPRESA = P_ID_EMPRESA
      AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
      AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
			AND A.ID_ANHO = P_ID_ANHO
			--AND A.id_mes = 3
			AND A.id_mes = P_ID_MES
            AND D.CODIGO IN ('00','91','97','98')
			AND A.Estado = '1' 
                    ) a;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_compra_ple_82_show ( P_ID_EMPRESA bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_MES bigint, P_ID_ANHO bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
