-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_facturacion,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_facturacion_fc_cliente_ubigeo ( P_ID_PERSONA bigint, P_TIPO bigint DEFAULT 4 --1=DISTRITO;2=PROVINCIA;3=DEPARTAMENTO;4=UBIGEO COMPLETO
) RETURNS varchar AS $body$
DECLARE

    L_UBIGEO varchar(5000);

BEGIN
	    L_UBIGEO:='';
	    IF P_TIPO = 1 THEN
	       	SELECT MIN(coalesce(B.NOMBRE,'')) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
	
	        IF coalesce(L_UBIGEO::text, '') = '' THEN 
	                SELECT MIN(coalesce(B.NOMBRE,'')) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
	    ELSIF P_TIPO = 2 THEN
	       	SELECT MIN(coalesce(C.NOMBRE,'')) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
	
	        IF coalesce(L_UBIGEO::text, '') = '' THEN 
	                SELECT MIN(coalesce(C.NOMBRE,'')) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
	    ELSIF P_TIPO = 3 THEN
	       	SELECT MIN(coalesce(C.NOMBRE,'')) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			INNER JOIN MOISES.UBIGUEO C ON B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND C.PVCIA = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
				
	        IF coalesce(L_UBIGEO::text, '') = '' THEN 
	                SELECT MIN(coalesce(C.NOMBRE,'')) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					INNER JOIN MOISES.UBIGUEO C ON B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND C.PVCIA = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
	    ELSE
	       	SELECT MIN(B.NOMBRE||', '||C.NOMBRE||', '||D.NOMBRE) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
			INNER JOIN MOISES.UBIGUEO D ON B.DEPTO = D.DEPTO  AND D.DITTO = '00' AND D.PVCIA = '00' AND B.ID_TIPOPAIS = D.ID_TIPOPAIS 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
				
	        IF coalesce(L_UBIGEO::text, '') = '' THEN 
	                SELECT MIN(B.NOMBRE||', '||C.NOMBRE||', '||D.NOMBRE) INTO STRICT L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
					INNER JOIN MOISES.UBIGUEO D ON B.DEPTO = D.DEPTO  AND D.DITTO = '00' AND D.PVCIA = '00' AND B.ID_TIPOPAIS = D.ID_TIPOPAIS 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
        END IF;
        RETURN(L_UBIGEO);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_facturacion_fc_cliente_ubigeo ( P_ID_PERSONA bigint, P_TIPO bigint DEFAULT 4 ) FROM PUBLIC;
