-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_nodom (P_ID_COMPRAS_PRELI bigint, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;
      l_id_empresa bigint;
      l_periodo  varchar(20);
      l_id_entidad bigint:=7124;

BEGIN
    
      select ID_EMPRESA, PERIODO into STRICT
      l_id_empresa,l_periodo
      from SIRE_COMPRAS_PRELI
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI;

      
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=l_id_empresa;

      delete from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in (
        SELECT id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and id_depto not in ('2','3');

      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI;

      
      insert into SIRE_COMPRAS_PRELI_DET(
        ID_COMPRAS_PRELI_DET,
        ID_COMPRAS_PRELI,
        ID_ENTIDAD,
        ID_DEPTO,
        TIPO,
        ORDEN,
        CARSUNAT,	
        FEMISION,	
        TIPOCOMP,	
        SERIE,
        ANHO, 
        MES,
        NRODOCINICIAL,
        VALORADQNG,	
        NDCONCEPTO_ADIC,	
        TOTALCP,	
        NDTIPOCOMP,	
        NDSERIE,	
        NDANHO,	
        NDNRODOCINICIAL,	
        IGVIPMDNG,	
        MONEDA,	
        TIPOCAMBIO,	
        NDPAIS,	
        RAZONSOCIAL,	
        NDDOMICILIO,	
        NRODOCUMENTO,	
        NDNRODOCPAGO,	
        NDRAZONSOCIALPAGO,	
        NDPAISPAGO,	
        NDVINCULO,	
        BIGRAVADODG,	
        BIGRAVADODGNG,	
        BIGRAVADODNG,	
        IGVIPMDGNG,	
        IGVIPMDG,	
        NDDOBLETRIB,	
        NDEXOAPLI,	
        NDTIPORENTA,	
        NDMODERV,	
        NDAPLIRENTA,	
        CARORIGINDEOI,
        VIGENCIA,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT 
      DISTINCT
      'ND'||l_id_empresa::text||a.id_anho::text||LPAD(a.id_mes::text,2,'0')|| to_char((row_number() OVER ( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
      P_ID_COMPRAS_PRELI,
      a.id_entidad,
      A.ID_DEPTO,
      'C',
      ((row_number() OVER ( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ORDEN,
      B.ID_RUC ||a.ID_COMPROBANTE||a.SERIE||LPAD(a.NUMERO::text,20,'0') as CARSUNAT,
      a.FECHA_DOC,
      a.id_comprobante,
      a.SERIE,
      a.id_anho::text as anho,
      LPAD(a.id_mes::text,2,'0') as mes,
      CASE WHEN LENGTH(trim(both TRANSLATE(a.NUMERO, ' .0123456789', ' '))) IS NULL THEN (a.NUMERO)::numeric ::text ELSE a.NUMERO end,
      coalesce(a.base,0) as VALORADQNG,
      0 as NDCONCEPTO_ADIC,
      coalesce(a.IMPORTE,0) as TOTALCP,
      '' as NDTIPOCOMP,	
      '' as NDSERIE,	
      '' as NDANHO,	
      '' as NDNRODOCINICIAL,
      0 as IGVIPMDNG,
      CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END  as MONEDA,
      coalesce(a.TIPOCAMBIO,0),
      tp.COD_SUNAT as NDPAIS,--pendiente
      b.NOMBRE as RAZONSOCIAL,
      '' as NDDOMICILIO,
      B.ID_RUC as NRODOCUMENTO,
      '' as NDNRODOCPAGO,	
      '' as NDRAZONSOCIALPAGO,	
      '' as NDPAISPAGO,	
      '' as NDVINCULO,
      0 as BIGRAVADODG,	
      0 as BIGRAVADODGNG,	
      0 as BIGRAVADODNG,	
      0 as IGVIPMDGNG,	
      0 as IGVIPMDG,
      '00' as NDDOBLETRIB, --00-ninguno
      '' as NDEXOAPLI,	
      '' as NDTIPORENTA,	
      '' as NDMODERV,	
      '' as NDAPLIRENTA,	
      '' as CARORIGINDEOI,
      1,
      P_ID_USER,
      clock_timestamp()
      from COMPRA a inner join MOISES.VW_PERSONA_NATURAL_LEGAL B on a.ID_PROVEEDOR = b.ID_PERSONA
      left join MOISES.PERSONA_JURIDICA pj on pj.ID_PERSONA=a.ID_PROVEEDOR
      left join MOISES.TIPO_PAIS tp on tp.ID_TIPOPAIS=pj.ID_TIPOPAIS
      LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
      where a.id_entidad in (
        SELECT id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and a.id_anho::text||LPAD(a.id_mes::text,2,'0')=l_periodo
      and a.estado='1'
      and a.id_comprobante  in ('91','97','98')
      order by a.id_comprobante,
      a.SERIE,
      CASE WHEN LENGTH(trim(both TRANSLATE(a.NUMERO, ' .0123456789', ' '))) IS NULL THEN (a.NUMERO)::numeric ::text ELSE a.NUMERO end;
      --to_char(to_number(a.NUMERO));
      update SIRE_COMPRAS_PRELI_DET set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        NDCONCEPTO_ADIC=NDCONCEPTO_ADIC*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in (
        SELECT id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and TIPOCOMP in ('97')
      and TOTALCP>0
      and id_depto not in ('2','3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_nodom (P_ID_COMPRAS_PRELI bigint, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
