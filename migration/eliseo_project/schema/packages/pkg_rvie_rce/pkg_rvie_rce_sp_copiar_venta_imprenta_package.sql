-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_venta_imprenta (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;

BEGIN
    
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;

      delete from SIRE_VENTAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto  in ('3');

      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_VENTAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;

      
      insert into SIRE_VENTAS_CONTRIBUY(
        ID_VENTAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        VALFACEXPO,
        BIGRAVADA,
        DSCTOBI,
        IGVIPM,
        DSCTOIGVIPM,
        MTOEXONERADO,
        MTOINAFECTO,
        ISC,
        BIGRAVIVAP,
        IVAP,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        NROCPMOD,
        IDPROYOPERATRI,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      
      SELECT
          P_ID_EMPRESA::text||P_PERIODO|| to_char((row_number() OVER ( ORDER BY ID_MOV ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
          P_ID_EMPRESA as ID_EMPRESA,
          7124 AS ID_ENTIDAD,
          '3' AS ID_DEPTO,
          TO_CHAR(FECHA,'YYYYMM') AS PERIODO,
          ((row_number() OVER ( ORDER BY ID_MOV ASC )) + l_orden) as ORDEN,
          FECHA,
          NULL AS FECHA_VENCIMIENTO,
          ID_COMPROBANTE,
          SERIE,
          NUMERO,
          '' AS NRODOFINAL,
          TIPO_DOC,
          NRODOCUMENTO,
          RAZON_SOCIAL,
          0 AS VALFACEXPO,
          BIGRABADA,
          0 AS DSCTOBI,
          IGVIMP,
          0 AS DSCTOIGVIPM,
          MTOEXONERADO,
          MTOINAFECTO,
          0 AS ISC,
          0 AS BIGRAVIVAP,
          0 AS IVAP,
          0 AS ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPO_CAMBIO,
          null AS FECHA_REF,
          TIPOCPMOD,
          SERIECPMOD,
          NROCPMOD,
          '' AS IDPROYOPERATRI,
          CARSUNAT,
          P_ID_USER,
          clock_timestamp()
        from(
          SELECT
            a.ID_MOV_DOC as ID_MOV ,
            A.FECHA,
            A.TIPODOC_VNT AS ID_COMPROBANTE, 
            (CASE A.TIPODOC_VNT WHEN '07' THEN A.SERIE_NOT WHEN '08' THEN A.SERIE_NOT ELSE CASE WHEN A.SERIE_VNT='X' THEN ' '  ELSE A.SERIE_VNT END  END) AS SERIE,
            (CASE A.TIPODOC_VNT WHEN '07' THEN A.NUMNOT WHEN '08' THEN A.NUMNOT ELSE A.NUMDOC END)::numeric ::text AS NUMERO,
            (CASE SUBSTR(A.SERIE_VNT,1,1) WHEN 'F' THEN 6 ELSE CASE WHEN LENGTH(trim(both REGEXP_REPLACE(UPPER(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL)), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', '', 'g')) )=8 THEN 1  ELSE 0 END  END) AS TIPO_DOC,
            (CASE SUBSTR(A.SERIE_VNT,1,1) WHEN 'F' THEN trim(both coalesce(RUC4@DBL_ARON_APP(A.ID_PERSONAL),RUC@DBL_ARON_APP(A.ID_PERSONAL))) ELSE CASE WHEN LENGTH(trim(both REGEXP_REPLACE(UPPER(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL)), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', '', 'g')))=8 THEN FC_DNI@DBL_ARON_APP(A.ID_PERSONAL)  ELSE coalesce(trim(both RUC@DBL_ARON_APP(A.ID_PERSONAL)),'0000') END  END) AS NRODOCUMENTO,
            (CASE SUBSTR(A.SERIE_VNT,1,1) WHEN 'F' THEN trim(both coalesce(APELLIDO2@DBL_ARON_APP(A.ID_PERSONAL),'Cliente Aces Peru')) ELSE trim(both coalesce(APELLIDO2@DBL_ARON_APP(A.ID_PERSONAL),'Cliente UPeU')) END) AS RAZON_SOCIAL,
            CASE WHEN A.TIPO_VENTA='10' THEN coalesce(A.BASE_IMP,0)  ELSE 0 END  AS BIGRABADA,
            coalesce(A.IGV,0) AS IGVIMP,
            CASE WHEN A.TIPO_VENTA='20' THEN coalesce(A.BASE_IMP,0)  ELSE 0 END  AS MTOEXONERADO,
            CASE WHEN A.TIPO_VENTA='30' THEN coalesce(A.BASE_IMP,0)  ELSE 0 END  AS MTOINAFECTO,
            0 as OTROSTRIBUTOS,
            coalesce(A.IMPORTE,0) AS TOTALCP,
            CASE WHEN A.MONEDA='00' THEN 'PEN'  ELSE 'USD' END  AS MONEDA,
            coalesce(A.TIPO_CAMBIO,0) as TIPO_CAMBIO,
            (CASE A.TIPODOC_VNT WHEN '07' THEN A.TIPODOC_NOT WHEN '08' THEN A.TIPODOC_NOT ELSE '' END) AS TIPOCPMOD,
            (CASE A.TIPODOC_VNT WHEN '07' THEN A.SERIE_VNT WHEN '08' THEN A.SERIE_VNT ELSE '' END) AS SERIECPMOD,
            (CASE A.TIPODOC_VNT WHEN '07' THEN LPAD(A.NUMDOC,8,'0') WHEN '08' THEN LPAD(A.NUMDOC,8,'0') ELSE '' END) AS NROCPMOD,
            l_ruc||A.TIPODOC_VNT||(CASE A.TIPODOC_VNT WHEN '07' THEN A.SERIE_NOT WHEN '08' THEN A.SERIE_NOT ELSE CASE WHEN A.SERIE_VNT='X' THEN ' '  ELSE A.SERIE_VNT END  END)||(CASE A.TIPODOC_VNT WHEN '07' THEN LPAD(A.NUMNOT,10,'0') WHEN '08' THEN LPAD(A.NUMNOT,10,'0') ELSE LPAD(A.NUMDOC,10,'0') END) AS CARSUNAT
          FROM IMP_REG_VNT2@DBL_ARON_APP A, DATOS_CLIENTES@DBL_ARON_APP B 
          WHERE A.ID_PERSONAL = B.ID_PERSONAL 
          AND A.ID_VENTA = '001-' ||SUBSTR(P_PERIODO,0,4)
          AND TO_CHAR(A.FECHA,'MM') = SUBSTR(P_PERIODO,5,2)  
          
union all

          SELECT  
            id_mov_vnt as ID_MOV,
            A.FECHA_DOC as FECHA,  
            A.TIPODOC AS ID_COMPROBANTE,
            A.SERIE,  
            A.NUMDOC AS NUMERO,
            CASE WHEN A.TIPODOC='01' THEN 6  ELSE CASE WHEN LENGTH(trim(both REGEXP_REPLACE(UPPER(coalesce(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL),DNI@DBL_ARON_APP(A.ID_PERSONAL))), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', '', 'g')) )=8 THEN 1  ELSE 0 END  END  AS TIPO_DOC,
            CASE WHEN LENGTH(trim(both REGEXP_REPLACE(UPPER(coalesce(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL),DNI@DBL_ARON_APP(A.ID_PERSONAL))), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', '', 'g')))=8 THEN coalesce(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL),DNI@DBL_ARON_APP(A.ID_PERSONAL))  ELSE coalesce(RUC@DBL_ARON_APP(ID_PERSONAL),'0000') END  AS NRODOCUMENTO,
            trim(both coalesce(APELLIDO2@DBL_ARON_APP(A.ID_PERSONAL),'Cliente UPeU')) AS RAZON_SOCIAL,
            coalesce(A.BASE_IMP,0) AS BIGRABADA, 
            coalesce(A.IGV,0) AS IGVIMP,
            coalesce(A.IMP_EXONERADA,0) AS MTOEXONERADO,
            coalesce(A.IMP_INAFECTA,0) AS MTOINAFECTO,
            coalesce(A.OTROS_CARGOS,0) AS OTROSTRIBUTOS, 
            coalesce(A.IMPORTE,0) AS TOTALCP, 
            CASE WHEN coalesce(A.MONEDA,'00')='00' THEN 'PEN'  ELSE 'USD' END  AS MONEDA,
            coalesce(A.TIPO_CAMBIO,1) AS TIPO_CAMBIO,
            '' AS TIPOCPMOD,
            '' AS SERIECPMOD,
            '' AS NROCPMOD,
            l_ruc||A.TIPODOC||A.SERIE||LPAD(A.NUMDOC,10,'0') AS CARSUNAT
          FROM MKT_REGVENTAS@DBL_ARON_APP A       
          WHERE A.ID_NIVEL_CONT  LIKE '3%' 
          AND   A.ID_VENTA='001-'||SUBSTR(P_PERIODO,0,4)
          AND   A.ESTADO='V'         
          AND   TO_CHAR(A.FECHA_PED,'MM')=SUBSTR(P_PERIODO,5,2) 
        )
        ORDER BY ID_COMPROBANTE, serie, NUMERO;

      
      update SIRE_VENTAS_CONTRIBUY set
        VALFACEXPO=VALFACEXPO*(-1),
        BIGRAVADA=BIGRAVADA*(-1),
        DSCTOBI=DSCTOBI*(-1),
        IGVIPM=IGVIPM*(-1),
        DSCTOIGVIPM=DSCTOIGVIPM*(-1),
        MTOEXONERADO=MTOEXONERADO*(-1),
        MTOINAFECTO=MTOINAFECTO*(-1),
        ISC=ISC*(-1),
        BIGRAVIVAP=BIGRAVIVAP*(-1),
        IVAP=IVAP*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP='07'
      and TOTALCP>0
      and id_depto  in ('3');


    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_venta_imprenta (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
