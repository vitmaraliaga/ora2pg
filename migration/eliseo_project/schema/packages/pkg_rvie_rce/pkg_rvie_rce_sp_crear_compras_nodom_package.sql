-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_crear_compras_nodom (P_ID_EMPRESA bigint,P_PERIODO text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;
      l_id bigint:=0;
      l_corr bigint:=0;

BEGIN
    
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;

      select count(1) into STRICT l_contar from SIRE_COMPRAS_PRELI 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO 
      and TIPO_COMPRA='ND'
      and ID_ESTADO_PREL_RVIE not in ('00');

      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Primero elimine los registros anteriores del mes';
--         goto salida;
      end if;

     select coalesce(max(ID_COMPRAS_PRELI),0) +1 into STRICT l_id from SIRE_COMPRAS_PRELI;

     select coalesce(max(CORRELATIVO),0) + 1 into STRICT l_corr from SIRE_COMPRAS_PRELI
      where id_empresa=P_ID_EMPRESA
      and periodo=P_PERIODO;


     INSERT INTO SIRE_COMPRAS_PRELI(
      ID_COMPRAS_PRELI,
      ID_EMPRESA,
      PERIODO,
      TIPO,
      TIPO_COMPRA,
      ID_ESTADO_PREL_RVIE,
      CORRELATIVO,
      ID_USER_REG,
      FECHA_REG
      )VALUES (
        l_id,
        P_ID_EMPRESA,
        P_PERIODO,
        'ND',
        'ND',
        '01',
        l_corr,
        P_ID_USER,
        clock_timestamp()
      );

--     <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_crear_compras_nodom (P_ID_EMPRESA bigint,P_PERIODO text,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
