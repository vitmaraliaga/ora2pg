-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_crear_compras_preliminar (P_ID_EMPRESA bigint,P_PERIODO text,P_TIPO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;
      l_id bigint:=0;
      l_corr bigint:=0;

BEGIN
    
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;

      select count(1) into STRICT l_contar from SIRE_COMPRAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO and ID_ESTADO_PREL_RVIE not in ('00');

      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Primero elimine los registros anteriores del mes';
--         goto salida;
      end if;

     select coalesce(max(ID_COMPRAS_PRELI),0) +1 into STRICT l_id from SIRE_COMPRAS_PRELI;

     if P_TIPO='R' then
      select coalesce(max(CORRELATIVO),0) + 1 into STRICT l_corr from SIRE_COMPRAS_PRELI
      where id_empresa=P_ID_EMPRESA
      and periodo=P_PERIODO;
     end if;

     INSERT INTO SIRE_COMPRAS_PRELI(
      ID_COMPRAS_PRELI,
      ID_EMPRESA,
      PERIODO,
      TIPO,
      TIPO_COMPRA,
      ID_ESTADO_PREL_RVIE,
      CORRELATIVO,
      ID_USER_REG,
      FECHA_REG
      )VALUES (
        l_id,
        P_ID_EMPRESA,
        P_PERIODO,
        P_TIPO,
        'CO',
        '01',
        l_corr,
        P_ID_USER,
        clock_timestamp()
      );

      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI in (
        SELECT ID_COMPRAS_PRELI from SIRE_COMPRAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO
      );

      if P_TIPO='P' then
        insert into SIRE_COMPRAS_PRELI_DET(
          ID_COMPRAS_PRELI_DET,
          ID_COMPRAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          ANHO,
          MES,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          BIGRAVADODG,
          IGVIPMDG,
          BIGRAVADODGNG,
          IGVIPMDGNG,
          BIGRAVADODNG,
          IGVIPMDNG,
          VALORADQNG,
          ISC,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          CODDAMODSI,
          NROCPMOD,
          CLASIFDEBSSYSSS,
          IDPROYOPERATRI,
          PORCPART,
          IMB,
          CARORIGINDEOI,
          DETRACCION,
          TIPODENOTA,
          ESTCOMP,
          INCAL,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        SELECT 
        P_ID_EMPRESA::text||PERIODO|| to_char((row_number() OVER ( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
        l_id,
        (row_number() OVER ( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden,
        'P',
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        ESTCOMP,
        INCAL,
        CARSUNAT,
        1,
        0,
        P_ID_USER,
        clock_timestamp()
        from SIRE_COMPRAS_SUNAT 
        where id_empresa=P_ID_EMPRESA 
        and periodo=P_PERIODO
        order by TIPOCOMP,SERIE,NRODOCINICIAL;
    else
      insert into SIRE_COMPRAS_PRELI_DET(
          ID_COMPRAS_PRELI_DET,
          ID_COMPRAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          ANHO,
          MES,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          BIGRAVADODG,
          IGVIPMDG,
          BIGRAVADODGNG,
          IGVIPMDGNG,
          BIGRAVADODNG,
          IGVIPMDNG,
          VALORADQNG,
          ISC,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          CODDAMODSI,
          NROCPMOD,
          CLASIFDEBSSYSSS,
          IDPROYOPERATRI,
          PORCPART,
          IMB,
          CARORIGINDEOI,
          DETRACCION,
          TIPODENOTA,
          ESTCOMP,
          INCAL,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        SELECT
        P_ID_EMPRESA::text||PERIODO|| to_char((row_number() OVER ( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
        l_id,
        (row_number() OVER ( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden,
        'P',
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        ESTCOMP,
        INCAL,
        CARSUNAT,
        1,
        0,
        P_ID_USER,
        clock_timestamp()
        from SIRE_COMPRAS_SUNAT a
        where a.id_empresa=P_ID_EMPRESA 
        and a.periodo=P_PERIODO
        and a.CARSUNAT in (
          /*select w.CARSUNAT from SIRE_VENTAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
          and w.TIPODOC=a.TIPODOC
          and w.NRODOCUMENTO=a.NRODOCUMENTO
          and lower(w.RAZONSOCIAL)=lower(a.RAZONSOCIAL)
          union*/
          SELECT w.CARSUNAT from SIRE_COMPRAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
          and coalesce(w.BIGRAVADODG,0)= coalesce(a.BIGRAVADODG,0)
          and coalesce(w.IGVIPMDG,0)= coalesce(a.IGVIPMDG,0)
          and coalesce(w.BIGRAVADODGNG,0)= coalesce(a.BIGRAVADODGNG,0)
          and coalesce(w.IGVIPMDGNG,0)= coalesce(a.IGVIPMDGNG,0)
          and coalesce(w.BIGRAVADODNG,0)= coalesce(a.BIGRAVADODNG,0)
          and coalesce(w.IGVIPMDNG,0)= coalesce(a.IGVIPMDNG,0)
          and coalesce(w.VALORADQNG,0)= coalesce(a.VALORADQNG,0)
          and coalesce(w.ISC,0)= coalesce(a.ISC,0)
          and coalesce(w.ICBPER,0)= coalesce(a.ICBPER,0)
          and coalesce(w.OTROSTRIBUTOS,0)= coalesce(a.OTROSTRIBUTOS,0)
          and coalesce(w.TOTALCP,0)= coalesce(a.TOTALCP,0) 
        ) 
        order by a.TIPOCOMP,a.SERIE,a.NRODOCINICIAL;

        
      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI in (
        SELECT ID_COMPRAS_PRELI from SIRE_COMPRAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO
      );

      insert into SIRE_COMPRAS_PRELI_DET(
          ID_COMPRAS_PRELI_DET,
          ID_COMPRAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          ANHO,
          MES,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          BIGRAVADODG,
          IGVIPMDG,
          BIGRAVADODGNG,
          IGVIPMDGNG,
          BIGRAVADODNG,
          IGVIPMDNG,
          VALORADQNG,
          ISC,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          CODDAMODSI,
          NROCPMOD,
          CLASIFDEBSSYSSS,
          IDPROYOPERATRI,
          PORCPART,
          IMB,
          CARORIGINDEOI,
          DETRACCION,
          TIPODENOTA,
          ESTCOMP,
          INCAL,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        SELECT 
        P_ID_EMPRESA::text||PERIODO|| to_char((row_number() OVER ( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
        l_id,
        (row_number() OVER ( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden,
        'P',
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        ESTCOMP,
        INCAL,
        CARSUNAT,
        1,
        0,
        P_ID_USER,
        clock_timestamp()
        from SIRE_COMPRAS_SUNAT a
        where a.id_empresa=P_ID_EMPRESA 
        and a.periodo=P_PERIODO
        and a.CARSUNAT not in (
          SELECT w.CARSUNAT from SIRE_COMPRAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
        ) 
        order by a.TIPOCOMP,a.SERIE,a.NRODOCINICIAL;

    end if;
--     <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_crear_compras_preliminar (P_ID_EMPRESA bigint,P_PERIODO text,P_TIPO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
