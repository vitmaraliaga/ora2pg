-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_orders_sp_create_orden_compra ( P_ID_ANHO integer, P_ID_MES integer, P_ID_PERSONA integer, P_ID_PROVEEDOR integer, P_ID_PEDIDO integer, P_ID_MEDIOPAGO text, P_ID_MONEDA integer, P_FECHA_ENTREGA timestamp(0), P_LUGAR_ENTREGA text, P_OBSERVACIONES text, P_CON_IGV text, P_DIAS_CREDITO bigint, P_ES_CREDITO text, P_CUOTAS text, P_AREA_SOLICITANTE text DEFAULT NULL, P_PERSONAL_CONTACTO text DEFAULT NULL, P_ID_ORDEN OUT integer, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

        L_ID_ORDEN integer;
        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(200);
        L_ID_SEDEAREA varchar(10):='0';
        L_NUMERO varchar(10);
        L_ESTADO varchar(1) :='1';

        
        
BEGIN
            SELECT ID_ENTIDAD,ID_DEPTO, ID_AREAORIGEN INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_SEDEAREA
            FROM PEDIDO_REGISTRO WHERE ID_PEDIDO = P_ID_PEDIDO;

            SELECT LPAD(MAX((coalesce(NUMERO,0))::numeric )+1,8,0) INTO STRICT L_NUMERO FROM COMPRA_ORDEN WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_DEPTO = L_ID_DEPTO;

            INSERT INTO COMPRA_ORDEN(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_PERSONA,ID_PROVEEDOR,ID_PEDIDO,ID_SEDEAREA,ID_MEDIOPAGO,ID_MONEDA,NUMERO,FECHA_PEDIDO,FECHA_ENTREGA,LUGAR_ENTREGA,OBSERVACIONES,CON_IGV,DIAS_CREDITO,ES_CREDITO,CUOTAS,ESTADO, AREA_SOLICITANTE, PERSONAL_CONTACTO)
            VALUES (
                L_ID_ENTIDAD,L_ID_DEPTO,P_ID_ANHO,P_ID_MES,P_ID_PERSONA,P_ID_PROVEEDOR,P_ID_PEDIDO,L_ID_SEDEAREA,P_ID_MEDIOPAGO,P_ID_MONEDA,L_NUMERO,clock_timestamp(),P_FECHA_ENTREGA,P_LUGAR_ENTREGA,P_OBSERVACIONES,P_CON_IGV,P_DIAS_CREDITO,P_ES_CREDITO,P_CUOTAS,L_ESTADO, P_AREA_SOLICITANTE, P_PERSONAL_CONTACTO
            )RETURNING ID_ORDEN INTO L_ID_ORDEN;
                P_ID_ORDEN := L_ID_ORDEN;
                P_ERROR :=0;
                P_MSGERROR := 'OK';
        EXCEPTION
            WHEN OTHERS THEN
            P_MSGERROR := 'ERROR AL REGISTRAR EL ORDEN DE COMPRA'||SQLSTATE||' -ERROR- '||SQLERRM;
            P_ERROR :=1;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_orders_sp_create_orden_compra ( P_ID_ANHO integer, P_ID_MES integer, P_ID_PERSONA integer, P_ID_PROVEEDOR integer, P_ID_PEDIDO integer, P_ID_MEDIOPAGO text, P_ID_MONEDA integer, P_FECHA_ENTREGA timestamp(0), P_LUGAR_ENTREGA text, P_OBSERVACIONES text, P_CON_IGV text, P_DIAS_CREDITO bigint, P_ES_CREDITO text, P_CUOTAS text, P_AREA_SOLICITANTE text DEFAULT NULL, P_PERSONAL_CONTACTO text DEFAULT NULL, P_ID_ORDEN OUT integer, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
