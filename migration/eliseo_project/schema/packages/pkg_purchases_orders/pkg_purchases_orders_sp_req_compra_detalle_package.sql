-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_orders_sp_req_compra_detalle ( P_ID_PEDIDO integer, P_ID_ALMACEN integer, P_ID_ARTICULO integer, P_ID_PEDIDO_ORIGEN integer, P_DETALLE text, P_CANTIDAD bigint, P_PRECIO bigint, P_DESCRIPCION text, P_ID_DETALLE integer DEFAULT NULL, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE


        L_ID_PEDIDO bigint;
        L_ID_DETALLE bigint;
        L_ID_TIPOPEDIDO bigint;
        L_MSN varchar(200);
        L_ESTADO varchar(1):='0';
        L_NUMERO varchar(10);

BEGIN
            INSERT INTO PEDIDO_DETALLE(
                ID_PEDIDO,--PEDIDO
                ID_ALMACEN,--LOGISTICA
                ID_ARTICULO,
                DETALLE,--DESCRIPCION DEL ARTICULO
                CANTIDAD,
                PRECIO,
                IMPORTE,
                DESCRIPCION
            )VALUES (
                P_ID_PEDIDO,--PEDIDO
                P_ID_ALMACEN,--LOGISTICA
                P_ID_ARTICULO,
                P_DETALLE,--DESCRIPCION DEL ARTICULO
                P_CANTIDAD,
                P_PRECIO,
                P_CANTIDAD*P_PRECIO,
                P_DESCRIPCION
            ) RETURNING ID_DETALLE INTO L_ID_DETALLE;
                P_ERROR :=0;
                L_MSN := 'OK';
                P_MSGERROR := L_MSN;

            SELECT ID_TIPOPEDIDO INTO STRICT L_ID_TIPOPEDIDO FROM PEDIDO_REGISTRO WHERE ID_PEDIDO = P_ID_PEDIDO;

            IF L_ID_TIPOPEDIDO = 10 THEN
                IF P_ID_PEDIDO_ORIGEN <> 0 THEN
                    INSERT INTO PEDIDO_REQUERIMIENTO(ID_REQUERIMIENTO,ID_PEDIDO,ID_DETALLE,FECHA, CANTIDAD, ID_DETALLE_ORIGEN)
                    VALUES (P_ID_PEDIDO,P_ID_PEDIDO_ORIGEN,L_ID_DETALLE, clock_timestamp(), P_CANTIDAD, P_ID_DETALLE);
                END IF;
            END IF;

        EXCEPTION
            WHEN OTHERS THEN
            L_MSN := 'ERROR AL REGISTRAR EL DETALLE'||SQLSTATE||' -ERROR- '||SQLERRM||' ::'||P_ID_PEDIDO_ORIGEN;
            P_MSGERROR := L_MSN;
            P_ERROR :=1;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_orders_sp_req_compra_detalle ( P_ID_PEDIDO integer, P_ID_ALMACEN integer, P_ID_ARTICULO integer, P_ID_PEDIDO_ORIGEN integer, P_DETALLE text, P_CANTIDAD bigint, P_PRECIO bigint, P_DESCRIPCION text, P_ID_DETALLE integer DEFAULT NULL, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
