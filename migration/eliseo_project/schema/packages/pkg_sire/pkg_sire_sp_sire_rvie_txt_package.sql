-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sire,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sire_sp_sire_rvie_txt ( P_ID_EMPRESA bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_MES bigint, P_ID_ANHO bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE

    	l_empresa_ruc varchar(20) := '';
    	l_empresa_rs varchar(250) := '';

BEGIN
	    
		SELECT ce2.ID_RUC, ce2.RAZON_SOCIAL INTO STRICT l_empresa_ruc, l_empresa_rs FROM CONTA_EMPRESA ce2 
		WHERE ce2.ID_EMPRESA =P_ID_EMPRESA;

    OPEN CURSOR FOR

    SELECT
        A.id_depto,
        A.id_venta,
        A.glosa,
        A.total,
        trim(both campo_1) as campo1,
        trim(both campo_2) as campo2,
        trim(both campo_3) as campo3,
        trim(both campo_4) as campo4,
        trim(both campo_5) as campo5,
        trim(both campo_6) as campo6,
        trim(both campo_7) as campo7,
        trim(both campo_8) as campo8,
        trim(both campo_9) as campo9,
        trim(both campo_10) as campo10,
        trim(both campo_11) as campo11,
        trim(both campo_12) as campo12,
        trim(both campo_13) as campo13,
        trim(both campo_14) as campo14,
        trim(both campo_15) as campo15,
        trim(both campo_16) as campo16,
        trim(both campo_17) as campo17,
        trim(both campo_18) as campo18,
        trim(both campo_19) as campo19,
        trim(both campo_20) as campo20,
        trim(both campo_21) as campo21,
        trim(both campo_22) as campo22,
        trim(both campo_23) as campo23,
        trim(both campo_24) as campo24,
        trim(both campo_25) as campo25,
        trim(both campo_26) as campo26,
        trim(both campo_27) as campo27,
        trim(both campo_28) as campo28,
        trim(both campo_29) as campo29,
        trim(both campo_30) as campo30,
        trim(both campo_31) as campo31,
        trim(both campo_32) as campo32,
        trim(both campo_33) as campo33,
        trim(both campo_34) as campo34,
        trim(both campo_35) as campo35,
        trim(both campo_35) as campo36,
        --
        trim(both campo_1)||'|'||
        trim(both campo_2)||'|'||
        trim(both campo_3)||'|'||
        trim(both campo_4)||'|'||
        trim(both campo_5)||'|'||
        trim(both campo_6)||'|'||
        trim(both campo_7)||'|'||
        trim(both campo_8)||'|'||
        trim(both campo_9)||'|'||
        trim(both campo_10)||'|'||
        trim(both campo_11)||'|'||
        trim(both campo_12)||'|'||
        trim(both campo_13)||'|'||
        trim(both campo_14)||'|'||
        trim(both campo_15)||'|'||
        trim(both campo_16)||'|'||
        trim(both campo_17)||'|'||
        trim(both campo_18)||'|'||
        trim(both campo_19)||'|'||
        trim(both campo_20)||'|'||
        trim(both campo_21)||'|'||
        trim(both campo_22)||'|'||
        trim(both campo_23)||'|'||
        trim(both campo_24)||'|'||
        trim(both campo_25)||'|'||
        trim(both campo_26)||'|'||
        trim(both campo_27)||'|'||
        trim(both campo_28)||'|'||
        trim(both campo_29)||'|'||
        trim(both campo_30)||'|'||
        trim(both campo_31)||'|'||
        trim(both campo_32)||'|'||
        trim(both campo_33)||'|'||
        trim(both campo_34)||'|'||
        trim(both campo_35)||'|'||
        trim(both campo_36)||'|'||
        '' as datos
from (
SELECT
        A.ID_VENTA ,A.fecha,A.NUMERO ,A.id_voucher, A.glosa, A.TOTAL,A.ID_DEPTO,
        A.ID_ANHO ||lpad(A.ID_MES,2,'0')||'00' AS campo_1,
        coalesce(ELISEO.FC_CONTA_CUO_VENTA(A.ID_VENTA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES ),'') AS campo_2,
        coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO_VENTA(A.ID_VENTA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES ),'') AS campo_3,
        to_char(A.fecha,'DD/MM/YYYY') AS campo_4,
        to_char(A.fecha,'DD/MM/YYYY') AS campo_5,
        A.ID_COMPROBANTE AS campo_6,
        lpad(COALESCE(A.serie,'0'),4,'0') AS campo_7,
        COALESCE(A.numero,'') AS campo_8,
        '' as campo_9,
        CASE A.ID_COMPROBANTE WHEN '01' THEN  6
        ELSE
        CASE(
            SELECT min(pd.ID_TIPODOCUMENTO )::text
            FROM moises.VW_PERSONA_NATURAL pd
            WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL 
             LIMIT 1) WHEN '99' THEN 0 
            WHEN '23' THEN 0 
            ELSE (
            SELECT min(pd.ID_TIPODOCUMENTO )
            FROM moises.VW_PERSONA_NATURAL pd
            WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL 
             LIMIT 1) end
        end as campo_10,
        CASE A.ID_COMPROBANTE
            WHEN '01' THEN (SELECT max(ID_RUC)
                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                        WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL  LIMIT 1)
            WHEN '07' THEN CASE B.ID_COMPROBANTE WHEN '01' THEN (SELECT max(ID_RUC)
                                                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                                                        WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL  LIMIT 1)
                            ELSE (SELECT max(pd.NUM_DOCUMENTO )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL  LIMIT 1) END
            ELSE (SELECT max(pd.NUM_DOCUMENTO )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL  LIMIT 1) end as campo_11,
        CASE A.ID_COMPROBANTE
            WHEN '01' THEN (SELECT max(NOMBRE )
                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                        WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL  LIMIT 1)
            WHEN '07' THEN CASE B.ID_COMPROBANTE WHEN '01' THEN (SELECT max(nombre)
                                                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                                                        WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL  LIMIT 1)  ELSE (SELECT max(pd.nom_persona )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL  LIMIT 1) END
            ELSE (SELECT max(pd.nom_persona )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL  LIMIT 1) end as campo_12,
        '0.00' as campo_13,

        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.GRAVADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.GRAVADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_14,

        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') != to_char(B.fecha, 'yyyymm') then
                trim(to_char((A.GRAVADA+A.EXONERADA+A.INAFECTA) * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            '0.00'
        end
        as campo_15,

        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.IGV * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.IGV * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_16,
        '0.00' as campo_17,
        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.EXONERADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.EXONERADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_18,
        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.INAFECTA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.INAFECTA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_19,
        '' as campo_20,
        '' as campo_21,
        '' as campo_22,
        '0.00' as campo_23,
        '' as campo_24,
        trim(to_char( A.TOTAL * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99')) as campo_25, -- importe total
        'PEN' as campo_26,
        '1.000' as campo_27,
        COALESCE(to_char(B.FECHA,'DD/MM/YYYY'),'') as campo_28, -- fecha de emision del comprobante que modifica
        COALESCE(B.ID_COMPROBANTE ,'') as campo_29,
        COALESCE(B.SERIE ,'') AS campo_30, -- numero de serie del comprobante que modifica
        COALESCE(B.NUMERO ,'') as campo_31, -- numdoc_ref
        '' as campo_32,
        '' as campo_33,
        '' as campo_34,
        '1' as campo_35,
        '' as campo_36,
        '' as other
	FROM eliseo.venta A
	LEFT OUTER JOIN eliseo.venta B ON A.ID_PARENT = B.ID_VENTA
	            where 7=7
	            AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
		      	AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
		      	AND A.ESTADO = '1'
				AND A.ID_MES = P_ID_MES
				AND A.ID_ANHO = P_ID_ANHO 
            ) a 
            ORDER BY fecha, NUMERO;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sire_sp_sire_rvie_txt ( P_ID_EMPRESA bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_MES bigint, P_ID_ANHO bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
