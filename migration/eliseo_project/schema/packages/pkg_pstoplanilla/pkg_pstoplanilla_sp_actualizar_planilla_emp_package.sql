-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;

        
        /*PROCEDURE SP_GENERAR_PLANILLA_CARGO(P_ID_ENTIDAD numeric,P_ID_ANHO numeric,P_ID_DEPTO varchar,P_ID_DEPTO_PADRE IN numeric,P_ID_AUXILIAR IN numeric,P_ERROR OUT numeric,P_MSGERROR out varchar) IS
          l_error numeric:=0;
          l_msgerror varchar(200):='';
          l_contar numeric;
          l_anho numeric;
          l_mes numeric;
          
          l_id_cargo_proceso numeric;

              
        BEGIN
          
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
          
          SELECT COALESCE(MAX(ID_CARGO_PROCESO),0) INTO l_contar FROM PSTO_PLLA_CARGO_PROCESO;
          
          insert into PSTO_PLLA_CARGO_PROCESO(
            ID_CARGO_PROCESO, 
            ID_ANHO,
            ID_ENTIDAD,
            ID_DEPTO,
            ID_DEPTO_PADRE,
            ID_CARGO,
            CANTIDAD
          )
          SELECT
          ROWNUM + l_contar AS ID_CARGO_PROCESO,
          P_ID_ANHO,
          P_ID_ENTIDAD,
          P_ID_DEPTO,
          P_ID_DEPTO_PADRE,
          X.ID_CARGO,
          X.CANTIDAD
          FROM(
          SELECT 
          COALESCE(a.ID_CARGO,p.ID_CARGO) AS ID_CARGO,
          COUNT(*) AS CANTIDAD
          FROM APS_PLANILLA a, APS_TRABAJADOR p
          WHERE a.ID_PERSONA=P.ID_PERSONA
          AND a.ID_ENTIDAD=P_ID_ENTIDAD
          AND a.ID_ANHO=l_anho
          AND a.ID_MES=l_mes
          AND a.ID_DEPTO=P_ID_DEPTO
          AND COALESCE(a.ID_CARGO,p.ID_CARGO) NOT IN(
            SELECT ID_CARGO FROM PSTO_PLLA_CARGO_PROCESO
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND  ID_DEPTO=P_ID_DEPTO
            AND  ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            AND  ID_ANHO=P_ID_ANHO
          )
          GROUP BY 
          COALESCE(a.ID_CARGO,p.ID_CARGO)
          ORDER BY COALESCE(a.ID_CARGO,p.ID_CARGO)
         )X;
        
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;
        END SP_GENERAR_PLANILLA_CARGO;
        */
        /*PROCEDURE SP_ACTUALIZAR_PLANILLA_EMP_ANT(P_ID_PSTO_PLANILLA numeric,P_ERROR OUT numeric,P_MSGERROR out varchar) IS
          l_error numeric:=0;
          l_msgerror varchar(200):='';
          l_contar numeric;
          l_id_anho numeric;
          l_uniforme varchar(2);
          l_docente_tc varchar(2);
          l_tipo_area varchar(2);
          l_id_cond_lab varchar(5);
          l_ant_basico numeric(10,2);
          l_ant_prima_inf  numeric(10,2);
          l_ant_asig_fam numeric(10,2);
          
          l_imp_movi_lib_dis numeric(10,2):=0;
          l_imp_ayudaanual numeric(10,2):=0;
          
          l_finicio	timestamp;
          l_ffin	timestamp;

          
          l_param_fmr_ant numeric(10,5);
          l_param_fmr  numeric(10,2);
          l_param_inc_anual  numeric(10,5);
          l_param_essalud  numeric(10,5);
          l_param_rmv  numeric(10,5);
          l_param_af  numeric(10,5);
          l_param_midc  numeric(10,5);
          l_param_madc  numeric(10,5);
          l_param_bono_mis  numeric(10,5);
          l_param_unif  numeric(10,5);
          l_param_unif_jefe  numeric(10,5);
          l_param_ppg_i  numeric(20,14);
          l_param_ppg_ii  numeric(10,5);
          l_param_seg_vida  numeric(10,5);
          l_param_igv  numeric(10,5);
          
          l_cal_meses numeric(10,2);
          l_cal_prima_inf numeric(10,2);
          l_cal_sueldo numeric(10,2):=0;

          l_id_entidad numeric;
          l_id_persona numeric;
          
          
          l_hextras25 numeric(10,2):=0;
          l_hextras35 numeric(10,2):=0;
          l_hnocturna numeric(10,2):=0;
          l_hferiado numeric(10,2):=0;
        
              
        BEGIN
          
          SELECT 
          ID_ANHO,UNIFORME,DOCENTE_TC,TIPO_AREA,ID_COND_LAB,ANT_BASICO,ANT_PRIMA_INF,ANT_ASIG_FAM,FINICIO,FFIN,ID_ENTIDAD,ID_PERSONA
          into
          l_id_anho,l_uniforme, l_docente_tc, l_tipo_area, l_id_cond_lab, l_ant_basico, l_ant_prima_inf, l_ant_asig_fam,l_finicio,l_ffin,l_id_entidad,l_id_persona
          FROM PSTO_PLLA_PLANILLA
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
          
          
          select IMPORTE INTO l_param_fmr_ant from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR_ANT' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_fmr from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_inc_anual from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_INC_ANUAL' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_essalud from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ESSALUD' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_rmv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_RMV' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_af from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_AF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_midc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MIDC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_madc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MADC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_bono_mis from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_BONO_MIS' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_unif from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_unif_jefe from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF_JEFE' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_ppg_i from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_I' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_ppg_ii from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_II' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_seg_vida from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_SEG_VIDA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_igv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_IGV' AND ID_ANHO=l_id_anho;
          
          select IMPORTE INTO l_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;

      
          select FC_PSTO_CALC_MESES(l_finicio,l_ffin,l_id_anho),
          l_ant_prima_inf/l_param_fmr_ant
          into
          l_cal_meses,l_cal_prima_inf
          from dual;
          l_cal_sueldo:=0;
          
          if l_id_cond_lab='M' then
            if l_ant_basico/l_param_fmr_ant<0.95 then
              l_cal_sueldo:=(l_ant_basico/l_param_fmr_ant)+0.05;
            elsif l_ant_basico/l_param_fmr_ant>=1 then
              l_cal_sueldo:=(l_ant_basico/l_param_fmr_ant)+0.01;
            else
              l_cal_sueldo:=  (1-(l_ant_basico/l_param_fmr_ant))+(l_ant_basico/l_param_fmr_ant);
            end if;
          else
            if l_docente_tc='S' then
              if l_ant_basico<l_param_midc then
                l_cal_sueldo:=l_param_madc-l_ant_basico;
              else
                l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
              end if;
            else
              l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
            end if;
          end if;
        
        update PSTO_PLLA_PLANILLA set
        CAL_MESES=l_cal_meses,
        CAL_PRIMA_INF=l_cal_prima_inf,
        CAL_SUELDO=l_cal_sueldo,
        IMP_BONI_CARGO=ANT_BONI_CARGO,
        IMP_ASIG_FAM=case when ID_COND_LAB<>'M' then case when l_ant_asig_fam>0 then l_param_af else 0 end else 0 end ,
        IMP_VIV_REMUN=ANT_VIV_REMUN,
        IMP_SODEXO=ANT_SODEXO,
        IMP_BASICO=case when ID_COND_LAB='M' then l_param_fmr*l_cal_sueldo else FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) end,
        IMP_MODAL_FORMATIVA=case when ID_COND_LAB='P' then FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) else 0 end,
        IMP_PRIMA_INF=case when ID_COND_LAB='M' then case when l_ant_prima_inf>0 then l_cal_prima_inf*l_param_fmr else 0 end else 0 end,
        IMP_BONO_MIS=case when ID_COND_LAB='M' then l_param_bono_mis else 0 end,
        IMP_UNIFORME=case when UNIFORME='N' or ID_TIEMPOTRABAJO=2 then 0 else case when  TIPO_AREA='A' and ID_CATEGORIA IS NULL THEN l_param_unif ELSE l_param_unif_jefe END end,
        IMP_HEXTRAS25=case when ESHEXTRAS25=1 then l_hextras25 else 0 end,
        IMP_HEXTRAS35=case when ESHEXTRAS35=1 then l_hextras35 else 0 end,
        IMP_HNOCTURNA=case when ESHNOCTURNA=1 then l_hnocturna else 0 end,
        IMP_HFERIADO=case when ESHFERIADO=1 then l_hferiado else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
          
        update PSTO_PLLA_PLANILLA set
        IMP_PPG=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_ppg_i*l_param_ppg_ii)*12 else 0 end,
        IMP_SEGURO_VIDA=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_seg_vida*CAL_MESES)*(1+l_param_igv) else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --vac truncas essalud
        update PSTO_PLLA_PLANILLA set
        IMP_VAC_TRUNCA=case when ID_COND_LAB='C' and ID_TIEMPOTRABAJO=1  then 
          ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )/12)*CAL_MESES
        else 0 end,
        IMP_ESSALUD=case when ID_TIEMPOTRABAJO=1  then 
          (((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )*l_param_essalud)*CAL_MESES)+(coalesce(IMP_BONO_MIS,0)*l_param_essalud)+(coalesce(IMP_REINT5TACAT,0)*l_param_essalud)
        else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --gratificacion
        update PSTO_PLLA_PLANILLA set
        IMP_GRATIFICACION= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --cts
        update PSTO_PLLA_PLANILLA set
         IMP_CTS= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_GRATIFICACION,0)/6)+(coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        
        --bonificacion extraordinaria
        update PSTO_PLLA_PLANILLA set
        IMP_BONI_EXTRA= ((((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES)*2)*l_param_essalud
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --ayuda y movilidad
        if l_id_cond_lab='M' then
        
          select count(*) into l_contar from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
        
          if l_contar=1 then
            select IMP_TOTAL into l_imp_movi_lib_dis from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;
          
          select count(*) into l_contar from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
        
          if l_contar=1 then
            select IMP_ANUAL_REG into l_imp_ayudaanual from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;
    
        
          update PSTO_PLLA_PLANILLA set
          IMP_MOVI_LIB_DIS=l_imp_movi_lib_dis,
          IMP_AYUDAANUAL=l_imp_ayudaanual
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        end if;
        
        
        --total
          update PSTO_PLLA_PLANILLA set
          TOTAL=COALESCE(IMP_BONI_CARGO,0)*CAL_MESES+
                COALESCE(IMP_ASIG_FAM,0)*CAL_MESES+
                COALESCE(IMP_MOVI_LIB_DIS,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS25,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS35,0)*CAL_MESES+
                COALESCE(IMP_HNOCTURNA,0)*CAL_MESES+
                COALESCE(IMP_HFERIADO,0)*CAL_MESES+
                COALESCE(IMP_VIV_REMUN,0)*CAL_MESES+
                COALESCE(IMP_SODEXO,0)*CAL_MESES+
                COALESCE(IMP_AYUDAANUAL,0)+
                COALESCE(IMP_REINT5TACAT,0)+
                COALESCE(IMP_BASICO,0)*CAL_MESES+
                COALESCE(IMP_MODAL_FORMATIVA,0)*CAL_MESES+
                COALESCE(IMP_PRIMA_INF,0)*CAL_MESES+
                COALESCE(IMP_GRATIFICACION,0)*2+
                COALESCE(IMP_BONO_MIS,0)+
                COALESCE(IMP_ESSALUD,0)+
                COALESCE(IMP_UNIFORME,0)+
                COALESCE(IMP_BONI_EXTRA,0)+
                COALESCE(IMP_CTS,0)+
                COALESCE(IMP_VAC_TRUNCA,0)+
                COALESCE(IMP_PPG,0)+
                COALESCE(IMP_SEGURO_VIDA,0)
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
         
        PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_ACTIVIDAD(P_ID_PSTO_PLANILLA,l_error,l_msgerror);
         
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_ACTUALIZAR_PLANILLA_EMP_ANT;
        */
CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_actualizar_planilla_emp (P_ID_PSTO_PLANILLA bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;
          l_id_anho bigint;
          l_uniforme varchar(2);
          l_docente_tc varchar(2);
          l_tipo_area varchar(2);
          l_id_cond_lab varchar(5);
          l_ant_basico decimal(10,2);
          l_ant_prima_inf  decimal(10,2);
          l_ant_asig_fam decimal(10,2);

          l_imp_movi_lib_dis decimal(10,2):=0;
          l_imp_ayudaanual decimal(10,2):=0;

          l_finicio	timestamp(0);
          l_ffin	timestamp(0);


          l_param_fmr_ant decimal(10,5);
          l_param_fmr  decimal(10,2);
          l_param_inc_anual  decimal(10,5);
          l_param_essalud  decimal(10,5);
          l_param_rmv  decimal(10,5);
          l_param_af  decimal(10,5);
          l_param_midc  decimal(10,5);
          l_param_madc  decimal(10,5);
          l_param_bono_mis  decimal(10,5);
          l_param_unif  decimal(10,5);
          l_param_unif_jefe  decimal(10,5);
          l_param_ppg_i  decimal(20,14);
          l_param_ppg_ii  decimal(10,5);
          l_param_seg_vida  decimal(10,5);
          l_param_igv  decimal(10,5);

          l_cal_meses decimal(10,2);
          l_cal_prima_inf decimal(10,2);
          l_cal_sueldo decimal(10,2):=0;
          l_imp_vivienda decimal(10,2):=0;

          l_id_entidad bigint;
          l_id_persona bigint;

          
          l_hextras25 decimal(10,2):=0;
          l_hextras35 decimal(10,2):=0;
          l_hnocturna decimal(10,2):=0;
          l_hferiado decimal(10,2):=0;

          l_id_temporada varchar(5);

        
BEGIN
          
          SELECT 
          ID_ANHO,UNIFORME,DOCENTE_TC,TIPO_AREA,ID_COND_LAB,ANT_BASICO,ANT_PRIMA_INF,ANT_ASIG_FAM,FINICIO,FFIN,ID_ENTIDAD,ID_PERSONA,ID_TEMPORADA
          into STRICT
          l_id_anho,l_uniforme, l_docente_tc, l_tipo_area, l_id_cond_lab, l_ant_basico, l_ant_prima_inf, l_ant_asig_fam,l_finicio,l_ffin,l_id_entidad,l_id_persona,l_id_temporada
          FROM PSTO_PLLA_PLANILLA
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

          
          select IMPORTE INTO STRICT l_param_fmr_ant from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR_ANT' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_fmr from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_inc_anual from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_INC_ANUAL' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_essalud from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ESSALUD' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_rmv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_RMV' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_af from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_AF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_midc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MIDC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_madc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MADC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_bono_mis from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_BONO_MIS' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_unif from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_unif_jefe from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF_JEFE' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_ppg_i from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_I' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_ppg_ii from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_II' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_seg_vida from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_SEG_VIDA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_param_igv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_IGV' AND ID_ANHO=l_id_anho;

          select IMPORTE INTO STRICT l_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO STRICT l_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;


          select FC_PSTO_CALC_MES_TEMPORADA(l_id_temporada),
          l_ant_prima_inf/l_param_fmr_ant
          into STRICT
          l_cal_meses,l_cal_prima_inf
;

          l_cal_sueldo:=0;

          if l_id_cond_lab='M' then
            
            l_cal_sueldo:=  0;

          else
            if l_docente_tc='S' then
              if l_ant_basico<l_param_midc then
                l_cal_sueldo:=l_param_madc-l_ant_basico;
              else
                l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
              end if;
            else
              l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
            end if;
          end if;

        update PSTO_PLLA_PLANILLA set
        CAL_MESES=l_cal_meses,
        CAL_PRIMA_INF=l_cal_prima_inf,
        CAL_SUELDO=l_cal_sueldo,
        IMP_BONI_CARGO=ANT_BONI_CARGO,
        IMP_ASIG_FAM=case when ID_COND_LAB<>'M' then case when l_ant_asig_fam>0 then l_param_af else 0 end else 0 end ,
        --IMP_VIV_REMUN=ANT_VIV_REMUN,
        IMP_SODEXO=ANT_SODEXO,
        IMP_BASICO=case when ID_COND_LAB='M' then l_param_fmr*(FMR/100) else FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) end,
        IMP_MODAL_FORMATIVA=case when ID_COND_LAB='P' then FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) else 0 end,
        IMP_PRIMA_INF=case when ID_COND_LAB='M' then case when l_ant_prima_inf>0 then l_cal_prima_inf*l_param_fmr else 0 end else 0 end,
        IMP_BONO_MIS=case when ID_COND_LAB='M' then l_param_bono_mis else 0 end,
        IMP_UNIFORME=0,--case when UNIFORME='N' or ID_TIEMPOTRABAJO=2 then 0 else case when  TIPO_AREA='A' and ID_CATEGORIA IS NULL THEN l_param_unif ELSE l_param_unif_jefe END end,
        IMP_HEXTRAS25=case when ESHEXTRAS25=1 then l_hextras25 else 0 end,
        IMP_HEXTRAS35=case when ESHEXTRAS35=1 then l_hextras35 else 0 end,
        IMP_HNOCTURNA=case when ESHNOCTURNA=1 then l_hnocturna else 0 end,
        IMP_HFERIADO=case when ESHFERIADO=1 then l_hferiado else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

          
        update PSTO_PLLA_PLANILLA set
        IMP_PPG=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_ppg_i*l_param_ppg_ii)*12 else 0 end,
        IMP_SEGURO_VIDA=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_seg_vida*CAL_MESES)*(1+l_param_igv) else 0 end  ---pendiente
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        --vac truncas essalud
        update PSTO_PLLA_PLANILLA set
        IMP_VAC_TRUNCA=case when ID_COND_LAB='C' and ID_TIEMPOTRABAJO=1  then 
          ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )/12)*CAL_MESES
        else 0 end,
        IMP_ESSALUD=case when ID_TIEMPOTRABAJO=1  then 
          (((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )*l_param_essalud)*CAL_MESES)+(coalesce(IMP_BONO_MIS,0)*l_param_essalud)+(coalesce(IMP_REINT5TACAT,0)*l_param_essalud)
        else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        --gratificacion
        update PSTO_PLLA_PLANILLA set
        IMP_GRATIFICACION= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        --cts
        update PSTO_PLLA_PLANILLA set
         IMP_CTS= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_GRATIFICACION,0)/6)+(coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        
        --bonificacion extraordinaria
        update PSTO_PLLA_PLANILLA set
        IMP_BONI_EXTRA= ((((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES)*2)*l_param_essalud
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        --ayuda y movilidad
        --if l_id_cond_lab='M' then
        
          select count(*) into STRICT l_contar from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;

          if l_contar=1 then
            select IMP_TOTAL into STRICT l_imp_movi_lib_dis from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;

          select count(*) into STRICT l_contar from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;

          if l_contar=1 then
            select IMP_ANUAL_REG into STRICT l_imp_ayudaanual from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;

          select count(*) into STRICT l_contar from PSTO_PLLA_VIVIENDA WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;

          if l_contar=1 then
            select IMP_IMPORTE into STRICT l_imp_vivienda from PSTO_PLLA_VIVIENDA WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;

          update PSTO_PLLA_PLANILLA set
          IMP_MOVI_LIB_DIS=l_imp_movi_lib_dis,
          IMP_AYUDAANUAL=l_imp_ayudaanual,
          IMP_VIV_REMUN=l_imp_vivienda
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        --end if;
        
        
        --total
          update PSTO_PLLA_PLANILLA set
          TOTAL=COALESCE(IMP_BONI_CARGO,0)*CAL_MESES+
                COALESCE(IMP_ASIG_FAM,0)*CAL_MESES+
                COALESCE(IMP_MOVI_LIB_DIS,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS25,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS35,0)*CAL_MESES+
                COALESCE(IMP_HNOCTURNA,0)*CAL_MESES+
                COALESCE(IMP_HFERIADO,0)*CAL_MESES+
                COALESCE(IMP_VIV_REMUN,0)*CAL_MESES+
                COALESCE(IMP_SODEXO,0)*CAL_MESES+
                COALESCE(IMP_AYUDAANUAL,0)+
                COALESCE(IMP_REINT5TACAT,0)+
                COALESCE(IMP_BASICO,0)*CAL_MESES+
                COALESCE(IMP_MODAL_FORMATIVA,0)*CAL_MESES+
                COALESCE(IMP_PRIMA_INF,0)*CAL_MESES+
                COALESCE(IMP_GRATIFICACION,0)*2+
                COALESCE(IMP_BONO_MIS,0)+
                COALESCE(IMP_ESSALUD,0)+
                COALESCE(IMP_UNIFORME,0)+
                COALESCE(IMP_BONI_EXTRA,0)+
                COALESCE(IMP_CTS,0)+
                COALESCE(IMP_VAC_TRUNCA,0)+
                COALESCE(IMP_PPG,0)+
                COALESCE(IMP_SEGURO_VIDA,0)
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        CALL pkg_pstoplanilla_sp_generar_planilla_dist_det(P_ID_PSTO_PLANILLA,l_error,l_msgerror);
        --PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_ACTIVIDAD(P_ID_PSTO_PLANILLA,l_error,l_msgerror);
         
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_actualizar_planilla_emp (P_ID_PSTO_PLANILLA bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
