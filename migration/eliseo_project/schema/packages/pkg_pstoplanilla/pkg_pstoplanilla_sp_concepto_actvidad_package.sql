-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_concepto_actvidad (P_AUXI_IDENTIFICADOR text,P_ID_DEPTO_PADRE bigint) AS $body$
DECLARE


          l_contar bigint;
          l_id_evento bigint;
          l_id_auxiliar bigint;

BEGIN
        
          SELECT COALESCE(MAX(ID_CONCEPTO_ACTIVIDAD),0) INTO STRICT l_contar FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD;

          select ID_AUXILIAR  into STRICT l_id_auxiliar from PSTO_AUXILIAR 
          where IDENTIFICADOR=P_AUXI_IDENTIFICADOR
          AND ID_DEPTO=P_ID_DEPTO_PADRE;

          select id_evento  into STRICT l_id_evento from psto_evento 
          where id_auxiliar=l_id_auxiliar;

        
          INSERT INTO PSTO_PLLA_CONCEPTO_ACTIVIDAD(
            ID_CONCEPTO_ACTIVIDAD,
            ID_ACTIVIDAD,
            ID_DEPTO_PADRE,
            ID_CONCEPTOAPS,
            COLUMNA_IMP,
            FORMULA,
            AUXI_IDENTIFICADOR,
            ESTADO,
            DISTRIBUIDO
          )
          SELECT 
            row_number() OVER () + l_contar AS ID_CONCEPTO_ACTIVIDAD,
            M.ID_ACTIVIDAD, 
            P_ID_DEPTO_PADRE,
            NULL,
            NULL,
            NULL,
            P_AUXI_IDENTIFICADOR,
            '1',
            'S'
          FROM (
            SELECT 
            A.ID_ACTIVIDAD 
            FROM PSTO_ACTIVIDAD A
            WHERE A.ESTADO='1'
            AND ID_EVENTO=l_id_evento
            AND A.ID_ACTIVIDAD NOT IN (
              SELECT B.ID_ACTIVIDAD FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD B
              WHERE B.AUXI_IDENTIFICADOR=P_AUXI_IDENTIFICADOR
              AND B.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            )  ORDER BY A.ID_ACTIVIDAD
          )M;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_concepto_actvidad (P_AUXI_IDENTIFICADOR text,P_ID_DEPTO_PADRE bigint) FROM PUBLIC;
