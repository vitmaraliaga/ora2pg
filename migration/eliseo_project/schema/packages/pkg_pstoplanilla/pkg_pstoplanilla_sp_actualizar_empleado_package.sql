-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_actualizar_empleado (P_ID_PSTO_PLANILLA bigint, P_ID_CARGO_PROCESO bigint,P_ID_TIPOCONTRATO bigint,P_ID_COND_LAB text,P_DOCENTE_TC text, P_ESHEXTRAS25 bigint,P_ESHEXTRAS35 bigint,P_ESHNOCTURNA bigint,P_ESHFERIADO bigint, P_ANT_BASICO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;

          l_anho bigint;
          l_mes bigint;
          l_id_cargo bigint;
          l_id_tipocontrato bigint;
          l_tipo_area varchar(2);
          l_es_misionero varchar(10);
          l_id_cond_lab varchar(5);


  
          l_id_entidad bigint;
          l_id_anho bigint;
          l_id_depto bigint;
          l_id_depto_padre bigint;
          l_id_cargosueldo_escala bigint;
          l_id_condicion_escala varchar(2);
          l_id_temporada varchar(2);

           l_imp_hextras25 decimal(10,2);
           l_imp_hextras35 decimal(10,2);
           l_imp_hnocturna decimal(10,2);
           l_imp_hferiado decimal(10,2);
            l_cal_meses bigint;
           l_tiempotrabajo bigint;
           l_porcentaje decimal(10,2);
           l_actual  decimal(10,2);
           l_minimo decimal(10,2);
           l_maximo decimal(10,2);
           l_id_persona bigint;

           l_fmr decimal(10,2);

        
BEGIN
        
          SELECT ID_ENTIDAD,ID_ANHO,ID_DEPTO,ID_DEPTO_PADRE,ID_CARGOSUELDO_ESCALA,ID_TEMPORADA,ID_TIEMPOTRABAJO
          INTO STRICT l_id_entidad,l_id_anho,l_id_depto,l_id_depto_padre,l_id_cargosueldo_escala,l_id_temporada,l_tiempotrabajo
          FROM PSTO_PLLA_CARGO_PROCESO
          WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;

          select IMPORTE INTO STRICT l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=l_id_anho;

          select IMPORTE INTO STRICT l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=l_id_anho;

          select CASE WHEN P_ESHEXTRAS25=1 THEN IMPORTE END INTO STRICT l_imp_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHEXTRAS35=1 THEN IMPORTE END INTO STRICT l_imp_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHNOCTURNA=1 THEN IMPORTE END INTO STRICT l_imp_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHFERIADO=1 THEN IMPORTE END  INTO STRICT l_imp_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;

          
           select FC_PSTO_CALC_MES_TEMPORADA(l_id_temporada) into STRICT l_cal_meses;


          select TIPO into STRICT  l_tipo_area from PSTO_AREA_DEPTO where id_entidad= l_id_entidad and id_depto=l_id_depto;

          
          SELECT ID_PERSONA INTO STRICT l_id_persona FROM PSTO_PLLA_PLANILLA WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

          
          UPDATE PSTO_PLLA_PLANILLA  SET 
              ID_TIPOCONTRATO=P_ID_TIPOCONTRATO,
              DOCENTE_TC=P_DOCENTE_TC,
              TIPO_AREA=l_tipo_area,
              ID_COND_LAB=P_ID_COND_LAB,
              ID_TIEMPOTRABAJO=l_tiempotrabajo,
              ID_TEMPORADA=l_id_temporada,
              ESHEXTRAS25=P_ESHEXTRAS25,
              ESHEXTRAS35=P_ESHEXTRAS35,
              ESHNOCTURNA=P_ESHNOCTURNA,
              ESHFERIADO=P_ESHFERIADO,
              IMP_HEXTRAS25=l_imp_hextras25,
              IMP_HEXTRAS35=l_imp_hextras35,
              IMP_HNOCTURNA=l_imp_hnocturna,
              IMP_HFERIADO=l_imp_hferiado,
              CAL_MESES=l_cal_meses,
              ANT_BASICO=P_ANT_BASICO
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

          select coalesce(minimo,0),coalesce(maximo,0),l_id_condicion_escala into STRICT l_minimo, l_maximo,l_id_condicion_escala from PSTO_PLLA_CARGOSUELDO_ESCALA where ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;

            select IMP_BASICO into STRICT l_actual from PSTO_PLLA_PLANILLA where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

            if P_ID_COND_LAB='M' then
              /*if l_minimo>0 and l_maximo>0 then
                if l_actual<l_minimo and l_actual>l_maximo then
                  l_error:=0;
                 -- l_msgerror:='Haber BÃ¡sico Actual '||replace(to_char(l_actual),',','.')|| ' escala salarial MIN: '||replace(to_char(l_minimo),',','.')||' MAX: '||replace(to_char(l_maximo),',','.');
                end if;
              end if;
            else*/
            
              SELECT count(*) INTO STRICT l_contar
                  FROM PSTO_PLLA_PUNTAJE_MIS 
                  WHERE ID_ENTIDAD=l_id_entidad
                  AND ID_PERSONA=l_id_persona
                  AND ID_ANHO=l_id_anho;

              if l_contar=1 then
              
              SELECT punt_aprobado INTO STRICT l_fmr
              FROM PSTO_PLLA_PUNTAJE_MIS 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_PERSONA=l_id_persona
               AND ID_ANHO=l_id_anho;

              UPDATE PSTO_PLLA_PLANILLA SET FMR=l_fmr
              where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
              end if;
            end if;

          
                    
          CALL pkg_pstoplanilla_sp_actualizar_planilla_emp(P_ID_PSTO_PLANILLA,l_error,l_msgerror);

         
          select PORCENTAJE into STRICT  l_porcentaje from PSTO_PLLA_PLANILLA_DIST 
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA 
          AND TIPO='1';

          CALL pkg_pstoplanilla_sp_generar_planilla_dist(P_ID_PSTO_PLANILLA,l_id_depto,l_id_temporada,l_porcentaje,'1',l_error,l_msgerror);

      
      
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_actualizar_empleado (P_ID_PSTO_PLANILLA bigint, P_ID_CARGO_PROCESO bigint,P_ID_TIPOCONTRATO bigint,P_ID_COND_LAB text,P_DOCENTE_TC text, P_ESHEXTRAS25 bigint,P_ESHEXTRAS35 bigint,P_ESHNOCTURNA bigint,P_ESHFERIADO bigint, P_ANT_BASICO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
