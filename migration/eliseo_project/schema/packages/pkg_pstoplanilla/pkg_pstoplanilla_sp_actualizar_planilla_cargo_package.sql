-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_actualizar_planilla_cargo (P_ID_CARGO_PROCESO bigint,P_ID_RENOVABLE text,P_ID_SEXO bigint,P_ID_EDAD text,P_ID_NIVEL_EDU text,P_ID_TIPOESTADOCIVIL bigint,P_ID_TIEMPOTRABAJO bigint,P_ID_TEMPORADA text,P_CANTIDAD bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;
          l_id_anho bigint;
          l_id_entidad bigint;
          l_id_depto varchar(10);
          l_id_depto_padre varchar(10);
          l_id_cargo bigint;
          l_id_renovable varchar(10);
          l_id_sexo bigint;
          l_id_edad varchar(10);
          l_id_nivel_edu varchar(10);
          l_id_tipoestadocivil bigint;
          l_id_tiempotrabajo bigint;
          l_id_temporada varchar(10);
          l_id_condicion_escala varchar(10);

          l_id_cargosueldo_escala bigint;


BEGIN
        
          select ID_CARGOSUELDO_ESCALA,ID_DEPTO into STRICT l_id_cargosueldo_escala,l_id_depto from PSTO_PLLA_CARGO_PROCESO WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;

            SELECT 
            ID_ANHO,
            ID_ENTIDAD,
            ID_DEPTO_PADRE,
            ID_CARGO,
            id_condicion_escala
            INTO STRICT 
            l_id_anho,
            l_id_entidad,
            l_id_depto_padre,
            l_id_cargo,
            l_id_condicion_escala
          FROM PSTO_PLLA_CARGOSUELDO_ESCALA
          WHERE ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;

            SELECT 
                    COUNT(*) INTO STRICT l_contar
            FROM PSTO_PLLA_CARGO_PROCESO
            WHERE ID_ANHO=l_id_anho
            AND ID_ENTIDAD=l_id_entidad
            AND ID_DEPTO=l_id_depto
            AND ID_DEPTO_PADRE=l_id_depto_padre
            AND ID_CARGO=l_id_cargo
            AND coalesce(ID_RENOVABLE,'-')=P_ID_RENOVABLE
            AND coalesce(ID_SEXO,0)=P_ID_SEXO
            AND coalesce(ID_EDAD,'-')=P_ID_EDAD
            AND coalesce(ID_NIVEL_EDU,'-')=P_ID_NIVEL_EDU
            AND coalesce(ID_TIPOESTADOCIVIL,0)=P_ID_TIPOESTADOCIVIL
            AND coalesce(ID_TIEMPOTRABAJO,0)=P_ID_TIEMPOTRABAJO
            AND coalesce(ID_TEMPORADA,'-')=P_ID_TEMPORADA
            AND ID_CARGO_PROCESO<>P_ID_CARGO_PROCESO;

           IF l_contar=0 THEN 
          
          
            l_id_renovable:=P_ID_RENOVABLE;
            IF P_ID_RENOVABLE='-' THEN
              l_id_renovable:=NULL;
            END IF;

            l_id_sexo:=P_ID_SEXO;
            IF P_ID_SEXO=0 THEN
              l_id_sexo:=NULL;
            END IF;

            l_id_edad:=P_ID_EDAD;
            IF P_ID_EDAD='-' THEN
              l_id_edad:=NULL;
            END IF;

            l_id_nivel_edu:=P_ID_NIVEL_EDU;
            IF P_ID_NIVEL_EDU='-' THEN
              l_id_nivel_edu:=NULL;
            END IF;

            l_id_tipoestadocivil:=P_ID_TIPOESTADOCIVIL;
            IF P_ID_TIPOESTADOCIVIL=0 THEN
              l_id_tipoestadocivil:=NULL;
          END IF;

          l_id_tiempotrabajo:=P_ID_TIEMPOTRABAJO;
          IF P_ID_TIEMPOTRABAJO=0 THEN
            l_id_tiempotrabajo:=NULL;
          END IF;

          l_id_temporada:=P_ID_TEMPORADA;
          IF P_ID_TEMPORADA='-' THEN
            l_id_temporada:=NULL;
          END IF;

          
          if l_id_condicion_escala='M' then
            if l_id_renovable<>'R3' then
              l_error:=1;
              l_msgerror:='Dato renovable no Corresponde';
            else
              if l_id_temporada<>'T1' then
                l_error:=1;
                l_msgerror:='Dato Temporada no Corresponde';
              else
                if l_id_tiempotrabajo<>1 then
                  l_error:=1;
                  l_msgerror:='Dato Tiempo Trabajo no Corresponde';
                end if;
              end if;
            end if;

          end if;

          if l_error=0 then
            if l_id_renovable='R3' then
              if l_id_temporada<>'T1' then
                l_error:=1;
                l_msgerror:='Dato Temporada no Corresponde';
              else
                if l_id_tiempotrabajo<>1 then
                  l_error:=1;
                  l_msgerror:='Dato Tiempo Trabajo no Corresponde';
                end if;
              end if;
            end if;
          end if;

          if l_error=0 then       
          UPDATE PSTO_PLLA_CARGO_PROCESO SET
            ID_RENOVABLE=l_id_renovable,
            ID_SEXO=l_id_sexo,
            ID_EDAD=l_id_edad,
            ID_NIVEL_EDU=l_id_nivel_edu,
            ID_TIPOESTADOCIVIL=l_id_tipoestadocivil,
            ID_TIEMPOTRABAJO=l_id_tiempotrabajo,
            ID_TEMPORADA=l_id_temporada,
            CANTIDAD=P_CANTIDAD
            WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;

        end if;
         
        else
          l_error:=1;
          l_msgerror:='Ya esta registrado';
        end if;

          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_actualizar_planilla_cargo (P_ID_CARGO_PROCESO bigint,P_ID_RENOVABLE text,P_ID_SEXO bigint,P_ID_EDAD text,P_ID_NIVEL_EDU text,P_ID_TIPOESTADOCIVIL bigint,P_ID_TIEMPOTRABAJO bigint,P_ID_TEMPORADA text,P_CANTIDAD bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
