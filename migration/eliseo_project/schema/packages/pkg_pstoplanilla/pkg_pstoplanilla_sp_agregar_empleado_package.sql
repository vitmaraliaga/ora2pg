-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;

        
        /*PROCEDURE pkg_pstoplanilla_sp_agregar_empleado(P_ID_ENTIDAD numeric,P_ID_ANHO numeric,P_ID_PERSONA numeric,P_ID_CONTRATO numeric,P_ID_DEPTO varchar,P_ID_DEPTO_PADRE IN numeric,P_ID_AUXILIAR IN numeric,P_ID_TIPOESTATUS numeric,P_ERROR OUT numeric,P_MSGERROR out varchar) IS
          l_error numeric:=0;
          l_msgerror varchar(200):='';
          l_contar numeric;
          l_anho numeric;
          l_mes numeric;
          l_id_psto_planilla numeric;
          l_id_cargo numeric;
          l_id_tipocontrato numeric;
          l_finicio timestamp;
          l_ftermino timestamp;
          l_tipo_area varchar(2);
          l_es_misionero varchar(10);
          l_id_cond_lab varchar(5);
          l_id_tiempotrabajo numeric;
          l_id_categoria numeric;
          l_id_tipoestatus numeric;
           CURSOR cur IS SELECT 
              c.COLUMNA_IMP,b.COS_VALOR
              FROM APS_PLANILLA a,APS_PLANILLA_DETALLE b,PSTO_PLLA_CONCE_PLANI_ANT c
              WHERE a.ID_ENTIDAD=b.ID_ENTIDAD
              AND a.ID_ANHO=b.ID_ANHO
              AND a.ID_MES=b.ID_MES
              AND a.ID_PERSONA=b.ID_PERSONA
              AND a.ID_CONTRATO=b.ID_CONTRATO
              AND b.ID_CONCEPTOAPS=c.ID_CONCEPTOAPS
              AND a.ID_ENTIDAD=P_ID_ENTIDAD
              AND a.ID_PERSONA=P_ID_PERSONA
              AND a.ID_CONTRATO=P_ID_CONTRATO
              AND a.ID_ANHO=l_anho
              AND a.ID_MES=l_mes
              AND c.estado='1';
        
        l_columna varchar(60);
        l_importe numeric(10,2);
        l_nom_cargo varchar(100);
              
        BEGIN
        
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
          
          
         
        
          SELECT COUNT(*) INTO l_contar
          FROM APS_PLANILLA 
          WHERE ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_PERSONA=P_ID_PERSONA
          AND ID_CONTRATO=P_ID_CONTRATO
          AND ID_ANHO=l_anho
          AND ID_MES=l_mes;
          
          if l_contar=1 then
          
            SELECT coalesce(max(ID_PSTO_PLANILLA),0)+1 INTO l_id_psto_planilla  FROM PSTO_PLLA_PLANILLA;
            
            
            SELECT ID_CARGO,ES_MISIONERO,NOM_CARGO INTO l_id_cargo,l_es_misionero,l_nom_cargo
            FROM APS_PLANILLA 
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND ID_PERSONA=P_ID_PERSONA
            AND ID_CONTRATO=P_ID_CONTRATO
            AND ID_ANHO=l_anho
            AND ID_MES=l_mes;
            
            
            if l_id_cargo is null then
              select id_cargo,id_categoria into l_id_cargo,l_id_categoria from  aps_trabajador  where id_persona=P_ID_PERSONA;
            else
              select count(*) into l_contar from aps_cargo where id_cargo=l_id_cargo;
              if l_contar=0 then
                insert into aps_cargo(id_cargo,nombre,estado) values(l_id_cargo,l_nom_cargo,'1');
              end if;
              update aps_trabajador set id_cargo=l_id_cargo where id_persona=P_ID_PERSONA;
            end if;
            
            
            select TIPO into  l_tipo_area from PSTO_AREA_DEPTO where id_entidad= P_ID_ENTIDAD and id_depto=P_ID_DEPTO;
            
            SELECT ID_TIPOCONTRATO,FEC_INICIO,FEC_TERMINO INTO l_id_tipocontrato,l_finicio, l_ftermino
            FROM APS_EMPLEADO
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND ID_PERSONA=P_ID_PERSONA
            AND ID_CONTRATO=P_ID_CONTRATO;
            
            
            if l_es_misionero='1' then
                l_id_cond_lab:='M';
            else
                if l_id_tipocontrato=1 then
                  l_id_cond_lab:='E';
                elsif l_id_tipocontrato=81 then
                  l_id_cond_lab:='P';
                else
                  l_id_cond_lab:='C';
                end if;
            end if;
            
            l_id_tiempotrabajo:=1;
            if l_id_tipocontrato=2 then
              l_id_tiempotrabajo:=2;
            end if;
            
            SELECT COUNT(*) INTO l_contar
            FROM PSTO_PLLA_PLANILLA 
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND ID_PERSONA=P_ID_PERSONA
            AND ID_ANHO=l_anho;
            
            if l_contar=0 then
          
              INSERT INTO PSTO_PLLA_PLANILLA(
                  ID_PSTO_PLANILLA,
                  ID_ANHO,
                  ID_ENTIDAD,
                  ID_PERSONA,
                  ID_DEPTO,
                  ID_DEPTO_PADRE,
                  ID_AUXILIAR,
                  ID_CARGO,
                  ID_TIPOCONTRATO,
                  TIPO_AREA,
                  FINICIO,
                  FFIN,
                  ID_COND_LAB,
                  ID_TIEMPOTRABAJO,
                  UNIFORME,
                  ID_CATEGORIA
                  
              )VALUES(
                  l_id_psto_planilla,
                  P_ID_ANHO,
                  P_ID_ENTIDAD,
                  P_ID_PERSONA,
                  P_ID_DEPTO,
                  P_ID_DEPTO_PADRE,
                  P_ID_AUXILIAR,
                  l_id_cargo,
                  l_id_tipocontrato,
                  l_tipo_area,
                  l_finicio,
                  l_ftermino,
                  l_id_cond_lab,
                  l_id_tiempotrabajo,
                  'N',
                  l_id_categoria
                     
              );
              
              OPEN cur;
              FETCH cur INTO l_columna,l_importe;
                
              WHILE cur%FOUND LOOP
              
                  EXECUTE IMMEDIATE 'UPDATE PSTO_PLLA_PLANILLA SET '||l_columna||'='||replace(to_char(l_importe),',','.')||' WHERE ID_PSTO_PLANILLA=:PARAMETRO'  
                  USING l_id_psto_planilla;
                
                FETCH cur INTO l_columna,l_importe;
                  
              END LOOP;
              CLOSE cur;
              
              
            else
              l_error:=1;
              l_msgerror:='Ya esta asignado el personal para el periodo '||to_char(P_ID_ANHO);
            end if;
           
            
          elsif(l_contar>1) then
            l_error:=1;
            l_msgerror:='AGREGAR_EMPLEADO: Dos(2) registros para el mismo año y mes ';
           
          end if;
      
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

        END pkg_pstoplanilla_sp_agregar_empleado;*/
        


CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_agregar_empleado (P_ID_CARGO_PROCESO bigint,P_ID_PERSONA bigint,P_ID_TIPOCONTRATO bigint,P_ID_COND_LAB text,P_DOCENTE_TC text, P_ESHEXTRAS25 bigint,P_ESHEXTRAS35 bigint,P_ESHNOCTURNA bigint,P_ESHFERIADO bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;
          l_contar1 bigint;
          l_contareg bigint;
          l_anho bigint;
          l_mes bigint;
          l_id_psto_planilla bigint;
          l_id_cargo bigint;
          l_id_tipocontrato bigint;
          l_finicio timestamp(0);
          l_ftermino timestamp(0);
          l_tipo_area varchar(2);
          l_es_misionero varchar(10);
          l_id_cond_lab varchar(5);

          l_columna varchar(60);
          l_importe decimal(10,2);

          l_id_entidad bigint;
          l_id_anho bigint;
          l_id_depto bigint;
          l_id_depto_padre bigint;
          l_id_cargosueldo_escala bigint;
          l_id_contrato bigint;
          l_minimo decimal(10,2);
          l_maximo decimal(10,2);
          l_actual decimal(10,2);
          l_id_condicion_escala varchar(2);
          l_fmr decimal(10,2);
          l_id_temporada varchar(2);

           l_imp_hextras25 decimal(10,2);
           l_imp_hextras35 decimal(10,2);
           l_imp_hnocturna decimal(10,2);
           l_imp_hferiado decimal(10,2);
           l_cal_meses bigint;
           l_id_persona bigint;

           cur CURSOR FOR SELECT
              c.COLUMNA_IMP,b.COS_VALOR
              FROM APS_PLANILLA a,APS_PLANILLA_DETALLE b,PSTO_PLLA_CONCE_PLANI_ANT c
              WHERE a.ID_ENTIDAD=b.ID_ENTIDAD
              AND a.ID_ANHO=b.ID_ANHO
              AND a.ID_MES=b.ID_MES
              AND a.ID_PERSONA=b.ID_PERSONA
              AND a.ID_CONTRATO=b.ID_CONTRATO
              AND b.ID_CONCEPTOAPS=c.ID_CONCEPTOAPS
              AND a.ID_ENTIDAD=l_id_entidad
              AND a.ID_PERSONA=P_ID_PERSONA
              --AND a.ID_CONTRATO=P_ID_CONTRATO
              AND a.ID_ANHO=l_anho
              AND a.ID_MES=l_mes
              AND c.estado='1';

        
        
BEGIN
          l_id_persona:=P_ID_PERSONA;

          if l_id_persona=0 then
            l_id_persona:=null;
          end if;
          SELECT ID_ENTIDAD,ID_ANHO,ID_DEPTO,ID_DEPTO_PADRE,ID_CARGOSUELDO_ESCALA,ID_TEMPORADA
          INTO STRICT l_id_entidad,l_id_anho,l_id_depto,l_id_depto_padre,l_id_cargosueldo_escala,l_id_temporada
          FROM PSTO_PLLA_CARGO_PROCESO
          WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;

          select IMPORTE INTO STRICT l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=l_id_anho;

          select IMPORTE INTO STRICT l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=l_id_anho;

          select CASE WHEN P_ESHEXTRAS25=1 THEN IMPORTE END INTO STRICT l_imp_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHEXTRAS35=1 THEN IMPORTE END INTO STRICT l_imp_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHNOCTURNA=1 THEN IMPORTE END INTO STRICT l_imp_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHFERIADO=1 THEN IMPORTE END  INTO STRICT l_imp_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;

          
          
          SELECT COUNT(*) INTO STRICT l_contareg
          FROM PSTO_PLLA_PLANILLA 
          WHERE ID_ENTIDAD=l_id_entidad
          AND ID_PERSONA=l_id_persona
          AND ID_ANHO=l_id_anho;

          if l_contareg=0 then

             select FC_PSTO_CALC_MES_TEMPORADA(l_id_temporada) into STRICT l_cal_meses;

             SELECT coalesce(max(ID_PSTO_PLANILLA),0)+1 INTO STRICT l_id_psto_planilla  FROM PSTO_PLLA_PLANILLA;

             select TIPO into STRICT  l_tipo_area from PSTO_AREA_DEPTO where id_entidad= l_id_entidad and id_depto=l_id_depto;

              insert into PSTO_PLLA_PLANILLA(
              ID_PSTO_PLANILLA,
              ID_ANHO,
              ID_ENTIDAD,
              ID_DEPTO_PADRE,
              ID_PERSONA,
              ID_CATEGORIA,
              ID_DEPTO,
              ID_CARGO,
              ID_TIPOCONTRATO,
              UNIFORME,
              DOCENTE_TC,
              TIPO_AREA,
              FINICIO,
              FFIN,
              ID_COND_LAB,
              ID_TIEMPOTRABAJO,
              ID_TEMPORADA,
              ID_CARGO_PROCESO,
              ESHEXTRAS25,
              ESHEXTRAS35,
              ESHNOCTURNA,
              ESHFERIADO,
              IMP_HEXTRAS25,
              IMP_HEXTRAS35,
              IMP_HNOCTURNA,
              IMP_HFERIADO,
              CAL_MESES
              )
              SELECT 
              l_id_psto_planilla,
              ID_ANHO,
              ID_ENTIDAD,
              ID_DEPTO_PADRE,
              l_id_persona,
              NULL,
              ID_DEPTO,
              ID_CARGO,
              P_ID_TIPOCONTRATO,
              'N',
              P_DOCENTE_TC,
              l_tipo_area,
              NULL,
              NULL,
              P_ID_COND_LAB,
              ID_TIEMPOTRABAJO,
              ID_TEMPORADA,
              ID_CARGO_PROCESO,
              P_ESHEXTRAS25,
              P_ESHEXTRAS35,
              P_ESHNOCTURNA,
              P_ESHFERIADO,
              l_imp_hextras25,
              l_imp_hextras35,
              l_imp_hnocturna,
              l_imp_hferiado,
              l_cal_meses
              FROM PSTO_PLLA_CARGO_PROCESO
              WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;

              SELECT COUNT(*) INTO STRICT l_contar
              FROM APS_PLANILLA 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_PERSONA=l_id_persona
              --AND ID_CONTRATO=P_ID_CONTRATO
              AND ID_ANHO=l_anho
              AND ID_MES=l_mes;

              if l_contar=1 then
                OPEN cur;
                FETCH cur INTO l_columna,l_importe;

                WHILE cur%FOUND LOOP
                
                    EXECUTE 'UPDATE PSTO_PLLA_PLANILLA SET '||l_columna||'='||replace(l_importe::text,',','.')||' WHERE ID_PSTO_PLANILLA=:PARAMETRO'  
                    USING l_id_psto_planilla;

                  FETCH cur INTO l_columna,l_importe;

                END LOOP;
                CLOSE cur;

                
                select coalesce(minimo,0),coalesce(maximo,0),l_id_condicion_escala into STRICT l_minimo, l_maximo,l_id_condicion_escala from PSTO_PLLA_CARGOSUELDO_ESCALA where ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;

                select IMP_BASICO into STRICT l_actual from PSTO_PLLA_PLANILLA where ID_PSTO_PLANILLA=l_id_psto_planilla;

                if P_ID_COND_LAB='M' then
                  /*if l_minimo>0 and l_maximo>0 then
                    if l_actual<l_minimo and l_actual>l_maximo then
                      l_error:=0;
                     -- l_msgerror:='Haber Básico Actual '||replace(to_char(l_actual),',','.')|| ' escala salarial MIN: '||replace(to_char(l_minimo),',','.')||' MAX: '||replace(to_char(l_maximo),',','.');
                    end if;
                  end if;
                else*/
                
                  
                  SELECT count(*) INTO STRICT l_contar
                  FROM PSTO_PLLA_PUNTAJE_MIS 
                  WHERE ID_ENTIDAD=l_id_entidad
                  AND ID_PERSONA=l_id_persona
                  AND ID_ANHO=l_id_anho;

                  if l_contar=1 then
                    SELECT punt_aprobado INTO STRICT l_fmr
                    FROM PSTO_PLLA_PUNTAJE_MIS 
                    WHERE ID_ENTIDAD=l_id_entidad
                    AND ID_PERSONA=l_id_persona
                     AND ID_ANHO=l_id_anho;

                    UPDATE PSTO_PLLA_PLANILLA SET FMR=l_fmr
                    where ID_PSTO_PLANILLA=l_id_psto_planilla;
                  end if;
                end if;
              else
                select maximo into STRICT l_importe from PSTO_PLLA_CARGOSUELDO_ESCALA where ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;

                UPDATE PSTO_PLLA_PLANILLA SET ANT_BASICO=l_importe
                where ID_PSTO_PLANILLA=l_id_psto_planilla;

              end if;

              
               CALL pkg_pstoplanilla_sp_actualizar_planilla_emp(l_id_psto_planilla,l_error,l_msgerror);

               CALL pkg_pstoplanilla_sp_generar_planilla_dist(l_id_psto_planilla,l_id_depto,l_id_temporada,100,'1',l_error,l_msgerror);

          else  
          
            l_error:=1;
            l_msgerror:='Ya esta asignado el personal para el periodo '||l_anho::text;

          end if;

          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_agregar_empleado (P_ID_CARGO_PROCESO bigint,P_ID_PERSONA bigint,P_ID_TIPOCONTRATO bigint,P_ID_COND_LAB text,P_DOCENTE_TC text, P_ESHEXTRAS25 bigint,P_ESHEXTRAS35 bigint,P_ESHNOCTURNA bigint,P_ESHFERIADO bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
