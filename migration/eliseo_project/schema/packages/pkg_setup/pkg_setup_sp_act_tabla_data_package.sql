-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_setup,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_setup_sp_act_tabla_data (P_ESQUEMA text,P_ID_ENTIDAD bigint, P_ID_PERSONA_QUEDA bigint,P_ID_PERSONA_QUITA bigint) AS $body$
DECLARE

    l_contar bigint;
    l_contar1 bigint;
    l_id_trabajador_queda bigint;
    l_id_trabajador_quita bigint;
    l_query varchar(3000);
    l_select varchar(3000);
    curTab CURSOR FOR
    SELECT A.owner||'.'||a.table_name as tabla, a.column_name, a.data_type as tipo
    FROM all_tab_columns A,all_tables B
    WHERE A.TABLE_NAME=B.TABLE_NAME
    AND A.owner=B.owner
    AND A.column_name IN ('ID_PERSONA','ID_TRABAJADOR')
    AND (A.NUM_NULLS IS NOT NULL AND A.NUM_NULLS::text <> '')
    AND A.owner = P_ESQUEMA
    ORDER BY A.column_name;

BEGIN
  
    SELECT  count(1) INTO STRICT l_contar FROM MOISES.TRABAJADOR WHERE  ID_PERSONA=P_ID_PERSONA_QUEDA and ID_ENTIDAD=P_ID_ENTIDAD;
    if l_contar>0 then
      SELECT ID_TRABAJADOR INTO STRICT l_id_trabajador_queda FROM MOISES.TRABAJADOR WHERE  ID_PERSONA=P_ID_PERSONA_QUEDA and ID_ENTIDAD=P_ID_ENTIDAD;
    end if;
    SELECT  count(1) INTO STRICT l_contar FROM MOISES.TRABAJADOR WHERE  ID_PERSONA=P_ID_PERSONA_QUITA and ID_ENTIDAD=P_ID_ENTIDAD;
    if l_contar>0 then
        SELECT ID_TRABAJADOR INTO STRICT l_id_trabajador_quita FROM MOISES.TRABAJADOR WHERE  ID_PERSONA=P_ID_PERSONA_QUITA and ID_ENTIDAD=P_ID_ENTIDAD;
    end if;
    FOR cur in curTab LOOP
    BEGIN
      l_query:=null;
      l_select:=NULL;
      l_contar:=0;
      if cur.tipo='numeric' then
        if cur.column_name='ID_PERSONA' then
         EXECUTE 'SELECT count(1)  from '||cur.tabla||'  where ID_PERSONA=:P_ID_PERSONA' into STRICT l_contar USING P_ID_PERSONA_QUITA;
         EXECUTE 'SELECT count(1)  from '||cur.tabla||'  where ID_PERSONA=:P_ID_PERSONA' into STRICT l_contar1 USING P_ID_PERSONA_QUEDA;
         if l_contar>0 then
          l_query:='UPDATE  '||cur.tabla||' SET ID_PERSONA='||P_ID_PERSONA_QUEDA||' WHERE ID_PERSONA='||P_ID_PERSONA_QUITA||';';

         end if;
         if l_contar>0 OR l_contar1>0 then
          l_select:='SELECT *  from '||cur.tabla||'  where ID_PERSONA in('||P_ID_PERSONA_QUEDA||','||P_ID_PERSONA_QUITA||');';
         END IF;
        else

          EXECUTE 'SELECT count(1)  from '||cur.tabla||'  where ID_TRABAJADOR=:P_ID_TRABAJADOR' into STRICT l_contar USING l_id_trabajador_quita;
          EXECUTE 'SELECT count(1)  from '||cur.tabla||'  where ID_TRABAJADOR=:P_ID_TRABAJADOR' into STRICT l_contar1 USING l_id_trabajador_queda;
          IF l_id_trabajador_quita>0 THEN
            if l_contar>0 then
              IF l_id_trabajador_queda>0 THEN
                l_query:='UPDATE  '||cur.tabla||' SET ID_TRABAJADOR='||l_id_trabajador_queda||' WHERE ID_TRABAJADOR='||l_id_trabajador_quita||';';
              END IF;

            end if;
            if l_contar>0 OR l_contar1>0 then
               l_select:='SELECT *  from '||cur.tabla||'  where ID_TRABAJADOR IN('||l_id_trabajador_queda||','||l_id_trabajador_quita||');';
            END IF;
          end if;
        end if;
        IF (l_query IS NOT NULL AND l_query::text <> '') OR (l_select IS NOT NULL AND l_select::text <> '') THEN
          INSERT INTO ELISEO.TT_ACT_TABLA_DATA(
            SCHEMAS,
            TABLA,
            COLUMNA,
            ID_PERSONA_QUEDA,
            ID_PERSONA_QUITA,
            ID_TRABAJADOR_QUEDA,
            ID_TRABAJADOR_QUITA,
            CANTIDAD_QUEDA,
            CANTIDAD_QUITA,
            MODIFICAR,
            SELECCION
          )values (
            P_ESQUEMA,
            cur.tabla,
            cur.column_name,
            P_ID_PERSONA_QUEDA,
            P_ID_PERSONA_QUITA,
            l_id_trabajador_queda,
            l_id_trabajador_quita,
            l_contar1,
            l_contar,
            l_query,
            l_select
          );
        end if;
      end if;
    END;
    END LOOP;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_setup_sp_act_tabla_data (P_ESQUEMA text,P_ID_ENTIDAD bigint, P_ID_PERSONA_QUEDA bigint,P_ID_PERSONA_QUITA bigint) FROM PUBLIC;
