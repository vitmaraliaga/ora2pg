-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_init_config,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_init_config_sp_articulos (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint := 0;
        l_id_entidad_base bigint := 72122;
        l_id_depto_base varchar(15) := '121211';
        l_id_tipoarea_base bigint := 1;
        l_id_area_base bigint;
        l_id_sedearea_base bigint;
        l_id_sede_base bigint := 4;
        l_id_almacen_base bigint;
        l_id_user bigint := 7932;
        l_id_sistemaexterno bigint;
        l_id_area bigint;
        l_id_sedearea bigint;
        l_id_almacen bigint;
        l_id_almacen_calculo bigint;

        datos_base CURSOR FOR
        SELECT * from ORG_AREA
        where id_entidad = l_id_entidad_base
        and id_tipoarea = l_id_tipoarea_base;


BEGIN

            -- ORG SEDE
            select max(id_area) into STRICT  l_id_area_base from eliseo.ORG_AREA
                where id_entidad = l_id_entidad_base
                and id_tipoarea = l_id_tipoarea_base;

            select max(id_sedearea) into STRICT  l_id_sedearea_base from eliseo.ORG_SEDE_AREA
                where id_entidad = l_id_entidad_base
                and id_depto = l_id_depto_base
                and id_sede = l_id_sede_base
                and id_area = l_id_area_base;

            select max(id_almacen) into STRICT  l_id_almacen_base from eliseo.inventario_almacen
                where id_entidad = l_id_entidad_base
                and id_depto = l_id_depto_base
                and id_sedearea = l_id_sedearea_base;



            select count(1), max(id_area) into STRICT l_contar, l_id_area from eliseo.ORG_AREA
                where id_entidad = P_ID_ENTIDAD
                and id_tipoarea = l_id_tipoarea_base;

            select max(id_almacen) into STRICT l_id_almacen_calculo from eliseo.inventario_almacen;


            if l_contar = 0 then

                select max(id_area)+1 into STRICT l_id_area from eliseo.ORG_AREA;

                insert into eliseo.ORG_AREA(
                    ID_AREA,
                    id_parent,
                    id_entidad,
                    id_tipoarea,
                    nombre,
                    nivel,
                    izquierda,
                    derecha,
                    orden,
                    estado,
                    codigo,
                    nivelhijo,
                    tipo,
                    gth,
                    sigla
                )
               SELECT
                    l_id_area,
                    null,
                    P_ID_ENTIDAD,
                    id_tipoarea,
                    nombre,
                    nivel,
                    izquierda,
                    derecha,
                    orden,
                    estado,
                    codigo,
                    nivelhijo,
                    tipo,
                    gth,
                    sigla
                from eliseo.ORG_AREA
                where id_entidad = l_id_entidad_base
                and id_tipoarea = l_id_tipoarea_base;

                RAISE NOTICE 'eliseo.ORG_AREA creado';
            else
                RAISE NOTICE 'eliseo.ORG_AREA existente';
            end if;

            -- ORG SEDE SEDE
            select count(1), max(id_sedearea) into STRICT l_contar, l_id_sedearea from eliseo.ORG_SEDE_AREA
                where id_entidad = P_ID_ENTIDAD
                and id_depto = P_ID_DEPTO
                and id_area = l_id_area
                and id_sede = l_id_sede_base;


            if l_contar = 0 then

                select max(id_sedearea)+1 into STRICT l_id_sedearea from eliseo.ORG_SEDE_AREA;

                insert into eliseo.ORG_SEDE_AREA(
                    ID_SEDEAREA,
                    id_entidad,
                    id_depto,
                    id_sede,
                    id_area,
                    id_persona,
                    estado,
                    codigo
                )
               SELECT
                    l_id_sedearea,
                    P_ID_ENTIDAD,
                    P_ID_DEPTO,
                    l_id_sede_base,
                    l_id_area,
                    id_persona,
                    estado,
                    codigo
                from eliseo.ORG_SEDE_AREA
                where id_entidad = l_id_entidad_base
                and id_depto = l_id_depto_base
                and id_area = l_id_area_base
                and id_sede = l_id_sede_base;

                RAISE NOTICE 'eliseo.ORG_SEDE_AREA creado';


            else
                RAISE NOTICE 'eliseo.ORG_SEDE_AREA existente';
            end if;

            -- ALMACEN
            select count(1), max(id_almacen) into STRICT l_contar, l_id_almacen from eliseo.inventario_almacen
                where id_entidad = P_ID_ENTIDAD
                and id_depto = P_ID_DEPTO
                and id_sedearea = l_id_sedearea;


            if l_contar = 0 then

                l_id_almacen_calculo := l_id_almacen_calculo +1;
                l_id_almacen := l_id_almacen_calculo;
                -- select max(id_almacen)+1 into l_id_almacen from eliseo.inventario_almacen;
                insert into eliseo.inventario_almacen(
                    id_almacen,
                    id_entidad,
                    id_depto,
                    id_sedearea,
                    nombre,
                    estado,
                    id_existencia
                )
               SELECT
                    l_id_almacen,
                    P_ID_ENTIDAD,
                    P_ID_DEPTO,
                    l_id_sedearea,
                    'ALMACEN',
                    estado,
                    id_existencia
                from eliseo.inventario_almacen
                where id_entidad = l_id_entidad_base
                and id_depto = l_id_depto_base
                and id_sedearea = l_id_sedearea_base;

                RAISE NOTICE 'eliseo.inventario_almacen creado';
            else
                RAISE NOTICE 'eliseo.inventario_almacen existente';
            end if;

             RAISE NOTICE '*** INVENTARIO ALMACEN ARTICULO ***';

             RAISE NOTICE 'new l_id_almacen = %', l_id_almacen;


            MERGE INTO eliseo.inventario_almacen_articulo niaa
            USING(
                SELECT id_almacen, id_articulo, id_anho, id_tipoigv, codigo, stock_minimo, stock_actual, costo, costo_total, es_servicio, estado, ubicacion, abreviatura, id_ctacte
                    from inventario_almacen_articulo
                    where id_almacen = l_id_almacen_base
            ) iaa
            ON (niaa.id_almacen = l_id_almacen and niaa.id_articulo = iaa.id_articulo and niaa.id_anho = iaa.id_anho )
            WHEN NOT MATCHED THEN 
                INSERT(id_almacen, id_articulo, id_anho, id_tipoigv, codigo, stock_minimo, stock_actual, costo, costo_total, es_servicio, estado, ubicacion, abreviatura, id_ctacte ) 
                VALUES (l_id_almacen, iaa.id_articulo, iaa.id_anho, iaa.id_tipoigv, iaa.codigo, iaa.stock_minimo, iaa.stock_actual, iaa.costo, iaa.costo_total, iaa.es_servicio, iaa.estado, iaa.ubicacion, iaa.abreviatura, iaa.id_ctacte );



        P_ERROR := 0;
        P_MSGERROR := 'eliseo.ORG_AREA revisado y actualizado';
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_init_config_sp_articulos (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
