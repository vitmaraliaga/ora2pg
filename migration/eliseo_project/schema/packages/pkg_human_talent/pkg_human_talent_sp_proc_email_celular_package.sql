-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_human_talent,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_human_talent_sp_proc_email_celular (P_ID_PERSONA bigint, P_OPCION text,P_TIPO text,P_ID_VIRTUAL bigint,P_ID_TELEFONO bigint,P_EMAIL text,P_CELULAR text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint:=0;
    l_id bigint;

  
BEGIN
  
  
  IF P_TIPO='E' THEN
    IF P_OPCION='I' THEN
    
      SELECT COUNT(*) INTO STRICT l_contar FROM moises.PERSONA_VIRTUAL WHERE ID_PERSONA=P_ID_PERSONA AND ID_TIPOVIRTUAL=1 AND LOWER(DIRECCION)=LOWER(P_EMAIL);

      IF l_contar=0 THEN
      
        SELECT COALESCE(MAX(ID_VIRTUAL),0)+1 INTO STRICT l_id FROM moises.PERSONA_VIRTUAL WHERE ID_PERSONA=P_ID_PERSONA;
        
        UPDATE moises.PERSONA_VIRTUAL SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOVIRTUAL=1;
      
        INSERT INTO moises.PERSONA_VIRTUAL(
          ID_VIRTUAL,
          ID_PERSONA,
          ID_TIPOVIRTUAL,
          DIRECCION,
          COMENTARIO,
          GTH
        )VALUES (
          l_id,
          P_ID_PERSONA,
          1,
          P_EMAIL,
          '',
          1
        );

      UPDATE moises.PERSONA_NATURAL set correo = P_EMAIL where ID_PERSONA=P_ID_PERSONA;

      ELSE
        l_error:=1;
        l_msgerror:='YA ESTA REGISTRADO EL CORREO '||P_EMAIL;
      END IF;
    ELSE

      UPDATE moises.PERSONA_VIRTUAL SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOVIRTUAL=1;
      
      UPDATE moises.PERSONA_VIRTUAL SET GTH=1 WHERE ID_PERSONA=P_ID_PERSONA AND ID_VIRTUAL=P_ID_VIRTUAL AND ID_TIPOVIRTUAL=1;

      UPDATE moises.PERSONA_NATURAL set correo = (
        SELECT max(DIRECCION) FROM moises.PERSONA_VIRTUAL pv 
        WHERE ID_TIPOVIRTUAL = 1
        AND ID_PERSONA = P_ID_PERSONA
        AND GTH = '1') where ID_PERSONA=P_ID_PERSONA;

    END IF;
  ELSE
    IF P_OPCION='I' THEN

      SELECT COUNT(*) INTO STRICT l_contar FROM moises.PERSONA_TELEFONO WHERE ID_PERSONA=P_ID_PERSONA AND ID_TIPOTELEFONO in (3,5) AND LOWER(NUM_TELEFONO)=LOWER(P_CELULAR);

      IF l_contar=0 THEN
      
        SELECT COALESCE(MAX(ID_TELEFONO),0)+1 INTO STRICT l_id FROM moises.PERSONA_TELEFONO WHERE ID_PERSONA=P_ID_PERSONA;
        
        UPDATE moises.PERSONA_TELEFONO SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOTELEFONO=3;
      
        INSERT INTO moises.PERSONA_TELEFONO(
          ID_TELEFONO,
          ID_PERSONA,
          ID_TIPOTELEFONO,
          NUM_TELEFONO,
          ES_ACTIVO,
          ES_PRIVADO,
          COMENTARIO,
          GTH
        )VALUES (
          l_id,
          P_ID_PERSONA,
          3,
          P_CELULAR,
          0,
          0,
          '',
          1
        );

        UPDATE moises.PERSONA_NATURAL set celular = P_CELULAR where ID_PERSONA=P_ID_PERSONA;

      ELSE
        l_error:=1;
        l_msgerror:='YA ESTA REGISTRADO EL CELULAR '||P_CELULAR;
      END IF;
    ELSE

      UPDATE moises.PERSONA_TELEFONO SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOTELEFONO in (3,5);
      
      UPDATE moises.PERSONA_TELEFONO SET GTH=1 WHERE ID_PERSONA=P_ID_PERSONA AND ID_TELEFONO=P_ID_TELEFONO AND ID_TIPOTELEFONO in (3,5);
      
      UPDATE moises.PERSONA_NATURAL set celular = (
        SELECT max(NUM_TELEFONO) FROM moises.PERSONA_TELEFONO pt
        WHERE ID_TIPOTELEFONO IN (3,5)
        AND ID_PERSONA = P_ID_PERSONA
        AND GTH = '1' ) where ID_PERSONA=P_ID_PERSONA;

    END IF;
  END IF;

    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_human_talent_sp_proc_email_celular (P_ID_PERSONA bigint, P_OPCION text,P_TIPO text,P_ID_VIRTUAL bigint,P_ID_TELEFONO bigint,P_EMAIL text,P_CELULAR text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
