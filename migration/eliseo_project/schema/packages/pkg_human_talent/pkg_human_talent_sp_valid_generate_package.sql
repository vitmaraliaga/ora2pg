-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_human_talent,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_human_talent_sp_valid_generate (P_ID_ENTIDAD bigint,P_ID_ANHO bigint ,P_ID_MES bigint,P_ID_DEPTO text,P_ID_PERSONA bigint,P_ID_CERTIFICADO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(300):='';
    l_contar bigint;
    l_id_certificado bigint;
    l_archivo bigint;
    ls_clave varchar(500);
    ls_desde timestamp(0);
    ls_hasta timestamp(0);
    id_persona bigint;
    ls_firma varchar(500);

  
BEGIN
 
     SELECT COUNT(*) INTO STRICT l_contar 
     from APS_CERTIFICADO_DEPTO
     where id_entidad = P_ID_ENTIDAD
     and id_depto = P_ID_DEPTO
     and id_certificado in (
        SELECT a.id_certificado FROM APS_CERTIFICADO a ,APS_CERTIFICADO_DEPTO b
        where a.id_certificado=b.id_certificado
        and a.estado='1'
        and b.id_depto =P_ID_DEPTO
        and a.id_certificado= P_ID_CERTIFICADO
        --and hasta >= sysdate
     );

     IF l_contar=0 THEN
      l_error:=1;
      l_msgerror:='No esta asignado certificado digital para el departamento '||P_ID_DEPTO;
     ELSE
       IF l_contar>1 THEN
        l_error:=1;
        l_msgerror:='Hay '||l_contar||' certificados digitales activos para el departamento '||P_ID_DEPTO;
       END IF;
     END IF;

    
     
     IF l_error=0 THEN
     
      SELECT id_certificado INTO STRICT l_id_certificado 
      from APS_CERTIFICADO_DEPTO
      where id_entidad = P_ID_ENTIDAD
      and id_depto = P_ID_DEPTO
      and id_certificado in (
        SELECT a.id_certificado FROM APS_CERTIFICADO a ,APS_CERTIFICADO_DEPTO b
        where a.id_certificado=b.id_certificado
        and a.estado='1'
        and b.id_depto =P_ID_DEPTO
        and a.id_certificado= P_ID_CERTIFICADO
        --and hasta >= sysdate
      );

      SELECT 
                length(archivo) as ARCHIVO,
                CLAVE,
                DESDE,
                HASTA,
                coalesce(id_persona,0) as ID_PERSONA,
                FIRMA
                into STRICT
                l_archivo,
                ls_clave,
                ls_desde,
                ls_hasta,
                id_persona,
                ls_firma
        FROM APS_CERTIFICADO
        where id_certificado=l_id_certificado;

        if l_archivo=0 then
          l_error:=1;
          l_msgerror:='No existe archivo de firma digital('||l_id_certificado||')';
        else

            if clock_timestamp() > ls_hasta then
              l_error:=1;
              l_msgerror:='Firma digital('||l_id_certificado||') ha caducado  el '||to_char(ls_hasta,'DD/MM/YYYY');
            else
              if id_persona=0 then
                l_error:=1;
                l_msgerror:='Firma digital('||l_id_certificado||') no esta asignado a ningún representate legal';
                else
                  if coalesce(ls_firma::text, '') = '' then
                    l_error:=1;
                    l_msgerror:='No esta registrado firma escaneado de representate legal - Firma digital('||l_id_certificado||') ';
                  end if;
              end if;
            end if;

        end if;

     end if;

     IF l_error=0 THEN
        
        if P_ID_PERSONA>0 then
          SELECT  count(*)  into STRICT l_contar
          FROM VW_APS_PLANILLA A
          WHERE ID_ENTIDAD = P_ID_ENTIDAD
          AND ID_ANHO = P_ID_ANHO
          AND ID_MES = P_ID_MES
          AND ID_PERSONA=P_ID_PERSONA;

          IF l_contar=0 THEN
            l_error:=1;
            l_msgerror:='No existe información de boleta para el periodo '||P_ID_ANHO||'-'||P_ID_MES||' para el personal('||P_ID_PERSONA||')';
          ELSE
              SELECT COUNT(*) INTO STRICT l_contar FROM  APS_PLANILLA_BOLETA
              WHERE ID_ENTIDAD=P_ID_ENTIDAD
              AND ID_ANHO=P_ID_ANHO
              AND ID_MES=P_ID_MES
              AND ID_PERSONA=P_ID_PERSONA
              AND ID_DEPTO=P_ID_DEPTO;

              IF l_contar>0 THEN
                l_error:=1;
                l_msgerror:='Ya esta generado firma digital de la boleta  para el personal('||P_ID_PERSONA||') del periodo '||P_ID_ANHO||'-'||P_ID_MES;
              END IF;
          END IF;

        END IF;
     end if;

    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_human_talent_sp_valid_generate (P_ID_ENTIDAD bigint,P_ID_ANHO bigint ,P_ID_MES bigint,P_ID_DEPTO text,P_ID_PERSONA bigint,P_ID_CERTIFICADO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
