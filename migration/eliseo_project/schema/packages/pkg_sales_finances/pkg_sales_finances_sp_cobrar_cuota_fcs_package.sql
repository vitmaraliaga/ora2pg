-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_cobrar_cuota_fcs (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_VENTA bigint;
        L_ID_VDETALLE bigint;
        L_ID_ASIENTO bigint;
        L_ID_ANHO bigint;
        L_ID_ANHO_ACTUAL bigint;
        L_ID_MES bigint;--OBTENER AUTOMATICO
        L_ID_MES_ACTUAL bigint;
        L_ID_TIPOVOUCHER bigint := 1;
        L_ID_TIPOASIENTO varchar(4);
        L_ID_PERSONA bigint := 13428; --USER samuel.miranda
        L_ID_PERSONA_V bigint; --CONTADOR
        L_ID_CLIENTE bigint;
        L_NAME varchar(150);
        L_ID_VOUCHER bigint;
        L_ID_COMPROBANTE varchar(2) := '03';
        L_SERIE varchar(5);
        L_CORRELATIVO bigint;
        L_NUMERO varchar(8);
        L_ID_MONEDA bigint := 7;
        L_ID_LEYENDA varchar(4) := '1000';
        L_ID_IGV bigint := 18;
        L_ID_CREDITO bigint := 2;
        L_ID_TIPOTRANSACCION bigint;
        L_ID_TIPOORIGEN bigint := 1;
        L_ESTADO bigint := 1;
        L_ID_TIPOVENTA bigint := 1;
        L_ID_TIPOIGV varchar(2) := '30';
        L_DC varchar(1) := 'D';
        L_CANTIDAD decimal(10,2) := 1;
        L_IGV decimal(10,2) := 0;
        L_DESCUENTO decimal(10,2) := 0;
        L_ITEM bigint := 1;
        L_CODIGO varchar(10);
        L_DEPTO_A varchar(10);

        L_ID_FONDO bigint := 10;
        L_ID_DEPTO_ASIENTO varchar(10);
        L_ID_CUENTAAASI varchar(20);
        L_CTACTE varchar(20);
        L_RESTRICCION varchar(10);
        L_IMPORTE decimal(10,2) := 0;
        L_GLOSA varchar(100) := '5ta Armada 2020-1';
        L_AGRUPA varchar(1) := 'N';
        L_DC_ASIENTO varchar(1);

        L_ERROR bigint := 0;
        L_MSGERROR varchar(200) := 'OK';
        L_CANT bigint;
        --DATOS PARA EL ANTICIPO
        L_IMPORTE_ANTICIPO decimal(10,2);
        L_TOTAL_ANTICIPO decimal(10,2);
        L_DC_ANT varchar(1) :='C'; --DC PARA ANTICIPOS
        L_CODIGO_ANT varchar(2) :='NA'; --ANNTICIPOS CLIENTES - CREDITO
        L_TIPO varchar(1) := 'V';

        L_CODIGO_PERSONAL varchar(50);
        L_CUENTA_EAP varchar(20);

        L_DETALLE varchar(100);
        L_IMPORTE_DET decimal(10,2);
        --L_DESCUENTO numeric(10,2);
        L_CUENTA varchar(20);
        L_NIVEL varchar(20);

        L_TOTAL decimal(10,2);
        L_T_DESCUENTO decimal(10,2);

        ALUMNOS CURSOR FOR
        SELECT CARNE@DBL_ARON_APP(CODIGO_PERSONAL) AS CODIGO,CODIGO_PERSONAL,CUENTA_EAP
        FROM ALUMNO_CONTRATO@DBL_ARON_APP
        WHERE CODIGO_CONTRATO = '2020-1'  			
        AND ESTADO = '1' 
        AND BECA_ESTATAL = 'N' 
        AND TIPO_PAGO = '4'
        --AND CODIGO_EAP <> '0309';
        AND CODIGO_PERSONAL NOT IN (SELECT ID_PERSONAL FROM UPEU_REGVENTAS@DBL_ARON_APP WHERE ID_VENTA = '001-2020' AND GLOSA LIKE '3ra Armada%');
        --AND CODIGO_PERSONAL IN (SELECT ID_PERSONAL FROM UPEU_REGVENTAS@DBL_ARON_APP WHERE ID_VENTA = '001-2020' AND GLOSA LIKE '3ra Armada%'); --5T0 AÑO
        --AND CODIGO_PERSONAL = '2014ME20140303173024';
        DETALLE CURSOR FOR
        SELECT 
             B.NOMBRE,
             ABS(round((A.IMPORTE/5)::numeric,2)) IMPORTE,
             CASE WHEN SIGN(round((A.IMPORTE/5)::numeric,2))=-1 THEN ABS(round((A.IMPORTE/5)::numeric,2))  ELSE 0 END  AS DESCUENTO,
             B.CUENTA_DESTINO AS CUENTA,
             CASE WHEN B.CUENTA_DPTO='C' THEN L_CUENTA_EAP  ELSE B.CUENTA_DPTO END  AS DEPTO,
             CASE WHEN SIGN(round((A.IMPORTE/5)::numeric,2))=-1 THEN 'C'  ELSE 'D' END  AS DC
        FROM NOE.ALUMNO_CONTRATO_DETALLE@DBL_ARON_APP A, NOE.CONTRATO_CRITERIO@DBL_ARON_APP B
        WHERE A.CODIGO_CRITERIO = B.CODIGO_CRITERIO
        AND A.CODIGO_CONTRATO = B.CODIGO_CONTRATO			
        AND A.CODIGO_PERSONAL = L_CODIGO_PERSONAL
        AND A.CODIGO_CONTRATO = '2020-1'
        AND B.TIPO_COBRO IN ('E','I')
        AND A.ESTADO = '0';

        
BEGIN
            SELECT  MAX(ID_ANHO) ID_ANHO, TO_CHAR(clock_timestamp(),'YYYY') ID_ANHO_ACTUAL INTO STRICT L_ID_ANHO,L_ID_ANHO_ACTUAL
            FROM CONTA_ENTIDAD_ANHO_CONFIG WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ACTIVO = '1';
            IF L_ID_ANHO = L_ID_ANHO_ACTUAL THEN
                SELECT MAX(ID_MES) ID_MES, (TO_CHAR(clock_timestamp(),'MM'))::numeric  ID_MES_ACTUAL INTO STRICT L_ID_MES,L_ID_MES_ACTUAL
                FROM CONTA_ENTIDAD_MES_CONFIG WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_ANHO = L_ID_ANHO AND ESTADO = '1';
                IF L_ID_MES = L_ID_MES_ACTUAL THEN

                    SELECT ID_TIPOASIENTO INTO STRICT L_ID_TIPOASIENTO FROM CONTA_VOUCHER_CONFIG
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD
                    AND ID_DEPTO = P_ID_DEPTO
                    AND ID_ANHO = l_ID_ANHO
                    AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;
                    --VOUCHER
                    SELECT ID_PERSONA INTO STRICT L_ID_PERSONA_V FROM FIN_CONTADOR_DEPTO
                    WHERE ID_ENTIDAD=P_ID_ENTIDAD
                    AND ID_DEPTO=P_ID_DEPTO;

                    CALL pkg_accounting_sp_crear_voucher(P_ID_ENTIDAD,P_ID_DEPTO,L_ID_ANHO,L_ID_MES,clock_timestamp(),L_ID_TIPOASIENTO,L_ID_TIPOVOUCHER,'','S',L_ID_PERSONA_V,L_ID_VOUCHER);

                    SELECT FC_IGV(CURRENT_DATE ) INTO STRICT L_ID_IGV;
                    -- GENERA ITEM NUMERO DE LOS DETALLES
                    OPEN ALUMNOS;
                        FETCH ALUMNOS INTO L_CODIGO,L_CODIGO_PERSONAL,L_CUENTA_EAP;
                        WHILE ALUMNOS%FOUND LOOP
                            SELECT COUNT(1) INTO STRICT L_CANT FROM MOISES.PERSONA_NATURAL_ALUMNO WHERE CODIGO = L_CODIGO;
                            IF L_CANT > 0 THEN
                                SELECT A.ID_PERSONA,A.PATERNO||' '||A.MATERNO||', '||A.NOMBRE AS NOMBRE INTO STRICT L_ID_CLIENTE,L_NAME FROM MOISES.PERSONA A JOIN MOISES.PERSONA_NATURAL_ALUMNO B
                                ON A.ID_PERSONA = B.ID_PERSONA WHERE B.CODIGO = L_CODIGO;
                                --SERIE
                                CALL pkg_sales_sp_obtener_serie_numero(L_ID_PERSONA,L_ID_COMPROBANTE,P_ID_ENTIDAD,P_ID_DEPTO, NULL, L_SERIE,L_CORRELATIVO);
                                SELECT LPAD(L_CORRELATIVO::text,8,'0') INTO STRICT L_NUMERO;
                                --VENTA
                                INSERT INTO VENTA(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_PERSONA,ID_CLIENTE,ID_VOUCHER,ID_COMPROBANTE,ID_IGV,ID_MONEDA,ID_LEYENDA,ID_CREDITO,ID_TIPOTRANSACCION,ID_TIPOORIGEN,SERIE,NUMERO,FECHA,GLOSA,
                                GRAVADA,INAFECTA,EXONERADA,GRATUITA,DESCUENTO,DESCUENTO_GLOBAL,IGV,TOTAL,ESTADO,ID_TIPOVENTA,OTROS_CARGOS)
                                VALUES (P_ID_ENTIDAD,P_ID_DEPTO,L_ID_ANHO,L_ID_MES,L_ID_PERSONA,L_ID_CLIENTE,L_ID_VOUCHER,L_ID_COMPROBANTE,L_ID_IGV,L_ID_MONEDA,L_ID_LEYENDA,L_ID_CREDITO,L_ID_TIPOTRANSACCION,L_ID_TIPOORIGEN,L_SERIE,L_NUMERO,clock_timestamp(),L_GLOSA,
                                0,L_IMPORTE,0,0,0,0,L_IGV,L_IMPORTE,L_ESTADO,L_ID_TIPOVENTA,0) RETURNING ID_VENTA INTO L_ID_VENTA;

                                OPEN DETALLE;
                                FETCH DETALLE INTO L_DETALLE,L_IMPORTE_DET,L_DESCUENTO,L_CUENTA,L_NIVEL,L_DC;-- L_ID_CUENTAAASI,L_CTACTE,L_RESTRICCION,L_ID_DEPTO_ASIENTO,L_DC_ASIENTO;
                                    WHILE DETALLE%FOUND LOOP
                                         --VENTA_DETALLE
                                        INSERT INTO VENTA_DETALLE(ID_VENTA,ID_TIPOIGV,ID_TIPOORIGEN,DETALLE,DC,CANTIDAD,PRECIO,PRECIO_BASE,BASE,IGV,DESCUENTO,IMPORTE,ITEM)
                                        VALUES (L_ID_VENTA,L_ID_TIPOIGV,L_ID_TIPOORIGEN,L_DETALLE,L_DC,L_CANTIDAD,L_IMPORTE_DET,L_IMPORTE_DET,L_IMPORTE_DET,L_IGV,L_DESCUENTO,L_IMPORTE_DET,L_ITEM) RETURNING ID_VDETALLE INTO L_ID_VDETALLE;
                                        --DEBITO
                                        SELECT coalesce(MAX(ID_ASIENTO),0)+1 INTO STRICT L_ID_ASIENTO FROM CONTA_ASIENTO;
                                        INSERT INTO CONTA_ASIENTO(ID_ASIENTO, ID_TIPOORIGEN, ID_ORIGEN, FONDO, DEPTO, CUENTA, CUENTA_CTE, RESTRICCION,IMPORTE, DESCRIPCION, MEMO, VOUCHER, REF_ID, AGRUPA)
                                        VALUES(L_ID_ASIENTO, L_ID_TIPOORIGEN, L_ID_VDETALLE, L_ID_FONDO, '11010101', '1132001','2','0A',L_IMPORTE_DET*(CASE WHEN L_DC='C' THEN -1  ELSE 1 END ),
                                        P_ID_ENTIDAD||'-('||L_SERIE||'-'||L_CORRELATIVO||')-'||L_GLOSA||'-'||L_NAME, L_ID_TIPOORIGEN || '-' || L_ID_VDETALLE, L_ID_VOUCHER, NULL,'S');
                                        --CREDITO
                                        SELECT ID_EQUIV,ID_CTA_CTE,ID_RESTRICCION INTO STRICT L_ID_CUENTAAASI, L_CTACTE, L_RESTRICCION
                                        FROM CONT_EQUIV@DBL_ARON_APP WHERE ID_CONT = '001-2020' AND ID_CUENTA = L_CUENTA;

                                        SELECT ID_EQUIV INTO STRICT L_ID_DEPTO_ASIENTO
                                        FROM CONT_EQUIV_NIVEL@DBL_ARON_APP WHERE ID_CONT = '001-2020' AND ID_NIVEL = L_NIVEL;

                                        SELECT coalesce(MAX(ID_ASIENTO),0)+1 INTO STRICT L_ID_ASIENTO FROM CONTA_ASIENTO;
                                        INSERT INTO CONTA_ASIENTO(ID_ASIENTO, ID_TIPOORIGEN, ID_ORIGEN, FONDO, DEPTO, CUENTA, CUENTA_CTE, RESTRICCION,IMPORTE, DESCRIPCION, MEMO, VOUCHER, REF_ID, AGRUPA)
                                        VALUES(L_ID_ASIENTO, L_ID_TIPOORIGEN, L_ID_VDETALLE, L_ID_FONDO, L_ID_DEPTO_ASIENTO, L_ID_CUENTAAASI, L_CTACTE, L_RESTRICCION,L_IMPORTE_DET*(CASE WHEN L_DC='D' THEN -1  ELSE 1 END ),
                                        P_ID_ENTIDAD||'-('||L_SERIE||'-'||L_CORRELATIVO||')-'||L_DETALLE||'-'||L_NAME, L_ID_TIPOORIGEN || '-' || L_ID_VDETALLE, L_ID_VOUCHER, NULL,L_AGRUPA);

                                    FETCH DETALLE INTO L_DETALLE,L_IMPORTE_DET,L_DESCUENTO,L_CUENTA,L_NIVEL,L_DC;
                                    END LOOP;
                                CLOSE DETALLE;

                                SELECT 
                                        SUM(IMPORTE*CASE WHEN DC='C' THEN -1  ELSE 1 END ) AS IMPORTE,SUM(DESCUENTO) AS DESCUENTO INTO STRICT L_TOTAL, L_T_DESCUENTO
                                FROM VENTA_DETALLE
                                WHERE ID_VENTA = L_ID_VENTA;

                                UPDATE VENTA SET INAFECTA = L_TOTAL, DESCUENTO = L_T_DESCUENTO,TOTAL = L_TOTAL
                                WHERE ID_VENTA = L_ID_VENTA;

                                --CANCELA LA VENTA SI TIENE DINERO / EJECUTA ANTICIPOS
                                SELECT SUM(IMPORTE) AS TOTAL INTO STRICT L_TOTAL_ANTICIPO
                                FROM VW_SALES_ADVANCES
                                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                                AND ID_DEPTO = P_ID_DEPTO
                                AND ID_ANHO = L_ID_ANHO
                                AND ID_CLIENTE = L_ID_CLIENTE;
                                IF L_TOTAL_ANTICIPO > 0 THEN
                                    IF L_TOTAL_ANTICIPO >= L_TOTAL THEN
                                        L_IMPORTE_ANTICIPO := L_TOTAL;
                                    ELSE
                                        L_IMPORTE_ANTICIPO := L_TOTAL_ANTICIPO;
                                    END IF;
                                    CALL pkg_sales_sp_crear_anticipos_clientes(P_ID_ENTIDAD,P_ID_DEPTO,L_ID_ANHO,L_ID_MES,L_ID_CLIENTE,L_ID_PERSONA,L_ID_VENTA,L_IMPORTE_ANTICIPO,L_DC_ANT,L_CODIGO_ANT,L_ERROR,L_MSGERROR,L_TIPO);
                                    IF L_ERROR > 0 THEN
                                      L_MSGERROR := L_MSGERROR;
                                  END IF;
                                END IF;
                                --VENTA ELECTRONICA
                                IF P_ID_ENTIDAD = 7124 THEN
                                    CALL pkg_sales_sp_venta_electronica(L_ID_VENTA,L_ID_COMPROBANTE);
                                END IF;
                            ELSE
                                L_ERROR := 1;
                                L_MSGERROR := 'ERROR: NO Existe Alumno';
                            END IF;

                        FETCH ALUMNOS INTO L_CODIGO,L_CODIGO_PERSONAL,L_CUENTA_EAP;
                        END LOOP;
                    CLOSE ALUMNOS;
                ELSE
                    L_ERROR := 1;
                    L_MSGERROR := 'ERROR: El mes no esta Activo';
                END IF;
            ELSE
                L_ERROR := 1;
                L_MSGERROR := 'ERROR: El Año no esta Activo';
            END IF;
        P_ERROR:=L_ERROR;
        P_MSGERROR:=L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_cobrar_cuota_fcs (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
