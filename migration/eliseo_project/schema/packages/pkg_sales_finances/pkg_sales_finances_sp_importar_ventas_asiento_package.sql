-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_importar_ventas_asiento (P_TIPO text,P_ID_VENTA bigint,P_ID_VDETALLE bigint,P_ID_FONDO bigint,P_CUENTA text,P_CUENTA_CTE text,P_RESTRICCION text,P_DEPTO text,P_DC text,P_PORCENTAJE bigint,P_ES_ESCUELA text,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_TIPOORIGEN bigint;
        L_ID_ORIGEN bigint;
        L_DEPTO varchar(10);
        L_CUENTA_CTE varchar(10);
        L_IMPORTE decimal(10,2);
        L_DESCRIPCION varchar(100);
        L_ID_VOUCHER bigint;
        L_IMPORTE_ME decimal(10,2) :=0;
        L_IMP decimal(10,2);
        L_MSGERROR varchar(200);
        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);

BEGIN
            IF P_TIPO = 'V' THEN  --SI SE IMPORTAN VENTAS
                L_ID_ORIGEN := P_ID_VDETALLE;
                SELECT ID_ENTIDAD,ID_DEPTO,ID_TIPOORIGEN,ID_VOUCHER,ID_ENTIDAD||'-'||ID_DEPTO||'-'||SERIE||'-'||NUMERO||'-'||GLOSA,(TOTAL*P_PORCENTAJE/100)*CASE WHEN P_DC='D' THEN 1  ELSE -1 END  AS TOTAL
                INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPOORIGEN,L_ID_VOUCHER,L_DESCRIPCION,L_IMPORTE
                FROM VENTA WHERE ID_VENTA = P_ID_VENTA;
            ELSE  --SI SE IMPORTAN TRANSFERENCIAS
                L_ID_ORIGEN := P_ID_VENTA;
                SELECT ID_ENTIDAD,ID_DEPTO,ID_TIPOORIGEN,ID_VOUCHER,ID_ENTIDAD||'-'||ID_DEPTO||'-'||SERIE||'-'||NUMERO||'-'||GLOSA,(IMPORTE*P_PORCENTAJE/100)*CASE WHEN P_DC='D' THEN 1  ELSE -1 END  AS TOTAL
                INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_TIPOORIGEN,L_ID_VOUCHER,L_DESCRIPCION,L_IMPORTE
                FROM VENTA_TRANSFERENCIA WHERE ID_TRANSFERENCIA = P_ID_VENTA;
            END IF;

            IF P_CUENTA = '1132001' THEN
                IF L_ID_ENTIDAD = 7124 AND L_ID_DEPTO = '1' THEN
                    L_DEPTO := '11010101';
                    L_CUENTA_CTE := '2';
                ELSIF L_ID_ENTIDAD = 7124 AND L_ID_DEPTO = '5' THEN
                    L_DEPTO := '51010101';
                    L_CUENTA_CTE := '8';
                ELSIF L_ID_ENTIDAD = 7124 AND L_ID_DEPTO = '6' THEN
                    L_DEPTO := '61010101';
                    L_CUENTA_CTE := '11';
                ELSE
                    L_DEPTO := '11010101';
                    L_CUENTA_CTE := '2';
                END IF;
            ELSE
                L_CUENTA_CTE := P_CUENTA_CTE;
                IF P_ES_ESCUELA = 'S' THEN
                    L_DEPTO := ''; --PREGUNTAR A SOTIL
                ELSE
                    L_DEPTO := P_DEPTO;
                END IF;
            END IF;

            INSERT INTO CONTA_ASIENTO(ID_TIPOORIGEN,ID_ORIGEN,FONDO,DEPTO,CUENTA,CUENTA_CTE,RESTRICCION,IMPORTE,DESCRIPCION,MEMO,VOUCHER,AGRUPA,IMPORTE_ME)
            VALUES (
                L_ID_TIPOORIGEN,L_ID_ORIGEN,P_ID_FONDO,L_DEPTO,P_CUENTA,L_CUENTA_CTE,P_RESTRICCION,L_IMPORTE,L_DESCRIPCION,L_ID_ORIGEN,L_ID_VOUCHER,'S',L_IMPORTE_ME
            );
            P_ERROR :=0;
            L_MSGERROR := 'ASIENTO: ASIENTO PROCESADO';
            P_MSGERROR := L_MSGERROR;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_importar_ventas_asiento (P_TIPO text,P_ID_VENTA bigint,P_ID_VDETALLE bigint,P_ID_FONDO bigint,P_CUENTA text,P_CUENTA_CTE text,P_RESTRICCION text,P_DEPTO text,P_DC text,P_PORCENTAJE bigint,P_ES_ESCUELA text,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
