-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_resultado_departamento (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_USER bigint) AS $body$
BEGIN
            DELETE FROM EF_RESULTADO_DEPTO WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_ANHO = P_ID_ANHO AND ID_MES = P_ID_MES;

            INSERT INTO EF_RESULTADO_DEPTO(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,IMPORTE)
            SELECT P_ID_ENTIDAD,ID_DEPTO,P_ID_ANHO,P_ID_MES,SUM(IMPORTE) AS IMPORTE
            FROM (
                    SELECT ID_DEPTO,COS_VALOR as IMPORTE 
                    FROM VW_CONTA_DIARIO  WHERE ID_ENTIDAD = P_ID_ENTIDAD  AND ID_ANHO = P_ID_ANHO  AND ID_MES <= P_ID_MES   
                    AND ID_CUENTAAASI LIKE '3%'
                    
UNION ALL

                    SELECT ID_DEPTO,COS_VALOR as IMPORTE 
                    FROM VW_CONTA_DIARIO  WHERE ID_ENTIDAD = P_ID_ENTIDAD  AND ID_ANHO = P_ID_ANHO  AND ID_MES <= P_ID_MES   
                    AND ID_CUENTAAASI LIKE '4%'
            ) alias2 
            GROUP BY ID_DEPTO
            ORDER BY ID_DEPTO;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_resultado_departamento (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_USER bigint) FROM PUBLIC;
