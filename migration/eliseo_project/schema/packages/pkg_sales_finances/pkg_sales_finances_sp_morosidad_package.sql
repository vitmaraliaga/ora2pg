-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_morosidad (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_USER bigint,P_ID_SEMESTRE bigint,P_ID_NIVEL_ENSENANZA bigint,P_ID_MODO_CONTRATO bigint,P_ID_SEDE bigint,P_ID_MODALIDAD_ESTUDIO bigint) AS $body$
DECLARE

        L_ID_MES bigint;
        L_ID_CLIENTE bigint;
        L_ID_TIPOVENTA bigint;
        L_INGRESO decimal(10,2);
        L_DEBITO decimal(10,2);
        L_CREDITO decimal(10,2);
        L_SALDO decimal(10,2);
        L_MOROSIDAD decimal(10,2);
        L_CANT bigint :=0;
        L_ERROR bigint;

        C_ALUMNOS CURSOR FOR
        SELECT ID_PERSONA FROM VW_MAT_MATRICULADOS
        WHERE ID_SEMESTRE = P_ID_SEMESTRE  
        AND ID_NIVEL_ENSENANZA = P_ID_NIVEL_ENSENANZA 
        AND ID_MODO_CONTRATO = P_ID_MODO_CONTRATO 
        AND ID_SEDE = P_ID_SEDE 
        AND ID_MODALIDAD_ESTUDIO = P_ID_MODALIDAD_ESTUDIO
        AND CUOTAS <> 1;
        --AND ID_PERSONA IN (81236);--(198015,78583);
        C_MESES CURSOR FOR
        SELECT ID_MES FROM CONTA_MES
        WHERE ID_MES <= P_ID_MES;

        
BEGIN 
            delete from TT_SALDO_ALUMNO_MES1;
            INSERT INTO TT_SALDO_ALUMNO_MES1(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_CLIENTE,CREDITO,DEBITO,SALDO)--VALUES(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,L_ID_MES,L_ID_CLIENTE,L_INGRESO,L_DEBITO,L_CREDITO,L_SALDO);
            SELECT  A.ID_ENTIDAD,A.ID_DEPTO,A.ID_ANHO,A.ID_MES,A.ID_CLIENTE,A.CREDITO,A.DEBITO,A.SALDO
            --INTO L_INGRESO,L_DEBITO,L_SALDO
            FROM VW_SALDO_ALUMNO_MES A
            WHERE A.ID_ENTIDAD = P_ID_ENTIDAD
            AND A.ID_DEPTO = P_ID_DEPTO 
            AND A.ID_ANHO = P_ID_ANHO 
            AND A.ID_MES <= P_ID_MES
            AND A.ID_CLIENTE IN (
              SELECT ID_PERSONA FROM VW_MAT_MATRICULADOS
              WHERE ID_SEMESTRE = P_ID_SEMESTRE  
              AND ID_NIVEL_ENSENANZA = P_ID_NIVEL_ENSENANZA 
              AND ID_MODO_CONTRATO = P_ID_MODO_CONTRATO 
              AND ID_SEDE = P_ID_SEDE 
              AND ID_MODALIDAD_ESTUDIO = P_ID_MODALIDAD_ESTUDIO
              AND CUOTAS <> 1
              --AND ID_PERSONA IN (81236)
            );
            --AND A.ID_CLIENTE = 78583;
            DELETE FROM REP_MOROSIDAD WHERE ID_USER = P_ID_USER;
            OPEN C_ALUMNOS;
                FETCH C_ALUMNOS INTO L_ID_CLIENTE;
                WHILE C_ALUMNOS%FOUND LOOP

                    OPEN C_MESES;
                    FETCH C_MESES INTO L_ID_MES;
                        WHILE C_MESES%FOUND LOOP
                            BEGIN
                                SELECT 
                                A.DEBITO AS INGRESO,
                                (SELECT SUM(DEBITO) FROM TT_SALDO_ALUMNO_MES1 X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_DEPTO = A.ID_DEPTO AND X.ID_ANHO = A.ID_ANHO AND X.ID_CLIENTE = A.ID_CLIENTE AND X.ID_MES <= A.ID_MES) DEBITO,
                                (SELECT SUM(SALDO) FROM TT_SALDO_ALUMNO_MES1 X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_DEPTO = A.ID_DEPTO AND X.ID_ANHO = A.ID_ANHO AND X.ID_CLIENTE = A.ID_CLIENTE AND X.ID_MES <= A.ID_MES) SALDO
                                INTO STRICT L_INGRESO,L_DEBITO,L_SALDO
                                FROM TT_SALDO_ALUMNO_MES1 A
                                WHERE A.ID_ENTIDAD = P_ID_ENTIDAD 
                                AND A.ID_DEPTO = P_ID_DEPTO 
                                AND A.ID_ANHO = P_ID_ANHO 
                                AND A.ID_MES = L_ID_MES
                                AND A.ID_CLIENTE = L_ID_CLIENTE;

                                /*SELECT INGRESO,DEBITO,SALDO INTO L_INGRESO,L_DEBITO,L_SALDO
                                FROM TT_SALDO_ALUMNO_MES
                                WHERE ID_ENTIDAD = P_ID_ENTIDAD 
                                AND ID_DEPTO = P_ID_DEPTO 
                                AND ID_ANHO = P_ID_ANHO 
                                AND ID_MES = L_ID_MES
                                AND ID_CLIENTE = L_ID_CLIENTE;*/
                                
                                L_MOROSIDAD := (L_SALDO/(CASE WHEN L_DEBITO = 0 THEN 1 ELSE L_DEBITO END))*100;
                            EXCEPTION
                            WHEN OTHERS THEN
                                SELECT COUNT(1) INTO STRICT L_CANT FROM REP_MOROSIDAD WHERE ID_ENTIDAD = P_ID_ENTIDAD  AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ID_ANHO
                                AND ID_MES = L_ID_MES-1 AND ID_CLIENTE = L_ID_CLIENTE;
                                IF L_CANT > 0 THEN
                                    SELECT INGRESO,DEBITO,CREDITO,SALDO,MOROSIDAD INTO STRICT L_INGRESO,L_DEBITO,L_CREDITO,L_SALDO,L_MOROSIDAD
                                    FROM REP_MOROSIDAD WHERE ID_ENTIDAD = P_ID_ENTIDAD  AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ID_ANHO
                                    AND ID_MES = L_ID_MES-1 AND ID_CLIENTE = L_ID_CLIENTE;
                                ELSE
                                    L_INGRESO :=0;
                                    L_DEBITO :=0;
                                    L_CREDITO :=0;
                                    L_SALDO :=0;
                                    L_MOROSIDAD :=0;
                                END IF;
                            END;

                            BEGIN
                                INSERT INTO REP_MOROSIDAD(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_CLIENTE,ID_USER,ID_TIPOVENTA,INGRESO,DEBITO,CREDITO,SALDO,MOROSIDAD)
                                VALUES (P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,L_ID_MES,L_ID_CLIENTE,P_ID_USER,L_ID_TIPOVENTA,L_INGRESO,L_DEBITO,L_CREDITO,L_SALDO,L_MOROSIDAD);
                            EXCEPTION
                            WHEN OTHERS THEN
                                L_ERROR :=0;
                            END;

                        FETCH C_MESES INTO L_ID_MES;
                        END LOOP;
                    CLOSE C_MESES;
                    L_INGRESO :=0;
                    L_DEBITO :=0;
                    L_CREDITO :=0;
                    L_SALDO :=0;
                    L_MOROSIDAD :=0;

                FETCH C_ALUMNOS INTO L_ID_CLIENTE;
                END LOOP;
            CLOSE C_ALUMNOS;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_morosidad (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_USER bigint,P_ID_SEMESTRE bigint,P_ID_NIVEL_ENSENANZA bigint,P_ID_MODO_CONTRATO bigint,P_ID_SEDE bigint,P_ID_MODALIDAD_ESTUDIO bigint) FROM PUBLIC;
