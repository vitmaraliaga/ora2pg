-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_orders_sp_update_kardex_pedido (P_ID_ALMACEN bigint,P_ID_VOUCHER integer) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_ID_ANHO bigint;
        L_ID_MES bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_CANTIDAD bigint;
        L_COSTO bigint;
        L_IMPORTE bigint;
        L_MSN_ERROR varchar(200):='';
        L_ID_TIPOASIENTO varchar(4);
        l_error bigint:=0;
        l_contar bigint;
        L_ID_VOUCHER bigint;
        l_automatico varchar(1);
        L_CODIGO varchar(20):='70';
        L_ES_SERVICES varchar(1);
        L_ID_PERSONA bigint;
        L_CANT_PED decimal(10,2) :=0;
        L_CANT_DES decimal(10,2) :=0;
        L_ID_TIPOORIGEN bigint :=13;
        L_ID_DESPACHO bigint;
        L_ID_EXISTENCIA bigint;
        L_ID_SEDEAREA bigint;
        L_FECHA timestamp(0);
        L_ID_PEDIDO bigint;

        articulos CURSOR FOR

        SELECT DISTINCT
        A.ID_PEDIDO,C.ID_PERSONA,C.ID_VOUCHER
        FROM PEDIDO_REGISTRO A 
        JOIN PEDIDO_DETALLE B ON A.ID_PEDIDO = B.ID_PEDIDO 
        JOIN PEDIDO_DESPACHO C ON B.ID_DETALLE = C.ID_DETALLE 
        JOIN CONTA_VOUCHER D ON C.ID_VOUCHER = D.ID_VOUCHER
        LEFT JOIN VENTA X ON A.ID_PEDIDO = X.ID_PEDIDO
        WHERE A.ID_ENTIDAD = 7124
        AND A.ID_ANHO = 2023
        AND D.ID_MES = 5
        AND C.ID_ALMACEN = P_ID_ALMACEN
        AND (A.ID_TASK IS NOT NULL AND A.ID_TASK::text <> '')
        AND C.ID_ARTICULO <> 0
        AND coalesce(X.ID_PEDIDO::text, '') = ''
        --AND A.ID_PEDIDO = 175595
        AND C.ID_VOUCHER = P_ID_VOUCHER;


BEGIN

            OPEN articulos;
              FETCH articulos INTO L_ID_PEDIDO,L_ID_PERSONA,L_ID_VOUCHER;
                WHILE articulos%FOUND LOOP

                    SELECT coalesce(ID_EXISTENCIA,11) INTO STRICT L_ID_EXISTENCIA FROM INVENTARIO_ALMACEN WHERE ID_ALMACEN = P_ID_ALMACEN;

                    IF (L_ID_EXISTENCIA = 1 OR L_ID_EXISTENCIA = 2) THEN  --TIPO DE LAMACEN
                        UPDATE PEDIDO_DESPACHO SET ESTADO = '0' WHERE ID_VOUCHER = L_ID_VOUCHER AND ESTADO = '1'
                        AND ID_DETALLE IN (SELECT ID_DETALLE FROM PEDIDO_DETALLE WHERE ID_PEDIDO = L_ID_PEDIDO );

                        CALL pkg_sales_sp_venta_autoconsumo(L_ID_PEDIDO,L_ID_PERSONA,l_error,L_MSN_ERROR);

                        UPDATE PEDIDO_DESPACHO SET ESTADO = '1' WHERE ID_VOUCHER = L_ID_VOUCHER AND ESTADO = '0' 
                        AND ID_DETALLE IN (SELECT ID_DETALLE FROM PEDIDO_DETALLE WHERE ID_PEDIDO = L_ID_PEDIDO );

                    END IF;

                    FETCH articulos INTO L_ID_PEDIDO,L_ID_PERSONA,L_ID_VOUCHER;
                END LOOP;
            CLOSE articulos;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_orders_sp_update_kardex_pedido (P_ID_ALMACEN bigint,P_ID_VOUCHER integer) FROM PUBLIC;
