-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_orders_sp_pedido_asiento_plantilla (P_ID_PEDIDO bigint, P_ID_DINAMICA bigint, P_ERROR OUT bigint,P_MSN_ERROR OUT text) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ORIGEN bigint;
        L_DESTINO bigint;

        l_id_asiento bigint;
        l_id_parent bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);
        l_unicoctated varchar(1);
        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_id_fondo bigint;
        l_descripcion varchar(255);
        l_agrupa varchar(1);
        l_ctas varchar(200);
        l_ctates varchar(200);
        l_cont bigint;
        l_actas tablastring;
        l_actates tablastring;
        l_buscar bigint;
        l_importe decimal(10,2);

        DETA CURSOR FOR
        SELECT 
            ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,'D' AS DC, PORCENTAJE,IMPORTE,DETALLE,'BASE' AS INDICADOR
        FROM PEDIDO_PLANTILLA_COMPRA
        WHERE ID_PEDIDO = P_ID_PEDIDO;

        casi CURSOR FOR		
        SELECT 
                a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,round((a.PORCENTAJE*100)::numeric,2),a.NOMBRE,a.AGRUPA,a.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a,CONTA_DINAMICA d
        WHERE a.ID_DINAMICA=d.ID_DINAMICA 
        AND a.ID_DINAMICA =P_ID_DINAMICA 
        AND A.DC = 'C'
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        
BEGIN 
            OPEN DETA;
                FETCH DETA INTO l_id_tipoplan,l_id_cuentaaasi,l_id_restriccion,l_id_fondo,l_cuenta_cte,l_depto,l_dc,l_porcentaje,l_importe,l_descripcion,l_id_indicador;
                WHILE DETA%FOUND LOOP

                     INSERT INTO PEDIDO_ASIENTO(ID_PASIENTO,ID_PEDIDO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,DC,PORCENTAJE,IMPORTE,GLOSA,INDICADOR,AGRUPA) 
                    VALUES (nextval('eliseo.sq_pedido_asiento_id'),P_ID_PEDIDO,l_id_tipoplan,l_id_cuentaaasi,l_id_restriccion,l_id_fondo,l_cuenta_cte,l_depto,l_dc,l_porcentaje,l_importe,l_descripcion,l_id_indicador,'N');

                FETCH DETA INTO l_id_tipoplan,l_id_cuentaaasi,l_id_restriccion,l_id_fondo,l_cuenta_cte,l_depto,l_dc,l_porcentaje,l_importe,l_descripcion,l_id_indicador;
                END LOOP;
            CLOSE DETA;

            SELECT A.ID_ENTIDAD, 
            (SELECT X.ID_DEPTO FROM ORG_SEDE_AREA X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_SEDEAREA = coalesce(A.ID_AREAGASTO,A.ID_AREAORIGEN) ) ORIGEN,
            (SELECT X.ID_DEPTO FROM ORG_SEDE_AREA X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_SEDEAREA = ID_AREADESTINO) DESTINO
            INTO STRICT L_ID_ENTIDAD,L_ORIGEN,L_DESTINO 
            FROM PEDIDO_REGISTRO A 
            WHERE A.ID_PEDIDO = P_ID_PEDIDO;

            SELECT IMPORTE*-1 INTO STRICT l_importe 
            FROM PEDIDO_COMPRA
            WHERE ID_PEDIDO = P_ID_PEDIDO;
            OPEN casi;
            FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa,l_id_fondo;
            WHILE casi%FOUND LOOP
                l_depto:=null;
                l_cuenta_cte:=null;

                if l_unico='U' then
                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                elsif (l_unico='X') then
                    IF l_dc = 'C' THEN
                        l_depto := L_DESTINO;
                    ELSE
                        l_depto := L_ORIGEN;
                    END IF;
                end if;

                if l_unicoctate='U' then
                    SELECT  count(*) into STRICT l_cont FROM CONTA_DINAMICA_CTA_CTE WHERE id_entidad = L_ID_ENTIDAD AND id_asiento = l_id_asiento;
                    if l_cont>0 then
                        SELECT ID_CTACTE into STRICT l_cuenta_cte FROM CONTA_DINAMICA_CTA_CTE WHERE id_entidad = L_ID_ENTIDAD AND id_asiento = l_id_asiento;
                    end if;
                elsif (l_unicoctated='M') then
                    SELECT position('|' in l_ctates) into STRICT l_buscar;
                    if l_buscar>0 then
                        select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                        select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                        select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                    else
                        l_cuenta_cte:=l_ctates;
                    end if;
                end if;

                INSERT INTO PEDIDO_ASIENTO(ID_PASIENTO,ID_PEDIDO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,DC,PORCENTAJE,IMPORTE,GLOSA,INDICADOR,AGRUPA) 
                VALUES (nextval('eliseo.sq_pedido_asiento_id'),P_ID_PEDIDO,l_id_tipoplan,l_id_cuentaaasi,l_id_restriccion,l_id_fondo,l_cuenta_cte,l_depto,l_dc,l_porcentaje,l_importe,l_descripcion,l_id_indicador,l_agrupa);

                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa,l_id_fondo;

            END LOOP;
            CLOSE casi;

        P_ERROR:=0;
        P_MSN_ERROR:='ok';
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_orders_sp_pedido_asiento_plantilla (P_ID_PEDIDO bigint, P_ID_DINAMICA bigint, P_ERROR OUT bigint,P_MSN_ERROR OUT text) FROM PUBLIC;
