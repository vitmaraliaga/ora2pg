-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_orders_sp_pedido_asiento (P_ID_PEDIDO bigint, P_ID_DINAMICA bigint, P_ERROR OUT bigint,P_MSN_ERROR OUT text) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ORIGEN varchar(10);
        L_DESTINO varchar(10);
        L_ID_DEPTO varchar(10);

        l_id_asiento bigint;
        l_id_parent bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);
        l_unicoctated varchar(1);
        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_id_fondo bigint;
        l_descripcion varchar(100);
        l_agrupa varchar(1);
        l_ctas varchar(200);
        l_ctates varchar(200);
        l_cont bigint;
        l_actas tablastring;
        l_actates tablastring;
        l_buscar bigint;
        l_nro_asiento bigint;
        L_ORDERS varchar(1);
        L_INSERT varchar(1);
        L_NUMERO varchar(10);
        L_MOTIVO varchar(100);
        L_FECHA varchar(12);
        L_DET varchar(4);

        casi CURSOR FOR		
        SELECT 
                a.ID_ASIENTO,d.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,round((a.PORCENTAJE*100)::numeric,2),a.NOMBRE,a.AGRUPA,a.ID_FONDO,a.NRO_ASIENTO
        FROM CONTA_DINAMICA_ASIENTO a,CONTA_DINAMICA d
        WHERE a.ID_DINAMICA=d.ID_DINAMICA 
        AND a.ID_DINAMICA =P_ID_DINAMICA 
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        casides CURSOR FOR		
        SELECT 
                a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,round((a.PORCENTAJE*100)::numeric,2),a.NOMBRE,a.AGRUPA,a.ID_FONDO,2 as NRO_ASIENTO
        FROM CONTA_DINAMICA_ASIENTO a,CONTA_DINAMICA d
        WHERE a.ID_DINAMICA=d.ID_DINAMICA 
        AND a.ID_DINAMICA = l_id_parent 
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        
BEGIN  
            SELECT A.ID_ENTIDAD,A.ID_DEPTO, CASE WHEN A.ID_TIPOPEDIDO='3' THEN 'S' WHEN A.ID_TIPOPEDIDO='4' THEN 'S' WHEN A.ID_TIPOPEDIDO='5' THEN 'S' WHEN A.ID_TIPOPEDIDO='6' THEN 'S'  ELSE 'N' END ,
                (SELECT X.ID_DEPTO FROM ORG_SEDE_AREA X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_SEDEAREA = coalesce(A.ID_AREAGASTO,A.ID_AREAORIGEN) ) ORIGEN,
                (SELECT X.ID_DEPTO FROM ORG_SEDE_AREA X WHERE X.ID_ENTIDAD = A.ID_ENTIDAD AND X.ID_SEDEAREA = ID_AREADESTINO) DESTINO,(NUMERO)::numeric ::text,SUBSTR(MOTIVO,1,50),TO_CHAR(FECHA,'DD/MM/YYYY')
                INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ORDERS,L_ORIGEN,L_DESTINO,L_NUMERO,L_MOTIVO,L_FECHA
            FROM PEDIDO_REGISTRO A 
            WHERE A.ID_PEDIDO = P_ID_PEDIDO;

            DELETE FROM PEDIDO_ASIENTO
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            OPEN casi;
            FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa,l_id_fondo,l_nro_asiento;
            WHILE casi%FOUND LOOP
                l_depto:=null;
                l_cuenta_cte:=null;

                if l_unico='U' then
                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                elsif (l_unico='X') then
                    IF l_dc = 'C' THEN
                        l_depto := L_DESTINO;
                    ELSE
                        l_depto := L_ORIGEN;
                    END IF;
                end if;

                if l_unicoctate='U' then
                    SELECT  count(1) into STRICT l_cont FROM CONTA_DINAMICA_CTA_CTE WHERE id_entidad = L_ID_ENTIDAD AND id_asiento = l_id_asiento;
                    if l_cont>0 then
                        SELECT ID_CTACTE into STRICT l_cuenta_cte FROM CONTA_DINAMICA_CTA_CTE WHERE id_entidad = L_ID_ENTIDAD AND id_asiento = l_id_asiento;
                    end if;
                elsif (l_unicoctated='M') then
                    SELECT position('|' in l_ctates) into STRICT l_buscar;
                    if l_buscar>0 then
                        select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                        select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                        select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                    else
                        l_cuenta_cte:=l_ctates;
                    end if;
                end if;

                --cta cte bazar
                L_INSERT := 'S';
                IF L_ORDERS = 'S' THEN
                    l_descripcion := 'PI:'||L_NUMERO||'-'||L_MOTIVO||'-'||L_FECHA;
                    IF l_dc = 'C' THEN
                        L_INSERT := 'S';
                        IF L_ID_DEPTO = '5' THEN
                            IF L_DESTINO = '52020102' OR L_DESTINO = '51010111' OR L_DESTINO = '52020107' OR L_DESTINO = '53020604' OR L_DESTINO = '52020112' OR L_DESTINO = '53010601' THEN
                                SELECT (CASE L_DESTINO
                                                WHEN '52020102' THEN  '1131001' --COMEDOR JULIACA
                                                WHEN '51010111' THEN  '1146001' --logistica
                                                WHEN '52010108' THEN  '3191005' --transporte
                                                WHEN '52020107' THEN  '1131001' --cafetin
                                                WHEN '52020112' THEN  '1139090' -- panaificadora
                                                WHEN '53020604' THEN  '1139090' -- lacteos
                                                WHEN '53010601' THEN  '1139090' -- textileria
                                            END),
                                            (CASE L_DESTINO 
                                                WHEN '52020102' THEN  '5' --COMEDOR
                                                WHEN '51010111' THEN  '1' --logistica
                                                WHEN '52010108' THEN  '2' --transporte
                                                WHEN '52020107' THEN  '10' --cafetin
                                                WHEN '52020112' THEN  '5' -- panaificadora
                                                WHEN '53020604' THEN  '5' -- lacteos
                                                WHEN '53010601' THEN  '5' -- textileria
                                            END) INTO STRICT l_id_cuentaaasi,l_cuenta_cte
;
                                l_id_restriccion :='0A';
                            END IF;
                            l_depto := '51010101';
                        ELSE
                        IF L_ID_DEPTO <> '4' THEN
                            IF L_DESTINO = '12020102' OR L_DESTINO = '11010111' OR L_DESTINO = '12020107' OR L_DESTINO = '12020104' THEN
                                l_id_cuentaaasi := '1146001';
                                l_cuenta_cte := '';
                                l_depto := L_DESTINO;
                                l_id_restriccion :='0A';

                                SELECT (CASE L_DESTINO
                                            WHEN '12020102' THEN  '1131001' --bazar
                                            WHEN '11010111' THEN  '1146001' --logistica
                                            WHEN '12020107' THEN  '1131001' --cafetin
                                            WHEN '12020104' THEN  '1131001' -- comedor
                                        END),
                                        (CASE L_DESTINO 
                                            WHEN '12020102' THEN  '4' --bazar
                                            WHEN '11010111' THEN  '1' --logistica
                                            WHEN '12020107' THEN  '10' --cafetin
                                            WHEN '12020104' THEN  '5' -- comedor
                                        END) INTO STRICT l_id_cuentaaasi,l_cuenta_cte
;
                            ELSIF SUBSTR(L_DESTINO,1,1) = '2' OR SUBSTR(L_DESTINO,1,1) = '3' OR SUBSTR(L_DESTINO,1,1) = '4' OR SUBSTR(L_DESTINO,1,1) = '5' OR SUBSTR(L_DESTINO,1,1) = '6' THEN
                                l_id_cuentaaasi := '1136080';
                                l_depto := '11010101';
                                l_id_restriccion :='0A';
                                SELECT
                                    CASE SUBSTR(L_DESTINO,1,1) 
                                        WHEN '2' THEN  '21010101'
                                        WHEN '3' THEN  '31010101'
                                        WHEN '4' THEN  '41010101'
                                        WHEN '5' THEN  '51010101'
                                        WHEN '6' THEN  '61010101'
                                        WHEN '7' THEN  '71010101'
                                    END INTO STRICT l_cuenta_cte
;
                            ELSE
                                SELECT CASE WHEN SUBSTR(L_ORIGEN,1,1)='2' THEN 'PU' WHEN SUBSTR(L_ORIGEN,1,1)='3' THEN 'IU' WHEN SUBSTR(L_ORIGEN,1,1)='4' THEN 'CU' WHEN SUBSTR(L_ORIGEN,1,1)='5' THEN 'FJ'  ELSE 'FT' END  INTO STRICT L_DET;
                                l_descripcion := 'PI:'||L_NUMERO||'-'||L_DET||'-'||L_MOTIVO||'-'||L_FECHA;
                                l_id_cuentaaasi := l_id_cuentaaasi;
                                l_cuenta_cte := l_cuenta_cte;
                                l_depto := l_depto;
                            END IF;
                            END IF;
                        END IF;
                    ELSE  --DEBITO
                    IF L_ID_DEPTO <> '4' THEN
                        IF L_DESTINO = '12020102' OR L_DESTINO = '11010111' OR L_DESTINO = '12020107' OR L_DESTINO = '12020104' THEN
                            L_INSERT := 'N';
                        ELSIF SUBSTR(L_DESTINO,1,1) = '2' OR SUBSTR(L_DESTINO,1,1) = '3' OR SUBSTR(L_DESTINO,1,1) = '4' OR SUBSTR(L_DESTINO,1,1) = '5X' OR SUBSTR(L_DESTINO,1,1) = '6X' THEN
                            L_INSERT := 'N';
                        ELSIF  L_DESTINO = '52020102' OR L_DESTINO = '51010111' OR L_DESTINO = '52020107' OR L_DESTINO = '53020604' OR L_DESTINO = '52020112' OR L_DESTINO = '53010601' THEN  --DEBITO JULIACA
                            L_INSERT := 'N';
                        ELSE
                            L_INSERT := 'S';
                        END IF;
                        END IF;
                        IF l_dc = 'D' THEN
                            IF SUBSTR(L_ORIGEN,1,1) = '2' OR SUBSTR(L_ORIGEN,1,1) = '3' OR SUBSTR(L_ORIGEN,1,1) = '4' OR SUBSTR(L_ORIGEN,1,1) = '5X' OR SUBSTR(L_ORIGEN,1,1) = '6X' THEN  --PEDIDO INTER-DEP
                                SELECT CASE WHEN SUBSTR(L_ORIGEN,1,1)='2' THEN 'PU' WHEN SUBSTR(L_ORIGEN,1,1)='3' THEN 'IU' WHEN SUBSTR(L_ORIGEN,1,1)='4' THEN 'CU' WHEN SUBSTR(L_ORIGEN,1,1)='5' THEN 'FJ'  ELSE 'FT' END  INTO STRICT L_DET;
                                l_depto := '11010101';
                                l_id_restriccion :='0A';
                                IF L_ID_DEPTO <> '4' THEN
                                IF L_DESTINO = '12020102' OR L_DESTINO = '11010111' OR L_DESTINO = '12020107' OR L_DESTINO = '12020104' THEN
                                    SELECT '1136080' AS CTA,
                                        (CASE SUBSTR(L_ORIGEN,1,1)
                                            WHEN '2' THEN  '21010101'
                                            WHEN '3' THEN  '31010101'
                                            WHEN '4' THEN  '41010101'
                                            WHEN '5' THEN  '51010101'
                                            WHEN '6' THEN  '61010101'
                                            WHEN '7' THEN  '71010101'
                                        END) INTO STRICT l_id_cuentaaasi,l_cuenta_cte
;
                                ELSE
                                    l_id_cuentaaasi :='1136080';
                                    l_cuenta_cte :='11010101';
                                    l_descripcion := 'PI:'||L_NUMERO||'-'||L_DET||'-'||L_MOTIVO||'-'||L_FECHA;
                                END IF;
                                END IF;
                            END IF;
                        END IF;
                    END IF;
                END IF;
                /*IF L_ORDERS = 'S' THEN 
                    IF l_dc = 'C' THEN
                        SELECT 
                        CASE L_DESTINO 
                            WHEN '12020107' THEN  '1131001'
                            WHEN '12020102' THEN  '1131001'
                            WHEN '21010101' THEN  '1136080'
                            WHEN '31010101' THEN  '1136080'
                            WHEN '11010111' THEN  '1146001'
                            ELSE '3191005'
                        END ,
                        CASE L_DESTINO 
                            WHEN '11010111' THEN  '1'
                            WHEN '12020107' THEN  '10'
                            WHEN '12020102' THEN  '4'
                            WHEN '21010101' THEN  '11010101'
                            WHEN '31010101' THEN  '11010101'
                            WHEN '41010101' THEN  '11010101'
                            ELSE '2'
                        END,'2' INTO l_id_cuentaaasi,l_cuenta_cte,l_id_restriccion
                        FROM DUAL;
                    END IF;
                END IF;*/
                IF L_INSERT = 'S' THEN
                    INSERT INTO PEDIDO_ASIENTO(ID_PASIENTO,ID_PEDIDO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,DC,PORCENTAJE,GLOSA,INDICADOR,AGRUPA,NRO_ASIENTO)
                    VALUES (nextval('eliseo.sq_pedido_asiento_id'),P_ID_PEDIDO,l_id_tipoplan,l_id_cuentaaasi,l_id_restriccion,l_id_fondo,l_cuenta_cte,l_depto,l_dc,l_porcentaje,l_descripcion,l_id_indicador,l_agrupa,l_nro_asiento);
                END IF;

                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa,l_id_fondo,l_nro_asiento;

            END LOOP;
            CLOSE casi;
            --Destino
            OPEN casides;
            FETCH casides INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa,l_id_fondo,l_nro_asiento;
            WHILE casides%FOUND LOOP
                l_depto:=null;
                l_cuenta_cte:=null;

                if l_unico='U' then
                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                elsif (l_unico='X') then
                    IF l_dc = 'C' THEN
                        l_depto := L_DESTINO;
                    ELSE
                        l_depto := L_ORIGEN;
                    END IF;
                end if;

                if l_unicoctate='U' then
                    SELECT  count(*) into STRICT l_cont FROM CONTA_DINAMICA_CTA_CTE WHERE id_entidad = L_ID_ENTIDAD AND id_asiento = l_id_asiento;
                    if l_cont>0 then
                        SELECT ID_CTACTE into STRICT l_cuenta_cte FROM CONTA_DINAMICA_CTA_CTE WHERE id_entidad = L_ID_ENTIDAD AND id_asiento = l_id_asiento;
                    end if;
                elsif (l_unicoctated='M') then
                    SELECT position('|' in l_ctates) into STRICT l_buscar;
                    if l_buscar>0 then
                        select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                        select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                        select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                    else
                        l_cuenta_cte:=l_ctates;
                    end if;
                end if;
                INSERT INTO PEDIDO_ASIENTO(ID_PASIENTO,ID_PEDIDO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,DC,PORCENTAJE,GLOSA,INDICADOR,AGRUPA,NRO_ASIENTO)
                VALUES (nextval('eliseo.sq_pedido_asiento_id'),P_ID_PEDIDO,l_id_tipoplan,l_id_cuentaaasi,l_id_restriccion,l_id_fondo,l_cuenta_cte,l_depto,l_dc,l_porcentaje,l_descripcion,l_id_indicador,l_agrupa,l_nro_asiento);

                FETCH casides INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa,l_id_fondo,l_nro_asiento;

            END LOOP;
            CLOSE casides;
        P_ERROR:=0;
        P_MSN_ERROR:='ok';
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_orders_sp_pedido_asiento (P_ID_PEDIDO bigint, P_ID_DINAMICA bigint, P_ERROR OUT bigint,P_MSN_ERROR OUT text) FROM PUBLIC;
