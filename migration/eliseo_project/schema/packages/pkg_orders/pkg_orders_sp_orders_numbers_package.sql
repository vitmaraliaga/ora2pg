-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_orders_sp_orders_numbers (P_ID_PEDIDO bigint) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_NUMERO varchar(8);
        L_TIPOPEDIDO bigint;

BEGIN 
            SELECT ID_ENTIDAD, ID_DEPTO, ID_TIPOPEDIDO INTO STRICT L_ID_ENTIDAD, L_ID_DEPTO, L_TIPOPEDIDO
            FROM PEDIDO_REGISTRO
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            IF L_TIPOPEDIDO BETWEEN 3 AND 6 THEN 
                SELECT 
                    --LPAD(NVL(MAX(NUMERO),0)+1 ,8,0)INTO L_NUMERO
                    LPAD(coalesce(MAX((NUMERO)::numeric ),0)+1,8,0) INTO STRICT L_NUMERO
                FROM PEDIDO_REGISTRO
                WHERE ID_ENTIDAD = L_ID_ENTIDAD
                AND ID_DEPTO = L_ID_DEPTO
                AND ID_TIPOPEDIDO BETWEEN 3 AND 6;
            ELSE
                SELECT
                    --LPAD(NVL(MAX(NUMERO),0)+1,8,0) INTO L_NUMERO
                    LPAD(coalesce(MAX((NUMERO)::numeric ),0)+1,8,0) INTO STRICT L_NUMERO
                FROM PEDIDO_REGISTRO
                WHERE ID_ENTIDAD = L_ID_ENTIDAD
                AND ID_DEPTO = L_ID_DEPTO
                AND ID_TIPOPEDIDO BETWEEN 7 AND 11;
            END IF;
            UPDATE PEDIDO_REGISTRO SET NUMERO = L_NUMERO
            WHERE ID_PEDIDO = P_ID_PEDIDO;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_orders_sp_orders_numbers (P_ID_PEDIDO bigint) FROM PUBLIC;
