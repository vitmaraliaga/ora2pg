-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_ense_comunidad_ing (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_contar1 bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_semestre_programa bigint;
    l_id_persona bigint;

    l_id_criterio	bigint;
    l_importe	decimal(10,2);
    l_tipo_proceso	varchar(2);
    l_tipo_valor	varchar(2);
    l_id_semestre bigint;
    l_nombre varchar(150);
    l_id_plan_programa bigint;
    l_id_plan bigint;
    l_dc varchar(1);
    l_creditos decimal(10,2);
    l_comunidad varchar(1);

BEGIN
  
    SELECT ID_SEMESTRE_PROGRAMA,ID_PERSONA,ID_PLAN_PROGRAMA,coalesce(COMUNIDAD,'N')
    INTO STRICT l_id_semestre_programa,l_id_persona,l_id_plan_programa,l_comunidad
    FROM DAVID.ACAD_ALUMNO_CONTRATO
    WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

    
    IF l_comunidad='S' THEN
    
      SELECT 
        ID_CRITERIO,
        IMPORTE,
        TIPO_PROCESO,
        TIPO_VALOR,
        DC,
        NOMBRE
        INTO STRICT
        l_id_criterio,
        l_importe,
        l_tipo_proceso,
        l_tipo_valor,
        l_dc,
        l_nombre
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

      
      SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
      WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

    
      insert into MAT_CONCEPTO_ASIGN_ALUM(
        ID_ALUMNO_CONTRATO,
        ID_CRITERIO_SEMESTRE,
        ITEM,
        ID_SEMESTRE_PROGRAMA,
        DESCRIPCION,
        DC,
        CANTIDAD,
        UNITARIO,
        TOTAL,
        TIPO_VALOR,
        ID_PLAN
      )
      VALUES ( 
      P_ID_ALUMNO_CONTRATO,
      P_ID_CRITERIO_SEMESTRE,
      l_items, 
      l_id_semestre_programa,
      l_nombre,
      l_dc,
      1,
      l_importe,
      l_importe,
      l_tipo_valor,
      null);
    END IF;

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_ense_comunidad_ing (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
