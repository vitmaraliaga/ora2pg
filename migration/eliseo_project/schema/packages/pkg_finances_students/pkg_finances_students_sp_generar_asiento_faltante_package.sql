-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_generar_asiento_faltante (P_ID_ENTIDAD bigint) AS $body$
DECLARE

        L_ID bigint;
        L_ID_ANHO bigint := 2021;
        L_ID_MES bigint  := 1;
        L_ID_MONEDA bigint := 7;
        L_ID_CLIENTE bigint;
        L_TOTAL decimal(10,2);
        L_SALDO decimal(10,2);
        L_ID_VENTA bigint;
        L_SERIE varchar(4);
        L_NUMERO varchar(8);
        L_IMP decimal(10,2);
        L_ID_COMPROBANTE varchar(2) :='00';
        L_GLOSA varchar(200);
        L_FECHA timestamp(0);
        L_ID_TIPOVENTA bigint :=1;
        L_TOTAL_ANTICIPO decimal(10,2);
        L_IMPORTE_ANTICIPO   decimal(10,2);
        L_TOTAL_ME bigint :=0;
        L_DC varchar(1);
        L_CODIGO varchar(2);
        L_TIPO varchar(1);
        L_CANT bigint;
        L_MSN varchar(100);
        L_ERROR bigint :=0;
        L_ID_VNT bigint;
        L_ID_ALUMNO_CONTRATO bigint;

        C_ALUMNOS CURSOR FOR
        SELECT A.ID_VENTA, B.ID_ALUMNO_CONTRATO
        FROM ELISEO.VENTA A 
        INNER JOIN ELISEO.VENTA_DETALLE B ON B.ID_VENTA = A.ID_VENTA
        WHERE (B.ID_ALUMNO_CONTRATO IS NOT NULL AND B.ID_ALUMNO_CONTRATO::text <> '') AND A.FECHA LIKE '%31/08/21%' AND A.ID_DEPTO='5'
        AND A.ID_VENTA NOT IN (498873,498875,498930,498932)--= 498873
 
        GROUP BY A.ID_VENTA, A.SERIE, A.NUMERO , A.ID_PERSONA, A.TOTAL, B.ID_ALUMNO_CONTRATO,  A.GLOSA;


        
BEGIN
            OPEN C_ALUMNOS;
                FETCH C_ALUMNOS INTO L_ID_VENTA,L_ID_ALUMNO_CONTRATO;
                WHILE C_ALUMNOS%FOUND LOOP
                    CALL pkg_finances_students_sp_generar_asiento_mat_manual(L_ID_ALUMNO_CONTRATO,P_ID_ENTIDAD,L_ID_VENTA);
                FETCH C_ALUMNOS INTO L_ID_VENTA,L_ID_ALUMNO_CONTRATO;
                END LOOP;
            CLOSE C_ALUMNOS;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_generar_asiento_faltante (P_ID_ENTIDAD bigint) FROM PUBLIC;
