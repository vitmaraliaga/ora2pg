-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_copiar_planpago_semestre (P_ID_SEMESTRE_PROGRAMA_ORI bigint, P_ID_SEMESTRE_PROGRAMA_DES text, P_INDICADOR text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='';
      l_contar bigint;
      PP_ID_SEMESTRE_PROGRAMA_DES text:=P_ID_SEMESTRE_PROGRAMA_DES||'|';

      l_1 bigint;
      l_id_semestre_programa_des bigint;
      l_id_criterio_semestre bigint;
      curcri CURSOR FOR
       SELECT
            ID_PLANPAGO_SEMESTRE,
            ID_PLANPAGO,
            ID_SEMESTRE_PROGRAMA,
            ESTADO
          FROM MAT_PLANPAGO_SEMESTRE 
          WHERE ID_SEMESTRE_PROGRAMA=P_ID_SEMESTRE_PROGRAMA_ORI
          AND ESTADO='1'
          AND ID_PLANPAGO NOT IN (
            SELECT ID_PLANPAGO
            FROM MAT_PLANPAGO_SEMESTRE 
            WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa_des
          );

                 
    
BEGIN
    
     
        LOOP
            l_error:=0;
            l_1 := position('|'  in PP_ID_SEMESTRE_PROGRAMA_DES);
            exit when coalesce(l_1,0) = 0;

            select cast(trim(both substr(PP_ID_SEMESTRE_PROGRAMA_DES,1, l_1-1)) as bigint) into STRICT l_id_semestre_programa_des;

            if P_INDICADOR='D' THEN
            
              SELECT COUNT(*) INTO STRICT l_contar FROM DAVID.ACAD_ALUMNO_CONTRATO 
              WHERE ID_PLANPAGO_SEMESTRE IN (
                SELECT ID_PLANPAGO_SEMESTRE FROM MAT_PLANPAGO_SEMESTRE WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa_des
              );
              IF l_contar>0 then
                l_error:=1; --descuadre de asiento
                l_msgerror:='Esta asociado a alumno contrato';
                exit when l_contar>0;
              END IF;

              DELETE FROM MAT_PLANPAGO_SEMESTRE_DET WHERE ID_PLANPAGO_SEMESTRE in (
                SELECT  ID_PLANPAGO_SEMESTRE FROM MAT_PLANPAGO_SEMESTRE WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa_des
              );

              
              DELETE FROM MAT_PLANPAGO_SEMESTRE WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa_des;

              
             
            END IF;
            
            FOR cur in curcri LOOP
              BEGIN
              
                SELECT COUNT(*) INTO STRICT l_contar FROM MAT_PLANPAGO_SEMESTRE
                WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa_des
                AND ID_PLANPAGO=CUR.ID_PLANPAGO;

                IF l_contar=0 THEN
                  INSERT INTO MAT_PLANPAGO_SEMESTRE(
                    ID_PLANPAGO_SEMESTRE,
                    ID_PLANPAGO,
                    ID_SEMESTRE_PROGRAMA,
                    ESTADO
                  )values (
                    0,
                    cur.ID_PLANPAGO,
                    l_id_semestre_programa_des,
                    '1'
                  ) RETURNING ID_PLANPAGO_SEMESTRE INTO l_id_criterio_semestre;
                ELSE
                  SELECT ID_PLANPAGO_SEMESTRE INTO STRICT l_id_criterio_semestre FROM MAT_PLANPAGO_SEMESTRE
                  WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa_des
                  AND ID_PLANPAGO=CUR.ID_PLANPAGO;
                END IF;

                DELETE FROM MAT_PLANPAGO_SEMESTRE_DET WHERE ID_PLANPAGO_SEMESTRE=l_id_criterio_semestre;

                              
                insert into MAT_PLANPAGO_SEMESTRE_DET(
                  ID_PLANPAGO_SEMESTRE_DET,
                  ID_PLANPAGO_SEMESTRE,
                  FECHA_INICIO,
                  FECHA_FIN,
                  ORDEN,
                  EJECUTADO,
                  CICLO
                )
                SELECT 
                  0,
                  ID_PLANPAGO_SEMESTRE,
                  FECHA_INICIO,
                  FECHA_FIN,
                  ORDEN,
                  EJECUTADO,
                  CICLO
                FROM MAT_PLANPAGO_SEMESTRE_DET
                WHERE ID_PLANPAGO_SEMESTRE = cur.ID_PLANPAGO_SEMESTRE;

              END;
            END LOOP;

         
            PP_ID_SEMESTRE_PROGRAMA_DES := substr(PP_ID_SEMESTRE_PROGRAMA_DES, l_1+1 );
        END LOOP;

  
      
      
      P_ERROR:=l_error;
      P_MSGERROR:= l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_copiar_planpago_semestre (P_ID_SEMESTRE_PROGRAMA_ORI bigint, P_ID_SEMESTRE_PROGRAMA_DES text, P_INDICADOR text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
