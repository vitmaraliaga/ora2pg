-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_resi_alimentacion_mat (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';

    l_id_resid_tipo_habitacion bigint;
    l_id_criterio bigint;
    l_importe decimal(10,2);
    l_dc varchar(5);
    l_dias decimal(10,2);
    l_nombre varchar(150);
    l_tipo_valor varchar(2);
    l_id_semestre_programa bigint;
    l_total decimal(10,2);
    l_cuotas decimal(10,2);

BEGIN
    SELECT a.ID_SEMESTRE_PROGRAMA, C.CUOTAS,coalesce(a.DIAS_RESIDENCIA,0),coalesce(a.ID_RESID_TIPO_HABITACION,0)
    INTO STRICT l_id_semestre_programa,l_cuotas,l_dias,l_id_resid_tipo_habitacion
    FROM DAVID.ACAD_ALUMNO_CONTRATO A, MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
    WHERE A.ID_PLANPAGO_SEMESTRE=B.ID_PLANPAGO_SEMESTRE
    AND B.ID_PLANPAGO=C.ID_PLANPAGO
    AND ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

    if l_cuotas=1  then
      l_error:=0;
      l_msgerror:='';
--       goto resi_resi_mat;
    end if;

    if l_id_resid_tipo_habitacion >0 then
      SELECT 
        ID_CRITERIO,
        IMPORTE,
        DC,
        NOMBRE,
        TIPO_VALOR
        INTO STRICT
        l_id_criterio,
        l_importe,
        l_dc,
        l_nombre,
        l_tipo_valor
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

      SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
         WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

         --l_total:=(l_importe*l_dias)/2;
         l_total:= (l_importe*l_dias)*0.2;

         insert into MAT_CONCEPTO_ASIGN_ALUM(
          ID_ALUMNO_CONTRATO,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          CANTIDAD,
          UNITARIO,
          TOTAL,
          TIPO_VALOR
          )VALUES (
          P_ID_ALUMNO_CONTRATO,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nombre||' '||l_dias::text||' dias',
          l_dc,
          l_dias,
          l_importe,
          l_total,
          l_tipo_valor
      );

    end if;
--     <<resi_resi_mat>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_resi_alimentacion_mat (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
