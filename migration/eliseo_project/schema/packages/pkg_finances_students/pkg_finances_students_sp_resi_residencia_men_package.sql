-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_resi_residencia_men (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_semestre_programa bigint;
    l_id_persona bigint;

    l_id_criterio	bigint;
    l_importe	decimal(10,2);
    l_tipo_proceso	varchar(2);
    l_tipo_valor	varchar(2);
    l_id_resid_tipo_habitacion bigint;
    l_id_semestre bigint;
    l_nombre varchar(150);
    l_dc varchar(1);
    l_desde timestamp(0);
    l_hasta timestamp(0);
    l_dias decimal(10,2);
    l_id_plan_programa bigint;
    l_total decimal(10,2);
    l_cuotas decimal(10,2);

BEGIN
  
     SELECT a.ID_SEMESTRE_PROGRAMA,a.ID_PERSONA,a.ID_PLAN_PROGRAMA, C.CUOTAS
    INTO STRICT l_id_semestre_programa,l_id_persona,l_id_plan_programa,l_cuotas
    FROM DAVID.ACAD_ALUMNO_CONTRATO A, MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
    WHERE A.ID_PLANPAGO_SEMESTRE=B.ID_PLANPAGO_SEMESTRE
    AND B.ID_PLANPAGO=C.ID_PLANPAGO
    AND ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

    
    SELECT ID_SEMESTRE INTO STRICT l_id_semestre FROM DAVID.ACAD_SEMESTRE_PROGRAMA WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa;

    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC
      INTO STRICT
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

    
     
    select COUNT(*) INTO STRICT l_contar
    from DAVID.Acad_Reserva_Residencia arr
    inner join DAVID.residencia_habitacion rh on Rh.Id_Habitacion=Arr.Id_Habitacion
    inner join DAVID.Residencia_Bloque rb on Rb.Id_Bloque=Rh.Id_Bloque
    inner join DAVID.residencia_tipo_habitacion rth on Rth.Id_Residencia=Rb.Id_Residencia and Rth.Id_Resid_Tipo_Habitacion=Rh.Id_Resid_Tipo_Habitacion  and Rth.Estado='1'
    WHERE rth.ID_CRITERIO=l_id_criterio
    AND arr.ID_SEMESTRE=l_id_semestre
    AND arr.ID_PERSONA=l_id_persona
    and arr.ID_PLAN_PROGRAMA=l_id_plan_programa
    AND arr.ESTADO='6';

 
    IF l_contar>0 THEN
      if l_contar=1 then
      
        SELECT rth.nombre,rth.ID_RESID_TIPO_HABITACION ,arr.fecha_inicio,arr.fecha_fin
        INTO STRICT l_nombre,l_id_resid_tipo_habitacion,l_desde,l_hasta
        from DAVID.Acad_Reserva_Residencia arr
        inner join DAVID.residencia_habitacion rh on Rh.Id_Habitacion=Arr.Id_Habitacion
        inner join DAVID.Residencia_Bloque rb on Rb.Id_Bloque=Rh.Id_Bloque
        inner join DAVID.residencia_tipo_habitacion rth on Rth.Id_Residencia=Rb.Id_Residencia and Rth.Id_Resid_Tipo_Habitacion=Rh.Id_Resid_Tipo_Habitacion  and Rth.Estado='1'
        WHERE rth.ID_CRITERIO=l_id_criterio
        AND arr.ID_SEMESTRE=l_id_semestre
        AND arr.ID_PERSONA=l_id_persona
        and arr.ID_PLAN_PROGRAMA=l_id_plan_programa
        AND arr.ESTADO='6';

  
        /*--lo va tomar de la tabla DAVID.Acad_Reserva_Residencia
        SELECT MIN(C.FECHA_INICIO) AS FECHA_INICIO,MAX(C.FECHA_FIN) AS FECHA_FIN into l_desde,l_hasta
        FROM VW_MAT_CURSOS_PLAN_ALUMNO A, DAVID.ACAD_CARGA_CURSO_DOCENTE B,DAVID.ACAD_MODULO_DETALLE C
        WHERE A.ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO
        AND A.ID_CARGA_CURSO=B.ID_CARGA_CURSO
        AND B.ID_MODULO_DETALLE=C.ID_MODULO_DETALLE;
        */
        
        
        if coalesce(l_desde::text, '') = '' or coalesce(l_hasta::text, '') = '' then
          l_error:=1;
          l_msgerror:='Falta asignar fecha desde o hasta de permanencia en la residencia';
--           goto resi_residencia;
        end if;

         if l_desde > l_hasta then
          l_error:=1;
          l_msgerror:='Fecha desde es mayor a la fecha hasta de permanencia en la residencia';
--           goto resi_residencia;
        end if;

        --select coalesce(sum((l_hasta -  l_desde)+1),0)+9 into  l_dias  from dual; 
        select coalesce(sum((l_hasta -  l_desde)+1),0) into STRICT  l_dias;
        
         SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
         WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

         if l_cuotas=1 then
          l_total:= (l_importe*l_dias);
         else
          --l_total:= (l_importe*l_dias)/2;
          l_total:= (l_importe*l_dias)*0.8;
         end if;

         insert into MAT_CONCEPTO_ASIGN_ALUM(
          ID_ALUMNO_CONTRATO,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          CANTIDAD,
          UNITARIO,
          TOTAL,
          TIPO_VALOR
          )VALUES (
          P_ID_ALUMNO_CONTRATO,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nombre||'. '||TO_CHAR(l_desde,'DD/MM/YYYY')||'-'||TO_CHAR(l_hasta,'DD/MM/YYYY')||' '||l_dias::text||' dias' ,
          l_dc,
          l_dias,
          l_importe,
          l_total,
          l_tipo_valor
          );

          update DAVID.ACAD_ALUMNO_CONTRATO SET 
          ID_RESID_TIPO_HABITACION= l_id_resid_tipo_habitacion ,
          DIAS_RESIDENCIA=l_dias
          WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;
          
      else
        l_error:=1;
        l_msgerror:='Mas de una residencia Reservada';
      end if;

     END IF;

--     <<resi_residencia>>
    
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_resi_residencia_men (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
