-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_ins_cuota_alumno (P_ID_ALUMNO_CONTRATO bigint,P_ID_USER bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;
    l_cuotas decimal(10,2);
    l_imp_cuota1 decimal(10,2);
    l_imp_cuota2 decimal(10,2);
    l_imp_cuota decimal(10,2);
    l_codigo_mod varchar(10);
    l_id_planpago_semestre bigint;
    l_id_matricula_detalle bigint;
    l_creditosvar decimal(10,2);
    l_tipo_alumno varchar(5);
    l_conmat1cuota varchar(5);
    l_ciclo bigint;
    l_id_semestre_programa bigint;
    l_plan_pago_ciclo varchar(5):='N';

BEGIN
    
      SELECT C.CUOTAS,COALESCE(A.CREDITOSVAR,0),tipo_alumno,B.ID_PLANPAGO_SEMESTRE,A.id_matricula_detalle, coalesce(c.conmat1cuota,'N'),coalesce(a.ciclo,0) as ciclo, a.id_semestre_programa
      INTO STRICT l_cuotas,l_creditosvar,l_tipo_alumno,l_id_planpago_semestre,l_id_matricula_detalle,l_conmat1cuota,l_ciclo,l_id_semestre_programa
      FROM DAVID.ACAD_ALUMNO_CONTRATO A, MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
      WHERE A.ID_PLANPAGO_SEMESTRE=B.ID_PLANPAGO_SEMESTRE
      AND B.ID_PLANPAGO=C.ID_PLANPAGO
      AND A.ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

      IF l_cuotas<>1 THEN
      
        delete from MAT_ALUMNO_CONTRATO_CUOTA where ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

         select coalesce(plan_pago_ciclo,'N') into STRICT l_plan_pago_ciclo from david.acad_semestre_programa where id_semestre_programa=l_id_semestre_programa;

        
        select B.CODIGO INTO STRICT l_codigo_mod FROM DAVID.ACAD_MATRICULA_DETALLE A, DAVID.MODO_CONTRATO B
        WHERE A.ID_MODO_CONTRATO=B.ID_MODO_CONTRATO
        AND A.id_matricula_detalle=l_id_matricula_detalle;
        select
           COALESCE(SUM((CASE WHEN x.DC='C' THEN -1 ELSE 1 END)*( x.IMPORTE)),0)/l_cuotas
           into STRICT l_imp_cuota1
          from (SELECT
            a.importe,
            b.tipo_cobro,
            case when l_codigo_mod = 'V' and l_creditosvar<0 then  
              case when a.dc='D' then 'C' else 'D' end
            else 
              a.dc
            end as DC
          from mat_alumno_contrato_det a,vw_mat_criterio_semestre b 
          where a.id_criterio_semestre=b.id_criterio_semestre
          and a.id_alumno_contrato=P_ID_ALUMNO_CONTRATO
          and b.TIPO_COBRO='M'
          AND B.TIENE_HIJO=0
          and B.RESI_MEN=0
        )x;

        select
           COALESCE(SUM((CASE WHEN x.DC='C' THEN -1 ELSE 1 END)*( x.IMPORTE)),0)/(l_cuotas-1) 
           into STRICT l_imp_cuota2
          from (SELECT 
            a.importe,
            b.tipo_cobro,
            case when l_codigo_mod = 'V' and l_creditosvar<0 then  
              case when a.dc='D' then 'C' else 'D' end
            else 
              a.dc
            end as DC
          from mat_alumno_contrato_det a,vw_mat_criterio_semestre b 
          where a.id_criterio_semestre=b.id_criterio_semestre
          and a.id_alumno_contrato=P_ID_ALUMNO_CONTRATO
          and b.TIPO_COBRO='M'
          AND B.TIENE_HIJO=0
          and B.RESI_MEN=1
        )x;
        l_imp_cuota:=l_imp_cuota1 + l_imp_cuota2;
        if l_imp_cuota<>0 then
          insert into MAT_ALUMNO_CONTRATO_CUOTA(
          ID_ITEM,
          ID_ALUMNO_CONTRATO,
          ID_PLANPAGO_SEMESTRE_DET,
          FECHA,
          IMPORTE,
          EJECUTADO,
          ID_USER_REG,
          FECHA_REG
          )
          SELECT
          orden,
          P_ID_ALUMNO_CONTRATO,
          id_planpago_semestre_det,
          fecha_inicio,
          l_imp_cuota,
          'N',--case when orden = 1 and l_conmat1cuota='S' then 'S' else 'N' end,
          P_ID_USER,
          clock_timestamp()
          from MAT_PLANPAGO_SEMESTRE_DET
          where id_planpago_semestre=l_id_planpago_semestre 
          and case when l_plan_pago_ciclo='S' then ciclo else 0 end=case when l_plan_pago_ciclo='S' then l_ciclo else 0 end
          order by orden;
        end if;
      END IF;
      P_ERROR:=l_error;
      P_MSGERROR:= l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_ins_cuota_alumno (P_ID_ALUMNO_CONTRATO bigint,P_ID_USER bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
