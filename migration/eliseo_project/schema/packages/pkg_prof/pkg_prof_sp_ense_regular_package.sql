-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_prof,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_prof_sp_ense_regular (P_ID_PROFORMA bigint,P_ID_CRITERIO_SEMESTRE bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_semestre_programa bigint;
    l_id_persona bigint;

    l_id_criterio	bigint;
    l_importe	decimal(10,2);
    l_tipo_proceso	varchar(2);
    l_tipo_valor	varchar(2);
    l_nombre varchar(150);
    l_id_plan bigint;
    l_dc varchar(1);
    l_creditos decimal(10,2);
    l_costo  decimal(10,2);
    l_id_postulante bigint;
    l_ciclo bigint;

BEGIN
  
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,a.ciclo,a.creditos
    INTO STRICT l_id_persona,l_id_semestre_programa,l_id_postulante,l_ciclo,l_creditos
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;

    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE
      INTO STRICT
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nombre
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

    
   select count(1) into STRICT l_contar from DAVID.VW_ACAD_CARGA_ACADEMICA where ID_SEMESTRE_PROGRAMA=l_id_semestre_programa  and ciclo=l_ciclo;
   if l_contar=0 then
      l_error:=1;
      l_msgerror:='No existe plan';
--       goto salida_proc;
   end if;

   select id_plan INTO STRICT l_id_plan from DAVID.VW_ACAD_CARGA_ACADEMICA where ID_SEMESTRE_PROGRAMA=l_id_semestre_programa  and ciclo=l_ciclo group by id_plan;
    
    
    SELECT COUNT(*) INTO STRICT l_contar  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio;

    if l_items=0 then
      l_error:=1;
      l_msgerror:='No esta asignado costo de enseñanza';
--       goto salida_proc;
    end if;


    SELECT  COUNT(*) INTO STRICT l_contar  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio;

    if l_contar=0 then
      l_error:=1;
      l_msgerror:='Falta asignar costo de enseñanza';
--       goto salida_proc;
    end if;

    SELECT COUNT(*) INTO STRICT l_contar  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio
    AND coalesce(a.IMPORTE,0)<=0;

    if l_contar>0 then
      l_error:=1;
      l_msgerror:='Falta asignar costo de enseñanza para algunos planes, importe cero';
--       goto salida_proc;
    end if;

     SELECT  coalesce(IMPORTE,0) into STRICT  l_costo  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio;

    SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM PRO_CONCEPTO_ASIGN_ALUM
      WHERE ID_PROFORMA=P_ID_PROFORMA;

    
    
    insert into PRO_CONCEPTO_ASIGN_ALUM(
      ID_PROFORMA,
      ID_CRITERIO_SEMESTRE,
      ITEM,
      ID_SEMESTRE_PROGRAMA,
      DESCRIPCION,
      DC,
      CANTIDAD,
      UNITARIO,
      TOTAL,
      TIPO_VALOR,
      ID_PLAN
     )VALUES (
    P_ID_PROFORMA,
    P_ID_CRITERIO_SEMESTRE,
    l_items, 
    l_id_semestre_programa,
    l_nombre,
    l_dc,
    l_creditos,
    l_costo,
    l_creditos*l_costo,
    l_tipo_valor,
    l_id_plan
    );

--     <<salida_proc>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_prof_sp_ense_regular (P_ID_PROFORMA bigint,P_ID_CRITERIO_SEMESTRE bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
