-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_prof,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_prof_sp_desctos_alum_proforma (P_ID_PROFORMA bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_id_semestre_programa bigint;


    l_importe	decimal(10,2);
    l_formula	varchar(4000);
    l_tipo_proceso	varchar(2);

    l_codigo varchar(15);
    l_dc varchar(2);
    l_items bigint:=0;
    l_items_padre bigint:=0;
    l_nombre varchar(150);
    l_tipo_valor varchar(2);

    l_id_criterio	bigint;
    l_numhijo	bigint;
    l_tipo_alumno varchar(5):='RE';

    curDES CURSOR FOR
    SELECT
      A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      A.IMPORTE,
      A.FORMULA,
      A.TIPO_PROCESO,
      A.TIPO_VALOR,
      A.DC,
      A.NOMBRE,
      A.ORDEN,
      coalesce(a.ID_PROCEDURE_PRO,a.ID_PROCEDURE_PRO_CRI) as ID_PROCEDURE_PRO
    FROM VW_MAT_CRITERIO_SEMESTRE A
    WHERE  A.DC='C'
    AND A.ESTADO='1'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND A.TIPO_ALUMNO=l_tipo_alumno
    AND COALESCE(A.PROFORMA,0)=1
    AND COALESCE(A.PROFORMA_MANUAL,0)=0
    AND A.ID_AFECTA IN (
      SELECT
            X.ID_CRITERIO
            FROM VW_MAT_CRITERIO_SEMESTRE X, PRO_CONCEPTO_ASIGN_ALUM Z
            WHERE X.ID_CRITERIO_SEMESTRE=Z.ID_CRITERIO_SEMESTRE
            AND X.DC='D'
            AND X.ESTADO='1'
            AND X.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
            AND Z.ID_PROFORMA=P_ID_PROFORMA
            AND COALESCE(X.PROFORMA,0)=1 
    ) 
    
UNION

    SELECT
      A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      A.IMPORTE,
      A.FORMULA,
      A.TIPO_PROCESO,
      A.TIPO_VALOR,
      A.DC,
      A.NOMBRE,
      A.ORDEN,
      coalesce(a.ID_PROCEDURE_PRO,a.ID_PROCEDURE_PRO_CRI) as ID_PROCEDURE_PRO
    FROM VW_MAT_CRITERIO_SEMESTRE A
    WHERE  A.DC='C'
    AND A.ESTADO='1'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND A.TIPO_ALUMNO=l_tipo_alumno
    --AND COALESCE(A.PROFORMA,0)=1
    AND A.ID_CRITERIO_SEMESTRE IN (
      SELECT ID_CRITERIO_SEMESTRE FROM PRO_PROFORMA_CRITERIO
      WHERE ID_PROFORMA=P_ID_PROFORMA
    )
    AND A.ID_AFECTA IN (
      SELECT
            X.ID_CRITERIO
            FROM VW_MAT_CRITERIO_SEMESTRE X, PRO_CONCEPTO_ASIGN_ALUM Z
            WHERE X.ID_CRITERIO_SEMESTRE=Z.ID_CRITERIO_SEMESTRE
            AND X.DC='D'
            AND X.ESTADO='1'
            AND X.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
            AND Z.ID_PROFORMA=P_ID_PROFORMA
            AND COALESCE(X.PROFORMA,0)=1 
    ) 
    ORDER BY DC DESC,ORDEN;

 
    l_total decimal(10,2);
    l_total_hijo decimal(10,2);

    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';

    l_id_persona bigint;
    l_orden bigint;
    l_id_postulante bigint;


BEGIN
  
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE
    INTO STRICT l_id_persona,l_id_semestre_programa,l_id_postulante
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;

    
    FOR cur in curDES LOOP
      BEGIN
        l_total:= 0;
        CASE
        WHEN cur.tipo_proceso = 'PF' OR cur.tipo_proceso = 'P'  THEN
        
          l_formula:= CUR.formula;
           if cur.ID_PROCEDURE_PRO>0 then
            select nombre into STRICT l_formula from eliseo.mat_procedure where id_procedure=cur.ID_PROCEDURE_PRO;
           end if;

          EXECUTE 'BEGIN PKG_PROF.'||l_formula||'(:P_ID_PROFORMA,:P_ID_CRITERIO_SEMESTRE,:l_error,:l_msgerror);end;'
          --INTO l_error,l_msgerror
          USING P_ID_PROFORMA,cur.id_criterio_semestre,IN OUT l_error,IN OUT l_msgerror;


          
          if l_error=1 then
             Exit when l_error=1;
          end if;
        WHEN cur.tipo_proceso = 'F' then
           SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM PRO_CONCEPTO_ASIGN_ALUM
           WHERE ID_PROFORMA=P_ID_PROFORMA;

           insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES (
            P_ID_PROFORMA,
            CUR.id_criterio_semestre,
            l_items,
            l_id_semestre_programa,
            CUR.nombre,
            CUR.dc,
            CUR.importe,
            CUR.tipo_valor
            );
        WHEN coalesce(cur.tipo_proceso::text, '') = '' THEN

           SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM PRO_CONCEPTO_ASIGN_ALUM
           WHERE ID_PROFORMA=P_ID_PROFORMA;

           insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES (
            P_ID_PROFORMA,
            cur.id_criterio_semestre,
            l_items,
            l_id_semestre_programa,
            cur.nombre,
            cur.dc,
            NULL,
            cur.tipo_valor
            );

        END CASE;
      END;
    END LOOP;

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_prof_sp_desctos_alum_proforma (P_ID_PROFORMA bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
