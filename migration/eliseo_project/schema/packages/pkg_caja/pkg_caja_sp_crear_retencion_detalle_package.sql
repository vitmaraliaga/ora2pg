-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_crear_retencion_detalle (P_ID_RETENCION bigint,P_ID_COMPRA bigint,P_ID_DINAMICA bigint,P_IMPORTE_TOTAL bigint,P_IMPORTE_RET bigint,P_IMPORTE_RET_ME bigint, P_ID_RETDETALLE INOUT bigint, P_ERROR out bigint, P_MSGERROR out text) AS $body$
DECLARE

        l_id_retdetalle bigint;
        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_importe_me decimal(10,2);
        L_DETALLE varchar(100);
        L_ID_COMPRA bigint;
        L_ID_SALDO bigint;
        L_ID_PROVEEDOR bigint;

        
BEGIN
            l_error:=0;

            if l_error=0 then
                 IF P_ID_RETDETALLE <> 0 then  -- Update
                    UPDATE CAJA_RETENCION_COMPRA
                    SET
                    IMPORTE_TOTAL = P_IMPORTE_TOTAL,
                    IMPORTE_RET = P_IMPORTE_RET,
                    IMPORTE_RET_ME = P_IMPORTE_RET_ME
                    WHERE ID_RETDETALLE=P_ID_RETDETALLE;
                    l_msgerror:='Pago OK';
                    l_id_retdetalle := P_ID_RETDETALLE;
                 ELSE
                    --SELECT coalesce(max(ID_RETDETALLE),0)+1 into l_id_retdetalle FROM CAJA_RETENCION_COMPRA;
     
                    IF coalesce(P_IMPORTE_RET,0)+coalesce(P_IMPORTE_RET_ME,0) > 0 THEN
                    
                        SELECT
                                ID_PROVEEDOR,ID_ENTIDAD||'-'||ID_DEPTO||'-Ret:'||SERIE||'-'||NRO_RETENCION||'-'||SUBSTR(FC_NOMBRE_PERSONA(ID_PROVEEDOR),1,20)||'-'||TO_CHAR(FECHA_EMISION,'DD/MM/YYYY') INTO STRICT L_ID_PROVEEDOR,L_DETALLE
                        FROM CAJA_RETENCION
                        WHERE ID_RETENCION = P_ID_RETENCION;

                        SELECT COUNT(1) INTO STRICT l_contar FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA AND ID_PROVEEDOR = L_ID_PROVEEDOR;

                        IF l_contar > 0 THEN
                            L_ID_COMPRA := P_ID_COMPRA;
                            L_ID_SALDO := NULL;
                        ELSE
                            L_ID_COMPRA := NULL;
                            L_ID_SALDO := P_ID_COMPRA;
                        END IF;

                        INSERT INTO CAJA_RETENCION_COMPRA(
                        --ID_RETDETALLE,
                        ID_RETENCION,
                        ID_COMPRA,
                        ID_DINAMICA,
                        IMPORTE_TOTAL,
                        IMPORTE_RET,
                        IMPORTE_RET_ME,
                        DETALLE,
                        ESTADO,
                        ID_SALDO
                        )values (
                        --l_id_retdetalle,
                        P_ID_RETENCION,
                        L_ID_COMPRA,
                        P_ID_DINAMICA,
                        P_IMPORTE_TOTAL,
                        P_IMPORTE_RET,
                        P_IMPORTE_RET_ME,
                        L_DETALLE,
                        '1',
                        L_ID_SALDO
                        ) RETURNING ID_RETDETALLE INTO l_id_retdetalle;
                        l_msgerror:='Pago OK';
                    ELSE
                        l_error := 1;
                        l_msgerror:='No existen Importes';
                    END IF;
                END IF;
            end if;

        P_ERROR:=l_error;
        P_ID_RETDETALLE := l_id_retdetalle;
        P_MSGERROR:=l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_crear_retencion_detalle (P_ID_RETENCION bigint,P_ID_COMPRA bigint,P_ID_DINAMICA bigint,P_IMPORTE_TOTAL bigint,P_IMPORTE_RET bigint,P_IMPORTE_RET_ME bigint, P_ID_RETDETALLE INOUT bigint, P_ERROR out bigint, P_MSGERROR out text) FROM PUBLIC;
