-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_generar_asiento_gasto (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

    l_id_entidad              bigint;
    l_id_detpo                varchar(10);
    l_dinamica                bigint;
    l_id_persona              bigint;
    l_detalle                 varchar(200);
    l_importe                 decimal(10,2);
    l_importe_me              decimal(10,2);
    l_correlativo             decimal(10,2);
    l_id_asiento              bigint;
    l_id_tipoplan             bigint;
    l_id_restriccion          varchar(50);
    l_id_cuentaaasi           varchar(10);
    l_dc                      varchar(1);
    l_depto                   varchar(10);
    l_cuenta_cte              varchar(50);
    l_descripcion             varchar(255);
    l_memo                    varchar(255);
    l_voucher                 varchar(10);
    l_error                   bigint := 0;
    l_msgerror                varchar(200) := '';
    l_agrupa                  varchar(1);
    l_id_ctabancaria          bigint;
    l_id_mediopago            varchar(4);
    l_pgasto                  bigint;
    l_tipoorigen              bigint;
    l_fondo                   bigint;
    l_importe_t               decimal(10,2);
    l_pago                    varchar(10);
    l_fecha                   varchar(10);
    l_numero                  varchar(10);
    ES_VALE bigint;
    L_ID_VALE bigint;
    L_GLOSA varchar(200);

    casi CURSOR FOR
        SELECT 
                B.ID_PGASTO,B.ID_TIPOORIGEN, 1 AS ID_TIPOPLAN,A.ID_RESTRICCION,A.ID_CUENTAAASI,A.ID_CTACTE,A.ID_DEPTO,A.DC,B.DETALLE,A.IMPORTE,A.IMPORTE_ME,A.AGRUPA,A.ID_FONDO
        FROM CAJA_PAGO_GASTO_ASIENTO A JOIN CAJA_PAGO_GASTO B
        ON A.ID_PGASTO = B.ID_PGASTO
        WHERE B.ID_PAGO = P_ID_PAGO
        AND coalesce(B.ID_DINAMICA::text, '') = '';

BEGIN
        SELECT ID_ENTIDAD,ID_DEPTO,ID_CTABANCARIA,ID_VOUCHER,ID_MEDIOPAGO,IMPORTE,CASE WHEN ID_MEDIOPAGO='001' THEN 'TLC' WHEN ID_MEDIOPAGO='007' THEN 'CHQ' WHEN ID_MEDIOPAGO='008' THEN 'EFEC' WHEN ID_MEDIOPAGO='999' THEN 'REND' END  AS PAGO,TO_CHAR(FECHA,'DD/MM/YY') AS FECHA,NUMERO
            INTO STRICT l_id_entidad,l_id_detpo,l_id_ctabancaria,l_voucher,l_id_mediopago,l_importe_t,l_pago,l_fecha,l_numero
        FROM CAJA_PAGO
        WHERE ID_PAGO = P_ID_PAGO;

        SELECT COUNT(ID_VALE) INTO STRICT ES_VALE FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
        IF ES_VALE > 0 THEN
            SELECT ID_VALE INTO STRICT L_ID_VALE
            FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;

            SELECT ID_ENTIDAD||'-'||ID_DEPTO||'-[Vale :'||NRO_VALE||']-Rendicion-'||FC_NOMBRE_PERSONA(ID_EMPLEADO) INTO STRICT L_GLOSA
            FROM CAJA_VALE WHERE ID_VALE = L_ID_VALE;
        END IF;

        OPEN casi;
            FETCH casi INTO l_pgasto,l_tipoorigen,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_cuenta_cte,l_depto,l_dc,l_descripcion,l_importe,l_importe_me,l_agrupa,l_fondo;

                WHILE casi%FOUND LOOP

                    IF l_id_entidad = 7124 THEN
                        l_detalle := l_descripcion;
                    ELSE
                        l_detalle := SUBSTR(l_id_entidad|| '-'|| l_correlativo|| '-'|| l_descripcion|| '-'|| SUBSTR(FC_NOMBRE_PERSONA(l_id_persona), 1, 100),1,50);
                    END IF;

                    IF l_importe <> 0 THEN
                        --GASTOS DEBITOS
                        INSERT INTO CONTA_ASIENTO(ID_TIPOORIGEN,
                                                   ID_ORIGEN,
                                                   FONDO,
                                                   DEPTO,
                                                   CUENTA,
                                                   CUENTA_CTE,
                                                   RESTRICCION,
                                                   IMPORTE,
                                                   DESCRIPCION,
                                                   MEMO,
                                                   VOUCHER,
                                                   PARENT_ID,
                                                   REF_ID,
                                                   AGRUPA,
                                                   IMPORTE_ME)
                        VALUES (l_tipoorigen,
                                l_pgasto,
                                l_fondo,
                                l_depto,
                                l_id_cuentaaasi,
                                l_cuenta_cte,
                                l_id_restriccion,
                                l_importe,
                                l_detalle,
                                l_memo,
                                l_voucher,
                                NULL,
                                '',
                                l_agrupa,
                                l_importe_me);
                        -- contra partida CREDITOS
                        IF ES_VALE > 0 THEN 
                            SELECT B.CUENTA,CUENTA_CTE INTO STRICT l_id_cuentaaasi,l_cuenta_cte
                            FROM CAJA_VALE A JOIN CONTA_ASIENTO B ON A.ID_TIPOORIGEN = B.ID_TIPOORIGEN 
                            AND A.ID_VALE = B.ID_ORIGEN AND A.ID_VOUCHER = B.VOUCHER 
                            WHERE A.ID_VALE = L_ID_VALE
                            AND B.IMPORTE > 0;

                            l_agrupa := 'S';
                            l_detalle := L_GLOSA;
                        ELSE
                            SELECT ID_CUENTAAASI,ID_TIPOCTACTE into STRICT l_id_cuentaaasi,l_cuenta_cte FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;

                            IF l_agrupa = 'S' THEN
                                l_detalle := SUBSTR(l_id_entidad||'-'||l_id_detpo||'-'||l_pago||':'||l_numero||':'||l_fecha, 1,50);
                            ELSE
                                l_detalle := l_descripcion;
                            END IF;
                        END IF;

                        --l_id_cuentaaasi := '1112001';
                        if l_id_entidad = 7124 and l_id_detpo = '1' then
                            l_depto := '11010101';
                        elsif l_id_entidad = 7124 and l_id_detpo = '3' then
                            l_depto := '31010101';
                        elsif l_id_entidad = 7124 and l_id_detpo = '4' then
                            l_depto := '41010101';
                        elsif l_id_entidad = 7124 and l_id_detpo = '5' then
                            l_depto := '51010101';
                        elsif l_id_entidad = 7124 and l_id_detpo = '6' then
                            l_depto := '61010101';
                        elsif l_id_entidad = 7124 and l_id_detpo = '7' then
                            l_depto := '71010101';
                        elsif l_id_entidad = 7124 and l_id_detpo = '8' then
                            l_depto := '81010101';
                        else
                            l_depto := '131111';
                        end if;

                        l_id_restriccion := '0A';
                        INSERT INTO CONTA_ASIENTO(ID_TIPOORIGEN,
                                                   ID_ORIGEN,
                                                   FONDO,
                                                   DEPTO,
                                                   CUENTA,
                                                   CUENTA_CTE,
                                                   RESTRICCION,
                                                   IMPORTE,
                                                   DESCRIPCION,
                                                   MEMO,
                                                   VOUCHER,
                                                   PARENT_ID,
                                                   REF_ID,
                                                   AGRUPA,
                                                   IMPORTE_ME)
                                        VALUES (l_tipoorigen,
                                                l_pgasto,
                                                l_fondo,
                                                l_depto,
                                                l_id_cuentaaasi,
                                                l_cuenta_cte,
                                                l_id_restriccion,
                                                l_importe*-1,
                                                l_detalle,
                                                l_memo,
                                                l_voucher,
                                                NULL,
                                                '',
                                                l_agrupa,
                                                l_importe_me);
                    END IF;
                    FETCH casi INTO l_pgasto,l_tipoorigen,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_cuenta_cte,l_depto,l_dc,l_descripcion,l_importe,l_importe_me,l_agrupa,l_fondo;
                END LOOP;
        CLOSE casi;

    P_ERROR := 0;
    P_MSGERROR := 'OK';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_generar_asiento_gasto (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
