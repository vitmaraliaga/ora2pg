-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_crear_retencion (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_MEDIOPAGO text,P_ID_VOUCHER bigint,P_ID_PERSONA bigint,P_ID_PROVEEDOR bigint,P_ID_CTABANCARIA bigint,P_ID_CHEQUERA bigint,P_ID_ANHO bigint, P_ID_MES bigint,P_ID_MONEDA bigint,P_NUMERO text,P_FECHA_EMISION timestamp(0),P_SERIE text,P_NRO_RETENCION text,P_ID_RETENCION INOUT bigint,P_ERROR out bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_retencion bigint:=0;
        l_estado varchar(1):='0'; --1:vigente, 0:anulado
        L_ID_CTABANCARIA bigint := null;
        L_ID_CHEQUERA bigint :=null;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        L_FECHA timestamp(0);

BEGIN
            IF LENGTH(P_SERIE) > 4 THEN 
                    l_error := 1;
                    l_msgerror := 'La série de la retención debe contener solo 4 caracteres';
            END IF;
            IF LENGTH(P_NRO_RETENCION) > 8 THEN
                    l_error := 1;
                    l_msgerror := 'El número de la retención debe contener solo 8 caracteres';
            END IF;

            if l_error=0 then
      
                -- SELECT coalesce(max(ID_RETENCION),0)+1 into l_retencion FROM CAJA_RETENCION;
        
                IF coalesce(P_ID_CTABANCARIA::text, '') = '' OR P_ID_CTABANCARIA = 0 THEN
                    L_ID_CTABANCARIA:=null;
                ELSE
                    L_ID_CTABANCARIA:=P_ID_CTABANCARIA;
                END IF;
                IF coalesce(P_ID_CHEQUERA::text, '') = '' OR P_ID_CHEQUERA = 0 THEN
                    L_ID_CHEQUERA:=null;
                ELSE
                    L_ID_CHEQUERA:=P_ID_CHEQUERA;
                END IF;
                IF coalesce(P_FECHA_EMISION::text, '') = '' THEN
                    L_FECHA := NULL;
                ELSE
                    L_FECHA := P_FECHA_EMISION;
                END IF;

                IF P_ID_RETENCION <> 0 THEN  -- Editar 
                
                    UPDATE CAJA_RETENCION
                        SET ID_MEDIOPAGO = P_ID_MEDIOPAGO,
                        ID_PROVEEDOR = P_ID_PROVEEDOR,
                        ID_CTABANCARIA = L_ID_CTABANCARIA,
                        ID_CHEQUERA = L_ID_CHEQUERA,
                        ID_ANHO = P_ID_ANHO,
                        ID_MES = P_ID_MES,
                        ID_MONEDA = P_ID_MONEDA,
                        NUMERO = P_NUMERO,
                        FECHA_EMISION = L_FECHA,
                        SERIE = P_SERIE,
                        NRO_RETENCION = P_NRO_RETENCION
                    WHERE ID_RETENCION=P_ID_RETENCION;
                    l_retencion := P_ID_RETENCION;

                ELSE  -- Nuevo
                    
                    INSERT INTO CAJA_RETENCION(
                        -- ID_RETENCION,
                        ID_ENTIDAD,
                        ID_DEPTO,
                        ID_MEDIOPAGO,
                        ID_VOUCHER,
                        ID_PERSONA,
                        ID_PROVEEDOR,
                        ID_CTABANCARIA,
                        ID_CHEQUERA,
                        ID_ANHO,
                        ID_MES,
                        ID_MONEDA,
                        NUMERO,
                        FECHA_EMISION,
                        FECHA,
                        SERIE,
                        NRO_RETENCION,
                        ESTADO
                    )VALUES (
                      -- l_retencion,
                      P_ID_ENTIDAD, 
                      P_ID_DEPTO, 
                      P_ID_MEDIOPAGO,
                      P_ID_VOUCHER, 
                      P_ID_PERSONA, 
                      P_ID_PROVEEDOR, 
                      L_ID_CTABANCARIA,
                      L_ID_CHEQUERA,
                      P_ID_ANHO, 
                      P_ID_MES,  
                      P_ID_MONEDA,
                      P_NUMERO,
                      L_FECHA,
                      clock_timestamp(), 
                      P_SERIE,
                      P_NRO_RETENCION,
                      l_estado
                    ) RETURNING ID_RETENCION INTO l_retencion;
                    l_retencion := l_retencion;
                END IF;
            END IF;
        P_ERROR:=l_error;
        P_ID_RETENCION :=l_retencion;
        --P_MSGERROR:='l_error ss';
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_crear_retencion (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_MEDIOPAGO text,P_ID_VOUCHER bigint,P_ID_PERSONA bigint,P_ID_PROVEEDOR bigint,P_ID_CTABANCARIA bigint,P_ID_CHEQUERA bigint,P_ID_ANHO bigint, P_ID_MES bigint,P_ID_MONEDA bigint,P_NUMERO text,P_FECHA_EMISION timestamp(0),P_SERIE text,P_NRO_RETENCION text,P_ID_RETENCION INOUT bigint,P_ERROR out bigint,P_MSGERROR out text) FROM PUBLIC;
