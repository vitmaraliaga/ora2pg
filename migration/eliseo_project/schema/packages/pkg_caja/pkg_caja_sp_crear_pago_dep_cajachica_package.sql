-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_crear_pago_dep_cajachica (P_ID_ENTIDAD bigint, P_ID_DEPTO text,P_ID_VOUCHER bigint,P_ID_ANHO bigint, P_ID_MES bigint, P_ID_USER bigint, P_ID_TIPOTRANSACCION bigint, P_ID_DINAMICA bigint,P_ID_CTABANCARIA bigint,P_NUMERO text, P_ID_CHEQUERA bigint,P_ID_MONEDA bigint,P_TIPOCAMBIO bigint,P_DETALLE text,P_IMPORTE bigint,P_IMPORTE_ME bigint, P_ID_PAGO INOUT bigint,P_ERROR out bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_estado varchar(1):='1'; --1:vigente, 0:anulado
        L_ID_CTABANCARIA bigint := null;
        L_ID_CHEQUERA bigint :=null;
        L_ID_MONEDA bigint :=null;
        L_FECHA timestamp(0);
        L_ID_MEDIOPAGO varchar(200):='007'; -- Cheque
        l_id_pago bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';

        
BEGIN
            
            if l_error=0 then
                
                /*
                DELETE FROM CAJA_PAGO_GASTO_ASIENTO
                WHERE ID_PGASTO IN (
                    SELECT ID_PGASTO FROM CAJA_PAGO_GASTO WHERE ID_PAGO IN (
                            SELECT ID_PAGO FROM CAJA_PAGO
                            WHERE ID_USER = P_ID_USER
                            AND ESTADO = '0'
                            )
                );
                */
                --ACTUALIZA EL FILE A NULL CUANDO ESTA EN PROCESO
                UPDATE CAJA_VALE_FILE SET ID_PGASTO  = NULL WHERE ID_PGASTO IN (
                    SELECT ID_PGASTO FROM CAJA_PAGO_GASTO
                    WHERE ID_PAGO IN (
                        SELECT ID_PAGO FROM CAJA_PAGO WHERE ID_USER = P_ID_USER  AND ESTADO = '0'
                    ) 
                )
                AND coalesce(ID_USER::text, '') = '';
                --ELIMINNA LOS FILES QUE EL USER SUBE MIESTRAS ESTE EN PROCESO
                DELETE  FROM CAJA_VALE_FILE WHERE ID_PGASTO IN (
                    SELECT ID_PGASTO FROM CAJA_PAGO_GASTO
                    WHERE ID_PAGO IN (
                        SELECT ID_PAGO FROM CAJA_PAGO WHERE ID_USER = P_ID_USER  AND ESTADO = '0'
                    )
                )
                AND ID_USER = P_ID_USER;

                DELETE FROM CAJA_PAGO_GASTO
                WHERE ID_PAGO IN (
                SELECT ID_PAGO FROM CAJA_PAGO
                WHERE ID_USER = P_ID_USER
                AND ESTADO = '0'
                );

                DELETE FROM CAJA_PAGO_COMPRA
                WHERE ID_PAGO IN (
                SELECT ID_PAGO FROM CAJA_PAGO
                WHERE ID_USER = P_ID_USER
                AND ESTADO = '0'
                );

                DELETE FROM CAJA_PAGO_VENTA
                WHERE ID_PAGO IN (
                SELECT ID_PAGO FROM CAJA_PAGO
                WHERE ID_USER = P_ID_USER
                AND ESTADO = '0'
                );

                DELETE FROM CAJA_PAGO
                WHERE ID_USER = P_ID_USER
                AND ESTADO = '0';

                -- SELECT coalesce(max(ID_PAGO),0)+1 into l_pago FROM CAJA_PAGO;
        
                IF coalesce(P_ID_CTABANCARIA::text, '') = '' OR P_ID_CTABANCARIA = 0 THEN
                    L_ID_CTABANCARIA:=null;
                ELSE
                    L_ID_CTABANCARIA:=P_ID_CTABANCARIA;
                END IF;

                /*
                IF P_FECHA IS NULL THEN
                    L_FECHA := NULL;
                ELSE
                    L_FECHA := P_FECHA;
                END IF;
                */
                
                IF coalesce(P_ID_CHEQUERA::text, '') = '' OR P_ID_CHEQUERA = 0 THEN
                    L_ID_CHEQUERA:=null;
                ELSE
                    L_ID_CHEQUERA:=P_ID_CHEQUERA;
                    select TO_CHAR(fecha, 'DD/MM/YYYY') into STRICT L_FECHA from caja_chequera WHERE ID_CHEQUERA=P_ID_CHEQUERA;
                END IF;

                IF coalesce(P_ID_MONEDA::text, '') = '' OR P_ID_MONEDA = 0 THEN
                    L_ID_MONEDA:=null;
                ELSE
                    L_ID_MONEDA:=P_ID_MONEDA;
                END IF;

                INSERT INTO CAJA_PAGO(
                    ID_MEDIOPAGO,
                    ID_ENTIDAD,
                    ID_DEPTO,
                    ID_CTABANCARIA,
                    ID_CHEQUERA,
                    ID_VOUCHER,
                    ID_ANHO,
                    ID_MES,
                    ID_USER,
                    ID_TIPOTRANSACCION,
                    ID_MONEDA,
                    NUMERO,
                    FECHA,
                    FECHA_REG,
                    TIPOCAMBIO,
                    ESTADO
                )VALUES (
                  L_ID_MEDIOPAGO, 
                  P_ID_ENTIDAD, 
                  P_ID_DEPTO, 
                  L_ID_CTABANCARIA,
                  L_ID_CHEQUERA,
                  P_ID_VOUCHER,
                  P_ID_ANHO, 
                  P_ID_MES,  
                  P_ID_USER, 
                  P_ID_TIPOTRANSACCION,
                  L_ID_MONEDA,
                  P_NUMERO,
                  L_FECHA,
                  clock_timestamp(),
                  P_TIPOCAMBIO, 
                  l_estado
                ) RETURNING ID_PAGO INTO l_id_pago;

                INSERT INTO CAJA_PAGO_GASTO(
                    ID_PAGO, ID_DINAMICA, ID_PERSONA, DETALLE,
                    IMPORTE, IMPORTE_ME, FECHA,ID_MONEDA
                )VALUES (
                  l_id_pago, P_ID_DINAMICA, P_ID_USER, P_DETALLE,
                  P_IMPORTE, P_IMPORTE_ME, L_FECHA,L_ID_MONEDA
                );

                INSERT INTO CAJA_DEPOSITO(
                    ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_VOUCHER,ID_MEDIOPAGO,
                    ID_PERSONA,ID_CLIENTE,ID_SUCURSAL,ID_TIPOTRANSACCION,ID_MONEDA, 
                    ID_DINAMICA, SERIE, NUMERO, FECHA, IMPORTE, IMPORTE_ME, TIPOCAMBIO,  
                    GLOSA, NOMBRE_DEP, DOCUMENTO_DEP, ESTADO,
                    ID_PAGO
                    --ID_TIPOORIGEN, ID_VALE, ID_TIPOTARJETA,ID_CTABANCARIA, FECHA_OPERACION, NRO_OPERACION
                )VALUES (
                    P_ID_ENTIDAD,P_ID_DEPTO, P_ID_ANHO, P_ID_MES, P_ID_VOUCHER, L_ID_MEDIOPAGO, 
                    P_ID_USER, P_ID_USER, NULL, P_ID_TIPOTRANSACCION, L_ID_MONEDA, 
                    P_ID_DINAMICA, NULL, NULL, L_FECHA, P_IMPORTE, P_IMPORTE_ME, P_TIPOCAMBIO, 
                    P_DETALLE, NULL, NULL, '1',
                    l_id_pago
                );

                
                CALL pkg_caja_sp_generar_asiento_dep_cajachi(l_id_pago,l_error,l_msgerror);
            end if;
        P_ID_PAGO :=l_id_pago;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_crear_pago_dep_cajachica (P_ID_ENTIDAD bigint, P_ID_DEPTO text,P_ID_VOUCHER bigint,P_ID_ANHO bigint, P_ID_MES bigint, P_ID_USER bigint, P_ID_TIPOTRANSACCION bigint, P_ID_DINAMICA bigint,P_ID_CTABANCARIA bigint,P_NUMERO text, P_ID_CHEQUERA bigint,P_ID_MONEDA bigint,P_TIPOCAMBIO bigint,P_DETALLE text,P_IMPORTE bigint,P_IMPORTE_ME bigint, P_ID_PAGO INOUT bigint,P_ERROR out bigint,P_MSGERROR out text) FROM PUBLIC;
