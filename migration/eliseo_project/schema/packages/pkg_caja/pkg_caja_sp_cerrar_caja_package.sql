-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_cerrar_caja (P_ID_VOUCHER bigint,P_ID_DINAMICA bigint,P_ID_PERSONA bigint,P_GLOSA text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    L_ID_CIERRE bigint;
    L_ID_ENTIDAD bigint;
    L_ID_DEPTO varchar(10);
    L_ID_ANHO bigint;
    L_ID_MES bigint;
    L_CODIGO varchar(20);
    L_IMPORTE decimal(10,2);
    L_IMPORTE_ME decimal(10,2);
    L_CANT bigint;

BEGIN
        SELECT 
                SUM(IMPORTE), coalesce(SUM(IMPORTE_ME),0) INTO STRICT L_IMPORTE,L_IMPORTE_ME
        FROM CAJA_DEPOSITO
        WHERE ID_VOUCHER = P_ID_VOUCHER
        AND ID_MEDIOPAGO = '008';

        IF (L_IMPORTE+L_IMPORTE_ME > 0) THEN 
            SELECT ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_ANHO,L_ID_MES
            FROM CONTA_VOUCHER
            WHERE ID_VOUCHER = P_ID_VOUCHER;

            SELECT L_ID_ENTIDAD||'-'||L_ID_DEPTO||'-'||COUNT(1)+1::text INTO STRICT L_CODIGO
            FROM CAJA_CIERRE
            WHERE ID_ENTIDAD = L_ID_ENTIDAD
            AND ID_DEPTO = L_ID_DEPTO;

            SELECT COUNT(1) INTO STRICT L_CANT 
            FROM CAJA_CIERRE
            WHERE ID_VOUCHER = P_ID_VOUCHER;
            IF L_CANT = 0 THEN
                INSERT INTO CAJA_CIERRE(ID_ENTIDAD,
                                         ID_DEPTO,
                                         ID_ANHO,
                                         ID_MES,
                                         ID_VOUCHER,
                                         ID_DINAMICA,
                                         ID_PERSONA,
                                         FECHA,
                                         CODIGO,
                                         GLOSA,
                                         IMPORTE,
                                         IMPORTE_ME,
                                         ESTADO)
                     VALUES (L_ID_ENTIDAD,
                             L_ID_DEPTO,
                             L_ID_ANHO,
                             L_ID_MES,
                             P_ID_VOUCHER,
                             P_ID_DINAMICA,
                             P_ID_PERSONA,
                             clock_timestamp(),
                             L_CODIGO,
                             P_GLOSA,
                             L_IMPORTE,
                             L_IMPORTE_ME,
                             '1');
                --GENERA ASIENTO DE CIERRE DE CAJA 
                --SP_ASIENTO_CIERRE
                SELECT MAX(ID_CIERRE) INTO STRICT L_ID_CIERRE FROM CAJA_CIERRE;
                CALL pkg_accounting_sp_asiento_contable(P_ID_DINAMICA,16,L_ID_CIERRE,L_IMPORTE,P_GLOSA,P_ID_VOUCHER,L_IMPORTE_ME ,P_ERROR,P_MSGERROR);
                P_ERROR := 0;
                P_MSGERROR := 'CIERRE DE CAJA, FINALIZADO CON EXITO';
            ELSE
                P_ERROR := 1;
                P_MSGERROR := 'ERROR: YA ESTA CERRADO EL DIA';
            END IF;
        ELSE
            P_ERROR := 1;
            P_MSGERROR := 'ERROR: AL REALIZAR EL CIERRE DEL DIA';
        END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_cerrar_caja (P_ID_VOUCHER bigint,P_ID_DINAMICA bigint,P_ID_PERSONA bigint,P_GLOSA text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
