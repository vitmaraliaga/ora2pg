-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_crear_deposito_imp (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint,P_ID_MONEDA bigint,P_ID_CTABANCARIA bigint,P_OPERACION text, P_FECHA_OP timestamp(0),P_IMPORTE bigint,P_IMPORTE_ME bigint,P_TIPOCAMBIO bigint,P_GLOSA text,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE


    l_deposito bigint:=0;
    l_id_mediopago varchar(3);
    l_id_tipotransaccion bigint;
    l_id_dinamica bigint;
    l_id_tipoasiento varchar(3) :='MB';
    l_id_tipotarjeta bigint:=null;
    l_estado varchar(1):='X'; --1:vigente, 0:anulado, X:temporal al importar en 2 pasos
    l_error bigint:=0;
    l_msgerror varchar(200):='';

BEGIN
    
--        ASIENTO :
--        CAJA - CLIENTE
--        CAJA - BANCOS
        l_id_mediopago := '008'; --EFECTIVO:ASEI
        l_id_tipotransaccion := 14; --DEPOSITOS ALUMNOS
        l_id_dinamica := 21;--DEPOSITOS ALUMNOS BANCOS
      if l_error=0 then
        select coalesce(max(id_deposito),0)+1 into STRICT l_deposito from CAJA_DEPOSITO;
        -- insert into test_cli values(l_deposito);
        INSERT INTO CAJA_DEPOSITO(ID_DEPOSITO,
                           ID_ENTIDAD,
                           ID_DEPTO,
                           ID_ANHO,
                           ID_MES,
                           ID_MEDIOPAGO,
                           ID_PERSONA,
                           ID_CLIENTE,
                           ID_TIPOTRANSACCION,
                           ID_MONEDA,
                           ID_DINAMICA,
                           FECHA,
                           IMPORTE,
                           IMPORTE_ME,
                           TIPOCAMBIO,
                           GLOSA,
                           ESTADO)
        VALUES (l_deposito,
                 P_ID_ENTIDAD,
                 P_ID_DEPTO,
                 P_ID_ANHO,
                 P_ID_MES,
                 l_id_mediopago,
                 P_ID_PERSONA,
                 P_ID_CLIENTE,
                 l_id_tipotransaccion,
                 P_ID_MONEDA,
                 l_id_dinamica,
                 clock_timestamp(),
                 P_IMPORTE,
                 P_IMPORTE_ME,
                 P_TIPOCAMBIO,
                 P_GLOSA||' - Oper:'||P_OPERACION||' Fecha:'||TO_CHAR(P_FECHA_OP,'DD/MM/YYYY'),
                 l_estado);
                l_id_mediopago := '001'; --deposito en cuenta
                CALL pkg_caja_sp_crear_deposito_banco(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,l_deposito,l_id_dinamica,P_ID_MONEDA,P_ID_CTABANCARIA,l_id_tipotarjeta,P_ID_PERSONA,l_id_mediopago,P_OPERACION,P_FECHA_OP,P_IMPORTE,P_IMPORTE_ME,P_TIPOCAMBIO,P_GLOSA,l_id_tipoasiento,l_estado,l_error,l_msgerror);
      end if;
      P_ERROR:=l_error;
      P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_crear_deposito_imp (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint,P_ID_MONEDA bigint,P_ID_CTABANCARIA bigint,P_OPERACION text, P_FECHA_OP timestamp(0),P_IMPORTE bigint,P_IMPORTE_ME bigint,P_TIPOCAMBIO bigint,P_GLOSA text,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
