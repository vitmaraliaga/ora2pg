-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_compra_end (P_ID_COMPRA bigint) RETURNS varchar AS $body$
DECLARE

    S_RESULT varchar(2);
    S_SUMA_D decimal(10,2);
    S_SUMA_C decimal(10,2);
    S_IMPORTE decimal(10,2);
    S_DET_IMPORTE decimal(10,2);
    S_SUMA_D_1 decimal(10,2);

BEGIN
    SELECT (SELECT coalesce(SUM(IMPORTE),0)
        FROM COMPRA_ASIENTO
        WHERE ID_COMPRA = P_ID_COMPRA AND DC = 'D')
      ,(SELECT ABS(coalesce(SUM(IMPORTE),0))
        FROM COMPRA_ASIENTO
        WHERE ID_COMPRA = P_ID_COMPRA AND DC = 'C')
      ,(SELECT coalesce(SUM(IMPORTE),0)
        FROM COMPRA
        WHERE ID_COMPRA = P_ID_COMPRA)
      ,(SELECT coalesce(SUM(IMPORTE),0)
        FROM COMPRA_DETALLE
        WHERE ID_COMPRA = P_ID_COMPRA AND coalesce(ES_COSTO_VINCULADO::text, '') = ''  )
        ,(SELECT coalesce(SUM(IMPORTE),0)
        FROM COMPRA_ASIENTO
        WHERE ID_COMPRA = P_ID_COMPRA AND DC = 'D' AND coalesce(NRO_ASIENTO,1) = 1
        )
      INTO STRICT
      S_SUMA_D
      , S_SUMA_C
      , S_IMPORTE
      , S_DET_IMPORTE
      , S_SUMA_D_1
;
    -- 
    IF S_SUMA_D != S_SUMA_C THEN
        S_RESULT := 'N1';
    ELSIF S_SUMA_D_1 != S_IMPORTE THEN
        S_RESULT := 'N2';
    ELSIF S_IMPORTE != S_DET_IMPORTE THEN
        S_RESULT := 'N3';
    ELSE
        S_RESULT := 'SI';
    END IF;
    -- 
    RETURN(S_RESULT);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_compra_end (P_ID_COMPRA bigint) FROM PUBLIC;

