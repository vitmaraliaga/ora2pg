-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_saldo_alumno (P_ID_PERSONA integer, P_ANIO integer,P_ID_DEPTO text) RETURNS bigint AS $body$
DECLARE

    SALDO	  decimal(10,2);		

    
BEGIN

    DECLARE
    V_CODIGO varchar(100) := '';

    BEGIN
        SELECT CODIGO INTO STRICT V_CODIGO FROM MOISES.PERSONA WHERE ID_PERSONA = P_ID_PERSONA;

        SELECT  --DECODE(LENGTH(SIGN(NVL(SUM(TOTAL),0))),2,'',0)||SIGN(NVL(SUM(TOTAL),0))||'-'||NVL(ABS(SUM(TOTAL)),0) 
                coalesce(SUM(TOTAL),0) INTO SALDO
        FROM (
            SELECT TOTAL
            FROM ELISEO.VW_SALES_MOV
            WHERE ID_ENTIDAD = 7124 AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ANIO AND ID_CLIENTE = P_ID_PERSONA AND ID_TIPOVENTA IN (1,2,3)
            
UNION ALL

            SELECT SUM(IMPORTE)*CASE WHEN SIGN(SUM(IMPORTE))=1 THEN -1  ELSE 0 END  AS TOTAL
            FROM ELISEO.VW_SALES_ADVANCES
            WHERE ID_ENTIDAD = 7124 AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ANIO AND ID_CLIENTE = P_ID_PERSONA
        ) alias6;
        RETURN SALDO;
    END;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_saldo_alumno (P_ID_PERSONA integer, P_ANIO integer,P_ID_DEPTO text) FROM PUBLIC;

