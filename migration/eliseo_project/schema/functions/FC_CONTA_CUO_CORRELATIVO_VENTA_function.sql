-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_conta_cuo_correlativo_venta (P_ID_VENTA bigint, p_id_entidad bigint, p_id_anho bigint, p_id_mes bigint) RETURNS varchar AS $body$
DECLARE

L_NOMBRE varchar(100);
L_ID_TIPOORIGEN bigint;
L_ID_VDETALLE bigint;
L_ID_VDETALLE_MIN bigint;
L_CONTAR bigint;

BEGIN
	L_CONTAR := 0;
	
		SELECT COUNT(1), max(ID_VDETALLE), min(ID_VDETALLE), MAX(ID_TIPOORIGEN)
		INTO STRICT L_CONTAR, L_ID_VDETALLE, L_ID_VDETALLE_MIN, L_ID_TIPOORIGEN
		FROM ELISEO.VENTA_DETALLE vd WHERE VD.ID_VENTA = P_ID_VENTA;
	
		IF L_CONTAR > 0 THEN
		
            SELECT COUNT(1), min('M'||d.NUM_AASI) INTO STRICT L_CONTAR,L_NOMBRE FROM VW_CONTA_DIARIO d
            where
            trim(both to_char(L_ID_TIPOORIGEN,'999'))||'-'||trim(both to_char(L_ID_VDETALLE,'9999999999999999999')) = d.OBSERVACION
            AND d.ID_ENTIDAD = p_id_entidad
            AND d.ID_ANHO = p_id_anho
            AND d.ID_MES = p_id_mes
            -- AND d.ID_CUENTAAASI = 1132001
 
;
            IF L_CONTAR = 0 THEN
                SELECT COUNT(1), min('M'||d.NUM_AASI) INTO STRICT L_CONTAR,L_NOMBRE FROM VW_CONTA_DIARIO d
	            where
	            trim(both to_char(L_ID_TIPOORIGEN,'999'))||'-'||trim(both to_char(L_ID_VDETALLE_MIN,'9999999999999999999')) = d.OBSERVACION
	            AND d.ID_ENTIDAD = p_id_entidad
	            AND d.ID_ANHO = p_id_anho
	            AND d.ID_MES = p_id_mes
	            -- AND d.ID_CUENTAAASI = 1132001
 
	;	
            END IF;

           IF L_CONTAR = 0 THEN 
                SELECT COUNT(1), MAX(A.CUO_CORRELATIVO ) INTO STRICT L_CONTAR, L_NOMBRE FROM CONTA_DIARIO_CUO_AUX A
                WHERE A.ID_ORIGEN = L_ID_VDETALLE
                AND A.ID_TIPOORIGEN = L_ID_TIPOORIGEN;
            END IF;

           IF L_CONTAR = 0 THEN 
                SELECT COUNT(1), MAX(A.CUO_CORRELATIVO ) INTO STRICT L_CONTAR, L_NOMBRE FROM CONTA_DIARIO_CUO_AUX A
                WHERE A.ID_ORIGEN = L_ID_VDETALLE_MIN
                AND A.ID_TIPOORIGEN = L_ID_TIPOORIGEN;
            END IF;

           IF L_CONTAR = 0 THEN 
                SELECT COUNT(1), min('M'||d.NUM_AASI) INTO STRICT L_CONTAR,L_NOMBRE FROM VW_CONTA_DIARIO d
	            where
	            trim(both to_char(L_ID_TIPOORIGEN,'999'))||'-'||trim(both to_char(P_ID_VENTA,'9999999999999999999')) = d.OBSERVACION
	            AND d.ID_ENTIDAD = p_id_entidad
	            AND d.ID_ANHO = p_id_anho
	            AND d.ID_MES = p_id_mes
	            -- AND d.ID_CUENTAAASI = 1132001
 
	;
            END IF;
	
		ELSE 
		L_NOMBRE := '';
		
		END IF;

  RETURN(L_NOMBRE);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_conta_cuo_correlativo_venta (P_ID_VENTA bigint, p_id_entidad bigint, p_id_anho bigint, p_id_mes bigint) FROM PUBLIC;

