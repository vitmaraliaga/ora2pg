-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_imprime_documento ( P_ID_PERSONA integer, P_ID_DOCUMENTO integer, P_CONTENIDO text, P_TEXTO text, P_FILA bigint ) RETURNS bigint AS $body$
DECLARE


	   fil 		smallint;
	   col		smallint;
	   t_fila	smallint;
	   largo	smallint;
	   numcol	smallint;

	   documento CURSOR FOR
	   SELECT
	   	   numcol
	   FROM CONTA_DOCUMENTO
	   WHERE ID_DOCUMENTO = P_ID_DOCUMENTO;

	   datos CURSOR FOR
       SELECT
	       pos_x,
		   pos_y
	   FROM CONTA_DOCUMENTO_DETALLE
	   WHERE ID_DOCUMENTO = P_ID_DOCUMENTO
	   AND CONTENIDO = P_CONTENIDO;

	   filas CURSOR FOR
	   SELECT
	   	   FILA
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA
	   AND FILA = fil;


BEGIN
	 largo := length(p_texto);

	 open documento;
	 fetch documento into numcol;
	 close documento;

	 open datos;
	 fetch datos into col,fil;
	 close datos;

	 fil := fil + coalesce(p_fila,0);

	 open filas;
	 fetch filas into t_fila;

	 if not filas%found then
        IF (fil IS NOT NULL AND fil::text <> '') THEN
            INSERT INTO CONTA_DOCUMENTO_TEMPORAL(ID_PERSONA,FILA,TEXTO)VALUES ( P_ID_PERSONA, fil,lpad(' ',numcol,' '));
	 	END IF;
 	 end if;

	 UPDATE CONTA_DOCUMENTO_TEMPORAL SET TEXTO =  substr(texto,1,col-1)||p_texto||substr(texto,col+largo,numcol-(col+largo)+1)
	 WHERE ID_PERSONA = P_ID_PERSONA
	 AND FILA = fil;

	RETURN( 1 );
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION eliseo.fc_imprime_documento ( P_ID_PERSONA integer, P_ID_DOCUMENTO integer, P_CONTENIDO text, P_TEXTO text, P_FILA bigint ) FROM PUBLIC;

