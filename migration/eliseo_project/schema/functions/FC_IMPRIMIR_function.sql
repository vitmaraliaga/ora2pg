-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_imprimir (P_ID_PERSONA integer ) RETURNS varchar AS $body$
DECLARE


	   t_texto 	varchar(300);
	   texto1	varchar(4000);
	   texto2	varchar(4000);
	   num_filas smallint;
	   t_fila	smallint;
	   contador smallint;

	   -- extrae datos
	   datos CURSOR FOR
       SELECT
	   		 texto
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA
	   ORDER BY FILA;

	   -- indica maximo de filas
	   filas CURSOR FOR
       SELECT
	   		 max(fila)
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA;

	   -- verifica existencia de fila
	   verfila CURSOR FOR
	   SELECT
	   		 fila
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA
	   AND FILA = contador;


BEGIN
     texto1 := '';
	 texto2 := '';
	 t_fila := 0;

	 open filas;
	 fetch filas into num_filas;
	 close filas;

	 -- ingresa filas vacias
	 contador := 1;
	 while contador<=num_filas loop
	 	   open verfila;
		   fetch verfila into t_fila;
		   if not verfila%found then
		   	  INSERT INTO CONTA_DOCUMENTO_TEMPORAL values ( P_ID_PERSONA, contador, ' ');
		   end if;
		   close verfila;
		   contador := contador + 1;
	 end loop;

	 -- descarga los datos
	 open datos;
	 fetch datos into t_texto;
	 while datos%found loop
	 	   if length(texto1||rtrim(t_texto)||'~')<4000 then
		   		   texto1 := texto1||rtrim(t_texto)||'~';
		   else
		   		   texto2 := texto2||rtrim(t_texto)||'~';
		   end if;
		   fetch datos into t_texto;
	 end loop;
	 close datos;

	RETURN( texto1 );
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION eliseo.fc_imprimir (P_ID_PERSONA integer ) FROM PUBLIC;

