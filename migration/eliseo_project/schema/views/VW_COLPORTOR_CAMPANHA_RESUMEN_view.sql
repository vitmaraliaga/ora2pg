-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_colportor_campanha_resumen (id_asistente_campanha, id_almacen, id_campanha, id_asistente, id_rcategoria, id_colportor, id_rcategoria_ins, estado, id_asist_camp_dep, total_entregado, total_devuelto, total_vendido, total_vendido_diezmo, total_facturado, total_depositado, total_amortizado, total_deposito_aprobado, saldo_disponible, saldo_contable, deuda_anterior, deuda_campanha, deuda) AS SELECT FILAS.ID_ASISTENTE_CAMPANHA,FILAS.ID_ALMACEN,FILAS.ID_CAMPANHA,FILAS.ID_ASISTENTE,FILAS.ID_RCATEGORIA,FILAS.ID_COLPORTOR,FILAS.ID_RCATEGORIA_INS,FILAS.ESTADO,
FILAS.ID_ASIST_CAMP_DEP,FILAS.TOTAL_ENTREGADO,FILAS.TOTAL_DEVUELTO,FILAS.TOTAL_VENDIDO,round((FILAS.TOTAL_VENDIDO*0.10)::numeric,2) AS TOTAL_VENDIDO_DIEZMO,
FILAS.TOTAL_FACTURADO,FILAS.TOTAL_DEPOSITADO,FILAS.TOTAL_AMORTIZADO,FILAS.TOTAL_DEPOSITO_APROBADO, 
round((FILAS.TOTAL_DEPOSITO_APROBADO - FILAS.TOTAL_AMORTIZADO)::numeric,2) AS SALDO_DISPONIBLE,
round((FILAS.TOTAL_DEPOSITADO - FILAS.TOTAL_AMORTIZADO)::numeric,2) AS SALDO_CONTABLE,
FILAS.DEUDA_ANTERIOR,
round((FILAS.TOTAL_VENDIDO - FILAS.TOTAL_DEPOSITADO)::numeric, 2) AS DEUDA_CAMPANHA,
round((FILAS.TOTAL_VENDIDO + FILAS.TOTAL_VENDIDO*0.10 + FILAS.DEUDA_ANTERIOR - FILAS.TOTAL_DEPOSITADO)::numeric, 2) AS DEUDA
FROM (
SELECT A.ID_ASISTENTE_CAMPANHA, A.ID_ALMACEN, A.ID_CAMPANHA, A.ID_ASISTENTE, A.ID_RCATEGORIA, B.ID_COLPORTOR, B.ID_RCATEGORIA_INS, B.ESTADO, B.ID_ASIST_CAMP_DEP,
FC_COLP_DEUDA_CAMPANHA(B.ID_ASIST_CAMP_DEP, B.ID_COLPORTOR) AS DEUDA_ANTERIOR,
(
	SELECT coalesce(round((SUM(COD.CANTIDAD * COD.PRECIO))::numeric,2),0)-- + SUM(COD.CANTIDAD * COD.PRECIO)*(10/100),2),0)
	FROM COLP_OPERACION CO 
	INNER JOIN COLP_OPERACION_DETALLE COD ON
		CO.ID_OPERACION = COD.ID_OPERACION
	WHERE CO.ID_ASISTENTE_CAMPANHA = B.ID_ASISTENTE_CAMPANHA AND CO.ID_COLPORTOR = B.ID_COLPORTOR AND 
		CO.ID_TIPOOPERACION = 1 AND CO.ESTADO = '1'
) AS TOTAL_ENTREGADO,
(
	SELECT coalesce(round((SUM(COD.CANTIDAD * COD.PRECIO))::numeric,2),0)-- + SUM(COD.CANTIDAD * COD.PRECIO)*(10/100),2),0)
	FROM COLP_OPERACION CO 
	INNER JOIN COLP_OPERACION_DETALLE COD ON
		CO.ID_OPERACION = COD.ID_OPERACION
	WHERE CO.ID_ASISTENTE_CAMPANHA = B.ID_ASISTENTE_CAMPANHA AND CO.ID_COLPORTOR = B.ID_COLPORTOR AND 
		CO.ID_TIPOOPERACION = 3 AND CO.ESTADO = '1'
) AS TOTAL_DEVUELTO,
(
	SELECT coalesce(round((SUM(DEP.MONTO))::numeric,2),0)
	FROM COLP_DEPOSITO_COLP DEP
	WHERE DEP.ID_ASISTENTE_CAMPANHA = B.ID_ASISTENTE_CAMPANHA AND DEP.ID_COLPORTOR = B.ID_COLPORTOR 
) AS TOTAL_DEPOSITADO,
(
	SELECT coalesce(round((SUM(COD.CANTIDAD * COD.PRECIO))::numeric,2),0)-- + SUM(COD.CANTIDAD * COD.PRECIO)*(10/100),0),2)
	FROM COLP_OPERACION CO 
	INNER JOIN COLP_OPERACION_DETALLE COD ON
		CO.ID_OPERACION = COD.ID_OPERACION
	WHERE CO.ID_ASISTENTE_CAMPANHA = B.ID_ASISTENTE_CAMPANHA AND B.ID_COLPORTOR = CO.ID_COLPORTOR AND CO.ID_TIPOOPERACION = 2 AND CO.ESTADO = '1'
) AS TOTAL_VENDIDO,
(
	SELECT coalesce(round((SUM(VENTA.TOTAL))::numeric,2),0) FROM VENTA INNER JOIN COLP_VENTA CV ON VENTA.ID_VENTA = "CV".ID_VENTA
	WHERE VENTA.ID_DEPTO = FC_COLP_OBT_DEPTO_ALMACEN(A.ID_ALMACEN) AND VENTA.ID_CLIENTE = B.ID_COLPORTOR AND "CV".ID_CAMPANHA = A.ID_CAMPANHA
		--FC_COLP_OBTENER_CAMPANHA(VENTA.FECHA, VENTA.ID_CLIENTE, A.ID_ALMACEN) = A.ID_CAMPANHA
		--(SELECT ID_CAMPANHA FROM INVENTARIO_CAMPANHA WHERE FECHA_INICIO <= VENTA.FECHA AND FECHA_FIN >= VENTA.FECHA) = A.ID_CAMPANHA
 
) AS TOTAL_FACTURADO,
(
	SELECT round((coalesce(SUM(CDD.IMPORTE),0))::numeric,2)
	FROM CAJA_DEPOSITO_DETALLE CDD
	INNER JOIN CAJA_DEPOSITO CD ON	
		CDD.ID_DEPOSITO = CD.ID_DEPOSITO
	INNER JOIN COLP_VENTA CV ON CDD.ID_VENTA = "CV".ID_VENTA
	WHERE  --(SELECT ID_CAMPANHA FROM INVENTARIO_CAMPANHA WHERE FECHA_INICIO <= CD.FECHA AND FECHA_FIN >= CD.FECHA) = A.ID_CAMPANHA
		--FC_COLP_OBTENER_CAMPANHA(CD.FECHA, CD.ID_CLIENTE, A.ID_ALMACEN) = A.ID_CAMPANHA
		"CV".ID_CAMPANHA = A.ID_CAMPANHA
		AND FC_COLP_OBT_DEPTO_ALMACEN(A.ID_ALMACEN) = CD.ID_DEPTO AND B.ID_COLPORTOR = CD.ID_CLIENTE 
) AS TOTAL_AMORTIZADO,
(
	SELECT round((coalesce(SUM(CDC.MONTO),0))::numeric,2)
	FROM COLP_DEPOSITO_COLP CDC
	INNER JOIN COLP_DEPOSITO_DETALLE CDD ON
		CDC.ID_DEPOSITO_COLP = CDD.ID_DEPOSITO_COLP
	INNER JOIN COLP_DEPOSITO_ASIST CDA ON
		CDA.ID_DEPOSITO_ASIST = CDD.ID_DEPOSITO_ASIST AND CDA.ID_ESTADO = 9
	WHERE CDC.ID_ASISTENTE_CAMPANHA = A.ID_ASISTENTE_CAMPANHA AND CDC.ID_COLPORTOR = B.ID_COLPORTOR
) AS TOTAL_DEPOSITO_APROBADO

FROM COLP_ASISTENTE_CAMPANHA A
INNER JOIN COLP_INSCRIPCION B ON
		A.ID_ASISTENTE_CAMPANHA = B.ID_ASISTENTE_CAMPANHA
) FILAS;

