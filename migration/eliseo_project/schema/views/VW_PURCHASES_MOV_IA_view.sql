-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_purchases_mov_ia (id_entidad, id_depto, id_anho, id_mes, id_compra, id_proveedor, id_comprobante, id_moneda, id_tipoorigen, id_origen, id_voucher, serie, numero, nro_referencia, fecha_doc, fecha_provision, importe, importe_me, importe_doc, importe_doc_me, correlativo, id_persona, tipo, oper, tipocambio) AS SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          1 AS ID_MES,
          A.ID_COMPRA,
          A.ID_PROVEEDOR,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          3 AS ID_TIPOORIGEN,
          A.ID_COMPRA,
          0 AS ID_VOUCHER,
          A.SERIE,
          A.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA_DOC,
          A.FECHA_PROVISION,
          A.IMPORTE,
          A.IMPORTE_ME,
          A.IMPORTE AS IMPORTE_DOC,
          A.IMPORTE_ME AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_PERSONA,
          'C' AS TIPO,
          'SI.-'||A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
   FROM COMPRA_SALDO A, COMPRA B
   WHERE A.ID_COMPRA = B.ID_COMPRA
   AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
   AND A.IMPORTE <> 0

UNION ALL

	SELECT A.ID_ENTIDAD,
        A.ID_DEPTO,
        A.ID_ANHO,
        A.ID_MES,
        A.ID_COMPRA,
        A.ID_PROVEEDOR,
        A.ID_COMPROBANTE,
        A.ID_MONEDA,
        A.ID_TIPOORIGEN,
        A.ID_COMPRA AS ID_ORIGEN,
        A.ID_VOUCHER,
        A.SERIE,
        A.NUMERO,
        A.NUMERO AS NRO_REFERENCIA,
        A.FECHA_DOC,
        A.FECHA_PROVISION,
        A.IMPORTE,
        A.IMPORTE_ME,
        A.IMPORTE as IMPORTE_DOC,
        A.IMPORTE_ME AS IMPORTE_DOC_ME,
        A.CORRELATIVO,
        A.ID_PERSONA,
        'C' AS TIPO,
        'Comp.-'||A.NUMERO AS OPER,
        A.TIPOCAMBIO
  FROM COMPRA A
  WHERE A.ID_COMPROBANTE NOT IN ('07','08','87', 46, 50)
  AND A.ESTADO = '1' 
  
UNION ALL

    	SELECT A.ID_ENTIDAD,
        A.ID_DEPTO,
        A.ID_ANHO,
        A.ID_MES,
        A.ID_COMPRA,
        A.ID_PROVEEDOR,
        A.ID_COMPROBANTE,
        A.ID_MONEDA,
        A.ID_TIPOORIGEN,
        A.ID_COMPRA AS ID_ORIGEN,
        A.ID_VOUCHER,
        A.SERIE,
        A.NUMERO,
        A.NUMERO AS NRO_REFERENCIA,
        A.FECHA_DOC,
        A.FECHA_PROVISION,
        A.IGV AS IMPORTE,
        A.IGV_ME AS IMPORTE_ME,
        A.IGV as IMPORTE_DOC,
        A.IGV_ME AS IMPORTE_DOC_ME,
        A.CORRELATIVO,
        A.ID_PERSONA,
        'C' AS TIPO,
        'Comp.-'||A.NUMERO AS OPER,
        A.TIPOCAMBIO
  FROM COMPRA A
  WHERE A.ID_COMPROBANTE IN (46, 50)
  AND A.ESTADO = '1' 
  
UNION ALL

  SELECT A.ID_ENTIDAD,
      A.ID_DEPTO,
      A.ID_ANHO,
      A.ID_MES,
      A.ID_COMPRA,
      A.ID_PROVEEDOR,
      A.ID_COMPROBANTE,
      A.ID_MONEDA,
      14 as ID_TIPOORIGEN,
      A.ID_COMPRA AS ID_ORIGEN,
      A.ID_VOUCHER,
      A.SERIE,
      A.NUMERO,
      'RET' AS NRO_REFERENCIA,
      A.FECHA_DOC,
      A.FECHA_PROVISION,
      A.IMPORTE_RENTA*-1 as IMPORTE,
      A.IMPORTE_RENTA_ME*-1 as IMPORTE_ME,
      0 as IMPORTE_DOC,
      0 AS IMPORTE_DOC_ME,

      A.CORRELATIVO,
      A.ID_PERSONA,
      'C' AS TIPO,
      'RxH.-'||A.NUMERO AS OPER,
      A.TIPOCAMBIO
FROM COMPRA A
WHERE A.ID_COMPROBANTE IN ('02')
AND A.ESTADO = '1'
AND coalesce(A.IMPORTE_RENTA, 0) != 0 

UNION ALL

SELECT A.ID_ENTIDAD,
      A.ID_DEPTO,
      A.ID_ANHO,
      A.ID_MES,
      C.ID_COMPRA,
      B.ID_PROVEEDOR,
      C.ID_COMPROBANTE,
      A.ID_MONEDA,
      B.ID_TIPOORIGEN,
      B.ID_PCOMPRA AS ID_ORIGEN,
      A.ID_VOUCHER,
      C.SERIE,
      C.NUMERO,
      A.NUMERO AS NRO_REFERENCIA,
      A.FECHA AS FECHA_DOC,
      A.FECHA_REG AS FECHA_PROVISION,
      B.IMPORTE * -1 AS IMPORTE,
      B.IMPORTE_ME * -1 AS IMPORTE_ME,
      0 as IMPORTE_DOC,
      0 AS IMPORTE_DOC_ME,
      C.CORRELATIVO,
      A.ID_USER,
      'C' AS TIPO,
      CASE WHEN A.ID_MEDIOPAGO='001' THEN 'TLC.-' WHEN A.ID_MEDIOPAGO='007' THEN 'CHQ.-' WHEN A.ID_MEDIOPAGO='008' THEN 'EFE.-' END ||A.NUMERO AS OPER,
      NULL AS TIPOCAMBIO
FROM CAJA_PAGO A, CAJA_PAGO_COMPRA B, COMPRA C
WHERE A.ID_PAGO = B.ID_PAGO 
AND B.ID_COMPRA = C.ID_COMPRA 
AND A.ID_ANHO = C.ID_ANHO
AND A.ESTADO = '1'

UNION ALL


SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_COMPRA, -- se cambio que solo traiga de la compra COALESCE(C.ID_COMPRA, C.ID_SALDO) AS ID_COMPRA
          B.ID_PROVEEDOR,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.ID_TIPOORIGEN,
          B.ID_PCOMPRA AS ID_ORIGEN,
          A.ID_VOUCHER,
          C.SERIE,
          C.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA AS FECHA_DOC,
          A.FECHA_REG AS FECHA_PROVISION,
          B.IMPORTE * -1 AS IMPORTE,
          B.IMPORTE_ME * -1 AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_USER,
          'C' AS TIPO,
  CASE WHEN A.ID_MEDIOPAGO='001' THEN 'TLC.-' WHEN A.ID_MEDIOPAGO='007' THEN 'CHQ.-' WHEN A.ID_MEDIOPAGO='008' THEN 'EFE.-' END ||A.NUMERO AS OPER,
      NULL AS TIPOCAMBIO
 FROM CAJA_PAGO A
      JOIN CAJA_PAGO_COMPRA B ON A.ID_PAGO = B.ID_PAGO
      JOIN COMPRA_SALDO C ON B.ID_COMPRA  = C.ID_COMPRA  -- se cambio que solo traiga de la compra
      AND B.ID_PROVEEDOR  = C.ID_PROVEEDOR  --se agrego el filtro de proveedor
  AND A.ID_ANHO = C.ID_ANHO
  AND A.ESTADO = '1'

UNION ALL


SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_COMPRA,
          A.ID_PROVEEDOR,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.ID_TIPOORIGEN,
          B.ID_RETDETALLE AS ID_ORIGEN,
          A.ID_VOUCHER,
          C.SERIE,
          C.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA_EMISION AS FECHA_DOC,
          A.FECHA_EMISION AS FECHA_PROVISION,
          B.IMPORTE_RET * -1 AS IMPORTE,
          B.IMPORTE_RET_ME * -1 AS IMPORTE_ME,
          0 as IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          C.CORRELATIVO,
          A.ID_PERSONA,
          'C' AS TIPO,
          'RET.-'||A.NRO_RETENCION AS OPER,
          NULL AS TIPOCAMBIO
FROM CAJA_RETENCION A, CAJA_RETENCION_COMPRA B, COMPRA C
WHERE A.ID_RETENCION = B.ID_RETENCION 
AND B.ID_COMPRA = C.ID_COMPRA
AND A.ID_PROVEEDOR  = C.ID_PROVEEDOR
AND A.ID_ANHO = C.ID_ANHO
AND A.ESTADO = '1'

UNION ALL

SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_COMPRA,
          --C.ID_SALDO AS ID_COMPRA, SE CAMBIO 
          A.ID_PROVEEDOR,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.ID_TIPOORIGEN,
          B.ID_RETDETALLE AS ID_ORIGEN,
          A.ID_VOUCHER,
          C.SERIE,
          C.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA_EMISION AS FECHA_DOC,
          A.FECHA_EMISION AS FECHA_PROVISION,
          B.IMPORTE_RET * -1 AS IMPORTE,
          B.IMPORTE_RET_ME * -1 AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          1 AS CORRELATIVO,
          A.ID_PERSONA,
          'C' AS TIPO,
          'RET.-'||A.NRO_RETENCION AS OPER,
          NULL AS TIPOCAMBIO
     FROM CAJA_RETENCION A, CAJA_RETENCION_COMPRA B, COMPRA_SALDO C
    WHERE     A.ID_RETENCION = B.ID_RETENCION
          AND B.ID_COMPRA  = C.ID_COMPRA   --SE CAMBIO EL ID_SALDO POR ID_COMPRA
          AND A.ID_ANHO = C.ID_ANHO
          AND A.ID_PROVEEDOR = C.ID_PROVEEDOR
          AND A.ESTADO = '1'

UNION ALL

SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_COMPRA,
          A.ID_PROVEEDOR,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.ID_TIPOORIGEN,
          B.ID_DETDETALLE AS ID_ORIGEN,
          A.ID_VOUCHER,
          C.SERIE,
          C.NUMERO,
          A.NRO_OPERACION AS NRO_REFERENCIA,
          A.FECHA_EMISION AS FECHA_DOC,
          A.FECHA AS FECHA_PROVISION,
          B.IMPORTE * -1 AS IMPORTE,
          B.IMPORTE_ME * -1 AS IMPORTE_ME,
          0 as IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          C.CORRELATIVO,
          A.ID_PERSONA,
          'C' AS TIPO,
          --'DET.-'||A.NRO_OPERACION AS OPER
          'DET.-'||A.NRO_CONSTANCIA AS OPER,
          NULL AS TIPOCAMBIO
FROM CAJA_DETRACCION A, CAJA_DETRACCION_COMPRA B, COMPRA C
WHERE A.ID_DETRACCION = B.ID_DETRACCION 
AND B.ID_COMPRA = C.ID_COMPRA
AND A.ID_ANHO = C.ID_ANHO
AND A.ESTADO = '1'

UNION ALL

SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_COMPRA, --se cambio
          A.ID_PROVEEDOR,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.ID_TIPOORIGEN,
          B.ID_DETDETALLE AS ID_ORIGEN,
          A.ID_VOUCHER,
          C.SERIE,
          C.NUMERO,
          A.NRO_OPERACION AS NRO_REFERENCIA,
          A.FECHA_EMISION AS FECHA_DOC,
          A.FECHA AS FECHA_PROVISION,
          B.IMPORTE * -1 AS IMPORTE,
          B.IMPORTE_ME * -1 AS IMPORTE_ME,
          0 as IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
         -- C.CORRELATIVO ,
          0 CORRELATIVO ,
          A.ID_PERSONA,
          'C' AS TIPO,
          --'DET.-'||A.NRO_OPERACION AS OPER
          'DET.-'||A.NRO_CONSTANCIA AS OPER,
          NULL AS TIPOCAMBIO
FROM CAJA_DETRACCION A, CAJA_DETRACCION_COMPRA B, compra_saldo C
WHERE A.ID_DETRACCION = B.ID_DETRACCION 
AND B.ID_COMPRA = C.ID_COMPRA  -- se cambio
AND A.ID_PROVEEDOR  = C.ID_PROVEEDOR
AND A.ID_ANHO = C.ID_ANHO
AND A.ESTADO = '1'

UNION ALL


SELECT 
        A.ID_ENTIDAD,
        A.ID_DEPTO,
        A.ID_ANHO,
        A.ID_MES,
        B.ID_COMPRA,
        --NVL((SELECT ID_SALDO FROM COMPRA_SALDO X WHERE B.ID_COMPRA = X.ID_COMPRA  AND A.ID_ANHO = X.ID_ANHO AND A.ID_PROVEEDOR = X.ID_PROVEEDOR),B.ID_COMPRA) AS ID_COMPRA, --SE CAMBIO
        A.ID_PROVEEDOR,
        B.ID_COMPROBANTE,
        A.ID_MONEDA,
        A.ID_TIPOORIGEN,
        A.ID_COMPRA AS ID_ORIGEN,
        A.ID_VOUCHER,
        B.SERIE,
        B.NUMERO,
        A.NUMERO,
        A.FECHA_DOC AS FECHA_DOC,
        A.FECHA_PROVISION AS FECHA_PROVISION,
        A.IMPORTE * CASE WHEN A.ID_COMPROBANTE='08' THEN 1  ELSE -1 END  AS IMPORTE,
        A.IMPORTE_ME * CASE WHEN A.ID_COMPROBANTE='08' THEN 1  ELSE -1 END  AS IMPORTE_ME,
        0 as IMPORTE_DOC,
        0 AS IMPORTE_DOC_ME,
        A.CORRELATIVO,
        A.ID_PERSONA,
        'C' AS TIPO,
        CASE WHEN A.ID_COMPROBANTE='07' THEN 'N/C.-' WHEN A.ID_COMPROBANTE='08' THEN 'N/D.-' END ||A.NUMERO AS OPER,
        A.TIPOCAMBIO
FROM COMPRA A, COMPRA B
WHERE A.ID_PARENT = B.ID_COMPRA AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
AND A.ID_COMPROBANTE IN ('07','08','87')
AND A.ESTADO = '1'
--AND B.IMPORTE > 0-- PARA QUE NO SE DUPLIQUE EN EL REGISTRO DE COMPRAS CON EL SALDO INICIAL
 

UNION ALL

SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_COMPRA,
          A.ID_PROVEEDOR,
          B.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.ID_TIPOORIGEN,
          A.ID_AJUSTE AS ID_ORIGEN,
          A.ID_VOUCHER,
          B.SERIE,
          B.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA AS FECHA_DOC,
          A.FECHA AS FECHA_PROVISION,
          A.IMPORTE * CASE WHEN A.DC='C' THEN -1  ELSE 1 END  AS IMPORTE,
          A.IMPORTE_ME * CASE WHEN A.DC='C' THEN -1  ELSE 1 END  AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          B.CORRELATIVO,
          A.ID_PERSONA,
          'C' AS TIPO,
          'AJU.-'||A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
FROM COMPRA_AJUSTE A, COMPRA B
WHERE A.ID_COMPRA = B.ID_COMPRA
AND A.ID_ANHO = B.ID_ANHO
AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
AND A.ESTADO = '1'

UNION ALL

-- Ojo: Cuando se relaciona con la compra destino se invierten los signos (D- y C +)
SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_COMPRA,
          A.ID_PROVEEDOR,
          B.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.ID_TIPOORIGEN,
          A.ID_AJUSTE AS ID_ORIGEN,
          A.ID_VOUCHER,
          B.SERIE,
          B.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA AS FECHA_DOC,
          A.FECHA AS FECHA_PROVISION,
          A.IMPORTE * CASE WHEN A.DC='D' THEN -1  ELSE 1 END  AS IMPORTE,
          A.IMPORTE_ME * CASE WHEN A.DC='D' THEN -1  ELSE 1 END  AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          B.CORRELATIVO,
          A.ID_PERSONA,
          'C' AS TIPO,
          'AJU.-'||A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
FROM COMPRA_AJUSTE A, COMPRA B
WHERE A.ID_COMPRA_DESTINO = B.ID_COMPRA
AND A.ID_ANHO = B.ID_ANHO
AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
AND A.ESTADO = '1'

UNION ALL

SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_COMPRA,
          --B.ID_SALDO AS ID_COMPRA, -- SE CAMBIO
          A.ID_PROVEEDOR,
          B.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.ID_TIPOORIGEN,
          A.ID_AJUSTE AS ID_ORIGEN,
          A.ID_VOUCHER,
          B.SERIE,
          B.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA AS FECHA_DOC,
          A.FECHA AS FECHA_PROVISION,
          A.IMPORTE * CASE WHEN A.DC='C' THEN  -1  ELSE 1 END  AS IMPORTE,
          A.IMPORTE_ME * CASE WHEN A.DC='C' THEN  -1  ELSE 1 END  AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_PERSONA,
          'S' AS TIPO,
          'AJU.-' || A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
FROM COMPRA_AJUSTE A, COMPRA_SALDO B
WHERE A.ID_COMPRA = B.ID_COMPRA
AND A.ID_ANHO = B.ID_ANHO
AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
AND A.ESTADO = '1'

UNION ALL

SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_COMPRA,
          --B.ID_SALDO AS ID_COMPRA, -- SE CAMBIO
          A.ID_PROVEEDOR,
          B.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.ID_TIPOORIGEN,
          A.ID_AJUSTE AS ID_ORIGEN,
          A.ID_VOUCHER,
          B.SERIE,
          B.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA AS FECHA_DOC,
          A.FECHA AS FECHA_PROVISION,
          A.IMPORTE * CASE WHEN A.DC='D' THEN  -1  ELSE 1 END  AS IMPORTE,
          A.IMPORTE_ME * CASE WHEN A.DC='D' THEN  -1  ELSE 1 END  AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_PERSONA,
          'S' AS TIPO,
          'AJU.-' || A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
FROM COMPRA_AJUSTE A, COMPRA_SALDO B
WHERE A.ID_COMPRA_DESTINO = B.ID_COMPRA
AND A.ID_ANHO = B.ID_ANHO
AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
AND A.ESTADO = '1'

UNION ALL

--SALDO INICIAL SISTEMA EXTERNO QUERY 2
   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          1 AS ID_MES, 
          A.ID_SALDO  AS ID_COMPRA,
          A.ID_PROVEEDOR,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          3 AS ID_TIPOORIGEN,
          A.ID_SALDO,
          0 AS ID_VOUCHER,
          A.SERIE,
          A.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA_DOC,
          A.FECHA_PROVISION,
          A.IMPORTE,
          A.IMPORTE_ME,
          A.IMPORTE AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_PERSONA,
          'S' AS TIPO,
          'SIN.-'||A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
     FROM COMPRA_SALDO A
     WHERE coalesce(A.ID_COMPRA::text, '') = ''
   	 AND A.IMPORTE > 0 
   	 
UNION ALL

   	   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          1 AS ID_MES,
          A.ID_COMPRA,
          A.ID_PROVEEDOR,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          3 AS ID_TIPOORIGEN,
          A.ID_COMPRA,
          0 AS ID_VOUCHER,
          A.SERIE,
          A.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA_DOC,
          A.FECHA_PROVISION,
          A.IMPORTE,
          A.IMPORTE_ME,
          A.IMPORTE AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_PERSONA,
          'S' AS TIPO,
          'SIN.-'||A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
   FROM COMPRA_SALDO A, COMPRA_SALDO B
   WHERE A.ID_COMPRA = B.ID_SALDO
   AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
   AND A.IMPORTE <> 0
   AND coalesce(B.ID_COMPRA::text, '') = '' 
   
UNION ALL

      SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_COMPRA,
          B.ID_PROVEEDOR,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.ID_TIPOORIGEN,
          B.ID_PCOMPRA AS ID_ORIGEN,
          A.ID_VOUCHER,
          C.SERIE,
          C.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA AS FECHA_DOC,
          A.FECHA_REG AS FECHA_PROVISION,
          B.IMPORTE * -1 AS IMPORTE,
          B.IMPORTE_ME * -1 AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_USER,
          'C' AS TIPO,
          CASE WHEN A.ID_MEDIOPAGO='001' THEN 'TLC.-' WHEN A.ID_MEDIOPAGO='007' THEN 'CHQ.-' WHEN A.ID_MEDIOPAGO='008' THEN 'EFE.-' END ||A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
     FROM CAJA_PAGO A
          JOIN CAJA_PAGO_COMPRA B ON A.ID_PAGO = B.ID_PAGO
          JOIN COMPRA_SALDO C ON B.ID_SALDO = C.ID_SALDO
          --AND A.ID_CLIENTE = C.ID_CLIENTE
          AND A.ID_ANHO = C.ID_ANHO
          AND A.ESTADO = '1'
          
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_SALDO AS ID_COMPRA,
          B.ID_PROVEEDOR,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.ID_TIPOORIGEN,
          B.ID_PCOMPRA AS ID_ORIGEN,
          A.ID_VOUCHER,
          C.SERIE,
          C.NUMERO,
          A.NUMERO AS NRO_REFERENCIA,
          A.FECHA AS FECHA_DOC,
          A.FECHA_REG AS FECHA_PROVISION,
          B.IMPORTE * -1 AS IMPORTE,
          B.IMPORTE_ME * -1 AS IMPORTE_ME,
          0 AS IMPORTE_DOC,
          0 AS IMPORTE_DOC_ME,
          0 AS CORRELATIVO,
          A.ID_USER,
          'C' AS TIPO,
          CASE WHEN A.ID_MEDIOPAGO='001' THEN 'TLC.-' WHEN A.ID_MEDIOPAGO='007' THEN 'CHQ.-' WHEN A.ID_MEDIOPAGO='008' THEN 'EFE.-' END ||A.NUMERO AS OPER,
          NULL AS TIPOCAMBIO
     FROM CAJA_PAGO A
          JOIN CAJA_PAGO_COMPRA B ON A.ID_PAGO = B.ID_PAGO
          JOIN COMPRA_SALDO C ON B.ID_COMPRA = C.ID_SALDO
          --AND A.ID_CLIENTE = C.ID_CLIENTE
          AND A.ID_ANHO = C.ID_ANHO
          AND A.ESTADO = '1' 

UNION ALL

SELECT 
        A.ID_ENTIDAD,
        A.ID_DEPTO,
        A.ID_ANHO,
        A.ID_MES,
        B.ID_COMPRA,
        A.ID_PROVEEDOR,
        B.ID_COMPROBANTE,
        A.ID_MONEDA,
        A.ID_TIPOORIGEN,
        A.ID_COMPRA AS ID_ORIGEN,
        A.ID_VOUCHER,
        B.SERIE,
        B.NUMERO,
        A.NUMERO,
        A.FECHA_DOC AS FECHA_DOC,
        A.FECHA_PROVISION AS FECHA_PROVISION,
        A.IMPORTE * CASE WHEN A.ID_COMPROBANTE='08' THEN 1  ELSE -1 END  AS IMPORTE,
        A.IMPORTE_ME * CASE WHEN A.ID_COMPROBANTE='08' THEN 1  ELSE -1 END  AS IMPORTE_ME,
        0 as IMPORTE_DOC,
        0 AS IMPORTE_DOC_ME,
        A.CORRELATIVO,
        A.ID_PERSONA,
        'S' AS TIPO,
        CASE WHEN A.ID_COMPROBANTE='07' THEN 'N/C.-' WHEN A.ID_COMPROBANTE='08' THEN 'N/D.-' END ||A.NUMERO AS OPER,
        A.TIPOCAMBIO
FROM COMPRA A, COMPRA_SALDO B
WHERE A.ID_PARENT = B.ID_SALDO
AND A.ID_PROVEEDOR = B.ID_PROVEEDOR
AND A.ID_COMPROBANTE IN ('07','08','87')
AND A.ESTADO = '1';

COMMENT ON VIEW vw_purchases_mov_ia  IS E'mov para imprenta y aces';

