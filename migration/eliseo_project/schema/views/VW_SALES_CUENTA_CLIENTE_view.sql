-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_sales_cuenta_cliente (id_entidad, id_depto, id_venta, id_anho, id_mes, cuenta, tipo, fecha, lote, operacion, numero, total, alumno, codigo, debito, credito) AS SELECT ID_ENTIDAD,
            ID_DEPTO,
            ID_VENTA,
            ID_ANHO,
            ID_MES,
            CUENTA,
            'VENTA/NC/ND' AS TIPO,
            FECHA,
            LOTE,
            CASE WHEN ID_COMPROBANTE='07' THEN  'NOTA CREDITO'  ELSE 'VENTA' END  AS OPERACION,
            NUMERO,
            TOTAL,
            ALUMNO,
            CODIGO,
            SUM(DEBITO) AS DEBITO,
            ABS(SUM(CREDITO)) AS CREDITO
       FROM (SELECT A.ID_ENTIDAD,
                    A.ID_DEPTO,
                    A.ID_VENTA,
                    A.ID_ANHO,
                    A.ID_MES,
                    X.CUENTA,
                    A.ID_COMPROBANTE,
                    A.FECHA,
                    C.LOTE,
                    A.SERIE || '-' || A.NUMERO AS NUMERO,
                    A.TOTAL,
                    D.NOMBRE || ' ' || D.PATERNO || ' ' || D.MATERNO AS ALUMNO,
                    E.CODIGO,
                    (CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS DEBITO,
                    (CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS CREDITO
               FROM VENTA A
                    JOIN VENTA_DETALLE B ON A.ID_VENTA = B.ID_VENTA
                    JOIN CONTA_VOUCHER C ON A.ID_VOUCHER = C.ID_VOUCHER
                    JOIN MOISES.PERSONA D ON A.ID_CLIENTE = D.ID_PERSONA
                    LEFT JOIN MOISES.PERSONA_NATURAL_ALUMNO E
                       ON A.ID_CLIENTE = E.ID_PERSONA
                    JOIN CONTA_ASIENTO X
                       ON     A.ID_VOUCHER = X.VOUCHER
                          AND B.ID_TIPOORIGEN = X.ID_TIPOORIGEN
                          AND B.ID_VDETALLE = X.ID_ORIGEN
              WHERE A.ID_ENTIDAD = 7124 AND A.ID_TIPOVENTA <> 5) alias9
   GROUP BY ID_ENTIDAD,
            ID_DEPTO,
            ID_VENTA,
            ID_ANHO,
            ID_MES,
            CUENTA,
            ID_VENTA,
            FECHA,
            LOTE,
            ID_COMPROBANTE,
            NUMERO,
            TOTAL,
            ALUMNO,
            CODIGO
   
UNION ALL

     --TRANSFERENCIAS
     SELECT                                                   --ID_VENTA,FECHA,
           ID_ENTIDAD,
            ID_DEPTO,
            ID_TRANSFERENCIA,
            ID_ANHO,
            ID_MES,
            CUENTA,
            'TRANSFERENCIA' AS TIPO,
            FECHA,
            LOTE,
            CASE WHEN ID_COMPROBANTE='07' THEN  'NOTA CREDITO'  ELSE 'TRANSFERENCIA' END 
               AS OPERACION,
            NUMERO,
            TOTAL,
            ALUMNO,
            CODIGO,
            SUM(DEBITO) AS DEBITO,
            ABS(SUM(CREDITO)) AS CREDITO
       FROM (SELECT DISTINCT
                    A.ID_ENTIDAD,
                    A.ID_DEPTO,
                    A.ID_TRANSFERENCIA,
                    A.ID_ANHO,
                    A.ID_MES,
                    X.CUENTA,
                    '99' AS ID_COMPROBANTE,
                    A.FECHA,
                    C.LOTE,
                    A.SERIE || '-' || A.NUMERO AS NUMERO,
                    A.IMPORTE AS TOTAL,
                    D.NOMBRE || ' ' || D.PATERNO || ' ' || D.MATERNO AS ALUMNO,
                    E.CODIGO,
                    (CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS DEBITO,
                    (CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS CREDITO
               FROM VENTA_TRANSFERENCIA A
                    JOIN VENTA_TRANSFERENCIA_DETALLE B
                       ON A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
                    JOIN CONTA_VOUCHER C ON A.ID_VOUCHER = C.ID_VOUCHER
                    JOIN MOISES.PERSONA D ON A.ID_CLIENTE = D.ID_PERSONA
                    LEFT JOIN MOISES.PERSONA_NATURAL_ALUMNO E
                       ON A.ID_CLIENTE = E.ID_PERSONA
                    JOIN CONTA_ASIENTO X
                       ON     A.ID_VOUCHER = X.VOUCHER
                          AND A.ID_TIPOORIGEN = X.ID_TIPOORIGEN
                          AND B.ID_TRANSFERENCIA = X.ID_ORIGEN) alias19 
   GROUP BY ID_ENTIDAD,
            ID_DEPTO,
            ID_TRANSFERENCIA,
            ID_ANHO,
            ID_MES,
            CUENTA,
            FECHA,
            LOTE,
            ID_COMPROBANTE,
            NUMERO,
            TOTAL,
            ALUMNO,
            CODIGO
   
UNION ALL

     --CAJA
     SELECT ID_ENTIDAD,
            ID_DEPTO,
            ID_DEPOSITO,
            ID_ANHO,
            ID_MES,
            CUENTA,
            'DEPOSITO CAJA' AS TIPO,
            FECHA,
            LOTE,
            CASE WHEN ID_MEDIOPAGO='08' THEN  'EFECTIVO'  ELSE 'BANCO/VISA' END  AS OPERACION,
            NUMERO,
            IMPORTE,
            ALUMNO,
            CODIGO,
            SUM(DEBITO) AS DEBITO,
            ABS(SUM(CREDITO)) AS CREDITO
       FROM (SELECT DISTINCT
                    A.ID_ENTIDAD,
                    A.ID_DEPTO,
                    A.ID_DEPOSITO,
                    A.ID_ANHO,
                    A.ID_MES,
                    X.CUENTA,
                    A.ID_MEDIOPAGO,
                    A.FECHA,
                    C.LOTE,
                    A.SERIE || '-' || A.NUMERO AS NUMERO,
                    A.IMPORTE,
                    D.NOMBRE || ' ' || D.PATERNO || ' ' || D.MATERNO AS ALUMNO,
                    E.CODIGO,
                    (CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS DEBITO,
                    (CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS CREDITO
               FROM CAJA_DEPOSITO A
                    JOIN CAJA_DEPOSITO_DETALLE B
                       ON A.ID_DEPOSITO = B.ID_DEPOSITO
                    JOIN CONTA_VOUCHER C ON A.ID_VOUCHER = C.ID_VOUCHER
                    JOIN MOISES.PERSONA D ON A.ID_CLIENTE = D.ID_PERSONA
                    LEFT JOIN MOISES.PERSONA_NATURAL_ALUMNO E
                       ON A.ID_CLIENTE = E.ID_PERSONA
                    JOIN CONTA_ASIENTO X
                       ON     A.ID_VOUCHER = X.VOUCHER
                          AND A.ID_TIPOORIGEN = X.ID_TIPOORIGEN
                          AND A.ID_DEPOSITO = X.ID_ORIGEN
              WHERE A.ID_TIPODEPOSITO <> 5) alias29 
   GROUP BY ID_ENTIDAD,
            ID_DEPTO,
            ID_DEPOSITO,
            ID_ANHO,
            ID_MES,
            CUENTA,
            FECHA,
            LOTE,
            NUMERO,
            ID_MEDIOPAGO,
            IMPORTE,
            ALUMNO,
            CODIGO
   
UNION ALL

     SELECT ID_ENTIDAD,
            ID_DEPTO,
            ID_PAGO,
            ID_ANHO,
            ID_MES,
            CUENTA,
            'PAGO CAJA' AS TIPO,
            FECHA,
            LOTE,
            CASE WHEN ID_MEDIOPAGO='08' THEN  'EFECTIVO'  ELSE 'BANCO/VISA' END  AS OPERACION,
            NUMERO,
            IMPORTE,
            ALUMNO,
            CODIGO,
            SUM(DEBITO) AS DEBITO,
            ABS(SUM(CREDITO)) AS CREDITO
       FROM (SELECT DISTINCT
                    A.ID_ENTIDAD,
                    A.ID_DEPTO,
                    A.ID_PAGO,
                    A.ID_ANHO,
                    A.ID_MES,
                    X.CUENTA,
                    A.ID_MEDIOPAGO,
                    A.FECHA,
                    C.LOTE,
                    A.NUMERO AS NUMERO,
                    A.IMPORTE,
                    D.NOMBRE || ' ' || D.PATERNO || ' ' || D.MATERNO AS ALUMNO,
                    E.CODIGO,
                    (CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS DEBITO,
                    (CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END)
                       AS CREDITO
               FROM CAJA_PAGO A
                    JOIN CAJA_PAGO_VENTA B ON A.ID_PAGO = B.ID_PAGO
                    JOIN CONTA_VOUCHER C ON A.ID_VOUCHER = C.ID_VOUCHER
                    JOIN MOISES.PERSONA D ON B.ID_CLIENTE = D.ID_PERSONA
                    LEFT JOIN MOISES.PERSONA_NATURAL_ALUMNO E
                       ON B.ID_CLIENTE = E.ID_PERSONA
                    JOIN CONTA_ASIENTO X
                       ON     A.ID_VOUCHER = X.VOUCHER
                          AND B.ID_TIPOORIGEN = X.ID_TIPOORIGEN
                          AND B.ID_PVENTA = X.ID_ORIGEN) alias39 
   GROUP BY ID_ENTIDAD,
            ID_DEPTO,
            ID_PAGO,
            ID_ANHO,
            ID_MES,
            CUENTA,
            FECHA,
            LOTE,
            NUMERO,
            ID_MEDIOPAGO,
            IMPORTE,
            ALUMNO,
            CODIGO;

