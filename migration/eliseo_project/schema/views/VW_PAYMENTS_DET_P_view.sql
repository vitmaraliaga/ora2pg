-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_payments_det_p (id_pago, id_entidad, id_depto, id_anho, id_mes, id_user, id_voucher, id_ctabancaria, id_chequera, id_tipoorigen, id_origen, numero, fecha, id_compra, id_proveedor, importe, importe_me, detalle, tipo) AS SELECT A.ID_PAGO,
      A.ID_ENTIDAD,
      A.ID_DEPTO,
      A.ID_ANHO,
      A.ID_MES,
      A.ID_USER,
      A.ID_VOUCHER,
      A.ID_CTABANCARIA,
      A.ID_CHEQUERA,
      B.ID_TIPOORIGEN,
      B.ID_PCOMPRA AS ID_ORIGEN,
      A.NUMERO,
      A.FECHA,
      B.ID_COMPRA,
      B.ID_PROVEEDOR,
      B.IMPORTE,
      B.IMPORTE_ME,
      B.DETALLE,
      'P' AS TIPO
FROM CAJA_PAGO A JOIN CAJA_PAGO_COMPRA B
ON A.ID_PAGO = B.ID_PAGO
WHERE A.ESTADO = '1'

UNION ALL

SELECT A.ID_PAGO,
      A.ID_ENTIDAD,
      A.ID_DEPTO,
      A.ID_ANHO,
      A.ID_MES,
      A.ID_USER,
      A.ID_VOUCHER,
      A.ID_CTABANCARIA,
      A.ID_CHEQUERA,
      B.ID_TIPOORIGEN,
      B.ID_PGASTO AS ID_ORIGEN,
      A.NUMERO,
      A.FECHA,
      0 ID_COMPRA,
      B.ID_PERSONA,
      B.IMPORTE,
      B.IMPORTE_ME,
      B.DETALLE,
      'P' AS TIPO
FROM CAJA_PAGO A JOIN CAJA_PAGO_GASTO B 
ON A.ID_PAGO = B.ID_PAGO
WHERE A.ESTADO = '1'

UNION ALL


SELECT  A.ID_PAGO,
      A.ID_ENTIDAD,
      A.ID_DEPTO,
      A.ID_ANHO,
      A.ID_MES,
      A.ID_USER,
      A.ID_VOUCHER,
      A.ID_CTABANCARIA,
      A.ID_CHEQUERA,
      B.ID_TIPOORIGEN,
      B.ID_PVENTA AS ID_ORIGEN,
      A.NUMERO,
      A.FECHA,
      B.ID_VENTA AS ID_COMPRA,
      B.ID_CLIENTE AS ID_PROVEEDOR,
      B.IMPORTE,
      B.IMPORTE_ME,
      B.DETALLE,
      'P' AS TIPO
FROM CAJA_PAGO A JOIN CAJA_PAGO_VENTA B 
ON A.ID_PAGO = B.ID_PAGO
WHERE A.ESTADO = '1'

UNION ALL

SELECT 
    A.ID_DETRACCION,
    A.ID_ENTIDAD,
    A.ID_DEPTO,
    A.ID_ANHO,
    A.ID_MES,
    A.ID_PERSONA,
    A.ID_VOUCHER,
    A.ID_CTABANCARIA,
    A.ID_CHEQUERA,
    A.ID_TIPOORIGEN,
    A.ID_DETRACCION AS ID_ORIGEN,
    A.NRO_OPERACION,
    A.FECHA_EMISION,
    coalesce(B.ID_COMPRA,C.ID_VENTA) AS ID_COMPRA,
    A.ID_PROVEEDOR,
    coalesce(B.IMPORTE,C.IMPORTE) AS IMPORTE,
    coalesce(B.IMPORTE_ME,C.IMPORTE_ME) AS IMPORTE_ME,
    coalesce(B.DETALLE,C.DETALLE) AS DETALLE,
    'D' AS TIPO
FROM CAJA_DETRACCION A LEFT JOIN CAJA_DETRACCION_COMPRA B
ON A.ID_DETRACCION = B.ID_DETRACCION
LEFT JOIN CAJA_DETRACCION_VENTA C
ON A.ID_DETRACCION = C.ID_DETRACCION
WHERE A.ID_ENTIDAD = 7124
AND A.ESTADO = '1'

UNION ALL

SELECT 
    A.ID_RETENCION,
    A.ID_ENTIDAD,
    A.ID_DEPTO,
    A.ID_ANHO,
    A.ID_MES,
    A.ID_PERSONA,
    A.ID_VOUCHER,
    A.ID_CTABANCARIA,
    A.ID_CHEQUERA,
    B.ID_TIPOORIGEN,
    A.ID_RETENCION AS ID_ORIGEN,
    A.SERIE||'-'||A.NUMERO,
    A.FECHA,
    B.ID_COMPRA,
    A.ID_PROVEEDOR,
    B.IMPORTE_RET,
    B.IMPORTE_RET_ME,
    '' AS DETALLE,
    'R' AS TIPO
FROM CAJA_RETENCION A
LEFT JOIN CAJA_RETENCION_COMPRA B
ON A.ID_RETENCION = B.ID_RETENCION
WHERE A.ESTADO = '1'
/*SELECT 
    A.ID_RETENCION,
    A.ID_ENTIDAD,
    A.ID_DEPTO,
    A.ID_ANHO,
    A.ID_MES,
    A.ID_PERSONA,
    A.ID_VOUCHER,
    A.ID_CTABANCARIA,
    A.ID_CHEQUERA,
    12 AS ID_TIPOORIGEN,
    A.ID_RETENCION AS ID_ORIGEN,
    A.SERIE||'-'||A.NRO_RETENCION,
    A.FECHA,
    0 AS ID_COMPRA,
    A.ID_PROVEEDOR,
    A.IMPORTE AS IMPORTE_RET,
    0 AS IMPORTE_RET_ME,
    '' AS DETALLE,
    'R' AS TIPO
FROM CAJA_RETENCION A
WHERE A.ESTADO = '1';*/
;

COMMENT ON VIEW vw_payments_det_p  IS E'VISTA CREADA PARA REPORTE DETALLE DE PAGOS DEBIDO A QUE EN LA VISTA PRINCIPAL (vw_PAYMENTS_DET)SE TRAE DE LAS RETENCIONES DE LA CABECERA Y NO DEL DETALLE';

