-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

FUNCTION        FC_COMPRA_END(P_ID_COMPRA IN NUMBER) RETURN VARCHAR2 IS 
    S_RESULT VARCHAR2(2);
    S_SUMA_D DECIMAL(10,2);
    S_SUMA_C DECIMAL(10,2);
    S_IMPORTE DECIMAL(10,2);
    S_DET_IMPORTE DECIMAL(10,2);
    S_SUMA_D_1 DECIMAL(10,2);
BEGIN
    SELECT
      (SELECT NVL(SUM(IMPORTE),0)
        FROM COMPRA_ASIENTO
        WHERE ID_COMPRA = P_ID_COMPRA AND DC = 'D')
      ,(SELECT ABS(NVL(SUM(IMPORTE),0))
        FROM COMPRA_ASIENTO
        WHERE ID_COMPRA = P_ID_COMPRA AND DC = 'C')
      ,(SELECT NVL(SUM(IMPORTE),0)
        FROM COMPRA
        WHERE ID_COMPRA = P_ID_COMPRA)
      ,(SELECT NVL(SUM(IMPORTE),0)
        FROM COMPRA_DETALLE
        WHERE ID_COMPRA = P_ID_COMPRA AND ES_COSTO_VINCULADO IS NULL )
        ,(SELECT NVL(SUM(IMPORTE),0)
        FROM COMPRA_ASIENTO
        WHERE ID_COMPRA = P_ID_COMPRA AND DC = 'D' AND NVL(NRO_ASIENTO,1) = 1
        )
      INTO
      S_SUMA_D
      , S_SUMA_C
      , S_IMPORTE
      , S_DET_IMPORTE
      , S_SUMA_D_1
    FROM DUAL;
    -- 
    IF S_SUMA_D != S_SUMA_C THEN
        S_RESULT := 'N1';
    ELSIF S_SUMA_D_1 != S_IMPORTE THEN
        S_RESULT := 'N2';
    ELSIF S_IMPORTE != S_DET_IMPORTE THEN
        S_RESULT := 'N3';
    ELSE
        S_RESULT := 'SI';
    END IF;
    -- 
    RETURN (S_RESULT);
END FC_COMPRA_END;

