-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

FUNCTION        FC_IMPRIME_DOCUMENTO(
	   P_ID_PERSONA in INT,
	   P_ID_DOCUMENTO in INT,
	   P_CONTENIDO	 in varchar2,
	   P_TEXTO		 in varchar2,
	   P_FILA		 in number  )
RETURN number IS

	   fil 		number(3);
	   col		number(3);
	   t_fila	number(3);
	   largo	number(3);
	   numcol	number(3);

	   cursor documento is
	   SELECT
	   	   numcol
	   FROM CONTA_DOCUMENTO
	   WHERE ID_DOCUMENTO = P_ID_DOCUMENTO;

	   cursor datos is
       SELECT
	       pos_x,
		   pos_y
	   FROM CONTA_DOCUMENTO_DETALLE
	   WHERE ID_DOCUMENTO = P_ID_DOCUMENTO
	   AND CONTENIDO = P_CONTENIDO;

	   cursor filas is
	   SELECT
	   	   FILA
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA
	   AND FILA = fil;

BEGIN
	 largo := length(p_texto);

	 open documento;
	 fetch documento into numcol;
	 close documento;

	 open datos;
	 fetch datos into col,fil;
	 close datos;

	 fil := fil + nvl(p_fila,0);

	 open filas;
	 fetch filas into t_fila;

	 if not filas%found then
        IF fil IS NOT NULL THEN
            INSERT INTO CONTA_DOCUMENTO_TEMPORAL (ID_PERSONA,FILA,TEXTO)VALUES( P_ID_PERSONA, fil,lpad(' ',numcol,' '));
	 	END IF;
 	 end if;

	 UPDATE CONTA_DOCUMENTO_TEMPORAL SET TEXTO =  substr(texto,1,col-1)||p_texto||substr(texto,col+largo,numcol-(col+largo)+1)
	 WHERE ID_PERSONA = P_ID_PERSONA
	 AND FILA = fil;

	RETURN ( 1 );
END;

