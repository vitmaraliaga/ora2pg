-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

FUNCTION        FC_CONTA_CUO(P_ID_TIPOORIGEN NUMBER, P_ID_MOV NUMBER, p_id_entidad NUMBER, p_id_anho NUMBER, p_id_mes number) RETURN VARCHAR2 AS
L_NOMBRE VARCHAR2(100);
L_COD_AASI number;
L_CONTAR NUMBER;
BEGIN
	
	IF P_ID_TIPOORIGEN = 1 THEN  
	   
	    SELECT max(lote) INTO L_NOMBRE FROM VW_CONTA_DIARIO d 
		where
	    trim(to_char(P_ID_TIPOORIGEN,'999'))||'-'||trim(to_char(P_ID_MOV,'9999999999999999999')) = d.OBSERVACION
	    AND d.ID_ANHO = p_id_anho
	    AND d.ID_MES = p_id_mes
	    AND d.ID_CUENTAAASI = 1132001
	    AND d.ID_ENTIDAD = p_id_entidad;  
		
	ELSE 
	
		SELECT count(1), max(lote), max(cod_aasi) INTO L_CONTAR, L_NOMBRE,L_COD_AASI  FROM VW_CONTA_DIARIO d 
		where
	    trim(to_char(P_ID_TIPOORIGEN,'999'))||'-'||trim(to_char(P_ID_MOV,'9999999999999999999')) = d.OBSERVACION
	    AND d.ID_ANHO = p_id_anho
	    AND d.ID_MES = p_id_mes
	    AND d.ID_CUENTAAASI IN (2130101, 2130103, 2130107)
	    AND d.ID_ENTIDAD = p_id_entidad;  
	    
	    SELECT
            COUNT(1), MIN(lote)
            INTO L_CONTAR, L_NOMBRE
            FROM eliseo.vw_conta_diario d
            WHERE cod_aasi = L_COD_AASI 
            AND trim(to_char(P_ID_TIPOORIGEN,'999'))||'-'||trim(to_char(P_ID_MOV,'9999999999999999999')) = d.OBSERVACION
            AND d.id_entidad = p_id_entidad 
            AND d.id_anho = p_id_anho 
            AND d.id_mes = p_id_mes;

	   
	    IF L_CONTAR = 0 THEN 
                SELECT MAX(A.CUO) INTO L_NOMBRE FROM CONTA_DIARIO_CUO_AUX A
                WHERE A.ID_ORIGEN = P_ID_MOV
                AND A.ID_TIPOORIGEN = P_ID_TIPOORIGEN;
        END IF;
            
   
   	END IF;
   
  RETURN(L_NOMBRE); 
END;

