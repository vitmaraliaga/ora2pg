-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

function  FC_PSTO_EVAL_FORMULA(P_FORMULA VARCHAR2,P_ID_ANHO NUMBER) RETURN VARCHAR2
IS
l_id_parametro varchar2(50);
l_importe number(20,14);
l_formula  varchar2(3000):='';
l_valid number;

CURSOR CUR is
SELECT UPPER(B.ID_PARAMETRO),B.IMPORTE 
FROM PSTO_PLLA_PARAMETROS A, PSTO_PLLA_PARAMETROS_VALOR  B
WHERE B.ID_ANHO = P_ID_ANHO
AND A.ESTADO='1'
ORDER BY A.ORDEN;


BEGIN
    l_formula:=UPPER(P_FORMULA);
    open CUR;
        fetch CUR into l_id_parametro,l_importe;
        while CUR%found loop
            l_formula:= replace(l_formula,'$'||l_id_parametro,replace(TO_CHAR(l_importe),',','.') );
            
            SELECT INSTR(l_formula, '$') into l_valid FROM dual;
            
            if l_valid=0 then
              EXIT;
            end if;
            
            fetch CUR into l_id_parametro,l_importe;
        end loop;
	close CUR;	
	
	RETURN(l_formula);
END;

