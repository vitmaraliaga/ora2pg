-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE        PKG_SALES_FACTURACION AS 

  /* TODO enter package declarations (types, exceptions, methods etc) here */ 

	 FUNCTION FC_VENTA(P_ID_VENTA IN NUMBER) RETURN VARCHAR2;
	 FUNCTION FC_NOTA_CREDITO(P_ID_VENTA IN NUMBER) RETURN VARCHAR2;
	 FUNCTION FC_NOTA_DEBITO(P_ID_VENTA IN NUMBER) RETURN VARCHAR2;
	 PROCEDURE SP_VENTA_ELECTRONICA_NUBE(P_ID_VENTA IN NUMBER);
	 PROCEDURE SP_VENTA_ELECTRONICA_UPEU(P_ID_VENTA IN NUMBER);
	 PROCEDURE SP_VENTA_ELECTRONICA(P_ID_VENTA IN NUMBER);
	 FUNCTION FC_CLIENTE_DIRECCION(P_ID_PERSONA IN NUMBER) RETURN VARCHAR2;
	 FUNCTION FC_CLIENTE_UBIGEO(
	    P_ID_PERSONA IN NUMBER,
	    P_TIPO IN NUMBER DEFAULT 4 --1=DISTRITO;2=PROVINCIA;3=DEPARTAMENTO;4=UBIGEO COMPLETO
	 ) RETURN VARCHAR2;

END PKG_SALES_FACTURACION;


CREATE OR REPLACE PACKAGE BODY               PKG_SALES_FACTURACION AS
 FUNCTION FC_VENTA(P_ID_VENTA IN NUMBER) RETURN VARCHAR2 IS
        S_DETALLE       VARCHAR2(4000);
        --S_DETALLE       LONG;
        S_VENTA         VARCHAR2(4000);
        --S_VENTA         LONG;
        S_CONTA         INT;
        S_TIPODOC       VARCHAR2(2);
        L_ID_TIPOVENTA NUMBER;

        S_ID_RUC      VARCHAR2(20);

        TYPE cv_typ IS REF CURSOR; 
        VENTA cv_typ;

    BEGIN  
    S_CONTA:=0;
    SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
    AND E.ID_EMPRESA = M.ID_EMPRESA
    AND V.ID_VENTA = P_ID_VENTA;

    --SELECT ID_COMPROBANTE,ID_TIPOVENTA INTO S_TIPODOC, L_ID_TIPOVENTA FROM VENTA WHERE ID_VENTA=P_ID_VENTA;
   
   		SELECT TC.COD_ELECTRONICO,V.ID_TIPOVENTA INTO S_TIPODOC, L_ID_TIPOVENTA 
		FROM VENTA V 
		INNER JOIN ELISEO.TIPO_COMPROBANTE TC ON V.ID_COMPROBANTE = TC.ID_COMPROBANTE 
		WHERE ID_VENTA=P_ID_VENTA; --Agregado por Ulices
		
        IF S_TIPODOC='03' THEN -- BOLETA

                open VENTA FOR  
                SELECT distinct'CB'||'|'||'0101'||
                    '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
                    '|'||'03'|| 
                    '|'||A.SERIE||'-'||A.NUMERO||
                    '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
                    '|'||S_ID_RUC|| 
                    '|'||DECODE(LENGTH(FC_DOCUMENTO_CLIENTE(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),8,1,0)||
                    '|'||NVL(FC_DOCUMENTO_CLIENTE(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
                    '|'||FC_NOMBRE_PERSONA(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
                    '|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Sin Direccion'),'-','')|| 
                    '|'||''|| 
                    '|'||trim(coalesce (FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
                    '|'||'0.00'|| 
                    '|'||decode(b.id_tipoigv,'40',DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END)),'0.00')||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||'0.00'||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
                    '|'||'0.00'||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
                    '|'||'1000'|| 
                    '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''|| 
                    '|'||''||    
                    '|' CAB 
                FROM VENTA A, VENTA_DETALLE B  
                WHERE A.ID_VENTA = B.ID_VENTA   
                AND A.ID_VENTA = P_ID_VENTA 
                AND A.ESTADO = 1 		
                UNION ALL 
                SELECT  'DB'||	
                    '|'||ROWNUM||
                    '|'||''|| 
                        (SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
                    '|86121503'|| 
                    '|'||'NIU'|| 
                    '|'||trim(to_char(b.cantidad,'990.99'))|| 
                    '|'||nvl(b.detalle,'Venta')|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999990D99')),',','.') END))||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
                    '|'||b.ID_TIPOIGV|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||''|| 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    '|'||'0.00'|| 
                    --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN B.DESCUENTO >0 THEN TO_CHAR(B.BASE,'999999,9999.99') ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.BASE_ME,'999999,9999.99') ELSE '0.00' END))||    
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2),'9999999990D99')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2),'9999999990D99')),',','.') END))|| 
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END))||
                    --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IMPORTE,0) = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END))||			
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
            		'|'||''|| 
                    '|'||''||
                    '|' DET 			
                FROM VENTA A, VENTA_DETALLE B  
                WHERE A.ID_VENTA = B.ID_VENTA    
                AND A.ID_VENTA = P_ID_VENTA  
                AND B.IMPORTE > 0
                AND A.ESTADO = 1;

ELSIF S_TIPODOC = '01' THEN  -- FACTURA
open VENTA FOR  
    SELECT distinct'CF'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'01'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		'|'||S_ID_RUC||'|6'||
		'|'||NVL(A.NRO_DOC_CLI,NVL(FC_DOCUMENTO_CLIENTE(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-'))||
    --'|'||DECODE(LENGTH(FC_DOCUMENTO_CLIENTE(A.ID_CLIENTE)),8,1,0)||
    '|'||NVL(A.RAZON_SOCIAL_CLI,FC_NOMBRE_PERSONA(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)))||
		'|'||REGEXP_REPLACE(nvl(A.DIRECCION_CLI,nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Sin Direccion')),'-','')|| 
		'|'||''|| 
		-- '|'||trim(FC_EMAIL(A.ID_CLIENTE_LEGAL))|| 
        '|'||trim(coalesce (FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
		'|'||'0.00'|| 
		'|'||decode(b.id_tipoigv,'40',DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END)),'0.00')||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl((A.GRAVADA+A.INAFECTA),0) = 0 THEN '0.00' WHEN (A.GRAVADA+A.INAFECTA) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR((A.GRAVADA+A.INAFECTA),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((A.GRAVADA+A.INAFECTA),'9999999990D99')),',','.') END),(CASE  WHEN (A.GRAVADA_ME+A.INAFECTA_ME) = 0 THEN '0.00' WHEN (A.GRAVADA_ME+A.INAFECTA_ME) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR((A.GRAVADA_ME+A.INAFECTA_ME),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((A.GRAVADA_ME+A.INAFECTA_ME),'9999999990D99')),',','.') END))|| 
        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		'|'||'0.00'||  -- total descuento, va 0.00 porque 
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
        '|'||'1000'|| 
        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM VENTA A, VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA   
        AND A.ID_VENTA = P_ID_VENTA 
        AND B.IMPORTE > 0
        AND A.ESTADO = 1 		
       UNION ALL 
 SELECT  'DF'||	'|'||ROWNUM||
			'|'||''|| 
            (SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
			-- '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)||
            '|86121503'|| 
			'|'||'NIU'|| 
			'|'||trim(to_char(b.cantidad,'990.99'))|| 
			'|'||nvl(b.detalle,'Venta')|| 
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IMPORTE,0) = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
			'|'||b.ID_TIPOIGV|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN TO_CHAR(B.PRECIO_BASE,'9999999990.00') ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.PRECIO_BASE_ME,'9999999990.00') ELSE '0.00' END))||    
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.PRECIO_BASE,0),4)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.PRECIO_BASE,0),4) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.PRECIO_BASE,0),4),'90D9999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.PRECIO_BASE,0),4),'9999999990D9999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.PRECIO_BASE_ME,0),4)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.PRECIO_BASE_ME,0),4) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.PRECIO_BASE_ME,0),4),'90D9999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.PRECIO_BASE_ME,0),4),'9999999990D9999')),',','.') END))|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END))||
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.IMPORTE,0) = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END))||			
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
            '|'||''|| 
			'|'||''||
			'|' DET 			
        FROM VENTA A, VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA  
        AND B.IMPORTE > 0
        AND A.ESTADO = 1;

         END IF;
         
        -- open VENTA;
        fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                --S_DETALLE :='';
            END IF;

            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	

        RETURN(TO_CLOB(S_DETALLE));
    END;


    FUNCTION FC_NOTA_CREDITO(P_ID_VENTA IN NUMBER) RETURN VARCHAR2 IS
        S_DETALLE       VARCHAR2(4000);
        S_VENTA         VARCHAR2(4000);
        S_CONTA         INT;
        S_ID_RUC      VARCHAR2(20);

        CURSOR VENTA IS
    SELECT 'CC'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'07'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		'|'||S_ID_RUC|| 
		--'|'||decode(SUBSTR(a.serie_ref,1,1),'F','6','1')|| 
        '|'||(CASE WHEN SUBSTR(a.serie_ref,1,1) = 'F' THEN '6'
              WHEN LENGTH(FC_DOCUMENTO_CLIENTE(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))) =11 THEN '6'
              WHEN LENGTH(FC_DOCUMENTO_CLIENTE(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))) =8 THEN '1'
              ELSE '0'
              END)
        || 
    '|'||NVL(FC_DOCUMENTO_CLIENTE(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
    '|'||FC_NOMBRE_PERSONA(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		'|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Sin Direccion'),'-','')||
		'|'||''|| 
		-- '|'||trim(eliseo.FC_EMAIL(A.ID_CLIENTE))|| 
        '|'||trim(coalesce (FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.INAFECTA = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.EXONERADA = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
		'|'||'0.00'|| 
		'|'||decode(b.id_tipoigv,'40',DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END)),'0.00')||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.TOTAL = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.DESCUENTO = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.TOTAL = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
        '|'||'1000'|| 
        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
        '|'||decode(SUBSTR(a.serie_ref,1,1),'F','01','03')|| 
        '|'||a.serie_ref||'-'||a.numero_ref|| 
        '|'||'01'|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA   
        AND A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       UNION ALL 
 SELECT  'DC'||	'|'||ROWNUM||
			'|'||''|| 
            (SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
			-- '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
            '|86121503'|| 
			'|'||'NIU'|| 
			'|'||b.cantidad|| 
			'|'||nvl(b.detalle,'Venta')|| 
	    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.PRECIO_BASE = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.PRECIO = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.IGV = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
			'|'||b.ID_TIPOIGV|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.BASE = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.IGV = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN B.DESCUENTO >0 THEN TO_CHAR(B.BASE,'999999,9999.99') ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.BASE_ME,'999999,9999.99') ELSE '0.00' END))||    
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2),'9999999990D99')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2),'9999999990D99')),',','.') END))|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.DESCUENTO = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END))||
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.IMPORTE = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END))||			
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
            '|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;

     /*   SELECT 
                'CC'||'|'||'0101'||'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||'|'||A.ID_COMPROBANTE||'|'||A.SERIE||'-'||LPAD(A.NUMERO,8,0)||'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')||'|'||FC_EMPRESA_RUC(A.ID_ENTIDAD)||'|'||
                DECODE(FC_COMPROBANTE_VENTA(A.ID_VENTA),'01','6','1')||'|'||DECODE(FC_COMPROBANTE_VENTA(A.ID_VENTA),'01',PKG_PURCHASES.FC_RUC(A.ID_CLIENTE),FC_DOCUMENTO_CLIENTE(A.ID_CLIENTE))||'|'||
                INITCAP(FC_NOMBRE_PERSONA(A.ID_CLIENTE))||'|'||PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(A.ID_CLIENTE)||'|'||FC_PHONO(A.ID_CLIENTE)||'|'||FC_EMAIL(A.ID_CLIENTE)||'||||||'||
                REPLACE(FC_FORMATO_IMPORTE(A.IGV),',','.')||'|'||REPLACE(ABS(FC_FORMATO_IMPORTE(A.GRAVADA)),',','.')||'|'||REPLACE(FC_FORMATO_IMPORTE(A.IGV),',','.')||'|'||'0.00'||'|'||'0.00'||'|'||
                TO_CHAR(A.INAFECTA,'FM999999999990.00')||'|'||TO_CHAR(A.EXONERADA,'FM999999999990.00')||'|'||TO_CHAR(A.GRATUITA,'FM999999999990.00')||'|'||'0.00'||'|'||'0.00'||'|'||'0.00'||'|'||
                TO_CHAR(NVL(A.IMPORTE_ADESCONTAR,A.GRAVADA),'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_PORCENTAJE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_GLOBAL,0),'FM999999999990.00')||'|'||
                TO_CHAR(A.GRAVADA,'FM999999999990.00')||'|'||TO_CHAR(A.TOTAL,'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_GLOBAL+A.DESCUENTO,0),'FM999999999990.00')||'|'||'0.00'||'|'||
                TO_CHAR(A.TOTAL,'FM999999999990.00')||'|'||A.ID_LEYENDA||'|'||DECODE(A.ID_LEYENDA,'1000',INITCAP(FC_NUMERO_TEXTO(ABS(A.TOTAL))),FC_LEYENDA(A.ID_LEYENDA))||DECODE(A.ID_MONEDA,7,' Soles',' Dolares')||'|'||
                NVL(FC_COMPROBANTE_VENTA(A.ID_PARENT),A.ID_COMPROBANTE_REF)||'|'||NVL(FC_SERIE_VENTA(A.ID_PARENT),A.SERIE_REF)||'-'||NVL(FC_NUMERO_VENTA(A.ID_PARENT),NUMERO_REF)||'|'||A.ID_TIPONOTA||'|||||'
                AS CAB
        FROM VENTA A
        WHERE A.ID_VENTA = P_ID_VENTA
        AND A.ESTADO = '1'
        UNION ALL
        SELECT 
                'DC'||'|'||ITEM||'|'||FC_CODIGO_ARTICULO(B.ID_ARTICULO,'1')||'|'||FC_CODIGO_ARTICULO(B.ID_ARTICULO,'2')||'|'||NVL(FC_CODIGO_UNIDAD(B.ID_ALMACEN,B.ID_ARTICULO),'ZZ')||'|'||NVL(B.CANTIDAD,1)||'|'||
                NVL(PKG_INVENTORIES.FC_ARTICULO(B.ID_ARTICULO),B.DETALLE)||'|'||TO_CHAR(NVL(B.PRECIO_BASE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IGV,0),'FM999999999990.00')||'|'||B.ID_TIPOIGV||'|'||TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IGV,0),'FM999999999990.00')||'|0.00|0.00|0.00||'||'0.00|0.00|0.00|'||
                TO_CHAR(NVL(B.IMPORTE_ADESCONTAR,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.DESCUENTO_PORCENTAJE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.DESCUENTO,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|||'
                AS DET
        FROM VENTA A, VENTA_DETALLE B
        WHERE A.ID_VENTA = B.ID_VENTA
        AND A.ID_VENTA = P_ID_VENTA
        AND A.ESTADO = '1';*/
    BEGIN  
        S_CONTA:=0;

        SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
        WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
        AND E.ID_EMPRESA = M.ID_EMPRESA
        AND V.ID_VENTA = P_ID_VENTA;

        open VENTA;
        fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
            END IF;

            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	

        RETURN(TO_CLOB(S_DETALLE));
    END;

FUNCTION FC_NOTA_DEBITO(P_ID_VENTA IN NUMBER) RETURN VARCHAR2 IS
        S_DETALLE       VARCHAR2(4000);
        S_VENTA         VARCHAR2(4000);
        S_CONTA         INT;
        S_ID_RUC      VARCHAR2(20);

        CURSOR VENTA IS
    SELECT 'CD'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'08'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		'|'||S_ID_RUC|| 
		'|'||decode(SUBSTR(a.serie_ref,1,1),'F','6','1')|| 
    '|'||NVL(eliseo.FC_DOCUMENTO_CLIENTE(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
    '|'||eliseo.FC_NOMBRE_PERSONA(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		'|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Sin Direccion'),'-','')||
		'|'||''|| 
		-- '|'||trim(eliseo.FC_EMAIL(A.ID_CLIENTE))|| 
        '|'||trim(coalesce (FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.INAFECTA = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.EXONERADA = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
		'|'||'0.00'|| 
		'|'||decode(b.id_tipoigv,'40',DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END)),'0.00')||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.TOTAL = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.DESCUENTO = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN A.TOTAL = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
        '|'||'1000'|| 
        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
        '|'||decode(SUBSTR(a.serie_ref,1,1),'F','01','03')|| 
        '|'||a.serie_ref||'-'||a.numero_ref|| 
        '|'||'01'|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA   
        AND A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       UNION ALL 
 SELECT  'DD'||	'|'||ROWNUM||
			'|'||''|| 
            (SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
			-- '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
            '|86121503'|| 
			'|'||'NIU'|| 
			'|'||b.cantidad|| 
			'|'||nvl(b.detalle,'Venta')|| 
	    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.PRECIO_BASE = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.PRECIO = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.IGV = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
			'|'||b.ID_TIPOIGV|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.BASE = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.IGV = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN B.DESCUENTO >0 THEN TO_CHAR(B.BASE,'999999,9999.99') ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.BASE_ME,'999999,9999.99') ELSE '0.00' END))||    
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/NVL(B.BASE,0),2),'9999999990D99')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/NVL(B.BASE_ME,0),2),'9999999990D99')),',','.') END))|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.DESCUENTO = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END))||
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN B.IMPORTE = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END))||			
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
            '|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;

     /*   SELECT 
                'CC'||'|'||'0101'||'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||'|'||A.ID_COMPROBANTE||'|'||A.SERIE||'-'||LPAD(A.NUMERO,8,0)||'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')||'|'||FC_EMPRESA_RUC(A.ID_ENTIDAD)||'|'||
                DECODE(FC_COMPROBANTE_VENTA(A.ID_VENTA),'01','6','1')||'|'||DECODE(FC_COMPROBANTE_VENTA(A.ID_VENTA),'01',PKG_PURCHASES.FC_RUC(A.ID_CLIENTE),FC_DOCUMENTO_CLIENTE(A.ID_CLIENTE))||'|'||
                INITCAP(FC_NOMBRE_PERSONA(A.ID_CLIENTE))||'|'||PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(A.ID_CLIENTE)||'|'||FC_PHONO(A.ID_CLIENTE)||'|'||FC_EMAIL(A.ID_CLIENTE)||'||||||'||
                REPLACE(FC_FORMATO_IMPORTE(A.IGV),',','.')||'|'||REPLACE(ABS(FC_FORMATO_IMPORTE(A.GRAVADA)),',','.')||'|'||REPLACE(FC_FORMATO_IMPORTE(A.IGV),',','.')||'|'||'0.00'||'|'||'0.00'||'|'||
                TO_CHAR(A.INAFECTA,'FM999999999990.00')||'|'||TO_CHAR(A.EXONERADA,'FM999999999990.00')||'|'||TO_CHAR(A.GRATUITA,'FM999999999990.00')||'|'||'0.00'||'|'||'0.00'||'|'||'0.00'||'|'||
                TO_CHAR(NVL(A.IMPORTE_ADESCONTAR,A.GRAVADA),'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_PORCENTAJE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_GLOBAL,0),'FM999999999990.00')||'|'||
                TO_CHAR(A.GRAVADA,'FM999999999990.00')||'|'||TO_CHAR(A.TOTAL,'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_GLOBAL+A.DESCUENTO,0),'FM999999999990.00')||'|'||'0.00'||'|'||
                TO_CHAR(A.TOTAL,'FM999999999990.00')||'|'||A.ID_LEYENDA||'|'||DECODE(A.ID_LEYENDA,'1000',INITCAP(FC_NUMERO_TEXTO(ABS(A.TOTAL))),FC_LEYENDA(A.ID_LEYENDA))||DECODE(A.ID_MONEDA,7,' Soles',' Dolares')||'|'||
                NVL(FC_COMPROBANTE_VENTA(A.ID_PARENT),A.ID_COMPROBANTE_REF)||'|'||NVL(FC_SERIE_VENTA(A.ID_PARENT),A.SERIE_REF)||'-'||NVL(FC_NUMERO_VENTA(A.ID_PARENT),NUMERO_REF)||'|'||A.ID_TIPONOTA||'|||||'
                AS CAB
        FROM VENTA A
        WHERE A.ID_VENTA = P_ID_VENTA
        AND A.ESTADO = '1'
        UNION ALL
        SELECT 
                'DC'||'|'||ITEM||'|'||FC_CODIGO_ARTICULO(B.ID_ARTICULO,'1')||'|'||FC_CODIGO_ARTICULO(B.ID_ARTICULO,'2')||'|'||NVL(FC_CODIGO_UNIDAD(B.ID_ALMACEN,B.ID_ARTICULO),'ZZ')||'|'||NVL(B.CANTIDAD,1)||'|'||
                NVL(PKG_INVENTORIES.FC_ARTICULO(B.ID_ARTICULO),B.DETALLE)||'|'||TO_CHAR(NVL(B.PRECIO_BASE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IGV,0),'FM999999999990.00')||'|'||B.ID_TIPOIGV||'|'||TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IGV,0),'FM999999999990.00')||'|0.00|0.00|0.00||'||'0.00|0.00|0.00|'||
                TO_CHAR(NVL(B.IMPORTE_ADESCONTAR,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.DESCUENTO_PORCENTAJE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.DESCUENTO,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|||'
                AS DET
        FROM VENTA A, VENTA_DETALLE B
        WHERE A.ID_VENTA = B.ID_VENTA
        AND A.ID_VENTA = P_ID_VENTA
        AND A.ESTADO = '1';*/
    BEGIN  
        S_CONTA:=0;

        SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
        WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
        AND E.ID_EMPRESA = M.ID_EMPRESA
        AND V.ID_VENTA = P_ID_VENTA;

        open VENTA;
        fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
            END IF;

            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	

        RETURN(TO_CLOB(S_DETALLE));
    END;
    
     PROCEDURE SP_VENTA_ELECTRONICA_NUBE(P_ID_VENTA IN NUMBER) IS
        L_ID_ENTIDAD NUMBER;
        L_ID_DEPTO VARCHAR2(11);
        L_RUC VARCHAR2(11);
        L_ID_COMPROBANTE VARCHAR2(3);
        L_COD_ELECTRONICO VARCHAR2(3);
        L_SERIE VARCHAR2(4);
        L_NUMERO VARCHAR2(8);
        L_DET VARCHAR2(4000);
        L_EMISOR_ID NUMBER:=1; --EMPRESA CON RUC UPeU
        L_HASH VARCHAR2(50);
        L_ORIGENID NUMBER := 0;
        L_TIPOEMISORID VARCHAR2(20);

    BEGIN  
    
        
        select coalesce(max(origenid),0) into L_ORIGENID from eliseo.venta_electronica_nube
        where origenid = P_ID_VENTA;
    
        IF L_ORIGENID = 0 THEN 
        --IF 7 = 7 THEN 
        
            --SELECT ID_ENTIDAD,ID_DEPTO, ID_COMPROBANTE,SERIE,NUMERO INTO L_ID_ENTIDAD,L_ID_DEPTO,L_ID_COMPROBANTE,L_SERIE,L_NUMERO
            --FROM VENTA
            --WHERE ID_VENTA = P_ID_VENTA;
    
           	SELECT V.ID_ENTIDAD,V.ID_DEPTO, V.ID_COMPROBANTE,TC.COD_ELECTRONICO,V.SERIE,V.NUMERO 
			INTO L_ID_ENTIDAD,L_ID_DEPTO,L_ID_COMPROBANTE,L_COD_ELECTRONICO,L_SERIE,L_NUMERO
			FROM VENTA V
			INNER JOIN ELISEO.TIPO_COMPROBANTE TC ON V.ID_COMPROBANTE = TC.ID_COMPROBANTE
			WHERE ID_VENTA = P_ID_VENTA;--Agregado por Ulices
			
            SELECT B.ID_RUC, EMISORID, TIPOEMISORID INTO L_RUC, L_EMISOR_ID, L_TIPOEMISORID
            FROM CONTA_ENTIDAD A, CONTA_EMPRESA B
            WHERE A.ID_EMPRESA = B.ID_EMPRESA
            AND A.ID_ENTIDAD = L_ID_ENTIDAD;
    
            IF L_COD_ELECTRONICO = '03' OR L_COD_ELECTRONICO = '01' THEN
                SELECT TO_CLOB(PKG_SALES_FACTURACION.FC_VENTA(P_ID_VENTA)) INTO L_DET FROM DUAL;
            END IF;
            IF L_COD_ELECTRONICO = '07' THEN 
                SELECT TO_CLOB(PKG_SALES_FACTURACION.FC_NOTA_CREDITO(P_ID_VENTA)) INTO L_DET FROM DUAL;
            END IF;
            IF L_COD_ELECTRONICO = '08' THEN 
                SELECT TO_CLOB(PKG_SALES_FACTURACION.FC_NOTA_DEBITO(P_ID_VENTA)) INTO L_DET FROM DUAL;
            END IF;
            --FACTURACION ELECTRONICA LAMB
                        
            IF L_TIPOEMISORID = 'NUBE' THEN

                IF L_ID_ENTIDAD != 7922 THEN  -- Entidad prueba de iatec
                    NULL;
                    -- DESHABILITADO POR COBRO DE CUOTA EXTEMPORANEO ABRIL 2022
                     INSERT INTO VENTA_ELECTRONICA_NUBE(EMISORID,ORIGENID,FECHA,TIPO,NROCOMPROBANTE,COMPROBANTE,NOMBREARCHIVO, PROCESADO, ENVIADO)
                     VALUES(L_EMISOR_ID,P_ID_VENTA,SYSDATE,L_ID_COMPROBANTE,L_SERIE||'-'||L_NUMERO,L_DET,L_RUC||'-'||L_ID_COMPROBANTE||'-'||L_SERIE||'-'||L_NUMERO||'.txt', 0, 0);
                END IF;
                
            ELSE--UPEU -OTRO SERVER EFAC

                    --FACTURACION ELECTRONICA LAMB
                    INSERT INTO VENTA_ELECTRONICA(EMISORID,ORIGENID,FECHA,TIPO,NROCOMPROBANTE,COMPROBANTE,NOMBREARCHIVO)
                    VALUES(L_EMISOR_ID,P_ID_VENTA,SYSDATE,L_ID_COMPROBANTE,L_SERIE||'-'||L_NUMERO,L_DET,L_RUC||'-'||L_ID_COMPROBANTE||'-'||L_SERIE||'-'||L_NUMERO||'.txt');
                    --FACTURACION ELECTRONICA CONTAWEB
                    INSERT INTO UPEU_COMPROBANTE@DBL_ARON_APP(EMISORID,ORIGENID,FECHA,TIPO,NROCOMPROBANTE,COMPROBANTE,NOMBREARCHIVO)
                    VALUES(L_EMISOR_ID,P_ID_VENTA,SYSDATE,L_ID_COMPROBANTE,L_SERIE||'-'||L_NUMERO,L_DET,L_RUC||'-'||L_ID_COMPROBANTE||'-'||L_SERIE||'-'||L_NUMERO||'.txt');

            END IF;
            --HACEMOS UNA PAUSA DE 2 SEGUNDOS PARA DEVOLVER EL VALOR RESUMEN
            --PKG_SALES.SP_SLEEP(2);
            --APEX_UTIL.PAUSE(4);
            
        END IF;


    END SP_VENTA_ELECTRONICA_NUBE;
    
    
    PROCEDURE SP_VENTA_ELECTRONICA_UPEU(P_ID_VENTA IN NUMBER) IS
        L_ID_ENTIDAD NUMBER;
        L_ID_DEPTO VARCHAR2(11);
        L_RUC VARCHAR2(11);
        L_ID_COMPROBANTE VARCHAR2(3);
       	L_COD_ELECTRONICO varchar2(3);
        L_SERIE VARCHAR2(4);
        L_NUMERO VARCHAR2(8);
        L_DET VARCHAR2(4000);
        L_EMISOR_ID NUMBER:=1; --EMPRESA CON RUC UPeU
        L_HASH VARCHAR2(50);
        L_ORIGENID NUMBER := 0;
        L_TIPOEMISORID VARCHAR2(20);

    BEGIN  
    
        
        select coalesce(max(origenid),0) into L_ORIGENID from eliseo.venta_electronica_nube
        where origenid = P_ID_VENTA;
    
        IF L_ORIGENID = 0 THEN 
        --IF 7 = 7 THEN 
        
            /* SELECT 
                    ID_ENTIDAD,ID_DEPTO, ID_COMPROBANTE,SERIE,NUMERO INTO L_ID_ENTIDAD,L_ID_DEPTO,L_ID_COMPROBANTE,L_SERIE,L_NUMERO
            FROM VENTA
            WHERE ID_VENTA = P_ID_VENTA;*/
           
           SELECT V.ID_ENTIDAD,V.ID_DEPTO, V.ID_COMPROBANTE,TC.COD_ELECTRONICO,V.SERIE,V.NUMERO 
			INTO L_ID_ENTIDAD,L_ID_DEPTO,L_ID_COMPROBANTE,L_COD_ELECTRONICO,L_SERIE,L_NUMERO
			FROM VENTA V
			INNER JOIN ELISEO.TIPO_COMPROBANTE TC ON V.ID_COMPROBANTE = TC.ID_COMPROBANTE
			WHERE ID_VENTA = P_ID_VENTA;--Agregado por Ulices
    
            SELECT B.ID_RUC, EMISORID, TIPOEMISORID INTO L_RUC, L_EMISOR_ID, L_TIPOEMISORID
            FROM CONTA_ENTIDAD A, CONTA_EMPRESA B
            WHERE A.ID_EMPRESA = B.ID_EMPRESA
            AND A.ID_ENTIDAD = L_ID_ENTIDAD;
    
            IF L_COD_ELECTRONICO = '03' OR L_COD_ELECTRONICO = '01' THEN
                SELECT TO_CLOB(PKG_SALES_FACTURACION.FC_VENTA(P_ID_VENTA)) INTO L_DET FROM DUAL;
            END IF;
            IF L_COD_ELECTRONICO = '07' THEN 
                SELECT TO_CLOB(PKG_SALES_FACTURACION.FC_NOTA_CREDITO(P_ID_VENTA)) INTO L_DET FROM DUAL;
            END IF;
            IF L_COD_ELECTRONICO = '08' THEN 
                SELECT TO_CLOB(PKG_SALES_FACTURACION.FC_NOTA_DEBITO(P_ID_VENTA)) INTO L_DET FROM DUAL;
            END IF;
            --FACTURACION ELECTRONICA LAMB
                        
            IF L_TIPOEMISORID = 'UPEU' THEN

                    --FACTURACION ELECTRONICA LAMB
                    INSERT INTO VENTA_ELECTRONICA(EMISORID,ORIGENID,FECHA,TIPO,NROCOMPROBANTE,COMPROBANTE,NOMBREARCHIVO)
                    VALUES(L_EMISOR_ID,P_ID_VENTA,SYSDATE,L_ID_COMPROBANTE,L_SERIE||'-'||L_NUMERO,L_DET,L_RUC||'-'||L_ID_COMPROBANTE||'-'||L_SERIE||'-'||L_NUMERO||'.txt');
                    --FACTURACION ELECTRONICA CONTAWEB
                    INSERT INTO UPEU_COMPROBANTE@DBL_ARON_APP(EMISORID,ORIGENID,FECHA,TIPO,NROCOMPROBANTE,COMPROBANTE,NOMBREARCHIVO)
                    VALUES(L_EMISOR_ID,P_ID_VENTA,SYSDATE,L_ID_COMPROBANTE,L_SERIE||'-'||L_NUMERO,L_DET,L_RUC||'-'||L_ID_COMPROBANTE||'-'||L_SERIE||'-'||L_NUMERO||'.txt');

            END IF;
            --HACEMOS UNA PAUSA DE 2 SEGUNDOS PARA DEVOLVER EL VALOR RESUMEN
            --PKG_SALES.SP_SLEEP(2);
            --APEX_UTIL.PAUSE(4);
            
        END IF;


    END SP_VENTA_ELECTRONICA_UPEU;
    
    
PROCEDURE SP_VENTA_ELECTRONICA(P_ID_VENTA IN NUMBER) IS
        L_ID_ENTIDAD NUMBER;
        L_TIPOEMISORID VARCHAR2(20);

    BEGIN  

        SELECT 
                ID_ENTIDAD INTO L_ID_ENTIDAD
        FROM VENTA
        WHERE ID_VENTA = P_ID_VENTA;

        SELECT TIPOEMISORID INTO L_TIPOEMISORID
        FROM CONTA_ENTIDAD A, CONTA_EMPRESA B
        WHERE A.ID_EMPRESA = B.ID_EMPRESA
        AND A.ID_ENTIDAD = L_ID_ENTIDAD;

                    
        IF L_TIPOEMISORID = 'NUBE' THEN

            ELISEO.PKG_SALES_FACTURACION.SP_VENTA_ELECTRONICA_NUBE(P_ID_VENTA);
            
        ELSIF L_TIPOEMISORID = 'UPEU' THEN --UPEU -OTRO SERVER EFAC

            ELISEO.PKG_SALES_FACTURACION.SP_VENTA_ELECTRONICA_UPEU(P_ID_VENTA);
            
        ELSIF L_TIPOEMISORID = 'DESIS' THEN --UPEU -OTRO SERVER EFAC

            ELISEO.PKG_SALES_FACTURACION_DESIS.SP_VENTA_ELECTRONICA_DESIS(P_ID_VENTA);
        
        ELSIF L_TIPOEMISORID = 'BIZLINKS' THEN -- UPS BIZLINKS

            ELISEO.PKG_SALES_FACTURACION_BIZLINKS.SP_VENTA_ELECTRONICA(P_ID_VENTA);
        
        ELSE
            null;
        
        END IF;

    END SP_VENTA_ELECTRONICA;
       
    
    FUNCTION FC_CLIENTE_DIRECCION(P_ID_PERSONA IN NUMBER) RETURN VARCHAR2 IS
    L_DIRECCION VARCHAR2(1000);
    BEGIN
	    L_DIRECCION:='';
        SELECT Min(NVL(DIRECCION,'')) INTO L_DIRECCION
        FROM MOISES.PERSONA_DIRECCION
        WHERE ID_PERSONA = P_ID_PERSONA
        AND ID_TIPODIRECCION = 5;
        
        if L_DIRECCION is null then 
                SELECT Min(NVL(DIRECCION,'')) INTO L_DIRECCION
                FROM MOISES.PERSONA_DIRECCION
                WHERE ID_PERSONA = P_ID_PERSONA
                AND ID_TIPODIRECCION = 4;
        end if;
        
        RETURN (L_DIRECCION);
    END;
   
   
    FUNCTION FC_CLIENTE_UBIGEO(
    P_ID_PERSONA IN NUMBER,
    P_TIPO IN NUMBER DEFAULT 4 --1=DISTRITO;2=PROVINCIA;3=DEPARTAMENTO;4=UBIGEO COMPLETO
    ) RETURN VARCHAR2 IS
    L_UBIGEO VARCHAR2(5000);
    BEGIN
	    L_UBIGEO:='';
	    IF P_TIPO = 1 THEN 
	       	SELECT MIN(NVL(B.NOMBRE,'')) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
	        
	        IF L_UBIGEO IS NULL THEN 
	                SELECT MIN(NVL(B.NOMBRE,'')) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
	    ELSIF P_TIPO = 2 THEN 
	       	SELECT MIN(NVL(C.NOMBRE,'')) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
	        
	        IF L_UBIGEO IS NULL THEN 
	                SELECT MIN(NVL(C.NOMBRE,'')) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
	    ELSIF P_TIPO = 3 THEN 
	       	SELECT MIN(NVL(C.NOMBRE,'')) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			INNER JOIN MOISES.UBIGUEO C ON B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND C.PVCIA = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
				        
	        IF L_UBIGEO IS NULL THEN 
	                SELECT MIN(NVL(C.NOMBRE,'')) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					INNER JOIN MOISES.UBIGUEO C ON B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND C.PVCIA = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
	    ELSE 
	       	SELECT MIN(B.NOMBRE||', '||C.NOMBRE||', '||D.NOMBRE) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
			INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
			INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
			INNER JOIN MOISES.UBIGUEO D ON B.DEPTO = D.DEPTO  AND D.DITTO = '00' AND D.PVCIA = '00' AND B.ID_TIPOPAIS = D.ID_TIPOPAIS 
			WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 5;
				        
	        IF L_UBIGEO IS NULL THEN 
	                SELECT MIN(B.NOMBRE||', '||C.NOMBRE||', '||D.NOMBRE) INTO L_UBIGEO FROM MOISES.PERSONA_DIRECCION A 
					INNER JOIN MOISES.UBIGUEO B ON A.ID_UBIGEO = B.ID_UBIGEO 
					INNER JOIN MOISES.UBIGUEO C ON B.PVCIA  = C.PVCIA AND B.DEPTO = C.DEPTO  AND C.DITTO = '00' AND B.ID_TIPOPAIS = C.ID_TIPOPAIS 
					INNER JOIN MOISES.UBIGUEO D ON B.DEPTO = D.DEPTO  AND D.DITTO = '00' AND D.PVCIA = '00' AND B.ID_TIPOPAIS = D.ID_TIPOPAIS 
					WHERE A.ID_PERSONA = P_ID_PERSONA AND A.ES_ACTIVO = '1' AND A.ID_TIPODIRECCION = 4;
	        END IF;
        END IF;
        RETURN (L_UBIGEO);
    END;
    
END PKG_SALES_FACTURACION;