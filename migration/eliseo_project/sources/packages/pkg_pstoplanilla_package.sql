-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE        PKG_PSTOPLANILLA AS
/******************************************************************************
   NAME:       PKG_PSTOPLANILLA
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        19/07/2018      sotil.yarasca       1. Created this package.
******************************************************************************/

    
    PROCEDURE SP_GENERAR_PARAMETROS(P_ID_ANHO IN NUMBER);
    PROCEDURE SP_GENERAR_ESCALA_SUELDO(P_ID_ENTIDAD IN NUMBER,P_ID_DEPTO_PADRE IN VARCHAR2,P_ID_ANHO IN NUMBER);
    PROCEDURE SP_CONCEPTO_ACTVIDAD(P_AUXI_IDENTIFICADOR varchar2,P_ID_DEPTO_PADRE IN NUMBER);
    --PROCEDURE SP_AGREGAR_EMPLEADO(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_PERSONA NUMBER,P_ID_CONTRATO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ID_TIPOESTATUS NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_AGREGAR_EMPLEADO(P_ID_CARGO_PROCESO IN NUMBER,P_ID_PERSONA IN NUMBER,P_ID_TIPOCONTRATO NUMBER,P_ID_COND_LAB varchar2,P_DOCENTE_TC varchar2, P_ESHEXTRAS25 NUMBER,P_ESHEXTRAS35 NUMBER,P_ESHNOCTURNA NUMBER,P_ESHFERIADO NUMBER, P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_ACTUALIZAR_EMPLEADO(P_ID_PSTO_PLANILLA IN NUMBER, P_ID_CARGO_PROCESO IN NUMBER,P_ID_TIPOCONTRATO NUMBER,P_ID_COND_LAB varchar2,P_DOCENTE_TC varchar2, P_ESHEXTRAS25 NUMBER,P_ESHEXTRAS35 NUMBER,P_ESHNOCTURNA NUMBER,P_ESHFERIADO NUMBER, P_ANT_BASICO number,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    
    PROCEDURE SP_AGREGAR_PLANILLA_CARGO(P_ID_CARGOSUELDO_ESCALA NUMBER,P_ID_DEPTO varchar2,P_ID_RENOVABLE varchar2,P_ID_SEXO number,P_ID_EDAD varchar2,P_ID_NIVEL_EDU varchar2,P_ID_TIPOESTADOCIVIL number,P_ID_TIEMPOTRABAJO number,P_ID_TEMPORADA varchar2,P_CANTIDAD number,P_ID_CARGO_PROCESO out number,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_ACTUALIZAR_PLANILLA_CARGO(P_ID_CARGO_PROCESO NUMBER,P_ID_RENOVABLE varchar2,P_ID_SEXO number,P_ID_EDAD varchar2,P_ID_NIVEL_EDU varchar2,P_ID_TIPOESTADOCIVIL number,P_ID_TIEMPOTRABAJO number,P_ID_TEMPORADA varchar2,P_CANTIDAD number,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    --PROCEDURE SP_GENERAR_PLANILLA(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_GENERAR_PLANILLA_DIST(P_ID_PSTO_PLANILLA NUMBER,P_ID_DEPTO VARCHAR2,P_ID_TEMPORADA VARCHAR2,P_PORCENTAJE NUMBER,P_TIPO VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_ACTUALIZAR_PLANILLA_DIST(P_ID_PLLA_PLANILLA_DIST NUMBER,P_ID_DEPTO VARCHAR2,P_ID_TEMPORADA VARCHAR2,P_PORCENTAJE NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_ELIMINAR_PLANILLA_DIST(P_ID_PLLA_PLANILLA_DIST NUMBER);
    PROCEDURE SP_GENERAR_PLANILLA_DIST_DET(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    --PROCEDURE SP_GENERAR_PLANILLA_CARGO(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    --PROCEDURE SP_ACTUALIZAR_PLANILLA_EMP_ANT(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2)
    PROCEDURE SP_ACTUALIZAR_PLANILLA_EMP(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    --PROCEDURE SP_ACTUALIZAR_PLANILLA(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2); 
    --PROCEDURE SP_GENERAR_PLANILLA_ACTIVIDAD(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_PLANILLA_PRESUPUESTO(P_ID_ENTIDAD NUMBER,P_ID_DEPTO_PADRE VARCHAR2,P_ID_ANHO NUMBER,P_ID_PERSONA NUMBER,P_ID_PSTONEGOCIO NUMBER,P_ID_EJE NUMBER,P_ID_AUXILIAR NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_GENERAR_PROCESO_MISIONERO(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) ;
    
    PROCEDURE SP_GEN_PSTO_DET_DIST_PLLA(P_ID_PRESUPUESTO NUMBER);
    PROCEDURE SP_GENERAR_PLANILLA_DIST_EXCEL(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_NUM_DOC VARCHAR2,P_ID_DEPTO VARCHAR2,P_PORCENTAJE NUMBER,P_TIPO VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
    PROCEDURE SP_REPROCESAR_PLANILLA(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO_PADRE VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
END PKG_PSTOPLANILLA;


CREATE OR REPLACE PACKAGE BODY        PKG_PSTOPLANILLA AS
/******************************************************************************
   NAME:       PKG_PSTOPLANILLA
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        19/07/2018      sotil.yarasca       1. Created this package.
******************************************************************************/

    
 
    PROCEDURE SP_GENERAR_PARAMETROS(P_ID_ANHO IN NUMBER) IS
        CURSOR cur IS select  ID_PARAMETRO,   FORMULA from psto_plla_parametros ORDER BY orden;
        l_id_parametro varchar2(25);
        l_formula varchar2(200);
        l_importe number(20,14);
        l_contar number;
  
        CURSOR cur1 IS select  ID_PARAMETRO,   EJE_FORMULA from psto_plla_parametros_valor where ID_ANHO=P_ID_ANHO AND EJE_FORMULA is not null ORDER BY ID_PARAMETRO;
        BEGIN
        
            INSERT INTO psto_plla_parametros_valor(ID_PARAMETRO,ID_ANHO,EJE_FORMULA,IMPORTE)
              select  ID_PARAMETRO, P_ID_ANHO,  FORMULA,  IMPORTE 
              from psto_plla_parametros
              WHERE ID_PARAMETRO NOT IN(
                SELECT ID_PARAMETRO FROM psto_plla_parametros_valor
                WHERE ID_ANHO=P_ID_ANHO
              ) ORDER BY orden;
              
              
              
              MERGE INTO psto_plla_parametros_valor C
              USING(
                SELECT 
                A.ID_PARAMETRO,
                B.FORMULA,
                A.ID_ANHO,
                B.IMPORTE,
                a.importe as importe_val
                FROM psto_plla_parametros_valor A,psto_plla_parametros B
                WHERE A.ID_PARAMETRO=B.ID_PARAMETRO
                AND A.ID_ANHO=P_ID_ANHO
              )t ON (C.ID_PARAMETRO=t.ID_PARAMETRO AND C.ID_ANHO=t.ID_ANHO and C.ID_ANHO=P_ID_ANHO)
              WHEN  MATCHED THEN UPDATE SET  C.EJE_FORMULA=t.FORMULA,C.IMPORTE=case when coalesce(t.importe_val,0)<>0 then t.importe_val  else t.IMPORTE end;
              
              
              
              OPEN cur;
                FETCH cur INTO l_id_parametro,l_formula;
                
                WHILE cur%FOUND LOOP
                       
             
                  
                  select IMPORTE into l_importe from psto_plla_parametros_valor
                  where ID_PARAMETRO=l_id_parametro
                  and ID_ANHO=P_ID_ANHO;
                  
                  
                  select count(*) into l_contar from psto_plla_parametros_valor
                  where EJE_FORMULA LIKE '%'||l_id_parametro||'%'
                  and ID_ANHO=P_ID_ANHO
                  AND EJE_FORMULA IS NOT NULL;
                  
                 
                  IF l_contar>0 THEN

                    UPDATE psto_plla_parametros_valor
                    SET EJE_FORMULA=REPLACE(EJE_FORMULA,l_id_parametro,REPLACE(TO_CHAR(l_importe),',','.'))
                    WHERE EJE_FORMULA LIKE '%'||l_id_parametro||'%'
                    AND ID_ANHO=P_ID_ANHO
                    AND EJE_FORMULA IS NOT NULL;


                  END IF;

                  FETCH cur INTO l_id_parametro,l_formula;
                  
                 END LOOP;
                CLOSE cur;
                
                
                --ejecutar
                OPEN cur1;
                FETCH cur1 INTO l_id_parametro,l_formula;
                
                WHILE cur1%FOUND LOOP
                
                    EXECUTE IMMEDIATE 'UPDATE psto_plla_parametros_valor SET IMPORTE='||l_formula||' WHERE ID_PARAMETRO=:PARAMETRO AND ID_ANHO=:ANHO'  
                    USING l_id_parametro,P_ID_ANHO;
                
                FETCH cur1 INTO l_id_parametro,l_formula;
                  
                END LOOP;
                CLOSE cur1;
           
        END SP_GENERAR_PARAMETROS;
        
        PROCEDURE SP_GENERAR_ESCALA_SUELDO(P_ID_ENTIDAD IN NUMBER,P_ID_DEPTO_PADRE IN VARCHAR2,P_ID_ANHO IN NUMBER) IS
            l_id_cargosuledo_escala number;
            l_contar number;
            l_anho number;
            l_mes number;
            l_rmv number(20,14);
          BEGIN
          
            select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
            select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
            
            select IMPORTE INTO l_rmv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_RMV' AND ID_ANHO=P_ID_ANHO;
            
            SELECT COALESCE(MAX(ID_CARGOSUELDO_ESCALA),0) INTO l_contar FROM PSTO_PLLA_CARGOSUELDO_ESCALA;
            
            INSERT INTO PSTO_PLLA_CARGOSUELDO_ESCALA(
                ID_CARGOSUELDO_ESCALA,
                ID_ANHO,
                ID_ENTIDAD,
                ID_DEPTO_PADRE,
                ID_CARGO,
                BONO_MIN,
                BONO_MAX,
                VIA_MIN,
                VIA_MAX,
                ID_CONDICION_ESCALA,
                TIPO_MIN,
                TIPO_MAX,
                MINIMO,
                MAXIMO
            )
            SELECT 
                ROWNUM + l_contar AS ID_CARGOSUELDO_ESCALA,
                P_ID_ANHO,
                P_ID_ENTIDAD,
                P_ID_DEPTO_PADRE,
                X.ID_CARGO,
                0 AS BONO_MIN,
                0 AS BONO_MAX,
                0 AS VIA_MIN,
                0 AS VIA_MAX,
                x.ID_CONDICION_ESCALA,
                null,--case when x.ID_CONDICION_ESCALA='P' then '1' else null end,
                null,--case when x.ID_CONDICION_ESCALA='P' then '1' else null end,
                null,--case when x.ID_CONDICION_ESCALA='P' then l_rmv else 0 end,
                null--case when x.ID_CONDICION_ESCALA='P' then l_rmv else 0 end
                FROM 
                (
                    SELECT 
                    COALESCE(a.ID_CARGO,p.ID_CARGO) AS ID_CARGO,
                    CASE WHEN a.ES_MISIONERO='1' then
                        'M'
                    else
                        CASE WHEN b.ID_TIPOCONTRATO=81 then
                              'P'
                        else
                          'C'
                        end 
                    end as ID_CONDICION_ESCALA,
                    COUNT(*) AS CANTIDAD
                    FROM  APS_PLANILLA a, APS_EMPLEADO b,APS_TRABAJADOR p
                    WHERE a.ID_PERSONA=b.ID_PERSONA
                    AND a.ID_CONTRATO=b.ID_CONTRATO
                    AND b.ID_PERSONA=p.ID_PERSONA
                    AND a.ID_ANHO=l_anho
                    AND a.ID_MES=l_mes
                    AND a.ID_ENTIDAD=P_ID_ENTIDAD
                    and COALESCE(a.ID_CARGO,p.ID_CARGO) is not null
                    AND COALESCE(a.ID_CARGO,p.ID_CARGO) NOT IN(
                        SELECT X.ID_CARGO FROM PSTO_PLLA_CARGOSUELDO_ESCALA X
                        WHERE X.ID_ANHO=P_ID_ANHO
                        AND X.ID_ENTIDAD=P_ID_ENTIDAD
                        AND X.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
                        AND X.ID_CONDICION_ESCALA=(CASE WHEN a.ES_MISIONERO='1' then
                                                'M'
                                            else
                                                CASE WHEN b.ID_TIPOCONTRATO=81 then
                                                      'P'
                                                else
                                                  'C'
                                                end 
                                            end)
                    )
                    GROUP BY 
                    COALESCE(a.ID_CARGO,p.ID_CARGO),
                    CASE WHEN a.ES_MISIONERO='1' then
                        'M'
                    else
                        CASE WHEN b.ID_TIPOCONTRATO=81 then
                              'P'
                        else
                          'C'
                        end 
                    end
                    ORDER BY COALESCE(a.ID_CARGO,p.ID_CARGO)
            )X;
            
        END SP_GENERAR_ESCALA_SUELDO;
        
        PROCEDURE SP_CONCEPTO_ACTVIDAD(P_AUXI_IDENTIFICADOR varchar2,P_ID_DEPTO_PADRE IN NUMBER) IS

          l_contar number;
          l_id_evento number;
          l_id_auxiliar number;
        BEGIN
        
          SELECT COALESCE(MAX(ID_CONCEPTO_ACTIVIDAD),0) INTO l_contar FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD;
          
          select ID_AUXILIAR  into l_id_auxiliar from PSTO_AUXILIAR 
          where IDENTIFICADOR=P_AUXI_IDENTIFICADOR
          AND ID_DEPTO=P_ID_DEPTO_PADRE;
          
          select id_evento  into l_id_evento from psto_evento 
          where id_auxiliar=l_id_auxiliar;
          
        
          INSERT INTO PSTO_PLLA_CONCEPTO_ACTIVIDAD(
            ID_CONCEPTO_ACTIVIDAD,
            ID_ACTIVIDAD,
            ID_DEPTO_PADRE,
            ID_CONCEPTOAPS,
            COLUMNA_IMP,
            FORMULA,
            AUXI_IDENTIFICADOR,
            ESTADO,
            DISTRIBUIDO
          )
          SELECT 
            ROWNUM + l_contar AS ID_CONCEPTO_ACTIVIDAD,
            M.ID_ACTIVIDAD, 
            P_ID_DEPTO_PADRE,
            NULL,
            NULL,
            NULL,
            P_AUXI_IDENTIFICADOR,
            '1',
            'S'
          FROM (
            SELECT 
            A.ID_ACTIVIDAD 
            FROM PSTO_ACTIVIDAD A
            WHERE A.ESTADO='1'
            AND ID_EVENTO=l_id_evento
            AND A.ID_ACTIVIDAD NOT IN(
              SELECT B.ID_ACTIVIDAD FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD B
              WHERE B.AUXI_IDENTIFICADOR=P_AUXI_IDENTIFICADOR
              AND B.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            ) ORDER BY A.ID_ACTIVIDAD
          )M;

        END SP_CONCEPTO_ACTVIDAD;
        
        /*PROCEDURE SP_AGREGAR_EMPLEADO(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_PERSONA NUMBER,P_ID_CONTRATO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ID_TIPOESTATUS NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_anho number;
          l_mes number;
          l_id_psto_planilla number;
          l_id_cargo NUMBER;
          l_id_tipocontrato number;
          l_finicio date;
          l_ftermino date;
          l_tipo_area varchar2(2);
          l_es_misionero varchar2(10);
          l_id_cond_lab varchar2(5);
          l_id_tiempotrabajo number;
          l_id_categoria number;
          l_id_tipoestatus number;
           CURSOR cur IS SELECT 
              c.COLUMNA_IMP,b.COS_VALOR
              FROM APS_PLANILLA a,APS_PLANILLA_DETALLE b,PSTO_PLLA_CONCE_PLANI_ANT c
              WHERE a.ID_ENTIDAD=b.ID_ENTIDAD
              AND a.ID_ANHO=b.ID_ANHO
              AND a.ID_MES=b.ID_MES
              AND a.ID_PERSONA=b.ID_PERSONA
              AND a.ID_CONTRATO=b.ID_CONTRATO
              AND b.ID_CONCEPTOAPS=c.ID_CONCEPTOAPS
              AND a.ID_ENTIDAD=P_ID_ENTIDAD
              AND a.ID_PERSONA=P_ID_PERSONA
              AND a.ID_CONTRATO=P_ID_CONTRATO
              AND a.ID_ANHO=l_anho
              AND a.ID_MES=l_mes
              AND c.estado='1';
        
        l_columna varchar2(60);
        l_importe number(10,2);
        l_nom_cargo varchar2(100);
              
        BEGIN
        
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
          
          
         
        
          SELECT COUNT(*) INTO l_contar
          FROM APS_PLANILLA 
          WHERE ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_PERSONA=P_ID_PERSONA
          AND ID_CONTRATO=P_ID_CONTRATO
          AND ID_ANHO=l_anho
          AND ID_MES=l_mes;
          
          if l_contar=1 then
          
            SELECT coalesce(max(ID_PSTO_PLANILLA),0)+1 INTO l_id_psto_planilla  FROM PSTO_PLLA_PLANILLA;
            
            
            SELECT ID_CARGO,ES_MISIONERO,NOM_CARGO INTO l_id_cargo,l_es_misionero,l_nom_cargo
            FROM APS_PLANILLA 
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND ID_PERSONA=P_ID_PERSONA
            AND ID_CONTRATO=P_ID_CONTRATO
            AND ID_ANHO=l_anho
            AND ID_MES=l_mes;
            
            
            if l_id_cargo is null then
              select id_cargo,id_categoria into l_id_cargo,l_id_categoria from  aps_trabajador  where id_persona=P_ID_PERSONA;
            else
              select count(*) into l_contar from aps_cargo where id_cargo=l_id_cargo;
              if l_contar=0 then
                insert into aps_cargo(id_cargo,nombre,estado) values(l_id_cargo,l_nom_cargo,'1');
              end if;
              update aps_trabajador set id_cargo=l_id_cargo where id_persona=P_ID_PERSONA;
            end if;
            
            
            select TIPO into  l_tipo_area from PSTO_AREA_DEPTO where id_entidad= P_ID_ENTIDAD and id_depto=P_ID_DEPTO;
            
            SELECT ID_TIPOCONTRATO,FEC_INICIO,FEC_TERMINO INTO l_id_tipocontrato,l_finicio, l_ftermino
            FROM APS_EMPLEADO
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND ID_PERSONA=P_ID_PERSONA
            AND ID_CONTRATO=P_ID_CONTRATO;
            
            
            if l_es_misionero='1' then
                l_id_cond_lab:='M';
            else
                if l_id_tipocontrato=1 then
                  l_id_cond_lab:='E';
                elsif l_id_tipocontrato=81 then
                  l_id_cond_lab:='P';
                else
                  l_id_cond_lab:='C';
                end if;
            end if;
            
            l_id_tiempotrabajo:=1;
            if l_id_tipocontrato=2 then
              l_id_tiempotrabajo:=2;
            end if;
            
            SELECT COUNT(*) INTO l_contar
            FROM PSTO_PLLA_PLANILLA 
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND ID_PERSONA=P_ID_PERSONA
            AND ID_ANHO=l_anho;
            
            if l_contar=0 then
          
              INSERT INTO PSTO_PLLA_PLANILLA(
                  ID_PSTO_PLANILLA,
                  ID_ANHO,
                  ID_ENTIDAD,
                  ID_PERSONA,
                  ID_DEPTO,
                  ID_DEPTO_PADRE,
                  ID_AUXILIAR,
                  ID_CARGO,
                  ID_TIPOCONTRATO,
                  TIPO_AREA,
                  FINICIO,
                  FFIN,
                  ID_COND_LAB,
                  ID_TIEMPOTRABAJO,
                  UNIFORME,
                  ID_CATEGORIA
                  
              )VALUES(
                  l_id_psto_planilla,
                  P_ID_ANHO,
                  P_ID_ENTIDAD,
                  P_ID_PERSONA,
                  P_ID_DEPTO,
                  P_ID_DEPTO_PADRE,
                  P_ID_AUXILIAR,
                  l_id_cargo,
                  l_id_tipocontrato,
                  l_tipo_area,
                  l_finicio,
                  l_ftermino,
                  l_id_cond_lab,
                  l_id_tiempotrabajo,
                  'N',
                  l_id_categoria
                     
              );
              
              OPEN cur;
              FETCH cur INTO l_columna,l_importe;
                
              WHILE cur%FOUND LOOP
              
                  EXECUTE IMMEDIATE 'UPDATE PSTO_PLLA_PLANILLA SET '||l_columna||'='||replace(to_char(l_importe),',','.')||' WHERE ID_PSTO_PLANILLA=:PARAMETRO'  
                  USING l_id_psto_planilla;
                
                FETCH cur INTO l_columna,l_importe;
                  
              END LOOP;
              CLOSE cur;
              
              
            else
              l_error:=1;
              l_msgerror:='Ya esta asignado el personal para el periodo '||to_char(P_ID_ANHO);
            end if;
           
            
          elsif(l_contar>1) then
            l_error:=1;
            l_msgerror:='AGREGAR_EMPLEADO: Dos(2) registros para el mismo año y mes ';
           
          end if;
      
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

        END SP_AGREGAR_EMPLEADO;*/
        
        PROCEDURE SP_AGREGAR_EMPLEADO(P_ID_CARGO_PROCESO IN NUMBER,P_ID_PERSONA IN NUMBER,P_ID_TIPOCONTRATO NUMBER,P_ID_COND_LAB varchar2,P_DOCENTE_TC varchar2, P_ESHEXTRAS25 NUMBER,P_ESHEXTRAS35 NUMBER,P_ESHNOCTURNA NUMBER,P_ESHFERIADO NUMBER, P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;    
          l_msgerror varchar2(200):='';
          l_contar number;
          l_contar1 number;
          l_contareg number;
          l_anho number;
          l_mes number;
          l_id_psto_planilla number;
          l_id_cargo NUMBER;
          l_id_tipocontrato number;
          l_finicio date;
          l_ftermino date;
          l_tipo_area varchar2(2);
          l_es_misionero varchar2(10);
          l_id_cond_lab varchar2(5);
          
          l_columna varchar2(60);
          l_importe number(10,2);
  
          l_id_entidad number;
          l_id_anho number;
          l_id_depto number;
          l_id_depto_padre number;    
          l_id_cargosueldo_escala number;
          l_id_contrato number;
          l_minimo number(10,2);
          l_maximo number(10,2);
          l_actual number(10,2);
          l_id_condicion_escala varchar2(2);
          l_fmr number(10,2);
          l_id_temporada varchar2(2);
          
           l_imp_hextras25 number(10,2);
           l_imp_hextras35 number(10,2);
           l_imp_hnocturna number(10,2);
           l_imp_hferiado number(10,2);
           l_cal_meses NUMBER;
           l_id_persona number;

           CURSOR cur IS SELECT 
              c.COLUMNA_IMP,b.COS_VALOR
              FROM APS_PLANILLA a,APS_PLANILLA_DETALLE b,PSTO_PLLA_CONCE_PLANI_ANT c
              WHERE a.ID_ENTIDAD=b.ID_ENTIDAD
              AND a.ID_ANHO=b.ID_ANHO
              AND a.ID_MES=b.ID_MES
              AND a.ID_PERSONA=b.ID_PERSONA
              AND a.ID_CONTRATO=b.ID_CONTRATO
              AND b.ID_CONCEPTOAPS=c.ID_CONCEPTOAPS
              AND a.ID_ENTIDAD=l_id_entidad
              AND a.ID_PERSONA=P_ID_PERSONA
              --AND a.ID_CONTRATO=P_ID_CONTRATO
              AND a.ID_ANHO=l_anho
              AND a.ID_MES=l_mes
              AND c.estado='1';
        
        
        BEGIN
          l_id_persona:=P_ID_PERSONA;
          
          if l_id_persona=0 then
            l_id_persona:=null;
          end if;
          SELECT ID_ENTIDAD,ID_ANHO,ID_DEPTO,ID_DEPTO_PADRE,ID_CARGOSUELDO_ESCALA,ID_TEMPORADA
          INTO l_id_entidad,l_id_anho,l_id_depto,l_id_depto_padre,l_id_cargosueldo_escala,l_id_temporada
          FROM PSTO_PLLA_CARGO_PROCESO
          WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;
        
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=l_id_anho;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=l_id_anho;
          
          select CASE WHEN P_ESHEXTRAS25=1 THEN IMPORTE END INTO l_imp_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHEXTRAS35=1 THEN IMPORTE END INTO l_imp_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHNOCTURNA=1 THEN IMPORTE END INTO l_imp_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHFERIADO=1 THEN IMPORTE END  INTO l_imp_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;
          
          
          
          SELECT COUNT(*) INTO l_contareg
          FROM PSTO_PLLA_PLANILLA 
          WHERE ID_ENTIDAD=l_id_entidad
          AND ID_PERSONA=l_id_persona
          AND ID_ANHO=l_id_anho;
            
          if l_contareg=0 then

             select FC_PSTO_CALC_MES_TEMPORADA(l_id_temporada) into l_cal_meses from dual;
                       
             SELECT coalesce(max(ID_PSTO_PLANILLA),0)+1 INTO l_id_psto_planilla  FROM PSTO_PLLA_PLANILLA;
             
             select TIPO into  l_tipo_area from PSTO_AREA_DEPTO where id_entidad= l_id_entidad and id_depto=l_id_depto;
              
              insert into PSTO_PLLA_PLANILLA(
              ID_PSTO_PLANILLA,
              ID_ANHO,
              ID_ENTIDAD,
              ID_DEPTO_PADRE,
              ID_PERSONA,
              ID_CATEGORIA,
              ID_DEPTO,
              ID_CARGO,
              ID_TIPOCONTRATO,
              UNIFORME,
              DOCENTE_TC,
              TIPO_AREA,
              FINICIO,
              FFIN,
              ID_COND_LAB,
              ID_TIEMPOTRABAJO,
              ID_TEMPORADA,
              ID_CARGO_PROCESO,
              ESHEXTRAS25,
              ESHEXTRAS35,
              ESHNOCTURNA,
              ESHFERIADO,
              IMP_HEXTRAS25,
              IMP_HEXTRAS35,
              IMP_HNOCTURNA,
              IMP_HFERIADO,
              CAL_MESES
              )
              SELECT 
              l_id_psto_planilla,
              ID_ANHO,
              ID_ENTIDAD,
              ID_DEPTO_PADRE,
              l_id_persona,
              NULL,
              ID_DEPTO,
              ID_CARGO,
              P_ID_TIPOCONTRATO,
              'N',
              P_DOCENTE_TC,
              l_tipo_area,
              NULL,
              NULL,
              P_ID_COND_LAB,
              ID_TIEMPOTRABAJO,
              ID_TEMPORADA,
              ID_CARGO_PROCESO,
              P_ESHEXTRAS25,
              P_ESHEXTRAS35,
              P_ESHNOCTURNA,
              P_ESHFERIADO,
              l_imp_hextras25,
              l_imp_hextras35,
              l_imp_hnocturna,
              l_imp_hferiado,
              l_cal_meses
              FROM PSTO_PLLA_CARGO_PROCESO
              WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;
                            
              SELECT COUNT(*) INTO l_contar
              FROM APS_PLANILLA 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_PERSONA=l_id_persona
              --AND ID_CONTRATO=P_ID_CONTRATO
              AND ID_ANHO=l_anho
              AND ID_MES=l_mes;
              
              if l_contar=1 then
                OPEN cur;
                FETCH cur INTO l_columna,l_importe;
                  
                WHILE cur%FOUND LOOP
                
                    EXECUTE IMMEDIATE 'UPDATE PSTO_PLLA_PLANILLA SET '||l_columna||'='||replace(to_char(l_importe),',','.')||' WHERE ID_PSTO_PLANILLA=:PARAMETRO'  
                    USING l_id_psto_planilla;
                  
                  FETCH cur INTO l_columna,l_importe;
                    
                END LOOP;
                CLOSE cur;
                
                
                select coalesce(minimo,0),coalesce(maximo,0),l_id_condicion_escala into l_minimo, l_maximo,l_id_condicion_escala from PSTO_PLLA_CARGOSUELDO_ESCALA where ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;
                
                select IMP_BASICO into l_actual from PSTO_PLLA_PLANILLA where ID_PSTO_PLANILLA=l_id_psto_planilla;
                
                if P_ID_COND_LAB='M' then
                  /*if l_minimo>0 and l_maximo>0 then
                    if l_actual<l_minimo and l_actual>l_maximo then
                      l_error:=0;
                     -- l_msgerror:='Haber Básico Actual '||replace(to_char(l_actual),',','.')|| ' escala salarial MIN: '||replace(to_char(l_minimo),',','.')||' MAX: '||replace(to_char(l_maximo),',','.');
                    end if;
                  end if;
                else*/
                
                  
                  SELECT count(*) INTO l_contar
                  FROM PSTO_PLLA_PUNTAJE_MIS 
                  WHERE ID_ENTIDAD=l_id_entidad
                  AND ID_PERSONA=l_id_persona
                  AND ID_ANHO=l_id_anho;
                  
                  if l_contar=1 then
                    SELECT punt_aprobado INTO l_fmr
                    FROM PSTO_PLLA_PUNTAJE_MIS 
                    WHERE ID_ENTIDAD=l_id_entidad
                    AND ID_PERSONA=l_id_persona
                     AND ID_ANHO=l_id_anho;
                
                    UPDATE PSTO_PLLA_PLANILLA SET FMR=l_fmr
                    where ID_PSTO_PLANILLA=l_id_psto_planilla;
                  end if;
                end if;
              else
                select maximo into l_importe from PSTO_PLLA_CARGOSUELDO_ESCALA where ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;
                
                UPDATE PSTO_PLLA_PLANILLA SET ANT_BASICO=l_importe
                where ID_PSTO_PLANILLA=l_id_psto_planilla;
                
              end if;
              
              
              SP_ACTUALIZAR_PLANILLA_EMP(l_id_psto_planilla,l_error,l_msgerror);
              
              SP_GENERAR_PLANILLA_DIST(l_id_psto_planilla,l_id_depto,l_id_temporada,100,'1',l_error,l_msgerror);
              
          else  
          
            l_error:=1;
            l_msgerror:='Ya esta asignado el personal para el periodo '||to_char(l_anho);
            
          end if;
      
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

        END SP_AGREGAR_EMPLEADO;
        
        PROCEDURE SP_ACTUALIZAR_EMPLEADO(P_ID_PSTO_PLANILLA IN NUMBER, P_ID_CARGO_PROCESO IN NUMBER,P_ID_TIPOCONTRATO NUMBER,P_ID_COND_LAB varchar2,P_DOCENTE_TC varchar2, P_ESHEXTRAS25 NUMBER,P_ESHEXTRAS35 NUMBER,P_ESHNOCTURNA NUMBER,P_ESHFERIADO NUMBER, P_ANT_BASICO number,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;    
          l_msgerror varchar2(200):='';
          l_contar number;

          l_anho number;
          l_mes number;
          l_id_cargo NUMBER;
          l_id_tipocontrato number;
          l_tipo_area varchar2(2);
          l_es_misionero varchar2(10);
          l_id_cond_lab varchar2(5);
          

  
          l_id_entidad number;
          l_id_anho number;
          l_id_depto number;
          l_id_depto_padre number;    
          l_id_cargosueldo_escala number;
          l_id_condicion_escala varchar2(2);
          l_id_temporada varchar2(2);
          
           l_imp_hextras25 number(10,2);
           l_imp_hextras35 number(10,2);
           l_imp_hnocturna number(10,2);
           l_imp_hferiado number(10,2);
            l_cal_meses NUMBER;
           l_tiempotrabajo NUMBER;
           l_porcentaje number(10,2);
           l_actual  number(10,2);
           l_minimo number(10,2); 
           l_maximo number(10,2);
           l_id_persona number;
           
           l_fmr number(10,2);
        
        BEGIN
        
          SELECT ID_ENTIDAD,ID_ANHO,ID_DEPTO,ID_DEPTO_PADRE,ID_CARGOSUELDO_ESCALA,ID_TEMPORADA,ID_TIEMPOTRABAJO
          INTO l_id_entidad,l_id_anho,l_id_depto,l_id_depto_padre,l_id_cargosueldo_escala,l_id_temporada,l_tiempotrabajo
          FROM PSTO_PLLA_CARGO_PROCESO
          WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;
        
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=l_id_anho;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=l_id_anho;
          
          select CASE WHEN P_ESHEXTRAS25=1 THEN IMPORTE END INTO l_imp_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHEXTRAS35=1 THEN IMPORTE END INTO l_imp_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHNOCTURNA=1 THEN IMPORTE END INTO l_imp_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select CASE WHEN P_ESHFERIADO=1 THEN IMPORTE END  INTO l_imp_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;
          
          
           select FC_PSTO_CALC_MES_TEMPORADA(l_id_temporada) into l_cal_meses from dual;
                       

          select TIPO into  l_tipo_area from PSTO_AREA_DEPTO where id_entidad= l_id_entidad and id_depto=l_id_depto;
          
          
          SELECT ID_PERSONA INTO l_id_persona FROM PSTO_PLLA_PLANILLA WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
              
          
          UPDATE PSTO_PLLA_PLANILLA  SET 
              ID_TIPOCONTRATO=P_ID_TIPOCONTRATO,
              DOCENTE_TC=P_DOCENTE_TC,
              TIPO_AREA=l_tipo_area,
              ID_COND_LAB=P_ID_COND_LAB,
              ID_TIEMPOTRABAJO=l_tiempotrabajo,
              ID_TEMPORADA=l_id_temporada,
              ESHEXTRAS25=P_ESHEXTRAS25,
              ESHEXTRAS35=P_ESHEXTRAS35,
              ESHNOCTURNA=P_ESHNOCTURNA,
              ESHFERIADO=P_ESHFERIADO,
              IMP_HEXTRAS25=l_imp_hextras25,
              IMP_HEXTRAS35=l_imp_hextras35,
              IMP_HNOCTURNA=l_imp_hnocturna,
              IMP_HFERIADO=l_imp_hferiado,
              CAL_MESES=l_cal_meses,
              ANT_BASICO=P_ANT_BASICO
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
          
          select coalesce(minimo,0),coalesce(maximo,0),l_id_condicion_escala into l_minimo, l_maximo,l_id_condicion_escala from PSTO_PLLA_CARGOSUELDO_ESCALA where ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;
                
            select IMP_BASICO into l_actual from PSTO_PLLA_PLANILLA where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
            
            if P_ID_COND_LAB='M' then
              /*if l_minimo>0 and l_maximo>0 then
                if l_actual<l_minimo and l_actual>l_maximo then
                  l_error:=0;
                 -- l_msgerror:='Haber Básico Actual '||replace(to_char(l_actual),',','.')|| ' escala salarial MIN: '||replace(to_char(l_minimo),',','.')||' MAX: '||replace(to_char(l_maximo),',','.');
                end if;
              end if;
            else*/
            
              SELECT count(*) INTO l_contar
                  FROM PSTO_PLLA_PUNTAJE_MIS 
                  WHERE ID_ENTIDAD=l_id_entidad
                  AND ID_PERSONA=l_id_persona
                  AND ID_ANHO=l_id_anho;
                  
              if l_contar=1 then
              
              SELECT punt_aprobado INTO l_fmr
              FROM PSTO_PLLA_PUNTAJE_MIS 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_PERSONA=l_id_persona
               AND ID_ANHO=l_id_anho;
          
              UPDATE PSTO_PLLA_PLANILLA SET FMR=l_fmr
              where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
              end if;
            end if;
        
          
                    
         SP_ACTUALIZAR_PLANILLA_EMP(P_ID_PSTO_PLANILLA,l_error,l_msgerror);
         
         
          select PORCENTAJE into  l_porcentaje from PSTO_PLLA_PLANILLA_DIST 
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA 
          AND TIPO='1';
              
         SP_GENERAR_PLANILLA_DIST(P_ID_PSTO_PLANILLA,l_id_depto,l_id_temporada,l_porcentaje,'1',l_error,l_msgerror);
              
      
      
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

        END SP_ACTUALIZAR_EMPLEADO;
        
        /*PROCEDURE SP_GENERAR_PLANILLA(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_id_persona number;
          l_id_contrato number;
          l_id_tipoestatus number;
          l_anho number;
          l_mes number;
          
          CURSOR cur IS SELECT 
              ID_PERSONA,ID_CONTRATO,ID_TIPOESTATUS
              FROM APS_PLANILLA 
              WHERE ID_ENTIDAD=P_ID_ENTIDAD
              AND ID_DEPTO=P_ID_DEPTO
              AND ID_ANHO=l_anho
              AND ID_MES=l_mes;
              
        BEGIN
          
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
          
          OPEN cur;
          FETCH cur INTO l_id_persona,l_id_contrato,l_id_tipoestatus;
                
          WHILE cur%FOUND LOOP
          
            SELECT COUNT(*) INTO l_contar
            FROM PSTO_PLLA_PLANILLA 
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND ID_PERSONA=l_id_persona
            AND ID_ANHO=P_ID_ANHO;
            
            if l_contar=0 then  
              
              PKG_PSTOPLANILLA.SP_AGREGAR_EMPLEADO(P_ID_ENTIDAD,P_ID_ANHO,l_id_persona,l_id_contrato,P_ID_DEPTO,P_ID_DEPTO_PADRE,P_ID_AUXILIAR ,l_id_tipoestatus,l_error,l_msgerror);
              
              IF l_error=1 THEN
                EXIT;
              END IF;
              
            END IF ;  
            
            FETCH cur INTO l_id_persona,l_id_contrato,l_id_tipoestatus;
                  
        END LOOP;   
        CLOSE cur;
        
        
        PKG_PSTOPLANILLA.SP_GENERAR_AYUDA_MOVLIBDIS(P_ID_ENTIDAD,P_ID_DEPTO_PADRE,P_ID_ANHO, P_ID_AUXILIAR,l_error,l_msgerror);
        
        
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_GENERAR_PLANILLA;
        
        */
        
        /*PROCEDURE SP_GENERAR_PLANILLA_CARGO(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_anho number;
          l_mes number;
          
          l_id_cargo_proceso number;

              
        BEGIN
          
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
          
          SELECT COALESCE(MAX(ID_CARGO_PROCESO),0) INTO l_contar FROM PSTO_PLLA_CARGO_PROCESO;
          
          insert into PSTO_PLLA_CARGO_PROCESO(
            ID_CARGO_PROCESO, 
            ID_ANHO,
            ID_ENTIDAD,
            ID_DEPTO,
            ID_DEPTO_PADRE,
            ID_CARGO,
            CANTIDAD
          )
          SELECT
          ROWNUM + l_contar AS ID_CARGO_PROCESO,
          P_ID_ANHO,
          P_ID_ENTIDAD,
          P_ID_DEPTO,
          P_ID_DEPTO_PADRE,
          X.ID_CARGO,
          X.CANTIDAD
          FROM(
          SELECT 
          COALESCE(a.ID_CARGO,p.ID_CARGO) AS ID_CARGO,
          COUNT(*) AS CANTIDAD
          FROM APS_PLANILLA a, APS_TRABAJADOR p
          WHERE a.ID_PERSONA=P.ID_PERSONA
          AND a.ID_ENTIDAD=P_ID_ENTIDAD
          AND a.ID_ANHO=l_anho
          AND a.ID_MES=l_mes
          AND a.ID_DEPTO=P_ID_DEPTO
          AND COALESCE(a.ID_CARGO,p.ID_CARGO) NOT IN(
            SELECT ID_CARGO FROM PSTO_PLLA_CARGO_PROCESO
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND  ID_DEPTO=P_ID_DEPTO
            AND  ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            AND  ID_ANHO=P_ID_ANHO
          )
          GROUP BY 
          COALESCE(a.ID_CARGO,p.ID_CARGO)
          ORDER BY COALESCE(a.ID_CARGO,p.ID_CARGO)
         )X;
        
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;
        END SP_GENERAR_PLANILLA_CARGO;
        */
        PROCEDURE SP_AGREGAR_PLANILLA_CARGO(P_ID_CARGOSUELDO_ESCALA NUMBER,P_ID_DEPTO varchar2,P_ID_RENOVABLE varchar2,P_ID_SEXO number,P_ID_EDAD varchar2,P_ID_NIVEL_EDU varchar2,P_ID_TIPOESTADOCIVIL number,P_ID_TIEMPOTRABAJO number,P_ID_TEMPORADA varchar2,P_CANTIDAD number,P_ID_CARGO_PROCESO out number,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_id_anho number;
          l_id_entidad number;
          l_id_depto varchar2(10);
          l_id_depto_padre varchar2(10);
          l_id_cargo number;
          l_id_renovable varchar2(10);
          l_id_sexo number;
          l_id_edad varchar2(10);
          l_id_nivel_edu varchar2(10);
          l_id_tipoestadocivil number;
          l_id_tiempotrabajo number;
          l_id_temporada varchar2(10);
          l_id_condicion_escala varchar2(10);
          
          l_id_cargo_proceso number;

        BEGIN
        
            l_id_depto:=P_ID_DEPTO;
        
            SELECT 
            ID_ANHO,
            ID_ENTIDAD,
            ID_DEPTO_PADRE,
            ID_CARGO,
            ID_CONDICION_ESCALA
            INTO 
            l_id_anho,
            l_id_entidad,
            l_id_depto_padre,
            l_id_cargo,
            l_id_condicion_escala
          FROM PSTO_PLLA_CARGOSUELDO_ESCALA
          WHERE ID_CARGOSUELDO_ESCALA=P_ID_CARGOSUELDO_ESCALA;
          
            SELECT 
                    COUNT(*) INTO l_contar
            FROM PSTO_PLLA_CARGO_PROCESO
            WHERE ID_ANHO=l_id_anho
            AND ID_ENTIDAD=l_id_entidad
            AND ID_DEPTO=l_id_depto
            AND ID_DEPTO_PADRE=l_id_depto_padre
            AND ID_CARGO=l_id_cargo
            AND coalesce(ID_RENOVABLE,'-')=P_ID_RENOVABLE
            AND coalesce(ID_SEXO,0)=P_ID_SEXO
            AND coalesce(ID_EDAD,'-')=P_ID_EDAD
            AND coalesce(ID_NIVEL_EDU,'-')=P_ID_NIVEL_EDU
            AND coalesce(ID_TIPOESTADOCIVIL,0)=P_ID_TIPOESTADOCIVIL
            AND coalesce(ID_TIEMPOTRABAJO,0)=P_ID_TIEMPOTRABAJO
            AND coalesce(ID_TEMPORADA,'-')=P_ID_TEMPORADA
            and ID_CARGOSUELDO_ESCALA=P_ID_CARGOSUELDO_ESCALA;
            
           IF l_contar=0 THEN 
          
          
            l_id_renovable:=P_ID_RENOVABLE;
            IF P_ID_RENOVABLE='-' THEN
              l_id_renovable:=NULL;
            END IF;
          
            l_id_sexo:=P_ID_SEXO;
            IF P_ID_SEXO=0 THEN
              l_id_sexo:=NULL;
            END IF;
            
            l_id_edad:=P_ID_EDAD;
            IF P_ID_EDAD='-' THEN
              l_id_edad:=NULL;
            END IF;
            
            l_id_nivel_edu:=P_ID_NIVEL_EDU;
            IF P_ID_NIVEL_EDU='-' THEN
              l_id_nivel_edu:=NULL;
            END IF;
            
            l_id_tipoestadocivil:=P_ID_TIPOESTADOCIVIL;
            IF P_ID_TIPOESTADOCIVIL=0 THEN
              l_id_tipoestadocivil:=NULL;
          END IF;
          
          l_id_tiempotrabajo:=P_ID_TIEMPOTRABAJO;
          IF P_ID_TIEMPOTRABAJO=0 THEN
            l_id_tiempotrabajo:=NULL;
          END IF;
          
          l_id_temporada:=P_ID_TEMPORADA;
          IF P_ID_TEMPORADA='-' THEN
            l_id_temporada:=NULL;
          END IF;
          
          if l_id_condicion_escala='M' then
            if l_id_renovable<>'R3' then
              l_error:=1;
              l_msgerror:='Dato renovable no Corresponde';
            else
              if l_id_temporada<>'T1' then
                l_error:=1;
                l_msgerror:='Dato Temporada no Corresponde';
              else
                if l_id_tiempotrabajo<>1 then
                  l_error:=1;
                  l_msgerror:='Dato Tiempo Trabajo no Corresponde';
                end if;
              end if;
            end if;
            
          end if;
          
          if l_error=0 then
            if l_id_renovable='R3' then
              if l_id_temporada<>'T1' then
                l_error:=1;
                l_msgerror:='Dato Temporada no Corresponde';
              else
                if l_id_tiempotrabajo<>1 then
                  l_error:=1;
                  l_msgerror:='Dato Tiempo Trabajo no Corresponde';
                end if;
              end if;
            end if;
          end if;
          
          if l_error=0 then
            SELECT COALESCE(MAX(ID_CARGO_PROCESO),0)+1 INTO l_id_cargo_proceso FROM PSTO_PLLA_CARGO_PROCESO;
            
            INSERT INTO PSTO_PLLA_CARGO_PROCESO(
              ID_CARGO_PROCESO,
              ID_ANHO,
              ID_ENTIDAD,
              ID_DEPTO,
              ID_DEPTO_PADRE,
              ID_CARGO,
              ID_RENOVABLE,
              ID_SEXO,
              ID_EDAD,
              ID_NIVEL_EDU,
              ID_TIPOESTADOCIVIL,
              ID_TIEMPOTRABAJO,
              ID_TEMPORADA,
              CANTIDAD,
              ID_CARGOSUELDO_ESCALA
            )values(
              l_id_cargo_proceso,
              l_id_anho,
              l_id_entidad,
              l_id_depto,
              l_id_depto_padre,
              l_id_cargo,
              l_id_renovable,
              l_id_sexo,
              l_id_edad,
              l_id_nivel_edu,
              l_id_tipoestadocivil,
              l_id_tiempotrabajo,
              l_id_temporada,
              P_CANTIDAD,
              P_ID_CARGOSUELDO_ESCALA
            );
        end if;  
         
        else
          l_error:=1;
          l_msgerror:='Ya esta registrado';
        end if;
          P_ID_CARGO_PROCESO:=l_id_cargo_proceso;
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;
          
        END SP_AGREGAR_PLANILLA_CARGO;
        
        PROCEDURE SP_ACTUALIZAR_PLANILLA_CARGO(P_ID_CARGO_PROCESO NUMBER,P_ID_RENOVABLE varchar2,P_ID_SEXO number,P_ID_EDAD varchar2,P_ID_NIVEL_EDU varchar2,P_ID_TIPOESTADOCIVIL number,P_ID_TIEMPOTRABAJO number,P_ID_TEMPORADA varchar2,P_CANTIDAD number,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_id_anho number;
          l_id_entidad number;
          l_id_depto varchar2(10);
          l_id_depto_padre varchar2(10);
          l_id_cargo number;
          l_id_renovable varchar2(10);
          l_id_sexo number;
          l_id_edad varchar2(10);
          l_id_nivel_edu varchar2(10);
          l_id_tipoestadocivil number;
          l_id_tiempotrabajo number;
          l_id_temporada varchar2(10);
          l_id_condicion_escala varchar2(10);
          
          l_id_cargosueldo_escala number;

        BEGIN
        
          select ID_CARGOSUELDO_ESCALA,ID_DEPTO into l_id_cargosueldo_escala,l_id_depto from PSTO_PLLA_CARGO_PROCESO WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;
        
            SELECT 
            ID_ANHO,
            ID_ENTIDAD,
            ID_DEPTO_PADRE,
            ID_CARGO,
            id_condicion_escala
            INTO 
            l_id_anho,
            l_id_entidad,
            l_id_depto_padre,
            l_id_cargo,
            l_id_condicion_escala
          FROM PSTO_PLLA_CARGOSUELDO_ESCALA
          WHERE ID_CARGOSUELDO_ESCALA=l_id_cargosueldo_escala;
          
            SELECT 
                    COUNT(*) INTO l_contar
            FROM PSTO_PLLA_CARGO_PROCESO
            WHERE ID_ANHO=l_id_anho
            AND ID_ENTIDAD=l_id_entidad
            AND ID_DEPTO=l_id_depto
            AND ID_DEPTO_PADRE=l_id_depto_padre
            AND ID_CARGO=l_id_cargo
            AND coalesce(ID_RENOVABLE,'-')=P_ID_RENOVABLE
            AND coalesce(ID_SEXO,0)=P_ID_SEXO
            AND coalesce(ID_EDAD,'-')=P_ID_EDAD
            AND coalesce(ID_NIVEL_EDU,'-')=P_ID_NIVEL_EDU
            AND coalesce(ID_TIPOESTADOCIVIL,0)=P_ID_TIPOESTADOCIVIL
            AND coalesce(ID_TIEMPOTRABAJO,0)=P_ID_TIEMPOTRABAJO
            AND coalesce(ID_TEMPORADA,'-')=P_ID_TEMPORADA
            AND ID_CARGO_PROCESO<>P_ID_CARGO_PROCESO;
            
           IF l_contar=0 THEN 
          
          
            l_id_renovable:=P_ID_RENOVABLE;
            IF P_ID_RENOVABLE='-' THEN
              l_id_renovable:=NULL;
            END IF;
          
            l_id_sexo:=P_ID_SEXO;
            IF P_ID_SEXO=0 THEN
              l_id_sexo:=NULL;
            END IF;
            
            l_id_edad:=P_ID_EDAD;
            IF P_ID_EDAD='-' THEN
              l_id_edad:=NULL;
            END IF;
            
            l_id_nivel_edu:=P_ID_NIVEL_EDU;
            IF P_ID_NIVEL_EDU='-' THEN
              l_id_nivel_edu:=NULL;
            END IF;
            
            l_id_tipoestadocivil:=P_ID_TIPOESTADOCIVIL;
            IF P_ID_TIPOESTADOCIVIL=0 THEN
              l_id_tipoestadocivil:=NULL;
          END IF;
          
          l_id_tiempotrabajo:=P_ID_TIEMPOTRABAJO;
          IF P_ID_TIEMPOTRABAJO=0 THEN
            l_id_tiempotrabajo:=NULL;
          END IF;
          
          l_id_temporada:=P_ID_TEMPORADA;
          IF P_ID_TEMPORADA='-' THEN
            l_id_temporada:=NULL;
          END IF;
          
          
          if l_id_condicion_escala='M' then
            if l_id_renovable<>'R3' then
              l_error:=1;
              l_msgerror:='Dato renovable no Corresponde';
            else
              if l_id_temporada<>'T1' then
                l_error:=1;
                l_msgerror:='Dato Temporada no Corresponde';
              else
                if l_id_tiempotrabajo<>1 then
                  l_error:=1;
                  l_msgerror:='Dato Tiempo Trabajo no Corresponde';
                end if;
              end if;
            end if;
            
          end if;
          
          if l_error=0 then
            if l_id_renovable='R3' then
              if l_id_temporada<>'T1' then
                l_error:=1;
                l_msgerror:='Dato Temporada no Corresponde';
              else
                if l_id_tiempotrabajo<>1 then
                  l_error:=1;
                  l_msgerror:='Dato Tiempo Trabajo no Corresponde';
                end if;
              end if;
            end if;
          end if;
          
          if l_error=0 then       
          UPDATE PSTO_PLLA_CARGO_PROCESO SET
            ID_RENOVABLE=l_id_renovable,
            ID_SEXO=l_id_sexo,
            ID_EDAD=l_id_edad,
            ID_NIVEL_EDU=l_id_nivel_edu,
            ID_TIPOESTADOCIVIL=l_id_tipoestadocivil,
            ID_TIEMPOTRABAJO=l_id_tiempotrabajo,
            ID_TEMPORADA=l_id_temporada,
            CANTIDAD=P_CANTIDAD
            WHERE ID_CARGO_PROCESO=P_ID_CARGO_PROCESO;
         
        end if;  
         
        else
          l_error:=1;
          l_msgerror:='Ya esta registrado';
        end if;
        
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;
          
        END SP_ACTUALIZAR_PLANILLA_CARGO;
        
        /*PROCEDURE SP_GENERAR_PLANILLA_CARGO(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_anho number;
          l_mes number;
          
          l_id_cargo_proceso number;

              
        BEGIN
          
          select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
          select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
          
          SELECT COALESCE(MAX(ID_CARGO_PROCESO),0) INTO l_contar FROM PSTO_PLLA_CARGO_PROCESO;
          
          insert into PSTO_PLLA_CARGO_PROCESO(
            ID_CARGO_PROCESO, 
            ID_ANHO,
            ID_ENTIDAD,
            ID_DEPTO,
            ID_DEPTO_PADRE,
            ID_CARGO,
            CANTIDAD
          )
          SELECT
          ROWNUM + l_contar AS ID_CARGO_PROCESO,
          P_ID_ANHO,
          P_ID_ENTIDAD,
          P_ID_DEPTO,
          P_ID_DEPTO_PADRE,
          X.ID_CARGO,
          X.CANTIDAD
          FROM(
          SELECT 
          COALESCE(a.ID_CARGO,p.ID_CARGO) AS ID_CARGO,
          COUNT(*) AS CANTIDAD
          FROM APS_PLANILLA a, APS_TRABAJADOR p
          WHERE a.ID_PERSONA=P.ID_PERSONA
          AND a.ID_ENTIDAD=P_ID_ENTIDAD
          AND a.ID_ANHO=l_anho
          AND a.ID_MES=l_mes
          AND a.ID_DEPTO=P_ID_DEPTO
          AND COALESCE(a.ID_CARGO,p.ID_CARGO) NOT IN(
            SELECT ID_CARGO FROM PSTO_PLLA_CARGO_PROCESO
            WHERE ID_ENTIDAD=P_ID_ENTIDAD
            AND  ID_DEPTO=P_ID_DEPTO
            AND  ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            AND  ID_ANHO=P_ID_ANHO
          )
          GROUP BY 
          COALESCE(a.ID_CARGO,p.ID_CARGO)
          ORDER BY COALESCE(a.ID_CARGO,p.ID_CARGO)
         )X;
        
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;
        END SP_GENERAR_PLANILLA_CARGO;
        */
        /*PROCEDURE SP_ACTUALIZAR_PLANILLA_EMP_ANT(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_id_anho number;
          l_uniforme varchar2(2);
          l_docente_tc varchar2(2);
          l_tipo_area varchar2(2);
          l_id_cond_lab varchar2(5);
          l_ant_basico number(10,2);
          l_ant_prima_inf  number(10,2);
          l_ant_asig_fam number(10,2);
          
          l_imp_movi_lib_dis number(10,2):=0;
          l_imp_ayudaanual number(10,2):=0;
          
          l_finicio	date;
          l_ffin	date;

          
          l_param_fmr_ant number(10,5);
          l_param_fmr  number(10,2);
          l_param_inc_anual  number(10,5);
          l_param_essalud  number(10,5);
          l_param_rmv  number(10,5);
          l_param_af  number(10,5);
          l_param_midc  number(10,5);
          l_param_madc  number(10,5);
          l_param_bono_mis  number(10,5);
          l_param_unif  number(10,5);
          l_param_unif_jefe  number(10,5);
          l_param_ppg_i  number(20,14);
          l_param_ppg_ii  number(10,5);
          l_param_seg_vida  number(10,5);
          l_param_igv  number(10,5);
          
          l_cal_meses number(10,2);
          l_cal_prima_inf number(10,2);
          l_cal_sueldo number(10,2):=0;

          l_id_entidad number;
          l_id_persona number;
          
          
          l_hextras25 number(10,2):=0;
          l_hextras35 number(10,2):=0;
          l_hnocturna number(10,2):=0;
          l_hferiado number(10,2):=0;
        
              
        BEGIN
          
          SELECT 
          ID_ANHO,UNIFORME,DOCENTE_TC,TIPO_AREA,ID_COND_LAB,ANT_BASICO,ANT_PRIMA_INF,ANT_ASIG_FAM,FINICIO,FFIN,ID_ENTIDAD,ID_PERSONA
          into
          l_id_anho,l_uniforme, l_docente_tc, l_tipo_area, l_id_cond_lab, l_ant_basico, l_ant_prima_inf, l_ant_asig_fam,l_finicio,l_ffin,l_id_entidad,l_id_persona
          FROM PSTO_PLLA_PLANILLA
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
          
          
          select IMPORTE INTO l_param_fmr_ant from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR_ANT' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_fmr from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_inc_anual from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_INC_ANUAL' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_essalud from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ESSALUD' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_rmv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_RMV' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_af from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_AF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_midc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MIDC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_madc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MADC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_bono_mis from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_BONO_MIS' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_unif from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_unif_jefe from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF_JEFE' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_ppg_i from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_I' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_ppg_ii from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_II' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_seg_vida from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_SEG_VIDA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_igv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_IGV' AND ID_ANHO=l_id_anho;
          
          select IMPORTE INTO l_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;

      
          select FC_PSTO_CALC_MESES(l_finicio,l_ffin,l_id_anho),
          l_ant_prima_inf/l_param_fmr_ant
          into
          l_cal_meses,l_cal_prima_inf
          from dual;
          l_cal_sueldo:=0;
          
          if l_id_cond_lab='M' then
            if l_ant_basico/l_param_fmr_ant<0.95 then
              l_cal_sueldo:=(l_ant_basico/l_param_fmr_ant)+0.05;
            elsif l_ant_basico/l_param_fmr_ant>=1 then
              l_cal_sueldo:=(l_ant_basico/l_param_fmr_ant)+0.01;
            else
              l_cal_sueldo:=  (1-(l_ant_basico/l_param_fmr_ant))+(l_ant_basico/l_param_fmr_ant);
            end if;
          else
            if l_docente_tc='S' then
              if l_ant_basico<l_param_midc then
                l_cal_sueldo:=l_param_madc-l_ant_basico;
              else
                l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
              end if;
            else
              l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
            end if;
          end if;
        
        update PSTO_PLLA_PLANILLA set
        CAL_MESES=l_cal_meses,
        CAL_PRIMA_INF=l_cal_prima_inf,
        CAL_SUELDO=l_cal_sueldo,
        IMP_BONI_CARGO=ANT_BONI_CARGO,
        IMP_ASIG_FAM=case when ID_COND_LAB<>'M' then case when l_ant_asig_fam>0 then l_param_af else 0 end else 0 end ,
        IMP_VIV_REMUN=ANT_VIV_REMUN,
        IMP_SODEXO=ANT_SODEXO,
        IMP_BASICO=case when ID_COND_LAB='M' then l_param_fmr*l_cal_sueldo else FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) end,
        IMP_MODAL_FORMATIVA=case when ID_COND_LAB='P' then FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) else 0 end,
        IMP_PRIMA_INF=case when ID_COND_LAB='M' then case when l_ant_prima_inf>0 then l_cal_prima_inf*l_param_fmr else 0 end else 0 end,
        IMP_BONO_MIS=case when ID_COND_LAB='M' then l_param_bono_mis else 0 end,
        IMP_UNIFORME=case when UNIFORME='N' or ID_TIEMPOTRABAJO=2 then 0 else case when  TIPO_AREA='A' and ID_CATEGORIA IS NULL THEN l_param_unif ELSE l_param_unif_jefe END end,
        IMP_HEXTRAS25=case when ESHEXTRAS25=1 then l_hextras25 else 0 end,
        IMP_HEXTRAS35=case when ESHEXTRAS35=1 then l_hextras35 else 0 end,
        IMP_HNOCTURNA=case when ESHNOCTURNA=1 then l_hnocturna else 0 end,
        IMP_HFERIADO=case when ESHFERIADO=1 then l_hferiado else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
          
        update PSTO_PLLA_PLANILLA set
        IMP_PPG=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_ppg_i*l_param_ppg_ii)*12 else 0 end,
        IMP_SEGURO_VIDA=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_seg_vida*CAL_MESES)*(1+l_param_igv) else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --vac truncas essalud
        update PSTO_PLLA_PLANILLA set
        IMP_VAC_TRUNCA=case when ID_COND_LAB='C' and ID_TIEMPOTRABAJO=1  then 
          ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )/12)*CAL_MESES
        else 0 end,
        IMP_ESSALUD=case when ID_TIEMPOTRABAJO=1  then 
          (((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )*l_param_essalud)*CAL_MESES)+(coalesce(IMP_BONO_MIS,0)*l_param_essalud)+(coalesce(IMP_REINT5TACAT,0)*l_param_essalud)
        else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --gratificacion
        update PSTO_PLLA_PLANILLA set
        IMP_GRATIFICACION= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --cts
        update PSTO_PLLA_PLANILLA set
         IMP_CTS= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_GRATIFICACION,0)/6)+(coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        
        --bonificacion extraordinaria
        update PSTO_PLLA_PLANILLA set
        IMP_BONI_EXTRA= ((((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES)*2)*l_param_essalud
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --ayuda y movilidad
        if l_id_cond_lab='M' then
        
          select count(*) into l_contar from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
        
          if l_contar=1 then
            select IMP_TOTAL into l_imp_movi_lib_dis from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;
          
          select count(*) into l_contar from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
        
          if l_contar=1 then
            select IMP_ANUAL_REG into l_imp_ayudaanual from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;
    
        
          update PSTO_PLLA_PLANILLA set
          IMP_MOVI_LIB_DIS=l_imp_movi_lib_dis,
          IMP_AYUDAANUAL=l_imp_ayudaanual
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        end if;
        
        
        --total
          update PSTO_PLLA_PLANILLA set
          TOTAL=COALESCE(IMP_BONI_CARGO,0)*CAL_MESES+
                COALESCE(IMP_ASIG_FAM,0)*CAL_MESES+
                COALESCE(IMP_MOVI_LIB_DIS,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS25,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS35,0)*CAL_MESES+
                COALESCE(IMP_HNOCTURNA,0)*CAL_MESES+
                COALESCE(IMP_HFERIADO,0)*CAL_MESES+
                COALESCE(IMP_VIV_REMUN,0)*CAL_MESES+
                COALESCE(IMP_SODEXO,0)*CAL_MESES+
                COALESCE(IMP_AYUDAANUAL,0)+
                COALESCE(IMP_REINT5TACAT,0)+
                COALESCE(IMP_BASICO,0)*CAL_MESES+
                COALESCE(IMP_MODAL_FORMATIVA,0)*CAL_MESES+
                COALESCE(IMP_PRIMA_INF,0)*CAL_MESES+
                COALESCE(IMP_GRATIFICACION,0)*2+
                COALESCE(IMP_BONO_MIS,0)+
                COALESCE(IMP_ESSALUD,0)+
                COALESCE(IMP_UNIFORME,0)+
                COALESCE(IMP_BONI_EXTRA,0)+
                COALESCE(IMP_CTS,0)+
                COALESCE(IMP_VAC_TRUNCA,0)+
                COALESCE(IMP_PPG,0)+
                COALESCE(IMP_SEGURO_VIDA,0)
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
         
        PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_ACTIVIDAD(P_ID_PSTO_PLANILLA,l_error,l_msgerror);
         
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_ACTUALIZAR_PLANILLA_EMP_ANT;
        */
        PROCEDURE SP_ACTUALIZAR_PLANILLA_EMP(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_id_anho number;
          l_uniforme varchar2(2);
          l_docente_tc varchar2(2);
          l_tipo_area varchar2(2);
          l_id_cond_lab varchar2(5);
          l_ant_basico number(10,2);
          l_ant_prima_inf  number(10,2);
          l_ant_asig_fam number(10,2);
          
          l_imp_movi_lib_dis number(10,2):=0;
          l_imp_ayudaanual number(10,2):=0;
          
          l_finicio	date;
          l_ffin	date;

          
          l_param_fmr_ant number(10,5);
          l_param_fmr  number(10,2);
          l_param_inc_anual  number(10,5);
          l_param_essalud  number(10,5);
          l_param_rmv  number(10,5);
          l_param_af  number(10,5);
          l_param_midc  number(10,5);
          l_param_madc  number(10,5);
          l_param_bono_mis  number(10,5);
          l_param_unif  number(10,5);
          l_param_unif_jefe  number(10,5);
          l_param_ppg_i  number(20,14);
          l_param_ppg_ii  number(10,5);
          l_param_seg_vida  number(10,5);
          l_param_igv  number(10,5);
          
          l_cal_meses number(10,2);
          l_cal_prima_inf number(10,2);
          l_cal_sueldo number(10,2):=0;
          l_imp_vivienda number(10,2):=0;

          l_id_entidad number;
          l_id_persona number;
          
          
          l_hextras25 number(10,2):=0;
          l_hextras35 number(10,2):=0;
          l_hnocturna number(10,2):=0;
          l_hferiado number(10,2):=0;
        
          l_id_temporada varchar2(5);
              
        BEGIN
          
          SELECT 
          ID_ANHO,UNIFORME,DOCENTE_TC,TIPO_AREA,ID_COND_LAB,ANT_BASICO,ANT_PRIMA_INF,ANT_ASIG_FAM,FINICIO,FFIN,ID_ENTIDAD,ID_PERSONA,ID_TEMPORADA
          into
          l_id_anho,l_uniforme, l_docente_tc, l_tipo_area, l_id_cond_lab, l_ant_basico, l_ant_prima_inf, l_ant_asig_fam,l_finicio,l_ffin,l_id_entidad,l_id_persona,l_id_temporada
          FROM PSTO_PLLA_PLANILLA
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
          
          
          select IMPORTE INTO l_param_fmr_ant from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR_ANT' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_fmr from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_FMR' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_inc_anual from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_INC_ANUAL' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_essalud from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ESSALUD' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_rmv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_RMV' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_af from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_AF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_midc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MIDC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_madc from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MADC' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_bono_mis from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_BONO_MIS' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_unif from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_unif_jefe from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_UNIF_JEFE' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_ppg_i from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_I' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_ppg_ii from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_PPG_II' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_seg_vida from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_SEG_VIDA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_param_igv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_IGV' AND ID_ANHO=l_id_anho;
          
          select IMPORTE INTO l_hextras25 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS25' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hextras35 from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HEXTRAS35' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hnocturna from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HNOCTURNA' AND ID_ANHO=l_id_anho;
          select IMPORTE INTO l_hferiado from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_HFERIADO' AND ID_ANHO=l_id_anho;

      
          select FC_PSTO_CALC_MES_TEMPORADA(l_id_temporada),
          l_ant_prima_inf/l_param_fmr_ant
          into
          l_cal_meses,l_cal_prima_inf
          from dual;
          
          l_cal_sueldo:=0;
          
          if l_id_cond_lab='M' then
            
            l_cal_sueldo:=  0;
            
          else
            if l_docente_tc='S' then
              if l_ant_basico<l_param_midc then
                l_cal_sueldo:=l_param_madc-l_ant_basico;
              else
                l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
              end if;
            else
              l_cal_sueldo:=l_ant_basico*l_param_inc_anual;
            end if;
          end if;
        
        update PSTO_PLLA_PLANILLA set
        CAL_MESES=l_cal_meses,
        CAL_PRIMA_INF=l_cal_prima_inf,
        CAL_SUELDO=l_cal_sueldo,
        IMP_BONI_CARGO=ANT_BONI_CARGO,
        IMP_ASIG_FAM=case when ID_COND_LAB<>'M' then case when l_ant_asig_fam>0 then l_param_af else 0 end else 0 end ,
        --IMP_VIV_REMUN=ANT_VIV_REMUN,
        IMP_SODEXO=ANT_SODEXO,
        IMP_BASICO=case when ID_COND_LAB='M' then l_param_fmr*(FMR/100) else FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) end,
        IMP_MODAL_FORMATIVA=case when ID_COND_LAB='P' then FC_PSTO_CALC_MODFORLAB(l_ant_basico+l_cal_sueldo) else 0 end,
        IMP_PRIMA_INF=case when ID_COND_LAB='M' then case when l_ant_prima_inf>0 then l_cal_prima_inf*l_param_fmr else 0 end else 0 end,
        IMP_BONO_MIS=case when ID_COND_LAB='M' then l_param_bono_mis else 0 end,
        IMP_UNIFORME=0,--case when UNIFORME='N' or ID_TIEMPOTRABAJO=2 then 0 else case when  TIPO_AREA='A' and ID_CATEGORIA IS NULL THEN l_param_unif ELSE l_param_unif_jefe END end,
        IMP_HEXTRAS25=case when ESHEXTRAS25=1 then l_hextras25 else 0 end,
        IMP_HEXTRAS35=case when ESHEXTRAS35=1 then l_hextras35 else 0 end,
        IMP_HNOCTURNA=case when ESHNOCTURNA=1 then l_hnocturna else 0 end,
        IMP_HFERIADO=case when ESHFERIADO=1 then l_hferiado else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
          
        update PSTO_PLLA_PLANILLA set
        IMP_PPG=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_ppg_i*l_param_ppg_ii)*12 else 0 end,
        IMP_SEGURO_VIDA=case when ID_COND_LAB='M' then (IMP_BASICO*l_param_seg_vida*CAL_MESES)*(1+l_param_igv) else 0 end ---pendiente
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --vac truncas essalud
        update PSTO_PLLA_PLANILLA set
        IMP_VAC_TRUNCA=case when ID_COND_LAB='C' and ID_TIEMPOTRABAJO=1  then 
          ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )/12)*CAL_MESES
        else 0 end,
        IMP_ESSALUD=case when ID_TIEMPOTRABAJO=1  then 
          (((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) )*l_param_essalud)*CAL_MESES)+(coalesce(IMP_BONO_MIS,0)*l_param_essalud)+(coalesce(IMP_REINT5TACAT,0)*l_param_essalud)
        else 0 end
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --gratificacion
        update PSTO_PLLA_PLANILLA set
        IMP_GRATIFICACION= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --cts
        update PSTO_PLLA_PLANILLA set
         IMP_CTS= ((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_GRATIFICACION,0)/6)+(coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        
        --bonificacion extraordinaria
        update PSTO_PLLA_PLANILLA set
        IMP_BONI_EXTRA= ((((coalesce(IMP_BASICO,0) +coalesce(IMP_BONI_CARGO,0) + coalesce(IMP_ASIG_FAM,0) + coalesce(IMP_PRIMA_INF,0) + coalesce(IMP_MOVI_LIB_DIS,0) + 
          coalesce(IMP_HEXTRAS25,0) + coalesce(IMP_HEXTRAS35,0) + coalesce(IMP_HNOCTURNA,0) + coalesce(IMP_HFERIADO,0) + 
          coalesce(IMP_VIV_REMUN,0) + (coalesce(IMP_BONO_MIS,0)/12)+(coalesce(IMP_REINT5TACAT,0)/12))/12)*CAL_MESES)*2)*l_param_essalud
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        --ayuda y movilidad
        --if l_id_cond_lab='M' then
        
          select count(*) into l_contar from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
        
          if l_contar=1 then
            select IMP_TOTAL into l_imp_movi_lib_dis from PSTO_PLLA_MOVLIBDIS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;
          
          select count(*) into l_contar from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
        
          if l_contar=1 then
            select IMP_ANUAL_REG into l_imp_ayudaanual from PSTO_PLLA_AYUDAS WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;
          
          select count(*) into l_contar from PSTO_PLLA_VIVIENDA WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
        
          if l_contar=1 then
            select IMP_IMPORTE into l_imp_vivienda from PSTO_PLLA_VIVIENDA WHERE ID_ENTIDAD=l_id_entidad AND ID_PERSONA=l_id_persona AND ID_ANHO=l_id_anho;
          end if;
        
          update PSTO_PLLA_PLANILLA set
          IMP_MOVI_LIB_DIS=l_imp_movi_lib_dis,
          IMP_AYUDAANUAL=l_imp_ayudaanual,
          IMP_VIV_REMUN=l_imp_vivienda
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        --end if;
        
        
        --total
          update PSTO_PLLA_PLANILLA set
          TOTAL=COALESCE(IMP_BONI_CARGO,0)*CAL_MESES+
                COALESCE(IMP_ASIG_FAM,0)*CAL_MESES+
                COALESCE(IMP_MOVI_LIB_DIS,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS25,0)*CAL_MESES+
                COALESCE(IMP_HEXTRAS35,0)*CAL_MESES+
                COALESCE(IMP_HNOCTURNA,0)*CAL_MESES+
                COALESCE(IMP_HFERIADO,0)*CAL_MESES+
                COALESCE(IMP_VIV_REMUN,0)*CAL_MESES+
                COALESCE(IMP_SODEXO,0)*CAL_MESES+
                COALESCE(IMP_AYUDAANUAL,0)+
                COALESCE(IMP_REINT5TACAT,0)+
                COALESCE(IMP_BASICO,0)*CAL_MESES+
                COALESCE(IMP_MODAL_FORMATIVA,0)*CAL_MESES+
                COALESCE(IMP_PRIMA_INF,0)*CAL_MESES+
                COALESCE(IMP_GRATIFICACION,0)*2+
                COALESCE(IMP_BONO_MIS,0)+
                COALESCE(IMP_ESSALUD,0)+
                COALESCE(IMP_UNIFORME,0)+
                COALESCE(IMP_BONI_EXTRA,0)+
                COALESCE(IMP_CTS,0)+
                COALESCE(IMP_VAC_TRUNCA,0)+
                COALESCE(IMP_PPG,0)+
                COALESCE(IMP_SEGURO_VIDA,0)
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_DIST_DET(P_ID_PSTO_PLANILLA,l_error,l_msgerror); 
        --PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_ACTIVIDAD(P_ID_PSTO_PLANILLA,l_error,l_msgerror);
         
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_ACTUALIZAR_PLANILLA_EMP;
        
        /*PROCEDURE SP_ACTUALIZAR_PLANILLA(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO VARCHAR2,P_ID_DEPTO_PADRE IN NUMBER,P_ID_AUXILIAR IN NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_id_psto_planilla number;

          
          CURSOR cur IS SELECT 
              ID_PSTO_PLANILLA
              FROM PSTO_PLLA_PLANILLA 
              WHERE ID_ENTIDAD=P_ID_ENTIDAD
              AND ID_DEPTO=P_ID_DEPTO
              AND ID_ANHO=P_ID_ANHO
              AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
              AND ID_AUXILIAR=P_ID_AUXILIAR;
              
        BEGIN
          

          
          OPEN cur;
          FETCH cur INTO l_id_psto_planilla;
                
          WHILE cur%FOUND LOOP
          
            
              
              PKG_PSTOPLANILLA.SP_ACTUALIZAR_PLANILLA_EMP_ANT(l_id_psto_planilla,l_error,l_msgerror);
              
               
            
            FETCH cur INTO l_id_psto_planilla;
                  
        END LOOP;   
        CLOSE cur;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_ACTUALIZAR_PLANILLA;
        */
        PROCEDURE SP_GENERAR_PLANILLA_DIST(P_ID_PSTO_PLANILLA NUMBER,P_ID_DEPTO VARCHAR2,P_ID_TEMPORADA VARCHAR2,P_PORCENTAJE NUMBER,P_TIPO VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          
          l_id_entidad number;
          l_imp_prin number(10,2);
          l_imp_aso number(10,2);
          l_imp_queda number(10,2);
          l_imp_actual number(10,2);
          
          l_id_plla_planilla_dist number;
          
          l_mes number:=1;
          l_activo number:=0;
          
          l_inicio number:=0;
          l_fin number:=0;
          l_inicio1 number:=0;
          l_fin1 number:=0;
          
          l_id_temporada_v varchar(2);
          
          l_inicio_v number:=0;
          l_fin_v number:=0;
          l_inicio1_v number:=0;
          l_fin1_v number:=0;
 
        BEGIN
      
        SELECT ID_ENTIDAD into  l_id_entidad FROM PSTO_PLLA_PLANILLA where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        IF P_PORCENTAJE>100 THEN
          l_error:=1;
          l_msgerror:='Porcentaje ingresado mayor a 100  ingresado '||to_char(P_PORCENTAJE);
        END IF;
        
        SELECT
            coalesce(INICIO,0),
            coalesce(FIN,0),
            coalesce(INICIO1,0),
            coalesce(FIN1,0)
          into 
            l_inicio,
            l_fin,
            l_inicio1,
            l_fin1 
        FROM PSTO_PLLA_TEMPORADA
        WHERE ID_TEMPORADA=P_ID_TEMPORADA;
        
        IF l_error=0 THEN
          if P_TIPO='0' then
              SELECT
              ID_TEMPORADA INTO l_id_temporada_v
              FROM PSTO_PLLA_PLANILLA_DIST
              WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA 
              AND TIPO='1';
              
              SELECT
                coalesce(INICIO,0),
                coalesce(FIN,0),
                coalesce(INICIO,0),
                coalesce(FIN1,0)
              into 
                l_inicio_v,
                l_fin_v,
                l_inicio1_v,
                l_fin1_v 
            FROM PSTO_PLLA_TEMPORADA
            WHERE ID_TEMPORADA=l_id_temporada_v;
            
            if l_fin1_v>0 then
              l_fin_v:=l_fin1_v;
            end if;
            
            if l_inicio>0 and l_fin>0 then
              
                if l_inicio>=l_inicio_v  then
                   if l_fin<=l_fin_v then
                      l_error:=0;
                   else
                    l_error:=1;
                    l_msgerror:='Temporada fecha fin fuera de rango ';
                   end if;
                else
                  l_error:=1;
                  l_msgerror:='Temporada fecha inicio fuera de rango ';
                end if;
               
            end if;
            
             IF l_error=0 THEN
               if l_inicio1>0 and l_fin1>0 then
                
                  if l_inicio1>=l_inicio_v  then
                     if l_fin1<=l_fin_v then
                        l_error:=0;
                     else
                      l_error:=1;
                      l_msgerror:='Temporada fecha fin fuera de rango ';
                     end if;
                  else
                    l_error:=1;
                    l_msgerror:='Temporada fecha inicio fuera de rango ';
                  end if;
                 
              end if;
             end if;
            
          end if;
        end if;
        
        IF l_error=0 THEN
        
          SELECT COALESCE(SUM(case when TIPO='1' then PORCENTAJE else 0 end),0),COALESCE(SUM(case when TIPO='0' then PORCENTAJE else 0 end),0) 
          INTO l_imp_prin,l_imp_aso FROM PSTO_PLLA_PLANILLA_DIST
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
          
          l_imp_actual:=l_imp_aso+P_PORCENTAJE;
          if l_imp_actual>100 then
            l_error:=1;
            l_msgerror:='Porcentaje total mayor a 100  actual '||to_char(l_imp_actual);
          else
            if P_TIPO<>'1' then
                l_imp_queda:=100-l_imp_actual;
              else
                l_imp_queda:=l_imp_actual;
            end if;
          end if;
          
        end if;
        
        SELECT COUNT(*) INTO l_contar FROM PSTO_PLLA_PLANILLA_DIST
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
        AND ID_DEPTO=P_ID_DEPTO
        AND ID_ENTIDAD=l_id_entidad;
        
        IF l_contar=0 and l_error=0 THEN
          
          SELECT COALESCE(MAX(ID_PLLA_PLANILLA_DIST),0) +1 INTO l_id_plla_planilla_dist FROM PSTO_PLLA_PLANILLA_DIST;
          
          insert into PSTO_PLLA_PLANILLA_DIST(
            ID_PLLA_PLANILLA_DIST,
            ID_ENTIDAD,
            ID_DEPTO,
            ID_PSTO_PLANILLA,
            TIPO,
            ID_TEMPORADA,
            PORCENTAJE
          )values(
            l_id_plla_planilla_dist,
            l_id_entidad,
            P_ID_DEPTO,
            P_ID_PSTO_PLANILLA,
            P_TIPO,
            P_ID_TEMPORADA,
            P_PORCENTAJE
          );
          
          UPDATE PSTO_PLLA_PLANILLA_DIST SET PORCENTAJE=l_imp_queda
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA 
          AND TIPO='1';
          
          
          
          l_mes:=1;
          
          
          while l_mes<=12 loop
            l_activo:=0;
            if l_mes between l_inicio and  l_fin then
            --if l_mes>=l_inicio and l_mes<=l_fin then
              l_activo:=1;
            else
              if l_mes between l_inicio1 and  l_fin1 then
              --if l_mes>=l_inicio1 and l_mes<=l_fin1 then
                l_activo:=1;
              end if;
            end if;
  
            EXECUTE IMMEDIATE 'UPDATE PSTO_PLLA_PLANILLA_DIST SET MES'||to_char(l_mes)||'='||to_char(l_activo)||' WHERE ID_PLLA_PLANILLA_DIST=:PARAMETRO'  
            USING l_id_plla_planilla_dist;
            l_mes:=l_mes+1;
          end loop;
          
        ELSE
          IF l_contar>0 and l_error=0 THEN
            l_error:=1;
            l_msgerror:='Ya esta registrado a departamento '||P_ID_DEPTO;
          END IF;
        END IF;
        
        IF l_error=0 THEN    
          PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_DIST_DET(P_ID_PSTO_PLANILLA,l_error,l_msgerror); 
        end if;       
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_GENERAR_PLANILLA_DIST;
        
        PROCEDURE SP_ACTUALIZAR_PLANILLA_DIST(P_ID_PLLA_PLANILLA_DIST NUMBER,P_ID_DEPTO VARCHAR2,P_ID_TEMPORADA VARCHAR2,P_PORCENTAJE NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          
          l_id_entidad number;
          l_imp_prin number(10,2);
          l_imp_aso number(10,2);
          l_imp_queda number(10,2);
          l_imp_actual number(10,2);
          
          l_id_plla_planilla_dist number;
          
          l_mes number:=1;
          l_activo number:=0;
          
          l_inicio number:=0;
          l_fin number:=0;
          l_inicio1 number:=0;
          l_fin1 number:=0;
          
          l_id_temporada_v varchar(2);
          
          l_inicio_v number:=0;
          l_fin_v number:=0;
          l_inicio1_v number:=0;
          l_fin1_v number:=0;
          l_psto_planilla number;
          l_tipo varchar2(2);
        BEGIN
      
        SELECT ID_ENTIDAD,ID_PSTO_PLANILLA,TIPO into  l_id_entidad,l_psto_planilla,l_tipo FROM PSTO_PLLA_PLANILLA_DIST where ID_PLLA_PLANILLA_DIST=P_ID_PLLA_PLANILLA_DIST;
        
        IF P_PORCENTAJE>100 THEN
          l_error:=1;
          l_msgerror:='Porcentaje ingresado mayor a 100  ingresado '||to_char(P_PORCENTAJE);
        END IF;
        
        SELECT
            coalesce(INICIO,0),
            coalesce(FIN,0),
            coalesce(INICIO1,0),
            coalesce(FIN1,0)
          into 
            l_inicio,
            l_fin,
            l_inicio1,
            l_fin1 
        FROM PSTO_PLLA_TEMPORADA
        WHERE ID_TEMPORADA=P_ID_TEMPORADA;
        
        IF l_error=0 THEN
          if l_tipo='0' then
              SELECT
              ID_TEMPORADA INTO l_id_temporada_v
              FROM PSTO_PLLA_PLANILLA_DIST
              WHERE ID_PSTO_PLANILLA=l_psto_planilla 
              AND TIPO='1';
              
              SELECT
                coalesce(INICIO,0),
                coalesce(FIN,0),
                coalesce(INICIO,0),
                coalesce(FIN1,0)
              into 
                l_inicio_v,
                l_fin_v,
                l_inicio1_v,
                l_fin1_v 
            FROM PSTO_PLLA_TEMPORADA
            WHERE ID_TEMPORADA=l_id_temporada_v;
            
            if l_fin1_v>0 then
              l_fin_v:=l_fin1_v;
            end if;
            
            if l_inicio>0 and l_fin>0 then
              
                if l_inicio>=l_inicio_v  then
                   if l_fin<=l_fin_v then
                      l_error:=0;
                   else
                    l_error:=1;
                    l_msgerror:='Temporada fecha fin fuera de rango ';
                   end if;
                else
                  l_error:=1;
                  l_msgerror:='Temporada fecha inicio fuera de rango ';
                end if;
               
            end if;
            
             IF l_error=0 THEN
               if l_inicio1>0 and l_fin1>0 then
                
                  if l_inicio1>=l_inicio_v  then
                     if l_fin1<=l_fin_v then
                        l_error:=0;
                     else
                      l_error:=1;
                      l_msgerror:='Temporada fecha fin fuera de rango ';
                     end if;
                  else
                    l_error:=1;
                    l_msgerror:='Temporada fecha inicio fuera de rango ';
                  end if;
                 
              end if;
             end if;
            
          end if;
        end if;
        
        IF l_error=0 THEN
          
                
          SELECT COALESCE(SUM(case when TIPO='1' then PORCENTAJE else 0 end),0),COALESCE(SUM(case when TIPO='0' then PORCENTAJE else 0 end),0) 
          INTO l_imp_prin,l_imp_aso FROM PSTO_PLLA_PLANILLA_DIST
          WHERE ID_PSTO_PLANILLA=l_psto_planilla
          AND ID_PLLA_PLANILLA_DIST<>P_ID_PLLA_PLANILLA_DIST;
          
          l_imp_actual:=l_imp_aso+P_PORCENTAJE;
          if l_imp_actual>100 then
            l_error:=1;
            l_msgerror:='Porcentaje total mayor a 100  actual '||to_char(l_imp_actual);
          else
            if l_tipo<>'1' then
                l_imp_queda:=100-l_imp_actual;
              else
                l_imp_queda:=l_imp_actual;
            end if;
          end if;
          
        end if;
        
        SELECT COUNT(*) INTO l_contar FROM PSTO_PLLA_PLANILLA_DIST
        WHERE ID_PSTO_PLANILLA=l_psto_planilla
        AND ID_DEPTO=P_ID_DEPTO
        AND ID_ENTIDAD=l_id_entidad
        AND ID_PLLA_PLANILLA_DIST<>P_ID_PLLA_PLANILLA_DIST;
        
        if l_contar=0 then
          IF  l_error=0 THEN
  
            UPDATE PSTO_PLLA_PLANILLA_DIST SET
                ID_DEPTO=P_ID_DEPTO,
                ID_TEMPORADA=P_ID_TEMPORADA,
                PORCENTAJE=P_PORCENTAJE
            WHERE ID_PLLA_PLANILLA_DIST=P_ID_PLLA_PLANILLA_DIST;
            
            
            UPDATE PSTO_PLLA_PLANILLA_DIST SET PORCENTAJE=l_imp_queda
            WHERE ID_PSTO_PLANILLA=l_psto_planilla 
            AND TIPO='1';
            
                     
            
            l_mes:=1;
            
            
            while l_mes<=12 loop
              l_activo:=0;
               if l_mes between l_inicio and  l_fin then
              --if l_mes>=l_inicio and l_mes<=l_fin then
                l_activo:=1;
              else
                if l_mes between l_inicio1 and  l_fin1 then
                --if l_mes>=l_inicio1 and l_mes<=l_fin1 then
                  l_activo:=1;
                end if;
              end if;
    
              EXECUTE IMMEDIATE 'UPDATE PSTO_PLLA_PLANILLA_DIST SET MES'||to_char(l_mes)||'='||to_char(l_activo)||' WHERE ID_PLLA_PLANILLA_DIST=:PARAMETRO'  
              USING P_ID_PLLA_PLANILLA_DIST;
              l_mes:=l_mes+1;
            end loop;
   
          END IF;
        else
          IF l_contar>0 and l_error=0 THEN
            l_error:=1;
            l_msgerror:='Ya esta registrado a departamento '||P_ID_DEPTO;
          END IF;
        end if;   
        
        if l_error=0 then
          PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_DIST_DET(l_psto_planilla,l_error,l_msgerror); 
        end if;       
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_ACTUALIZAR_PLANILLA_DIST;
        
        PROCEDURE SP_ELIMINAR_PLANILLA_DIST(P_ID_PLLA_PLANILLA_DIST NUMBER) IS
      
          l_error number:=0;
          l_msgerror varchar2(200):='';

          l_imp_aso number(10,2);
          l_imp_queda number(10,2);


          
      
          l_psto_planilla number;
        
        BEGIN
      
        SELECT ID_PSTO_PLANILLA into l_psto_planilla FROM PSTO_PLLA_PLANILLA_DIST where ID_PLLA_PLANILLA_DIST=P_ID_PLLA_PLANILLA_DIST;
        
        
        DELETE from PSTO_PLLA_PLANILLA_DIST_DET  where ID_PLLA_PLANILLA_DIST=P_ID_PLLA_PLANILLA_DIST;
        
        DELETE FROM PSTO_PLLA_PLANILLA_DIST where ID_PLLA_PLANILLA_DIST=P_ID_PLLA_PLANILLA_DIST;
        
        
        
        SELECT COALESCE(SUM(case when TIPO='0' then PORCENTAJE else 0 end),0) 
        INTO l_imp_aso FROM PSTO_PLLA_PLANILLA_DIST
        WHERE ID_PSTO_PLANILLA=l_psto_planilla;
          
        
        l_imp_queda:=100-l_imp_aso;
         
       
        UPDATE PSTO_PLLA_PLANILLA_DIST SET PORCENTAJE=l_imp_queda
        WHERE ID_PSTO_PLANILLA=l_psto_planilla 
        AND TIPO='1';
          
                   
        PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_DIST_DET(l_psto_planilla,l_error,l_msgerror); 
               

        END SP_ELIMINAR_PLANILLA_DIST;
        
        /*PROCEDURE SP_GENERAR_PLANILLA_ACTIVIDAD(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          
          l_id_entidad number;
          l_id_auxiliar number;
          l_id_depto_padre number;
          
          l_id_concepto_actividad number;
          l_columna_imp varchar2(50);
          
          CURSOR cur IS SELECT 
              ID_CONCEPTO_ACTIVIDAD,COLUMNA_IMP
              FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_DEPTO_PADRE=l_id_depto_padre
              AND ID_AUXILIAR=l_id_auxiliar;        
              
        BEGIN
          
        DELETE  FROM PSTO_PLLA_PLANILLA_ACTIVIDAD WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;   
        
        SELECT 
        ID_ENTIDAD,ID_AUXILIAR,ID_DEPTO_PADRE
        into
        l_id_entidad,l_id_auxiliar,l_id_depto_padre
        FROM PSTO_PLLA_PLANILLA
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        OPEN cur;
          FETCH cur INTO l_id_concepto_actividad,l_columna_imp;
                
          WHILE cur%FOUND LOOP
          
            EXECUTE IMMEDIATE 'INSERT INTO PSTO_PLLA_PLANILLA_ACTIVIDAD(ID_CONCEPTO_ACTIVIDAD,ID_PSTO_PLANILLA,IMPORTE) SELECT '||to_char(l_id_concepto_actividad)||','||to_char(P_ID_PSTO_PLANILLA)||','||l_columna_imp||' FROM PSTO_PLLA_PLANILLA WHERE ID_PSTO_PLANILLA=:PARAMETRO and coalesce('||l_columna_imp||',0)>0 '  
            USING P_ID_PSTO_PLANILLA;
            
            FETCH cur INTO l_id_concepto_actividad,l_columna_imp;
                  
        END LOOP;   
        CLOSE cur;
      
        
               
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_GENERAR_PLANILLA_ACTIVIDAD;
        */
    PROCEDURE SP_GENERAR_PLANILLA_DIST_DET(P_ID_PSTO_PLANILLA NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          
          l_id_entidad number;
          l_id_auxiliar number;
          l_id_depto_padre number;
          
          l_id_concepto_actividad number;
          l_columna_imp varchar2(50);
          l_distribuido varchar2(2);
          
          l_id_psto_plainilla number;
          l_importe number(10,2);
          
          l_id_plla_planilla_dist number;
          l_porcentaje number(10,2);
          l_mes1 number(10,2);
          l_mes2 number(10,2);
          l_mes3 number(10,2);
          l_mes4 number(10,2);
          l_mes5 number(10,2);
          l_mes6 number(10,2);
          l_mes7 number(10,2);
          l_mes8 number(10,2);
          l_mes9 number(10,2);
          l_mes10 number(10,2);
          l_mes11 number(10,2);
          l_mes12 number(10,2);

          
          CURSOR cur IS SELECT 
              ID_CONCEPTO_ACTIVIDAD,COLUMNA_IMP,DISTRIBUIDO
              FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_DEPTO_PADRE=l_id_depto_padre
              AND AUXI_IDENTIFICADOR='PL'; 
              
          CURSOR cureje IS  select
                  ID_PLLA_PLANILLA_DIST,
                  PORCENTAJE,
                  MES1,
                  MES2,
                  MES3,
                  MES4,
                  MES5,
                  MES6,
                  MES7,
                  MES8,
                  MES9,
                  MES10,
                  MES11,
                  MES12
            from PSTO_PLLA_PLANILLA_DIST
            where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
            AND TIPO='0' ;
              
        BEGIN
          
        DELETE  FROM PSTO_PLLA_PLANILLA_DIST_DET WHERE ID_PLLA_PLANILLA_DIST IN(
          select ID_PLLA_PLANILLA_DIST from PSTO_PLLA_PLANILLA_DIST where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
        );   
        
  
        SELECT 
        ID_ENTIDAD,ID_AUXILIAR,ID_DEPTO_PADRE
        into
        l_id_entidad,l_id_auxiliar,l_id_depto_padre
        FROM PSTO_PLLA_PLANILLA
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        OPEN cur;
          FETCH cur INTO l_id_concepto_actividad,l_columna_imp,l_distribuido;
                
          WHILE cur%FOUND LOOP
          
            EXECUTE IMMEDIATE ' SELECT coalesce('||l_columna_imp||'_MEN,0) FROM VW_PSTO_PLLA_PLANILLA WHERE ID_PSTO_PLANILLA=:PARAMETRO'  
            into l_importe
            USING P_ID_PSTO_PLANILLA;
            
            if l_importe>0 and l_distribuido='S' then
            
              OPEN cureje;
              FETCH cureje INTO l_id_plla_planilla_dist,l_porcentaje, l_mes1,l_mes2,l_mes3,l_mes4,l_mes5,l_mes6,l_mes7,l_mes8,l_mes9,l_mes10,l_mes11,l_mes12;
                    
              WHILE cureje%FOUND LOOP
              
                insert into PSTO_PLLA_PLANILLA_DIST_DET(
                    ID_CONCEPTO_ACTIVIDAD,
                    ID_PLLA_PLANILLA_DIST,
                    MES1,
                    MES2,
                    MES3,
                    MES4,
                    MES5,
                    MES6,
                    MES7,
                    MES8,
                    MES9,
                    MES10,
                    MES11,
                    MES12
                )values(
                  l_id_concepto_actividad,
                  l_id_plla_planilla_dist,
                  ((l_porcentaje*l_mes1)/100)*l_importe,
                  ((l_porcentaje*l_mes2)/100)*l_importe,
                  ((l_porcentaje*l_mes3)/100)*l_importe,
                  ((l_porcentaje*l_mes4)/100)*l_importe,
                  ((l_porcentaje*l_mes5)/100)*l_importe,
                  ((l_porcentaje*l_mes6)/100)*l_importe,
                  ((l_porcentaje*l_mes7)/100)*l_importe,
                  ((l_porcentaje*l_mes8)/100)*l_importe,
                  ((l_porcentaje*l_mes9)/100)*l_importe,
                  ((l_porcentaje*l_mes10)/100)*l_importe,
                  ((l_porcentaje*l_mes11)/100)*l_importe,
                  ((l_porcentaje*l_mes12)/100)*l_importe
                );
                
                update PSTO_PLLA_PLANILLA_DIST_DET set importe=MES1+MES2+MES3+MES4+MES5+MES6+MES7+MES8+MES9+MES10+MES11+MES12
                where ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad
                and ID_PLLA_PLANILLA_DIST=l_id_plla_planilla_dist;
                
                FETCH cureje INTO l_id_plla_planilla_dist,l_porcentaje, l_mes1,l_mes2,l_mes3,l_mes4,l_mes5,l_mes6,l_mes7,l_mes8,l_mes9,l_mes10,l_mes11,l_mes12;
                  
              END LOOP;  
              
              ---------------------------------------------------
              SELECT
              COALESCE(SUM(MES1),0),COALESCE(SUM(MES2),0),COALESCE(SUM(MES3),0),COALESCE(SUM(MES4),0),COALESCE(SUM(MES5),0),COALESCE(SUM(MES6),0),COALESCE(SUM(MES7),0),COALESCE(SUM(MES8),0),COALESCE(SUM(MES9),0),COALESCE(SUM(MES10),0),COALESCE(SUM(MES11),0),COALESCE(SUM(MES12),0)
              INTO 
              l_mes1,l_mes2,l_mes3,l_mes4,l_mes5,l_mes6,l_mes7,l_mes8,l_mes9,l_mes10,l_mes11,l_mes12
              FROM PSTO_PLLA_PLANILLA_DIST_DET WHERE ID_PLLA_PLANILLA_DIST IN(
                  select ID_PLLA_PLANILLA_DIST from PSTO_PLLA_PLANILLA_DIST where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                  AND TIPO='0'
              ) and ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad;
              
               insert into PSTO_PLLA_PLANILLA_DIST_DET(
                    ID_CONCEPTO_ACTIVIDAD,
                    ID_PLLA_PLANILLA_DIST,
                    MES1,
                    MES2,
                    MES3,
                    MES4,
                    MES5,
                    MES6,
                    MES7,
                    MES8,
                    MES9,
                    MES10,
                    MES11,
                    MES12
                )
                SELECT
                  l_id_concepto_actividad,
                  ID_PLLA_PLANILLA_DIST,
                  (l_importe-l_mes1)*MES1,
                  (l_importe-l_mes2)*MES2,
                  (l_importe-l_mes3)*MES3,
                  (l_importe-l_mes4)*MES4,
                  (l_importe-l_mes5)*MES5,
                  (l_importe-l_mes6)*MES6,
                  (l_importe-l_mes7)*MES7,
                  (l_importe-l_mes8)*MES8,
                  (l_importe-l_mes9)*MES9,
                  (l_importe-l_mes10)*MES10,
                  (l_importe-l_mes11)*MES11,
                  (l_importe-l_mes12)*MES12
                FROM PSTO_PLLA_PLANILLA_DIST
                where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                AND TIPO='1';
                
                update PSTO_PLLA_PLANILLA_DIST_DET set importe=MES1+MES2+MES3+MES4+MES5+MES6+MES7+MES8+MES9+MES10+MES11+MES12
                where ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad
                and ID_PLLA_PLANILLA_DIST IN(
                  SELECT ID_PLLA_PLANILLA_DIST 
                  FROM PSTO_PLLA_PLANILLA_DIST
                  where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                  AND TIPO='1'
                );
                
              CLOSE cureje;
            else
              if l_importe>0 then
                insert into PSTO_PLLA_PLANILLA_DIST_DET(
                      ID_CONCEPTO_ACTIVIDAD,
                      ID_PLLA_PLANILLA_DIST,
                      MES1,
                      MES2,
                      MES3,
                      MES4,
                      MES5,
                      MES6,
                      MES7,
                      MES8,
                      MES9,
                      MES10,
                      MES11,
                      MES12
                  )
                  SELECT
                    l_id_concepto_actividad,
                    ID_PLLA_PLANILLA_DIST,
                    (l_importe)*MES1,
                    (l_importe)*MES2,
                    (l_importe)*MES3,
                    (l_importe)*MES4,
                    (l_importe)*MES5,
                    (l_importe)*MES6,
                    (l_importe)*MES7,
                    (l_importe)*MES8,
                    (l_importe)*MES9,
                    (l_importe)*MES10,
                    (l_importe)*MES11,
                    (l_importe)*MES12
                  FROM PSTO_PLLA_PLANILLA_DIST
                  where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                  AND TIPO='1';
                  
                  update PSTO_PLLA_PLANILLA_DIST_DET set importe=MES1+MES2+MES3+MES4+MES5+MES6+MES7+MES8+MES9+MES10+MES11+MES12
                  where ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad
                  and ID_PLLA_PLANILLA_DIST IN(
                    SELECT
                    ID_PLLA_PLANILLA_DIST
                    FROM PSTO_PLLA_PLANILLA_DIST
                    where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                    AND TIPO='1'
                  );
               end if; 
            end if;
          
                 
            FETCH cur INTO l_id_concepto_actividad,l_columna_imp,l_distribuido;
                  
        END LOOP;   
        CLOSE cur;
      
        
               
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        
        END SP_GENERAR_PLANILLA_DIST_DET;
        
        
    /*
    PROCEDURE SP_PLANILLA_PRESUPUESTO(P_ID_ENTIDAD NUMBER,P_ID_DEPTO_PADRE VARCHAR2,P_ID_ANHO NUMBER,P_ID_PERSONA NUMBER,P_ID_PSTONEGOCIO NUMBER,P_ID_EJE NUMBER, P_ID_AUXILIAR NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_contar number;
    l_id_presupuesto number;
    l_id_evento number;
    l_descripcion varchar2(300);
    l_total_ingreso number(10,2);
    l_total_gasto number(10,2);
    l_id_presupuesto_del number;
  BEGIN
  
    SELECT COALESCE(MAX(ID_PRESUPUESTO),0)+1 INTO l_id_presupuesto FROM PSTO_PRESUPUESTO;
    
    SELECT D.id_evento into l_id_evento
    FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD B,
    PSTO_ACTIVIDAD D
    WHERE B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
    AND B.ID_ENTIDAD=P_ID_ENTIDAD
    AND B.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
    AND B.ID_AUXILIAR=P_ID_AUXILIAR
    GROUP BY D.id_evento;
    
    
    SELECT  NOMBRE INTO l_descripcion  FROM PSTO_EVENTO WHERE ID_EVENTO=l_id_evento;
    
    
    select 
      COUNT(*) INTO l_contar
      FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD B,
      PSTO_ACTIVIDAD D
      WHERE B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
      AND B.ID_ENTIDAD=P_ID_ENTIDAD
      AND B.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
      AND B.ID_AUXILIAR=P_ID_AUXILIAR
      AND (D.ID_TIPOPLAN IS NULL OR D.ID_CUENTAAASI IS NULL OR D.ID_RESTRICCION IS NULL);
    
    if l_contar>0 then
      l_error:=1;
      l_msgerror:='Falta asignar  cuenta contable denominacional a la actividad de evento '||l_descripcion;
    end if;
    
    if l_error=0 then
      SELECT  COUNT(*) INTO l_contar FROM PSTO_PRESUPUESTO 
      WHERE ID_EVENTO=l_id_evento
      AND ID_ENTIDAD=P_ID_ENTIDAD
      AND ID_ANHO=P_ID_ANHO
      AND ESTADO='2';
      
      
        
      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Ya esta aprobado presupuesto del evento '||l_descripcion||' para el año ' ||to_char(P_ID_ANHO);
      else
      
        
        SELECT  COUNT(*) INTO l_contar FROM PSTO_PRESUPUESTO 
        WHERE ID_EVENTO=l_id_evento
        AND ID_ENTIDAD=P_ID_ENTIDAD
        AND ID_ANHO=P_ID_ANHO
        AND ESTADO='1';
        
        IF l_contar>0 THEN
          SELECT ID_PRESUPUESTO into l_id_presupuesto_del FROM PSTO_PRESUPUESTO 
          WHERE ID_EVENTO=l_id_evento
          AND ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_ANHO=P_ID_ANHO
          AND ESTADO='1';
          
          PKG_PRESUPUESTO.SP_ELIMINAR_PRESUPUESTO(l_id_presupuesto_del,P_ID_PERSONA);
          
        END IF;
        
      
        --CABECERA
        insert into PSTO_PRESUPUESTO(
          ID_PRESUPUESTO, 
          ID_ENTIDAD,
          ID_ANHO, 
          ID_EVENTO,
          ID_PSTONEGOCIO,
          ID_EJE,
          ID_DEPTO,
          ID_PERSONA,
          DESCRIPCION,
          FECHA, 
          ESTADO
        )values(
          l_id_presupuesto,
          P_ID_ENTIDAD,
          P_ID_ANHO,
          l_id_evento,
          P_ID_PSTONEGOCIO,
          P_ID_EJE,
          P_ID_DEPTO_PADRE,
          P_ID_PERSONA,
          l_descripcion,
          sysdate,
          '1'
        );
    
        --DETALLE
        INSERT INTO PSTO_PRESUPUESTO_DET(
            ID_PRESUPUESTO_DET,
            ID_PRESUPUESTO,
            ID_ACTIVIDAD,
            ID_ENTIDAD, 
            ID_DEPTO, 
            ID_DEPTO_ASIENTO,
            TIPO,
            DESCRIPCION,
            CANTIDAD,
            PUNIDAD,
            A, 
            B, 
            C,
            D, 
            E,
            F, 
            G,
            TOTAL,
            ID_TIPOPLAN,
            ID_CUENTAAASI,
            ID_RESTRICCION,
            ID_CTACTE,
            ID_TIPOCTACTE,
            ID_ENTIDAD_CTACTE
          )
        SELECT
            ROWNUM AS ID_PRESUPUESTO_DET, 
            l_id_presupuesto AS ID_PRESUPUESTO,
            M.ID_ACTIVIDAD,
            M.ID_ENTIDAD,
            M.ID_DEPTO,
            M.ID_DEPTO_ASIENTO,
            M.TIPO,
            M.DESCRIPCION,
            M.CANTIDAD,
            M.PUNIDAD,
            M.A,
            M.B,
            M.C, 
            M.D,
            M.E, 
            M.F,
            M.G,
            M.TOTAL,
            M.ID_TIPOPLAN,
            M.ID_CUENTAAASI,
            M.ID_RESTRICCION,
            M.ID_CTACTE,
            M.ID_TIPOCTACTE,
            M.ID_ENTIDAD_CTACTE
        FROM(
            select 
            B.ID_ACTIVIDAD,
            C.ID_ENTIDAD,
            C.ID_DEPTO,
            COALESCE(D.ID_DEPTO,C.ID_DEPTO) AS ID_DEPTO_ASIENTO,
            D.TIPO,
            D.NOMBRE AS DESCRIPCION,
            0 AS CANTIDAD,
            0 AS PUNIDAD,
            0 AS A,
            0 AS B,
            0 AS C,
            0 AS D, 
            0 AS E, 
            0 AS F,
            0 AS G,
            COALESCE(SUM(COALESCE(IMPORTE,0)),0) AS TOTAL,
            D.ID_TIPOPLAN,
            D.ID_CUENTAAASI,
            D.ID_RESTRICCION,
            D.ID_CTACTE,
            D.ID_TIPOCTACTE,
            D.ID_ENTIDAD_CTACTE
            FROM PSTO_PLLA_PLANILLA_ACTIVIDAD A,PSTO_PLLA_CONCEPTO_ACTIVIDAD B,PSTO_PLLA_PLANILLA C,PSTO_ACTIVIDAD D
            WHERE A.ID_CONCEPTO_ACTIVIDAD=B.ID_CONCEPTO_ACTIVIDAD
            AND A.ID_PSTO_PLANILLA=C.ID_PSTO_PLANILLA
            AND B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
            AND (A.IMPORTE)>0
            AND C.ID_ENTIDAD=P_ID_ENTIDAD
            AND C.ID_ANHO=P_ID_ANHO
            AND C.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            AND B.ID_AUXILIAR=C.ID_AUXILIAR
            AND B.ID_AUXILIAR=P_ID_AUXILIAR
            GROUP BY B.ID_ACTIVIDAD,
            C.ID_ENTIDAD,
            C.ID_DEPTO,
            COALESCE(D.ID_DEPTO,C.ID_DEPTO),
            D.TIPO,
            D.NOMBRE,
            D.ID_TIPOPLAN,
            D.ID_CUENTAAASI,
            D.ID_RESTRICCION,
            D.ID_CTACTE,
            D.ID_TIPOCTACTE,
            D.ID_ENTIDAD_CTACTE
            
        )M;
        
        
        MERGE INTO PSTO_PRESUPUESTO_DET C 
        USING (SELECT 
                A.ID_PRESUPUESTO,
                A.ID_PRESUPUESTO_DET,
                B.NOMBRE
                FROM PSTO_PRESUPUESTO_DET A,CONTA_ENTIDAD_DEPTO B
                WHERE A.ID_ENTIDAD=B.ID_ENTIDAD
                AND A.ID_DEPTO=B.ID_DEPTO
                AND A.ID_PRESUPUESTO=l_id_presupuesto
              )t
          ON (C.ID_PRESUPUESTO=t.ID_PRESUPUESTO and C.ID_PRESUPUESTO_DET=t.ID_PRESUPUESTO_DET and C.ID_PRESUPUESTO=l_id_presupuesto)
          WHEN  MATCHED THEN UPDATE SET  
            C.DEPTO_NOMBRE=t.NOMBRE;
            
        MERGE INTO PSTO_PRESUPUESTO_DET C 
        USING (SELECT 
                A.ID_PRESUPUESTO,
                A.ID_PRESUPUESTO_DET,
                B.NOMBRE
                FROM PSTO_PRESUPUESTO_DET A,CONTA_ENTIDAD_DEPTO B
                WHERE A.ID_ENTIDAD=B.ID_ENTIDAD
                AND A.ID_DEPTO_ASIENTO=B.ID_DEPTO
                AND A.ID_PRESUPUESTO=l_id_presupuesto
              )t
          ON (C.ID_PRESUPUESTO=t.ID_PRESUPUESTO and C.ID_PRESUPUESTO_DET=t.ID_PRESUPUESTO_DET and C.ID_PRESUPUESTO=l_id_presupuesto)
          WHEN  MATCHED THEN UPDATE SET  
            C.DEPTO_ASIENTO_NOMBRE=t.NOMBRE;
        
  
        select 
        coalesce(sum(case when tipo='I' then TOTAL else 0 end),0),
        coalesce(sum(case when tipo='G' then TOTAL else 0 end),0)
        into 
        l_total_ingreso,
        l_total_gasto
        from  PSTO_PRESUPUESTO_DET
        where ID_PRESUPUESTO=l_id_presupuesto;
        
        update PSTO_PRESUPUESTO set
        TOTAL_INGRESO=l_total_ingreso,
        TOTAL_GASTO=l_total_gasto
        where ID_PRESUPUESTO=l_id_presupuesto;
        
        
        PKG_PRESUPUESTO.SP_ASIENTO_PRESUPUESTO(l_id_presupuesto,P_ID_PERSONA);
        
        select count(*) into l_contar from psto_auxiliar_anho
        where id_auxiliar=P_ID_AUXILIAR
        and id_anho=P_ID_ANHO;
      
        if l_contar=0 then
          insert into psto_auxiliar_anho(id_anho,id_auxiliar,estado) values(P_ID_ANHO,P_ID_AUXILIAR,'01');
        else
          update psto_auxiliar_anho set estado='01'
          where id_auxiliar=P_ID_AUXILIAR
          and id_anho=P_ID_ANHO;
        end if;
  
      end if;
    end if;
    
  
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
    
  END SP_PLANILLA_PRESUPUESTO;
  */
  PROCEDURE SP_PLANILLA_PRESUPUESTO(P_ID_ENTIDAD NUMBER,P_ID_DEPTO_PADRE VARCHAR2,P_ID_ANHO NUMBER,P_ID_PERSONA NUMBER,P_ID_PSTONEGOCIO NUMBER,P_ID_EJE NUMBER,P_ID_AUXILIAR NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_contar number;
    l_id_presupuesto number;
    l_id_evento number;
    l_descripcion varchar2(300);
    l_total_ingreso number(10,2);
    l_total_gasto number(10,2);
    l_id_presupuesto_del number;
    l_id_auxiliar number;
    l_id_psto_planilla number;
    
    l_cerror number:=0;
    l_cmsgerror varchar2(200):='';
    
    CURSOR cur IS  select ID_PSTO_PLANILLA from  PSTO_PLLA_PLANILLA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND P_ID_DEPTO_PADRE=P_ID_DEPTO_PADRE AND ID_ANHO=P_ID_ANHO;
    
  BEGIN
  
 
    SELECT D.id_evento into l_id_evento
    FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD B,
    PSTO_ACTIVIDAD D
    WHERE B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
    AND B.ID_ENTIDAD=P_ID_ENTIDAD
    AND B.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
    AND B.AUXI_IDENTIFICADOR='PL'
    GROUP BY D.id_evento;
    
    
    SELECT  NOMBRE INTO l_descripcion  FROM PSTO_EVENTO WHERE ID_EVENTO=l_id_evento;
    
    
    select 
      COUNT(*) INTO l_contar
      FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD B,
      PSTO_ACTIVIDAD D
      WHERE B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
      AND B.ID_ENTIDAD=P_ID_ENTIDAD
      AND B.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
      AND B.AUXI_IDENTIFICADOR='PL'
      AND (D.ID_TIPOPLAN IS NULL OR D.ID_CUENTAAASI IS NULL OR D.ID_RESTRICCION IS NULL);
    
    if l_contar>0 then
      l_error:=1;
      l_msgerror:='Falta asignar  cuenta contable denominacional a la actividad de evento '||l_descripcion;
    end if;
    --l_error:=0;
    if l_error=0 then
      SELECT  COUNT(*) INTO l_contar FROM PSTO_PRESUPUESTO 
      WHERE ID_EVENTO=l_id_evento
      AND ID_ENTIDAD=P_ID_ENTIDAD
      AND ID_ANHO=P_ID_ANHO
      AND ESTADO='2';
      
      
        
      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Ya esta aprobado presupuesto del evento '||l_descripcion||' para el año ' ||to_char(P_ID_ANHO);
      else
      
        
        SELECT  COUNT(*) INTO l_contar FROM PSTO_PRESUPUESTO 
        WHERE ID_EVENTO=l_id_evento
        AND ID_ENTIDAD=P_ID_ENTIDAD
        AND ID_ANHO=P_ID_ANHO
        AND ESTADO='1';
        
        IF l_contar>0 THEN
          SELECT ID_PRESUPUESTO into l_id_presupuesto_del FROM PSTO_PRESUPUESTO 
          WHERE ID_EVENTO=l_id_evento
          AND ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_ANHO=P_ID_ANHO
          AND ESTADO='1';
          
          PKG_PRESUPUESTO.SP_ELIMINAR_PRESUPUESTO(l_id_presupuesto_del,P_ID_PERSONA);
          
        END IF;
        
        OPEN cur;
        FETCH cur INTO l_id_psto_planilla;
        
        WHILE cur%FOUND LOOP

              PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_DIST_DET(l_id_psto_planilla,l_cerror,l_cmsgerror);

          FETCH cur INTO l_id_psto_planilla;
          
        END LOOP;
        CLOSE cur; 
        
        
        
       SELECT COALESCE(MAX(ID_PRESUPUESTO),0)+1 INTO l_id_presupuesto FROM PSTO_PRESUPUESTO;
        --CABECERA
        insert into PSTO_PRESUPUESTO(
          ID_PRESUPUESTO, 
          ID_ENTIDAD,
          ID_ANHO, 
          ID_EVENTO,
          ID_PSTONEGOCIO,
          ID_EJE,
          ID_DEPTO,
          ID_PERSONA,
          DESCRIPCION,
          FECHA, 
          ESTADO
        )values(
          l_id_presupuesto,
          P_ID_ENTIDAD,
          P_ID_ANHO,
          l_id_evento,
          P_ID_PSTONEGOCIO,
          P_ID_EJE,
          P_ID_DEPTO_PADRE,
          P_ID_PERSONA,
          l_descripcion,
          sysdate,
          '1'
        );
    
        --DETALLE
        INSERT INTO PSTO_PRESUPUESTO_DET(
            ID_PRESUPUESTO_DET,
            ID_PRESUPUESTO,
            ID_ACTIVIDAD,
            ID_ENTIDAD, 
            ID_DEPTO, 
            ID_DEPTO_ASIENTO,
            TIPO,
            DESCRIPCION,
            CANTIDAD,
            PUNIDAD,
            A, 
            B, 
            C,
            D, 
            E,
            F, 
            G,
            TOTAL,
            ID_TIPOPLAN,
            ID_CUENTAAASI,
            ID_RESTRICCION,
            ID_CTACTE,
            ID_TIPOCTACTE,
            ID_ENTIDAD_CTACTE,
            MES1,
            MES2,
            MES3,
            MES4,
            MES5,
            MES6,
            MES7,
            MES8,
            MES9,
            MES10,
            MES11,
            MES12
          )
        SELECT
            ROWNUM AS ID_PRESUPUESTO_DET, 
            l_id_presupuesto AS ID_PRESUPUESTO,
            M.ID_ACTIVIDAD,
            M.ID_ENTIDAD,
            M.ID_DEPTO,
            M.ID_DEPTO_ASIENTO,
            M.TIPO,
            M.DESCRIPCION,
            M.CANTIDAD,
            M.PUNIDAD,
            M.A,
            M.B,
            M.C, 
            M.D,
            M.E, 
            M.F,
            M.G,
            M.TOTAL,
            M.ID_TIPOPLAN,
            M.ID_CUENTAAASI,
            M.ID_RESTRICCION,
            M.ID_CTACTE,
            M.ID_TIPOCTACTE,
            M.ID_ENTIDAD_CTACTE,
            M.MES1,
            M.MES2,
            M.MES3,
            M.MES4,
            M.MES5,
            M.MES6,
            M.MES7,
            M.MES8,
            M.MES9,
            M.MES10,
            M.MES11,
            M.MES12
        FROM(
            select 
            B.ID_ACTIVIDAD,
            C.ID_ENTIDAD,
            C.ID_DEPTO,
            COALESCE(D.ID_DEPTO,X.ID_DEPTO) AS ID_DEPTO_ASIENTO,
            D.TIPO,
            D.NOMBRE AS DESCRIPCION,
            0 AS CANTIDAD,
            0 AS PUNIDAD,
            0 AS A,
            0 AS B,
            0 AS C,
            0 AS D, 
            0 AS E, 
            0 AS F,
            0 AS G,
            COALESCE(SUM(COALESCE(A.IMPORTE,0)),0) AS TOTAL,
            D.ID_TIPOPLAN,
            D.ID_CUENTAAASI,
            D.ID_RESTRICCION,
            D.ID_CTACTE,
            D.ID_TIPOCTACTE,
            D.ID_ENTIDAD_CTACTE,
            COALESCE(SUM(COALESCE(A.MES1,0)),0) AS MES1,
            COALESCE(SUM(COALESCE(A.MES2,0)),0) AS MES2,
            COALESCE(SUM(COALESCE(A.MES3,0)),0) AS MES3,
            COALESCE(SUM(COALESCE(A.MES4,0)),0) AS MES4,
            COALESCE(SUM(COALESCE(A.MES5,0)),0) AS MES5,
            COALESCE(SUM(COALESCE(A.MES6,0)),0) AS MES6,
            COALESCE(SUM(COALESCE(A.MES7,0)),0) AS MES7,
            COALESCE(SUM(COALESCE(A.MES8,0)),0) AS MES8,
            COALESCE(SUM(COALESCE(A.MES9,0)),0) AS MES9,
            COALESCE(SUM(COALESCE(A.MES10,0)),0) AS MES10,
            COALESCE(SUM(COALESCE(A.MES11,0)),0) AS MES11,
            COALESCE(SUM(COALESCE(A.MES12,0)),0) AS MES12
            FROM PSTO_PLLA_PLANILLA_DIST_DET A,PSTO_PLLA_PLANILLA_DIST X ,PSTO_PLLA_CONCEPTO_ACTIVIDAD B,PSTO_PLLA_PLANILLA C,PSTO_ACTIVIDAD D
            WHERE A.ID_PLLA_PLANILLA_DIST=X.ID_PLLA_PLANILLA_DIST
            AND A.ID_CONCEPTO_ACTIVIDAD=B.ID_CONCEPTO_ACTIVIDAD
            AND X.ID_PSTO_PLANILLA=C.ID_PSTO_PLANILLA
            AND B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
            AND (A.IMPORTE)>0
            AND C.ID_ENTIDAD=P_ID_ENTIDAD
            AND C.ID_ANHO=P_ID_ANHO
            AND C.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            AND B.AUXI_IDENTIFICADOR='PL'
            GROUP BY B.ID_ACTIVIDAD,
            C.ID_ENTIDAD,
            C.ID_DEPTO,
            COALESCE(D.ID_DEPTO,X.ID_DEPTO),
            D.TIPO,
            D.NOMBRE,
            D.ID_TIPOPLAN,
            D.ID_CUENTAAASI,
            D.ID_RESTRICCION,
            D.ID_CTACTE,
            D.ID_TIPOCTACTE,
            D.ID_ENTIDAD_CTACTE
            ORDER BY B.ID_ACTIVIDAD,C.ID_DEPTO
            
        )M;
        
        
        MERGE INTO PSTO_PRESUPUESTO_DET C 
        USING (SELECT 
                A.ID_PRESUPUESTO,
                A.ID_PRESUPUESTO_DET,
                B.NOMBRE
                FROM PSTO_PRESUPUESTO_DET A,CONTA_ENTIDAD_DEPTO B
                WHERE A.ID_ENTIDAD=B.ID_ENTIDAD
                AND A.ID_DEPTO=B.ID_DEPTO
                AND A.ID_PRESUPUESTO=l_id_presupuesto
              )t
          ON (C.ID_PRESUPUESTO=t.ID_PRESUPUESTO and C.ID_PRESUPUESTO_DET=t.ID_PRESUPUESTO_DET and C.ID_PRESUPUESTO=l_id_presupuesto)
          WHEN  MATCHED THEN UPDATE SET  
            C.DEPTO_NOMBRE=t.NOMBRE;
            
        MERGE INTO PSTO_PRESUPUESTO_DET C 
        USING (SELECT 
                A.ID_PRESUPUESTO,
                A.ID_PRESUPUESTO_DET,
                B.NOMBRE
                FROM PSTO_PRESUPUESTO_DET A,CONTA_ENTIDAD_DEPTO B
                WHERE A.ID_ENTIDAD=B.ID_ENTIDAD
                AND A.ID_DEPTO_ASIENTO=B.ID_DEPTO
                AND A.ID_PRESUPUESTO=l_id_presupuesto
              )t
          ON (C.ID_PRESUPUESTO=t.ID_PRESUPUESTO and C.ID_PRESUPUESTO_DET=t.ID_PRESUPUESTO_DET and C.ID_PRESUPUESTO=l_id_presupuesto)
          WHEN  MATCHED THEN UPDATE SET  
            C.DEPTO_ASIENTO_NOMBRE=t.NOMBRE;
        
  
        select 
        coalesce(sum(case when tipo='I' then TOTAL else 0 end),0),
        coalesce(sum(case when tipo='G' then TOTAL else 0 end),0)
        into 
        l_total_ingreso,
        l_total_gasto
        from  PSTO_PRESUPUESTO_DET
        where ID_PRESUPUESTO=l_id_presupuesto;
        
        update PSTO_PRESUPUESTO set
        TOTAL_INGRESO=l_total_ingreso,
        TOTAL_GASTO=l_total_gasto
        where ID_PRESUPUESTO=l_id_presupuesto;
        
        
        PKG_PSTOPLANILLA.SP_GEN_PSTO_DET_DIST_PLLA(l_id_presupuesto);
        
        
        PKG_PRESUPUESTO.SP_ASIENTO_PRESUPUESTO(l_id_presupuesto,P_ID_PERSONA);
        
        
        select id_auxiliar into l_id_auxiliar from psto_evento where id_evento=l_id_evento;
        
        select count(*) into l_contar from psto_auxiliar_anho
        where id_auxiliar=P_ID_AUXILIAR
        and id_anho=P_ID_ANHO;
      
        if l_contar=0 then
          insert into psto_auxiliar_anho(id_anho,id_auxiliar,estado) values(P_ID_ANHO,P_ID_AUXILIAR,'01');
        else
          update psto_auxiliar_anho set estado='01'
          where id_auxiliar=P_ID_AUXILIAR
          and id_anho=P_ID_ANHO;
        end if;
  
      end if;
    end if;
    
  
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
    
  END SP_PLANILLA_PRESUPUESTO;
   PROCEDURE SP_GENERAR_PROCESO_MISIONERO(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_contar number;
    l_id_psto_ayudas number;
    l_id_psto_movlibdis number;
    l_id_psto_puntaje_mis number;
    l_id_psto_vivienda number;
    l_anho number;
    l_mes number;
  BEGIN
  --AYUDAS

         
    select IMPORTE INTO l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;
          
    select IMPORTE INTO l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;
            
    SELECT COALESCE(MAX(ID_PSTO_AYUDAS),0) INTO l_id_psto_ayudas FROM PSTO_PLLA_AYUDAS;
    
    INSERT INTO PSTO_PLLA_AYUDAS(
    ID_PSTO_AYUDAS,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO
    )
    SELECT 
    ROWNUM + l_id_psto_ayudas AS ID_PSTO_AYUDAS,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO
    FROM(
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO
      FROM APS_PLANILLA A
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN(
        SELECT X.ID_PERSONA FROM PSTO_PLLA_AYUDAS X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      )
      ORDER BY  A.ID_PERSONA 
    )X;
    
    /*DELETE FROM PSTO_PLLA_AYUDAS
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
    --MOVILIDAD DISPONIBILIDAD
    SELECT COALESCE(MAX(ID_PSTO_MOVLIBDIS),0) INTO l_id_psto_movlibdis FROM PSTO_PLLA_MOVLIBDIS;
    
    INSERT INTO PSTO_PLLA_MOVLIBDIS(
    ID_PSTO_MOVLIBDIS,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO,
    ID_TIPOESTATUS,
    ID_TIPOPAIS
    )
    SELECT 
    ROWNUM + l_id_psto_movlibdis AS ID_PSTO_MOVLIBDIS,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO,
    X.ID_TIPOESTATUS,
    X.ID_TIPOPAIS
    FROM(
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO,
      A.ID_TIPOESTATUS,
      P.ID_TIPOPAIS,
      A.FMR
      FROM APS_PLANILLA A LEFT JOIN PERSONA_NATURAL P
      ON A.ID_PERSONA=P.ID_PERSONA
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN(
        SELECT X.ID_PERSONA FROM PSTO_PLLA_MOVLIBDIS X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      )
      ORDER BY  A.ID_PERSONA 
    )X;
    
    /*DELETE FROM PSTO_PLLA_MOVLIBDIS
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
    
    --PUNTAJE 
    SELECT COALESCE(MAX(ID_PSTO_PUNTAJE_MIS),0) INTO l_id_psto_puntaje_mis FROM PSTO_PLLA_PUNTAJE_MIS;
    
    INSERT INTO PSTO_PLLA_PUNTAJE_MIS(
    ID_PSTO_PUNTAJE_MIS,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO,
    ID_TIPOESTATUS,
    ID_TIPOPAIS,
    PUNT_ANT
    )
    SELECT 
    ROWNUM + l_id_psto_puntaje_mis AS ID_PSTO_PUNTAJE_MIS,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO,
    X.ID_TIPOESTATUS,
    X.ID_TIPOPAIS,
    X.FMR
    FROM(
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO,
      A.ID_TIPOESTATUS,
      P.ID_TIPOPAIS,
      A.FMR
      FROM APS_PLANILLA A LEFT JOIN PERSONA_NATURAL P
      ON A.ID_PERSONA=P.ID_PERSONA
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN(
        SELECT X.ID_PERSONA FROM PSTO_PLLA_PUNTAJE_MIS X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      )
      ORDER BY  A.ID_PERSONA 
    )X;
    
    /*DELETE FROM PSTO_PLLA_PUNTAJE_MIS
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
    
    --vivienda
    SELECT COALESCE(MAX(ID_PSTO_VIVIENDA),0) INTO l_id_psto_vivienda FROM PSTO_PLLA_VIVIENDA;
    
    INSERT INTO PSTO_PLLA_VIVIENDA(
    ID_PSTO_VIVIENDA,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO
    )
    SELECT 
    ROWNUM + l_id_psto_vivienda AS ID_PSTO_VIVIENDA,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO
    FROM(
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO
      FROM APS_PLANILLA A
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN(
        SELECT X.ID_PERSONA FROM PSTO_PLLA_VIVIENDA X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      )
      ORDER BY  A.ID_PERSONA 
    )X;
    
    /*DELETE FROM PSTO_PLLA_VIVIENDA
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
  END SP_GENERAR_PROCESO_MISIONERO;
  
  
  PROCEDURE SP_GEN_PSTO_DET_DIST_PLLA(P_ID_PRESUPUESTO NUMBER) IS

     
      l_mes number;
      l_mes_d varchar(2);
      l_sql varchar2(3000);
      
    BEGIN
       
      
      DELETE FROM PSTO_PRESUPUESTO_DET_DIST WHERE ID_PRESUPUESTO=P_ID_PRESUPUESTO;
      
      
       l_mes:=1;
          
       
        
       while l_mes<=12 loop
         
         l_sql:='INSERT INTO PSTO_PRESUPUESTO_DET_DIST(ID_PRESUPUESTO_DET,ID_PRESUPUESTO,ID_MES,IMPORTE,PORCENTAJE,MESES) ';
         l_sql:=l_sql||'SELECT B.ID_PRESUPUESTO_DET,B.ID_PRESUPUESTO,'||to_char(l_mes)||' AS ID_MES,B.MES'||to_char(l_mes)||',0 AS PORCENTAJE,';
         l_sql:=l_sql||'CASE WHEN B.MES1>0 THEN 1 ELSE 0 END+CASE WHEN B.MES2>0 THEN 1 ELSE 0 END+CASE WHEN B.MES3>0 THEN 1 ELSE 0 END+';
         l_sql:=l_sql||'CASE WHEN B.MES4>0 THEN 1 ELSE 0 END+CASE WHEN B.MES5>0 THEN 1 ELSE 0 END+CASE WHEN B.MES6>0 THEN 1 ELSE 0 END+';
         l_sql:=l_sql||'CASE WHEN B.MES7>0 THEN 1 ELSE 0 END+CASE WHEN B.MES8>0 THEN 1 ELSE 0 END+CASE WHEN B.MES9>0 THEN 1 ELSE 0 END+';
         l_sql:=l_sql||'CASE WHEN B.MES10>0 THEN 1 ELSE 0 END+CASE WHEN B.MES11>0 THEN 1 ELSE 0 END+CASE WHEN B.MES12>0 THEN 1 ELSE 0 END AS MESES ';
         l_sql:=l_sql||'FROM PSTO_PRESUPUESTO_DET B  WHERE B.ID_PRESUPUESTO=:PARAMETRO AND B.MES'||to_char(l_mes)||'>0';
        
         EXECUTE IMMEDIATE l_sql USING P_ID_PRESUPUESTO;
        l_mes:=l_mes+1;
      end loop;
      
           
    END SP_GEN_PSTO_DET_DIST_PLLA;
    
    
     PROCEDURE SP_GENERAR_PLANILLA_DIST_EXCEL(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_NUM_DOC VARCHAR2,P_ID_DEPTO VARCHAR2,P_PORCENTAJE NUMBER,P_TIPO VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
     
    --P_ID_PSTO_PLANILLA NUMBER,P_ID_DEPTO VARCHAR2,P_ID_TEMPORADA VARCHAR2,P_PORCENTAJE NUMBER,P_TIPO VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2
          P_ID_PSTO_PLANILLA NUMBER;
          P_ID_TEMPORADA VARCHAR2(5);
          
          l_error number:=0;
          l_msgerror varchar2(200):='';
          l_contar number;
          l_contar1 number;
          
          l_id_entidad number;
          
 
        BEGIN
        
        l_id_entidad:=P_ID_ENTIDAD;
        
        SELECT COUNT(*) INTO l_contar FROM PSTO_PLLA_PLANILLA
        WHERE ID_ENTIDAD=l_id_entidad
        AND ID_ANHO=P_ID_ANHO
        AND ID_DEPTO_PADRE=SUBSTR(P_ID_DEPTO,1,1)
        AND ID_PERSONA IN(
          SELECT ID_PERSONA FROM PERSONA_DOCUMENTO WHERE NUM_DOCUMENTO=P_NUM_DOC
        );
        
        IF l_contar=1 THEN
        
          SELECT ID_PSTO_PLANILLA,ID_TEMPORADA INTO P_ID_PSTO_PLANILLA,P_ID_TEMPORADA FROM PSTO_PLLA_PLANILLA
          WHERE ID_ENTIDAD=l_id_entidad
          AND ID_ANHO=P_ID_ANHO
          AND ID_DEPTO_PADRE=SUBSTR(P_ID_DEPTO,1,1)
          AND ID_PERSONA IN(
            SELECT ID_PERSONA FROM PERSONA_DOCUMENTO WHERE NUM_DOCUMENTO=P_NUM_DOC
          );
          
          SELECT COUNT(*) INTO l_contar FROM PSTO_PLLA_PLANILLA_DIST
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
          AND ID_DEPTO=P_ID_DEPTO
          AND ID_ENTIDAD=l_id_entidad;
          
          select COUNT(*) INTO l_contar1 from vw_area_depto where id_entidad=l_id_entidad and ID_DEPTO=P_ID_DEPTO;
          
          IF l_contar=0 and l_contar1=1 THEN
          
            PKG_PSTOPLANILLA.SP_GENERAR_PLANILLA_DIST(P_ID_PSTO_PLANILLA,P_ID_DEPTO,P_ID_TEMPORADA,P_PORCENTAJE,P_TIPO,l_error,l_msgerror);
          END IF;
        END IF;         
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        
        END SP_GENERAR_PLANILLA_DIST_EXCEL;
        
        PROCEDURE SP_REPROCESAR_PLANILLA(P_ID_ENTIDAD NUMBER,P_ID_ANHO NUMBER,P_ID_DEPTO_PADRE VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
          l_error number:=0;
          l_msgerror varchar2(200):='';
          
          l_id_psto_planilla number;
          
          CURSOR cur IS  select ID_PSTO_PLANILLA from  PSTO_PLLA_PLANILLA 
          WHERE ID_ENTIDAD=P_ID_ENTIDAD 
          AND P_ID_DEPTO_PADRE=P_ID_DEPTO_PADRE 
          AND ID_ANHO=P_ID_ANHO;
          
        BEGIN
        
          OPEN cur;
          FETCH cur INTO l_id_psto_planilla;
          
          WHILE cur%FOUND LOOP
  
                PKG_PSTOPLANILLA.SP_ACTUALIZAR_PLANILLA_EMP(l_id_psto_planilla,l_error,l_msgerror);
  
            FETCH cur INTO l_id_psto_planilla;
            
          END LOOP;
          CLOSE cur; 

          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;
          
        END SP_REPROCESAR_PLANILLA;
        
END PKG_PSTOPLANILLA;