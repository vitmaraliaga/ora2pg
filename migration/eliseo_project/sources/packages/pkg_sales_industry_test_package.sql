-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE PKG_SALES_INDUSTRY_TEST AS 

  /* TODO enter package declarations (types, exceptions, methods etc) here */ 
    FUNCTION FC_VENTA(P_ID_VENTA IN NUMBER) RETURN VARCHAR2;
	FUNCTION FC_NOTA_CREDITO(P_ID_VENTA IN NUMBER) RETURN VARCHAR2;
	PROCEDURE SP_ANULAR_VENTAS_REG(P_ID_VENTA NUMBER, P_ID_PERSONA NUMBER, P_MOTIVO VARCHAR2, P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2);

	
END PKG_SALES_INDUSTRY_TEST;


CREATE OR REPLACE PACKAGE BODY PKG_SALES_INDUSTRY_TEST AS

  

	FUNCTION FC_NOTA_CREDITO(P_ID_VENTA IN NUMBER) RETURN VARCHAR2 IS
        S_DETALLE       VARCHAR2(4000);
        S_VENTA         VARCHAR2(4000);
        S_CONTA         INT;
        
          S_TIPODOC       VARCHAR2(2);
        L_ID_TIPOVENTA NUMBER;
        
        S_ID_RUC      VARCHAR2(20);
        S_ERROR         VARCHAR2(1) := 'N';
        

        TYPE cv_typ IS REF CURSOR;
        VENTA cv_typ;
        
    BEGIN  
    S_CONTA:=0;
    SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
    AND E.ID_EMPRESA = M.ID_EMPRESA
    AND V.ID_VENTA = P_ID_VENTA;
    
    SELECT ID_COMPROBANTE,ID_TIPOVENTA INTO S_TIPODOC, L_ID_TIPOVENTA FROM VENTA WHERE ID_VENTA=P_ID_VENTA;
    
        IF S_TIPODOC='07' THEN -- NOTA
                open VENTA FOR  
SELECT 'CC'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'07'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		'|'||S_ID_RUC|| 
		'|'||decode(SUBSTR(a.serie_ref,1,1),'F','6',DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0))|| 
    '|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',NVL(eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_legal,A.ID_CLIENTE)),'-'),DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000'))||
    '|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE_legal,A.ID_CLIENTE)),eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE,A.ID_CLIENTE_legal)))||
		'|'||REGEXP_REPLACE (nvl(TRIM(eliseo.PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','')|| 
		'|'||''|| 
		'|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',trim(eliseo.FC_EMAIL(A.ID_CLIENTE_legal)),trim(eliseo.FC_EMAIL(A.ID_CLIENTE)))||
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END))||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END))||
		'|'||'0.00'|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END))||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END))|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN nvl(A.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.DESCUENTO,0),'9999999999D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999999D99')),',','.') END))||
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
        '|'||'1000'|| 
        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
        '|'||decode(SUBSTR(a.serie_ref,1,1),'F','01','03')|| 
        '|'||a.serie_ref||'-'||a.numero_ref|| 
        '|'||'01'|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM eliseo.VENTA A
        WHERE A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       UNION ALL 
 SELECT  'DC'||	'|'||ROWNUM||
			'|'||nvl(B.ID_ARTICULO,'86121701001')|| 
			'|'||nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121701')|| 
			'|'||'NIU'|| 
			'|'||b.cantidad|| 
			'|'||nvl(b.detalle,'Venta UPeU')|| 
	    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999999D99')),',','.') END))||
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
			'|'||b.ID_TIPOIGV|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END))|| 
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999999D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999999D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN nvl(B.BASE,0)  BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE,0) ,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE,0) ,'9999999999D99')),',','.') END),(CASE  WHEN nvl(B.BASE_ME,0)  = 0 THEN '0.00' WHEN nvl(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE_ME,0),'9999999999D99')),',','.') END))||			
			'|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;                
                
    ELSIF S_TIPODOC = '08' THEN  -- DEBITO
        
            open VENTA FOR         
    SELECT 'CD'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'08'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		'|'||S_ID_RUC|| 
		'|'||decode(SUBSTR(a.serie_ref,1,1),'F','6','1')|| 
    '|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',NVL(eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_legal,A.ID_CLIENTE)),'-'),eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)))||
    '|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE_legal,A.ID_CLIENTE)),eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE,A.ID_CLIENTE_legal)))||
		'|'||REGEXP_REPLACE (nvl(TRIM(decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',eliseo.FC_DIRECCION_CLIENTE(nvl(A.ID_CLIENTE_legal,A.ID_CLIENTE)),eliseo.FC_DIRECCION_CLIENTE(nvl(A.ID_CLIENTE,A.ID_CLIENTE_legal)))),'Sin Direccion'),'-','')|| 
		'|'||''|| 
		'|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',trim(eliseo.FC_EMAIL(A.ID_CLIENTE_legal)),trim(eliseo.FC_EMAIL(A.ID_CLIENTE)))||		
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END))||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END))||
		'|'||'0.00'|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END))||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
                    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END))|| 
    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END))|| 
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN nvl(A.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.DESCUENTO,0),'9999999999D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999999D99')),',','.') END))||
		'|'||'0.00'||
		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END))|| 
        '|'||'1000'|| 
        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
        '|'||decode(SUBSTR(a.serie_ref,1,1),'F','01','03')|| 
        '|'||a.serie_ref||'-'||a.numero_ref|| 
        '|'||'01'|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM eliseo.VENTA A
        WHERE A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       UNION ALL 
 SELECT  'DD'||	'|'||ROWNUM||
			'|'||''|| 
			'|'||''|| 
			'|'||'NIU'|| 
			'|'||b.cantidad|| 
			'|'||nvl(b.detalle,'Venta UPeU')|| 
	    '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999999D99')),',','.') END))||
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
			'|'||b.ID_TIPOIGV|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN nvl(B.DESCUENTO,0) >0 THEN TO_CHAR(B.BASE,'9999999999.99') ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.BASE_ME,'9999999999.99') ELSE '0.00' END))||    
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END))|| 
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999999D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999999D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN nvl(B.BASE,0)  BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE,0) ,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE,0) ,'9999999999D99')),',','.') END),(CASE  WHEN nvl(B.BASE_ME,0)  = 0 THEN '0.00' WHEN nvl(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE_ME,0),'9999999999D99')),',','.') END))||			
			'|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;
        
        END IF;
    
    
    fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
            END IF;
        
            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	
        
        RETURN(TO_CLOB(S_DETALLE));
    END;
   
	 FUNCTION FC_VENTA(P_ID_VENTA IN NUMBER) RETURN VARCHAR2 IS
        S_DETALLE       VARCHAR2(4000);
        --S_DETALLE       LONG;
        S_VENTA         VARCHAR2(4000);
        --S_VENTA         LONG;
        S_CONTA         INT;
        S_TIPODOC       VARCHAR2(2);
        L_ID_TIPOVENTA NUMBER;
        S_ID_TIPOIGV         VARCHAR2(4000);
        
        S_ID_RUC      VARCHAR2(20);
        S_ERROR         VARCHAR2(1) := 'N';
        
        TYPE cv_typ IS REF CURSOR;
        VENTA cv_typ;
        
    BEGIN  
    S_CONTA:=0;
    SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
    AND E.ID_EMPRESA = M.ID_EMPRESA
    AND V.ID_VENTA = P_ID_VENTA;
    
    SELECT ID_COMPROBANTE,ID_TIPOVENTA INTO S_TIPODOC, L_ID_TIPOVENTA FROM VENTA WHERE ID_VENTA=P_ID_VENTA;
    SELECT MAX(ID_TIPOIGV) INTO S_ID_TIPOIGV FROM VENTA_DETALLE WHERE ID_VENTA=P_ID_VENTA;
    
    IF S_ID_TIPOIGV = '10' THEN --GRABADO
    
	    IF S_TIPODOC='03' THEN -- BOLETA
	           --VENTAS SERVICIOS
	        open VENTA FOR  
	        SELECT distinct'CB'||'|'||'0101'||
	            '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
	            '|'||'03'|| 
	            '|'||A.SERIE||'-'||A.NUMERO||
	            '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
	            '|'||S_ID_RUC|| 
	            '|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0)||
	            '|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000')||
	            '|'||NVL(TRIM(FC_NOMBRE_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')||
	            '|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','')||
	            '|'||''|| 
	            '|'||trim(FC_EMAIL(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL)))|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END))|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.INAFECTA_ME,0) = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END))||
	            '|'||'0.00'|| 
	            '|'||decode(b.id_tipoigv,'40',DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END)),'0.00')||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END))|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.DESCUENTO_ME,0) = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999999D99')),',','.') END))||
	            '|'||'0.00'||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
	            '|'||'1000'|| 
	            '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''||    
	            '|' CAB 
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA   
	        AND A.ID_VENTA = P_ID_VENTA 
	        AND A.ESTADO = 1 		
	        UNION ALL 
	        SELECT  'DB'||	'|'||ROWNUM||
	                '|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
	                '|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||   
	            '|'||'NIU'|| 
	            '|'||(case when length(trim(to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(to_char(b.cantidad,'9999999999.99'))else trim(to_char(b.cantidad,'9999999999.99')) END)|| 
	            '|'||nvl(b.detalle,'Venta Varios')|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN (B.PRECIO/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR((B.PRECIO/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO/1.18),'9999999D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN (B.PRECIO_ME/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR((B.PRECIO_ME/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO_ME/1.18),'9999999D99999')),',','.') END))||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_INICIAL_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
	            '|'||b.ID_TIPOIGV|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||''|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.BASE,0)+NVL(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END))||    
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE (case when B.BASE<1 then 0  end)||REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END))|| 
	    		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN nvl(B.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.DESCUENTO,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(B.DESCUENTO_ME,0) = 0 THEN '0.00' WHEN nvl(B.DESCUENTO_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.DESCUENTO_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.DESCUENTO_ME,0),'9999999999D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END))||			
	            '|'||''|| 
	            '|'||''||
	            '|' DET 			
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA    
	        AND A.ID_VENTA = P_ID_VENTA  
	        AND A.ESTADO = 1;
	          
	        
		ELSIF S_TIPODOC = '01' THEN  -- FACTURA
	        
	        open VENTA FOR  
		  	SELECT distinct'CF'||'|'||'0101'||
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		        '|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO||
		        '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		        '|'||S_ID_RUC||'|6'||
		        '|'||NVL(FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
		        '|'||FC_NOMBRE_PERSONA(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		        '|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(nvl(a.id_sucursal,A.ID_CLIENTE_LEGAL),A.ID_CLIENTE))),'Sin Direccion'),'-','')||
		        '|'||''|| 
		        '|'||trim(coalesce(FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'|| 
				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||'1000'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
		        FROM VENTA A
		        WHERE A.ID_VENTA = P_ID_VENTA 
		        AND A.ESTADO = 1 		
		        UNION ALL 
		         SELECT  'DF'||	'|'||ROWNUM||
		                        '|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
		                        '|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||     
		                   --     '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
		                    --    '|86121503'|| 
		                        '|'||'NIU'|| 
		                         '|'||(case when length(trim(to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(to_char(b.cantidad,'9999999999.99'))else trim(to_char(b.cantidad,'9999999999.99')) END)|| 
		                        '|'||nvl(b.detalle,'Venta')|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN (B.PRECIO/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR((B.PRECIO/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO/1.18),'9999999D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN (B.PRECIO_ME/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR((B.PRECIO_ME/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO_ME/1.18),'9999999D99999')),',','.') END))||
	            				--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_INICIAL_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||b.ID_TIPOIGV|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||''|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.BASE,0)+NVL(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END))||    
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END))|| 
		            			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.base,0) = 0 THEN '0.00' WHEN B.base BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.base,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.base,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
		                        '|'||''|| 
		                        '|'||''||
		                        '|' DET 			
		                FROM VENTA A, VENTA_DETALLE B  
		                WHERE A.ID_VENTA = B.ID_VENTA    
		                AND A.ID_VENTA = P_ID_VENTA  
		                AND A.ESTADO = 1
		                UNION ALL
		                SELECT 
		                      'FDP'||'|'||'Credito'||
		                      '|'||DECODE(ID_MONEDA, '7',(CASE  WHEN NVL(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END))||
		                      '|'CAB 
		                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
		                UNION ALL
		                SELECT 
		                      'CUO'||'|'||DECODE(B.NRO_CUOTA,'CUO001','Cuota001','Cuota002')||
		                      '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END))||                  
		                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
		                      '|' DET
		                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
		                AND A.ID_CREDITO = 2;
		        
		  
	    END IF;
	ELSE -- INAFECTO O EXONERADO
		IF S_TIPODOC='03' THEN -- BOLETA
	           --VENTAS SERVICIOS
	        open VENTA FOR  
	        SELECT distinct'CB'||'|'||'0101'||
	            '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
	            '|'||'03'|| 
	            '|'||A.SERIE||'-'||A.NUMERO||
	            '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
	            '|'||S_ID_RUC|| 
	            '|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0)||
	            '|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000')||
	            '|'||NVL(TRIM(FC_NOMBRE_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')||
	            '|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','')||
	            '|'||''|| 
	            '|'||trim(FC_EMAIL(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL)))|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END))|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.INAFECTA_ME,0) = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END))||
	            '|'||'0.00'|| 
	            '|'||decode(b.id_tipoigv,'40',DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END)),'0.00')||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END))|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
	            '|'||'1000'|| 
	            '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''||    
	            '|' CAB 
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA   
	        AND A.ID_VENTA = P_ID_VENTA 
	        AND A.ESTADO = 1 		
	        UNION ALL 
	        SELECT  'DB'||	'|'||ROWNUM||
	                '|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
	                '|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||   
	            '|'||'NIU'|| 
	            '|'||(case when length(trim(to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(to_char(b.cantidad,'9999999999.99'))else trim(to_char(b.cantidad,'9999999999.99')) END)|| 
	            '|'||nvl(b.detalle,'Venta Varios')|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999D99999')),',','.') END))||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_INICIAL_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
	            '|'||b.ID_TIPOIGV|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||''|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.BASE,0)+NVL(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END))||    
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE (case when B.BASE<1 then 0  end)||REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END))|| 
	    		'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN nvl(B.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.DESCUENTO,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(B.DESCUENTO_ME,0) = 0 THEN '0.00' WHEN nvl(B.DESCUENTO_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.DESCUENTO_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.DESCUENTO_ME,0),'9999999999D99')),',','.') END))||
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END))||			
	            '|'||''|| 
	            '|'||''||
	            '|' DET 			
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA    
	        AND A.ID_VENTA = P_ID_VENTA  
	        AND A.ESTADO = 1;
	          
	        
		ELSIF S_TIPODOC = '01' THEN  -- FACTURA
	        
	        open VENTA FOR  
		  	SELECT distinct'CF'||'|'||'0101'||
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		        '|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO||
		        '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		        '|'||S_ID_RUC||'|6'||
		        '|'||NVL(FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
		        '|'||FC_NOMBRE_PERSONA(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		        '|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(nvl(a.id_sucursal,A.ID_CLIENTE_LEGAL),A.ID_CLIENTE))),'Sin Direccion'),'-','')||
		        '|'||''|| 
		        '|'||trim(coalesce(FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'|| 
				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||'1000'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
		        FROM VENTA A
		        WHERE A.ID_VENTA = P_ID_VENTA 
		        AND A.ESTADO = 1 		
		        UNION ALL 
		         SELECT  'DF'||	'|'||ROWNUM||
		                        '|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
		                        '|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||     
		                   --     '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
		                    --    '|86121503'|| 
		                        '|'||'NIU'|| 
		                         '|'||(case when length(trim(to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(to_char(b.cantidad,'9999999999.99'))else trim(to_char(b.cantidad,'9999999999.99')) END)|| 
		                        '|'||nvl(b.detalle,'Venta')|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_ME,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999D99999')),',','.') END))||
	            				--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||b.ID_TIPOIGV|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||''|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.BASE,0)+NVL(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END))||    
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END))|| 
		            			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.base,0) = 0 THEN '0.00' WHEN B.base BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.base,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.base,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
		                        '|'||''|| 
		                        '|'||''||
		                        '|' DET 			
		                FROM VENTA A, VENTA_DETALLE B  
		                WHERE A.ID_VENTA = B.ID_VENTA    
		                AND A.ID_VENTA = P_ID_VENTA  
		                AND A.ESTADO = 1
		                UNION ALL
		                SELECT 
		                      'FDP'||'|'||'Credito'||
		                      '|'||DECODE(ID_MONEDA, '7',(CASE  WHEN NVL(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END))||
		                      '|'CAB 
		                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
		                UNION ALL
		                SELECT 
		                      'CUO'||'|'||DECODE(B.NRO_CUOTA,'CUO001','Cuota001','Cuota002')||
		                      '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END))||                  
		                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
		                      '|' DET
		                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
		                AND A.ID_CREDITO = 2;
		        
		  
	    END IF;
	
	END IF;
        
        fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                /*IF LENGTH(S_DETALLE||chr(13)||S_VENTA) <= 4000 THEN
                    S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                ELSE
                    S_DETALLE :='';
                END IF;*/
                
                BEGIN 
                    IF S_ERROR = 'N' THEN
                        S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                    END IF;
                EXCEPTION
                WHEN OTHERS THEN
                    S_DETALLE :='';
                    S_ERROR := 'S';
                END;
                
            END IF;
        
            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	
        
        RETURN(TO_CLOB(S_DETALLE));
    END;
   
   
   
   
   
   PROCEDURE SP_ANULAR_VENTAS_REG(P_ID_VENTA NUMBER, P_ID_PERSONA NUMBER, P_MOTIVO VARCHAR2, P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2) IS
        L_ID_VOUCHER NUMBER;
        L_ACTIVO VARCHAR2(1);
        L_ID_KARDEX NUMBER;
        L_ID_ALMACEN NUMBER;
        L_ID_ARTICULO NUMBER;
        L_ID_ANHO NUMBER;
        L_ID_TIPOORIGEN NUMBER := 1;
        L_ID_ASIENTO NUMBER;
        L_DATA VARCHAR2(255);

        L_ID_DEPOSITO NUMBER;
        L_ID_VOUCHER_DEP NUMBER;
        L_ID_TIPOORIGEN_DEP NUMBER;
        L_CANT NUMBER;

        CURSOR articulos IS	
        SELECT 
                ID_KARDEX,A.ID_ALMACEN,A.ID_ARTICULO,A.ID_ANHO 
        FROM INVENTARIO_KARDEX A JOIN VENTA_DETALLE B
        ON A.ID_ORIGEN = B.ID_VDETALLE 
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND B.ID_VENTA = P_ID_VENTA;

        CURSOR asientos IS
        SELECT 
                ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN VENTA_DETALLE B
        ON A.ID_ORIGEN = B.ID_VDETALLE
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND B.ID_VENTA = P_ID_VENTA
        AND A.VOUCHER = L_ID_VOUCHER;

        CURSOR asientos_dep is
        SELECT 
                A.ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN CAJA_DEPOSITO B
        ON A.ID_ORIGEN = B.ID_DEPOSITO
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN_DEP
        AND A.ID_ORIGEN = L_ID_DEPOSITO
        AND A.VOUCHER = L_ID_VOUCHER_DEP;

        BEGIN
            SELECT ID_VOUCHER, 'SERIE: '||SERIE||', NUMERO: '||NUMERO||'GRAVADA: '||GRAVADA||', INAFECTA: '||INAFECTA||', EXONERADA: '||EXONERADA||', DESCUENTO: '||DESCUENTO||', IGV: '||IGV||', TOTAL: '||TOTAL 
            INTO L_ID_VOUCHER, L_DATA
            FROM VENTA WHERE ID_VENTA = P_ID_VENTA;
            
            SELECT ACTIVO INTO L_ACTIVO FROM CONTA_VOUCHER  WHERE ID_VOUCHER = L_ID_VOUCHER;
            IF L_ACTIVO <> 'S' THEN 
            	P_ERROR := 1;
                P_MSGERROR := 'El Voucher ya esta CONTABILIZADO';
                GOTO salida_rapida;
            END IF;
           
                Insert into ARREGLO (
                ID_ENTIDAD, ID_DEPTO, ID_TIPOARREGLO, ID_PERSONA, ID_MODULO, ID_ORIGEN, ID_TIPOORIGEN, 
                MOTIVO, FECHA, INFO_BACKUP, ESTADO
                ) 
                select ID_ENTIDAD, id_depto, 1 as id_tipoarreglo, P_ID_PERSONA, 13, id_venta, id_tipoorigen, P_MOTIVO, sysdate, 
                'IMPORTE: '||total||' Glosa: '||glosa, 1
                from VENTA 
                where id_venta = P_ID_VENTA;
        
            --ANULA KARDEX
            OPEN articulos;
              FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO;
                WHILE articulos%FOUND LOOP

                    UPDATE INVENTARIO_KARDEX SET CANTIDAD = 0, COSTO_UNITARIO = 0, COSTO_TOTAL = 0
                    WHERE ID_KARDEX = L_ID_KARDEX;

                    UPDATE INVENTARIO_ALMACEN_ARTICULO SET ESTADO = '1'
                    WHERE ID_ALMACEN = L_ID_ALMACEN
                    AND ID_ARTICULO = L_ID_ARTICULO
                    AND ID_ANHO = L_ID_ANHO;

                    FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO;
                END LOOP;
            CLOSE articulos;
           
            --ANULA ASIENTO DE LA VENTA
            OPEN asientos;
              FETCH asientos INTO L_ID_ASIENTO;
                WHILE asientos%FOUND LOOP

                    UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                    WHERE ID_ASIENTO = L_ID_ASIENTO;

                    FETCH asientos INTO L_ID_ASIENTO;
                END LOOP;
            CLOSE asientos;
            --ANULAR DEPOSITO
            /*
            SELECT COUNT(1) INTO L_CANT FROM CAJA_DEPOSITO_DETALLE
            WHERE ID_VENTA = P_ID_VENTA;

            IF L_CANT > 0 THEN

                SELECT ID_DEPOSITO INTO L_ID_DEPOSITO FROM CAJA_DEPOSITO_DETALLE
                WHERE ID_VENTA = P_ID_VENTA;
                SELECT ID_VOUCHER,ID_TIPOORIGEN INTO L_ID_VOUCHER_DEP,L_ID_TIPOORIGEN_DEP
                FROM CAJA_DEPOSITO
                WHERE ID_DEPOSITO = L_ID_DEPOSITO;

                OPEN asientos_dep;
                  FETCH asientos_dep INTO L_ID_ASIENTO;
                    WHILE asientos_dep%FOUND LOOP

                        UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                        WHERE ID_ASIENTO = L_ID_ASIENTO;

                        FETCH asientos_dep INTO L_ID_ASIENTO;
                    END LOOP;
                CLOSE asientos_dep;

                UPDATE CAJA_DEPOSITO_DETALLE SET IMPORTE = 0, IMPORTE_ME = 0
                WHERE ID_DEPOSITO = L_ID_DEPOSITO;

                UPDATE CAJA_DEPOSITO SET IMPORTE = 0, IMPORTE_ME = 0, GLOSA = '<< Anulado >>'
                WHERE ID_DEPOSITO = L_ID_DEPOSITO;
            END IF;
            */
            --ANULAR VENTA
            UPDATE VENTA_DETALLE SET    DETALLE = '<< Anulado>>',CANTIDAD = 0,PRECIO = 0,PRECIO_BASE = 0,PRECIO_ALM = 0,BASE = 0,IGV = 0,DESCUENTO = 0,IMPORTE = 0,IMPORTE_ADESCONTAR = 0,OTROS_CARGOS = 0,
                                        PRECIO_ME = 0,PRECIO_BASE_ME = 0,PRECIO_ALM_ME = 0,BASE_ME = 0,IGV_ME = 0,DESCUENTO_ME = 0,IMPORTE_ME = 0,OTROS_CARGOS_ME = 0
            WHERE ID_VENTA = P_ID_VENTA;

            UPDATE VENTA SET    GLOSA = '<< Anulado>>', GRAVADA = 0,INAFECTA = 0,EXONERADA = 0,GRATUITA = 0,DESCUENTO = 0,IGV = 0,TOTAL = 0,DESCUENTO_GLOBAL = 0,IMPORTE_ADESCONTAR = 0,OTROS_CARGOS = 0,
                                GRAVADA_ME = 0,INAFECTA_ME = 0,EXONERADA_ME = 0,GRATUITA_ME = 0,DESCUENTO_ME = 0,IGV_ME = 0,TOTAL_ME = 0,DESCUENTO_GLOBAL_ME = 0,IMPORTE_ADESCONTAR_ME = 0,OTROS_CARGOS_ME = 0
            WHERE ID_VENTA = P_ID_VENTA;

            UPDATE ARREGLO SET ESTADO = '2',INFO_BACKUP = L_DATA
            WHERE ID_ORIGEN = P_ID_VENTA
            AND ID_TIPOORIGEN = L_ID_TIPOORIGEN
            AND ESTADO = '1';
            P_ERROR := 0;
            P_MSGERROR := 'OK: Anulado con Exito';
           
           <<salida_rapida>>
           P_ERROR := P_ERROR; --AREGLO 
            
    END SP_ANULAR_VENTAS_REG;

END PKG_SALES_INDUSTRY_TEST;