-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE PKG_PROF AS 

  /* TODO enter package declarations (types, exceptions, methods etc) here */ 
    PROCEDURE SP_GENERAR_DETALLE_PROFORMA(P_ID_PROFORMA IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_INGRESOS_ALUM_PROFORMA(P_ID_PROFORMA IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_DESCTOS_ALUM_PROFORMA(P_ID_PROFORMA IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_ENSE_REGULAR_FIJO(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_DESC_SOLICITUD_BECA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_DESC_ESPECIAL(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_DESC_HIJO_MISIONERO(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_RESI_RESIDENCIA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_RESI_ALIMENTACION(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_RESI_LAVANDERIA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_DESC_PRONTO_PAGO_JUL(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_LISTAR_DETALLE_PROFORMA(P_ID_PROFORMA NUMBER,P_DC VARCHAR2,CURSOR OUT SYS_REFCURSOR );
    PROCEDURE SP_DESC_HIJO_PERSONAL(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_DESC_PROMOTORA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
    PROCEDURE SP_ENSE_REGULAR(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
END PKG_PROF;


CREATE OR REPLACE PACKAGE BODY        PKG_PROF AS
    PROCEDURE SP_GENERAR_DETALLE_PROFORMA(P_ID_PROFORMA IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2) 
  IS
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_contar number;
    l_id_semestre_programa number;
    l_id_criterio_ing NUMBER;
    l_total number(15,2);
       
    CURSOR curdetING IS
    SELECT
      A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      coalesce(sum(B.TOTAL),0) as TOTAL,
      A.DC,
      B.ID_SEMESTRE_PROGRAMA,
      A.TIENE_HIJO,
      B.TIPO_VALOR,
      B.DESCRIPCION,
      B.APLAZADO
    FROM VW_MAT_CRITERIO_SEMESTRE A,PRO_CONCEPTO_ASIGN_ALUM B
    WHERE A.ID_CRITERIO_SEMESTRE=B.ID_CRITERIO_SEMESTRE
    AND B.ID_PROFORMA = P_ID_PROFORMA
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND A.DC='D'
    GROUP BY A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      A.DC,
      B.ID_SEMESTRE_PROGRAMA,
      A.TIENE_HIJO,
      A.ORDEN,
      B.TIPO_VALOR,
      B.DESCRIPCION,
      B.APLAZADO
    ORDER BY A.DC DESC,A.ORDEN;
    
    
    
    CURSOR curdetDES IS
    SELECT
      A.ID_CRITERIO_SEMESTRE,
      coalesce(B.TOTAL,0) as TOTAL,
      A.DC,
      B.TIPO_VALOR,
      A.TIENE_HIJO,
      B.DESCRIPCION,
      B.ID_SEMESTRE_PROGRAMA,
      B.CREDITOS,
      B.unitario_cred
    FROM VW_MAT_CRITERIO_SEMESTRE A,PRO_CONCEPTO_ASIGN_ALUM B
    WHERE A.ID_CRITERIO_SEMESTRE=B.ID_CRITERIO_SEMESTRE
    AND B.ID_PROFORMA = P_ID_PROFORMA
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND A.DC='C'
    AND COALESCE(A.ID_AFECTA,0)=l_id_criterio_ing
    ORDER BY A.DC DESC,A.ORDEN;
    
    l_total_des number(10,2);

    
    l_acumula  number(10,2);
    l_importe  number(10,2);
    l_i number:=0;
    l_id_parent number;
    
    l_k number:=0;
    l_numhijo number;
   
    
    l_total_debito number(15,2);
    l_total_credito number(15,2);
    l_matricula number(15,2);
    l_mensual number(15,2);
    l_mensual_resi number(15,2);
    l_contado number(15,2);
    l_matricula1cuota number(15,2);
    l_pago number(15,2);
    l_saldo number(15,2);
    l_cuotas number(10,2);
    l_id_persona number;
    l_id_postulante number;
    
    total_dc number(10,2);
    imp_dc number(10,2);
    l_prd number(10,2);
    l_contarcrit number:=0;

    l_conmat1cuota varchar2(1);

    unitario_cred number(10,2):=0;
    l_total_r  number(10,2):=0;
    l_total_debito_r  number(10,2):=0;
    l_total_credito_r  number(10,2):=0;

  BEGIN
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
  --eliminar 
    DELETE FROM PRO_CONCEPTO_ASIGN_ALUM WHERE ID_PROFORMA=P_ID_PROFORMA;
    DELETE FROM PRO_PROFORMA_DET WHERE ID_PROFORMA=P_ID_PROFORMA;
    
 
    UPDATE ELISEO.PRO_PROFORMA  SET 
      TOTAL=0,
      TOTAL_DEBITO=0,
      TOTAL_CREDITO=0,
      MATRICULA=0,
      MENSUAL=0,
      CONTADO=0,
      MATRICULA1CUOTA=0,
      PAGO=0,
      DIAS_RESIDENCIA=0,
      MENSUAL_ENS_RESI=0
    WHERE ID_PROFORMA = P_ID_PROFORMA;
    
    
    
    --PROCESA INGRESOS
    PKG_PROF.SP_INGRESOS_ALUM_PROFORMA(P_ID_PROFORMA,l_error,l_msgerror);
    
   
    IF l_error<>0 THEN
        GOTO salida_prof;
    END IF;
    
    --procesa_descuento
    SELECT COUNT(*) INTO l_contar FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND COALESCE(PROFORMA,0)=1
    AND DC='C';
    
    IF l_contar>0 THEN
      PKG_PROF.SP_DESCTOS_ALUM_PROFORMA(P_ID_PROFORMA,l_error,l_msgerror);
      
      IF l_error<>0 THEN
        GOTO salida_prof;
      END IF;
    
    END IF;
    
    --ELIMINA LOS QUE TIENE IMPORTE CERO QUE NO SEN PADRES
    DELETE FROM PRO_CONCEPTO_ASIGN_ALUM 
    WHERE ID_PROFORMA=P_ID_PROFORMA
    AND TOTAL=0
    AND ID_CRITERIO_SEMESTRE IN(
      SELECT ID_CRITERIO_SEMESTRE
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
      AND TIENE_HIJO=0
    );
    
    FOR cur in curdetING LOOP
        BEGIN
          l_acumula:=cur.total;
          l_id_criterio_ing:=cur.id_criterio;
          
          SELECT COALESCE(MAX(CONTADOR),0)+1  INTO l_i FROM PRO_PROFORMA_DET
          WHERE ID_PROFORMA = P_ID_PROFORMA;
          
          l_id_parent := l_i;
          
          INSERT INTO PRO_PROFORMA_DET(
            ID_PROFORMA,
            CONTADOR,
            ID_CRITERIO_SEMESTRE,
            IMPORTE,
            DC,
            ACUMULA,
            ID_PARENT,
            DESCRIPCION,
            IMP_CAL,
            TIPO_VALOR           
         ) VALUES (
            P_ID_PROFORMA,
            l_i,
            cur.id_criterio_semestre,
            cur.total,
            cur.dc,
            NULL,
            NULL,
            cur.descripcion,
            NULL,
            cur.tipo_valor
         );
         
         --DESCUENTO ASOCIADO
        if l_k=0 then
          SELECT COALESCE(MAX(CONTADOR),0)+1  INTO l_i FROM PRO_PROFORMA_DET
          WHERE ID_PROFORMA = P_ID_PROFORMA;
          
           INSERT INTO PRO_PROFORMA_DET(
            ID_PROFORMA,
            CONTADOR,
            ID_CRITERIO_SEMESTRE,
            IMPORTE,
            DC,
            ACUMULA,
            ID_PARENT,
            DESCRIPCION,
            IMP_CAL,
            TIPO_VALOR           
          )
       
          SELECT
            P_ID_PROFORMA,
            (row_number() OVER( ORDER BY A.ID_CRITERIO_SEMESTRE ASC )) + l_i AS items, 
            A.ID_CRITERIO_SEMESTRE,
            0,
            A.DC,
            0,
            null,
            A.NOMBRE,
            0,
            A.TIPO_VALOR
          FROM VW_MAT_CRITERIO_SEMESTRE A
          WHERE A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
          AND A.DC='C'
          --AND A.ID_AFECTA is null
          and A.TIENE_HIJO>0
          AND A.ID_CRITERIO IN(
            SELECT COALESCE(ID_PARENT,0) FROM MAT_CRITERIO
            WHERE COALESCE(PROFORMA,0)=1 --AND COALESCE(PROFORMA_MANUAL,0)=1
          )
          ORDER BY A.DC DESC,A.ORDEN; 
        end if;
        
        FOR curd in curdetDES LOOP
          BEGIN
            l_total_des:=curd.TOTAL;
            SELECT COALESCE(MAX(CONTADOR),0)+1  INTO l_i FROM PRO_PROFORMA_DET
            WHERE ID_PROFORMA = P_ID_PROFORMA;
            
            if curd.TIPO_VALOR='I' then
              select coalesce(sum(TOTAL),0) into total_dc from PRO_CONCEPTO_ASIGN_ALUM 
              where ID_PROFORMA=P_ID_PROFORMA 
              and ID_CRITERIO_SEMESTRE=cur.id_criterio_semestre;
              
              select importe into imp_dc from PRO_PROFORMA_DET 
              where ID_PROFORMA=P_ID_PROFORMA 
              and ID_CRITERIO_SEMESTRE=cur.id_criterio_semestre
              and CONTADOR=l_id_parent;
              
              l_prd:=0;
              
              if total_dc>0 then
                l_prd:=imp_dc/total_dc;
              end if;
              l_total_des := l_prd*l_total_des;
              
             
            end if;
            

            if curd.TIPO_VALOR = 'P' THEN
              l_importe:=(l_total_des/100)*l_acumula;
            else
              l_importe:=l_total_des;
            END IF;
            
            l_acumula := l_acumula - l_importe;
            
      
            if (cur.total>0 and l_importe>0 ) or (cur.total<0 and l_importe<0 ) then
            
            
              INSERT INTO PRO_PROFORMA_DET(
                  ID_PROFORMA,
                  ID_CRITERIO_SEMESTRE,
                  CONTADOR,
                  IMPORTE,
                  DC,
                  ACUMULA,
                  ID_PARENT,
                  DESCRIPCION,
                  IMP_CAL,
                  TIPO_VALOR,
                  CREDITOS,
                  UNITARIO
                 ) VALUES (
                  P_ID_PROFORMA,
                  curd.ID_CRITERIO_SEMESTRE,
                  l_i,
                  l_importe,
                  curd.DC,
                  l_acumula,
                  l_id_parent,
                  curd.descripcion,
                  l_total_des,
                  curd.TIPO_VALOR,
                  curd.CREDITOS,
                  curd.unitario_cred
                 );
            end if;
           END;
        END LOOP;
        l_k:=l_k+1;
        l_contarcrit:=l_contarcrit +1;
      end;
    END LOOP;

    IF l_contarcrit=0 THEN
        l_error:=1;
        l_msgerror:='No está asignado criterios de matricula';
        GOTO salida_prof;
    END IF;
    
    ---solo descuento
    SELECT
    COUNT(*) INTO l_numhijo  
    FROM VW_MAT_CRITERIO_SEMESTRE A, PRO_PROFORMA_DET D
    WHERE A.ID_CRITERIO_SEMESTRE=D.ID_CRITERIO_SEMESTRE
    AND A.DC='C'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND D.ID_PROFORMA=P_ID_PROFORMA
    AND A.ID_PARENT IS NOT NULL;
      
    IF l_numhijo>0 THEN
       MERGE INTO PRO_PROFORMA_DET S 
       USING(
          SELECT
          D.ID_PROFORMA,A.ID_SEMESTRE_PROGRAMA,A.ID_CRITERIO_SEMESTRE,D.CONTADOR,E.TOTAL  
          FROM VW_MAT_CRITERIO_SEMESTRE A, PRO_PROFORMA_DET D,(
            SELECT
            X.ID_PARENT, COALESCE(SUM(Z.IMPORTE),0) as total
            FROM VW_MAT_CRITERIO_SEMESTRE X, PRO_PROFORMA_DET Z
            WHERE X.ID_CRITERIO_SEMESTRE=Z.ID_CRITERIO_SEMESTRE
            AND X.DC='C'
            AND X.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
            AND Z.ID_PROFORMA=P_ID_PROFORMA
            AND X.ID_PARENT IS NOT NULL
            group by X.ID_PARENT
          )E
          WHERE A.ID_CRITERIO_SEMESTRE=D.ID_CRITERIO_SEMESTRE
          AND E.ID_PARENT=A.ID_CRITERIO
          AND A.DC='C'
          AND A.ESTADO='1'
          AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
          AND D.ID_PROFORMA=P_ID_PROFORMA
          AND A.ID_PARENT IS NULL
      )T ON (T.ID_PROFORMA=S.ID_PROFORMA AND  T.ID_CRITERIO_SEMESTRE= S.ID_CRITERIO_SEMESTRE AND T.CONTADOR=S.CONTADOR)
       WHEN  MATCHED THEN UPDATE SET  
       S.IMPORTE = T.TOTAL;
         
    END IF;
    
    --CALCULO DE TOTALES
    
    SELECT count(*)
    INTO l_contar
    FROM ELISEO.PRO_PROFORMA A, MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
    WHERE A.ID_PLANPAGO_SEMESTRE=B.ID_PLANPAGO_SEMESTRE
    AND B.ID_PLANPAGO=C.ID_PLANPAGO
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    
    IF l_contar=0 THEN
        l_error:=1;
        l_msgerror:='No tiene asignado plan de pagos';
        GOTO salida_prof;
    END IF;
    
    SELECT C.CUOTAS,coalesce(c.CONMAT1CUOTA,'S')
    INTO l_cuotas,l_conmat1cuota
    FROM ELISEO.PRO_PROFORMA A, MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
    WHERE A.ID_PLANPAGO_SEMESTRE=B.ID_PLANPAGO_SEMESTRE
    AND B.ID_PLANPAGO=C.ID_PLANPAGO
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    

    SELECT 
    COALESCE(SUM((CASE WHEN A.DC='C' THEN -1 ELSE 1 END)*A.IMPORTE),0) AS TOTAL,
    COALESCE(SUM((CASE WHEN A.DC='C' THEN 0 ELSE 1 END)*A.IMPORTE),0) AS TOTAL_DEBITO,
    COALESCE(SUM((CASE WHEN A.DC='C' THEN 1 ELSE 0 END)*A.IMPORTE),0) AS TOTAL_CREDITO,
    COALESCE(SUM((CASE WHEN A.DC='C' THEN -1 ELSE 1 END)*(CASE WHEN B.TIPO='M' or (B.tipo_cobro='U' and B.TIPO='R') THEN A.IMPORTE ELSE 0 END)),0) AS MATRICULA,
    COALESCE(SUM((CASE WHEN A.DC='C' THEN -1 ELSE 1 END)*(CASE WHEN (B.TIPO='E' or (B.tipo_cobro='M' and B.TIPO='R')) THEN  A.IMPORTE  ELSE 0 END)),0)/l_cuotas AS MENSUAL
    INTO
    l_total,
    l_total_debito,
    l_total_credito,
    l_matricula,
    l_mensual
    FROM PRO_PROFORMA_DET A, VW_MAT_CRITERIO_SEMESTRE B
    WHERE A.ID_CRITERIO_SEMESTRE=B.ID_CRITERIO_SEMESTRE
    AND A.ID_PROFORMA = P_ID_PROFORMA
    AND B.TIENE_HIJO=0
    AND B.RESI_MEN=0;
    
    
    SELECT 
    COALESCE(SUM((CASE WHEN A.DC='C' THEN -1 ELSE 1 END)*A.IMPORTE),0) AS TOTAL,
    COALESCE(SUM((CASE WHEN A.DC='C' THEN 0 ELSE 1 END)*A.IMPORTE),0) AS TOTAL_DEBITO,
    COALESCE(SUM((CASE WHEN A.DC='C' THEN 1 ELSE 0 END)*A.IMPORTE),0) AS TOTAL_CREDITO,
    COALESCE(SUM((CASE WHEN A.DC='C' THEN -1 ELSE 1 END)*(CASE WHEN (B.TIPO='E' or (B.tipo_cobro='M' and B.TIPO='R')) THEN  A.IMPORTE  ELSE 0 END)),0)/CASE WHEN (l_cuotas-1)=0 THEN 1 ELSE (l_cuotas-1) END AS MENSUAL
    into
    l_total_r,
    l_total_debito_r,
    l_total_credito_r,
    l_mensual_resi
    FROM PRO_PROFORMA_DET A, VW_MAT_CRITERIO_SEMESTRE B
    WHERE A.ID_CRITERIO_SEMESTRE=B.ID_CRITERIO_SEMESTRE
    AND A.ID_PROFORMA = P_ID_PROFORMA
    AND B.TIENE_HIJO=0
    AND B.RESI_MEN=1;
 
    
    
    l_saldo:= 0;

    
    l_contado:= 0;
    if l_cuotas=1 then
      l_contado:= l_total + l_total_r;
      l_pago:= l_contado + l_saldo;
    end if;
    
    l_matricula1cuota:=0;
    
    if l_cuotas<>1 then
      if l_conmat1cuota='S' then
        l_matricula1cuota:=l_matricula + l_mensual;
      else
        l_matricula1cuota:=l_matricula;
      end if;
      l_pago:= l_matricula1cuota + l_saldo;
    else
      l_mensual:=0;
      l_mensual_resi:=0;
    end if;
    
    if l_pago<0 then
      l_pago:=0;
    end if;
    
  
    
    UPDATE ELISEO.PRO_PROFORMA SET
      TOTAL=l_total + l_total_r,
      TOTAL_DEBITO=l_total_debito+l_total_debito_r,
      TOTAL_CREDITO=l_total_credito+l_total_credito_r,
      MATRICULA=l_matricula,
      MENSUAL=l_mensual,
      CONTADO=l_contado,
      MATRICULA1CUOTA=l_matricula1cuota,
      PAGO=l_pago,
      MENSUAL_ENS_RESI = l_mensual + l_mensual_resi
    WHERE ID_PROFORMA = P_ID_PROFORMA;
    
    delete from PRO_PROFORMA_DET  WHERE ID_PROFORMA = P_ID_PROFORMA  and coalesce(importe,0)=0;
    
  
    <<salida_prof>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
    
  END SP_GENERAR_DETALLE_PROFORMA;
  
  PROCEDURE SP_INGRESOS_ALUM_PROFORMA(P_ID_PROFORMA IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  IS
   
    l_id_semestre_programa number;
    


    l_importe	number(10,2);

   
    l_codigo varchar2(15 byte);

    l_items number:=0;

 

    l_numhijo	number;
    l_tipo_alumno varchar2(5);

    l_id_modo_contrato number;
    l_formula varchar2(500);
       
    CURSOR curING IS
    SELECT
      ID_CRITERIO_SEMESTRE,
      ID_CRITERIO,
      IMPORTE,
      FORMULA,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE,
      ORDEN,
      coalesce(ID_PROCEDURE_PRO,0) as ID_PROCEDURE_PRO
    FROM VW_MAT_CRITERIO_SEMESTRE 
    WHERE DC='D'
    AND ESTADO='1'
    AND ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND TIPO_ALUMNO=l_tipo_alumno
    AND TIENE_HIJO=0
    AND id_modo_contrato=l_id_modo_contrato
    AND COALESCE(PROFORMA,0)=1 --FIJO
    UNION
    SELECT
      A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      A.IMPORTE,
      A.FORMULA,
      A.TIPO_PROCESO,
      A.TIPO_VALOR,
      C.DC,
      C.NOMBRE,
      C.ORDEN,
      coalesce(a.ID_PROCEDURE_PRO,0) as ID_PROCEDURE_PRO
    FROM MAT_CRITERIO_SEMESTRE A, MAT_CRITERIO C
    WHERE A.ID_CRITERIO=C.ID_CRITERIO
    AND C.DC='D'
    AND A.ESTADO='1'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND c.id_modo_contrato=l_id_modo_contrato
    AND C.ID_CRITERIO in(
      SELECT
        COALESCE(d.ID_PARENT,0)
      FROM MAT_CRITERIO_SEMESTRE b, MAT_CRITERIO d
      WHERE b.ID_CRITERIO=d.ID_CRITERIO
      AND d.DC='D'
      AND b.ESTADO='1'
      AND b.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
      AND d.TIPO_ALUMNO=l_tipo_alumno
      AND d.id_modo_contrato=l_id_modo_contrato
      and d.ID_PARENT is not null
      AND COALESCE(D.PROFORMA,0)=1 --FIJO
      group by d.ID_PARENT
    )
    ORDER BY DC DESC,ORDEN;
    
 
    l_total NUMBER(10,2); 
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_persona number;
    l_cod_nivel varchar2(5);
    l_id_modalidad_estudio number;
    l_id_postulante number;

  BEGIN
  
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
   
    --select codigo into l_codigo from  david.TIPO_CONTRATO 
    --where ID_TIPO_CONTRATO=l_id_tipo_contrato;
    
    select c.codigo,b.id_modalidad_estudio into l_cod_nivel,l_id_modalidad_estudio
    from  david.acad_semestre_programa a,david.acad_programa_estudio b,david.TIPO_NIVEL_ENSENANZA c
    where a.id_programa_estudio=b.id_programa_estudio
    and b.id_nivel_ensenanza=c.id_nivel_ensenanza
    and a.id_semestre_programa=l_id_semestre_programa;
    
    
     
    l_id_modo_contrato:=1;
        
    l_tipo_alumno:='RE';
    l_codigo:='R';
    
    FOR cur in curING LOOP
      BEGIN
        l_total:= 0;
        CASE
          WHEN cur.TIPO_PROCESO = 'PF' OR cur.TIPO_PROCESO = 'P'  THEN
             l_formula:= CUR.formula;
             if cur.ID_PROCEDURE_PRO>0 then
              select nombre into l_formula from eliseo.mat_procedure where id_procedure=cur.ID_PROCEDURE_PRO;
             end if;
             EXECUTE IMMEDIATE 'BEGIN PKG_PROF.'||l_formula||'(:P_ID_PROFORMA,:P_ID_CRITERIO_SEMESTRE,:l_error,:l_msgerror); end;'
             USING P_ID_PROFORMA,CUR.id_criterio_semestre,IN OUT l_error,IN OUT l_msgerror;
          WHEN cur.TIPO_PROCESO = 'F' THEN
            l_total:= cur.importe;
            SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
            WHERE ID_PROFORMA=P_ID_PROFORMA;
             
            IF l_total>0 THEN
               insert into PRO_CONCEPTO_ASIGN_ALUM(
                  ID_PROFORMA,
                  ID_CRITERIO_SEMESTRE,
                  ITEM,
                  ID_SEMESTRE_PROGRAMA,
                  DESCRIPCION,
                  DC,
                  TOTAL,
                  TIPO_VALOR
                  )VALUES(
                  P_ID_PROFORMA,
                  CUR.id_criterio_semestre,
                  l_items,
                  l_id_semestre_programa,
                  CUR.nombre,
                  CUR.dc,
                  l_total,
                  CUR.tipo_valor
                  );
            END IF;
          ELSE
            SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
            WHERE ID_PROFORMA=P_ID_PROFORMA;
            
            insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES(
            P_ID_PROFORMA,
            CUR.id_criterio_semestre,
            l_items,
            l_id_semestre_programa,
            CUR.nombre,
            CUR.dc,
            0,
            CUR.tipo_valor
            );
        END CASE;
        
      end;
    END LOOP;
      
    
  --ASIGNACION DE VALORES A CRITERIO PADRE
  
    SELECT
    COUNT(*) INTO l_numhijo  
    FROM MAT_CRITERIO_SEMESTRE A, MAT_CRITERIO C, PRO_CONCEPTO_ASIGN_ALUM D
    WHERE A.ID_CRITERIO_SEMESTRE=D.ID_CRITERIO_SEMESTRE
    AND A.ID_CRITERIO=C.ID_CRITERIO
    AND C.DC='D'
    AND A.ESTADO='1'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND D.ID_PROFORMA=P_ID_PROFORMA
    AND C.id_modo_contrato=l_id_modo_contrato
    AND C.ID_PARENT IS NOT NULL;
      
    IF l_numhijo>0 THEN
       MERGE INTO PRO_CONCEPTO_ASIGN_ALUM S 
       USING(
          SELECT
          D.ID_PROFORMA,A.ID_SEMESTRE_PROGRAMA,A.ID_CRITERIO_SEMESTRE,D.ITEM,E.TOTAL  
          FROM MAT_CRITERIO_SEMESTRE A, MAT_CRITERIO C,PRO_CONCEPTO_ASIGN_ALUM D,(
            SELECT
            Y.ID_PARENT, COALESCE(SUM(Z.TOTAL),0) as total
            FROM MAT_CRITERIO_SEMESTRE X, MAT_CRITERIO Y, PRO_CONCEPTO_ASIGN_ALUM Z
            WHERE X.ID_CRITERIO_SEMESTRE=Z.ID_CRITERIO_SEMESTRE
            AND X.ID_CRITERIO=Y.ID_CRITERIO
            AND Y.DC='D'
            AND X.ESTADO='1'
            AND X.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
            AND Z.ID_PROFORMA=P_ID_PROFORMA
            AND Y.ID_PARENT IS NOT NULL
            group by Y.ID_PARENT
          )E
          WHERE A.ID_CRITERIO_SEMESTRE=D.ID_CRITERIO_SEMESTRE
          AND A.ID_CRITERIO=C.ID_CRITERIO
          AND E.ID_PARENT=A.ID_CRITERIO
          AND C.DC='D'
          AND A.ESTADO='1'
          AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
          AND D.ID_PROFORMA=P_ID_PROFORMA
          AND C.ID_PARENT IS NULL
      )T ON (T.ID_PROFORMA=S.ID_PROFORMA AND T.ID_SEMESTRE_PROGRAMA=S.ID_SEMESTRE_PROGRAMA AND T.ID_CRITERIO_SEMESTRE= S.ID_CRITERIO_SEMESTRE AND T.ITEM=S.ITEM)
       WHEN  MATCHED THEN UPDATE SET  
       S.TOTAL = T.TOTAL;
         
      END IF;
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_INGRESOS_ALUM_PROFORMA;
  
  PROCEDURE SP_DESCTOS_ALUM_PROFORMA(P_ID_PROFORMA IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
   is
    l_id_semestre_programa number;
    

    l_importe	number(10,2);
    l_formula	varchar2(4000 byte);
    l_tipo_proceso	varchar2(2 byte);
    
    l_codigo varchar2(15 byte);
    l_dc varchar2(2 byte) ;
    l_items number:=0;
    l_items_padre number:=0;
    l_nombre varchar2(150 byte) ;
    l_tipo_valor varchar2(2 byte) ;
    
    l_id_criterio	number;
    l_numhijo	number;
    l_tipo_alumno varchar2(5):='RE';
    
    CURSOR curDES IS
    SELECT
      A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      A.IMPORTE,
      A.FORMULA,
      A.TIPO_PROCESO,
      A.TIPO_VALOR,
      A.DC,
      A.NOMBRE,
      A.ORDEN,
      coalesce(a.ID_PROCEDURE_PRO,a.ID_PROCEDURE_PRO_CRI) as ID_PROCEDURE_PRO
    FROM VW_MAT_CRITERIO_SEMESTRE A
    WHERE  A.DC='C'
    AND A.ESTADO='1'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND A.TIPO_ALUMNO=l_tipo_alumno
    AND COALESCE(A.PROFORMA,0)=1
    AND COALESCE(A.PROFORMA_MANUAL,0)=0
    AND A.ID_AFECTA IN(
      SELECT
            X.ID_CRITERIO
            FROM VW_MAT_CRITERIO_SEMESTRE X, PRO_CONCEPTO_ASIGN_ALUM Z
            WHERE X.ID_CRITERIO_SEMESTRE=Z.ID_CRITERIO_SEMESTRE
            AND X.DC='D'
            AND X.ESTADO='1'
            AND X.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
            AND Z.ID_PROFORMA=P_ID_PROFORMA
            AND COALESCE(X.PROFORMA,0)=1
    )
    UNION
    SELECT
      A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      A.IMPORTE,
      A.FORMULA,
      A.TIPO_PROCESO,
      A.TIPO_VALOR,
      A.DC,
      A.NOMBRE,
      A.ORDEN,
      coalesce(a.ID_PROCEDURE_PRO,a.ID_PROCEDURE_PRO_CRI) as ID_PROCEDURE_PRO
    FROM VW_MAT_CRITERIO_SEMESTRE A
    WHERE  A.DC='C'
    AND A.ESTADO='1'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND A.TIPO_ALUMNO=l_tipo_alumno
    --AND COALESCE(A.PROFORMA,0)=1
    AND A.ID_CRITERIO_SEMESTRE IN(
      SELECT ID_CRITERIO_SEMESTRE FROM PRO_PROFORMA_CRITERIO
      WHERE ID_PROFORMA=P_ID_PROFORMA
    )
    AND A.ID_AFECTA IN(
      SELECT
            X.ID_CRITERIO
            FROM VW_MAT_CRITERIO_SEMESTRE X, PRO_CONCEPTO_ASIGN_ALUM Z
            WHERE X.ID_CRITERIO_SEMESTRE=Z.ID_CRITERIO_SEMESTRE
            AND X.DC='D'
            AND X.ESTADO='1'
            AND X.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
            AND Z.ID_PROFORMA=P_ID_PROFORMA
            AND COALESCE(X.PROFORMA,0)=1
    )
    ORDER BY DC DESC,ORDEN;
    
 
    l_total NUMBER(10,2); 
    l_total_hijo NUMBER(10,2); 
    
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    
    l_id_persona number;
    l_orden number;
    l_id_postulante NUMBER;  

  BEGIN
  
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    
    FOR cur in curDES LOOP
      BEGIN
        l_total:= 0;
        CASE 
        WHEN cur.tipo_proceso = 'PF' OR cur.tipo_proceso = 'P'  THEN
        
          l_formula:= CUR.formula;
           if cur.ID_PROCEDURE_PRO>0 then
            select nombre into l_formula from eliseo.mat_procedure where id_procedure=cur.ID_PROCEDURE_PRO;
           end if;
         
          EXECUTE IMMEDIATE 'BEGIN PKG_PROF.'||l_formula||'(:P_ID_PROFORMA,:P_ID_CRITERIO_SEMESTRE,:l_error,:l_msgerror);end;'
          --INTO l_error,l_msgerror
          USING P_ID_PROFORMA,cur.id_criterio_semestre,IN OUT l_error,IN OUT l_msgerror;
          

          
          if l_error=1 then
             Exit when l_error=1;
          end if;
        WHEN cur.tipo_proceso = 'F' then
           SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
           WHERE ID_PROFORMA=P_ID_PROFORMA;
           
           insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES(
            P_ID_PROFORMA,
            CUR.id_criterio_semestre,
            l_items,
            l_id_semestre_programa,
            CUR.nombre,
            CUR.dc,
            CUR.importe,
            CUR.tipo_valor
            );
        WHEN cur.tipo_proceso IS NULL THEN
          
           SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
           WHERE ID_PROFORMA=P_ID_PROFORMA;
           
           insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES(
            P_ID_PROFORMA,
            cur.id_criterio_semestre,
            l_items,
            l_id_semestre_programa,
            cur.nombre,
            cur.dc,
            NULL,
            cur.tipo_valor
            );
                
        END CASE;
      END;
    END LOOP;

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
  END SP_DESCTOS_ALUM_PROFORMA;
  
  PROCEDURE SP_ENSE_REGULAR_FIJO(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,A.CREDITOS
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_creditos
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE
      INTO
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nombre
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
    
     
    SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
    WHERE ID_PROFORMA=P_ID_PROFORMA;
    
    
    insert into PRO_CONCEPTO_ASIGN_ALUM(
      ID_PROFORMA,
      ID_CRITERIO_SEMESTRE,
      ITEM,
      ID_SEMESTRE_PROGRAMA,
      DESCRIPCION,
      DC,
      CANTIDAD,
      UNITARIO,
      TOTAL,
      TIPO_VALOR
    )
    VALUES( 
    P_ID_PROFORMA,
    P_ID_CRITERIO_SEMESTRE,
    l_items, 
    l_id_semestre_programa,
    l_nombre,
    l_dc,
    l_creditos,
    l_importe,
    l_creditos*l_importe,
    l_tipo_valor
    );
        
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_ENSE_REGULAR_FIJO;
  
  PROCEDURE SP_DESC_SOLICITUD_BECA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,A.CREDITOS
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_creditos
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE
      INTO
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nombre
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
    
     
    SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
    WHERE ID_PROFORMA=P_ID_PROFORMA;
    
    
    insert into PRO_CONCEPTO_ASIGN_ALUM(
        ID_PROFORMA,
        ID_CRITERIO_SEMESTRE,
        ITEM,
        ID_SEMESTRE_PROGRAMA,
        DESCRIPCION,
        DC,
        TOTAL,
        TIPO_VALOR
        )VALUES(
        P_ID_PROFORMA,
        P_ID_CRITERIO_SEMESTRE,
        l_items,
        l_id_semestre_programa,
        l_nombre,
        l_dc,
        l_importe,
        l_tipo_valor
        );
        
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_DESC_SOLICITUD_BECA;
  PROCEDURE SP_DESC_ESPECIAL(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,A.CREDITOS
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_creditos
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE
      INTO
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nombre
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
    
     
    SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
    WHERE ID_PROFORMA=P_ID_PROFORMA;
    
    
    insert into PRO_CONCEPTO_ASIGN_ALUM(
        ID_PROFORMA,
        ID_CRITERIO_SEMESTRE,
        ITEM,
        ID_SEMESTRE_PROGRAMA,
        DESCRIPCION,
        DC,
        TOTAL,
        TIPO_VALOR
        )VALUES(
        P_ID_PROFORMA,
        P_ID_CRITERIO_SEMESTRE,
        l_items,
        l_id_semestre_programa,
        l_nombre,
        l_dc,
        l_importe,
        l_tipo_valor
        );
        
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_DESC_ESPECIAL;
  
  PROCEDURE SP_DESC_HIJO_MISIONERO(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
    l_tipo_hijo varchar2(10);
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,coalesce(A.TIPO_HIJO,'N')
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_tipo_hijo
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    if l_tipo_hijo='M' then
      SELECT 
        ID_CRITERIO,
        IMPORTE,
        TIPO_PROCESO,
        TIPO_VALOR,
        DC,
        NOMBRE
        INTO
        l_id_criterio,
        l_importe,
        l_tipo_proceso,
        l_tipo_valor,
        l_dc,
        l_nombre
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
      
       
      SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
      WHERE ID_PROFORMA=P_ID_PROFORMA;
      
      
      insert into PRO_CONCEPTO_ASIGN_ALUM(
          ID_PROFORMA,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          TOTAL,
          TIPO_VALOR
          )VALUES(
          P_ID_PROFORMA,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nombre,
          l_dc,
          l_importe,
          l_tipo_valor
          );
    end if;    
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_DESC_HIJO_MISIONERO;
  
  PROCEDURE SP_RESI_RESIDENCIA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
    l_id_resis_tipo_habitacion number;
    l_desde date;
    l_hasta date;
    l_dias decimal(10,2):=112;
    l_id_semestre number;
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,coalesce(ID_RESID_TIPO_HABITACION,0)
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_id_resis_tipo_habitacion
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    SELECT ID_SEMESTRE into l_id_semestre FROM DAVID.ACAD_SEMESTRE_PROGRAMA WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa;
    
    select DIAS_RESID into l_dias from eliseo.pro_semestre where id_semestre=l_id_semestre;
    
    if l_id_resis_tipo_habitacion>0 then
    
     
        SELECT 
          ID_CRITERIO,
          IMPORTE,
          TIPO_PROCESO,
          TIPO_VALOR,
          DC,
          NOMBRE
          INTO
          l_id_criterio,
          l_importe,
          l_tipo_proceso,
          l_tipo_valor,
          l_dc,
          l_nombre
        FROM VW_MAT_CRITERIO_SEMESTRE
        WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
        
        SELECT count(1) into l_contar
      from DAVID.residencia_habitacion rh 
      inner join DAVID.Residencia_Bloque rb on Rb.Id_Bloque=Rh.Id_Bloque
      inner join DAVID.residencia_tipo_habitacion rth on Rth.Id_Residencia=Rb.Id_Residencia and Rth.Id_Resid_Tipo_Habitacion=Rh.Id_Resid_Tipo_Habitacion  and Rth.Estado='1'
      where rth.ID_CRITERIO=l_id_criterio;
     
      if l_contar>0 then 
        SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
        WHERE ID_PROFORMA=P_ID_PROFORMA;
        
        
        insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            CANTIDAD,
            UNITARIO,
            TOTAL,
            TIPO_VALOR
            )VALUES(
            P_ID_PROFORMA,
            P_ID_CRITERIO_SEMESTRE,
            l_items,
            l_id_semestre_programa,
            l_nombre||' '||TO_CHAR(l_dias)||' dias' ,
            l_dc,
            l_dias,
            l_importe,
            l_importe*l_dias,
            l_tipo_valor
            );
        end if;
    ELSE
      l_dias:=0;
    end if;  
    
    update PRO_PROFORMA SET 
      DIAS_RESIDENCIA=l_dias
    WHERE ID_PROFORMA=P_ID_PROFORMA; 
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_RESI_RESIDENCIA;
  
  PROCEDURE SP_RESI_ALIMENTACION(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
    l_id_resis_tipo_habitacion number;
    l_desde date;
    l_hasta date;
    l_dias decimal(10,2):=112;
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,coalesce(A.ID_RESID_TIPO_HABITACION,0), coalesce(A.DIAS_RESIDENCIA,0)
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_id_resis_tipo_habitacion,l_dias
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    if l_id_resis_tipo_habitacion>0 then
    
      
    
      SELECT 
        ID_CRITERIO,
        IMPORTE,
        TIPO_PROCESO,
        TIPO_VALOR,
        DC,
        NOMBRE
        INTO
        l_id_criterio,
        l_importe,
        l_tipo_proceso,
        l_tipo_valor,
        l_dc,
        l_nombre
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
      
       
      SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
      WHERE ID_PROFORMA=P_ID_PROFORMA;
      
      
      insert into PRO_CONCEPTO_ASIGN_ALUM(
          ID_PROFORMA,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          CANTIDAD,
          UNITARIO,
          TOTAL,
          TIPO_VALOR
          )VALUES(
          P_ID_PROFORMA,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nombre||' ' ||TO_CHAR(l_dias)||' dias' ,
          l_dc,
          l_dias,
          l_importe,
          l_importe*l_dias,
          l_tipo_valor
          );
          
    end if;    
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_RESI_ALIMENTACION;
  
  PROCEDURE SP_RESI_LAVANDERIA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
    l_id_resis_tipo_habitacion number;
    l_desde date;
    l_hasta date;
    l_dias decimal(10,2):=112;
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,coalesce(A.ID_RESID_TIPO_HABITACION,0),coalesce(A.DIAS_RESIDENCIA,0)
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_id_resis_tipo_habitacion,l_dias
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    if l_id_resis_tipo_habitacion>0 then
    
      SELECT 
        ID_CRITERIO,
        IMPORTE,
        TIPO_PROCESO,
        TIPO_VALOR,
        DC,
        NOMBRE
        INTO
        l_id_criterio,
        l_importe,
        l_tipo_proceso,
        l_tipo_valor,
        l_dc,
        l_nombre
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
      
      SELECT COUNT(*) INTO l_contar FROM DAVID.RESIDENCIA_CARACTERISTICA A, DAVID.TIPO_CARACTERISTICA_RESIDENCIA B 
      WHERE A.ID_TIPO_CARACT_RESIDENCIA=B.ID_TIPO_CARACT_RESIDENCIA
      AND A.ID_RESID_TIPO_HABITACION=l_id_resis_tipo_habitacion  and a.estado='1'
      AND B.CODIGO='7';
      
      IF l_contar>0 THEN
      
        SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
        WHERE ID_PROFORMA=P_ID_PROFORMA;
        
        
        insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            CANTIDAD,
            UNITARIO,
            TOTAL,
            TIPO_VALOR
            )VALUES(
            P_ID_PROFORMA,
            P_ID_CRITERIO_SEMESTRE,
            l_items,
            l_id_semestre_programa,
            l_nombre||' ' ||TO_CHAR(l_dias)||' dias' ,
            l_dc,
            l_dias,
            l_importe,
            l_importe*l_dias,
            l_tipo_valor
            );
      end if; 
    end if;    
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_RESI_LAVANDERIA;
  
  PROCEDURE SP_DESC_PRONTO_PAGO_JUL(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
    l_id_planpago_semestre number;
    l_tipo_hijo varchar2(10);
    l_cuotas number;
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,coalesce(ID_PLANPAGO_SEMESTRE,0),coalesce(A.TIPO_HIJO,'N')
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_id_planpago_semestre,l_tipo_hijo
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
     
    if l_id_planpago_semestre>0 then
    
      SELECT C.CUOTAS
      INTO l_cuotas
      FROM MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
      WHERE B.ID_PLANPAGO=C.ID_PLANPAGO
      AND B.ID_PLANPAGO_SEMESTRE = l_id_planpago_semestre;
    
      if l_cuotas=1 and l_tipo_hijo<>'M' then
      
        SELECT 
          ID_CRITERIO,
          IMPORTE,
          TIPO_PROCESO,
          TIPO_VALOR,
          DC,
          NOMBRE
          INTO
          l_id_criterio,
          l_importe,
          l_tipo_proceso,
          l_tipo_valor,
          l_dc,
          l_nombre
        FROM VW_MAT_CRITERIO_SEMESTRE
        WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
        
         
        SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
        WHERE ID_PROFORMA=P_ID_PROFORMA;
        
        
        insert into PRO_CONCEPTO_ASIGN_ALUM(
            ID_PROFORMA,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES(
            P_ID_PROFORMA,
            P_ID_CRITERIO_SEMESTRE,
            l_items,
            l_id_semestre_programa,
            l_nombre,
            l_dc,
            l_importe,
            l_tipo_valor
            );      
      end if; 
    end if;  
    
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_DESC_PRONTO_PAGO_JUL;
  
  PROCEDURE SP_LISTAR_DETALLE_PROFORMA(P_ID_PROFORMA NUMBER,P_DC VARCHAR2,CURSOR OUT SYS_REFCURSOR ) AS
 
      BEGIN
        
        OPEN cursor FOR 
          select 
            x.id_criterio,
            x.id_parent,
            x.nombre,
            x.importe,
            x.dc,
            x.codigo,
            x.orden,
            x.tipo,
            x.ver_hijo,
            level as nivel
          from(
            select
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            --(case when a.dc = 'C' AND b.codigo in('DSCTOCP','DSCTOCPCA') then 'X' else a.dc end) as tipo --Mostraba Cobranza Suspendida
            (case when a.dc = 'C' AND b.codigo in('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and b.id_parent is null
            and coalesce(b.ver_hijo,'N')='N'
            union
            select 
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            (case when a.dc = 'C' AND b.codigo in('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and b.id_parent is null
            and coalesce(b.ver_hijo,'N')='S'
            union
            select 
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            (case when a.dc = 'C' AND b.codigo in('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and coalesce(b.id_parent,0) in(
              select  
              b.id_criterio
              from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
              where a.id_criterio_semestre=b.id_criterio_semestre
              and a.ID_PROFORMA=P_ID_PROFORMA
              and a.dc like '%'||P_DC||'%'
              and b.id_parent is null
              and coalesce(b.ver_hijo,'N')='S'
            )
            order by orden
          )x
          START WITH x.id_parent is null
          CONNECT BY PRIOR x.id_criterio = coalesce(x.id_parent,0) 
          ORDER SIBLINGS BY x.dc desc,x.orden;
        
      END SP_LISTAR_DETALLE_PROFORMA;
      
      PROCEDURE SP_DESC_HIJO_PERSONAL(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
    l_tipo_hijo varchar2(10);
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,coalesce(A.TIPO_HIJO,'N')
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_tipo_hijo
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    if l_tipo_hijo='T' then
      SELECT 
        ID_CRITERIO,
        IMPORTE,
        TIPO_PROCESO,
        TIPO_VALOR,
        DC,
        NOMBRE
        INTO
        l_id_criterio,
        l_importe,
        l_tipo_proceso,
        l_tipo_valor,
        l_dc,
        l_nombre
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
      
       
      SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
      WHERE ID_PROFORMA=P_ID_PROFORMA;
      
      
      insert into PRO_CONCEPTO_ASIGN_ALUM(
          ID_PROFORMA,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          TOTAL,
          TIPO_VALOR
          )VALUES(
          P_ID_PROFORMA,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nombre,
          l_dc,
          l_importe,
          l_tipo_valor
          );
    end if;    
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_DESC_HIJO_PERSONAL;
  
  PROCEDURE SP_DESC_PROMOTORA(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_id_postulante NUMBER;
    l_so varchar2(10);
  begin
  
    
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,coalesce(A.SOSTENEDOR_OBRA,'N')
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_so
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    if l_so='S' then
      SELECT 
        ID_CRITERIO,
        IMPORTE,
        TIPO_PROCESO,
        TIPO_VALOR,
        DC,
        NOMBRE
        INTO
        l_id_criterio,
        l_importe,
        l_tipo_proceso,
        l_tipo_valor,
        l_dc,
        l_nombre
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
      
       
      SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
      WHERE ID_PROFORMA=P_ID_PROFORMA;
      
      
      insert into PRO_CONCEPTO_ASIGN_ALUM(
          ID_PROFORMA,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          TOTAL,
          TIPO_VALOR
          )VALUES(
          P_ID_PROFORMA,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nombre,
          l_dc,
          l_importe,
          l_tipo_valor
          );
    end if;    
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_DESC_PROMOTORA;
  
  PROCEDURE SP_ENSE_REGULAR(P_ID_PROFORMA IN NUMBER,P_ID_CRITERIO_SEMESTRE IN NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  is
    l_items number;
    l_contar number;
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_id_semestre_programa number;
    l_id_persona number;
    
    l_id_criterio	number;
    l_importe	number(10,2);
    l_tipo_proceso	varchar2(2 byte);
    l_tipo_valor	varchar2(2 byte);
    l_nombre varchar2(150 byte);
    l_id_plan number;
    l_dc varchar2(1);
    l_creditos number(10,2);
    l_costo  number(10,2);
    l_id_postulante NUMBER;
    l_ciclo number;
  begin
  
    SELECT B.ID_PERSONA, A.ID_SEMESTRE_PROGRAMA,B.ID_POSTULANTE,a.ciclo,a.creditos
    INTO l_id_persona,l_id_semestre_programa,l_id_postulante,l_ciclo,l_creditos
    FROM ELISEO.PRO_PROFORMA A, PRO_POSTULANTE B
    WHERE A.ID_POSTULANTE=B.ID_POSTULANTE
    AND A.ID_PROFORMA = P_ID_PROFORMA;
    
    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE
      INTO
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nombre
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;
    
    
   select count(1) into l_contar from DAVID.VW_ACAD_CARGA_ACADEMICA where ID_SEMESTRE_PROGRAMA=l_id_semestre_programa  and ciclo=l_ciclo;  
   if l_contar=0 then
      l_error:=1;
      l_msgerror:='No existe plan';
      goto salida_proc;
   end if;
   
   select id_plan INTO l_id_plan from DAVID.VW_ACAD_CARGA_ACADEMICA where ID_SEMESTRE_PROGRAMA=l_id_semestre_programa  and ciclo=l_ciclo group by id_plan;   
    
    
    SELECT COUNT(*) INTO l_contar  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio;
    
    if l_items=0 then
      l_error:=1;
      l_msgerror:='No esta asignado costo de enseñanza';
      goto salida_proc;
    end if;

    
    SELECT  COUNT(*) INTO l_contar  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio;
    
    if l_contar=0 then
      l_error:=1;
      l_msgerror:='Falta asignar costo de enseñanza';
      goto salida_proc;
    end if;
    
    SELECT COUNT(*) INTO l_contar  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio
    AND coalesce(a.IMPORTE,0)<=0 ;
    
    if l_contar>0 then
      l_error:=1;
      l_msgerror:='Falta asignar costo de enseñanza para algunos planes, importe cero';
      goto salida_proc;
    end if;
    
     SELECT  coalesce(IMPORTE,0) into  l_costo  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio;
    
    SELECT COALESCE(MAX(ITEM),0)+1  INTO l_items FROM PRO_CONCEPTO_ASIGN_ALUM
      WHERE ID_PROFORMA=P_ID_PROFORMA;
    
    
    
    insert into PRO_CONCEPTO_ASIGN_ALUM(
      ID_PROFORMA,
      ID_CRITERIO_SEMESTRE,
      ITEM,
      ID_SEMESTRE_PROGRAMA,
      DESCRIPCION,
      DC,
      CANTIDAD,
      UNITARIO,
      TOTAL,
      TIPO_VALOR,
      ID_PLAN
     )VALUES(
    P_ID_PROFORMA,
    P_ID_CRITERIO_SEMESTRE,
    l_items, 
    l_id_semestre_programa,
    l_nombre,
    l_dc,
    l_creditos,
    l_costo,
    l_creditos*l_costo,
    l_tipo_valor,
    l_id_plan
    );
        
    <<salida_proc>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END SP_ENSE_REGULAR;
  
END PKG_PROF;