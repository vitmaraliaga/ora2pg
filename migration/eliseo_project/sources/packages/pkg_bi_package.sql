-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE        PKG_BI AS
/******************************************************************************
   NAME:       PKG_BI
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        10/09/2018      wilder.marlo       1. Created this package.
******************************************************************************/

  
  PROCEDURE SPC_BI_ASIENTOS(cursor OUT SYS_REFCURSOR);
  PROCEDURE SPC_BI_TESORERIA(cursor OUT SYS_REFCURSOR);

END PKG_BI;


CREATE OR REPLACE PACKAGE BODY        PKG_BI AS
    PROCEDURE SPC_BI_ASIENTOS(cursor OUT SYS_REFCURSOR ) IS
    BEGIN
        OPEN cursor FOR 
        SELECT 
                A.ID_ENTIDAD,A.ID_ANHO,A.ID_MES,
                SUBSTR(B.ID_DEPTO,1,1) AS LEVEL_1,
                SUBSTR(B.ID_DEPTO,1,2) AS LEVEL_2,
                SUBSTR(B.ID_DEPTO,1,4) AS LEVEL_4,
                SUBSTR(B.ID_DEPTO,1,6) AS LEVEL_6,
                B.ID_DEPTO,
                SUBSTR(B.ID_CUENTAAASI,1,3) ID_CUENTAAASI,
                ABS(SUM(B.COS_VALOR)) IMPORTE,
                FC_CUENTA(SUBSTR(B.ID_CUENTAAASI,1,3)) NAME_CTA,
                (CASE  
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3) BETWEEN 111 AND 116 THEN 'ACTIVO CORRIENTE' 
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3) BETWEEN 121 AND 124 THEN 'ACTIVO NO CORRIENTE' 
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3) BETWEEN 213 AND 216 THEN 'PASIVO CORRIENTE' 
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3) = 221 THEN 'PASIVO NO CORRIENTE'
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3) IN (231,232) THEN 'PATRIMONIO NETO'
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3) BETWEEN 313 AND 318 THEN 'INGRESOS'
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3) BETWEEN 411 AND 419 THEN 'GASTOS'
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3)= 319 THEN 'Ingresos Inter-Departamentos'
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3)= 419 THEN 'GASTOS Inter-Departamentos'
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3)= 321 THEN 'Ingresos No Recurrientes'
                WHEN SUBSTR(B.ID_CUENTAAASI,1,3)= 421 THEN 'GASTOS No Recurrientes'
                END) NAME_GRUPO
        FROM CONTA_DIARIO A,CONTA_DIARIO_DETALLE B
        WHERE A.ID_ENTIDAD = B.ID_ENTIDAD
        AND A.ID_DIARIO = B.ID_DIARIO
        AND A.ID_ENTIDAD = 7124
        GROUP BY A.ID_ENTIDAD,A.ID_ANHO,A.ID_MES,SUBSTR(B.ID_DEPTO,1,1),SUBSTR(B.ID_CUENTAAASI,1,3),SUBSTR(B.ID_DEPTO,1,2),SUBSTR(B.ID_DEPTO,1,4),SUBSTR(B.ID_DEPTO,1,6),B.ID_DEPTO,SUBSTR(B.ID_CUENTAAASI,1,3)
        ORDER BY A.ID_ENTIDAD,A.ID_ANHO,A.ID_MES,ID_DEPTO,ID_CUENTAAASI;
    END;
    PROCEDURE SPC_BI_TESORERIA(cursor OUT SYS_REFCURSOR ) IS
        BEGIN
            OPEN cursor FOR 
            SELECT 
                    ID_ENTIDAD,ID_ANHO,ID_MES,
                    (CASE ID_MES 
                    WHEN 1 THEN 'ENERO' 
                    WHEN 2 THEN 'FEBRERO'
                    WHEN 3 THEN 'MARZO'
                    WHEN 4 THEN 'ABRIL'
                    WHEN 5 THEN 'MAYO'
                    WHEN 6 THEN 'JUNIO'
                    WHEN 7 THEN 'JULIO'
                    WHEN 8 THEN 'AGOSTO'
                    WHEN 9 THEN 'SETIEMBRE'
                    WHEN 10 THEN 'OCTUBRE'
                    WHEN 11 THEN 'NOVIEMBRE'
                    ELSE 'DICIEMBRE' END) AS MES,
                    DEPTO,FC_NIVEL_PARENT(DEPTO_PARENT) DEPTO_PARENT,CUENTA,FC_CUENTA_PARENT(CTA_PARENT) CUENTA_PARENT,
                    SUM(COS_VALOR) AS IMPORTE
            FROM (
                    SELECT 
                            B.ID_ENTIDAD,B.ID_ANHO,B.ID_MES,
                            B.COS_VALOR,
                            A.ID_PARENT AS DEPTO_PARENT,A.NOMBRE AS DEPTO,C.ID_PARENT AS CTA_PARENT,C.NOMBRE AS CUENTA 
                    FROM VW_REP_DEPTOS A, VW_CONTA_DIARIO B, VW_REP_CUENTAS C
                    WHERE A.ID_ENTIDAD = B.ID_ENTIDAD
                    AND A.ID_ANHO = B.ID_ANHO
                    AND A.ID_DEPTO = B.ID_DEPTO
                    AND B.ID_ENTIDAD = C.ID_ENTIDAD
                    AND B.ID_ANHO = C.ID_ANHO
                    AND B.ID_CUENTAAASI = C.ID_CUENTAAASI
                    UNION ALL
                    SELECT 
                            B.ID_ENTIDAD,B.ID_ANHO,B.ID_MES,
                            B.COS_VALOR,
                            A.ID_PARENT AS DEPTO_PARENT,A.NOMBRE AS DEPTO,C.ID_PARENT AS CTA_PARENT,C.NOMBRE AS CUENTA 
                    FROM VW_REP_DEPTOS A, VW_CONTA_DIARIO B, VW_REP_CUENTAS_CTES C
                    WHERE A.ID_ENTIDAD = B.ID_ENTIDAD
                    AND A.ID_ANHO = B.ID_ANHO
                    AND A.ID_DEPTO = B.ID_DEPTO
                    AND B.ID_ENTIDAD = C.ID_ENTIDAD
                    AND B.ID_ANHO = C.ID_ANHO
                    AND B.ID_CUENTAAASI = C.ID_CUENTAAASI
                    AND B.ID_CTACTE = C.CTA_CTE
            )
            WHERE ID_ENTIDAD = 7124
            --AND ID_ANHO BETWEEN 2018-5 AND 2018
            GROUP BY ID_ENTIDAD,ID_ANHO,ID_MES,DEPTO,DEPTO_PARENT,CUENTA,CTA_PARENT
            ORDER BY ID_MES,DEPTO;
    END;
END PKG_BI;