-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE        PKG_HUMAN_TALENT AS

  PROCEDURE SP_VALID_GENERATE(P_ID_ENTIDAD number,P_ID_ANHO number ,P_ID_MES number,P_ID_DEPTO varchar2,P_ID_PERSONA number,P_ID_CERTIFICADO  number,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
  PROCEDURE SP_PLANILLA_BOLETA_PROCESO(P_ID_PROCESO NUMBER,P_ID_GESTION NUMBER);
  PROCEDURE SP_CORREO_PERSONA(P_ID_ENTIDAD NUMBER,P_ID_PERSONA NUMBER, P_ID_ANHO NUMBER,P_ID_MES NUMBER,P_EMAIL VARCHAR2);
  PROCEDURE SP_PROC_EMAIL_CELULAR(P_ID_PERSONA NUMBER, P_OPCION VARCHAR2,P_TIPO VARCHAR2,P_ID_VIRTUAL NUMBER,P_ID_TELEFONO NUMBER,P_EMAIL VARCHAR2,P_CELULAR VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2);
  PROCEDURE SP_GENERA_CONTROL_CULTO(P_ID_ENTIDAD NUMBER);
  PROCEDURE SP_GENERA_CONTROL_CULTO_LIMP(P_ID_ENTIDAD NUMBER);
END PKG_HUMAN_TALENT;


CREATE OR REPLACE PACKAGE BODY        PKG_HUMAN_TALENT AS
 PROCEDURE SP_VALID_GENERATE(P_ID_ENTIDAD number,P_ID_ANHO number ,P_ID_MES number,P_ID_DEPTO varchar2,P_ID_PERSONA number,P_ID_CERTIFICADO  number,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
    l_error number:=0;
    l_msgerror varchar2(300):='';
    l_contar NUMBER;
    l_id_certificado number;
    l_archivo number;
    ls_clave varchar2(500);
    ls_desde date;
    ls_hasta date;
    id_persona number;
    ls_firma varchar2(500);
  
  BEGIN
 
     SELECT COUNT(*) INTO l_contar 
     from APS_CERTIFICADO_DEPTO
     where id_entidad = P_ID_ENTIDAD
     and id_depto = P_ID_DEPTO
     and id_certificado in(
        select a.id_certificado FROM APS_CERTIFICADO a ,APS_CERTIFICADO_DEPTO b
        where a.id_certificado=b.id_certificado
        and a.estado='1'
        and b.id_depto =P_ID_DEPTO
        and a.id_certificado= P_ID_CERTIFICADO
        --and hasta >= sysdate
     );
     
     IF l_contar=0 THEN
      l_error:=1;
      l_msgerror:='No esta asignado certificado digital para el departamento '||P_ID_DEPTO;
     ELSE
       IF l_contar>1 THEN
        l_error:=1;
        l_msgerror:='Hay '||l_contar||' certificados digitales activos para el departamento '||P_ID_DEPTO;
       END IF;
     END IF;
     
    
     
     IF l_error=0 THEN
     
      SELECT id_certificado INTO l_id_certificado 
      from APS_CERTIFICADO_DEPTO
      where id_entidad = P_ID_ENTIDAD
      and id_depto = P_ID_DEPTO
      and id_certificado in(
        select a.id_certificado FROM APS_CERTIFICADO a ,APS_CERTIFICADO_DEPTO b
        where a.id_certificado=b.id_certificado
        and a.estado='1'
        and b.id_depto =P_ID_DEPTO
        and a.id_certificado= P_ID_CERTIFICADO
        --and hasta >= sysdate
      );
      
      SELECT 
                length(archivo) as ARCHIVO,
                CLAVE,
                DESDE,
                HASTA,
                coalesce(id_persona,0) as ID_PERSONA,
                FIRMA
                into
                l_archivo,
                ls_clave,
                ls_desde,
                ls_hasta,
                id_persona,
                ls_firma
        FROM APS_CERTIFICADO
        where id_certificado=l_id_certificado;
        
        if l_archivo=0 then
          l_error:=1;
          l_msgerror:='No existe archivo de firma digital('||l_id_certificado||')';
        else
          
            if sysdate > ls_hasta then
              l_error:=1;
              l_msgerror:='Firma digital('||l_id_certificado||') ha caducado  el '||to_char(ls_hasta,'DD/MM/YYYY');
            else
              if id_persona=0 then
                l_error:=1;
                l_msgerror:='Firma digital('||l_id_certificado||') no esta asignado a ningún representate legal';
                else
                  if ls_firma is null then
                    l_error:=1;
                    l_msgerror:='No esta registrado firma escaneado de representate legal - Firma digital('||l_id_certificado||') ';
                  end if;
              end if;
            end if;

        end if;
      
     end if;
     
     IF l_error=0 THEN
        
        if P_ID_PERSONA>0 then
          SELECT  count(*)  into l_contar
          FROM VW_APS_PLANILLA A
          WHERE ID_ENTIDAD = P_ID_ENTIDAD
          AND ID_ANHO = P_ID_ANHO
          AND ID_MES = P_ID_MES
          AND ID_PERSONA=P_ID_PERSONA;
          
          IF l_contar=0 THEN
            l_error:=1;
            l_msgerror:='No existe información de boleta para el periodo '||P_ID_ANHO||'-'||P_ID_MES||' para el personal('||P_ID_PERSONA||')';
          ELSE
              SELECT COUNT(*) INTO l_contar FROM  APS_PLANILLA_BOLETA 
              WHERE ID_ENTIDAD=P_ID_ENTIDAD
              AND ID_ANHO=P_ID_ANHO
              AND ID_MES=P_ID_MES
              AND ID_PERSONA=P_ID_PERSONA
              AND ID_DEPTO=P_ID_DEPTO;
              
              IF l_contar>0 THEN
                l_error:=1;
                l_msgerror:='Ya esta generado firma digital de la boleta  para el personal('||P_ID_PERSONA||') del periodo '||P_ID_ANHO||'-'||P_ID_MES;
              END IF;
          END IF;
          
        END IF;
     end if;
        
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  
  END SP_VALID_GENERATE;
  PROCEDURE SP_PLANILLA_BOLETA_PROCESO(P_ID_PROCESO NUMBER,P_ID_GESTION NUMBER) IS
    l_contar number:=0;

    
  BEGIN
    select count(*) into l_contar from APS_PLANILLA_BOLETA_PROCESO  where ID_GESTION=P_ID_GESTION and ID_PROCESO=P_ID_PROCESO;
    
    
   
    IF l_contar=0 THEN
    

      
      INSERT INTO APS_PLANILLA_BOLETA_PROCESO(ID_GESTION,ID_PROCESO,FECHA)VALUES(P_ID_GESTION,P_ID_PROCESO,SYSDATE);
      
      
    ELSE
      UPDATE APS_PLANILLA_BOLETA_PROCESO SET FECHA=SYSDATE where ID_GESTION=P_ID_GESTION  and ID_PROCESO=P_ID_PROCESO;
    END IF;


  END SP_PLANILLA_BOLETA_PROCESO;
  
  PROCEDURE SP_CORREO_PERSONA(P_ID_ENTIDAD NUMBER,P_ID_PERSONA NUMBER, P_ID_ANHO NUMBER,P_ID_MES NUMBER,P_EMAIL VARCHAR2) IS
    l_contar number:=0;
    l_id_virtual NUMBER;
    
  BEGIN
  
    select count(*) into l_contar from moises.PERSONA_VIRTUAL  WHERE  ID_PERSONA=P_ID_PERSONA AND ID_TIPOVIRTUAL=1; --and GTH=1;
    
    IF l_contar=0 THEN
      INSERT INTO moises.PERSONA_VIRTUAL(
      ID_VIRTUAL,
      ID_PERSONA,
      ID_TIPOVIRTUAL,
      DIRECCION,
      COMENTARIO,
      GTH
      )VALUES(
      1,
      P_ID_PERSONA,
      1,
      P_EMAIL,
      '',
      1
      );
  
    END IF;
    
    --UPDATE APS_PLANILLA_BOLETA SET CORREO=P_EMAIL WHERE ID_ENTIDAD=P_ID_ENTIDAD AND  ID_PERSONA=P_ID_PERSONA AND CORREO IS NULL;
    
    --UPDATE APS_PLANILLA_BOLETA SET CORREO=P_EMAIL WHERE ID_ENTIDAD=P_ID_ENTIDAD AND  ID_PERSONA=P_ID_PERSONA AND ID_ANHO=P_ID_ANHO AND ID_MES=P_ID_MES;


  END SP_CORREO_PERSONA;
  
  PROCEDURE SP_PROC_EMAIL_CELULAR(P_ID_PERSONA NUMBER, P_OPCION VARCHAR2,P_TIPO VARCHAR2,P_ID_VIRTUAL NUMBER,P_ID_TELEFONO NUMBER,P_EMAIL VARCHAR2,P_CELULAR VARCHAR2,P_ERROR OUT number,P_MSGERROR out VARCHAR2) IS
    l_error number:=0;
    l_msgerror varchar2(200):='';
    l_contar number:=0;
    l_id NUMBER;
    
  BEGIN
  
  
  IF P_TIPO='E' THEN
    IF P_OPCION='I' THEN
    
      SELECT COUNT(*) INTO l_contar FROM moises.PERSONA_VIRTUAL WHERE ID_PERSONA=P_ID_PERSONA AND ID_TIPOVIRTUAL=1 AND LOWER(DIRECCION)=LOWER(P_EMAIL);
      
      IF l_contar=0 THEN
      
        SELECT COALESCE(MAX(ID_VIRTUAL),0)+1 INTO l_id FROM moises.PERSONA_VIRTUAL WHERE ID_PERSONA=P_ID_PERSONA; 
        
        UPDATE moises.PERSONA_VIRTUAL SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOVIRTUAL=1; 
      
        INSERT INTO moises.PERSONA_VIRTUAL(
          ID_VIRTUAL,
          ID_PERSONA,
          ID_TIPOVIRTUAL,
          DIRECCION,
          COMENTARIO,
          GTH
        )VALUES(
          l_id,
          P_ID_PERSONA,
          1,
          P_EMAIL,
          '',
          1
        );
      
      UPDATE moises.PERSONA_NATURAL set correo = P_EMAIL where ID_PERSONA=P_ID_PERSONA;
        
      ELSE
        l_error:=1;
        l_msgerror:='YA ESTA REGISTRADO EL CORREO '||P_EMAIL;
      END IF;
    ELSE
    
      UPDATE moises.PERSONA_VIRTUAL SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOVIRTUAL=1; 
      
      UPDATE moises.PERSONA_VIRTUAL SET GTH=1 WHERE ID_PERSONA=P_ID_PERSONA AND ID_VIRTUAL=P_ID_VIRTUAL AND ID_TIPOVIRTUAL=1; 

      UPDATE moises.PERSONA_NATURAL set correo = (
        SELECT max(DIRECCION) FROM moises.PERSONA_VIRTUAL pv 
        WHERE ID_TIPOVIRTUAL = 1
        AND ID_PERSONA = P_ID_PERSONA
        AND GTH = '1') where ID_PERSONA=P_ID_PERSONA;
      
    END IF;
  ELSE
    IF P_OPCION='I' THEN
    
      SELECT COUNT(*) INTO l_contar FROM moises.PERSONA_TELEFONO WHERE ID_PERSONA=P_ID_PERSONA AND ID_TIPOTELEFONO in (3,5) AND LOWER(NUM_TELEFONO)=LOWER(P_CELULAR);
      
      IF l_contar=0 THEN
      
        SELECT COALESCE(MAX(ID_TELEFONO),0)+1 INTO l_id FROM moises.PERSONA_TELEFONO WHERE ID_PERSONA=P_ID_PERSONA; 
        
        UPDATE moises.PERSONA_TELEFONO SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOTELEFONO=3; 
      
        INSERT INTO moises.PERSONA_TELEFONO(
          ID_TELEFONO,
          ID_PERSONA,
          ID_TIPOTELEFONO,
          NUM_TELEFONO,
          ES_ACTIVO,
          ES_PRIVADO,
          COMENTARIO,
          GTH
        )VALUES(
          l_id,
          P_ID_PERSONA,
          3,
          P_CELULAR,
          0,
          0,
          '',
          1
        );
        
        UPDATE moises.PERSONA_NATURAL set celular = P_CELULAR where ID_PERSONA=P_ID_PERSONA;
        
      ELSE
        l_error:=1;
        l_msgerror:='YA ESTA REGISTRADO EL CELULAR '||P_CELULAR;
      END IF;
    ELSE
    
      UPDATE moises.PERSONA_TELEFONO SET GTH=0 WHERE ID_PERSONA=P_ID_PERSONA  AND ID_TIPOTELEFONO in (3,5); 
      
      UPDATE moises.PERSONA_TELEFONO SET GTH=1 WHERE ID_PERSONA=P_ID_PERSONA AND ID_TELEFONO=P_ID_TELEFONO AND ID_TIPOTELEFONO in (3,5); 
      
      UPDATE moises.PERSONA_NATURAL set celular = (
        SELECT max(NUM_TELEFONO) FROM moises.PERSONA_TELEFONO pt
        WHERE ID_TIPOTELEFONO IN (3,5)
        AND ID_PERSONA = P_ID_PERSONA
        AND GTH = '1') where ID_PERSONA=P_ID_PERSONA;
        
    END IF;
  END IF;
  
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_PROC_EMAIL_CELULAR;
  
  PROCEDURE SP_GENERA_CONTROL_CULTO(P_ID_ENTIDAD NUMBER) IS
    l_id NUMBER;
    l_nrodia varchar2(3);
  BEGIN
  
    select coalesce(max(ID_CONTROL_CULTO),0) into l_id from APS_CONTROL_CULTO;

    select 
            to_char(sysdate,'D') as dias
            into l_nrodia
            from dual;
            
    if l_nrodia not in('1','7') then

      insert into aps_control_culto(
      ID_CONTROL_CULTO,
      ID_PERSONA,
      ID_ENTIDAD,
      ID_DEPTO,
      FEC_FECHA,
      LETRA,
      NUMERO,
      ASISTENCIA,
      ASISTENCIA_CULTO,
      ESTADO,
      ACCION
      )
      select 
      ROWNUM + l_id AS ID_CONTROL_CULTO,
      w.ID_PERSONA,
      w.ID_ENTIDAD,
      w.ID_DEPTO,
      sysdate,
      w.LETRA,
      w.NUMERO,
      w.confianza,--0,1
      w.confianza,--0,1
      'R',--'R:Registrado,'J:justificado'
      '0'--0 control no registrado  1 control registrado para los casos
      from (
      select
        a.ID_PERSONA,
        a.ID_ENTIDAD,
        a.ID_DEPTO,
        a.LETRA,
        a.NUMERO,
        case when coalesce(a.confianza,'0')='1' then 1 else 0 end as confianza
        from aps_trabajador a
        where a.id_entidad=P_ID_ENTIDAD
        AND a.ID_PERSONA IN(
          SELECT x.ID_PERSONA FROM APS_EMPLEADO  x
          WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
          AND x.ID_DEPTO=a.ID_DEPTO
          AND x.estado='A'
        ) AND a.ID_PERSONA NOT IN(
          SELECT ID_PERSONA FROM aps_control_culto
          WHERE to_char(FEC_FECHA,'DDMMYYYY') = to_char(SYSDATE,'DDMMYYYY')
        )
        and a.id_depto is not null
      )w;
  end if;
  END SP_GENERA_CONTROL_CULTO;
  
  
  PROCEDURE SP_GENERA_CONTROL_CULTO_LIMP(P_ID_ENTIDAD NUMBER) IS
    l_id NUMBER;
    l_nrodia varchar2(3);
  BEGIN
  
    select coalesce(max(ID_CONTROL),0) into l_id from SERV_CONTROL;

    select 
            to_char(sysdate,'D') as dias
            into l_nrodia
            from dual;
            
    --if l_nrodia not in('1','7') then

      insert into SERV_CONTROL(
      ID_CONTROL,
      ID_GRUPO,
      ID_PERSONA,
      FECHA,
      ASISTENCIA,
      ASISTENCIA_CULTO,
      ESTADO,
      ACCION
      )
      select 
      ROWNUM + l_id AS ID_CONTROL,
      w.ID_GRUPO,
      w.ID_PERSONA,
      sysdate,
      0,--0,1
      0,--0,1
      'R',--'R:Registrado,'J:justificado'
      '0'--0 control no registrado  1 control registrado para los casos
      from (
      select
        a.ID_PERSONA,
        a.ID_GRUPO
        FROM SERV_GRUPO_INTEGRANTES a,SERV_GRUPO G
        where A.ID_GRUPO=G.ID_GRUPO
        AND G.id_entidad=P_ID_ENTIDAD
        AND a.ID_PERSONA IN(
          SELECT x.ID_PERSONA FROM APS_EMPLEADO  x
          WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
          AND x.ID_DEPTO='12010102'
          AND x.estado='A'
        ) AND a.ID_PERSONA NOT IN(
          SELECT ID_PERSONA FROM SERV_CONTROL
          WHERE to_char(FECHA,'DDMMYYYY') = to_char(SYSDATE,'DDMMYYYY')
        )
      )w;
  --end if;
  END SP_GENERA_CONTROL_CULTO_LIMP;
  
END PKG_HUMAN_TALENT;