-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_sta_salary_ing_ctipo_total (
    p_id_entidad           int,
    p_id_anho           int,
    p_id_mes           int,
    p_id_persona       int,
    p_tipo       varchar2,
    p_id_ctacte       varchar2, --add 
    p_id_cuentaaasi       varchar2, --add
    p_dc       varchar2, --add
    cursor       OUT SYS_REFCURSOR
)
IS

    l_ingresos number(38,2);
    l_fecha_desde varchar2(10) := '01';
    l_fecha_hasta varchar2(10) := '25';

BEGIN
    DELETE FROM TT_TABLE_AUX;
    
    IF p_dc = 'C' THEN-- ADELANTOSS JEJEJE 
    OPEN cursor FOR 
        select nvl(SUM(COS_VALOR),0) as total from VW_CONTA_DIARIO
                where id_entidad = p_id_entidad
                and ID_CUENTAAASI = p_id_cuentaaasi
                and ID_CTACTE = p_id_ctacte
                and ID_MES = p_id_mes
                and ID_ANHO = p_id_anho
                -- and not ID_TIPOASIENTO = 'RH'
                AND NOT COMENTARIO LIKE 'APS%'
                AND HABER=0
                AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
                ;
                
    ELSE 
    

    OPEN cursor FOR 
    SELECT nvl(sum(valor),0) as total FROM (
            	/*
    			select 
                nvl(p.COS_VALOR,0) as total, p.fec_pago AS fecha
                from
                VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
                where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
                and p.ID_ENTIDAD=p_id_entidad
                and p.ID_ANHO=p_id_anho
                and p.ID_MES=p_id_mes
                and p.ID_PERSONA=p_id_persona
                and a.ID_TIPOCONCEPTOAPS = p_tipo
                and (
                  P.ID_CONCEPTOAPS like '10%'
                  or P.ID_CONCEPTOAPS like '11%'
                  or P.ID_CONCEPTOAPS like '12%'
                  or P.ID_CONCEPTOAPS like '13%'
                  or P.ID_CONCEPTOAPS like '14%'
                  or P.ID_CONCEPTOAPS like '2%'
                  or P.ID_CONCEPTOAPS like '3%'
                  or P.ID_CONCEPTOAPS like '7%'
                )
                and not P.ID_CONCEPTOAPS like '7600%'
                -- AND ID_TIPOPLANILLA NOT IN (106791)
                UNION
                select nvl(ABS(COS_VALOR),0) as total, FEC_ASIENTO  from VW_CONTA_DIARIO
                where id_entidad = p_id_entidad
                and ID_CUENTAAASI = p_id_cuentaaasi
                and ID_CTACTE = p_id_ctacte
                and ID_MES = p_id_mes
                and ID_ANHO = p_id_anho
                -- and not ID_TIPOASIENTO = 'RH'
                AND NOT COMENTARIO LIKE 'APS%'
                AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
                AND DEBE=0 
                */
    			SELECT to_char(A.fec_pago, 'DD/MM/YY') as fecha,
		        b.NOMBRE AS COMENTARIO,
		        A.COS_VALOR as valor FROM VW_APS_PLANILLA A 
		        INNER JOIN APS_CONCEPTO_PLANILLA B ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
				WHERE ID_ENTIDAD = p_id_entidad
				AND ID_ANHO = p_id_anho
				AND ID_MES = p_id_mes
				AND ID_PERSONA = p_id_persona
				AND ID_TIPOPLANILLA in (98634,106791) -- 
				AND ID_TIPOCONCEPTOAPS = p_tipo
				
				union
                select 
                to_char(FEC_ASIENTO, 'DD/MMYY') AS FECHA,
                    COMENTARIO,
                    ABS(COS_VALOR) as valor
                from VW_CONTA_DIARIO
                where id_entidad = p_id_entidad
                and ID_CUENTAAASI = p_id_cuentaaasi
                and ID_CTACTE = p_id_ctacte
                and ID_MES = p_id_mes
                and ID_ANHO = p_id_anho
                AND NOT COMENTARIO LIKE 'APS%'
                AND DEBE=0
                AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
                ) X ;
               
       END IF;
  
END;

