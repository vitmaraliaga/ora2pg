-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_sta_salary_ing_ctipo (
    p_id_entidad           int,
    p_id_anho           int,
    p_id_mes           int,
    p_id_persona       int,
    p_tipo       varchar2,
    p_id_ctacte       varchar2, --add 
    p_id_cuentaaasi       varchar2, --add
    p_dc       varchar2, --add
    cursor       OUT SYS_REFCURSOR
)
IS
-- Ingresos de cuenta y tipo. 
    l_ingresos number(38,2);
    l_fecha_desde varchar2(10) := '01';
    l_fecha_hasta varchar2(10) := '25';

BEGIN
    DELETE FROM TT_TABLE_AUX;
    
    IF p_dc = 'C' THEN -- ADELANTOSS JEJEJE 
        OPEN cursor FOR 
        
        select 
        	to_char(FEC_ASIENTO, 'DD/MM/YY') AS FECHA,
            COMENTARIO,
            COS_VALOR as valor
        from VW_CONTA_DIARIO
        where id_entidad = p_id_entidad
        and ID_CUENTAAASI = p_id_cuentaaasi
        and ID_CTACTE = p_id_ctacte
        and ID_MES = p_id_mes
        and ID_ANHO = p_id_anho
        AND NOT COMENTARIO LIKE 'APS%'
        AND HABER=0
        AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
        ;   
        /* 
     	SELECT  fec_pago AS fecha,
        	COMENTARIO ,
        	COS_VALOR AS valor
      	FROM VW_APS_PLANILLA vap 
		WHERE ID_ENTIDAD = p_id_entidad
		AND ID_ANHO = p_id_anho
		AND ID_MES = p_id_mes
		AND ID_PERSONA = p_id_persona
		AND ID_TIPOPLANILLA IN (98634);*/
		-- Reintegro de gastos
		
       
    ELSE  -- INFORMADOS
    
        OPEN cursor FOR 
        
		        SELECT to_char(A.fec_pago, 'DD/MM/YY') as fecha,
		        b.NOMBRE AS COMENTARIO,
		        A.COS_VALOR as valor FROM VW_APS_PLANILLA A 
		        INNER JOIN APS_CONCEPTO_PLANILLA B ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
				WHERE ID_ENTIDAD = p_id_entidad
				AND ID_ANHO = p_id_anho
				AND ID_MES = p_id_mes
				AND ID_PERSONA = p_id_persona
				AND ID_TIPOPLANILLA in (98634,106791) -- 
				AND ID_TIPOCONCEPTOAPS = p_tipo
				
				union
                select 
                to_char(FEC_ASIENTO, 'DD/MMYY') AS FECHA,
                    COMENTARIO,
                    ABS(COS_VALOR) as valor
                from VW_CONTA_DIARIO
                where id_entidad = p_id_entidad
                and ID_CUENTAAASI = p_id_cuentaaasi
                and ID_CTACTE = p_id_ctacte
                and ID_MES = p_id_mes
                and ID_ANHO = p_id_anho
                AND NOT COMENTARIO LIKE 'APS%'
                AND DEBE=0
                AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
                ;
    END IF;
    
    
      
  
END;

