-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_account_statement_sal_rt (
    p_id_entidad           int,
    p_id_entidad_assinet  int,
    p_id_anho           int,
    p_id_mes           int,
    p_id_persona       int,
    p_id_cta_cte       varchar2,
    cursor       OUT SYS_REFCURSOR
)
IS
    l_ingresos_total number(38,2);
   	l_ingresos number(38,2);
   	l_ingresos_ayudas number(38,2);
   
    l_descuentos_total number(38,2);
    l_descuentos number(38,2);
    l_descuentos_sueldo number(38,2);
    l_descuentos_adelantos number(38,2);
    l_descuentos_ayudas number(38,2);
   
    l_depositado number(38,2);
   	l_sueldo_depositado number(38,2);
   	l_ayudas_depositado number(38,2);
   
   	l_codigo_assinet varchar2(20):='';
   

BEGIN
	DELETE FROM TT_TABLE_AUX;
    l_ingresos_total:= 0;
    l_ingresos:= 0;
    l_ingresos_ayudas:= 0;
   
    l_descuentos:= 0;
    l_descuentos_adelantos:= 0;
    l_descuentos_ayudas:= 0;
    l_descuentos_total:= 0;
    l_descuentos_sueldo:= 0;
   
    l_depositado:= 0;
   	l_sueldo_depositado:= 0;
  	l_ayudas_depositado:= 0;
      
    SELECT MAX(CODIGO_ASSINET) INTO l_codigo_assinet
  	FROM moises.PERSONA_NATURAL pn WHERE ID_PERSONA = p_id_persona;

    select 
      nvl(sum(p.COS_VALOR),0) into l_ingresos
      from
      VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
      where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
      and p.ID_ENTIDAD=p_id_entidad
      and p.ID_ANHO=p_id_anho
      and p.ID_MES= p_id_mes
      and p.ID_PERSONA=p_id_persona
      and a.ID_TIPOCONCEPTOAPS NOT IN (100,200,85) ---
      and (
        P.ID_CONCEPTOAPS like '10%'
        or P.ID_CONCEPTOAPS like '11%'
        or P.ID_CONCEPTOAPS like '12%'
        or P.ID_CONCEPTOAPS like '13%'
        or P.ID_CONCEPTOAPS like '14%'
        or P.ID_CONCEPTOAPS like '2%'
        or P.ID_CONCEPTOAPS like '3%'
        or P.ID_CONCEPTOAPS like '7%'
        or P.ID_CONCEPTOAPS like '43%'
      )
      and not P.ID_CONCEPTOAPS like '7600%' 
      --AND ID_TIPOPLANILLA = 98626
      --AND ID_TIPOPLANILLA NOT IN (106791)
      AND ID_TIPOPLANILLA NOT IN (98628)
      AND p.FEC_SALIDA IS NULL;
      
	select 
    nvl(sum(p.COS_VALOR),0)  into l_descuentos_sueldo
    from
    VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
    where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
    and p.ID_ENTIDAD=p_id_entidad
    and p.ID_ANHO=p_id_anho
    and p.ID_MES= p_id_mes
    and p.ID_PERSONA=p_id_persona
    and (
      P.ID_CONCEPTOAPS like '15%'
      or P.ID_CONCEPTOAPS like '7600%'
      or P.ID_CONCEPTOAPS like '4556%'
    )
    and not P.ID_CONCEPTOAPS like '1552%'
    and not P.ID_CONCEPTOAPS like '1556%'
    -- and not P.ID_CONCEPTOAPS like '1557%'
    -- and not P.ID_CONCEPTOAPS like '1558%'
    ;

	select nvl(sum(COS_VALOR),0) into l_descuentos_adelantos from VW_CONTA_DIARIO
	where id_entidad = p_id_entidad
	and ID_CUENTAAASI in (1135001)
	and (ID_CTACTE = p_id_cta_cte OR ID_CTACTE = l_codigo_assinet)
	and ID_MES = p_id_mes
	and ID_ANHO = p_id_anho
	AND NOT COMENTARIO LIKE 'APS%'
    AND HABER=0;


------------------------ AYUDAS INFORMADOS------------------------
	SELECT abs(nvl(sum(valor),0)) into l_ingresos_ayudas FROM (
	SELECT A.COS_VALOR as valor FROM VW_APS_PLANILLA A 
    INNER JOIN APS_CONCEPTO_PLANILLA B ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
	WHERE ID_ENTIDAD = p_id_entidad
	AND ID_ANHO = p_id_anho
	AND ID_MES = p_id_mes
	AND ID_PERSONA = p_id_persona
	AND ID_TIPOPLANILLA IN (98634) -- Reintegro de gastos
	AND ID_TIPOCONCEPTOAPS in ('100','85')
	union
    select 
        abs(COS_VALOR) valor
    from eliseo.VW_CONTA_DIARIO
    where id_entidad = p_id_entidad_assinet
    and ID_CUENTAAASI in (1135005)
    and (ID_CTACTE = p_id_cta_cte OR ID_CTACTE = l_codigo_assinet)
    and ID_MES = p_id_mes
    and ID_ANHO = p_id_anho
    AND NOT COMENTARIO LIKE 'APS%'
    AND DEBE=0
    ) X ;

	-- Descuentos AYUDAS
	
	select nvl(sum(COS_VALOR),0) into l_descuentos_ayudas from VW_CONTA_DIARIO
	where id_entidad = p_id_entidad_assinet
	and ID_CUENTAAASI in (1135005)
	and (ID_CTACTE = p_id_cta_cte OR ID_CTACTE = l_codigo_assinet)
	and ID_MES = p_id_mes
	and ID_ANHO = p_id_anho
	AND NOT COMENTARIO LIKE 'APS%'
    AND HABER=0;
	-----------------------------------------------------------------
	

	l_descuentos_total := l_descuentos_sueldo + l_descuentos_adelantos + l_descuentos_ayudas;
	l_ingresos_total := l_ingresos + l_ingresos_ayudas;
	l_depositado := l_ingresos_total - l_descuentos_total;
	l_sueldo_depositado := l_ingresos - (l_descuentos_sueldo + l_descuentos_adelantos);
	l_ayudas_depositado := l_ingresos_ayudas - l_descuentos_ayudas;
	l_descuentos := l_descuentos_sueldo + l_descuentos_adelantos;
    
	DBMS_OUTPUT.PUT_LINE('l_sueldo_depositado');
    DBMS_OUTPUT.PUT_LINE(l_sueldo_depositado);
    INSERT INTO TT_TABLE_AUX(NUM_1, NUM_2, NUM_3, NUM_4) 
    VALUES(l_sueldo_depositado, l_descuentos_ayudas, 0,0);
 
   
    OPEN cursor FOR 
    SELECT 
     	l_ingresos AS ingresos,
      	l_descuentos AS descuentos,
      	l_sueldo_depositado AS sueldo_depositado,
      	
      	l_ingresos_ayudas AS ingresos_ayudas,
      	l_descuentos_ayudas AS descuentos_ayudas,
      	l_ayudas_depositado AS ayudas_depositado,
      	
      	l_ingresos_total AS ingresos_total,
      	l_descuentos_total AS descuentos_total,
      	l_depositado AS depositado
    from dual;
  
END;

