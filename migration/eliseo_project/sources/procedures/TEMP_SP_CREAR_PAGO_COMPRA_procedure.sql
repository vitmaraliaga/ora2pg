-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE TEMP_SP_CREAR_PAGO_COMPRA(P_ID_PAGO NUMBER,P_ID_DINAMICA NUMBER,P_ID_PROVEEDOR NUMBER,P_ID_COMPRA NUMBER, P_IMPORTE NUMBER,P_IMPORTE_ME NUMBER, P_ID_PAGO_COMPRA IN OUT NUMBER, P_ERROR out NUMBER, P_MSGERROR out VARCHAR2) IS
        l_id_pcompra number := 0;
        l_contar number;
        l_error number:=0;
        l_msgerror varchar2(200):='';
        L_ID_PERSONA number :=null;
        L_IMPORTE_SALDO number(10,2);
        L_IMPORTE_SALDO_ME number(10,2);

        L_ID_TIPOORIGEN number := 8;
    
        L_IMPORTE_PAGADO number(10,2);
        L_IMPORTE_PAGADO_ME number(10,2);
        L_PROVEEDOR VARCHAR2(200);
        --L_CORRELATIVO NUMBER;
        L_DETALLE VARCHAR2(80);
        L_ID_MONEDA NUMBER;
        L_TIPOCAMBIO NUMBER;
        
        L_IMPORTE NUMBER;
        L_ID_COMPRA NUMBER :=NULL;
        L_ID_SALDO NUMBER :=NULL;
        L_DOC VARCHAR2(40);
    
        BEGIN
        
            --- CADA VEZ QUE SE ACTUALIZE O SE AGREGUE ALGO DE DETALLE AL PAGO EL PAGO AUTOMATICAMENTE SE PONE EN ESTADO 0
             UPDATE ELISEO.CAJA_PAGO SET ESTADO='0' WHERE ID_PAGO=P_ID_PAGO;
            ---
            
            l_error:=0;
            if l_error=0 then
                null;
                
                
                SELECT COUNT(1) INTO l_contar FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;
                IF l_contar = 0 THEN
                    L_ID_SALDO := P_ID_COMPRA;
                ELSE
                    L_ID_COMPRA := P_ID_COMPRA;
                END IF;
                SELECT SUBSTR(FC_NOMBRE_PERSONA(P_ID_PROVEEDOR),1,100) PROVEEDOR INTO L_PROVEEDOR
                FROM DUAL;
                
                SELECT DISTINCT DECODE(ID_COMPROBANTE,'01','FAC:','03','BOL:','02','RH:','DOC:')||SERIE||'-'||NUMERO INTO L_DOC
                FROM VW_PURCHASES_MOV
                WHERE ID_COMPRA = P_ID_COMPRA
                AND ID_PROVEEDOR = P_ID_PROVEEDOR;
                
                SELECT 
                SUBSTR((CASE ID_ENTIDAD 
                WHEN 7124 
                THEN ID_ENTIDAD||'-'||L_DOC||'-'||SUBSTR(L_PROVEEDOR,1,20)||'-'||DECODE(ID_MEDIOPAGO,'001','TLC','007','CHQ','008','EFEC')||'-'||TO_NUMBER(NUMERO)||'-'||TO_CHAR(FECHA,'DD/MM/YYYY')
                --THEN DECODE(ID_MEDIOPAGO,'001','TLC','007','CHQ','008','EFEC')||'-'||NUMERO||'-'||TO_CHAR(FECHA,'DD/MM/YYYY')||'-'||PKG_CAJA.FC_CUENTA_BANCARIA(ID_CTABANCARIA)||'-'||L_PROVEEDOR
                ELSE 
                -- TO_CHAR(FECHA,'DD/MM/YYYY')||'-'||DECODE(ID_MEDIOPAGO,'001','TLC','007','CHQ','008','EFEC')||'-'||NUMERO||'-'||PKG_CAJA.FC_CUENTA_BANCARIA(ID_CTABANCARIA)
                DECODE(ID_MEDIOPAGO,'001','TLC','007','CHQ','008','EFEC')||'-'||NUMERO||' | '||TO_CHAR(FECHA,'DD/MM/YYYY')||' | '||PKG_CAJA.FC_CUENTA_BANCARIA(ID_CTABANCARIA)
                END ),1,80) AS GLOSA, ID_MONEDA, TIPOCAMBIO INTO L_DETALLE, L_ID_MONEDA, L_TIPOCAMBIO
                FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
                
                SELECT NVL(IMPORTE,0),NVL(IMPORTE_ME,0) INTO L_IMPORTE_SALDO,L_IMPORTE_SALDO_ME
                FROM VW_PURCHASES_SALDO
                WHERE ID_COMPRA = P_ID_COMPRA
                AND ID_PROVEEDOR = P_ID_PROVEEDOR;
                   DBMS_OUTPUT.put_line(P_ID_PAGO_COMPRA);
                IF P_ID_PAGO_COMPRA <> 0 THEN -- UPDATE
                    -- ELIMINAR CONTA_ASIENTO
                    SELECT ID_TIPOORIGEN INTO L_ID_TIPOORIGEN FROM CAJA_PAGO_COMPRA WHERE ID_PCOMPRA=P_ID_PAGO_COMPRA; 
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN=P_ID_PAGO_COMPRA;
                
                    SELECT NVL(IMPORTE,0), NVL(IMPORTE_ME,0) INTO L_IMPORTE_PAGADO, L_IMPORTE_PAGADO_ME FROM CAJA_PAGO_COMPRA WHERE ID_PCOMPRA = P_ID_PAGO_COMPRA;
                    
                    IF L_ID_MONEDA = '7' THEN -- Soles
                        IF NVL(P_IMPORTE,0) > (NVL(L_IMPORTE_SALDO,0)+NVL(L_IMPORTE_PAGADO,0)) THEN
                            l_error := 1;
                            l_msgerror:='El importe en soles, es mayor al saldo del documento.'||ABS(NVL(P_IMPORTE,0)-(NVL(L_IMPORTE_SALDO,0)+NVL(L_IMPORTE_PAGADO,0)));
                            l_id_pcompra := P_ID_PAGO_COMPRA;
                        END IF;
                        L_IMPORTE := P_IMPORTE;
                    ELSE 
                        IF NVL(P_IMPORTE_ME,0) > (NVL(L_IMPORTE_SALDO_ME,0)+NVL(L_IMPORTE_PAGADO_ME,0)) THEN
                            l_error := 1;
                            l_msgerror:='El importe en moneda extranjera, es mayor al saldo del documento.';
                            l_id_pcompra := P_ID_PAGO_COMPRA;
                        END IF;
                        --L_IMPORTE := (P_IMPORTE_ME * L_TIPOCAMBIO);
                        L_IMPORTE := P_IMPORTE;
                    END IF;
                    
                    IF l_error = 0 THEN
                        UPDATE CAJA_PAGO_COMPRA
                            SET ID_DINAMICA = P_ID_DINAMICA, 
                            IMPORTE = L_IMPORTE, IMPORTE_ME = P_IMPORTE_ME
                        WHERE ID_PCOMPRA=P_ID_PAGO_COMPRA;
                        
                        
                        l_id_pcompra := P_ID_PAGO_COMPRA;

                        --SELECT IMPORTE_ME INTO L_IMPORTE  FROM CAJA_PAGO_COMPRA WHERE ID_PCOMPRA=P_ID_PAGO_COMPRA;
                        --l_msgerror := L_IMPORTE;
                        --l_error:=1;
                    END IF;
                    
                ELSE 
                    
                    IF NVL(P_IMPORTE,0)+NVL(P_IMPORTE_ME,0) > 0 THEN
                    
                        IF L_ID_MONEDA = '7' THEN -- Soles
                            IF NVL(P_IMPORTE,0) > NVL(L_IMPORTE_SALDO,0) THEN
                                
                                IF (NVL(P_IMPORTE,0)-NVL(L_IMPORTE_SALDO,0)) >= 0.02 THEN 
                                    l_error := 1;
                                    l_msgerror:='El importe en soles, es mayor al saldo del documento.' ||NVL(P_IMPORTE,0)||NVL(L_IMPORTE_SALDO,0);
                                    l_id_pcompra := P_ID_PAGO_COMPRA;
                                END IF;
                            END IF;
                            L_IMPORTE := P_IMPORTE;
                        ELSE 
                            IF NVL(P_IMPORTE_ME,0) > NVL(L_IMPORTE_SALDO_ME,0) THEN
                                l_error := 1;
                                l_msgerror:='El importe en moneda extranjera, es mayor al saldo del documento.';
                                l_id_pcompra := P_ID_PAGO_COMPRA;
                            END IF;
                            --L_IMPORTE := (P_IMPORTE_ME * L_TIPOCAMBIO);
                            L_IMPORTE := P_IMPORTE;
                        END IF;

                       IF l_error = 0 THEN
                            SELECT COALESCE(MAX(ID_PCOMPRA),0)+1 into l_id_pcompra FROM CAJA_PAGO_COMPRA;
                            --SELECT DECODE(ID_MEDIOPAGO,'001',9,'007',8,'008',7) INTO L_ID_TIPOORIGEN FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
                            INSERT INTO CAJA_PAGO_COMPRA(
                                ID_PCOMPRA,
                                ID_PAGO,
                                ID_PROVEEDOR,
                                ID_COMPRA,
                                ID_DINAMICA,
                                --ID_TIPOORIGEN,
                                IMPORTE,
                                IMPORTE_ME,
                                DETALLE,
                                ID_SALDO
                            )values(
                                l_id_pcompra,
                                P_ID_PAGO,
                                P_ID_PROVEEDOR,
                                L_ID_COMPRA,
                                P_ID_DINAMICA,
                                --L_ID_TIPOORIGEN,
                                L_IMPORTE,
                                P_IMPORTE_ME,
                                SUBSTR(L_DETALLE,1,80),
                                L_ID_SALDO
                            );
                            
                            
                            l_msgerror:='El pago se agregó con éxito.';
                        END IF;
                        
                    ELSE
                        l_error := 1;
                        l_msgerror:='No existen importes';
                    END IF;
                END IF;
                
            end if;  
            
        P_ERROR:=l_error;
        P_ID_PAGO_COMPRA:=l_id_pcompra;
        P_MSGERROR:=l_msgerror;
    END TEMP_SP_CREAR_PAGO_COMPRA;

