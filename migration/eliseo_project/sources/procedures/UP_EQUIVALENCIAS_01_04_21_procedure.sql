-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        UP_EQUIVALENCIAS_01_04_21 AS
L_ID_RESTRICION VARCHAR2(50);
L_ID_TIPOPLAN NUMBER(22,0);
L_COUNT NUMBER;
BEGIN
    /*
	FOR ITEM IN (
		SELECT T1.CODE_AASSI,T1.ID_CUENTAEMPRESARIAL_AASSI,T2.ID_CUENTAEMPRESARIAL_LAMB 
		FROM (SELECT DISTINCT ID_CUENTAAASI AS CODE_AASSI,ID_CUENTAEMPRESARIAL AS ID_CUENTAEMPRESARIAL_AASSI 
		FROM AAA_CONTA_EMPRESA_CTA_ASSINET aceca) T1
		LEFT JOIN 
		(SELECT DISTINCT ID_CUENTAAASI AS CODE_LAMB,ID_CUENTAEMPRESARIAL AS ID_CUENTAEMPRESARIAL_LAMB
		FROM CONTA_EMPRESA_CTA cec
		WHERE ID_EMPRESA =207 AND ID_ANHO = 2020)T2 ON T2.CODE_LAMB=T1.CODE_AASSI
		WHERE T1.ID_CUENTAEMPRESARIAL_AASSI<>T2.ID_CUENTAEMPRESARIAL_LAMB
		ORDER BY T1.CODE_AASSI)
	LOOP
	    UPDATE CONTA_EMPRESA_CTA  SET ID_CUENTAEMPRESARIAL =ITEM.ID_CUENTAEMPRESARIAL_AASSI
	    WHERE ID_CUENTAAASI=ITEM.CODE_AASSI AND ID_CUENTAEMPRESARIAL=ITEM.ID_CUENTAEMPRESARIAL_LAMB;
	END LOOP;
		*/
		 
	FOR ITEM IN (
		SELECT * FROM (SELECT ID_CUENTAEMPRESARIAL AS CODE_AASSI,COUNT(ID_CUENTAAASI) AS CANT_AASSI FROM
			(SELECT DISTINCT ID_CUENTAEMPRESARIAL,ID_CUENTAAASI 
			FROM AAA_CONTA_EMPRESA_CTA_ASSINET) GROUP BY ID_CUENTAEMPRESARIAL) T1
		LEFT JOIN 
		(SELECT ID_CUENTAEMPRESARIAL AS CODE_LAMB,COUNT(ID_CUENTAAASI) AS CANT_LAMB FROM (SELECT DISTINCT ID_CUENTAEMPRESARIAL,ID_CUENTAAASI
		FROM CONTA_EMPRESA_CTA cec
		WHERE ID_EMPRESA =207 AND ID_ANHO = 2020)GROUP BY ID_CUENTAEMPRESARIAL)T2 ON T2.CODE_LAMB=T1.CODE_AASSI
		WHERE T1.CANT_AASSI<>T2.CANT_LAMB
		ORDER BY T1.CODE_AASSI)
	LOOP
		-- AGREGAR EQUIVALENCIAS QUE NO ESTAN EN LAMB
		SELECT COUNT(1) INTO L_COUNT FROM (SELECT DISTINCT ID_CUENTAEMPRESARIAL,ID_CUENTAAASI
				FROM AAA_CONTA_EMPRESA_CTA_ASSINET aceca
				WHERE ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI
				AND ID_CUENTAAASI NOT IN (
				SELECT DISTINCT ID_CUENTAAASI
				FROM CONTA_EMPRESA_CTA cec
				WHERE ID_EMPRESA =207 AND ID_ANHO = 2020 AND ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI));
		IF L_COUNT>0 THEN 
			FOR ITEM1 IN (
				SELECT DISTINCT ID_CUENTAEMPRESARIAL,ID_CUENTAAASI
				FROM AAA_CONTA_EMPRESA_CTA_ASSINET aceca
				WHERE ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI
				AND ID_CUENTAAASI NOT IN (
				SELECT DISTINCT ID_CUENTAAASI
				FROM CONTA_EMPRESA_CTA cec
				WHERE ID_EMPRESA =207 AND ID_ANHO = 2020 AND ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI))
			LOOP
				SELECT ID_RESTRICCION,ID_TIPOPLAN INTO L_ID_RESTRICION,L_ID_TIPOPLAN FROM CONTA_CTA_DENOMINACIONAL ccd WHERE ID_CUENTAAASI =ITEM1.ID_CUENTAAASI;
				IF L_ID_RESTRICION IS NOT NULL AND L_ID_TIPOPLAN IS NOT NULL THEN
			    	INSERT INTO CONTA_EMPRESA_CTA (ID_ANHO,ID_CUENTAAASI,ID_CUENTAEMPRESARIAL,ID_EMPRESA,ID_MONEDA,ID_RESTRICCION,ID_TIPOPLAN)
			    	VALUES (2020,ITEM1.ID_CUENTAAASI,ITEM.CODE_AASSI,207,7,L_ID_RESTRICION,L_ID_TIPOPLAN);
				END IF;
			END LOOP;
		END IF;
		-- ELIMINAR EQUIVALENCIAS QUE NO ESTAN EN EL ASSINET
		SELECT COUNT(1) INTO L_COUNT FROM (SELECT DISTINCT ID_CUENTAEMPRESARIAL,ID_CUENTAAASI
				FROM CONTA_EMPRESA_CTA cec
				WHERE ID_EMPRESA =207 AND ID_ANHO = 2020 AND ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI
				AND ID_CUENTAAASI NOT IN (SELECT DISTINCT ID_CUENTAAASI
				FROM AAA_CONTA_EMPRESA_CTA_ASSINET aceca
				WHERE ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI));
		IF L_COUNT>0 THEN 
			FOR ITEM1 IN (
				SELECT DISTINCT ID_CUENTAEMPRESARIAL,ID_CUENTAAASI
				FROM CONTA_EMPRESA_CTA cec
				WHERE ID_EMPRESA =207 AND ID_ANHO = 2020 AND ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI
				AND ID_CUENTAAASI NOT IN (SELECT DISTINCT ID_CUENTAAASI
				FROM AAA_CONTA_EMPRESA_CTA_ASSINET aceca
				WHERE ID_CUENTAEMPRESARIAL=ITEM.CODE_AASSI))
			LOOP
				INSERT INTO AAA_DELETES_EQUIVALENCIAS SELECT * FROM CONTA_EMPRESA_CTA WHERE ID_ANHO =2020 
				AND ID_CUENTAEMPRESARIAL=ITEM1.ID_CUENTAEMPRESARIAL 
				AND ID_CUENTAAASI=ITEM1.ID_CUENTAAASI
				AND ID_EMPRESA =207;
				/*DELETE FROM CONTA_EMPRESA_CTA 
				WHERE ID_ANHO =2020 
				AND ID_CUENTAEMPRESARIAL=ITEM1.ID_CUENTAEMPRESARIAL 
				AND ID_CUENTAAASI=ITEM1.ID_CUENTAAASI
				AND ID_EMPRESA =207;*/
			END LOOP;
		END IF;
	END LOOP;
    
END;

