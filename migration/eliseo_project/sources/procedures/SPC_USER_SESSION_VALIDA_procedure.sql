-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_user_session_valida (
    p_token       varchar2,
    cursor       OUT SYS_REFCURSOR
)
IS
    l_id_user INTEGER :=0;  
   l_id_empresa INTEGER;
    l_id_entidad INTEGER;
    l_id_depto varchar2(10);
    l_id_institucion INTEGER;
    l_id_anho_activo INTEGER;
   	l_id_mes_activo INTEGER;
    l_id_moneda_activa INTEGER;
    l_cant INT;
    l_id_almacen INTEGER;
    l_email varchar2(50):='';
    l_token_oauth varchar2(100):='';
    pp_token varchar2(100):='';
BEGIN
	
	select max(token) into l_token_oauth
    from USERS_SESSION where token_oauth = p_token and status = '1';
	
	IF l_token_oauth IS NOT null THEN
		pp_token:= l_token_oauth;
	ELSE
		pp_token:= p_token;
	END IF;

    update USERS_SESSION set LAST_UPDATE = current_timestamp where token = pp_token and status = '1';
    
    --select nvl(max(ID_USER),0) into l_id_user from USERS_SESSION where token = p_token and status = '1';
    
    select count(ID_USER) into l_cant
    from USERS_SESSION where token = pp_token and status = '1';
    
    IF l_cant > 0 THEN
        select ID_USER,id_entidad,id_depto into l_id_user,l_id_entidad,l_id_depto
        from USERS_SESSION where token = pp_token and status = '1';
        select email into l_email from users where id=l_id_user;
       
       	SELECT max(ID_INSTITUCION) INTO l_id_institucion FROM JOSE.SCHOOL_INSTITUCION
       	WHERE ID_CAMPO = l_id_entidad AND ID_DEPTO =l_id_depto;
        
        SELECT COUNT(1) INTO l_cant FROM LAMB_MODULO M 
        WHERE M.ID_MODULO = 129
        AND NOT EXISTS (SELECT 1 FROM LAMB_ENTIDAD_DEPTO_CONFIG T 
                        WHERE T.ID_MODULO = M.ID_MODULO 
                        AND T.ID = l_id_user 
                        AND T.id_entidad = l_id_entidad 
                        AND T.id_depto = l_id_depto
                        );
        
        IF l_cant > 0 THEN
            PKG_SETUP.SP_ASSIGN_THEMES(l_id_user,l_id_entidad,l_id_depto);
        END IF;

       
       	IF l_id_entidad IS NOT NULL THEN 
	      	SELECT max(ID_EMPRESA) INTO l_id_empresa FROM CONTA_ENTIDAD WHERE ID_ENTIDAD = l_id_entidad;
       	
	        SELECT decode(MAX(ID_ANHO), TO_CHAR(SYSDATE,'YYYY'), MAX(ID_ANHO), 0), MAX(id_moneda)
	        INTO l_id_anho_activo, l_id_moneda_activa
		    FROM CONTA_ENTIDAD_ANHO_CONFIG
		    WHERE ID_ENTIDAD = l_id_entidad
		    AND ACTIVO = '1';
		    
		    IF l_id_anho_activo IS NOT NULL AND l_id_anho_activo<>0 THEN 
		    	SELECT decode(MAX(ID_MES), TO_NUMBER(TO_CHAR(SYSDATE,'MM')), max(id_mes),0)
		    		INTO l_id_mes_activo
		        FROM CONTA_ENTIDAD_MES_CONFIG
		        WHERE ID_ENTIDAD = l_id_entidad
		        AND ID_ANHO = l_id_anho_activo
		        AND ESTADO = '1';
		    END IF;
		END IF;
    END IF;





        
    OPEN cursor FOR 
    select decode(l_id_user,0,'NO','SI') as active, l_id_user as id_user,
    l_id_empresa AS id_empresa,
    l_id_entidad as id_entidad,
   	l_id_depto as id_depto,l_email as email,
   	l_id_institucion AS id_institucion,
   	l_id_anho_activo as id_anho_activo,
   	l_id_mes_activo as id_mes_activo,
   	l_id_moneda_activa AS id_moneda_activa
    from dual;
END;

