-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE SP_AUX_CREAR_VOUCHER(P_ID_ENTIDAD INT,P_ID_DEPTO VARCHAR2,P_ID_ANHO INT,P_ID_MES INT,P_FECHA DATE, P_ID_TIPOASIENTO VARCHAR2,P_ID_TIPOVOUCHER number,P_ID_SEAT_PARENT number,P_ACTIVO VARCHAR2, P_ID_PERSONA NUMBER, P_ID_VOUCHER out number) IS
        l_vou_id number;	
        l_cont number;			 				 
        l_nrovoucher number;

        l_automatico varchar2(4);

        -- DATOS DEL CONFIG PARENT
        l_id_tipovoucher_child number;
        l_id_tipoasiento_child varchar2(10);
        l_cantidad_child number := 0;
        l_id_voucher_child number;

        l_fecha date := sysdate; 
        BEGIN
            l_cont := 0;

            l_fecha := coalesce(P_FECHA, sysdate);

            SELECT 
            AUTOMATICO INTO l_automatico
            FROM CONTA_VOUCHER_CONFIG
            WHERE ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_DEPTO = P_ID_DEPTO
            AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
            AND ID_ANHO = P_ID_ANHO
            AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER;

            IF l_automatico = 'N' THEN -- SI EL VOUCHER NO ES AUTOMATICO SE CREAN TODOS LOS QUE SEAN NECESARIOS
                SELECT nvl(max(NUMERO),0)+1 INTO l_nrovoucher
                FROM CONTA_VOUCHER
                WHERE ID_ENTIDAD = P_ID_ENTIDAD 
                AND ID_DEPTO = P_ID_DEPTO 
                AND ID_ANHO = P_ID_ANHO
                AND ID_MES = P_ID_MES
                AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
                AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER;                

                SELECT nvl(max(ID_VOUCHER),0)+1 INTO l_vou_id
                FROM CONTA_VOUCHER;

                P_ID_VOUCHER := l_vou_id;

                INSERT INTO CONTA_VOUCHER(	
                                            ID_VOUCHER, 
                                            ID_ENTIDAD, 
											ID_DEPTO, 
											ID_ANHO, 
											ID_MES, 
											ID_TIPOASIENTO,
                                            ID_TIPOVOUCHER,
                                            NUMERO,
											FECHA, 
											ACTIVO,
											ID_PERSONA,
                                            ID_VOUCHER_PARENT
										  )VALUES (
										    l_vou_id,
											P_ID_ENTIDAD,
											P_ID_DEPTO,
											P_ID_ANHO,
											P_ID_MES,
											P_ID_TIPOASIENTO,
                                            P_ID_TIPOVOUCHER,
                                            l_nrovoucher,
											P_FECHA,
											P_ACTIVO,
                                            P_ID_PERSONA,
                                            P_ID_SEAT_PARENT
										  );

            ELSE -- EL SI VOUCHER ES AUTOMATICO SE CREA UNO POR DIA, CON LA PRIMERA OPCION
                SELECT COUNT(ID_VOUCHER) INTO l_cont
                FROM CONTA_VOUCHER 
                WHERE ID_ENTIDAD = P_ID_ENTIDAD 
                AND ID_DEPTO = P_ID_DEPTO 
                AND ID_ANHO = P_ID_ANHO
                AND ID_MES = P_ID_MES
                AND ID_TIPOASIENTO = P_ID_TIPOASIENTO       
                AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER              
                AND to_char(FECHA,'YYYYDDMM') = to_char(l_fecha,'YYYYDDMM');

                IF l_cont = 0 THEN

                    SELECT nvl(max(NUMERO),0)+1 INTO l_nrovoucher
                    FROM CONTA_VOUCHER
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD 
                    AND ID_DEPTO = P_ID_DEPTO 
                    AND ID_ANHO = P_ID_ANHO
                    AND ID_MES = P_ID_MES
                    AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
                    AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER;


                    SELECT nvl(max(ID_VOUCHER),0)+1 INTO l_vou_id
                    FROM CONTA_VOUCHER;

                    P_ID_VOUCHER := l_vou_id;

                    INSERT INTO CONTA_VOUCHER(	
                                                ID_VOUCHER, 
                                                ID_ENTIDAD, 
                                                ID_DEPTO, 
                                                ID_ANHO, 
                                                ID_MES, 
                                                ID_TIPOASIENTO,
                                                ID_TIPOVOUCHER,
                                                NUMERO,
                                                FECHA, 
                                                ACTIVO,
                                                ID_PERSONA,
                                               ID_VOUCHER_PARENT 
                                              )VALUES (
                                                l_vou_id,
                                                P_ID_ENTIDAD,
                                                P_ID_DEPTO,
                                                P_ID_ANHO,
                                                P_ID_MES,
                                                P_ID_TIPOASIENTO,
                                                P_ID_TIPOVOUCHER,
                                                l_nrovoucher,
                                                l_fecha,
                                                P_ACTIVO,
                                                P_ID_PERSONA,
                                                P_ID_SEAT_PARENT
                                              );	
                ELSE

                    SELECT ID_VOUCHER INTO l_vou_id
                    FROM CONTA_VOUCHER 
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD 
                    AND ID_DEPTO = P_ID_DEPTO 
                    AND ID_ANHO = P_ID_ANHO
                    AND ID_MES = P_ID_MES
                    AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
                    AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER
                    AND to_char(FECHA,'YYYYDDMM') = to_char(l_fecha,'YYYYDDMM');

                    P_ID_VOUCHER := l_vou_id;

                END IF;
            END IF;

			-- SI EL VOUCHER_CONFIG TIENE UN HIJO, TAMBIEN LO CREAMOS SU HIJO
			IF P_ID_ENTIDAD <> 7124 THEN
                SELECT COUNT(1) INTO l_cantidad_child
                FROM CONTA_VOUCHER_CONFIG
                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                AND ID_DEPTO = P_ID_DEPTO
                AND ID_ANHO = P_ID_ANHO
                AND ID_TIPOASIENTO_PARENT = P_ID_TIPOASIENTO;

                IF l_cantidad_child = 1 THEN
                    SELECT ID_TIPOASIENTO, ID_TIPOVOUCHER
                        INTO l_id_tipoasiento_child, l_id_tipovoucher_child
                    FROM CONTA_VOUCHER_CONFIG
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD
                    AND ID_DEPTO = P_ID_DEPTO
                    AND ID_ANHO = P_ID_ANHO
                    AND ID_TIPOASIENTO_PARENT = P_ID_TIPOASIENTO;
                    -- AGREGAR HIJO
                    PKG_ACCOUNTING.SP_CREAR_VOUCHER(P_ID_ENTIDAD, P_ID_DEPTO, P_ID_ANHO, P_ID_MES, P_FECHA, l_id_tipoasiento_child,  l_id_tipovoucher_child,
                    NULL, P_ACTIVO, P_ID_PERSONA, l_id_voucher_child);

                    -- UPDATE CHILD
                    UPDATE CONTA_VOUCHER
                    SET  ID_VOUCHER_PARENT = P_ID_VOUCHER
                    WHERE ID_VOUCHER = l_id_voucher_child;

                END IF;
            END IF;

    END SP_AUX_CREAR_VOUCHER;

