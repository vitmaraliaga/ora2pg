-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

DROP TRIGGER IF EXISTS conta_dinamica_log ON conta_dinamica CASCADE;
CREATE OR REPLACE FUNCTION eliseo.trigger_fct_conta_dinamica_log() RETURNS trigger AS $BODY$
DECLARE
  action  VARCHAR2(2):='-';
  columna tablastring;
  anterior tablastring;
  actual tablastring;
  desc_id varchar(120);
  tabla_id varchar(120);
  persona int;
  ip varchar2(20);
  tabla varchar2(50);
BEGIN

  tabla:='CONTA_DINAMICA';
  desc_id:='ID_DINAMICA';
  
  --tablastring ACEPTA 150 CARACTERES POR ITEMS Y ES DE TIPO STRING Y SE DEBE CONVERTIR CAMPOS NUMERICOS Y FECHA CON TO_CHAR
  IF INSERTING THEN
    action := 'I';
    tabla_id:=to_char(:NEW.ID_DINAMICA);
    columna:=tablastring('ID_DINAMICA');
    anterior:=tablastring(tabla_id);
    actual:=tablastring(tabla_id);
  ELSIF UPDATING THEN
    action := 'U';
  ELSIF DELETING THEN
    action := 'D';
  END IF;
  
  --IF UPDATING OR DELETING THEN
  IF UPDATING THEN
    tabla_id:=to_char(:OLD.ID_DINAMICA);
    columna:=tablastring('ID_DEPTO','ID_ANHO','ID_MODULO','ID_TIPOIGV','NOMBRE','IMPORTE','FECHA','ACTIVO');
    anterior:=tablastring(:OLD.ID_DEPTO,TO_CHAR(:OLD.ID_ANHO),TO_CHAR(:OLD.ID_MODULO),:OLD.ID_TIPOIGV,:OLD.NOMBRE,TO_CHAR(:OLD.IMPORTE),TO_CHAR(:OLD.FECHA),:OLD.ACTIVO);
    actual:=  tablastring(:NEW.ID_DEPTO,TO_CHAR(:NEW.ID_ANHO),TO_CHAR(:NEW.ID_MODULO),:NEW.ID_TIPOIGV,:NEW.NOMBRE,TO_CHAR(:NEW.IMPORTE),TO_CHAR(:NEW.FECHA),:NEW.ACTIVO);
  END IF;
  
  IF action<>'-' THEN
     persona := 0;
     if UPDATING('ID_PERSONA') then
        persona := :NEW.id_persona;
     end if;
     
     ip := '';
     if UPDATING('IP') then
        ip := :NEW.ip;
     end if;
     
     sp_audit_tabla( tabla, desc_id,tabla_id,persona,ip,action,columna,anterior,actual);
  END IF;
  
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION eliseo.trigger_fct_conta_dinamica_log() FROM PUBLIC;

DROP TRIGGER IF EXISTS conta_dinamica_log ON conta_dinamica;
CREATE TRIGGER conta_dinamica_log
	AFTER INSERT OR UPDATE ON conta_dinamica 
 FOR EACH ROW
	EXECUTE PROCEDURE eliseo.trigger_fct_conta_dinamica_log();

