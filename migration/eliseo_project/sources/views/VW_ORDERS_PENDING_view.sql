-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_orders_pending (id_entidad, id_depto, id_anho, id_mes, id_pedido, id_persona, pid_pedido, id_tipopedido, nombre_tipopedido, id_actividad, nombre_actividad, id_areaorigen, nombre_areaorigen, id_areadestino, nombre_areadestino, numero, acuerdo, codigo, fecha_pedido, fecha_entrega, motivo, estado_porcentaje, accion, revisado, id_paso_actual, estado, estado_run, llave, llave_nombre, estado_pedido, id_registro, fecha_registro, usuario, id_departamento_origen, tipo_articulo) AS SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.ID_PEDIDO,
          A.ID_PERSONA,
          'P' || A.NUMERO AS PID_PEDIDO,
          A.ID_TIPOPEDIDO,
         -- PKG_ORDERS.FC_NOMBRE_TIPOPEDIDO (A.ID_TIPOPEDIDO) AS NOMBRE_PEDIDO,
          (SELECT NVL(X.NOMBRE,'') AS NOMBRE_PEDIDO FROM TIPO_PEDIDO X WHERE X.ID_TIPOPEDIDO = A.ID_TIPOPEDIDO) AS NOMBRE_PEDIDO,
          A.ID_ACTIVIDAD,
         -- PKG_ORDERS.FC_NOMBRE_ACTIVIDAD (A.ID_ACTIVIDAD) AS NOMBRE_ACTIVIDAD,
          (SELECT NVL(X.NOMBRE,'') AS NOMBRE_ACTIVIDAD FROM PSTO_ACTIVIDAD X WHERE X.ID_ACTIVIDAD = A.ID_ACTIVIDAD) AS NOMBRE_ACTIVIDAD,
          A.ID_AREAORIGEN,
          --PKG_ORDERS.FC_NOMBRE_AREA (A.ID_AREAORIGEN) NOMBRE_AREAORIGEN,
          (SELECT  NVL(Y.ID_DEPTO||' - '||X.NOMBRE ,'') AS AREA FROM ORG_AREA X, ORG_SEDE_AREA Y WHERE X.ID_AREA = Y.ID_AREA AND Y.ID_SEDEAREA = A.ID_AREAORIGEN) AS NOMBRE_AREAORIGEN,
          A.ID_AREADESTINO,
          --PKG_ORDERS.FC_NOMBRE_AREA (A.ID_AREADESTINO) NOMBRE_AREADESTINO,
          (SELECT  NVL(Y.ID_DEPTO||' - '||X.NOMBRE ,'') AS AREA FROM ORG_AREA X, ORG_SEDE_AREA Y WHERE X.ID_AREA = Y.ID_AREA AND Y.ID_SEDEAREA = A.ID_AREADESTINO) AS NOMBRE_AREADESTINO,
          A.NUMERO,
          A.ACUERDO,
          C.CODIGO,
          TO_CHAR (A.FECHA_PEDIDO, 'YYYY-MM-DD') AS FECHA_PEDIDO,
          TO_CHAR (A.FECHA_ENTREGA, 'YYYY-MM-DD') AS FECHA_ENTREGA,
          A.MOTIVO,
          (CASE --FC_LLAVE_PROCESO_PREVIOUS (B.ID_REGISTRO)
            (SELECT 
                        FC_GET_LLAVE_COMPONENTE(A.ID_REGISTRO,A.ID_PASO,1)-- INTO L_LLAVE
                FROM PROCESS_PASO_RUN A, PROCESS_PASO C
                WHERE A.ID_PASO = C.ID_PASO
                AND A.ID_REGISTRO = B.ID_REGISTRO
                AND C.ID_TIPOPASO = 2
                AND A.ID_DETALLE = (SELECT MAX(ID_DETALLE) FROM PROCESS_PASO_RUN WHERE ID_REGISTRO = B.ID_REGISTRO AND ESTADO = '1'))
              WHEN 'FORP' THEN '25'
              WHEN 'FOCP' THEN '50'
              WHEN 'FOAP' THEN '75'
              ELSE '100'
           END)
             AS ESTADO_PORCENTAJE,
          --FC_GET_LLAVE_COMPONENTE (B.ID_REGISTRO, B.ID_PASO_ACTUAL, '0') AS ACCION,
          ( SELECT PROCESS_COMPONENTE.LLAVE AS ACCION FROM PROCESS_PASO_RUN INNER JOIN PROCESS_COMPONENTE_PASO
            ON PROCESS_PASO_RUN.ID_PASO=PROCESS_COMPONENTE_PASO.ID_PASO
            INNER JOIN PROCESS_COMPONENTE ON PROCESS_COMPONENTE_PASO.ID_COMPONENTE=PROCESS_COMPONENTE.ID_COMPONENTE
            WHERE PROCESS_PASO_RUN.ID_REGISTRO=B.ID_REGISTRO AND PROCESS_PASO_RUN.ID_PASO=B.ID_PASO_ACTUAL  AND PROCESS_PASO_RUN.ESTADO='0' AND ROWNUM<=1 ) AS ACCION,
          (SELECT MAX(X.REVISADO)
             FROM PROCESS_PASO_RUN X
            WHERE     X.ID_REGISTRO = B.ID_REGISTRO
                  AND X.ID_PASO = B.ID_PASO_ACTUAL
                  AND X.ESTADO = '0')
             AS REVISADO,
          B.ID_PASO_ACTUAL,
          A.ESTADO,
          B.ESTADO AS ESTADO_RUN,
          FC_LLAVE_PROCESO (B.ID_REGISTRO) AS LLAVE,
          (CASE --FC_GET_LLAVE_COMPONENTE (B.ID_REGISTRO, B.ID_PASO_ACTUAL,'0')
                ( SELECT PROCESS_COMPONENTE.LLAVE AS ACCION FROM PROCESS_PASO_RUN INNER JOIN PROCESS_COMPONENTE_PASO
    ON PROCESS_PASO_RUN.ID_PASO=PROCESS_COMPONENTE_PASO.ID_PASO
    INNER JOIN PROCESS_COMPONENTE ON PROCESS_COMPONENTE_PASO.ID_COMPONENTE=PROCESS_COMPONENTE.ID_COMPONENTE
  WHERE PROCESS_PASO_RUN.ID_REGISTRO=B.ID_REGISTRO AND PROCESS_PASO_RUN.ID_PASO=B.ID_PASO_ACTUAL  AND PROCESS_PASO_RUN.ESTADO='0' AND ROWNUM<=1 )
              WHEN 'FPP3' THEN 'PRE-PROVISION'
              WHEN 'FPC' THEN 'PEDIDO-COMPRA'
              WHEN 'FPP2' THEN 'PRE-PROVISION'
              WHEN 'FRA' THEN 'REQUERIMIENTO'
              WHEN 'FPPA' THEN 'PRE-PROVISION-ALMACEN'
              WHEN 'FOC' THEN 'ORDEN-COMPRA'
              WHEN 'FPPP' THEN 'PRE-PROVISION-PLANTILLA'
              WHEN 'FOC2' THEN 'ORDEN-COMPRA'
              WHEN 'FPP' THEN 'PRE-PROVISION'
              ELSE NULL
           END)
             AS LLAVE_NOMBRE,
          (SELECT X.NOMBRE
             FROM PROCESS_PASO X
            WHERE X.ID_PASO = B.ID_PASO_ACTUAL)
             AS ESTADO_PEDIDO,
          B.ID_REGISTRO,
          A.FECHA_PEDIDO AS FECHA_REGISTRO,
          D.EMAIL,
          (SELECT B.ID_DEPTO AS AREA
             FROM ORG_AREA A, ORG_SEDE_AREA B
            WHERE A.ID_AREA = B.ID_AREA AND B.ID_SEDEAREA = A.ID_AREAORIGEN)
             AS ID_DEPARTAMENTO,
             (CASE WHEN A.ID_AREADESTINO = 45 THEN
            (SELECT DISTINCT PKG_INVENTORIES.FC_ARTICULO(X.ID_ARTICULO) FROM PEDIDO_DETALLE X WHERE X.ID_PEDIDO = A.ID_PEDIDO AND FC_CODIGO_ARTICULO_CODIGO(X.ID_ARTICULO,A.ID_ANHO) = '32-001')||'|'||
            (SELECT DISTINCT PKG_INVENTORIES.FC_ARTICULO(X.ID_ARTICULO) FROM PEDIDO_DETALLE X WHERE X.ID_PEDIDO = A.ID_PEDIDO AND FC_CODIGO_ARTICULO_CODIGO(X.ID_ARTICULO,A.ID_ANHO) = '32-002')||'|'||
            (SELECT DISTINCT PKG_INVENTORIES.FC_ARTICULO(X.ID_ARTICULO) FROM PEDIDO_DETALLE X WHERE X.ID_PEDIDO = A.ID_PEDIDO AND FC_CODIGO_ARTICULO_CODIGO(X.ID_ARTICULO,A.ID_ANHO) = '32-003')
            ELSE '' END) AS TIPO_ARTICULO
FROM PEDIDO_REGISTRO A JOIN PROCESS_RUN B
ON A.ID_PEDIDO = B.ID_OPERACION
JOIN PROCESS C
ON B.ID_PROCESO = C.ID_PROCESO
JOIN USERS D
ON  A.ID_PERSONA = D.ID;

