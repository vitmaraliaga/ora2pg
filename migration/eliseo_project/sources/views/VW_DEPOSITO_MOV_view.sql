-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_deposito_mov (id_deposito, id_entidad, id_depto, id_anho, id_mes, serie_deposito, numero_deposito, id_cliente, id_transferencia, id_comprobante, id_moneda, fecha, glosa, total, total_me, id_tipotransaccion, tipo, dc) AS SELECT A.ID_DEPOSITO,
    	  A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.SERIE AS SERIE_DEPOSITO,
          A.NUMERO AS NUMERO_DEPOSITO,
          A.ID_CLIENTE,
          C.ID_TRANSFERENCIA,
          '99' AS ID_COMPROBANTE,
          A.ID_MONEDA,
          A.FECHA,
          A.GLOSA,
          B.IMPORTE,
          B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION,
          --C.ID_TIPOVENTA,
          'T' AS TIPO,
          C.DC
    FROM CAJA_DEPOSITO A
    INNER JOIN CAJA_DEPOSITO_DETALLE B ON A.ID_DEPOSITO = B.ID_DEPOSITO 
    INNER JOIN VENTA_TRANSFERENCIA_DETALLE C ON C.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
    INNER JOIN ELISEO.VENTA_TRANSFERENCIA D ON D.ID_TRANSFERENCIA = C.ID_TRANSFERENCIA 
    WHERE A.ESTADO = '1' AND B.IMPORTE <> 0
    AND D.ES_ANTICIPO = 'S'
    AND C.DC = 'D'
    UNION ALL
      SELECT D.ID_DEPOSITO,
    	  B.ID_ENTIDAD,
          B.ID_DEPTO,
          B.ID_ANHO,
          B.ID_MES,
          D.SERIE AS SERIE_DEPOSITO,
          D.NUMERO AS NUMERO_DEPOSITO,
          D.ID_CLIENTE,
          A.ID_TRANSFERENCIA,
          '99' AS ID_COMPROBANTE,
          D.ID_MONEDA,
          D.FECHA,
          D.GLOSA,
          A.IMPORTE,
          A.IMPORTE_ME,
          D.ID_TIPOTRANSACCION,
          --C.ID_TIPOVENTA,
          'T' AS TIPO,
          A.DC
    FROM VENTA_TRANSFERENCIA_DETALLE A
    INNER JOIN VENTA_TRANSFERENCIA B ON B.ID_TRANSFERENCIA = A.ID_TRANSFERENCIA 
    --INNER JOIN CAJA_DEPOSITO_DETALLE C ON B.ID_TRANSFERENCIA = C.ID_TRANSFERENCIA AND C.ID_DEPOSITO = B.ID_DEPOSITO
    -- INNER JOIN CAJA_DEPOSITO_DETALLE C ON  C.ID_DEPOSITO = B.ID_DEPOSITO -- AND C.ID_TRANSFERENCIA IS NOT NULL /* cambio: AND C.ID_TRANSFERENCIA IS NOT NULL */
    -- INNER JOIN CAJA_DEPOSITO D ON D.ID_DEPOSITO = C.ID_DEPOSITO 
    INNER JOIN CAJA_DEPOSITO D ON D.ID_DEPOSITO = B.ID_DEPOSITO 
    WHERE D.ESTADO = '1' AND A.IMPORTE <> 0
    AND A.DC = 'C';

