-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iu_depto_child () AS $body$
DECLARE


l_contar integer:=0;


  PARENTS RECORD;
  DEPTOS RECORD;

BEGIN
	DELETE FROM ELISEO.DEPTO_CHILD;
	FOR PARENTS IN (SELECT ID_DEPTO,ID_ENTIDAD FROM CONTA_ENTIDAD_DEPTO WHERE ES_GRUPO=1
		GROUP BY ID_ENTIDAD,ID_DEPTO)
	LOOP
		FOR DEPTOS IN (SELECT ID_DEPTO 
			FROM (WITH RECURSIVE cte AS (
SELECT  ID_PARENT,ID_DEPTO,ES_GRUPO,1 as level
	    	FROM (SELECT ID_DEPTO ,ID_PARENT,ES_GRUPO 
	    	FROM ELISEO.CONTA_ENTIDAD_DEPTO
	    	WHERE ID_ENTIDAD =PARENTS.ID_ENTIDAD) alias1  WHERE ID_PARENT= PARENTS.ID_DEPTO
  UNION ALL
SELECT  ID_PARENT,ID_DEPTO,ES_GRUPO,(c.level+1)
	    	FROM (SELECT ID_DEPTO ,ID_PARENT,ES_GRUPO 
	    	FROM ELISEO.CONTA_ENTIDAD_DEPTO
	    	WHERE ID_ENTIDAD =PARENTS.ID_ENTIDAD) JOIN cte c ON (c.ID_DEPTO = ID_PARENT)

) SELECT * FROM cte 
	    	GROUP BY ID_PARENT, ID_DEPTO,ES_GRUPO,LEVEL) alias2 
    		WHERE ES_GRUPO=0) 
		LOOP

			INSERT INTO DEPTO_CHILD(ID_PARENT,ID_DEPTO,ID_ENTIDAD) VALUES (PARENTS.ID_DEPTO,DEPTOS.ID_DEPTO,PARENTS.ID_ENTIDAD);

		END LOOP DEPTOS;
	END LOOP PARENTS;
 end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iu_depto_child () FROM PUBLIC;

