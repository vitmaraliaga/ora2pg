-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.spc_account_statement_data ( p_id_entidad integer, p_id_anho integer, p_id_mes integer, p_id_persona integer, p_id_cta_cte text, OUT CURSOR REFCURSOR ) AS $body$
DECLARE


    l_ingresos decimal(38,2);
    l_descuentos decimal(38,2);
    l_descuentos_adelantos decimal(38,2);
    l_descuentos_ayudas decimal(38,2);
    l_descuentos_viajes decimal(38,2);
    l_sueldo_depositado decimal(38,2);

    l_adelanto_ayudas decimal(38,2);
    l_adelanto_gratificaciones decimal(38,2);
    l_a_rendir decimal(38,2);

    l_adelanto_ayudas_c decimal(38,2);
    l_adelanto_gratificaciones_c decimal(38,2);
    l_a_rendir_c decimal(38,2);

    l_descuento_extraordinario decimal(38,2);


BEGIN
    DELETE FROM TT_TABLE_AUX;
    l_ingresos:= 0;
    l_descuentos:= 0;
    l_descuentos_adelantos:= 0;
    l_descuentos_ayudas:= 0;
    l_descuentos_viajes:= 0;
    l_sueldo_depositado:= 0;
    l_adelanto_ayudas:= 0;
    l_adelanto_gratificaciones:= 0;
    l_a_rendir:= 0;
    l_descuento_extraordinario := 0;

    select coalesce(sum(COS_VALOR),0) into STRICT l_descuento_extraordinario from VW_CONTA_DIARIO
          where ID_CUENTAAASI = '2135001'
          and id_entidad = 17112
          and ID_ANHO = 2017
          and ID_MES = 7
          and ID_TIPOASIENTO = 'MI'
          and COD_AASI = 3
          and id_entidad = p_id_entidad
          and ID_ANHO = p_id_anho
          and id_mes = p_id_mes
          and ID_CTACTE = p_id_cta_cte;

    select 
      coalesce(sum(p.COS_VALOR),0) into STRICT l_ingresos
      from
      VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
      where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
      and p.ID_ENTIDAD=p_id_entidad
      and p.ID_ANHO=p_id_anho
      and p.ID_MES= p_id_mes
      and p.ID_PERSONA=p_id_persona
      and (
        P.ID_CONCEPTOAPS like '10%'
        or P.ID_CONCEPTOAPS like '11%'
        or P.ID_CONCEPTOAPS like '12%'
        or P.ID_CONCEPTOAPS like '13%'
        or P.ID_CONCEPTOAPS like '14%'
        or P.ID_CONCEPTOAPS like '2%'
        or P.ID_CONCEPTOAPS like '3%'
        or P.ID_CONCEPTOAPS like '7%'
      )
      and not P.ID_CONCEPTOAPS like '7600%'  
      --AND ID_TIPOPLANILLA NOT IN (106791)
      AND ID_TIPOPLANILLA NOT IN (98628)  
;

select 
                coalesce(sum(p.COS_VALOR),0)  into STRICT l_descuentos
                from
                VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
                where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
                and p.ID_ENTIDAD=p_id_entidad
                and p.ID_ANHO=p_id_anho
                and p.ID_MES= p_id_mes
                and p.ID_PERSONA=p_id_persona
                and (
                  P.ID_CONCEPTOAPS like '15%'
                  or P.ID_CONCEPTOAPS like '7600%'
                )
                and not P.ID_CONCEPTOAPS like '1552%'
                and not P.ID_CONCEPTOAPS like '1556%'
                and not P.ID_CONCEPTOAPS like '1557%'
                and not P.ID_CONCEPTOAPS like '1558%'
;


select coalesce(sum(COS_VALOR),0) into STRICT l_descuentos_adelantos from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135001
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
and not ID_TIPOASIENTO = 'RH'

--and FEC_ASIENTO between (
--select nvl(max(FEC_ASIENTO),to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')) from VW_CONTA_DIARIO
--where id_entidad = p_id_entidad
--and ID_CUENTAAASI = 1135001
--and ID_CTACTE = p_id_cta_cte
--and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') - interval '1' month
--and ID_TIPOASIENTO = 'RH')
--and 
--(
--select nvl(max(FEC_ASIENTO),(to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') + interval '1' month - interval '1' day)) from VW_CONTA_DIARIO
--where id_entidad = p_id_entidad
--and ID_CUENTAAASI = 1135001
--and ID_CTACTE = p_id_cta_cte
--and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')
--and ID_TIPOASIENTO = 'RH')
;

select coalesce(sum(COS_VALOR),0) into STRICT l_descuentos_ayudas from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135005
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
and not ID_TIPOASIENTO = 'RH'
--and FEC_ASIENTO between (
--select nvl(max(FEC_ASIENTO),to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')) from VW_CONTA_DIARIO
--where id_entidad = p_id_entidad
--and ID_CUENTAAASI = 1135005
--and ID_CTACTE = p_id_cta_cte
--and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') - interval '1' month
--and ID_TIPOASIENTO = 'RH')
--and 
--(
--select nvl(max(FEC_ASIENTO),(to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') + interval '1' month - interval '1' day)) from VW_CONTA_DIARIO
--where id_entidad = p_id_entidad
--and ID_CUENTAAASI = 1135005
--and ID_CTACTE = p_id_cta_cte
--and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')
--and ID_TIPOASIENTO = 'RH')
;
select coalesce(sum(COS_VALOR),0) into STRICT l_descuentos_viajes from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135010
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
and not ID_TIPOASIENTO = 'RH'
--and FEC_ASIENTO between (
--select nvl(max(FEC_ASIENTO),to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')) from VW_CONTA_DIARIO
--where id_entidad = p_id_entidad
--and ID_CUENTAAASI = 1135010
--and ID_CTACTE = p_id_cta_cte
--and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') - interval '1' month
--and ID_TIPOASIENTO = 'RH')
--and 
--(
--select nvl(max(FEC_ASIENTO),(to_date(p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm') + interval '1' month - interval '1' day)) from VW_CONTA_DIARIO
--where id_entidad = p_id_entidad
--and ID_CUENTAAASI = 1135010
--and ID_CTACTE = p_id_cta_cte
--and to_date(ID_ANHO||lpad(id_mes,2,'0'),'yyyymm') = to_date (p_id_anho||lpad(p_id_mes,2,'0'),'yyyymm')
--and ID_TIPOASIENTO = 'RH')
;

    select coalesce(sum(COS_VALOR),0), count(*) into STRICT l_adelanto_ayudas, l_adelanto_ayudas_c from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135060
    and ID_CTACTE = p_id_cta_cte
    and ID_MES <= p_id_mes
    and ID_ANHO = p_id_anho
;
    select coalesce(sum(COS_VALOR),0), count(*) into STRICT l_adelanto_gratificaciones, l_adelanto_gratificaciones_c from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135016
    and ID_CTACTE = p_id_cta_cte
    and ID_MES <= p_id_mes
    and ID_ANHO = p_id_anho
;
    select coalesce(sum(COS_VALOR),0), count(*) into STRICT l_a_rendir, l_a_rendir_c from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135007
    and ID_CTACTE = p_id_cta_cte
    and ID_MES <= p_id_mes
    and ID_ANHO = p_id_anho
;

    RAISE NOTICE 'l_ingresos';
    RAISE NOTICE '%', l_ingresos;

    RAISE NOTICE 'l_descuentos';
    RAISE NOTICE '%', l_descuentos;

    RAISE NOTICE 'l_descuentos_ayudas';
    RAISE NOTICE '%', l_descuentos_ayudas;

    RAISE NOTICE 'l_descuentos_viajes';
    RAISE NOTICE '%', l_descuentos_viajes;


    l_sueldo_depositado := l_ingresos - (l_descuentos + l_descuento_extraordinario + l_descuentos_ayudas + l_descuentos_viajes+ l_descuentos_adelantos);
    RAISE NOTICE 'l_sueldo_depositado';
    RAISE NOTICE '%', l_sueldo_depositado;
    INSERT INTO TT_TABLE_AUX(NUM_1, NUM_2, NUM_3, NUM_4)
    VALUES (l_sueldo_depositado, l_adelanto_ayudas, l_adelanto_gratificaciones,l_a_rendir);

    OPEN CURSOR FOR 
    SELECT 
      l_sueldo_depositado as sueldo_depositado,
      l_adelanto_ayudas as adelanto_ayudas,
      l_adelanto_gratificaciones as adelanto_gratificaciones,
      l_a_rendir as a_rendir,
      l_adelanto_ayudas_c as adelanto_ayudas_c,
      l_adelanto_gratificaciones_c as adelanto_gratificaciones_c,
      l_a_rendir_c as a_rendir_c
     
;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.spc_account_statement_data ( p_id_entidad integer, p_id_anho integer, p_id_mes integer, p_id_persona integer, p_id_cta_cte text, OUT CURSOR REFCURSOR ) FROM PUBLIC;

