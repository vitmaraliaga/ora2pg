-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.spc_profile_worker_tipo ( p_id_persona integer, p_tipo integer, OUT CURSOR REFCURSOR ) AS $body$
DECLARE


    l_ID_ENTIDAD decimal(38,2);
    l_ID_ANHO decimal(38,2);
    l_ID_MES decimal(38,2);
    l_ID_TIPOESTATUS decimal(38,2);
    l_ID_SISTEMAPENSION decimal(38,2);
    l_ES_MISIONERO decimal(38,2);
    l_NOM_CARGO varchar(50);
    l_FMR decimal(38,2);
    l_TIPO_STATUS varchar(100);
    l_SISTEMA_PENSION varchar(100);
    l_ANHOS_SERVICIO decimal(38,2);



BEGIN
    select 
    p.ID_ENTIDAD, 
    p.ID_ANHO,
    p.ID_MES,
    p.ID_TIPOESTATUS,
    p.ID_SISTEMAPENSION,
    p.ES_MISIONERO,
    p.NOM_CARGO,
    p.FMR
    INTO STRICT 
    l_ID_ENTIDAD,
    l_ID_ANHO,
    l_ID_MES,
    l_ID_TIPOESTATUS,
    l_ID_SISTEMAPENSION,
    l_ES_MISIONERO,
    l_NOM_CARGO,
    l_FMR
    from APS_PLANILLA p
          where p.id_persona = p_id_persona
          and to_date(p.id_anho||lpad(p.id_mes,2,'0'),'yyyymm') = (
          SELECT max(to_date(pp.id_anho||lpad(pp.id_mes,2,'0'),'yyyymm')) from APS_PLANILLA pp
          where pp.id_persona = p_id_persona
          ) 
;

    SELECT NOMBRE INTO STRICT l_TIPO_STATUS FROM TIPO_ESTATUS
    WHERE ID_TIPOESTATUS = l_ID_TIPOESTATUS;

    SELECT NOMBRE INTO STRICT l_SISTEMA_PENSION FROM APS_SISTEMA_PENSION
    WHERE ID_SISTEMAPENSION = l_ID_SISTEMAPENSION;

    SELECT (clock_timestamp() - MIN(FEC_INICIO))/ 365.242199 INTO STRICT l_ANHOS_SERVICIO FROM APS_EMPLEADO
    WHERE ID_PERSONA = p_id_persona;

    OPEN CURSOR FOR
    SELECT 
    l_ID_ENTIDAD AS ID_ENTIDAD,
    l_ID_ANHO AS ID_ANHO,
    l_ID_MES AS ID_MES,
    l_NOM_CARGO AS NOM_CARGO,
    l_ES_MISIONERO AS ES_MISIONERO,
    l_FMR AS PUNTAJE,
    l_TIPO_STATUS AS TIPO_STATUS,
    l_SISTEMA_PENSION AS SISTEMA_PENSION,
    l_ANHOS_SERVICIO AS ANHOS_SERVICIO
;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.spc_profile_worker_tipo ( p_id_persona integer, p_tipo integer, OUT CURSOR REFCURSOR ) FROM PUBLIC;

