-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.sp_anular_saldo_reg (P_ID_SALDO bigint, P_ID_PERSONA bigint, P_MOTIVO text, P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE


        L_ACTIVO varchar(1);
        L_ID_VOUCHER_SALDO bigint;


BEGIN
	        -- VALIDAR SI EL VOUCHER EST√Å CONTABILIZADO
	        L_ACTIVO := 'S';

            SELECT V.ACTIVO INTO STRICT L_ACTIVO FROM VENTA_SALDO D
            INNER JOIN CONTA_VOUCHER V ON D.ID_VOUCHER = V.ID_VOUCHER 
            WHERE D.ID_SALDO = P_ID_SALDO;

            IF L_ACTIVO = 'S' THEN

                SELECT ID_VOUCHER INTO STRICT L_ID_VOUCHER_SALDO
                FROM VENTA_SALDO vs
                WHERE ID_SALDO = P_ID_SALDO;

                --UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                DELETE FROM CONTA_ASIENTO
                WHERE ID_TIPOORIGEN = 2
                AND ID_ORIGEN = P_ID_SALDO
                AND VOUCHER = L_ID_VOUCHER_SALDO;

                --UPDATE VENTA_SALDO SET TOTAL = 0, TOTAL_ME = 0, DETALLE = '<< Anulado >>'
                DELETE FROM VENTA_SALDO
                WHERE ID_SALDO = P_ID_SALDO;

                P_ERROR := 0;
                P_MSGERROR := 'OK: Anulado con Exito';
            ELSE
                P_ERROR := 1;
                P_MSGERROR := 'El Voucher ya esta CONTABILIZADO';
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.sp_anular_saldo_reg (P_ID_SALDO bigint, P_ID_PERSONA bigint, P_MOTIVO text, P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;

