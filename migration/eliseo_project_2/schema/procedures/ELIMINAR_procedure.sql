-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.eliminar ( P_Modo integer, P_NUM_DOCUMENTO text, P_ID_TIPODOCUMENTO integer, P_NOMBRE text, P_PATERNO text, P_MATERNO text, P_ID_ESTADOCIVIL integer, P_ID_TIPOTRATAMIENTO integer, P_ID_PAIS integer, P_ID_NACIONALIDAD integer, P_ID_TIPOSANGRE integer, P_SEXO text, P_FEC_NACIMIENTO text, P_FEC_DEFUNCION text, P_ID_PERSONA OUT integer ) AS $body$
DECLARE

  S_ID_PERSONANATURAL integer;
  S_ID_PERSONADOCUMENTO integer;
  S_NUM_DOCUMENTO varchar(100);
  S_ID_PAIS integer;
  S_ID_NACIONALIDAD integer;

BEGIN
	P_ID_PERSONA := 0;
	S_ID_PERSONANATURAL := 0;
	S_ID_PERSONADOCUMENTO := 0;
	S_NUM_DOCUMENTO := NULLIF(trim(both P_NUM_DOCUMENTO),'');

  
	IF P_Modo = 0 THEN
	
	
	SELECT coalesce(
				(SELECT  
					      coalesce(Persona.ID_PERSONA, 0)
					    FROM PERSONA
					    LEFT JOIN Persona_Natural ON
					      Persona.ID_PERSONA = Persona_Natural.ID_PERSONA
					    LEFT JOIN Persona_Documento ON
					      Persona.ID_PERSONA = Persona_Documento.ID_PERSONA
					    WHERE Persona_Documento.NUM_DOCUMENTO = S_NUM_DOCUMENTO)
				,0) INTO STRICT P_ID_PERSONA;
	SELECT coalesce(
				(SELECT
					      coalesce(Persona_Natural.ID_PERSONA, 0)
					    FROM PERSONA
					    LEFT JOIN Persona_Natural ON
					      Persona.ID_PERSONA = Persona_Natural.ID_PERSONA
					    LEFT JOIN Persona_Documento ON
					      Persona.ID_PERSONA = Persona_Documento.ID_PERSONA
					    WHERE Persona_Documento.NUM_DOCUMENTO = S_NUM_DOCUMENTO)
				,0) INTO STRICT S_ID_PERSONANATURAL;
	SELECT coalesce(
				(SELECT
					      coalesce(Persona_Documento.ID_PERSONA, 0)
					    FROM PERSONA
					    LEFT JOIN Persona_Natural ON
					      Persona.ID_PERSONA = Persona_Natural.ID_PERSONA
					    LEFT JOIN Persona_Documento ON
					      Persona.ID_PERSONA = Persona_Documento.ID_PERSONA
					    WHERE Persona_Documento.NUM_DOCUMENTO = S_NUM_DOCUMENTO)
				,0) INTO STRICT S_ID_PERSONADOCUMENTO;
	
	    IF P_ID_PERSONA <= 0 THEN
	    
	      IF NOT coalesce(S_NUM_DOCUMENTO::text, '') = '' THEN
	        SELECT MAX(ID_PERSONA) INTO STRICT P_ID_PERSONA FROM Persona;
	        P_ID_PERSONA := coalesce(P_ID_PERSONA, 0) + 1;
	
	        INSERT INTO Persona(ID_PERSONA, NOMBRE, PATERNO, MATERNO)
	          VALUES (P_ID_PERSONA, P_NOMBRE, P_PATERNO, P_MATERNO);
	      ELSE
		      UPDATE Persona SET
		        NOMBRE  = P_NOMBRE,
		        PATERNO = P_PATERNO,
		        MATERNO = P_MATERNO
		      WHERE ID_PERSONA = P_ID_PERSONA;
	      END IF;
	
	      IF S_ID_PERSONADOCUMENTO = 0 AND NOT coalesce(S_NUM_DOCUMENTO::text, '') = '' THEN 
			      INSERT INTO Persona_Documento(ID_PERSONA, ID_TIPODOCUMENTO, NUM_DOCUMENTO, IMG_DOCUMENTO)
			        VALUES (P_ID_PERSONA, P_ID_TIPODOCUMENTO, S_NUM_DOCUMENTO, NULL);
	      END IF;
	
	      IF P_ID_PAIS > 1000 THEN
      		SELECT
	        ID_TIPOPAIS INTO STRICT S_ID_PAIS
	      FROM Tipo_Pais
	      WHERE COD_SUNAT = P_ID_PAIS;
	      END IF;
	
	      IF S_ID_NACIONALIDAD > 1000 THEN
			SELECT
			  ID_TIPOPAIS INTO STRICT S_ID_NACIONALIDAD
			FROM Tipo_Pais
			WHERE COD_SUNAT = P_ID_NACIONALIDAD;
	      END IF;
	
	      
		IF S_ID_PERSONANATURAL = 0 THEN
		      IF P_ID_PERSONA > 0  THEN 
		      	INSERT INTO Persona_Natural(ID_PERSONA, ID_TIPOESTADOCIVIL, ID_TIPOTRATAMIENTO, ID_TIPOPAIS, ID_NACIONALIDAD, ID_TIPOSANGRE, SEXO, FEC_NACIMIENTO, FEC_DEFUNCION)
		        VALUES (P_ID_PERSONA, P_ID_ESTADOCIVIL, coalesce(P_ID_TIPOTRATAMIENTO, 1), NULLIF(P_ID_PAIS, 0), NULLIF(P_ID_NACIONALIDAD, 0), NULLIF(P_ID_TIPOSANGRE, 0), P_SEXO, to_date(P_FEC_NACIMIENTO,'yyyy-mm-dd'), to_date(P_FEC_DEFUNCION,'yyyy-mm-dd"T"HH24:MI:SS'));
		      END IF;
	      ELSE
		      UPDATE Persona_Natural SET
		        ID_TIPOESTADOCIVIL     = coalesce(NULLIF(P_ID_ESTADOCIVIL, 0), ID_TIPOESTADOCIVIL),
		        ID_TIPOTRATAMIENTO = coalesce(NULLIF(P_ID_TIPOTRATAMIENTO, 0), ID_TIPOTRATAMIENTO),
		        ID_TIPOPAIS            = coalesce(NULLIF(P_ID_PAIS, 0), ID_TIPOPAIS),
		        ID_NACIONALIDAD    = coalesce(NULLIF(P_ID_NACIONALIDAD, 0), ID_NACIONALIDAD),
		        ID_TIPOSANGRE      = coalesce(NULLIF(P_ID_TIPOSANGRE, 0), ID_TIPOSANGRE),
		        SEXO               = coalesce(P_SEXO, SEXO),
		        FEC_NACIMIENTO     = to_date(P_FEC_NACIMIENTO,'yyyy-mm-dd'),
		        FEC_DEFUNCION      = to_date(P_FEC_DEFUNCION,'yyyy-mm-dd')
		      WHERE ID_PERSONA = P_ID_PERSONA;
		   END IF;
	    END IF;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.eliminar ( P_Modo integer, P_NUM_DOCUMENTO text, P_ID_TIPODOCUMENTO integer, P_NOMBRE text, P_PATERNO text, P_MATERNO text, P_ID_ESTADOCIVIL integer, P_ID_TIPOTRATAMIENTO integer, P_ID_PAIS integer, P_ID_NACIONALIDAD integer, P_ID_TIPOSANGRE integer, P_SEXO text, P_FEC_NACIMIENTO text, P_FEC_DEFUNCION text, P_ID_PERSONA OUT integer ) FROM PUBLIC;

