-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_asist_marcaciones_interno ( v_ICODUSUARIO bigint, v_ID_ENTIDAD bigint, v_FECHA timestamp(0), v_HORARIOENTRADA timestamp(0), v_HORARIOSALIDA timestamp(0), v_INICIOREFRIGERIO timestamp(0), v_FINREFRIGERIO timestamp(0) ) AS $body$
DECLARE

  v_Id_Persona  numeric(38);
  l_Id_Entidad  numeric(38);
  v_Result  bigint;
  v_Mensaje varchar(255);
  v_Extra   varchar(255);

BEGIN
  v_Result  := -1;
  v_Mensaje := 'Mensaje.';
  v_Extra   := 'Extra.';
  DECLARE
    v_temp smallint := 0;
  BEGIN
    v_Result := 0;
    SELECT
					      max(coalesce(Persona.ID_PERSONA, 0)) into STRICT v_Id_Persona
					    FROM PERSONA
					    LEFT JOIN Persona_Natural ON
					      Persona.ID_PERSONA = Persona_Natural.ID_PERSONA
					    LEFT JOIN Persona_Documento ON
					      Persona.ID_PERSONA = Persona_Documento.ID_PERSONA
					    WHERE Persona_Documento.NUM_DOCUMENTO = v_ICODUSUARIO;
    select max(id_entidad) into STRICT l_Id_Entidad from vw_aps_empleado
    where id_persona = v_Id_Persona
    and v_FECHA between fec_inicio and coalesce(fec_termino, to_date('2030-12-31','yyyy-mm-dd')) 
;
    BEGIN
      SELECT 1
      INTO STRICT v_temp
      
      WHERE NOT EXISTS (SELECT *
        FROM APS_ASIST_MARCACIONES_INTERNO
        WHERE ID_PERSONA = v_Id_Persona
        AND ID_ENTIDAD    = v_ID_ENTIDAD
        AND FECHA         = v_FECHA 
         LIMIT 1);
    EXCEPTION
    WHEN OTHERS THEN
      NULL;
    END;
    IF v_temp = 1 THEN
      BEGIN
        INSERT
        INTO APS_ASIST_MARCACIONES_INTERNO(
            ID_PERSONA,
            ID_ENTIDAD,
            FECHA,
            HORARIOENTRADA,
            HORARIOSALIDA,
            INICIOREFRIGERIO,
            FINREFRIGERIO
          )
          VALUES (
            v_Id_Persona,
            l_Id_Entidad,
            v_FECHA,
            v_HORARIOENTRADA,
            v_HORARIOSALIDA,
            v_INICIOREFRIGERIO,
            v_FINREFRIGERIO
          );
      END;
    ELSE
      BEGIN
        UPDATE APS_ASIST_MARCACIONES_INTERNO
        SET HORARIOENTRADA = v_HORARIOENTRADA,
          HORARIOSALIDA    = v_HORARIOSALIDA,
          INICIOREFRIGERIO = v_INICIOREFRIGERIO,
          FINREFRIGERIO    = v_FINREFRIGERIO
        WHERE ID_PERSONA  = v_Id_Persona
        AND ID_ENTIDAD     = v_ID_ENTIDAD
        AND FECHA          = v_FECHA;--SELECT CODIGO = @Result, MENSAJE = @Mensaje, EXTRA = @Extra
      END;
    END IF;
  END;
EXCEPTION
WHEN OTHERS THEN
  CALL utils.handleerror(SQLSTATE,SQLERRM);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_asist_marcaciones_interno ( v_ICODUSUARIO bigint, v_ID_ENTIDAD bigint, v_FECHA timestamp(0), v_HORARIOENTRADA timestamp(0), v_HORARIOSALIDA timestamp(0), v_INICIOREFRIGERIO timestamp(0), v_FINREFRIGERIO timestamp(0) ) FROM PUBLIC;

