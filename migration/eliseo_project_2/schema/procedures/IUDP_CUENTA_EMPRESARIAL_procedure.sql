-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_cuenta_empresarial ( p_Modo bigint, p_ID_ENTIDAD bigint, p_ID_TIPOPLAN bigint, p_ID_CUENTAAASI text, p_ID_ANHO bigint, p_ID_CUENTAEMPRESARIAL text, p_NOMBRE text) AS $body$
DECLARE

  v_ID_EMPRESA bigint;v_ID_RESTRICCION bigint;v_ID_PARENT varchar(10);
  v_count_ID_PARENT bigint := 0;
  v_count_ID_CUENTAEMPRESARIAL bigint := 0;
  v_count_ID_ANHO bigint := 0;
  v_count_ID_CUENTAAASI bigint := 0;

BEGIN

  IF p_Modo = 0
  THEN
    select CASE WHEN LENGTH(RTRIM(p_ID_CUENTAEMPRESARIAL)) > 2 THEN SUBSTR(p_ID_CUENTAEMPRESARIAL, 1, LENGTH(RTRIM(p_ID_CUENTAEMPRESARIAL)) - 1) ELSE '' END
    into STRICT v_ID_PARENT
;

    SELECT count(ID_CUENTAEMPRESARIAL) into STRICT v_count_ID_PARENT FROM CONTA_CTA_EMPRESARIAL WHERE ID_CUENTAEMPRESARIAL = v_ID_PARENT  LIMIT 1;
    SELECT count(ID_CUENTAEMPRESARIAL) into STRICT v_count_ID_CUENTAEMPRESARIAL FROM CONTA_CTA_EMPRESARIAL WHERE ID_CUENTAEMPRESARIAL = p_ID_CUENTAEMPRESARIAL  LIMIT 1;

    IF coalesce(v_ID_PARENT, '') <> '' AND v_count_ID_PARENT = 0 THEN
      CALL iudp_Cuenta_Empresarial( 0, p_ID_ENTIDAD, p_ID_TIPOPLAN, NULL, p_ID_ANHO, v_ID_PARENT, p_NOMBRE);
    END IF;
    IF v_count_ID_CUENTAEMPRESARIAL = 0  THEN
      INSERT INTO CONTA_CTA_EMPRESARIAL(ID_CUENTAEMPRESARIAL, ID_PARENT, NOMBRE) -- , ES_GRUPO
        VALUES (p_ID_CUENTAEMPRESARIAL, NULL, p_NOMBRE);
    ELSE
      UPDATE CONTA_CTA_EMPRESARIAL SET
        NOMBRE = p_NOMBRE
      WHERE ID_CUENTAEMPRESARIAL = p_ID_CUENTAEMPRESARIAL;
    END IF;

    -- UPDATE CONTA_CTA_EMPRESARIAL SET ES_GRUPO = 1 WHERE ID_CUENTAEMPRESARIAL = v_ID_PARENT;
    SELECT count(ID_ANHO) into STRICT v_count_ID_ANHO FROM Conta_Entidad_Anho WHERE ID_ENTIDAD = p_ID_ENTIDAD AND ID_ANHO = p_ID_ANHO;

        IF NOT coalesce(NULLIF(p_ID_CUENTAAASI, '')::text, '') = '' AND v_count_ID_ANHO > 0
        THEN
                          SELECT ID_EMPRESA INTO STRICT v_ID_EMPRESA FROM Conta_Entidad WHERE ID_ENTIDAD = p_ID_ENTIDAD;
                          SELECT count(ID_CUENTAAASI) into STRICT v_count_ID_CUENTAAASI FROM Conta_Empresa_Cta WHERE ID_EMPRESA = v_ID_EMPRESA AND ID_TIPOPLAN = p_ID_TIPOPLAN AND ID_CUENTAAASI = p_ID_CUENTAAASI AND ID_ANHO = p_ID_ANHO  LIMIT 1;

                          IF v_count_ID_CUENTAAASI = 0 THEN
                            INSERT INTO Conta_Empresa_Cta(ID_EMPRESA, ID_TIPOPLAN, ID_CUENTAAASI, ID_RESTRICCION, ID_ANHO, ID_CUENTAEMPRESARIAL, ID_MONEDA)
                            SELECT
                              v_ID_EMPRESA, ID_TIPOPLAN, ID_CUENTAAASI, ID_RESTRICCION, p_ID_ANHO, p_ID_CUENTAEMPRESARIAL, 1
                            FROM Conta_Cta_Denominacional
                            WHERE ID_TIPOPLAN = p_ID_TIPOPLAN
                              AND ID_CUENTAAASI = p_ID_CUENTAAASI;
                          ELSE
                            UPDATE Conta_Empresa_Cta SET
                              ID_CUENTAEMPRESARIAL = p_ID_CUENTAEMPRESARIAL
                            WHERE ID_EMPRESA = v_ID_EMPRESA
                              AND ID_TIPOPLAN = p_ID_TIPOPLAN
                              AND ID_CUENTAAASI = p_ID_CUENTAAASI
                              AND ID_ANHO = p_ID_ANHO;
                          END IF;
        END IF;


  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_cuenta_empresarial ( p_Modo bigint, p_ID_ENTIDAD bigint, p_ID_TIPOPLAN bigint, p_ID_CUENTAAASI text, p_ID_ANHO bigint, p_ID_CUENTAEMPRESARIAL text, p_NOMBRE text) FROM PUBLIC;

