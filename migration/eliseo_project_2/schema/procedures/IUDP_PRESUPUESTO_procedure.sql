-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_presupuesto (v_Modo integer, v_ID_ENTIDAD integer, v_ID_ANHO integer, v_ID_MES integer, v_ID_DEPARTAMENTO text, v_ID_TIPOPLAN integer,v_ID_CUENTAAASI text,v_ID_RESTRICCION text, v_ID_FONDO text,iv_ID_CUENTACTE text, v_VALOR text) AS $body$
DECLARE


   v_ID_CTACTE        varchar(255);
   v_ID_PRESUPUESTO   integer;
   v_COS_VALOR        NUMERIC(10,2);

BEGIN

    v_ID_PRESUPUESTO := 0;
    v_COS_VALOR := TO_NUMBER(v_VALOR,'9999999999.9999');

    IF v_Modo = 1 THEN
        DELETE FROM conta_presupuesto
        WHERE ID_ENTIDAD = v_ID_ENTIDAD
        AND ID_ANHO = v_ID_ANHO
        AND v_ID_MES IN (0, ID_MES);
    ELSE

        IF coalesce(v_COS_VALOR, 0) <> 0 THEN
            --v_ID_CTACTE := CASE WHEN iv_ID_CUENTACTE IN ('@SubAccountCode@', ' ', '0') THEN '' ELSE iv_ID_CUENTACTE END;
            v_ID_CTACTE := CASE WHEN iv_ID_CUENTACTE = '@SubAccountCode@' OR iv_ID_CUENTACTE = '0' THEN '' ELSE iv_ID_CUENTACTE END;

            SELECT COUNT(ID_PRESUPUESTO) INTO STRICT v_ID_PRESUPUESTO
            FROM conta_presupuesto
            WHERE ID_ENTIDAD = v_ID_ENTIDAD
            AND ID_ANHO = v_ID_ANHO
            AND ID_MES = v_ID_MES
            AND ID_DEPTO = v_ID_DEPARTAMENTO
            --AND ID_TIPOPLAN = v_ID_TIPOPLAN
            AND ID_CUENTAAASI = v_ID_CUENTAAASI
            AND ID_RESTRICCION = v_ID_RESTRICCION
            AND ID_FONDO = v_ID_FONDO
            AND ID_CTACTE = v_ID_CTACTE;

            IF v_ID_PRESUPUESTO = 0 THEN
                SELECT coalesce(MAX(ID_PRESUPUESTO),0)+1
                INTO STRICT v_ID_PRESUPUESTO
                FROM conta_presupuesto
                WHERE ID_ENTIDAD = v_ID_ENTIDAD
                AND ID_ANHO = v_ID_ANHO
                AND ID_MES = v_ID_MES;
                --v_ID_PRESUPUESTO := NVL (v_ID_PRESUPUESTO, 0) + 1;
                INSERT INTO conta_presupuesto( ID_PRESUPUESTO,
                                                ID_ENTIDAD,
                                                ID_ANHO,
                                                ID_MES,
                                                ID_DEPTO,
                                                --ID_TIPOPLAN,
                                                ID_CUENTAAASI,
                                                ID_RESTRICCION,
                                                ID_FONDO,
                                                ID_CTACTE,
                                                COS_VALOR)
                                        VALUES (v_ID_PRESUPUESTO,
                                                v_ID_ENTIDAD,
                                                v_ID_ANHO,
                                                v_ID_MES,                                                      
                                                v_ID_DEPARTAMENTO,
                                                --v_ID_TIPOPLAN,
                                                v_ID_CUENTAAASI,
                                                v_ID_RESTRICCION,
                                                v_ID_FONDO,
                                                v_ID_CTACTE,
                                                v_COS_VALOR);

            ELSE
                UPDATE conta_presupuesto
                    SET COS_VALOR = v_COS_VALOR
                WHERE ID_ENTIDAD = v_ID_ENTIDAD
                AND ID_ANHO = v_ID_ANHO
                AND ID_MES = v_ID_MES
                AND ID_PRESUPUESTO = v_ID_PRESUPUESTO;
            END IF;
        END IF;
    END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_presupuesto (v_Modo integer, v_ID_ENTIDAD integer, v_ID_ANHO integer, v_ID_MES integer, v_ID_DEPARTAMENTO text, v_ID_TIPOPLAN integer,v_ID_CUENTAAASI text,v_ID_RESTRICCION text, v_ID_FONDO text,iv_ID_CUENTACTE text, v_VALOR text) FROM PUBLIC;

