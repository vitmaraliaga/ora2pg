-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.sp_asigned_themes (P_DATO bigint) AS $body$
DECLARE

    P_ID bigint;
    P_ENTIDAD bigint;
    P_DEPTO varchar(10);
    P_CANT bigint;

    USERSS CURSOR FOR
    SELECT DISTINCT A.ID,B.ID_ENTIDAD,C.ID_DEPTO
    FROM USERS A, CONTA_ENTIDAD_USUARIO B, LAMB_USERS_DEPTO C
    WHERE A.ID = B.ID_PERSONA
    AND B.ID_PERSONA = C.ID
    AND LENGTH(C.ID_DEPTO) = '1';

    
BEGIN
        
        OPEN USERSS;
            FETCH USERSS INTO P_ID,P_ENTIDAD,P_DEPTO;
            WHILE USERSS%FOUND LOOP


                SELECT COUNT(*) INTO STRICT P_CANT
                FROM  LAMB_ENTIDAD_DEPTO_CONFIG
                WHERE ID = P_ID
                AND ID_ENTIDAD = P_ENTIDAD
                AND ID_DEPTO = P_DEPTO
                AND ID_MODULO = 6
                AND ID_TEMA = 8;

                IF P_CANT = 0 THEN
                    SELECT COUNT(*) INTO STRICT P_CANT FROM LAMB_USERS_DEPTO
                    WHERE ID = P_ID
                    AND ID_ENTIDAD = P_ENTIDAD
                    AND ID_DEPTO = P_DEPTO;
                    IF P_CANT = 0 THEN
                        P_CANT := P_CANT;
                    ELSE
                        INSERT INTO LAMB_ENTIDAD_DEPTO_CONFIG(ID,ID_ENTIDAD,ID_DEPTO,ID_MODULO,ID_TEMA,FECHA)VALUES (P_ID,P_ENTIDAD,P_DEPTO,6,8,clock_timestamp());
                    END IF;
                END IF;

            FETCH USERSS INTO P_ID,P_ENTIDAD,P_DEPTO;

            END LOOP;
        CLOSE USERSS;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.sp_asigned_themes (P_DATO bigint) FROM PUBLIC;

