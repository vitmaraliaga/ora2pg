-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_entidad_departamento ( P_Modo integer, P_ID_ENTIDAD integer, P_ID_DEPARTAMENTO text, P_ID_PARENT text, P_NOMBRE text, P_ES_ACTIVO text ) AS $body$
DECLARE


  S_ID_PARENT           varchar(60);
  S_ES_ACTIVO           varchar(60);
  S_CANTIDAD            integer;
  S_ID_DEPARTAMENTO     varchar(60);

 
BEGIN
	 
IF P_Modo = 0 THEN

    S_ID_DEPARTAMENTO := P_ID_DEPARTAMENTO;

	S_ID_DEPARTAMENTO := REPLACE(S_ID_DEPARTAMENTO, ' ', '');

    S_ID_PARENT := CASE WHEN P_ID_PARENT IN ('@ParentCode@') THEN '' ELSE P_ID_PARENT END;
    S_ID_PARENT := REPLACE(S_ID_PARENT, ' ', '');

    S_ES_ACTIVO := CASE WHEN P_ES_ACTIVO IN ('true') THEN '1' ELSE '0' END;
    
	IF COALESCE(S_ID_PARENT, '') = '' THEN
	    S_CANTIDAD := 0;
	    SELECT COUNT(*) INTO STRICT S_CANTIDAD FROM CONTA_ENTIDAD_DEPTO WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = S_ID_PARENT;
	    IF S_CANTIDAD = 0 THEN
	    	CALL iudp_Entidad_Departamento(P_Modo, P_ID_ENTIDAD, S_ID_PARENT, NULL, P_NOMBRE, S_ES_ACTIVO);
	    END IF;
    END IF;

    S_CANTIDAD := 0;
    SELECT COUNT(*) INTO STRICT S_CANTIDAD FROM CONTA_ENTIDAD_DEPTO WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = S_ID_DEPARTAMENTO;
    
    
    IF S_CANTIDAD = 0 THEN
    
      INSERT INTO CONTA_ENTIDAD_DEPTO(ID_ENTIDAD, ID_DEPTO, ID_PARENT, NOMBRE, ES_ACTIVO, ES_GRUPO)
        VALUES (P_ID_ENTIDAD, S_ID_DEPARTAMENTO, NULLIF(S_ID_PARENT, ''), P_NOMBRE, S_ES_ACTIVO, '0');

    ELSE
      
      UPDATE CONTA_ENTIDAD_DEPTO SET
        ID_PARENT  = NULLIF(S_ID_PARENT, ''),
        NOMBRE    = P_NOMBRE,
        ES_ACTIVO = S_ES_ACTIVO
      WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = S_ID_DEPARTAMENTO;

    END IF;
    
    UPDATE CONTA_ENTIDAD_DEPTO SET
      ES_GRUPO = '1'
      WHERE ID_ENTIDAD = P_ID_ENTIDAD
      AND ID_DEPTO = S_ID_PARENT;
  END IF;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_entidad_departamento ( P_Modo integer, P_ID_ENTIDAD integer, P_ID_DEPARTAMENTO text, P_ID_PARENT text, P_NOMBRE text, P_ES_ACTIVO text ) FROM PUBLIC;

