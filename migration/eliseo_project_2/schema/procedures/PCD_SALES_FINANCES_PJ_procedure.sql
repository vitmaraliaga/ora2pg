-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.pcd_sales_finances_pj ( pval integer, v_mes integer) AS $body$
DECLARE


  p_res varchar(100);
  p_anio integer;
  p_mes integer;
  niveles CURSOR FOR
    SELECT a.id_depto, nombre
    FROM eliseo.conta_entidad_depto a
    WHERE a.id_entidad = 7124
      AND a.es_grupo = 1
      AND length(a.id_depto) = 1
    ORDER BY a.id_depto;

BEGIN

if (pval>=2020) then
  SELECT pval,v_mes into STRICT p_anio,p_mes
;
else
  SELECT (to_char(clock_timestamp(),'YYYY'))::numeric ,(to_char(clock_timestamp(),'MM'))::numeric  into STRICT p_anio,p_mes
;
end if;

  CALL ELISEO.PKG_SALES_FINANCES.SP_RESULTADO_DEPTO(7124,p_anio,p_mes,4);
  commit;
  CALL ELISEO.PKG_SALES_FINANCES.SP_RESULTADO_DEPARTAMENTO(7124,p_anio,p_mes,4);
  commit;
  CALL ELISEO.PKG_SALES_FINANCES.SP_RESULTADO_COSTOS_G(7124,p_anio,p_mes,4);
  commit;
  CALL ELISEO.PKG_SALES_FINANCES.SP_RESULTADO_COSTOS_SL(7124,p_anio,p_mes,4);
  commit;
  CALL ELISEO.PKG_SALES_FINANCES.SP_RESULTADO_COSTOS_SC(7124,p_anio,p_mes,4);
  commit;
  CALL ELISEO.PKG_SALES_FINANCES.SP_RESUMEN(7124,p_anio,p_mes,4);
  commit;
  CALL ELISEO.PKG_SALES_FINANCES.SP_RESULTADO_ALUMNOS(7124,p_anio);
  commit;


  for req in niveles
  loop      
    CALL ELISEO.PKG_SALES_FINANCES.SP_ESTADO_RESULTADO(7124,p_anio,p_mes,req.id_depto);
    commit;
    CALL ELISEO.PKG_SALES_FINANCES.SP_BALANCE(7124,p_anio,p_mes,req.id_depto);
    commit;
  end loop;

  
  CALL PKG_SALES_FINANCES.SP_ESTADO_RESULTADO_CONS(7124,p_anio,p_mes);
  commit;
  CALL PKG_SALES_FINANCES.SP_BALANCE_CONSOLIDADO(7124,p_anio,p_mes);
  commit;

end;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE eliseo.pcd_sales_finances_pj ( pval integer, v_mes integer) FROM PUBLIC;

