-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.sp_aux_crear_voucher (P_ID_ENTIDAD integer,P_ID_DEPTO text,P_ID_ANHO integer,P_ID_MES integer,P_FECHA timestamp(0), P_ID_TIPOASIENTO text,P_ID_TIPOVOUCHER bigint,P_ID_SEAT_PARENT bigint,P_ACTIVO text, P_ID_PERSONA bigint, P_ID_VOUCHER out bigint) AS $body$
DECLARE

        l_vou_id bigint;	
        l_cont bigint;			 				
        l_nrovoucher bigint;

        l_automatico varchar(4);

        -- DATOS DEL CONFIG PARENT
        l_id_tipovoucher_child bigint;
        l_id_tipoasiento_child varchar(10);
        l_cantidad_child bigint := 0;
        l_id_voucher_child bigint;

        l_fecha timestamp(0) := clock_timestamp();

BEGIN
            l_cont := 0;

            l_fecha := coalesce(P_FECHA, clock_timestamp());

            SELECT
            AUTOMATICO INTO STRICT l_automatico
            FROM CONTA_VOUCHER_CONFIG
            WHERE ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_DEPTO = P_ID_DEPTO
            AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
            AND ID_ANHO = P_ID_ANHO
            AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER;

            IF l_automatico = 'N' THEN  -- SI EL VOUCHER NO ES AUTOMATICO SE CREAN TODOS LOS QUE SEAN NECESARIOS
                SELECT coalesce(max(NUMERO),0)+1 INTO STRICT l_nrovoucher
                FROM CONTA_VOUCHER
                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                AND ID_DEPTO = P_ID_DEPTO 
                AND ID_ANHO = P_ID_ANHO
                AND ID_MES = P_ID_MES
                AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
                AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER;

                SELECT coalesce(max(ID_VOUCHER),0)+1 INTO STRICT l_vou_id
                FROM CONTA_VOUCHER;

                P_ID_VOUCHER := l_vou_id;

                INSERT INTO CONTA_VOUCHER(	
                                            ID_VOUCHER,
                                            ID_ENTIDAD, 
											ID_DEPTO, 
											ID_ANHO, 
											ID_MES, 
											ID_TIPOASIENTO,
                                            ID_TIPOVOUCHER,
                                            NUMERO,
											FECHA, 
											ACTIVO,
											ID_PERSONA,
                                            ID_VOUCHER_PARENT
										  )VALUES (
										    l_vou_id,
											P_ID_ENTIDAD,
											P_ID_DEPTO,
											P_ID_ANHO,
											P_ID_MES,
											P_ID_TIPOASIENTO,
                                            P_ID_TIPOVOUCHER,
                                            l_nrovoucher,
											P_FECHA,
											P_ACTIVO,
                                            P_ID_PERSONA,
                                            P_ID_SEAT_PARENT
										  );

            ELSE  -- EL SI VOUCHER ES AUTOMATICO SE CREA UNO POR DIA, CON LA PRIMERA OPCION
                SELECT COUNT(ID_VOUCHER) INTO STRICT l_cont
                FROM CONTA_VOUCHER
                WHERE ID_ENTIDAD = P_ID_ENTIDAD 
                AND ID_DEPTO = P_ID_DEPTO 
                AND ID_ANHO = P_ID_ANHO
                AND ID_MES = P_ID_MES
                AND ID_TIPOASIENTO = P_ID_TIPOASIENTO       
                AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER              
                AND to_char(FECHA,'YYYYDDMM') = to_char(l_fecha,'YYYYDDMM');

                IF l_cont = 0 THEN

                    SELECT coalesce(max(NUMERO),0)+1 INTO STRICT l_nrovoucher
                    FROM CONTA_VOUCHER
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD
                    AND ID_DEPTO = P_ID_DEPTO 
                    AND ID_ANHO = P_ID_ANHO
                    AND ID_MES = P_ID_MES
                    AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
                    AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER;


                    SELECT coalesce(max(ID_VOUCHER),0)+1 INTO STRICT l_vou_id
                    FROM CONTA_VOUCHER;

                    P_ID_VOUCHER := l_vou_id;

                    INSERT INTO CONTA_VOUCHER(	
                                                ID_VOUCHER,
                                                ID_ENTIDAD, 
                                                ID_DEPTO, 
                                                ID_ANHO, 
                                                ID_MES, 
                                                ID_TIPOASIENTO,
                                                ID_TIPOVOUCHER,
                                                NUMERO,
                                                FECHA, 
                                                ACTIVO,
                                                ID_PERSONA,
                                               ID_VOUCHER_PARENT 
                                              )VALUES (
                                                l_vou_id,
                                                P_ID_ENTIDAD,
                                                P_ID_DEPTO,
                                                P_ID_ANHO,
                                                P_ID_MES,
                                                P_ID_TIPOASIENTO,
                                                P_ID_TIPOVOUCHER,
                                                l_nrovoucher,
                                                l_fecha,
                                                P_ACTIVO,
                                                P_ID_PERSONA,
                                                P_ID_SEAT_PARENT
                                              );	
                ELSE

                    SELECT ID_VOUCHER INTO STRICT l_vou_id
                    FROM CONTA_VOUCHER
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD 
                    AND ID_DEPTO = P_ID_DEPTO 
                    AND ID_ANHO = P_ID_ANHO
                    AND ID_MES = P_ID_MES
                    AND ID_TIPOASIENTO = P_ID_TIPOASIENTO
                    AND ID_TIPOVOUCHER = P_ID_TIPOVOUCHER
                    AND to_char(FECHA,'YYYYDDMM') = to_char(l_fecha,'YYYYDDMM');

                    P_ID_VOUCHER := l_vou_id;

                END IF;
            END IF;

			-- SI EL VOUCHER_CONFIG TIENE UN HIJO, TAMBIEN LO CREAMOS SU HIJO
			IF P_ID_ENTIDAD <> 7124 THEN
                SELECT COUNT(1) INTO STRICT l_cantidad_child
                FROM CONTA_VOUCHER_CONFIG
                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                AND ID_DEPTO = P_ID_DEPTO
                AND ID_ANHO = P_ID_ANHO
                AND ID_TIPOASIENTO_PARENT = P_ID_TIPOASIENTO;

                IF l_cantidad_child = 1 THEN
                    SELECT ID_TIPOASIENTO, ID_TIPOVOUCHER
                        INTO STRICT l_id_tipoasiento_child, l_id_tipovoucher_child
                    FROM CONTA_VOUCHER_CONFIG
                    WHERE ID_ENTIDAD = P_ID_ENTIDAD
                    AND ID_DEPTO = P_ID_DEPTO
                    AND ID_ANHO = P_ID_ANHO
                    AND ID_TIPOASIENTO_PARENT = P_ID_TIPOASIENTO;
                    -- AGREGAR HIJO
                    CALL PKG_ACCOUNTING.SP_CREAR_VOUCHER(P_ID_ENTIDAD, P_ID_DEPTO, P_ID_ANHO, P_ID_MES, P_FECHA, l_id_tipoasiento_child,  l_id_tipovoucher_child,
                    NULL, P_ACTIVO, P_ID_PERSONA, l_id_voucher_child);

                    -- UPDATE CHILD
                    UPDATE CONTA_VOUCHER
                    SET  ID_VOUCHER_PARENT = P_ID_VOUCHER
                    WHERE ID_VOUCHER = l_id_voucher_child;

                END IF;
            END IF;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.sp_aux_crear_voucher (P_ID_ENTIDAD integer,P_ID_DEPTO text,P_ID_ANHO integer,P_ID_MES integer,P_FECHA timestamp(0), P_ID_TIPOASIENTO text,P_ID_TIPOVOUCHER bigint,P_ID_SEAT_PARENT bigint,P_ACTIVO text, P_ID_PERSONA bigint, P_ID_VOUCHER out bigint) FROM PUBLIC;

