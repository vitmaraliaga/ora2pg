-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_activo (P_Modo integer, P_ID_ENTIDAD integer, P_COD_ACTIVO text, P_ID_DEPARTAMENTO text, P_ID_TIPOPLAN integer, P_ID_CUENTAAASI text, P_ID_FONDO text, P_ID_TIPOACTIVOESTADO integer, P_NOMBRE text, P_CATEGORIA text, P_MARCA text, P_MODELO text, P_SERIE text, P_SECCION text, P_FEC_REGISTRO text, P_FEC_PRIMERUSO text,P_POR_DEPRECIACION text, P_POR_ESPECIAL text, P_DOLAR text, P_TIPOCAMBIO text) AS $body$
DECLARE


    S_COD_ACTIVO        varchar(20);
    S_MARCA             varchar(255);
    S_MODELO            varchar(255);
    S_SERIE             varchar(255);
    S_NOMBRE            varchar(2000);
    S_FEC_PRIMERUSO     timestamp(0);
    S_FEC_REGISTRO      timestamp(0);
    S_ID_ACTIVO         integer;
    S_ID_RESTRICCION    varchar(10);
    S_TAS_DEPRECIACION  NUMERIC(10,2);
    S_TAS_ESPECIAL      NUMERIC(10,2);
    S_COS_DOLAR         NUMERIC(10,2);
    S_COS_TIPOCAMBIO    NUMERIC(10,3);
    S_CANTIDAD          integer;


BEGIN
        
    S_COD_ACTIVO := CASE WHEN P_COD_ACTIVO IN ('@Code@') THEN '' ELSE P_COD_ACTIVO END;
    S_MARCA := CASE WHEN P_MARCA = '@Brand@' THEN '' ELSE P_MARCA END;
    S_MODELO := CASE WHEN P_MODELO = '@Model@' THEN '' ELSE P_MODELO END;
    S_SERIE := CASE WHEN P_SERIE = '@SerialNumber@' THEN '' ELSE P_SERIE END;
    S_NOMBRE := CASE WHEN P_NOMBRE = '@AditionalDescription@' THEN '' ELSE P_NOMBRE END;
    S_FEC_PRIMERUSO := CASE WHEN P_FEC_PRIMERUSO = '@FirstUseDate@' THEN NULL ELSE to_date(P_FEC_PRIMERUSO,'yyyy-mm-dd"T"HH24:MI:SS') END;
    S_TAS_DEPRECIACION := P_POR_DEPRECIACION;
    S_TAS_ESPECIAL := CASE WHEN P_POR_ESPECIAL = '@SpecialDepreciation@' OR P_POR_ESPECIAL = '' THEN '0' ELSE P_POR_ESPECIAL END;
    S_COS_DOLAR := CASE WHEN P_DOLAR = '@MulticurrencyAmount@' OR P_DOLAR = '' THEN '0' ELSE P_DOLAR END;
    S_COS_TIPOCAMBIO := CASE WHEN P_TIPOCAMBIO = '@ExchangeRate@' OR P_TIPOCAMBIO = '' THEN '0' ELSE P_TIPOCAMBIO END;
    S_FEC_REGISTRO := to_date(P_FEC_REGISTRO,'DD/MM/YYYY');

  IF P_Modo = 0 THEN  
  
    SELECT COUNT(*) INTO STRICT S_CANTIDAD 
    FROM CONTA_ACTIVO 
    WHERE ID_ENTIDAD = P_ID_ENTIDAD
    AND COD_ACTIVO = S_COD_ACTIVO;

    
    SELECT ID_RESTRICCION INTO STRICT S_ID_RESTRICCION
    FROM CONTA_CTA_DENOMINACIONAL
    WHERE ID_TIPOPLAN = P_ID_TIPOPLAN
    AND ID_CUENTAAASI = P_ID_CUENTAAASI  LIMIT 1;

    IF S_CANTIDAD = 0 THEN    
       
        SELECT
        coalesce(MAX(ID_ACTIVO),0)+1 INTO STRICT S_ID_ACTIVO
        FROM CONTA_ACTIVO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD;

        --S_ID_ACTIVO := S_ID_ACTIVO+1;
        INSERT INTO CONTA_ACTIVO(ID_ENTIDAD, ID_ACTIVO, ID_DEPTO, ID_TIPOPLAN, ID_CUENTAAASI, ID_RESTRICCION, ID_FONDO, ID_TIPOACTIVOESTADO, NOMBRE, COD_ACTIVO, CATEGORIA, MARCA, MODELO, SERIE, SECCION, FEC_REGISTRO, FEC_COMPRA, FEC_PRIMERUSO, TAS_DEPRECIACION, TAS_ESPECIAL, COS_VALOR, COS_DOLAR, COS_TIPOCAMBIO)
        VALUES (P_ID_ENTIDAD, S_ID_ACTIVO, P_ID_DEPARTAMENTO, P_ID_TIPOPLAN, P_ID_CUENTAAASI, S_ID_RESTRICCION, P_ID_FONDO, P_ID_TIPOACTIVOESTADO, S_NOMBRE, S_COD_ACTIVO, P_CATEGORIA, S_MARCA, S_MODELO, S_SERIE, P_SECCION, S_FEC_REGISTRO, NULL, S_FEC_PRIMERUSO, S_TAS_DEPRECIACION, S_TAS_ESPECIAL, 0, S_COS_DOLAR, S_COS_TIPOCAMBIO);

    ELSE
    
        SELECT ID_ACTIVO INTO STRICT S_ID_ACTIVO
        FROM CONTA_ACTIVO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD 
        AND COD_ACTIVO = S_COD_ACTIVO;

        UPDATE CONTA_ACTIVO SET
                ID_DEPTO     = P_ID_DEPARTAMENTO,
                ID_FONDO            = P_ID_FONDO,
                ID_TIPOPLAN         = P_ID_TIPOPLAN,
                ID_CUENTAAASI       = P_ID_CUENTAAASI,
                ID_RESTRICCION      = S_ID_RESTRICCION,
                ID_TIPOACTIVOESTADO = P_ID_TIPOACTIVOESTADO,
                NOMBRE              = S_NOMBRE,
                CATEGORIA           = P_CATEGORIA,
                MARCA               = S_MARCA,
                MODELO              = S_MODELO,
                SERIE               = S_SERIE,
                SECCION             = P_SECCION,
                FEC_REGISTRO        = S_FEC_REGISTRO,
                FEC_PRIMERUSO       = S_FEC_PRIMERUSO,
                TAS_DEPRECIACION    = S_TAS_DEPRECIACION,
                TAS_ESPECIAL        = S_TAS_ESPECIAL,
                COS_DOLAR           = S_COS_DOLAR,
                COS_TIPOCAMBIO      = S_COS_TIPOCAMBIO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_ACTIVO = S_ID_ACTIVO
        AND COD_ACTIVO = S_COD_ACTIVO;
  END IF;
END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_activo (P_Modo integer, P_ID_ENTIDAD integer, P_COD_ACTIVO text, P_ID_DEPARTAMENTO text, P_ID_TIPOPLAN integer, P_ID_CUENTAAASI text, P_ID_FONDO text, P_ID_TIPOACTIVOESTADO integer, P_NOMBRE text, P_CATEGORIA text, P_MARCA text, P_MODELO text, P_SERIE text, P_SECCION text, P_FEC_REGISTRO text, P_FEC_PRIMERUSO text,P_POR_DEPRECIACION text, P_POR_ESPECIAL text, P_DOLAR text, P_TIPOCAMBIO text) FROM PUBLIC;

