-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE eliseo.iudp_cuenta_denominacional ( P_Modo integer, P_ID_TIPOPLAN integer, P_ID_CUENTAAASI text, P_ID_PARENT text, P_ID_RESTRICCION text, P_ID_TIPOCUENTACTE text, P_NOMBRE text, P_NOMBRE_TIPOCUENTACTE text, P_ES_ACREEDORA text, P_ES_ACTIVA text) AS $body$
DECLARE


S_CANTIDAD integer;
S_ID_PARENT varchar(100);
S_ID_RESTRICCION varchar(20);

BEGIN
  IF P_Modo = 0
  THEN
	S_CANTIDAD:=0;
	SELECT COUNT(1) INTO STRICT S_CANTIDAD FROM TIPO_CTA_CORRIENTE WHERE ID_TIPOCTACTE = P_ID_TIPOCUENTACTE;
	IF S_CANTIDAD = 0 THEN
		IF NOT P_ID_TIPOCUENTACTE = '' THEN 
	       INSERT INTO TIPO_CTA_CORRIENTE(ID_TIPOCTACTE, NOMBRE)
	        VALUES (P_ID_TIPOCUENTACTE, P_NOMBRE_TIPOCUENTACTE);
        END IF;
    END IF;

      S_ID_PARENT := CASE WHEN P_ID_PARENT IN ('@ParentCode@') THEN '' ELSE P_ID_PARENT END;
      S_ID_RESTRICCION := CASE WHEN P_ID_RESTRICCION = '@BaseEntityCode@' THEN '' ELSE P_ID_RESTRICCION END;

      S_CANTIDAD := 0;
      --SELECT COUNT(1) INTO S_CANTIDAD FROM CONTA_CTA_DENOMINACIONAL WHERE ID_TIPOPLAN = P_ID_TIPOPLAN AND ID_CUENTAAASI = P_ID_CUENTAAASI AND ID_RESTRICCION = P_ID_RESTRICCION;
      SELECT COUNT(1) INTO STRICT S_CANTIDAD FROM CONTA_CTA_DENOMINACIONAL WHERE ID_TIPOPLAN = P_ID_TIPOPLAN AND ID_CUENTAAASI = P_ID_CUENTAAASI;

      IF S_CANTIDAD = 0 THEN 
	      INSERT INTO CONTA_CTA_DENOMINACIONAL(ID_TIPOPLAN, ID_CUENTAAASI, ID_RESTRICCION, ID_PARENT, ID_TIPOCTACTE, NOMBRE, ES_ACREEDORA, ES_ACTIVA, ES_GRUPO)
        	VALUES (P_ID_TIPOPLAN, P_ID_CUENTAAASI, P_ID_RESTRICCION, NULLIF(P_ID_PARENT, ''), NULLIF(P_ID_TIPOCUENTACTE, ''), P_NOMBRE, P_ES_ACREEDORA, CASE WHEN P_ES_ACTIVA='true' THEN 1  ELSE 0 END , 0);
      ELSE
	      UPDATE CONTA_CTA_DENOMINACIONAL SET
	        ID_PARENT        = P_ID_PARENT,
	        ID_TIPOCTACTE  = NULLIF(P_ID_TIPOCUENTACTE, ''),
	        NOMBRE           = P_NOMBRE,
	        ES_ACREEDORA     = P_ES_ACREEDORA,
	        ES_ACTIVA        = CASE WHEN P_ES_ACTIVA='true' THEN 1  ELSE 0 END
	      WHERE ID_TIPOPLAN = P_ID_TIPOPLAN
	        AND ID_CUENTAAASI = P_ID_CUENTAAASI
	        AND ID_RESTRICCION = P_ID_RESTRICCION;

      END IF;

     SELECT COUNT(1) INTO STRICT S_CANTIDAD FROM CONTA_CTA_RESTRICCION ccr WHERE ID_TIPOPLAN = P_ID_TIPOPLAN AND ID_CUENTAAASI = P_ID_CUENTAAASI AND ID_RESTRICCION = P_ID_RESTRICCION;

      IF S_CANTIDAD = 0 THEN 
	      INSERT INTO CONTA_CTA_RESTRICCION(ID_TIPOPLAN, ID_CUENTAAASI, ID_RESTRICCION ,ACTIVO)
        	VALUES (P_ID_TIPOPLAN, P_ID_CUENTAAASI, P_ID_RESTRICCION, CASE WHEN P_ES_ACTIVA='true' THEN 1  ELSE 0 END );
     /*
        ELSE
	      UPDATE CONTA_CTA_DENOMINACIONAL SET
	        ID_PARENT        = P_ID_PARENT,
	        ID_TIPOCTACTE = NULLIF(P_ID_TIPOCUENTACTE, ''),
	        NOMBRE           = P_NOMBRE,
	        ES_ACREEDORA     = P_ES_ACREEDORA,
	        ES_ACTIVA        = decode(P_ES_ACTIVA,'true',1,0)
	      WHERE ID_TIPOPLAN = P_ID_TIPOPLAN
	        AND ID_CUENTAAASI = P_ID_CUENTAAASI
	       -- AND ID_RESTRICCION = P_ID_RESTRICCION
	       ;
	       */
      END IF;

        
        
    UPDATE CONTA_CTA_DENOMINACIONAL SET
      ES_GRUPO = 1
    WHERE ID_TIPOPLAN = P_ID_TIPOPLAN
      AND ID_CUENTAAASI = P_ID_PARENT;

  END IF; --END DE P_MODO
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.iudp_cuenta_denominacional ( P_Modo integer, P_ID_TIPOPLAN integer, P_ID_CUENTAAASI text, P_ID_PARENT text, P_ID_RESTRICCION text, P_ID_TIPOCUENTACTE text, P_NOMBRE text, P_NOMBRE_TIPOCUENTACTE text, P_ES_ACREEDORA text, P_ES_ACTIVA text) FROM PUBLIC;

