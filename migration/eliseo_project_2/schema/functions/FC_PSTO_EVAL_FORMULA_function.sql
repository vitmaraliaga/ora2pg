-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_psto_eval_formula (P_FORMULA text,P_ID_ANHO bigint) RETURNS varchar AS $body$
DECLARE

l_id_parametro varchar(50);
l_importe decimal(20,14);
l_formula  varchar(3000):='';
l_valid bigint;

CUR CURSOR FOR
SELECT UPPER(B.ID_PARAMETRO),B.IMPORTE
FROM PSTO_PLLA_PARAMETROS A, PSTO_PLLA_PARAMETROS_VALOR  B
WHERE B.ID_ANHO = P_ID_ANHO
AND A.ESTADO='1'
ORDER BY A.ORDEN;



BEGIN
    l_formula:=UPPER(P_FORMULA);
    open CUR;
        fetch CUR into l_id_parametro,l_importe;
        while CUR%found loop
            l_formula:= replace(l_formula,'$'||l_id_parametro,replace(l_importe::text,',','.') );

            SELECT position('$' in l_formula) into STRICT l_valid;

            if l_valid=0 then
              EXIT;
            end if;

            fetch CUR into l_id_parametro,l_importe;
        end loop;
	close CUR;	
	
	RETURN(l_formula);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_psto_eval_formula (P_FORMULA text,P_ID_ANHO bigint) FROM PUBLIC;

