-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_depto_alumno (P_ID_CLIENTE bigint, P_ID_DEPTO text) RETURNS varchar AS $body$
DECLARE

  l_depto varchar(10);
  l_contar bigint;
  l_id_sedearea bigint;

BEGIN

  select count(*) into STRICT l_contar
  FROM DAVID.VW_ALUMNO_PLAN_PROGRAMA A
  WHERE A.ID_PERSONA = P_ID_CLIENTE
    AND A.ID_SEDE = CASE WHEN P_ID_DEPTO='1' THEN  1 WHEN P_ID_DEPTO='5' THEN  2 WHEN P_ID_DEPTO='6' THEN  3 WHEN P_ID_DEPTO='8' THEN  4 END;

  if l_contar > 0 then

    SELECT X.ID_SEDEAREA INTO STRICT l_id_sedearea
    FROM (
        SELECT ID_SEDEAREA
        FROM DAVID.VW_ALUMNO_PLAN_PROGRAMA
        WHERE ID_PERSONA = P_ID_CLIENTE
          AND ID_SEDE = CASE WHEN P_ID_DEPTO='1' THEN  1 WHEN P_ID_DEPTO='5' THEN  2 WHEN P_ID_DEPTO='6' THEN  3 WHEN P_ID_DEPTO='8' THEN  4 END 
        ORDER BY ESTADO ASC, ID_NIVEL_ENSENANZA ASC, NOMBRE_PLAN DESC
        ) X LIMIT 1;

    SELECT ID_DEPTO INTO STRICT l_depto
    FROM ELISEO.ORG_SEDE_AREA
    WHERE ID_SEDEAREA = l_id_sedearea
;

  else

    l_depto := P_ID_DEPTO||'1010101';

  end if;

  return l_depto;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_depto_alumno (P_ID_CLIENTE bigint, P_ID_DEPTO text) FROM PUBLIC;

