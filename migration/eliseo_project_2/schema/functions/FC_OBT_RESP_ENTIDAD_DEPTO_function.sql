-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_obt_resp_entidad_depto (P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_MES bigint, P_ID_ANHO bigint) RETURNS varchar AS $body$
DECLARE

l_dato varchar(200);
l_contar integer:=0;
l_id_virtual bigint;
l_date_ bigint;
l_fec_inicio timestamp(0);
l_id_persona bigint;

BEGIN

  	SELECT P_ID_ANHO ||''|| LPAD(P_ID_MES,2,0) INTO STRICT l_date_;

  	SELECT COUNT(ID_PERSONA) INTO STRICT l_contar
	FROM CONTA_ENTIDAD_DEPTO_RESP WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND  TO_CHAR(FEC_INICIO, 'YYYYMM') <= l_date_ AND (TO_CHAR(FEC_TERMINO, 'YYYYMM') >= l_date_ OR coalesce(FEC_TERMINO::text, '') = '');
	IF l_contar > 0 THEN
		IF l_contar = 1 THEN
		
			SELECT ID_PERSONA INTO STRICT l_id_persona FROM CONTA_ENTIDAD_DEPTO_RESP  WHERE ID_ENTIDAD = P_ID_ENTIDAD
					AND ID_DEPTO = P_ID_DEPTO AND TO_CHAR(FEC_INICIO, 'YYYYMM') <= l_date_ AND (TO_CHAR(FEC_TERMINO, 'YYYYMM') >= l_date_ OR coalesce(FEC_TERMINO::text, '') = '');
			SELECT P.PATERNO ||''|| P.MATERNO ||','|| P.NOMBRE INTO STRICT l_dato FROM MOISES.PERSONA P
			WHERE P.ID_PERSONA = l_id_persona;
		ELSE
			SELECT MAX(FEC_INICIO) INTO STRICT l_fec_inicio  FROM CONTA_ENTIDAD_DEPTO_RESP WHERE ID_ENTIDAD = P_ID_ENTIDAD
			AND ID_DEPTO = P_ID_DEPTO AND TO_CHAR(FEC_INICIO, 'YYYYMM') <= l_date_ AND (TO_CHAR(FEC_TERMINO, 'YYYYMM') >= l_date_ OR coalesce(FEC_TERMINO::text, '') = '');
		
			SELECT P.PATERNO ||''|| P.MATERNO ||','|| P.NOMBRE  INTO STRICT l_dato FROM MOISES.PERSONA  P
			WHERE P.ID_PERSONA = (SELECT ID_PERSONA FROM CONTA_ENTIDAD_DEPTO_RESP WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND FEC_INICIO = l_fec_inicio);
		END IF;
	ELSE
		l_dato	:='Sin administrador';
	END IF;

	RETURN(l_dato);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_obt_resp_entidad_depto (P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_MES bigint, P_ID_ANHO bigint) FROM PUBLIC;

