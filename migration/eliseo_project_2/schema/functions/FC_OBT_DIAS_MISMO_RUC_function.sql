-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_obt_dias_mismo_ruc (P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, FECHA_INI timestamp(0), FECHA_FIN timestamp(0)) RETURNS bigint AS $body$
DECLARE

l_contar integer:=0;
total_meses decimal(10,2):=0.00;
contador integer:=0;
anho bigint;
mes bigint;
fecha_ini_temp timestamp(0);
fecha_fin_temp timestamp(0);
fecha_ini_gen timestamp(0);
fecha_fin_gen timestamp(0);
total_meses_vacios bigint:=0;
dias bigint:=0;

  ITEM RECORD;

BEGIN

		SELECT COUNT(*) INTO STRICT l_contar
		FROM APS_EMPLEADO
		WHERE ID_PERSONA=P_ID_PERSONA AND FC_EMPRESA_RUC(ID_ENTIDAD) = FC_EMPRESA_RUC(P_ID_ENTIDAD) AND (ESTADO IS NOT NULL AND ESTADO::text <> '')
			AND FEC_ENTIDAD < FECHA_FIN AND (coalesce(FEC_TERMINO::text, '') = '' OR (FEC_TERMINO BETWEEN FECHA_INI AND FECHA_FIN OR FEC_TERMINO >= FECHA_FIN));

		IF l_contar > 0 THEN
			IF l_contar = 1 THEN
				SELECT RECORDS.SALIDA,RECORDS.INGRESO,MONTHS_BETWEEN(RECORDS.SALIDA+1, RECORDS.INGRESO) INTO STRICT fecha_fin_gen,fecha_ini_gen,total_meses
				FROM (
					SELECT ID_ENTIDAD, FEC_ENTIDAD, FEC_INICIO, FEC_TERMINO, ESTADO ,
						(CASE WHEN FEC_ENTIDAD > FECHA_INI THEN FEC_ENTIDAD ELSE FECHA_INI END ) AS INGRESO,
						(CASE WHEN coalesce(FEC_TERMINO::text, '') = '' THEN FECHA_FIN WHEN (FEC_TERMINO IS NOT NULL AND FEC_TERMINO::text <> '') AND FEC_TERMINO > FECHA_FIN THEN FECHA_FIN ELSE FEC_TERMINO END) AS SALIDA
					FROM APS_EMPLEADO
					WHERE ID_PERSONA=P_ID_PERSONA AND FC_EMPRESA_RUC(ID_ENTIDAD) = FC_EMPRESA_RUC(P_ID_ENTIDAD) AND (ESTADO IS NOT NULL AND ESTADO::text <> '')
						AND FEC_ENTIDAD < FECHA_FIN AND (coalesce(FEC_TERMINO::text, '') = '' OR (FEC_TERMINO BETWEEN FECHA_INI AND FECHA_FIN OR FEC_TERMINO >= FECHA_FIN)) 
				) RECORDS;
			ELSE
				FOR ITEM IN (SELECT ID_ENTIDAD, FEC_ENTIDAD, FEC_INICIO, FEC_TERMINO, ESTADO
					FROM APS_EMPLEADO 
					WHERE ID_PERSONA=P_ID_PERSONA AND FC_EMPRESA_RUC(ID_ENTIDAD) = FC_EMPRESA_RUC(P_ID_ENTIDAD) AND (ESTADO IS NOT NULL AND ESTADO::text <> '')
						AND FEC_ENTIDAD < FECHA_FIN AND (coalesce(FEC_TERMINO::text, '') = '' OR (FEC_TERMINO BETWEEN FECHA_INI AND FECHA_FIN OR FEC_TERMINO >= FECHA_FIN)) 
						ORDER BY FEC_ENTIDAD,ID_CONTRATO)
				LOOP
					contador := contador + 1;
					IF contador = 1 THEN
						fecha_ini_temp 	:= (CASE WHEN ITEM.FEC_ENTIDAD > FECHA_INI THEN ITEM.FEC_ENTIDAD ELSE FECHA_INI END);
						fecha_fin_temp 	:= (CASE WHEN coalesce(ITEM.FEC_TERMINO::text, '') = '' THEN FECHA_FIN
																		 WHEN (ITEM.FEC_TERMINO IS NOT NULL AND ITEM.FEC_TERMINO::text <> '') AND ITEM.FEC_TERMINO > FECHA_FIN THEN FECHA_FIN ELSE ITEM.FEC_TERMINO END);

						total_meses 		:= MONTHS_BETWEEN(fecha_fin_temp + 1, fecha_ini_temp);
					ELSE
						IF (ITEM.FEC_ENTIDAD NOT BETWEEN fecha_ini_temp AND fecha_fin_temp) AND (ITEM.FEC_INICIO NOT BETWEEN fecha_ini_temp AND fecha_fin_temp) THEN		
							IF (ITEM.FEC_ENTIDAD = fecha_fin_temp + 1) OR (ITEM.FEC_INICIO = fecha_fin_temp + 1) THEN
								fecha_ini_temp 	:= (CASE WHEN ITEM.FEC_ENTIDAD = fecha_fin_temp + 1  THEN ITEM.FEC_ENTIDAD ELSE ITEM.FEC_INICIO END);
								fecha_fin_temp 	:= (CASE WHEN coalesce(ITEM.FEC_TERMINO::text, '') = '' THEN FECHA_FIN ELSE ITEM.FEC_TERMINO END);

								total_meses 		:= total_meses + MONTHS_BETWEEN(fecha_fin_temp + 1, fecha_ini_temp);
							ELSE
								fecha_ini_temp 	:= (CASE WHEN ITEM.FEC_ENTIDAD > FECHA_INI THEN ITEM.FEC_ENTIDAD ELSE FECHA_INI END);
								fecha_fin_temp 	:= (CASE WHEN coalesce(ITEM.FEC_TERMINO::text, '') = '' THEN FECHA_FIN
																			 WHEN (ITEM.FEC_TERMINO IS NOT NULL AND ITEM.FEC_TERMINO::text <> '') AND ITEM.FEC_TERMINO > FECHA_FIN THEN FECHA_FIN ELSE ITEM.FEC_TERMINO END);
								total_meses := MONTHS_BETWEEN(fecha_fin_temp + 1, fecha_ini_temp);
								--fecha_ini_temp 	:= ITEM.FEC_ENTIDAD;
								--fecha_fin_temp 	:= (CASE WHEN ITEM.FEC_TERMINO IS NULL THEN FECHA_FIN ELSE ITEM.FEC_TERMINO END);
							END IF;
						END IF;
					fecha_fin_gen := fecha_fin_temp;
					END IF;
				END LOOP;
			END IF;
		END IF;
	IF l_contar>1 THEN
		dias:=CEIL((total_meses - date_trunc('day', total_meses))* 30);
	ELSE
		dias:=fecha_fin_gen - fecha_ini_gen + date_trunc('day', total_meses)*'1 month'::interval;
	END IF;
	RETURN CASE WHEN dias<=0 THEN 0 ELSE dias END;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_obt_dias_mismo_ruc (P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, FECHA_INI timestamp(0), FECHA_FIN timestamp(0)) FROM PUBLIC;

