-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_nuevo_detalle_asiento ( p_id_asiento bigint ) RETURNS varchar AS $body$
DECLARE

    l_glosa          varchar(200);
    l_id_tipo_origen varchar(50);
    l_id_origen      varchar(50);
    l_importe        decimal(10,2);
    l_cuenta         varchar(10);
    l_cuenta_cte     varchar(10);
    l_estado         boolean := false;
    l_signo          numeric;

BEGIN

    SELECT
        id_tipoorigen,
        id_origen,
        descripcion,
        cuenta,
        cuenta_cte,
        SIGN(l_importe)
    INTO STRICT
        l_id_tipo_origen,
        l_id_origen,
        l_glosa,
        l_cuenta,
        l_cuenta_cte,
        l_signo
    FROM
        conta_asiento
    WHERE
        id_asiento = p_id_asiento;

    
    
    IF l_id_tipo_origen = '5' THEN
        -- GASTOS 
        l_estado :=
            CASE l_cuenta
                WHEN '1112001' THEN
                    true
                WHEN '1112025' THEN
                    true
                WHEN '2162001' THEN
                    true
            END;

        IF l_estado THEN
            SELECT
                '5-'
                || cef.id_banco
                || '-'
                || coalesce(mp.id_mediopago, '00')
                || '-'
                || a.numero
                || '-'
                || to_char(a.fecha, 'DD/MM/YYYY')
                || '-'
                || 'TL-'
                || substr(l_glosa, 8, 34)
            INTO STRICT l_glosa
            FROM
                     caja_pago a
                INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                INNER JOIN caja_pago_gasto         cpg ON cpg.id_pago = a.id_pago
                LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                           AND mp.id_mediopago IN( '005', '006' )
            WHERE
                cpg.id_pgasto = l_id_origen;

        END IF;

    ELSIF l_id_tipo_origen = '8' THEN
        --PAGO COMPRAS 
        l_estado :=
            CASE l_cuenta
                WHEN '1112001' THEN
                    true
                WHEN '1112025' THEN
                    true
                WHEN '2162001' THEN
                    true
            END;

        IF l_estado THEN
            SELECT
                cef.id_banco
                || '-'
                || coalesce(mp.id_mediopago, '00')
                || '-'
                || a.numero
                || '-'
                || to_char(a.fecha, 'DD/MM/YYYY')
                || '-'
                || 'TL-'
                || substr(l_glosa, 8, 34)
            INTO STRICT l_glosa
            FROM
                     caja_pago a
                INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                INNER JOIN caja_pago_compra        cpc ON cpc.id_pago = a.id_pago
                LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                           AND mp.id_mediopago IN( '005', '006' )
            WHERE
                cpc.id_pcompra = l_id_origen;

        ELSE
            l_estado :=
                CASE l_cuenta
                    WHEN '2130101' THEN
                        true
                    ELSE false
                END;
            IF l_estado THEN
                SELECT
                    fc_ruc_proveedor(cpc.id_proveedor)
                    || '/'
                    || coalesce(c.serie, cs.serie)
                    || '-'
                    || lpad(coalesce(c.numero, cs.numero), 8, '0')
                    || '/'
                    || substr(fc_nombre_cliente(cpc.id_proveedor), 0, 25)
                INTO STRICT l_glosa
                FROM
                    caja_pago_compra cpc
                    LEFT JOIN compra           c ON c.id_compra = cpc.id_compra
                    LEFT JOIN compra_saldo     cs ON cs.id_saldo = cpc.id_saldo
                WHERE
                    cpc.id_pcompra = l_id_origen;

            END IF;

        END IF;

    ELSIF l_id_tipo_origen = '9' THEN
        l_glosa := '9999';
    ELSIF l_id_tipo_origen = '11' THEN
        --DETRACCION
            
               l_estado :=
                CASE l_cuenta
                    WHEN '1112001' THEN  true
                     WHEN '1112025' THEN  true
                      WHEN '2162001' THEN  true
                    ELSE false
                END;

        IF l_estado THEN
            SELECT
                cef.id_banco
                || '-'
                || coalesce(mp.id_mediopago, '00')
                || '-'
                || a.nro_operacion
                || '-'
                || to_char(a.fecha_emision, 'DD/MM/YYYY')
                || '-'
                || 'Ruc:'
                || fc_ruc_proveedor(a.id_proveedor) glosa
            INTO STRICT l_glosa
            FROM
                     caja_detraccion a
                INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                           AND mp.id_mediopago IN( '005', '006' )
            WHERE
                a.id_detraccion = l_id_origen;

        ELSE
            SELECT
                'DET-'
                || a.nro_operacion
                || '/'
                || fc_ruc_proveedor(a.id_proveedor)
                || '/'
                || coalesce(c.serie, cs.serie)
                || '-'
                || lpad(coalesce(c.numero, cs.numero), 8, '0')
                || '/'
                || substr(cdc.detalle, 36)
            INTO STRICT l_glosa
            FROM
                     caja_detraccion a
                INNER JOIN caja_detraccion_compra cdc ON cdc.id_detraccion = a.id_detraccion
                LEFT JOIN compra                 c ON c.id_compra = cdc.id_compra
                LEFT JOIN compra_saldo           cs ON cs.id_saldo = cdc.id_saldo
            WHERE
                a.id_detraccion = l_id_origen;

        END IF;

    ELSIF l_id_tipo_origen = '12' THEN
     --RETENCION
   l_estado :=
                CASE l_cuenta
                    WHEN '1112001' THEN  true
                     WHEN '1112025' THEN  true
                      WHEN '2162001' THEN  true
                    ELSE false
                END;

        IF l_estado THEN
            SELECT
                '00-'
                || coalesce(mp.id_mediopago, '00')
                || '-'
                || a.nro_retencion
                || '-'
                || a.fecha_emision
                || '-TL-'
                || 'PAGO RET. '
                || a.nro_retencion
                || ' '
                || substr(fc_nombre_cliente(a.id_proveedor), 25)
            INTO STRICT l_glosa
            FROM
                caja_retencion a
                LEFT JOIN medio_pago     mp ON mp.id_mediopago = a.id_mediopago
                                           AND mp.id_mediopago IN( '005', '006' )
            WHERE
                a.id_retencion = l_id_origen;

        ELSe

                
              l_estado :=
                CASE(l_cuenta||'/'||l_cuenta_cte)
                    WHEN '2130390/1' THEN  true 
                    ELSE false
                END;

            IF l_estado THEN
                SELECT
                    'RET/'
                    || a.serie
                    || '-'
                    || lpad(a.nro_retencion, 8, '0')
                    || '/'
                    || fc_ruc_proveedor(a.id_proveedor)
                    || '/'
                    || coalesce(c.serie, cs.serie)
                    || '-'
                    || lpad(coalesce(c.numero, cs.numero), 8, '0')
                    || '/'
                    || substr(fc_nombre_cliente(a.id_proveedor), 25)
                INTO STRICT l_glosa
                FROM
                         caja_retencion a
                    INNER JOIN caja_retencion_compra crc ON crc.id_retencion = a.id_retencion
                    LEFT JOIN compra                c ON c.id_compra = crc.id_compra
                    LEFT JOIN compra_saldo          cs ON cs.id_saldo = crc.id_saldo
                WHERE
                    a.id_retencion = l_id_origen;

            END IF;

        END IF;

    ELSIF l_id_tipo_origen = '15' THEN
        --VALES
   l_estado :=
                CASE l_cuenta
                    WHEN '1112001' THEN  true
                     WHEN '1112025' THEN  true
                      WHEN '2162001' THEN  true
                    ELSE false
                END;

        IF l_estado   THEN
            SELECT
                '15-'
                || cef.id_banco
                || '-'
                || coalesce(mp.id_mediopago, '00')
                || '-'
                || a.numero
                || '-'
                || to_char(a.fecha, 'DD/MM/YYYY')
                || '-'
                || 'TL-'
                || a.detalle glosa
            INTO STRICT l_glosa
            FROM
                     caja_vale a
                INNER JOIN caja_cuenta_bancaria    ccb ON ccb.id_ctabancaria = a.id_ctabancaria
                INNER JOIN caja_entidad_financiera cef ON cef.id_banco = ccb.id_banco
                LEFT JOIN medio_pago              mp ON mp.id_mediopago = a.id_mediopago
                                           AND mp.id_mediopago IN( '005', '006' )
            WHERE
                a.id_vale = l_id_origen;

        END IF;

    ELSE
        l_glosa := 'XXXX';
    END IF;

    RETURN( l_id_tipo_origen
             || '   - '
             || l_glosa );
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_nuevo_detalle_asiento ( p_id_asiento bigint ) FROM PUBLIC;

