-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_colp_deuda_campanha (P_ID_ASISTENTE_CAMPANHA bigint, P_ID_COLPORTOR bigint) RETURNS bigint AS $body$
DECLARE

l_monto decimal(10,2):=0.00;
l_total_vendido decimal(10,2):=0.00;
l_total_depositado decimal(10,2):=0.00;
l_contar integer:=0;

BEGIN

		SELECT ROUND(coalesce(SUM(COD.CANTIDAD * COD.PRECIO) + SUM(COD.CANTIDAD * COD.PRECIO)*(10/100),0),2) INTO STRICT l_total_vendido
		FROM COLP_OPERACION CO
		INNER JOIN COLP_OPERACION_DETALLE COD ON
			CO.ID_OPERACION = COD.ID_OPERACION
		WHERE CO.ID_ASISTENTE_CAMPANHA = P_ID_ASISTENTE_CAMPANHA AND CO.ID_COLPORTOR = P_ID_COLPORTOR AND CO.ID_TIPOOPERACION = 2 AND CO.ESTADO = '1';

		SELECT coalesce(round((SUM(DEP.MONTO))::numeric,2),0) INTO STRICT l_total_depositado
		FROM COLP_DEPOSITO_COLP DEP
		WHERE DEP.ID_ASISTENTE_CAMPANHA = P_ID_ASISTENTE_CAMPANHA AND DEP.ID_COLPORTOR = P_ID_COLPORTOR;

		l_monto:= l_total_vendido - l_total_depositado;

RETURN(l_monto);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_colp_deuda_campanha (P_ID_ASISTENTE_CAMPANHA bigint, P_ID_COLPORTOR bigint) FROM PUBLIC;

