-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.days360 ( p_start_date timestamp(0), p_end_date timestamp(0), p_rule_type char default 'F') RETURNS bigint AS $body$
DECLARE

  v_mm1    integer;
  v_dd1    integer;
  v_yyyy1  integer;
  v_mm2    integer;
  v_dd2    integer;
  v_yyyy2  integer;

BEGIN
  v_yyyy1 := (to_char(p_start_date,'yyyy'))::numeric;
  v_mm1   := (to_char(p_start_date,'mm'))::numeric;
  v_dd1   := (to_char(p_start_date,'dd'))::numeric;
  v_yyyy2 := (to_char(p_end_date,'yyyy'))::numeric;
  v_mm2   := (to_char(p_end_date,'mm'))::numeric;
  v_dd2   := (to_char(p_end_date,'dd'))::numeric;
  IF p_rule_type = 'F' THEN  --metodo EE.UU
     IF v_dd1 = 31 THEN v_dd1 := 30;END IF;
     IF v_mm1 = 2  AND v_dd1 = (to_char(((date_trunc('month',(p_start_date)::timestamp + interval '1 month'))::timestamp(0) - 1),'dd'))::numeric
          THEN v_dd1 := 30;END IF;
     IF v_dd2 = 31
          THEN IF v_dd1 < 30
                    THEN v_dd2 := 1;
                         v_mm2 := v_mm2 + 1;
                         IF v_mm2 = 13 THEN v_mm2 := 1;
                                            v_yyyy2 := v_yyyy2 +1;
                         END IF;
                    ELSE v_dd2 := 30;
               END IF;
     END IF;
     IF v_mm2 = 2  AND v_dd2 = (to_char(((date_trunc('month',(p_end_date)::timestamp + interval '1 month'))::timestamp(0) - 1),'dd'))::numeric
          THEN v_dd2 := 30;
               IF (v_dd1 < 30)
                   THEN v_dd2 := 1;
                        v_mm2 := 3;
               END IF;
     END IF;
     IF v_mm2 IN (4, 6, 9, 11) AND v_dd2 = 30
          AND v_dd1 < 30
          THEN v_dd2 := 1;
               v_mm2 := v_mm2 + 1;
     END IF;
  ELSIF p_rule_type = 'T' THEN  --metodo europeo
     IF v_dd1 = 31 THEN v_dd1 := 30;END IF;
     IF v_mm1 = 2  AND v_dd1 = (to_char(((date_trunc('month',(p_start_date)::timestamp + interval '1 month'))::timestamp(0) - 1),'dd'))::numeric
          THEN v_dd1 := 30;END IF;
     IF v_dd2 = 31 THEN v_dd2 := 30;END IF;
     IF v_mm2 = 2  AND v_dd2 = (to_char(((date_trunc('month',(p_end_date)::timestamp + interval '1 month'))::timestamp(0) - 1),'dd'))::numeric
          THEN v_dd2 := 30;END IF;
  ELSE RAISE EXCEPTION '%', '3VL Not Allowed Here' USING ERRCODE = '-20002';
  END IF;
  RETURN(v_yyyy2 - v_yyyy1) * 360
       + (v_mm2 - v_mm1) * 30
       + (v_dd2 - v_dd1);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.days360 ( p_start_date timestamp(0), p_end_date timestamp(0), p_rule_type char default 'F') FROM PUBLIC;

