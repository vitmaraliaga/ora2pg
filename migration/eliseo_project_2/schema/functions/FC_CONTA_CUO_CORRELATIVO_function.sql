-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE FUNCTION eliseo.fc_conta_cuo_correlativo (P_ID_TIPOORIGEN bigint, P_ID_MOV bigint, p_id_entidad bigint, p_id_anho bigint, p_id_mes bigint) RETURNS varchar AS $body$
DECLARE

L_NOMBRE varchar(100);
L_COD_AASI bigint;
L_CONTAR bigint;

BEGIN

	IF P_ID_TIPOORIGEN = 1 THEN
	   
	    SELECT max('M'||d.NUM_AASI) INTO STRICT L_NOMBRE FROM VW_CONTA_DIARIO d
		WHERE trim(both to_char(P_ID_TIPOORIGEN,'999'))||'-'||trim(both to_char(P_ID_MOV,'9999999999999999999')) = d.OBSERVACION
		AND d.ID_ENTIDAD = p_id_entidad
		AND d.ID_ANHO = p_id_anho
		AND d.ID_MES = p_id_mes
		AND d.ID_CUENTAAASI = 1132001
		AND d.ID_CUENTAAASI = p_id_entidad;
		
	ELSE
	
		SELECT count(1), max('M'||d.NUM_AASI), max(cod_aasi) INTO STRICT L_CONTAR, L_NOMBRE, L_COD_AASI FROM VW_CONTA_DIARIO d
		WHERE trim(both to_char(P_ID_TIPOORIGEN,'999'))||'-'||trim(both to_char(P_ID_MOV,'9999999999999999999')) = d.OBSERVACION
		AND d.ID_ENTIDAD = p_id_entidad
		AND d.ID_ANHO = p_id_anho
		AND d.ID_MES = p_id_mes
		AND d.ID_CUENTAAASI IN ( 2130101, 2130103, 2130107);
	
	   SELECT
            COUNT(1), max('M'||d.NUM_AASI)
            INTO STRICT L_CONTAR, L_NOMBRE
            FROM eliseo.vw_conta_diario d
            WHERE cod_aasi = L_COD_AASI
            AND trim(both to_char(P_ID_TIPOORIGEN,'999'))||'-'||trim(both to_char(P_ID_MOV,'9999999999999999999')) = d.OBSERVACION
            AND d.ID_ENTIDAD = p_id_entidad
			AND d.ID_ANHO = p_id_anho
			AND d.ID_MES = p_id_mes
			AND d.ID_CUENTAAASI IN ( 2130101, 2130103, 2130107);

		
		IF L_CONTAR = 0 THEN
                SELECT MAX('M'||A.CUO_CORRELATIVO ) INTO STRICT L_NOMBRE FROM CONTA_DIARIO_CUO_AUX A
                WHERE A.ID_ORIGEN = P_ID_MOV
                AND A.ID_TIPOORIGEN = P_ID_TIPOORIGEN;
        END IF;

   	END IF;

   
        RETURN(L_NOMBRE);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.fc_conta_cuo_correlativo (P_ID_TIPOORIGEN bigint, P_ID_MOV bigint, p_id_entidad bigint, p_id_anho bigint, p_id_mes bigint) FROM PUBLIC;

