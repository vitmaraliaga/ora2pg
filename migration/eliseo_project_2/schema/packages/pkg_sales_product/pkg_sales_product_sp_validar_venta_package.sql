-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_product,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_product_sp_validar_venta (P_ID_PERSONA bigint,P_ID_COMPROBANTE text,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_DOCUMENTO bigint :=0;
        L_CONTAR bigint;
        L_ID_TIPOVOUCHER bigint := 1;
        L_ID_TIPOASIENTO varchar(5);
        L_ID_PERSONA_CONTADOR bigint;
        l_id_comprobante_ref varchar(3);
        L_ERROR bigint := 0;
        L_MSGERROR varchar(200) := '';
        l_id_tipoasientodep varchar(5) := 'RV';

        
BEGIN
            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,P_ID_COMPROBANTE,P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                L_ERROR :=1;
                L_MSGERROR := 'Alto! El usuario no tiene asignado un punto de impresión para el tipo de documento: ' || P_ID_COMPROBANTE;
--                 GOTO SALIDA_RAPIDA;
            END IF;
            
            SELECT COUNT(1) INTO STRICT L_CONTAR FROM CONTA_VOUCHER_CONFIG
            WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ID_ANHO AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;

            IF L_CONTAR < 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: No existe tipo de Asiento (RV) ';
--                 GOTO SALIDA_RAPIDA;
            ELSIF L_CONTAR > 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: Existe más de una configuración de Tipo de Asiento (RV) '||P_ID_ANHO::text;
--                 GOTO SALIDA_RAPIDA;
            END IF;

            SELECT ID_TIPOASIENTO INTO STRICT L_ID_TIPOASIENTO FROM CONTA_VOUCHER_CONFIG
            WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ID_ANHO AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;
            
            SELECT   COUNT(1) INTO STRICT L_CONTAR FROM CONTA_VOUCHER_CONFIG
            WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO
            AND ID_MODULO = '13'--modulo ventas
            AND ID_ANHO = P_ID_ANHO AND ID_TIPOASIENTO = L_ID_TIPOASIENTO
            AND AUTOMATICO = 'S' AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;

            IF L_CONTAR < 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: No existe la configuración de vouchers para las ventas, del periodo '||P_ID_ANHO::text||' - '||P_ID_ENTIDAD||' - '||P_ID_DEPTO||' - '||L_ID_TIPOASIENTO||' - '||L_ID_TIPOVOUCHER;
--                 GOTO SALIDA_RAPIDA;
            ELSIF L_CONTAR > 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: Existe más de una configuración de vouchers para las ventas, del periodo '||P_ID_ANHO::text;
--                 GOTO SALIDA_RAPIDA;
            END IF;

            SELECT ID_PERSONA INTO STRICT L_ID_PERSONA_CONTADOR FROM FIN_CONTADOR_DEPTO WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO;

            IF coalesce(L_ID_PERSONA_CONTADOR::text, '') = '' THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: No existe asignado un contador para la entidad: ' || P_ID_ENTIDAD || ' y el departamento: ' || P_ID_DEPTO;
--                 GOTO SALIDA_RAPIDA;
            END IF;

            L_CONTAR := pkg_sales_fc_verificar_serie_numero(P_ID_PERSONA,P_ID_COMPROBANTE,P_ID_ENTIDAD, P_ID_DEPTO,L_ID_COMPROBANTE_REF);
            IF L_CONTAR < 1 THEN
                L_ERROR := 1;
                L_MSGERROR := 'Alto! No existe un punto de impresión activo de transferencias para el usuario. [tipo de documento: '||P_ID_COMPROBANTE||']';
--                 GOTO SALIDA_RAPIDA;
            ELSIF L_CONTAR > 1 THEN
                L_ERROR := 1;
                L_MSGERROR := 'Alto! Existe mas de un punto de impresión activo de transferencias para el usuario. [tipo de documento: '||P_ID_COMPROBANTE||']';
--                 GOTO SALIDA_RAPIDA;
            END IF;

            ---vouvher dep
            SELECT COUNT(1) INTO STRICT L_CONTAR FROM CONTA_VOUCHER_CONFIG
            WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ID_ANHO AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;

            IF L_CONTAR < 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: No existe tipo de Asiento (MB) ';
--                 GOTO SALIDA_RAPIDA;
            ELSIF L_CONTAR > 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: Existe más de una configuración de Tipo de Asiento (MB) '||P_ID_ANHO::text;
--                 GOTO SALIDA_RAPIDA;
            END IF;

            L_ID_TIPOVOUCHER := 5;--tipo voucher de depósitos
             SELECT ID_TIPOASIENTO INTO STRICT l_id_tipoasientodep FROM CONTA_VOUCHER_CONFIG
             WHERE ID_ENTIDAD = P_ID_ENTIDAD
             AND ID_DEPTO = P_ID_DEPTO
             AND ID_ANHO = P_ID_ANHO
             AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;

            SELECT  COUNT(1) INTO STRICT L_CONTAR FROM CONTA_VOUCHER_CONFIG
            WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO
            AND ID_MODULO = '14'--modulo tesoreria
            AND ID_ANHO = P_ID_ANHO AND ID_TIPOASIENTO = L_ID_TIPOASIENTODEP
            AND AUTOMATICO = 'S' AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;

            IF L_CONTAR < 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: No existe la configuración de vouchers para los depositos, del periodo '||P_ID_ANHO::text;
--                 GOTO SALIDA_RAPIDA;
            ELSIF L_CONTAR > 1 THEN
                L_ERROR:=1;
                L_MSGERROR:='Alto: Existe más de una configuración de vouchers para los Depositos, del periodo '||P_ID_ANHO::text;
--                 GOTO SALIDA_RAPIDA;
            END IF;

--         <<SALIDA_RAPIDA>>
        
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_product_sp_validar_venta (P_ID_PERSONA bigint,P_ID_COMPROBANTE text,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
