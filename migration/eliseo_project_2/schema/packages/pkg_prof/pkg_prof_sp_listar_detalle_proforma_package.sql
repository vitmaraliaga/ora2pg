-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_prof,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_prof_sp_listar_detalle_proforma (P_ID_PROFORMA bigint,P_DC text,OUT CURSOR REFCURSOR ) AS $body$
BEGIN

        OPEN CURSOR FOR 
          WITH RECURSIVE cte AS (
SELECT 
            x.id_criterio,x.id_parent,x.nombre,x.importe,x.dc,x.codigo,x.orden,x.tipo,x.ver_hijo,1 as nivel
          from(
            SELECT
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            --(case when a.dc = 'C' AND b.codigo in('DSCTOCP','DSCTOCPCA') then 'X' else a.dc end) as tipo --Mostraba Cobranza Suspendida
            (case when a.dc = 'C' AND b.codigo in ('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and coalesce(b.id_parent::text, '') = ''
            and coalesce(b.ver_hijo,'N')='N' 
            
union

            select 
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            (case when a.dc = 'C' AND b.codigo in ('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and coalesce(b.id_parent::text, '') = ''
            and coalesce(b.ver_hijo,'N')='S' 
            
union

            select 
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            (case when a.dc = 'C' AND b.codigo in ('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and coalesce(b.id_parent,0) in (
              select  
              b.id_criterio
              from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
              where a.id_criterio_semestre=b.id_criterio_semestre
              and a.ID_PROFORMA=P_ID_PROFORMA
              and a.dc like '%'||P_DC||'%'
              and coalesce(b.id_parent::text, '') = ''
              and coalesce(b.ver_hijo,'N')='S' 
            ) 
            order by orden
          )x WHERE coalesce(x.id_parent::text, '') = ''
  UNION ALL
SELECT 
            x.id_criterio,x.id_parent,x.nombre,x.importe,x.dc,x.codigo,x.orden,x.tipo,x.ver_hijo,(c.level+1) as nivel
          from(
            SELECT
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            
            (case when a.dc = 'C' AND b.codigo in ('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and coalesce(b.id_parent::text, '') = ''
            and coalesce(b.ver_hijo,'N')='N' 
            
union

            select 
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            (case when a.dc = 'C' AND b.codigo in ('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and coalesce(b.id_parent::text, '') = ''
            and coalesce(b.ver_hijo,'N')='S' 
            
union

            select 
            b.id_criterio,
            b.id_parent,
            b.nombre,
            a.importe,
            a.dc,
            b.codigo,
            b.orden,
            b.ver_hijo,
            (case when a.dc = 'C' AND b.codigo in ('DSCTOCP','DSCTOCPCA') then a.dc else a.dc end) as tipo
            from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
            where a.id_criterio_semestre=b.id_criterio_semestre
            and a.ID_PROFORMA=P_ID_PROFORMA
            and a.dc like '%'||P_DC||'%'
            and coalesce(b.id_parent,0) in (
              select  
              b.id_criterio
              from eliseo.PRO_PROFORMA_det a, eliseo.vw_mat_criterio_semestre  b
              where a.id_criterio_semestre=b.id_criterio_semestre
              and a.ID_PROFORMA=P_ID_PROFORMA
              and a.dc like '%'||P_DC||'%'
              and coalesce(b.id_parent::text, '') = ''
              and coalesce(b.ver_hijo,'N')='S' 
            ) 
            order by orden
          )x JOIN cte c ON (c.id_criterio = coalesce(x.id_parent,0))

) SELECT * FROM cte ORDER BY hierarchy;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_prof_sp_listar_detalle_proforma (P_ID_PROFORMA bigint,P_DC text,OUT CURSOR REFCURSOR ) FROM PUBLIC;
