-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_facturacion_1,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_facturacion_1_fc_nota_debito (P_ID_VENTA bigint) RETURNS varchar AS $body$
DECLARE

        S_DETALLE       varchar(4000);
        S_VENTA         varchar(4000);
        S_CONTA         integer;
        S_ID_RUC      varchar(20);

        VENTA CURSOR FOR
    SELECT 'CD'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'08'||
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
		'|'||S_ID_RUC|| 
		'|'||CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END || 
    '|'||coalesce(eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
    '|'||eliseo.FC_NOMBRE_PERSONA(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		'|'||REGEXP_REPLACE(coalesce(trim(both pkg_sales_facturacion_fc_cliente_direccion(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Sin Direccion'),'-','', 'g')||
		'|'||''|| 
		-- '|'||trim(eliseo.FC_EMAIL(A.ID_CLIENTE))|| 
        '|'||trim(both coalesce(FC_EMAIL(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.INAFECTA = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END) END ||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.EXONERADA = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END) END ||
		'|'||'0.00'|| 
		'|'||CASE WHEN b.id_tipoigv='40' THEN CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END   ELSE '0.00' END ||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.GRAVADA = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.TOTAL = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.DESCUENTO = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
		'|'||'0.00'||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN A.TOTAL = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
        '|'||'1000'|| 
        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
        '|'||CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '01'  ELSE '03' END || 
        '|'||a.serie_ref||'-'||a.numero_ref|| 
        '|'||'01'|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA   
        AND A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       
UNION ALL
 
 SELECT  'DD'||	'|'||ROWNUM||
			'|'||''|| 
            (SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
			-- '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM ELISEO.INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
            '|86121503'|| 
			'|'||'NIU'|| 
			'|'||b.cantidad|| 
			'|'||coalesce(b.detalle,'Venta')|| 
	    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN B.PRECIO_BASE = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN B.PRECIO = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN B.IGV = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
			'|'||b.ID_TIPOIGV|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN B.BASE = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN B.IGV = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN B.DESCUENTO >0 THEN TO_CHAR(B.BASE,'999999,9999.99') ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.BASE_ME,'999999,9999.99') ELSE '0.00' END) END ||    
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,0))::numeric,2),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,0))::numeric,2),'9999999990D99')),',','.') END) END || 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN B.DESCUENTO = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN B.IMPORTE = 0 THEN '0.00' WHEN B.IMPORTE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999990D99')),',','.') END) END ||			
			'|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;

     /*   SELECT 
                'CC'||'|'||'0101'||'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||'|'||A.ID_COMPROBANTE||'|'||A.SERIE||'-'||LPAD(A.NUMERO,8,0)||'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')||'|'||FC_EMPRESA_RUC(A.ID_ENTIDAD)||'|'||
                DECODE(FC_COMPROBANTE_VENTA(A.ID_VENTA),'01','6','1')||'|'||DECODE(FC_COMPROBANTE_VENTA(A.ID_VENTA),'01',pkg_purchases_fc_ruc(A.ID_CLIENTE),FC_DOCUMENTO_CLIENTE(A.ID_CLIENTE))||'|'||
                INITCAP(FC_NOMBRE_PERSONA(A.ID_CLIENTE))||'|'||pkg_sales_facturacion_fc_cliente_direccion(A.ID_CLIENTE)||'|'||FC_PHONO(A.ID_CLIENTE)||'|'||FC_EMAIL(A.ID_CLIENTE)||'||||||'||
                REPLACE(FC_FORMATO_IMPORTE(A.IGV),',','.')||'|'||REPLACE(ABS(FC_FORMATO_IMPORTE(A.GRAVADA)),',','.')||'|'||REPLACE(FC_FORMATO_IMPORTE(A.IGV),',','.')||'|'||'0.00'||'|'||'0.00'||'|'||
                TO_CHAR(A.INAFECTA,'FM999999999990.00')||'|'||TO_CHAR(A.EXONERADA,'FM999999999990.00')||'|'||TO_CHAR(A.GRATUITA,'FM999999999990.00')||'|'||'0.00'||'|'||'0.00'||'|'||'0.00'||'|'||
                TO_CHAR(NVL(A.IMPORTE_ADESCONTAR,A.GRAVADA),'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_PORCENTAJE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_GLOBAL,0),'FM999999999990.00')||'|'||
                TO_CHAR(A.GRAVADA,'FM999999999990.00')||'|'||TO_CHAR(A.TOTAL,'FM999999999990.00')||'|'||TO_CHAR(NVL(A.DESCUENTO_GLOBAL+A.DESCUENTO,0),'FM999999999990.00')||'|'||'0.00'||'|'||
                TO_CHAR(A.TOTAL,'FM999999999990.00')||'|'||A.ID_LEYENDA||'|'||DECODE(A.ID_LEYENDA,'1000',INITCAP(FC_NUMERO_TEXTO(ABS(A.TOTAL))),FC_LEYENDA(A.ID_LEYENDA))||DECODE(A.ID_MONEDA,7,' Soles',' Dolares')||'|'||
                NVL(FC_COMPROBANTE_VENTA(A.ID_PARENT),A.ID_COMPROBANTE_REF)||'|'||NVL(FC_SERIE_VENTA(A.ID_PARENT),A.SERIE_REF)||'-'||NVL(FC_NUMERO_VENTA(A.ID_PARENT),NUMERO_REF)||'|'||A.ID_TIPONOTA||'|||||'
                AS CAB
        FROM VENTA A
        WHERE A.ID_VENTA = P_ID_VENTA
        AND A.ESTADO = '1'
        UNION ALL
        SELECT 
                'DC'||'|'||ITEM||'|'||FC_CODIGO_ARTICULO(B.ID_ARTICULO,'1')||'|'||FC_CODIGO_ARTICULO(B.ID_ARTICULO,'2')||'|'||NVL(FC_CODIGO_UNIDAD(B.ID_ALMACEN,B.ID_ARTICULO),'ZZ')||'|'||NVL(B.CANTIDAD,1)||'|'||
                NVL(pkg_inventories_fc_articulo(B.ID_ARTICULO),B.DETALLE)||'|'||TO_CHAR(NVL(B.PRECIO_BASE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IGV,0),'FM999999999990.00')||'|'||B.ID_TIPOIGV||'|'||TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IGV,0),'FM999999999990.00')||'|0.00|0.00|0.00||'||'0.00|0.00|0.00|'||
                TO_CHAR(NVL(B.IMPORTE_ADESCONTAR,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.DESCUENTO_PORCENTAJE,0),'FM999999999990.00')||'|'||TO_CHAR(NVL(B.DESCUENTO,0),'FM999999999990.00')||'|'||
                TO_CHAR(NVL(B.IMPORTE,0),'FM999999999990.00')||'|||'
                AS DET
        FROM VENTA A, VENTA_DETALLE B
        WHERE A.ID_VENTA = B.ID_VENTA
        AND A.ID_VENTA = P_ID_VENTA
        AND A.ESTADO = '1';*/
BEGIN  
        S_CONTA:=0;

        SELECT COALESCE(MAX(M.ID_RUC),'') INTO STRICT S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
        WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
        AND E.ID_EMPRESA = M.ID_EMPRESA
        AND V.ID_VENTA = P_ID_VENTA;

        open VENTA;
        fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
            END IF;

            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	

        RETURN(S_DETALLE);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_facturacion_1_fc_nota_debito (P_ID_VENTA bigint) FROM PUBLIC;
