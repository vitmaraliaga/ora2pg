-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_valida_gen_presupuesto (P_ID_EVENTO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='';
      l_contar bigint;
      l_contar1 bigint;
      l_msg varchar(200):='';

BEGIN
       
        
        SELECT COUNT(*) INTO STRICT l_contar
        FROM PSTO_ACTIVIDAD 
        WHERE ID_EVENTO=P_ID_EVENTO
        AND coalesce(ID_DEPTO::text, '') = '';

        /*if l_contar>0 then  -- Ahora se asigna al momento de generar presupuesto
         l_error:=1;
         l_msgerror:='Falta asignar departamento. ';
        end if;*/
       
        SELECT COUNT(*) INTO STRICT l_contar
        FROM PSTO_ACTIVIDAD 
        WHERE ID_EVENTO=P_ID_EVENTO
        AND (coalesce(ID_TIPOPLAN::text, '') = '' OR coalesce(ID_CUENTAAASI::text, '') = '' OR coalesce(ID_RESTRICCION::text, '') = '');

        if l_contar>0 then
         l_error:=1;
         l_msgerror:=l_msgerror||'Falta asignar cuenta contable denominacional. ';
        end if;

        SELECT COUNT(*) INTO STRICT l_contar
        FROM PSTO_ACTIVIDAD 
        WHERE ID_EVENTO=P_ID_EVENTO;

        SELECT COUNT(*) INTO STRICT l_contar1
        FROM PSTO_ACTIVIDAD 
        WHERE ID_ACTIVIDAD IN (
          SELECT A.ID_ACTIVIDAD FROM PSTO_ACTIVIDAD A, PSTO_ACTIVIDAD_DIST B
          WHERE A.ID_ACTIVIDAD=B.ID_ACTIVIDAD
          AND A.ID_EVENTO=P_ID_EVENTO
          GROUP BY A.ID_ACTIVIDAD
        );

        if l_contar<>l_contar1 then
          l_error:=1;
          l_msgerror:=l_msgerror||'Falta asignar distribuci√≥n mensual. ';
        end if;

       P_ERROR:=l_error;
       P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_valida_gen_presupuesto (P_ID_EVENTO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
