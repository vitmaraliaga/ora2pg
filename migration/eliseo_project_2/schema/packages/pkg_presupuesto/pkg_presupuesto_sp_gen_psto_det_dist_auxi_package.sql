-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_gen_psto_det_dist_auxi (P_ID_PRESUPUESTO bigint) AS $body$
DECLARE


      l_id_actividad bigint;
      l_tipo_dist varchar(10);
      l_total decimal(10,2);
      l_importe decimal(10,2);
      l_totalA decimal(10,2);
      l_totalB decimal(10,2);
      l_meses bigint;
      l_id_presupuesto_det bigint;

      cur CURSOR FOR 
      SELECT  ID_PRESUPUESTO_DET 
      FROM PSTO_PRESUPUESTO_DET 
      WHERE ID_PRESUPUESTO=P_ID_PRESUPUESTO 
      AND COALESCE(TOTAL,0)<>0 
      ORDER BY ID_PRESUPUESTO_DET;

    
BEGIN
       
      
      DELETE FROM PSTO_PRESUPUESTO_DET_DIST WHERE ID_PRESUPUESTO=P_ID_PRESUPUESTO;

      OPEN cur;
          FETCH cur INTO l_id_presupuesto_det;

          WHILE cur%FOUND LOOP
      
            SELECT A.ID_ACTIVIDAD,B.TIPO_DIST,A.TOTAL,A.A,A.B
            INTO STRICT l_id_actividad,l_tipo_dist,l_total,l_totalA,l_totalB
            FROM PSTO_PRESUPUESTO_DET A ,PSTO_ACTIVIDAD B
            WHERE A.ID_ACTIVIDAD=B.ID_ACTIVIDAD
            AND A.ID_PRESUPUESTO_DET=l_id_presupuesto_det 
            AND A.ID_PRESUPUESTO=P_ID_PRESUPUESTO;

            ---PRIMER SEMESTRE
            select count(*) INTO STRICT l_meses from PSTO_ACTIVIDAD_DIST WHERE ID_ACTIVIDAD=l_id_actividad AND ID_MES IN (1,2,3,4,5,6);
            
            if l_tipo_dist='PR' then
              l_importe:=l_totalA/l_meses;
            end if;

            INSERT INTO PSTO_PRESUPUESTO_DET_DIST(
            ID_PRESUPUESTO_DET,
            ID_PRESUPUESTO,
            ID_MES,
            IMPORTE,
            PORCENTAJE,
            MESES
            )
            SELECT 
            A.ID_PRESUPUESTO_DET,
            A.ID_PRESUPUESTO,
            B.ID_MES,
            CASE WHEN l_tipo_dist='PR' THEN l_importe ELSE  A.A*(B.PORCENTAJE/100) END AS IMPORTE,
            CASE WHEN l_tipo_dist='PO' THEN PORCENTAJE ELSE  0 END PORCENTAJE,
            CASE WHEN l_tipo_dist='PR' THEN l_meses ELSE  0 END
            FROM  PSTO_PRESUPUESTO_DET A, PSTO_ACTIVIDAD_DIST B 
            where A.ID_ACTIVIDAD=B.ID_ACTIVIDAD
            AND A.ID_PRESUPUESTO=P_ID_PRESUPUESTO
            AND A.ID_PRESUPUESTO_DET=l_id_presupuesto_det
            AND B.ID_MES IN (1,2,3,4,5,6) 
            ORDER BY B.ID_MES;

            ---SEGUNDO SEMESTRE
            select count(*) INTO STRICT l_meses from PSTO_ACTIVIDAD_DIST WHERE ID_ACTIVIDAD=l_id_actividad AND ID_MES IN (7,8,9,10,11,12);
            
            if l_tipo_dist='PR' then
              l_importe:=l_totalB/l_meses;
            end if;

            INSERT INTO PSTO_PRESUPUESTO_DET_DIST(
            ID_PRESUPUESTO_DET,
            ID_PRESUPUESTO,
            ID_MES,
            IMPORTE,
            PORCENTAJE,
            MESES
            )
            SELECT 
            A.ID_PRESUPUESTO_DET,
            A.ID_PRESUPUESTO,
            B.ID_MES,
            CASE WHEN l_tipo_dist='PR' THEN l_importe ELSE  A.B*(B.PORCENTAJE/100) END AS IMPORTE,
            CASE WHEN l_tipo_dist='PO' THEN PORCENTAJE ELSE  0 END PORCENTAJE,
            CASE WHEN l_tipo_dist='PR' THEN l_meses ELSE  0 END
            FROM  PSTO_PRESUPUESTO_DET A, PSTO_ACTIVIDAD_DIST B 
            where A.ID_ACTIVIDAD=B.ID_ACTIVIDAD
            AND A.ID_PRESUPUESTO=P_ID_PRESUPUESTO
            AND A.ID_PRESUPUESTO_DET=l_id_presupuesto_det
            AND B.ID_MES IN (7,8,9,10,11,12) 
            ORDER BY B.ID_MES;

        FETCH cur INTO l_id_presupuesto_det;

      END LOOP;
      CLOSE cur;
      
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_gen_psto_det_dist_auxi (P_ID_PRESUPUESTO bigint) FROM PUBLIC;
