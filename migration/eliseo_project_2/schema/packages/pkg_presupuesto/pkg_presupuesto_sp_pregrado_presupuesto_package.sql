-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_pregrado_presupuesto (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_PERSONA bigint,P_ID_PSTONEGOCIO bigint,P_ID_EJE bigint, P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;
    l_contact bigint;
    l_contact1 bigint;
    l_id_presupuesto bigint;
    l_id_evento bigint;
    l_descripcion varchar(300);
    l_total_ingreso decimal(10,2);
    l_total_gasto decimal(10,2);
    l_id_presupuesto_del bigint;
    l_identificador varchar(5);

BEGIN
  
   
    
    SELECT D.id_evento into STRICT l_id_evento
    FROM PSTO_PREGRADO_PROCESO_CONCEPTO A,
    PSTO_PREGRADO_CONCEPTO_PRECIO B,
    PSTO_PREGRADO_PROCESO C,
    PSTO_ACTIVIDAD D
    WHERE A.ID_CONCEPTO_PRECIO=B.ID_CONCEPTO_PRECIO
    AND A.ID_PREGRADO_PROCESO=C.ID_PREGRADO_PROCESO
    AND B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
    AND C.ID_ENTIDAD=P_ID_ENTIDAD
    AND C.ID_ANHO=P_ID_ANHO
    AND C.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
    AND B.ID_AUXILIAR=C.ID_AUXILIAR
    AND B.ID_AUXILIAR=P_ID_AUXILIAR
    GROUP BY D.id_evento;

    
    SELECT  NOMBRE INTO STRICT l_descripcion  FROM PSTO_EVENTO WHERE ID_EVENTO=l_id_evento;

    
    select 
      COUNT(*) INTO STRICT l_contar
      FROM PSTO_PREGRADO_PROCESO_CONCEPTO A,PSTO_PREGRADO_CONCEPTO_PRECIO B,PSTO_PREGRADO_PROCESO C,PSTO_ACTIVIDAD D
      WHERE A.ID_CONCEPTO_PRECIO=B.ID_CONCEPTO_PRECIO
      AND A.ID_PREGRADO_PROCESO=C.ID_PREGRADO_PROCESO
      AND B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
      AND (A.TOTAL_I+A.TOTAL_II)>0
      AND C.ID_ENTIDAD=P_ID_ENTIDAD
      AND C.ID_ANHO=P_ID_ANHO
      AND C.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
      AND B.ID_AUXILIAR=C.ID_AUXILIAR
      AND B.ID_AUXILIAR=P_ID_AUXILIAR
      AND (coalesce(COALESCE(D.ID_DEPTO,C.ID_DEPTO)::text, '') = '' OR coalesce(D.ID_TIPOPLAN::text, '') = '' OR coalesce(D.ID_CUENTAAASI::text, '') = '' OR coalesce(D.ID_RESTRICCION::text, '') = '');

    if l_contar>0 then
      l_error:=1;
      l_msgerror:='Falta asignar departamento ó cuenta contable denominacional a la actividad de evento '||l_descripcion;
    end if;

    if l_error=0 then
      SELECT COUNT(*) INTO STRICT l_contact
      FROM PSTO_ACTIVIDAD 
      WHERE ID_EVENTO=l_id_evento;

      SELECT COUNT(*) INTO STRICT l_contact1
      FROM PSTO_ACTIVIDAD 
      WHERE ID_ACTIVIDAD IN (
        SELECT A.ID_ACTIVIDAD FROM PSTO_ACTIVIDAD A, PSTO_ACTIVIDAD_DIST B
        WHERE A.ID_ACTIVIDAD=B.ID_ACTIVIDAD
        AND A.ID_EVENTO=l_id_evento
        GROUP BY A.ID_ACTIVIDAD
      );

      if l_contact<>l_contact1 then
        l_error:=1;
        l_msgerror:='Falta asignar distribución mensual. ';
      end if;
    end if;
    if l_error=0 then
      SELECT  COUNT(*) INTO STRICT l_contar FROM PSTO_PRESUPUESTO
      WHERE ID_EVENTO=l_id_evento
      AND ID_ENTIDAD=P_ID_ENTIDAD
      AND ID_ANHO=P_ID_ANHO
      AND ESTADO='2';

      
        
      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Ya esta aprobado presupuesto del evento '||l_descripcion||' para el año ' ||P_ID_ANHO::text;
      else

        
        SELECT  COUNT(*) INTO STRICT l_contar FROM PSTO_PRESUPUESTO 
        WHERE ID_EVENTO=l_id_evento
        AND ID_ENTIDAD=P_ID_ENTIDAD
        AND ID_ANHO=P_ID_ANHO
        AND ESTADO='1';

        IF l_contar>0 THEN
          SELECT ID_PRESUPUESTO into STRICT l_id_presupuesto_del FROM PSTO_PRESUPUESTO 
          WHERE ID_EVENTO=l_id_evento
          AND ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_ANHO=P_ID_ANHO
          AND ESTADO='1';

          CALL pkg_presupuesto_sp_eliminar_presupuesto(l_id_presupuesto_del,P_ID_PERSONA);

        END IF;

         SELECT COALESCE(MAX(ID_PRESUPUESTO),0)+1 INTO STRICT l_id_presupuesto FROM PSTO_PRESUPUESTO;
        --CABECERA
        insert into PSTO_PRESUPUESTO(
          ID_PRESUPUESTO,
          ID_ENTIDAD,
          ID_ANHO, 
          ID_EVENTO,
          ID_PSTONEGOCIO,
          ID_EJE,
          ID_DEPTO,
          ID_PERSONA,
          DESCRIPCION,
          FECHA, 
          ESTADO
        )values (
          l_id_presupuesto,
          P_ID_ENTIDAD,
          P_ID_ANHO,
          l_id_evento,
          P_ID_PSTONEGOCIO,
          P_ID_EJE,
          P_ID_DEPTO_PADRE,
          P_ID_PERSONA,
          l_descripcion,
          clock_timestamp(),
          '1'
        );

        --DETALLE
        INSERT INTO PSTO_PRESUPUESTO_DET(
            ID_PRESUPUESTO_DET,
            ID_PRESUPUESTO,
            ID_ACTIVIDAD,
            ID_ENTIDAD, 
            ID_DEPTO, 
            ID_DEPTO_ASIENTO,
            TIPO,
            DESCRIPCION,
            CANTIDAD,
            PUNIDAD,
            A, 
            B, 
            C,
            D, 
            E,
            F, 
            G,
            TOTAL,
            ID_TIPOPLAN,
            ID_CUENTAAASI,
            ID_RESTRICCION,
            ID_CTACTE,
            ID_TIPOCTACTE,
            ID_ENTIDAD_CTACTE
          )
        SELECT
            row_number() OVER () AS ID_PRESUPUESTO_DET, 
            l_id_presupuesto AS ID_PRESUPUESTO,
            M.ID_ACTIVIDAD,
            M.ID_ENTIDAD,
            M.ID_DEPTO,
            M.ID_DEPTO_ASIENTO,
            M.TIPO,
            M.DESCRIPCION,
            M.CANTIDAD,
            M.PUNIDAD,
            M.A,
            M.B,
            M.C, 
            M.D,
            M.E, 
            M.F,
            M.G,
            M.TOTAL,
            M.ID_TIPOPLAN,
            M.ID_CUENTAAASI,
            M.ID_RESTRICCION,
            M.ID_CTACTE,
            M.ID_TIPOCTACTE,
            M.ID_ENTIDAD_CTACTE
        FROM (
            SELECT 
            B.ID_ACTIVIDAD,
            C.ID_ENTIDAD,
            C.ID_DEPTO,
            COALESCE(D.ID_DEPTO,C.ID_DEPTO) AS ID_DEPTO_ASIENTO,
            D.TIPO,
            D.NOMBRE AS DESCRIPCION,
            0 AS CANTIDAD,
            0 AS PUNIDAD,
            SUM(COALESCE(A.TOTAL_I,0)) AS A,
            SUM(COALESCE(A.TOTAL_II,0)) AS B,
            0 AS C,
            0 AS D, 
            0  AS E, 
            0 AS  F,
            0 AS G,
            COALESCE(SUM(COALESCE(A.TOTAL_I,0)+COALESCE(A.TOTAL_II,0)),0) AS TOTAL,
            D.ID_TIPOPLAN,
            D.ID_CUENTAAASI,
            D.ID_RESTRICCION,
            D.ID_CTACTE,
            D.ID_TIPOCTACTE,
            D.ID_ENTIDAD_CTACTE
            FROM PSTO_PREGRADO_PROCESO_CONCEPTO A,PSTO_PREGRADO_CONCEPTO_PRECIO B,PSTO_PREGRADO_PROCESO C,PSTO_ACTIVIDAD D
            WHERE A.ID_CONCEPTO_PRECIO=B.ID_CONCEPTO_PRECIO
            AND A.ID_PREGRADO_PROCESO=C.ID_PREGRADO_PROCESO
            AND B.ID_ACTIVIDAD=D.ID_ACTIVIDAD
            AND (A.TOTAL_I+A.TOTAL_II)>0
            AND C.ID_ENTIDAD=P_ID_ENTIDAD
            AND C.ID_ANHO=P_ID_ANHO
            AND C.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
            AND B.ID_AUXILIAR=C.ID_AUXILIAR
            AND B.ID_AUXILIAR=P_ID_AUXILIAR
            GROUP BY B.ID_ACTIVIDAD,
            C.ID_ENTIDAD,
            C.ID_DEPTO,
            COALESCE(D.ID_DEPTO,C.ID_DEPTO),
            D.TIPO,
            D.NOMBRE,
            D.ID_TIPOPLAN,
            D.ID_CUENTAAASI,
            D.ID_RESTRICCION,
            D.ID_CTACTE,
            D.ID_TIPOCTACTE,
            D.ID_ENTIDAD_CTACTE 
            
        )M;

        
        MERGE INTO PSTO_PRESUPUESTO_DET C 
        USING(SELECT 
                A.ID_PRESUPUESTO,
                A.ID_PRESUPUESTO_DET,
                B.NOMBRE
                FROM PSTO_PRESUPUESTO_DET A,CONTA_ENTIDAD_DEPTO B
                WHERE A.ID_ENTIDAD=B.ID_ENTIDAD
                AND A.ID_DEPTO=B.ID_DEPTO
                AND A.ID_PRESUPUESTO=l_id_presupuesto
              )t
          ON (C.ID_PRESUPUESTO=t.ID_PRESUPUESTO and C.ID_PRESUPUESTO_DET=t.ID_PRESUPUESTO_DET and C.ID_PRESUPUESTO=l_id_presupuesto)
          WHEN  MATCHED THEN UPDATE SET  
            C.DEPTO_NOMBRE=t.NOMBRE;

        MERGE INTO PSTO_PRESUPUESTO_DET C 
        USING(SELECT 
                A.ID_PRESUPUESTO,
                A.ID_PRESUPUESTO_DET,
                B.NOMBRE
                FROM PSTO_PRESUPUESTO_DET A,CONTA_ENTIDAD_DEPTO B
                WHERE A.ID_ENTIDAD=B.ID_ENTIDAD
                AND A.ID_DEPTO_ASIENTO=B.ID_DEPTO
                AND A.ID_PRESUPUESTO=l_id_presupuesto
              )t
          ON (C.ID_PRESUPUESTO=t.ID_PRESUPUESTO and C.ID_PRESUPUESTO_DET=t.ID_PRESUPUESTO_DET and C.ID_PRESUPUESTO=l_id_presupuesto)
          WHEN  MATCHED THEN UPDATE SET  
            C.DEPTO_ASIENTO_NOMBRE=t.NOMBRE;

  
        select 
        coalesce(sum(case when tipo='I' then TOTAL else 0 end),0),
        coalesce(sum(case when tipo='G' then TOTAL else 0 end),0)
        into STRICT 
        l_total_ingreso,
        l_total_gasto
        from  PSTO_PRESUPUESTO_DET
        where ID_PRESUPUESTO=l_id_presupuesto;

        
        
        
        MERGE INTO PSTO_PRESUPUESTO_DET C 
        USING(SELECT 
                A.ID_PRESUPUESTO,
                A.ID_PRESUPUESTO_DET,
                A.TOTAL,
                A.A,
                A.B
                FROM PSTO_PRESUPUESTO_DET A,PSTO_ACTIVIDAD B
                WHERE A.ID_ACTIVIDAD=B.ID_ACTIVIDAD
                AND A.ID_PRESUPUESTO=l_id_presupuesto
                AND A.TIPO='I'
                AND COALESCE(B.ESDESCUENTO,'N')='S' 
              )t
        ON (C.ID_PRESUPUESTO=t.ID_PRESUPUESTO and C.ID_PRESUPUESTO_DET=t.ID_PRESUPUESTO_DET AND C.ID_PRESUPUESTO=l_id_presupuesto)
        WHEN  MATCHED THEN UPDATE SET 
        C.A = t.A*(-1),
        C.B = t.B*(-1),
        C.TOTAL = t.TOTAL*(-1);

        
        update PSTO_PRESUPUESTO set
        TOTAL_INGRESO=l_total_ingreso,
        TOTAL_GASTO=l_total_gasto
        where ID_PRESUPUESTO=l_id_presupuesto;

        SELECT IDENTIFICADOR INTO STRICT l_identificador  FROM PSTO_AUXILIAR WHERE ID_AUXILIAR=P_ID_AUXILIAR;

        
        IF l_identificador in ('RG','RE','PR') then
           CALL pkg_presupuesto_sp_gen_psto_det_dist_auxi(l_id_presupuesto);
        else
           CALL pkg_presupuesto_sp_gen_presupuesto_det_dist(l_id_presupuesto);
        end if;

       
        
        CALL pkg_presupuesto_sp_asiento_presupuesto(l_id_presupuesto,P_ID_PERSONA);

        select count(*) into STRICT l_contar from psto_auxiliar_anho
        where id_auxiliar=P_ID_AUXILIAR
        and id_anho=P_ID_ANHO;

        if l_contar=0 then
          insert into psto_auxiliar_anho(id_anho,id_auxiliar,estado) values (P_ID_ANHO,P_ID_AUXILIAR,'01');
        else
          update psto_auxiliar_anho set estado='01'
          where id_auxiliar=P_ID_AUXILIAR
          and id_anho=P_ID_ANHO;
        end if;

      end if;
    end if;

  
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_pregrado_presupuesto (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_PERSONA bigint,P_ID_PSTONEGOCIO bigint,P_ID_EJE bigint, P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
