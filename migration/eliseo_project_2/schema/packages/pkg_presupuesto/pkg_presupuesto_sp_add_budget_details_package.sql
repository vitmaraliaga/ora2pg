-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_add_budget_details (P_ID_PRESUPUESTO bigint,P_ID_ACTIVIDAD bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_DEPTO_ASIENTO text,P_DESCRIPCION text,P_CANTIDAD bigint,P_PUNIDAD bigint, P_A bigint, P_B bigint, P_C bigint, P_D bigint, P_E bigint, P_F bigint, P_G bigint) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='';
      l_contar bigint;
      l_id_presupuesto_det bigint;
      l_tipo varchar(2);
      l_id_evento bigint;
      l_formula varchar(300);
      l_total_ingreso decimal(10,2);
      l_total_gasto decimal(10,2);
      l_esdescuento varchar(2);
      l_depto varchar(10);
      l_nombre varchar(255);
      l_nombre_asiento varchar(255);
      l_id_tipoplan bigint;
      l_id_cuentaaasi varchar(10);
      l_id_restriccion varchar(50);
      l_id_ctacte varchar(50);
      l_id_tipoctacte varchar(10);
      l_id_entidad_ctacte bigint;


BEGIN
    
            
      SELECT COALESCE(MAX(ID_PRESUPUESTO_DET),0)+1 INTO STRICT l_id_presupuesto_det FROM PSTO_PRESUPUESTO_DET WHERE ID_PRESUPUESTO=P_ID_PRESUPUESTO;

      SELECT 
      TIPO,
      ID_EVENTO,coalesce(ESDESCUENTO,'N') ,
      ID_TIPOPLAN,
      ID_CUENTAAASI,
      ID_RESTRICCION,
      ID_CTACTE,
      ID_TIPOCTACTE,
      ID_ENTIDAD_CTACTE
      INTO STRICT l_tipo,
      l_id_evento,
      l_esdescuento,
      l_id_tipoplan,
      l_id_cuentaaasi,
      l_id_restriccion, 
      l_id_ctacte,
      l_id_tipoctacte,
      l_id_entidad_ctacte
      FROM  PSTO_ACTIVIDAD WHERE ID_ACTIVIDAD=P_ID_ACTIVIDAD;

      SELECT NOMBRE into STRICT l_nombre FROM CONTA_ENTIDAD_DEPTO WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO=P_ID_DEPTO;

      SELECT NOMBRE into STRICT l_nombre_asiento FROM CONTA_ENTIDAD_DEPTO WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO=P_ID_DEPTO_ASIENTO;

      INSERT INTO PSTO_PRESUPUESTO_DET(
        ID_PRESUPUESTO_DET,
        ID_PRESUPUESTO,
        ID_ACTIVIDAD,
        ID_ENTIDAD, 
        ID_DEPTO, 
        ID_DEPTO_ASIENTO,
        TIPO,
        DESCRIPCION,
        CANTIDAD,
        PUNIDAD,
        A, 
        B, 
        C,
        D, 
        E,
        F, 
        G,
        TOTAL,
        DEPTO_NOMBRE,
        DEPTO_ASIENTO_NOMBRE,
        ID_TIPOPLAN,
        ID_CUENTAAASI,
        ID_RESTRICCION,
        ID_CTACTE,
        ID_TIPOCTACTE,
        ID_ENTIDAD_CTACTE
      )VALUES (
        l_id_presupuesto_det,
        P_ID_PRESUPUESTO,
        P_ID_ACTIVIDAD,
        P_ID_ENTIDAD, 
        P_ID_DEPTO, 
        P_ID_DEPTO_ASIENTO,
        l_tipo,
        P_DESCRIPCION,
        P_CANTIDAD,
        P_PUNIDAD,
        P_A, 
        P_B, 
        P_C,
        P_D, 
        P_E,
        P_F, 
        P_G,
        0.00,
        l_nombre,
        l_nombre_asiento,
        l_id_tipoplan,
        l_id_cuentaaasi,
        l_id_restriccion, 
        l_id_ctacte,
        l_id_tipoctacte,
        l_id_entidad_ctacte
      );

      SELECT FORMULA INTO STRICT l_formula  FROM  PSTO_EVENTO WHERE ID_EVENTO=l_id_evento;

      if coalesce(l_formula::text, '') = '' then
        l_formula:='0';
      end if;

      EXECUTE 'UPDATE PSTO_PRESUPUESTO_DET SET TOTAL='||l_formula||' WHERE ID_PRESUPUESTO_DET=:DETALLE AND ID_PRESUPUESTO=:PRESUPUESTO'  
      USING l_id_presupuesto_det,P_ID_PRESUPUESTO;

      if l_esdescuento='S' and l_tipo='I' then
        UPDATE PSTO_PRESUPUESTO_DET SET TOTAL=(-1)*TOTAL 
        WHERE ID_PRESUPUESTO_DET=l_id_presupuesto_det 
        AND ID_PRESUPUESTO=P_ID_PRESUPUESTO;
     end if;

      select 
      coalesce(sum(case when tipo='I' then TOTAL else 0 end),0),
      coalesce(sum(case when tipo='G' then TOTAL else 0 end),0)
      into STRICT 
      l_total_ingreso,
      l_total_gasto
      from  PSTO_PRESUPUESTO_DET
      where ID_PRESUPUESTO=P_ID_PRESUPUESTO;

      update PSTO_PRESUPUESTO set
      TOTAL_INGRESO=l_total_ingreso,
      TOTAL_GASTO=l_total_gasto
      where ID_PRESUPUESTO=P_ID_PRESUPUESTO;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_add_budget_details (P_ID_PRESUPUESTO bigint,P_ID_ACTIVIDAD bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_DEPTO_ASIENTO text,P_DESCRIPCION text,P_CANTIDAD bigint,P_PUNIDAD bigint, P_A bigint, P_B bigint, P_C bigint, P_D bigint, P_E bigint, P_F bigint, P_G bigint) FROM PUBLIC;
