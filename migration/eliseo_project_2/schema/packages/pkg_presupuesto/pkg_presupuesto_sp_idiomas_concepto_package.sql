-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_idiomas_concepto (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

     l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;

BEGIN
    
        DELETE FROM PSTO_PREGRADO_PROCESO_CONCEPTO
        WHERE ID_PREGRADO_PROCESO IN (
          SELECT ID_PREGRADO_PROCESO FROM PSTO_PREGRADO_PROCESO
          WHERE ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_ANHO=P_ID_ANHO
          AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
          AND ID_AUXILIAR=P_ID_AUXILIAR	
        );

      INSERT INTO PSTO_PREGRADO_PROCESO_CONCEPTO(
              ID_PREGRADO_PROCESO, 
              ID_CONCEPTO_PRECIO, 
              IMPORTE_I, 
              IMPORTE_II, 
              TOTAL_I, 
              TOTAL_II
          )
          
        SELECT 
        A.ID_PREGRADO_PROCESO,
        B.ID_CONCEPTO_PRECIO,
        A.IMP_MAT AS IMPORTE_I, 
        A.IMP_MAT AS IMPORTE_II,
        A.IMP_MAT*TOTAL_ALUMNO_I AS TOTAL_I,
        A.IMP_MAT*TOTAL_ALUMNO_II AS TOTAL_II
        FROM  PSTO_PREGRADO_PROCESO A, PSTO_PREGRADO_CONCEPTO_PRECIO B
        WHERE  A.ID_ENTIDAD=B.ID_ENTIDAD
        AND A.ID_DEPTO_PADRE=B.ID_DEPTO_PADRE
        AND A.ID_ANHO=B.ID_ANHO
        AND A.ID_AUXILIAR=B.ID_AUXILIAR
        AND A.ID_ENTIDAD=P_ID_ENTIDAD
        AND A.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
        AND A.ID_ANHO=P_ID_ANHO
        AND A.ID_AUXILIAR=P_ID_AUXILIAR 
        AND B.TIPO='M'
        
UNION ALL

        SELECT 
        A.ID_PREGRADO_PROCESO,
        B.ID_CONCEPTO_PRECIO,
        A.CREDITO_2_5 AS IMPORTE_I, 
        A.CREDITO_2_5 AS IMPORTE_II,
        A.CREDITO_2_5*TOTAL_ALUMNO_I AS TOTAL_I,
        A.CREDITO_2_5*TOTAL_ALUMNO_II AS TOTAL_II
        FROM  PSTO_PREGRADO_PROCESO A, PSTO_PREGRADO_CONCEPTO_PRECIO B
        WHERE  A.ID_ENTIDAD=B.ID_ENTIDAD
        AND A.ID_DEPTO_PADRE=B.ID_DEPTO_PADRE
        AND A.ID_ANHO=B.ID_ANHO
        AND A.ID_AUXILIAR=B.ID_AUXILIAR
        AND A.ID_ENTIDAD=P_ID_ENTIDAD
        AND A.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
        AND A.ID_ANHO=P_ID_ANHO
        AND A.ID_AUXILIAR=P_ID_AUXILIAR
        AND B.TIPO='CA'
        
UNION ALL

        select 
        A.ID_PREGRADO_PROCESO,
        B.ID_CONCEPTO_PRECIO,
        A.CREDITO_1 AS IMPORTE_I, 
        A.CREDITO_1 AS IMPORTE_II,
        (A.CREDITO_1*TOTAL_ALUMNO_I)-((A.IMP_MAT*TOTAL_ALUMNO_I)+(A.CREDITO_2_5*TOTAL_ALUMNO_I)) AS TOTAL_I,
        (A.CREDITO_1*TOTAL_ALUMNO_II)-((A.IMP_MAT*TOTAL_ALUMNO_II)+(A.CREDITO_2_5*TOTAL_ALUMNO_II)) AS TOTAL_II
        FROM  PSTO_PREGRADO_PROCESO A, PSTO_PREGRADO_CONCEPTO_PRECIO B
        WHERE  A.ID_ENTIDAD=B.ID_ENTIDAD
        AND A.ID_DEPTO_PADRE=B.ID_DEPTO_PADRE
        AND A.ID_ANHO=B.ID_ANHO
        AND A.ID_AUXILIAR=B.ID_AUXILIAR
        AND A.ID_ENTIDAD=P_ID_ENTIDAD
        AND A.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
        AND A.ID_ANHO=P_ID_ANHO
        AND A.ID_AUXILIAR=P_ID_AUXILIAR 
        AND B.TIPO='E'
        ORDER BY A.ID_PREGRADO_PROCESO,
        B.ID_CONCEPTO_PRECIO;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_idiomas_concepto (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
