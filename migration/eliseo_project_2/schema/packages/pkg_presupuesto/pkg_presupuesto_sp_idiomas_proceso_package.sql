-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_presupuesto,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_presupuesto_sp_idiomas_proceso (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;

BEGIN
     
     SELECT COALESCE(MAX(ID_PREGRADO_PROCESO),0) INTO STRICT l_contar FROM PSTO_PREGRADO_PROCESO;

          
      INSERT INTO PSTO_PREGRADO_PROCESO(
      ID_PREGRADO_PROCESO,
      ID_ENTIDAD,
      ID_DEPTO,
      ID_ANHO,
      ID_DEPTO_PADRE,
      ID_EAP_DEPTO_AREA,
      ID_AUXILIAR,
      ARMADA, 
      IMP_MAT, --MATERIAL EDUCATIVO M
      CREDITO_1,--ENSEÃ‘NZA E
      CREDITO_2_5,--CUOTA ALUMNO CA
      TOTAL_ALUMNO_I,
      TOTAL_ALUMNO_II
      )
      SELECT 
        row_number() OVER () + l_contar AS ID_PREGRADO_PROCESO,
        P_ID_ENTIDAD, 
        ID_DEPTO,
        P_ID_ANHO,
        P_ID_DEPTO_PADRE,
        ID_EAP_DEPTO_AREA,
        P_ID_AUXILIAR,
        1,
        0,
        0,
        0,
        0,
        0
      FROM (
        SELECT
        ID_EAP_DEPTO_AREA,
        ID_DEPTO,
        ID_EAP
        FROM VW_DPTO_EAP 
        WHERE ID_TIPO_DEPTO='ID' 
        AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
        AND ID_ENTIDAD=P_ID_ENTIDAD
        AND ID_EAP_DEPTO_AREA NOT IN (
          SELECT ID_EAP_DEPTO_AREA FROM PSTO_PREGRADO_PROCESO
          WHERE ID_ENTIDAD=P_ID_ENTIDAD
          AND ID_ANHO=P_ID_ANHO
          AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
          AND ID_AUXILIAR=P_ID_AUXILIAR
        ) AND ESTADO='1' 
        ) alias2 
        ORDER BY ID_DEPTO,ID_EAP_DEPTO_AREA;

         CALL pkg_presupuesto_sp_idiomas_concepto(P_ID_ENTIDAD,P_ID_DEPTO_PADRE,P_ID_ANHO,P_ID_AUXILIAR,l_error,l_msgerror);

        
         MERGE INTO PSTO_PREGRADO_PROCESO C 
        USING(SELECT 
              X.ID_PREGRADO_PROCESO,
              M.ENSE_I,
              M.ENSE_II,
              M.MAT_I,
              M.MAT_II 
              FROM PSTO_PREGRADO_PROCESO X INNER JOIN(
                  SELECT 
                    SUM(CASE WHEN P.CONVOCA='M' THEN D.TOTAL_I ELSE 0 END) AS MAT_I,
                    SUM(CASE WHEN P.CONVOCA='M' THEN D.TOTAL_II ELSE 0 END) AS MAT_II,
                    SUM(CASE WHEN P.CONVOCA='E' THEN D.TOTAL_I ELSE 0 END) AS ENSE_I,
                    SUM(CASE WHEN P.CONVOCA='E' THEN D.TOTAL_II ELSE 0 END) AS ENSE_II,
                    P.ID_PREGRADO_PROCESO
                  FROM PSTO_PREGRADO_PROCESO P, PSTO_PREGRADO_PROCESO_CONCEPTO D
                  WHERE P.ID_PREGRADO_PROCESO=D.ID_PREGRADO_PROCESO
                  AND P.ID_ENTIDAD=P_ID_ENTIDAD
                  AND P.ID_ANHO=P_ID_ANHO
                  AND P.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
                  AND P.ID_AUXILIAR=P_ID_AUXILIAR	
                  GROUP BY P.ID_PREGRADO_PROCESO
                )M
               ON X.ID_PREGRADO_PROCESO=M.ID_PREGRADO_PROCESO 
               WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
               AND X.ID_ANHO=P_ID_ANHO
               AND X.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE 
               AND X.ID_AUXILIAR=P_ID_AUXILIAR	
            )t
        ON (C.ID_PREGRADO_PROCESO=t.ID_PREGRADO_PROCESO)
        WHEN  MATCHED THEN UPDATE SET  C.TOTAL_ENSE_I=t.ENSE_I,  C.TOTAL_ENSE_II=t.ENSE_II,C.TOTAL_MAT_I=t.MAT_I,C.TOTAL_MAT_II=t.MAT_II;

      P_ERROR:=l_error;
      P_MSGERROR:=l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_presupuesto_sp_idiomas_proceso (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint,P_ID_AUXILIAR bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
