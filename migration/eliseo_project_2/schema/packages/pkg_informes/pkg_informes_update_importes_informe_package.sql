-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_informes,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_informes_update_importes_informe (P_ID_INFORME bigint) AS $body$
DECLARE

        L_IMPORTE bigint;
        L_IMPORTE_ME bigint;
        L_IMPORTE_DOC bigint;
        L_IMPORTE_AYUDA bigint;
        L_IMPORTE_OBRERO bigint;
        L_ID_TIPOINFORME bigint;

BEGIN 
            SELECT ID_TIPOINFORME INTO STRICT L_ID_TIPOINFORME FROM ELISEO.INFORME WHERE ID_INFORME =P_ID_INFORME;
            IF L_ID_TIPOINFORME=1 THEN
                -- ACTUALIZAR TODOS
                SELECT coalesce(SUM(IMPORTE_DOC),0),coalesce(SUM(IMPORTE_AYUDA),0),coalesce(SUM(IMPORTE_OBRERO),0) 
                INTO STRICT L_IMPORTE_DOC,L_IMPORTE_AYUDA,L_IMPORTE_OBRERO
                FROM ELISEO.INFORME_AYUDA 
                WHERE ID_INFORME =P_ID_INFORME;

                UPDATE ELISEO.INFORME SET IMPORTE_DOC=L_IMPORTE_DOC,IMPORTE_AYUDA=L_IMPORTE_AYUDA,IMPORTE_OBRERO=L_IMPORTE_OBRERO 
                WHERE ID_INFORME=P_ID_INFORME;

                -- ACTUALIZAR SOLO APROBADOS
                SELECT coalesce(SUM(IMPORTE_DOC),0),coalesce(SUM(IMPORTE_AYUDA),0),coalesce(SUM(IMPORTE_OBRERO),0) 
                INTO STRICT L_IMPORTE_DOC,L_IMPORTE_AYUDA,L_IMPORTE_OBRERO
                FROM ELISEO.INFORME_AYUDA
                WHERE ID_INFORME =P_ID_INFORME AND ES_APROBADO ='1';

                UPDATE ELISEO.INFORME SET 
                	IMPORTE_DOC_APROB=L_IMPORTE_DOC,
                	IMPORTE_AYUDA_APROB=L_IMPORTE_AYUDA,
                	IMPORTE_OBRERO_APROB=L_IMPORTE_OBRERO 
                WHERE ID_INFORME=P_ID_INFORME;
            ELSE
                -- ACTUALIZAR TODOS
                SELECT coalesce(SUM(X.IMPORTE),0),coalesce(SUM(X.IMPORTE_ME),0) INTO STRICT L_IMPORTE,L_IMPORTE_ME
                FROM (SELECT IMPORTE,IMPORTE_ME FROM ELISEO.INFORME_COMPRA  WHERE ID_INFORME =P_ID_INFORME
                    
UNION ALL

                    SELECT IMPORTE,IMPORTE_ME FROM ELISEO.INFORME_GASTO WHERE ID_INFORME =P_ID_INFORME) X;

                UPDATE ELISEO.INFORME SET IMPORTE_DOC=L_IMPORTE,IMPORTE_DOC_ME=L_IMPORTE_ME
                WHERE ID_INFORME=P_ID_INFORME;

               	-- ACTUALIZAR SOLO APROBADOS
               	SELECT coalesce(SUM(X.IMPORTE),0),coalesce(SUM(X.IMPORTE_ME),0) INTO STRICT L_IMPORTE,L_IMPORTE_ME 
                FROM (SELECT IMPORTE,IMPORTE_ME FROM ELISEO.INFORME_COMPRA  WHERE ID_INFORME =P_ID_INFORME AND ES_APROBADO ='1'
                    
UNION ALL

                    SELECT IMPORTE,IMPORTE_ME FROM ELISEO.INFORME_GASTO WHERE ID_INFORME =P_ID_INFORME AND ES_APROBADO ='1') X;

                UPDATE ELISEO.INFORME SET IMPORTE_DOC_APROB=L_IMPORTE,IMPORTE_DOC_ME_APROB=L_IMPORTE_ME
                WHERE ID_INFORME=P_ID_INFORME;
            END IF;

         END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_informes_update_importes_informe (P_ID_INFORME bigint) FROM PUBLIC;
