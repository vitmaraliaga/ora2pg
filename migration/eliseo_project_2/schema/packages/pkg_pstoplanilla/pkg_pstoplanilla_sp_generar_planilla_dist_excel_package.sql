-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_planilla_dist_excel (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_NUM_DOC text,P_ID_DEPTO text,P_PORCENTAJE bigint,P_TIPO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


    --P_ID_PSTO_PLANILLA numeric,P_ID_DEPTO varchar,P_ID_TEMPORADA varchar,P_PORCENTAJE numeric,P_TIPO varchar,P_ERROR OUT numeric,P_MSGERROR out varchar
          P_ID_PSTO_PLANILLA bigint;
          P_ID_TEMPORADA varchar(5);

          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;
          l_contar1 bigint;

          l_id_entidad bigint;

 
        
BEGIN
        
        l_id_entidad:=P_ID_ENTIDAD;

        SELECT COUNT(*) INTO STRICT l_contar FROM PSTO_PLLA_PLANILLA
        WHERE ID_ENTIDAD=l_id_entidad
        AND ID_ANHO=P_ID_ANHO
        AND ID_DEPTO_PADRE=SUBSTR(P_ID_DEPTO,1,1)
        AND ID_PERSONA IN (
          SELECT ID_PERSONA FROM PERSONA_DOCUMENTO WHERE NUM_DOCUMENTO=P_NUM_DOC
        );

        IF l_contar=1 THEN
        
          SELECT ID_PSTO_PLANILLA,ID_TEMPORADA INTO STRICT P_ID_PSTO_PLANILLA,P_ID_TEMPORADA FROM PSTO_PLLA_PLANILLA
          WHERE ID_ENTIDAD=l_id_entidad
          AND ID_ANHO=P_ID_ANHO
          AND ID_DEPTO_PADRE=SUBSTR(P_ID_DEPTO,1,1)
          AND ID_PERSONA IN (
            SELECT ID_PERSONA FROM PERSONA_DOCUMENTO WHERE NUM_DOCUMENTO=P_NUM_DOC
          );

          SELECT COUNT(*) INTO STRICT l_contar FROM PSTO_PLLA_PLANILLA_DIST
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
          AND ID_DEPTO=P_ID_DEPTO
          AND ID_ENTIDAD=l_id_entidad;

          select COUNT(*) INTO STRICT l_contar1 from vw_area_depto where id_entidad=l_id_entidad and ID_DEPTO=P_ID_DEPTO;

          IF l_contar=0 and l_contar1=1 THEN
          
            CALL pkg_pstoplanilla_sp_generar_planilla_dist(P_ID_PSTO_PLANILLA,P_ID_DEPTO,P_ID_TEMPORADA,P_PORCENTAJE,P_TIPO,l_error,l_msgerror);
          END IF;
        END IF;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_planilla_dist_excel (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_NUM_DOC text,P_ID_DEPTO text,P_PORCENTAJE bigint,P_TIPO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
