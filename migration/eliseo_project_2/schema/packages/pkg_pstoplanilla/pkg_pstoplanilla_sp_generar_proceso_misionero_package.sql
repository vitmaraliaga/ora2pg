-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_proceso_misionero (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;
    l_id_psto_ayudas bigint;
    l_id_psto_movlibdis bigint;
    l_id_psto_puntaje_mis bigint;
    l_id_psto_vivienda bigint;
    l_anho bigint;
    l_mes bigint;

BEGIN
  --AYUDAS
         
    select IMPORTE INTO STRICT l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;

    select IMPORTE INTO STRICT l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;

    SELECT COALESCE(MAX(ID_PSTO_AYUDAS),0) INTO STRICT l_id_psto_ayudas FROM PSTO_PLLA_AYUDAS;

    INSERT INTO PSTO_PLLA_AYUDAS(
    ID_PSTO_AYUDAS,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO
    )
    SELECT 
    row_number() OVER () + l_id_psto_ayudas AS ID_PSTO_AYUDAS,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO
    FROM (
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO
      FROM APS_PLANILLA A
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN (
        SELECT X.ID_PERSONA FROM PSTO_PLLA_AYUDAS X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      ) 
      ORDER BY  A.ID_PERSONA 
    )X;

    /*DELETE FROM PSTO_PLLA_AYUDAS
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
    --MOVILIDAD DISPONIBILIDAD
    SELECT COALESCE(MAX(ID_PSTO_MOVLIBDIS),0) INTO STRICT l_id_psto_movlibdis FROM PSTO_PLLA_MOVLIBDIS;

    INSERT INTO PSTO_PLLA_MOVLIBDIS(
    ID_PSTO_MOVLIBDIS,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO,
    ID_TIPOESTATUS,
    ID_TIPOPAIS
    )
    SELECT 
    row_number() OVER () + l_id_psto_movlibdis AS ID_PSTO_MOVLIBDIS,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO,
    X.ID_TIPOESTATUS,
    X.ID_TIPOPAIS
    FROM (
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO,
      A.ID_TIPOESTATUS,
      P.ID_TIPOPAIS,
      A.FMR
      FROM APS_PLANILLA A LEFT JOIN PERSONA_NATURAL P
      ON A.ID_PERSONA=P.ID_PERSONA
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN (
        SELECT X.ID_PERSONA FROM PSTO_PLLA_MOVLIBDIS X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      ) 
      ORDER BY  A.ID_PERSONA 
    )X;

    /*DELETE FROM PSTO_PLLA_MOVLIBDIS
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
    
    --PUNTAJE 
    SELECT COALESCE(MAX(ID_PSTO_PUNTAJE_MIS),0) INTO STRICT l_id_psto_puntaje_mis FROM PSTO_PLLA_PUNTAJE_MIS;

    INSERT INTO PSTO_PLLA_PUNTAJE_MIS(
    ID_PSTO_PUNTAJE_MIS,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO,
    ID_TIPOESTATUS,
    ID_TIPOPAIS,
    PUNT_ANT
    )
    SELECT 
    row_number() OVER () + l_id_psto_puntaje_mis AS ID_PSTO_PUNTAJE_MIS,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO,
    X.ID_TIPOESTATUS,
    X.ID_TIPOPAIS,
    X.FMR
    FROM (
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO,
      A.ID_TIPOESTATUS,
      P.ID_TIPOPAIS,
      A.FMR
      FROM APS_PLANILLA A LEFT JOIN PERSONA_NATURAL P
      ON A.ID_PERSONA=P.ID_PERSONA
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN (
        SELECT X.ID_PERSONA FROM PSTO_PLLA_PUNTAJE_MIS X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      ) 
      ORDER BY  A.ID_PERSONA 
    )X;

    /*DELETE FROM PSTO_PLLA_PUNTAJE_MIS
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
    
    --vivienda
    SELECT COALESCE(MAX(ID_PSTO_VIVIENDA),0) INTO STRICT l_id_psto_vivienda FROM PSTO_PLLA_VIVIENDA;

    INSERT INTO PSTO_PLLA_VIVIENDA(
    ID_PSTO_VIVIENDA,
    ID_ANHO,
    ID_ENTIDAD,
    ID_PERSONA,
    ID_DEPTO,
    ID_CARGO
    )
    SELECT 
    row_number() OVER () + l_id_psto_vivienda AS ID_PSTO_VIVIENDA,
    P_ID_ANHO,
    P_ID_ENTIDAD,
    X.ID_PERSONA,
    X.ID_DEPTO,
    X.ID_CARGO
    FROM (
      SELECT 
      A.ID_PERSONA,
      A.ID_DEPTO,
      A.ID_CARGO
      FROM APS_PLANILLA A
      WHERE A.ID_ENTIDAD=P_ID_ENTIDAD
      AND A.ID_ANHO=l_anho
      AND A.ID_MES=l_mes
      AND A.ES_MISIONERO='1'
      AND A.ID_PERSONA NOT IN (
        SELECT X.ID_PERSONA FROM PSTO_PLLA_VIVIENDA X
        WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
        AND X.ID_DEPTO=A.ID_DEPTO
        AND X.ID_ANHO=P_ID_ANHO
      ) 
      ORDER BY  A.ID_PERSONA 
    )X;

    /*DELETE FROM PSTO_PLLA_VIVIENDA
    WHERE ID_ENTIDAD=P_ID_ENTIDAD
    AND ID_ANHO=P_ID_ANHO
    AND ID_PERSONA NOT IN(
      SELECT X.ID_PERSONA
      FROM APS_PLANILLA X
      WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
      AND X.ID_ANHO=l_anho
      AND X.ID_MES=l_mes
      AND X.ID_DEPTO=ID_DEPTO
      --AND X.ES_MISIONERO='1'
    );*/
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_proceso_misionero (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
