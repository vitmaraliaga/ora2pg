-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;

        
        /*PROCEDURE SP_GENERAR_PLANILLA_ACTIVIDAD(P_ID_PSTO_PLANILLA numeric,P_ERROR OUT numeric,P_MSGERROR out varchar) IS
          l_error numeric:=0;
          l_msgerror varchar(200):='';
          l_contar numeric;
          
          l_id_entidad numeric;
          l_id_auxiliar numeric;
          l_id_depto_padre numeric;
          
          l_id_concepto_actividad numeric;
          l_columna_imp varchar(50);
          
          CURSOR cur IS SELECT 
              ID_CONCEPTO_ACTIVIDAD,COLUMNA_IMP
              FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_DEPTO_PADRE=l_id_depto_padre
              AND ID_AUXILIAR=l_id_auxiliar;        
              
        BEGIN
          
        DELETE  FROM PSTO_PLLA_PLANILLA_ACTIVIDAD WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;   
        
        SELECT 
        ID_ENTIDAD,ID_AUXILIAR,ID_DEPTO_PADRE
        into
        l_id_entidad,l_id_auxiliar,l_id_depto_padre
        FROM PSTO_PLLA_PLANILLA
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;
        
        OPEN cur;
          FETCH cur INTO l_id_concepto_actividad,l_columna_imp;
                
          WHILE cur%FOUND LOOP
          
            EXECUTE IMMEDIATE 'INSERT INTO PSTO_PLLA_PLANILLA_ACTIVIDAD(ID_CONCEPTO_ACTIVIDAD,ID_PSTO_PLANILLA,IMPORTE) SELECT '||to_char(l_id_concepto_actividad)||','||to_char(P_ID_PSTO_PLANILLA)||','||l_columna_imp||' FROM PSTO_PLLA_PLANILLA WHERE ID_PSTO_PLANILLA=:PARAMETRO and coalesce('||l_columna_imp||',0)>0 '  
            USING P_ID_PSTO_PLANILLA;
            
            FETCH cur INTO l_id_concepto_actividad,l_columna_imp;
                  
        END LOOP;   
        CLOSE cur;
      
        
               
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_GENERAR_PLANILLA_ACTIVIDAD;
        */
CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_planilla_dist_det (P_ID_PSTO_PLANILLA bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;

          l_id_entidad bigint;
          l_id_auxiliar bigint;
          l_id_depto_padre bigint;

          l_id_concepto_actividad bigint;
          l_columna_imp varchar(50);
          l_distribuido varchar(2);

          l_id_psto_plainilla bigint;
          l_importe decimal(10,2);

          l_id_plla_planilla_dist bigint;
          l_porcentaje decimal(10,2);
          l_mes1 decimal(10,2);
          l_mes2 decimal(10,2);
          l_mes3 decimal(10,2);
          l_mes4 decimal(10,2);
          l_mes5 decimal(10,2);
          l_mes6 decimal(10,2);
          l_mes7 decimal(10,2);
          l_mes8 decimal(10,2);
          l_mes9 decimal(10,2);
          l_mes10 decimal(10,2);
          l_mes11 decimal(10,2);
          l_mes12 decimal(10,2);


          cur CURSOR FOR SELECT 
              ID_CONCEPTO_ACTIVIDAD,COLUMNA_IMP,DISTRIBUIDO
              FROM PSTO_PLLA_CONCEPTO_ACTIVIDAD 
              WHERE ID_ENTIDAD=l_id_entidad
              AND ID_DEPTO_PADRE=l_id_depto_padre
              AND AUXI_IDENTIFICADOR='PL';

          cureje CURSOR FOR  SELECT
                  ID_PLLA_PLANILLA_DIST,
                  PORCENTAJE,
                  MES1,
                  MES2,
                  MES3,
                  MES4,
                  MES5,
                  MES6,
                  MES7,
                  MES8,
                  MES9,
                  MES10,
                  MES11,
                  MES12
            from PSTO_PLLA_PLANILLA_DIST
            where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
            AND TIPO='0';

        
BEGIN
          
        DELETE  FROM PSTO_PLLA_PLANILLA_DIST_DET WHERE ID_PLLA_PLANILLA_DIST IN (
          SELECT ID_PLLA_PLANILLA_DIST from PSTO_PLLA_PLANILLA_DIST where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
        );
        
  
        SELECT 
        ID_ENTIDAD,ID_AUXILIAR,ID_DEPTO_PADRE
        into STRICT
        l_id_entidad,l_id_auxiliar,l_id_depto_padre
        FROM PSTO_PLLA_PLANILLA
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        OPEN cur;
          FETCH cur INTO l_id_concepto_actividad,l_columna_imp,l_distribuido;

          WHILE cur%FOUND LOOP
          
            EXECUTE ' SELECT coalesce('||l_columna_imp||'_MEN,0) FROM VW_PSTO_PLLA_PLANILLA WHERE ID_PSTO_PLANILLA=:PARAMETRO'  
            into STRICT l_importe
            USING P_ID_PSTO_PLANILLA;

            if l_importe>0 and l_distribuido='S' then
            
              OPEN cureje;
              FETCH cureje INTO l_id_plla_planilla_dist,l_porcentaje, l_mes1,l_mes2,l_mes3,l_mes4,l_mes5,l_mes6,l_mes7,l_mes8,l_mes9,l_mes10,l_mes11,l_mes12;

              WHILE cureje%FOUND LOOP
              
                insert into PSTO_PLLA_PLANILLA_DIST_DET(
                    ID_CONCEPTO_ACTIVIDAD,
                    ID_PLLA_PLANILLA_DIST,
                    MES1,
                    MES2,
                    MES3,
                    MES4,
                    MES5,
                    MES6,
                    MES7,
                    MES8,
                    MES9,
                    MES10,
                    MES11,
                    MES12
                )values(
                  l_id_concepto_actividad,
                  l_id_plla_planilla_dist,
                  ((l_porcentaje*l_mes1)/100)*l_importe,
                  ((l_porcentaje*l_mes2)/100)*l_importe,
                  ((l_porcentaje*l_mes3)/100)*l_importe,
                  ((l_porcentaje*l_mes4)/100)*l_importe,
                  ((l_porcentaje*l_mes5)/100)*l_importe,
                  ((l_porcentaje*l_mes6)/100)*l_importe,
                  ((l_porcentaje*l_mes7)/100)*l_importe,
                  ((l_porcentaje*l_mes8)/100)*l_importe,
                  ((l_porcentaje*l_mes9)/100)*l_importe,
                  ((l_porcentaje*l_mes10)/100)*l_importe,
                  ((l_porcentaje*l_mes11)/100)*l_importe,
                  ((l_porcentaje*l_mes12)/100)*l_importe
                );

                update PSTO_PLLA_PLANILLA_DIST_DET set importe=MES1+MES2+MES3+MES4+MES5+MES6+MES7+MES8+MES9+MES10+MES11+MES12
                where ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad
                and ID_PLLA_PLANILLA_DIST=l_id_plla_planilla_dist;

                FETCH cureje INTO l_id_plla_planilla_dist,l_porcentaje, l_mes1,l_mes2,l_mes3,l_mes4,l_mes5,l_mes6,l_mes7,l_mes8,l_mes9,l_mes10,l_mes11,l_mes12;

              END LOOP;
              
              ---------------------------------------------------
              SELECT
              COALESCE(SUM(MES1),0),COALESCE(SUM(MES2),0),COALESCE(SUM(MES3),0),COALESCE(SUM(MES4),0),COALESCE(SUM(MES5),0),COALESCE(SUM(MES6),0),COALESCE(SUM(MES7),0),COALESCE(SUM(MES8),0),COALESCE(SUM(MES9),0),COALESCE(SUM(MES10),0),COALESCE(SUM(MES11),0),COALESCE(SUM(MES12),0)
              INTO STRICT 
              l_mes1,l_mes2,l_mes3,l_mes4,l_mes5,l_mes6,l_mes7,l_mes8,l_mes9,l_mes10,l_mes11,l_mes12
              FROM PSTO_PLLA_PLANILLA_DIST_DET WHERE ID_PLLA_PLANILLA_DIST IN (
                  SELECT ID_PLLA_PLANILLA_DIST from PSTO_PLLA_PLANILLA_DIST where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                  AND TIPO='0'
              ) and ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad;

               insert into PSTO_PLLA_PLANILLA_DIST_DET(
                    ID_CONCEPTO_ACTIVIDAD,
                    ID_PLLA_PLANILLA_DIST,
                    MES1,
                    MES2,
                    MES3,
                    MES4,
                    MES5,
                    MES6,
                    MES7,
                    MES8,
                    MES9,
                    MES10,
                    MES11,
                    MES12
                )
                SELECT
                  l_id_concepto_actividad,
                  ID_PLLA_PLANILLA_DIST,
                  (l_importe-l_mes1)*MES1,
                  (l_importe-l_mes2)*MES2,
                  (l_importe-l_mes3)*MES3,
                  (l_importe-l_mes4)*MES4,
                  (l_importe-l_mes5)*MES5,
                  (l_importe-l_mes6)*MES6,
                  (l_importe-l_mes7)*MES7,
                  (l_importe-l_mes8)*MES8,
                  (l_importe-l_mes9)*MES9,
                  (l_importe-l_mes10)*MES10,
                  (l_importe-l_mes11)*MES11,
                  (l_importe-l_mes12)*MES12
                FROM PSTO_PLLA_PLANILLA_DIST
                where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                AND TIPO='1';

                update PSTO_PLLA_PLANILLA_DIST_DET set importe=MES1+MES2+MES3+MES4+MES5+MES6+MES7+MES8+MES9+MES10+MES11+MES12
                where ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad
                and ID_PLLA_PLANILLA_DIST IN (
                  SELECT ID_PLLA_PLANILLA_DIST 
                  FROM PSTO_PLLA_PLANILLA_DIST
                  where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                  AND TIPO='1'
                );

              CLOSE cureje;
            else
              if l_importe>0 then
                insert into PSTO_PLLA_PLANILLA_DIST_DET(
                      ID_CONCEPTO_ACTIVIDAD,
                      ID_PLLA_PLANILLA_DIST,
                      MES1,
                      MES2,
                      MES3,
                      MES4,
                      MES5,
                      MES6,
                      MES7,
                      MES8,
                      MES9,
                      MES10,
                      MES11,
                      MES12
                  )
                  SELECT
                    l_id_concepto_actividad,
                    ID_PLLA_PLANILLA_DIST,
                    (l_importe)*MES1,
                    (l_importe)*MES2,
                    (l_importe)*MES3,
                    (l_importe)*MES4,
                    (l_importe)*MES5,
                    (l_importe)*MES6,
                    (l_importe)*MES7,
                    (l_importe)*MES8,
                    (l_importe)*MES9,
                    (l_importe)*MES10,
                    (l_importe)*MES11,
                    (l_importe)*MES12
                  FROM PSTO_PLLA_PLANILLA_DIST
                  where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                  AND TIPO='1';

                  update PSTO_PLLA_PLANILLA_DIST_DET set importe=MES1+MES2+MES3+MES4+MES5+MES6+MES7+MES8+MES9+MES10+MES11+MES12
                  where ID_CONCEPTO_ACTIVIDAD=l_id_concepto_actividad
                  and ID_PLLA_PLANILLA_DIST IN (
                    SELECT
                    ID_PLLA_PLANILLA_DIST
                    FROM PSTO_PLLA_PLANILLA_DIST
                    where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
                    AND TIPO='1'
                  );
               end if;
            end if;

                 
            FETCH cur INTO l_id_concepto_actividad,l_columna_imp,l_distribuido;

        END LOOP;
        CLOSE cur;

        
               
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_planilla_dist_det (P_ID_PSTO_PLANILLA bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
