-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_escala_sueldo (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint) AS $body$
DECLARE

            l_id_cargosuledo_escala bigint;
            l_contar bigint;
            l_anho bigint;
            l_mes bigint;
            l_rmv decimal(20,14);

BEGIN
          
            select IMPORTE INTO STRICT l_anho from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_ANHOPROC' AND ID_ANHO=P_ID_ANHO;

            select IMPORTE INTO STRICT l_mes from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_MESPROC' AND ID_ANHO=P_ID_ANHO;

            select IMPORTE INTO STRICT l_rmv from PSTO_PLLA_PARAMETROS_VALOR WHERE ID_PARAMETRO='PARAM_RMV' AND ID_ANHO=P_ID_ANHO;

            SELECT COALESCE(MAX(ID_CARGOSUELDO_ESCALA),0) INTO STRICT l_contar FROM PSTO_PLLA_CARGOSUELDO_ESCALA;

            INSERT INTO PSTO_PLLA_CARGOSUELDO_ESCALA(
                ID_CARGOSUELDO_ESCALA,
                ID_ANHO,
                ID_ENTIDAD,
                ID_DEPTO_PADRE,
                ID_CARGO,
                BONO_MIN,
                BONO_MAX,
                VIA_MIN,
                VIA_MAX,
                ID_CONDICION_ESCALA,
                TIPO_MIN,
                TIPO_MAX,
                MINIMO,
                MAXIMO
            )
            SELECT 
                row_number() OVER () + l_contar AS ID_CARGOSUELDO_ESCALA,
                P_ID_ANHO,
                P_ID_ENTIDAD,
                P_ID_DEPTO_PADRE,
                X.ID_CARGO,
                0 AS BONO_MIN,
                0 AS BONO_MAX,
                0 AS VIA_MIN,
                0 AS VIA_MAX,
                x.ID_CONDICION_ESCALA,
                null,--case when x.ID_CONDICION_ESCALA='P' then '1' else null end,
                null,--case when x.ID_CONDICION_ESCALA='P' then '1' else null end,
                null,--case when x.ID_CONDICION_ESCALA='P' then l_rmv else 0 end,
                null --case when x.ID_CONDICION_ESCALA='P' then l_rmv else 0 end
                FROM 
                (
                    SELECT 
                    COALESCE(a.ID_CARGO,p.ID_CARGO) AS ID_CARGO,
                    CASE WHEN a.ES_MISIONERO='1' then
                        'M'
                    else
                        CASE WHEN b.ID_TIPOCONTRATO=81 then
                              'P'
                        else
                          'C'
                        end 
                    end as ID_CONDICION_ESCALA,
                    COUNT(*) AS CANTIDAD
                    FROM  APS_PLANILLA a, APS_EMPLEADO b,APS_TRABAJADOR p
                    WHERE a.ID_PERSONA=b.ID_PERSONA
                    AND a.ID_CONTRATO=b.ID_CONTRATO
                    AND b.ID_PERSONA=p.ID_PERSONA
                    AND a.ID_ANHO=l_anho
                    AND a.ID_MES=l_mes
                    AND a.ID_ENTIDAD=P_ID_ENTIDAD
                    and (COALESCE(a.ID_CARGO,p.ID_CARGO) IS NOT NULL AND (COALESCE(a.ID_CARGO,p.ID_CARGO))::text <> '')
                    AND COALESCE(a.ID_CARGO,p.ID_CARGO) NOT IN(
                        SELECT X.ID_CARGO FROM PSTO_PLLA_CARGOSUELDO_ESCALA X
                        WHERE X.ID_ANHO=P_ID_ANHO
                        AND X.ID_ENTIDAD=P_ID_ENTIDAD
                        AND X.ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
                        AND X.ID_CONDICION_ESCALA=(CASE WHEN a.ES_MISIONERO='1' then
                                                'M'
                                            else
                                                CASE WHEN b.ID_TIPOCONTRATO=81 then
                                                      'P'
                                                else
                                                  'C'
                                                end 
                                            end) 
                    )
                    GROUP BY 
                    COALESCE(a.ID_CARGO,p.ID_CARGO),
                    CASE WHEN a.ES_MISIONERO='1' then
                        'M'
                    else
                        CASE WHEN b.ID_TIPOCONTRATO=81 then
                              'P'
                        else
                          'C'
                        end 
                    end
                    ORDER BY COALESCE(a.ID_CARGO,p.ID_CARGO) 
            )X;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_escala_sueldo (P_ID_ENTIDAD bigint,P_ID_DEPTO_PADRE text,P_ID_ANHO bigint) FROM PUBLIC;
