-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pstoplanilla,public;

        
        /*PROCEDURE SP_ACTUALIZAR_PLANILLA(P_ID_ENTIDAD numeric,P_ID_ANHO numeric,P_ID_DEPTO varchar,P_ID_DEPTO_PADRE IN numeric,P_ID_AUXILIAR IN numeric,P_ERROR OUT numeric,P_MSGERROR out varchar) IS
          l_error numeric:=0;
          l_msgerror varchar(200):='';
          l_contar numeric;
          l_id_psto_planilla numeric;

          
          CURSOR cur IS SELECT 
              ID_PSTO_PLANILLA
              FROM PSTO_PLLA_PLANILLA 
              WHERE ID_ENTIDAD=P_ID_ENTIDAD
              AND ID_DEPTO=P_ID_DEPTO
              AND ID_ANHO=P_ID_ANHO
              AND ID_DEPTO_PADRE=P_ID_DEPTO_PADRE
              AND ID_AUXILIAR=P_ID_AUXILIAR;
              
        BEGIN
          

          
          OPEN cur;
          FETCH cur INTO l_id_psto_planilla;
                
          WHILE cur%FOUND LOOP
          
            
              
              PKG_PSTOPLANILLA.SP_ACTUALIZAR_PLANILLA_EMP_ANT(l_id_psto_planilla,l_error,l_msgerror);
              
               
            
            FETCH cur INTO l_id_psto_planilla;
                  
        END LOOP;   
        CLOSE cur;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END SP_ACTUALIZAR_PLANILLA;
        */
CREATE OR REPLACE PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_planilla_dist (P_ID_PSTO_PLANILLA bigint,P_ID_DEPTO text,P_ID_TEMPORADA text,P_PORCENTAJE bigint,P_TIPO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

          l_error bigint:=0;
          l_msgerror varchar(200):='';
          l_contar bigint;

          l_id_entidad bigint;
          l_imp_prin decimal(10,2);
          l_imp_aso decimal(10,2);
          l_imp_queda decimal(10,2);
          l_imp_actual decimal(10,2);

          l_id_plla_planilla_dist bigint;

          l_mes bigint:=1;
          l_activo bigint:=0;

          l_inicio bigint:=0;
          l_fin bigint:=0;
          l_inicio1 bigint:=0;
          l_fin1 bigint:=0;

          l_id_temporada_v varchar(2);

          l_inicio_v bigint:=0;
          l_fin_v bigint:=0;
          l_inicio1_v bigint:=0;
          l_fin1_v bigint:=0;

        
BEGIN
      
        SELECT ID_ENTIDAD into STRICT  l_id_entidad FROM PSTO_PLLA_PLANILLA where ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

        IF P_PORCENTAJE>100 THEN
          l_error:=1;
          l_msgerror:='Porcentaje ingresado mayor a 100  ingresado '||P_PORCENTAJE::text;
        END IF;

        SELECT
            coalesce(INICIO,0),
            coalesce(FIN,0),
            coalesce(INICIO1,0),
            coalesce(FIN1,0)
          into STRICT 
            l_inicio,
            l_fin,
            l_inicio1,
            l_fin1 
        FROM PSTO_PLLA_TEMPORADA
        WHERE ID_TEMPORADA=P_ID_TEMPORADA;

        IF l_error=0 THEN
          if P_TIPO='0' then
              SELECT
              ID_TEMPORADA INTO STRICT l_id_temporada_v
              FROM PSTO_PLLA_PLANILLA_DIST
              WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA 
              AND TIPO='1';

              SELECT
                coalesce(INICIO,0),
                coalesce(FIN,0),
                coalesce(INICIO,0),
                coalesce(FIN1,0)
              into STRICT 
                l_inicio_v,
                l_fin_v,
                l_inicio1_v,
                l_fin1_v 
            FROM PSTO_PLLA_TEMPORADA
            WHERE ID_TEMPORADA=l_id_temporada_v;

            if l_fin1_v>0 then
              l_fin_v:=l_fin1_v;
            end if;

            if l_inicio>0 and l_fin>0 then
              
                if l_inicio>=l_inicio_v  then
                   if l_fin<=l_fin_v then
                      l_error:=0;
                   else
                    l_error:=1;
                    l_msgerror:='Temporada fecha fin fuera de rango ';
                   end if;
                else
                  l_error:=1;
                  l_msgerror:='Temporada fecha inicio fuera de rango ';
                end if;

            end if;

             IF l_error=0 THEN
               if l_inicio1>0 and l_fin1>0 then
                
                  if l_inicio1>=l_inicio_v  then
                     if l_fin1<=l_fin_v then
                        l_error:=0;
                     else
                      l_error:=1;
                      l_msgerror:='Temporada fecha fin fuera de rango ';
                     end if;
                  else
                    l_error:=1;
                    l_msgerror:='Temporada fecha inicio fuera de rango ';
                  end if;

              end if;
             end if;

          end if;
        end if;

        IF l_error=0 THEN
        
          SELECT COALESCE(SUM(case when TIPO='1' then PORCENTAJE else 0 end),0),COALESCE(SUM(case when TIPO='0' then PORCENTAJE else 0 end),0) 
          INTO STRICT l_imp_prin,l_imp_aso FROM PSTO_PLLA_PLANILLA_DIST
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA;

          l_imp_actual:=l_imp_aso+P_PORCENTAJE;
          if l_imp_actual>100 then
            l_error:=1;
            l_msgerror:='Porcentaje total mayor a 100  actual '||l_imp_actual::text;
          else
            if P_TIPO<>'1' then
                l_imp_queda:=100-l_imp_actual;
              else
                l_imp_queda:=l_imp_actual;
            end if;
          end if;

        end if;

        SELECT COUNT(*) INTO STRICT l_contar FROM PSTO_PLLA_PLANILLA_DIST
        WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA
        AND ID_DEPTO=P_ID_DEPTO
        AND ID_ENTIDAD=l_id_entidad;

        IF l_contar=0 and l_error=0 THEN
          
          SELECT COALESCE(MAX(ID_PLLA_PLANILLA_DIST),0) +1 INTO STRICT l_id_plla_planilla_dist FROM PSTO_PLLA_PLANILLA_DIST;

          insert into PSTO_PLLA_PLANILLA_DIST(
            ID_PLLA_PLANILLA_DIST,
            ID_ENTIDAD,
            ID_DEPTO,
            ID_PSTO_PLANILLA,
            TIPO,
            ID_TEMPORADA,
            PORCENTAJE
          )values (
            l_id_plla_planilla_dist,
            l_id_entidad,
            P_ID_DEPTO,
            P_ID_PSTO_PLANILLA,
            P_TIPO,
            P_ID_TEMPORADA,
            P_PORCENTAJE
          );

          UPDATE PSTO_PLLA_PLANILLA_DIST SET PORCENTAJE=l_imp_queda
          WHERE ID_PSTO_PLANILLA=P_ID_PSTO_PLANILLA 
          AND TIPO='1';

          
          
          l_mes:=1;

          
          while l_mes<=12 loop
            l_activo:=0;
            if l_mes between l_inicio and  l_fin then
            --if l_mes>=l_inicio and l_mes<=l_fin then
              l_activo:=1;
            else
              if l_mes between l_inicio1 and  l_fin1 then
              --if l_mes>=l_inicio1 and l_mes<=l_fin1 then
                l_activo:=1;
              end if;
            end if;

            EXECUTE 'UPDATE PSTO_PLLA_PLANILLA_DIST SET MES'||l_mes::text||'='||l_activo::text||' WHERE ID_PLLA_PLANILLA_DIST=:PARAMETRO'  
            USING l_id_plla_planilla_dist;
            l_mes:=l_mes+1;
          end loop;

        ELSE
          IF l_contar>0 and l_error=0 THEN
            l_error:=1;
            l_msgerror:='Ya esta registrado a departamento '||P_ID_DEPTO;
          END IF;
        END IF;

        IF l_error=0 THEN    
          CALL pkg_pstoplanilla_sp_generar_planilla_dist_det(P_ID_PSTO_PLANILLA,l_error,l_msgerror);
        end if;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pstoplanilla_sp_generar_planilla_dist (P_ID_PSTO_PLANILLA bigint,P_ID_DEPTO text,P_ID_TEMPORADA text,P_PORCENTAJE bigint,P_TIPO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
