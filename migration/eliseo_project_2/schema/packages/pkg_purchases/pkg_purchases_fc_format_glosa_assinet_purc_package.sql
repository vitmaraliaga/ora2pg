-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_purchases_fc_format_glosa_assinet_purc (P_ID_ASIENTO bigint) RETURNS varchar AS $body$
DECLARE

        L_GLOSA_2 varchar(255);
        L_DESCRIPCION_2 varchar(100):='';

BEGIN
    
        Begin
        SELECT (CASE
                    WHEN LENGTH(pkg_purchases_fc_ruc(C.ID_PROVEEDOR)) <= 11 THEN pkg_purchases_fc_ruc(C.ID_PROVEEDOR)
                    ELSE SUBSTR(pkg_purchases_fc_ruc(C.ID_PROVEEDOR), 1, 11)
                    END || '/' ||
                CASE
                    WHEN LENGTH(C.SERIE || '-' || C.NUMERO) <= 13 THEN C.SERIE || '-' || C.NUMERO
                    ELSE SUBSTR(C.SERIE || '-' || C.NUMERO, 1, 13)
                    END || '/' ||
                CASE
                    WHEN LENGTH(coalesce(cd.DETALLE,(select pr.motivo from pedido_compra pc,pedido_registro pr  where pc.id_compra=c.id_compra and pc.id_pedido=pr.id_pedido ))) <= 33 THEN cd.DETALLE
                    ELSE SUBSTR(coalesce(cd.DETALLE,(select pr.motivo from pedido_compra pc,pedido_registro pr  where pc.id_compra=c.id_compra and pc.id_pedido=pr.id_pedido )), 1, 33)
                    END)
        INTO STRICT L_DESCRIPCION_2
        FROM ELISEO.CONTA_ASIENTO ca
                 JOIN ELISEO.COMPRA C ON C.ID_COMPRA = ca.ID_ORIGEN
                 LEFT JOIN ELISEO.COMPRA_DETALLE cd ON cd.ID_COMPRA = C.ID_COMPRA
        WHERE ca.id_asiento = P_ID_ASIENTO
          AND (ca.CUENTA LIKE '1%' OR ca.CUENTA LIKE '2%')   LIMIT 1;

        EXCEPTION WHEN no_data_found THEN
            L_DESCRIPCION_2 := null;
        END;
        
        L_GLOSA_2 := L_DESCRIPCION_2;
      
        RETURN(L_GLOSA_2);
    END;

    
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION eliseo.pkg_purchases_fc_format_glosa_assinet_purc (P_ID_ASIENTO bigint) FROM PUBLIC;
