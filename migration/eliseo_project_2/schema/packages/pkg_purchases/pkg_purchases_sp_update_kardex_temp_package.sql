-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_update_kardex_temp (P_ID_COMPRA bigint) AS $body$
DECLARE

        L_ID_KARDEX bigint;
        L_ID_ANHO bigint;
        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_COSTO bigint;
        L_IMPORTE bigint;

        articulos CURSOR FOR	
        SELECT 
        A.ID_KARDEX,A.ID_ALMACEN,A.ID_ANHO,A.ID_ARTICULO,B.IMPORTE/B.CANTIDAD AS NEW_COSTO,B.IMPORTE 
        FROM INVENTARIO_KARDEX A JOIN COMPRA_DETALLE B
        ON A.ID_ORIGEN = B.ID_DETALLE
        AND A.ID_ARTICULO = B.ID_ARTICULO
        AND A.ID_ALMACEN = B.ID_ALMACEN
        JOIN COMPRA C
        ON B.ID_COMPRA = C.ID_COMPRA
        WHERE A.ID_ANHO = 2019
        AND A.ID_ALMACEN = 33
        AND A.ID_TIPOORIGEN = 3
        --AND B.ID_COMPRA = P_ID_COMPRA
        AND C.ID_PERSONA = 13504;
        	

BEGIN   
        
        OPEN articulos;
          FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ANHO,L_ID_ARTICULO,L_COSTO,L_IMPORTE;
            WHILE articulos%FOUND LOOP
                UPDATE INVENTARIO_KARDEX SET COSTO_UNITARIO = L_COSTO, COSTO_TOTAL = L_IMPORTE
                WHERE ID_KARDEX = L_ID_KARDEX;

                UPDATE INVENTARIO_ALMACEN_ARTICULO SET ESTADO = '1'
                WHERE ID_ALMACEN = L_ID_ALMACEN
                AND ID_ARTICULO = L_ID_ARTICULO
                AND ID_ANHO = L_ID_ANHO;

                FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ANHO,L_ID_ARTICULO,L_COSTO,L_IMPORTE;
            END LOOP;
        CLOSE articulos;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_update_kardex_temp (P_ID_COMPRA bigint) FROM PUBLIC;
