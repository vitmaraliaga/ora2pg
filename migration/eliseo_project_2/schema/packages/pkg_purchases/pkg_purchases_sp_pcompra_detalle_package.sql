-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_pcompra_detalle (P_ID_PCOMPRA bigint,P_ID_PEDIDO bigint) AS $body$
DECLARE

        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_ID_TIPOIGV varchar(2);
        L_CANTIDAD decimal(10,2);
        L_PRECIO decimal(10,2);
        L_BASE decimal(10,2);
        L_IGV decimal(10,2);
        L_IMPORTE decimal(10,2);

        DETA CURSOR FOR		
        SELECT 
                B.ID_ALMACEN,B.ID_ARTICULO,C.ID_TIPOIGV,B.CANTIDAD,B.PRECIO,
                --(CASE C.ID_TIPOIGV WHEN '10' THEN (B.CANTIDAD*B.PRECIO)/1.18 ELSE (B.CANTIDAD*B.PRECIO) END) AS BASE,
                --(CASE C.ID_TIPOIGV WHEN '10' THEN ((B.CANTIDAD*B.PRECIO)/1.18)*0.18 ELSE 0 END) AS IGV,
                --(B.CANTIDAD*B.PRECIO) AS IMPORTE,
                (CASE C.ID_TIPOIGV WHEN '10' THEN (B.IMPORTE)/1.18 ELSE (B.IMPORTE) END) AS BASE,
                (CASE C.ID_TIPOIGV WHEN '10' THEN ((B.IMPORTE)/1.18)*0.18 ELSE 0 END) AS IGV,
                B.IMPORTE
        FROM PEDIDO_REGISTRO A, PEDIDO_DETALLE B, INVENTARIO_ALMACEN_ARTICULO C
        WHERE A.ID_PEDIDO = B.ID_PEDIDO
        AND B.ID_ALMACEN = C.ID_ALMACEN
        AND B.ID_ARTICULO = C.ID_ARTICULO
        AND A.ID_ANHO = C.ID_ANHO
        AND A.ID_PEDIDO = P_ID_PEDIDO;

BEGIN
        
            OPEN DETA;
                FETCH DETA INTO L_ID_ALMACEN, L_ID_ARTICULO, L_ID_TIPOIGV,L_CANTIDAD, L_PRECIO,L_BASE,L_IGV, L_IMPORTE;
                WHILE DETA%FOUND LOOP
                    INSERT INTO PEDIDO_COMPRA_DETALLE(ID_PCOMPRA,ID_ALMACEN,ID_ARTICULO,ID_TIPOIGV,CANTIDAD,PRECIO,BASE,IGV,IMPORTE)
                    VALUES (P_ID_PCOMPRA,L_ID_ALMACEN, L_ID_ARTICULO, L_ID_TIPOIGV,L_CANTIDAD, L_PRECIO,L_BASE,L_IGV, L_IMPORTE);
                FETCH DETA INTO L_ID_ALMACEN, L_ID_ARTICULO, L_ID_TIPOIGV,L_CANTIDAD, L_PRECIO,L_BASE,L_IGV, L_IMPORTE;
                END LOOP;
            CLOSE DETA;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_pcompra_detalle (P_ID_PCOMPRA bigint,P_ID_PEDIDO bigint) FROM PUBLIC;
