-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;

        
    -- PROCEMINIETOS PARA HACER CALCULOS
CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_compra_calcular ( P_ID_COMPROBANTE text, P_GET_IGV boolean, P_TIPOCAMBIO bigint,P_ID_MONEDA bigint, P_IMPORTE bigint, P_TAXS bigint, P_INAFECTA bigint, P_OTROS bigint,P_PERCENT_IGV bigint, P_BASE OUT bigint, P_IGV OUT bigint, P_OUT_INAFECTA OUT bigint, P_TOTAL OUT bigint, P_IMPORTE_ME OUT bigint ) AS $body$
DECLARE

         L_IMPORTE_SOLES decimal(10,2);
        L_INAFECTA_SOLES decimal(10,2);
        L_OUT_INAFECTA_SOLES decimal(10,2);
        L_TAXS_SOLES decimal(10,2);

        L_OTROS_SOLES decimal(10,2);

        L_TOTAL_SINCREDITO_SOLES decimal(10,2); -- total_sincredito_soles
        L_BASE_SINCREDITO_SOLES decimal(10,2); -- base_sincredito_soles
        L_IGV_SINCREDITO_SOLES decimal(10,2); -- igv_sincredito_soles
        L_PERCENT_IGV_ONE bigint; -- 1.18 DEFAULT
    
BEGIN
	    L_PERCENT_IGV_ONE := P_PERCENT_IGV+1;
	
		   IF P_ID_MONEDA = 7 THEN  -- SOLES
		   		P_IMPORTE_ME := 0;
                
                L_IMPORTE_SOLES := P_IMPORTE;
                L_INAFECTA_SOLES := P_INAFECTA;
                L_TAXS_SOLES := P_TAXS;
                L_OTROS_SOLES := P_OTROS;
		   ELSE
		   		P_IMPORTE_ME := COALESCE(P_IMPORTE,0);
               	
                L_IMPORTE_SOLES := (COALESCE(P_IMPORTE,0) * COALESCE(P_TIPOCAMBIO,0));
                L_INAFECTA_SOLES := (COALESCE(P_INAFECTA,0) * COALESCE(P_TIPOCAMBIO,0));
                L_TAXS_SOLES := (COALESCE(P_TAXS,0) * COALESCE(P_TIPOCAMBIO,0));
                L_OTROS_SOLES := P_OTROS;
		   END IF;
	
            IF P_ID_COMPROBANTE='01' then  -- FACTURA
                --L_TOTAL_SINCREDITO_SOLES := (COALESCE(L_IMPORTE_SOLES,0) - COALESCE(P_INAFECTA,0));
                L_TOTAL_SINCREDITO_SOLES := (COALESCE(L_IMPORTE_SOLES,0) - COALESCE(L_INAFECTA_SOLES,0) - COALESCE(L_OTROS_SOLES,0));
                L_BASE_SINCREDITO_SOLES := (COALESCE(L_TOTAL_SINCREDITO_SOLES,0)/ (CASE WHEN P_GET_IGV THEN L_PERCENT_IGV_ONE ELSE 1 END));
                L_IGV_SINCREDITO_SOLES := COALESCE(L_TOTAL_SINCREDITO_SOLES,0) - COALESCE(L_BASE_SINCREDITO_SOLES,0);
                L_OUT_INAFECTA_SOLES := L_INAFECTA_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := COALESCE(L_TOTAL_SINCREDITO_SOLES,0) + COALESCE(L_OUT_INAFECTA_SOLES,0) +  COALESCE(L_OTROS_SOLES,0);
            	
            ELSIF P_ID_COMPROBANTE='02' then  -- RECIBO POR HONORARIO
                P_TOTAL := null;
            ELSIF P_ID_COMPROBANTE='03' then  -- BOLETA DE VENTA
                L_TOTAL_SINCREDITO_SOLES := L_IMPORTE_SOLES;
                L_BASE_SINCREDITO_SOLES := L_IMPORTE_SOLES;
                L_IGV_SINCREDITO_SOLES := 0;
                L_OUT_INAFECTA_SOLES := L_IMPORTE_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES;

            ELSIF P_ID_COMPROBANTE='04' then  -- LIQUIDACIÃ“N COMPRA
                L_TOTAL_SINCREDITO_SOLES := (L_IMPORTE_SOLES - L_INAFECTA_SOLES - L_OTROS_SOLES);
                L_BASE_SINCREDITO_SOLES := (L_TOTAL_SINCREDITO_SOLES/ (CASE WHEN P_GET_IGV THEN L_PERCENT_IGV_ONE ELSE 1 END));
                L_IGV_SINCREDITO_SOLES := L_TOTAL_SINCREDITO_SOLES - L_BASE_SINCREDITO_SOLES;
                L_OUT_INAFECTA_SOLES := L_INAFECTA_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES + L_INAFECTA_SOLES +  L_OTROS_SOLES;

            ELSIF P_ID_COMPROBANTE='05' then  -- BOLETA AEREO
                L_BASE_SINCREDITO_SOLES := (COALESCE(L_IMPORTE_SOLES,0) - COALESCE(L_TAXS_SOLES,0) - COALESCE(L_OTROS_SOLES,0));
                L_IGV_SINCREDITO_SOLES := (L_BASE_SINCREDITO_SOLES * (CASE WHEN P_GET_IGV THEN P_PERCENT_IGV ELSE 0 END));
                L_OUT_INAFECTA_SOLES := (L_TAXS_SOLES - L_IGV_SINCREDITO_SOLES);

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_BASE_SINCREDITO_SOLES + L_IGV_SINCREDITO_SOLES +  L_OUT_INAFECTA_SOLES + L_OTROS_SOLES;
            ELSIF P_ID_COMPROBANTE='07' OR P_ID_COMPROBANTE='08' OR P_ID_COMPROBANTE='87' OR P_ID_COMPROBANTE='88' then
                -- NOTA DE CREDITO, NOTA DE DEBITO, NOTA DE CREDITO ESPECIAL, NOTA DE DEBITO ESPECIAL
                L_TOTAL_SINCREDITO_SOLES := (L_IMPORTE_SOLES - L_INAFECTA_SOLES - L_OTROS_SOLES);
                L_BASE_SINCREDITO_SOLES := (L_TOTAL_SINCREDITO_SOLES/ (CASE WHEN P_GET_IGV THEN L_PERCENT_IGV_ONE ELSE 1 END));
                L_IGV_SINCREDITO_SOLES := L_TOTAL_SINCREDITO_SOLES - L_BASE_SINCREDITO_SOLES;
                L_OUT_INAFECTA_SOLES := L_INAFECTA_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES + L_INAFECTA_SOLES +  L_OTROS_SOLES;
            -- ELSIF P_ID_COMPROBANTE='08' then -- NOTA DE DEBITO
            -- ELSIF P_ID_COMPROBANTE='87' then -- NOTA DE CREDITO ESPECIAL
            -- ELSIF P_ID_COMPROBANTE='88' then -- NOTA DE DEBITO ESPECIAL
            ELSIF P_ID_COMPROBANTE='14' then  -- SERVICIOS PUBLICO
                L_TOTAL_SINCREDITO_SOLES := (L_IMPORTE_SOLES - L_INAFECTA_SOLES - L_OTROS_SOLES);
                L_BASE_SINCREDITO_SOLES := (L_TOTAL_SINCREDITO_SOLES/(CASE WHEN P_GET_IGV THEN L_PERCENT_IGV_ONE ELSE 1 END));
                L_IGV_SINCREDITO_SOLES := L_TOTAL_SINCREDITO_SOLES - L_BASE_SINCREDITO_SOLES;
                L_OUT_INAFECTA_SOLES := L_INAFECTA_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES + L_INAFECTA_SOLES +  L_OTROS_SOLES;
            ELSIF P_ID_COMPROBANTE='12' then  -- TICKET O CINTA EMITIDA
                L_TOTAL_SINCREDITO_SOLES := (L_IMPORTE_SOLES - L_INAFECTA_SOLES - L_OTROS_SOLES);
                L_BASE_SINCREDITO_SOLES := (L_TOTAL_SINCREDITO_SOLES/(CASE WHEN P_GET_IGV THEN L_PERCENT_IGV_ONE ELSE 1 END));
                L_IGV_SINCREDITO_SOLES := L_TOTAL_SINCREDITO_SOLES - L_BASE_SINCREDITO_SOLES;
                L_OUT_INAFECTA_SOLES := L_INAFECTA_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES + L_INAFECTA_SOLES +  L_OTROS_SOLES;
            ELSIF P_ID_COMPROBANTE='15' then  -- BOLETA SERVICIO TRANSPORTE TERRESTRE
                L_TOTAL_SINCREDITO_SOLES := (L_IMPORTE_SOLES - L_INAFECTA_SOLES - L_OTROS_SOLES);
                L_BASE_SINCREDITO_SOLES := (L_TOTAL_SINCREDITO_SOLES/ (CASE WHEN P_GET_IGV THEN L_PERCENT_IGV_ONE ELSE 1 END));
                L_IGV_SINCREDITO_SOLES := L_TOTAL_SINCREDITO_SOLES - L_BASE_SINCREDITO_SOLES;
                L_OUT_INAFECTA_SOLES := L_INAFECTA_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES + L_INAFECTA_SOLES +  L_OTROS_SOLES;
            ELSIF P_ID_COMPROBANTE='13' then  -- DOCUMENTO SISTEMA FINANCIERO SEGUROS
                L_TOTAL_SINCREDITO_SOLES := (L_IMPORTE_SOLES - L_INAFECTA_SOLES - L_OTROS_SOLES);
                L_BASE_SINCREDITO_SOLES := (L_TOTAL_SINCREDITO_SOLES/ (CASE WHEN P_GET_IGV THEN L_PERCENT_IGV_ONE ELSE 1 END));
                L_IGV_SINCREDITO_SOLES := L_TOTAL_SINCREDITO_SOLES - L_BASE_SINCREDITO_SOLES;
                L_OUT_INAFECTA_SOLES := L_INAFECTA_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES + L_INAFECTA_SOLES +  L_OTROS_SOLES;
            ELSIF P_ID_COMPROBANTE='16' then  -- 16-Boletos de viaje emitidos por las empresas de transporte nacional de pasajeros
                L_TOTAL_SINCREDITO_SOLES := L_IMPORTE_SOLES;
                L_BASE_SINCREDITO_SOLES := L_IMPORTE_SOLES;
                L_IGV_SINCREDITO_SOLES := 0;
                L_OUT_INAFECTA_SOLES := L_IMPORTE_SOLES;

                P_BASE := L_BASE_SINCREDITO_SOLES;
                P_IGV := L_IGV_SINCREDITO_SOLES;
                P_OUT_INAFECTA := L_OUT_INAFECTA_SOLES;
                P_TOTAL := L_TOTAL_SINCREDITO_SOLES;
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_compra_calcular ( P_ID_COMPROBANTE text, P_GET_IGV boolean, P_TIPOCAMBIO bigint,P_ID_MONEDA bigint, P_IMPORTE bigint, P_TAXS bigint, P_INAFECTA bigint, P_OTROS bigint,P_PERCENT_IGV bigint, P_BASE OUT bigint, P_IGV OUT bigint, P_OUT_INAFECTA OUT bigint, P_TOTAL OUT bigint, P_IMPORTE_ME OUT bigint ) FROM PUBLIC;
