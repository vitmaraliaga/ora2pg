-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_actualizar_total_compra (P_ID_COMPRA bigint) AS $body$
DECLARE

        L_BASE_GRAVADA decimal(10,2);
        L_IGV_GRAVADA decimal(10,2);
        L_BASE_MIXTA decimal(10,2);
        L_IGV_MIXTA decimal(10,2);
        L_BASE_NOGRAVADA decimal(10,2);
        L_IGV_NOGRAVADA decimal(10,2);
        L_BASE_SINCREDITO decimal(10,2);
        L_OTROS decimal(10,2);

BEGIN
            /*BASE_GRAVADA = 1
            IGV_GRAVADO
            BASE_MIXTA = 2
            IGV_MIXTO
            BASE_NOGRAVADA = 3
            IGV_NOGRAVADO
            BASE_SINCREDITO = 4 Facturas y Boletas sin IGV
            IGV_SINCREDITO = No se Usará
            BASE_INAFECTA = No se Usará 
            OTROS = Boletas (Solo UPN)
            BASE (TOTAL_BASE)
            en el RC la Column = VALOR DE LAS ADQUISICIONES NO GRAVADAS = BASE_SINCREDITO*/
            
            SELECT 
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 1 THEN BASE ELSE 0 END),0) AS BASE_GRAVADA,
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 1 THEN IGV ELSE 0 END),0) AS IGV_GRAVADA,
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 2 THEN BASE ELSE 0 END),0) AS BASE_MIXTA,
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 2 THEN IGV ELSE 0 END),0) AS IGV_MIXTA,
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 3 THEN BASE ELSE 0 END),0) AS BASE_NOGRAVADA,
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 3 THEN IGV ELSE 0 END),0) AS IGV_NOGRAVADA,
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 4 THEN IMPORTE ELSE 0 END),0) AS BASE_SINCREDITO,
            COALESCE(SUM(CASE ID_CTIPOIGV WHEN 6 THEN IMPORTE ELSE 0 END),0) AS OTROS
            INTO STRICT L_BASE_GRAVADA,L_IGV_GRAVADA,L_BASE_MIXTA,L_IGV_MIXTA,L_BASE_NOGRAVADA,L_IGV_NOGRAVADA,L_BASE_SINCREDITO,L_OTROS
            FROM COMPRA_DETALLE
            WHERE ID_COMPRA = P_ID_COMPRA;

            UPDATE COMPRA SET
            IGV = L_IGV_GRAVADA+L_IGV_NOGRAVADA+L_IGV_MIXTA,
            BASE_GRAVADA = L_BASE_GRAVADA,
            BASE_NOGRAVADA = L_BASE_NOGRAVADA,
            BASE_MIXTA = L_BASE_MIXTA,
            BASE_SINCREDITO = L_BASE_SINCREDITO,
            IGV_GRAVADO = L_IGV_GRAVADA,
            IGV_NOGRAVADO = L_IGV_NOGRAVADA,
            IGV_MIXTO = L_IGV_MIXTA,
            OTROS = L_OTROS,
            BASE = L_BASE_GRAVADA+L_BASE_NOGRAVADA+L_BASE_MIXTA+L_BASE_SINCREDITO+L_OTROS
            WHERE ID_COMPRA = P_ID_COMPRA;
            --ACTUALIZA COSTOS VINCULADOS
            CALL pkg_purchases_sp_compra_costo_vinculado(P_ID_COMPRA);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_actualizar_total_compra (P_ID_COMPRA bigint) FROM PUBLIC;
