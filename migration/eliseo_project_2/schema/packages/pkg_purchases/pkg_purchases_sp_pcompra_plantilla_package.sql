-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_pcompra_plantilla (P_ID_PLANTILLA bigint,P_ID_PEDIDO bigint) AS $body$
DECLARE

        L_ID_PPCOMPRA bigint;
        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_ID_TIPOPLAN bigint;
        L_ID_CUENTAAASI varchar(50);
        L_ID_RESTRICCION varchar(50);
        L_PORCENTAJE decimal(10,2);
        L_CANTIDAD decimal(10,2) :=1;
        L_PRECIO decimal(10,2);
        L_ID_CTACTE varchar(50);
        L_IMPORTE decimal(10,2);

        DETA CURSOR FOR		
        SELECT ID_ENTIDAD,ID_DEPTO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_CTACTE,PORCENTAJE
        FROM COMPRA_PLANTILLA_DETALLE 
        WHERE ID_PLANTILLA = P_ID_PLANTILLA;

BEGIN
        
            SELECT IMPORTE INTO STRICT L_IMPORTE FROM PEDIDO_COMPRA
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            OPEN DETA;
                FETCH DETA INTO L_ID_ENTIDAD, L_ID_DEPTO, L_ID_TIPOPLAN,L_ID_CUENTAAASI, L_ID_RESTRICCION,L_ID_CTACTE,L_PORCENTAJE;
                WHILE DETA%FOUND LOOP
                    SELECT
                            coalesce(MAX(ID_PPCOMPRA),0)+1 INTO STRICT L_ID_PPCOMPRA
                    FROM PEDIDO_PLANTILLA_COMPRA;
                    INSERT INTO PEDIDO_PLANTILLA_COMPRA(ID_PPCOMPRA,ID_PEDIDO,ID_ENTIDAD,ID_DEPTO,ID_FONDO,ID_TIPOPLAN,ID_CUENTAAASI,ID_RESTRICCION,ID_CTACTE,PORCENTAJE,CANTIDAD,PRECIO,IMPORTE,IMPORTE_ME,ESTADO)
                    VALUES(L_ID_PPCOMPRA,P_ID_PEDIDO,L_ID_ENTIDAD,L_ID_DEPTO,'10',L_ID_TIPOPLAN,L_ID_CUENTAAASI,L_ID_RESTRICCION,L_ID_CTACTE,L_PORCENTAJE,L_CANTIDAD,(L_PORCENTAJE/100)*L_IMPORTE,(L_PORCENTAJE/100)*L_IMPORTE,0,'1');

                FETCH DETA INTO L_ID_ENTIDAD, L_ID_DEPTO, L_ID_TIPOPLAN,L_ID_CUENTAAASI, L_ID_RESTRICCION,L_ID_CTACTE,L_PORCENTAJE;
                END LOOP;
            CLOSE DETA;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_pcompra_plantilla (P_ID_PLANTILLA bigint,P_ID_PEDIDO bigint) FROM PUBLIC;
