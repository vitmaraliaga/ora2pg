-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_crear_recibo_honorario (P_ID_PEDIDO bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO bigint, P_ID_ANHO bigint, P_ID_MES bigint, P_ID_PERSONA bigint, P_ID_PROVEEDOR bigint, P_ID_COMPROBANTE text, P_ID_MONEDA bigint, P_ID_TIPOTRANSACCION bigint, P_TIPOCAMBIO bigint, P_FECHA_DOC timestamp(0), P_SERIE text, P_NUMERO text, P_IMPORTE bigint, P_IMPORTE_RETENER bigint, P_TIENE_SUSPENCION text, P_ES_ELECTRONICA text, P_ERROR OUT bigint, P_ID_COMPRA INOUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

       L_IMPORTE_ME        bigint := 0;
       L_IMPORTE           bigint := 0;
       L_IMPORTE_RENTA     bigint := 0;

       --L_ID_TIPOTRANSACCION numeric:=25;
       L_FECHA_PROVISION   timestamp(0) := clock_timestamp();
       L_ESTADO            bigint := 0;
       L_BASE_OF_TABLE     bigint := 0;

       L_ID_ASIENTO        bigint := 0;

       -- Variables debito retencion RH---------------------------
       L_FONDO             varchar(50) := '';
       L_DEPTO             varchar(50) := '';
       L_CUENTA            bigint := 0;
       L_CUENTA_CTE        varchar(50) := '';
       L_RESTRICCION       varchar(50) := '';
       L_DESCRIPCION       varchar(50) := '';
       ---------------------------------------
       L_ERROR             bigint := 0;
       L_ID_COMPRA         bigint := 0;
       L_MSGERROR          varchar(300) := '';
       L_CORRELATIVO       bigint := 0;

BEGIN
       L_ERROR := 0;

       -- L_ID_COMPRA := P_ID_COMPRA;
        IF L_ERROR = 0 THEN
            IF P_ID_MONEDA = 7 THEN    -- Soles
                L_IMPORTE := P_IMPORTE;
                L_IMPORTE_ME := NULL;
            ELSIF P_ID_MONEDA = 9 THEN  -- Dolares
                L_IMPORTE := (P_IMPORTE * P_TIPOCAMBIO);
                L_IMPORTE_ME := P_IMPORTE;
            END IF;

            L_IMPORTE_RENTA := P_IMPORTE_RETENER;
            L_BASE_OF_TABLE := L_IMPORTE;

            IF P_ID_COMPRA <> 0 THEN    -- UPDATE
                -- Eliminar de compra_asiento.
                --DELETE COMPRA_ASIENTO
                --WHERE ID_COMPRA = P_ID_COMPRA AND EDITABLE = 'N';
                -- Eliminar de conta asiento.
                --DELETE CONTA_ASIENTO
                --WHERE ID_TIPOORIGEN = 3 AND ID_ORIGEN = P_ID_COMPRA;
                -- Eliminar asientos de la retencion del RH
                --DELETE CONTA_ASIENTO
                --WHERE ID_TIPOORIGEN = 14 AND ID_ORIGEN = P_ID_COMPRA;
                SELECT CORRELATIVO INTO STRICT L_CORRELATIVO
                FROM COMPRA
                WHERE ID_COMPRA = P_ID_COMPRA;

                UPDATE COMPRA SET
                                ID_PROVEEDOR = P_ID_PROVEEDOR,
                                ID_MONEDA = P_ID_MONEDA,
                                --ID_VOUCHER = P_ID_VOUCHER_COMPRA,
                                TIPOCAMBIO = P_TIPOCAMBIO,
                                FECHA_PROVISION = L_FECHA_PROVISION,
                                FECHA_DOC = P_FECHA_DOC,
                                SERIE = P_SERIE,
                                NUMERO = P_NUMERO,
                                IMPORTE = L_IMPORTE,
                                IMPORTE_ME = L_IMPORTE_ME,
                                ESTADO = L_ESTADO,
                                IMPORTE_RENTA = L_IMPORTE_RENTA,
                                TIENE_SUSPENCION = P_TIENE_SUSPENCION,
                                BASE = L_BASE_OF_TABLE
                WHERE ID_COMPRA = P_ID_COMPRA;
                L_ID_COMPRA := P_ID_COMPRA;
            ELSE
                SELECT coalesce(MAX(ID_COMPRA), 0) + 1 INTO STRICT L_ID_COMPRA
                FROM COMPRA;

                SELECT coalesce(MAX(CORRELATIVO), 0) + 1 INTO STRICT L_CORRELATIVO
                FROM COMPRA
                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                AND ID_DEPTO = P_ID_DEPTO
                --AND ID_VOUCHER = P_ID_VOUCHER_COMPRA
                AND ID_COMPROBANTE = '02';

                INSERT INTO COMPRA(ID_COMPRA,
                                    ID_ENTIDAD,
                                    ID_ANHO,
                                    ID_DEPTO,
                                    ID_MES,
                                    ID_PERSONA,
                                    ID_PROVEEDOR,
                                    ID_COMPROBANTE,
                                    ID_MONEDA,
                                    ID_TIPOTRANSACCION,
                                    TIPOCAMBIO,
                                    FECHA_PROVISION,
                                    FECHA_DOC,
                                    SERIE,
                                    NUMERO,
                                    IMPORTE,
                                    IMPORTE_ME,
                                    ESTADO,
                                    ES_ELECTRONICA,
                                    IMPORTE_RENTA,
                                    TIENE_SUSPENCION,
                                    BASE,
                                    CORRELATIVO)
                     VALUES (L_ID_COMPRA,
                             P_ID_ENTIDAD,
                             P_ID_ANHO,
                             P_ID_DEPTO,
                             P_ID_MES,
                             P_ID_PERSONA,
                             P_ID_PROVEEDOR,
                             P_ID_COMPROBANTE,
                             P_ID_MONEDA,
                             P_ID_TIPOTRANSACCION,
                             P_TIPOCAMBIO,
                             L_FECHA_PROVISION,
                             P_FECHA_DOC,
                             P_SERIE,
                             P_NUMERO,
                             L_IMPORTE,
                             L_IMPORTE_ME,
                             L_ESTADO,
                             P_ES_ELECTRONICA,
                             L_IMPORTE_RENTA,
                             P_TIENE_SUSPENCION,
                             L_BASE_OF_TABLE,
                             L_CORRELATIVO);

                UPDATE PEDIDO_COMPRA SET ID_COMPRA = L_ID_COMPRA
                WHERE ID_PEDIDO = P_ID_PEDIDO
                AND coalesce(ID_COMPRA::text, '') = '';
            END IF;

        END IF;
       P_ERROR := L_ERROR;
       P_ID_COMPRA := L_ID_COMPRA;
       P_MSGERROR := L_MSGERROR;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_crear_recibo_honorario (P_ID_PEDIDO bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO bigint, P_ID_ANHO bigint, P_ID_MES bigint, P_ID_PERSONA bigint, P_ID_PROVEEDOR bigint, P_ID_COMPROBANTE text, P_ID_MONEDA bigint, P_ID_TIPOTRANSACCION bigint, P_TIPOCAMBIO bigint, P_FECHA_DOC timestamp(0), P_SERIE text, P_NUMERO text, P_IMPORTE bigint, P_IMPORTE_RETENER bigint, P_TIENE_SUSPENCION text, P_ES_ELECTRONICA text, P_ERROR OUT bigint, P_ID_COMPRA INOUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
