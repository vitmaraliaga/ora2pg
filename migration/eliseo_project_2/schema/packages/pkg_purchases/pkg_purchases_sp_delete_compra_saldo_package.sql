-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_delete_compra_saldo (P_ID_SALDO bigint, P_ERROR OUT bigint, P_MSG OUT text) AS $body$
DECLARE

   L_ID_ENTIDAD       bigint;
   L_ID_DEPTO         varchar(10);
   L_ID_ANHO          bigint;
   L_ID_PROVEEDOR     bigint;
   L_ID_COMPROBANTE   bigint;
   L_SERIE            varchar(4);
   L_NUMERO           varchar(8);
   L_CANT             bigint;

        
BEGIN
            P_ERROR :=0;
            
            SELECT ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_PROVEEDOR,ID_COMPROBANTE,SERIE,NUMERO INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_ANHO,L_ID_PROVEEDOR,L_ID_COMPROBANTE,L_SERIE,L_NUMERO
            FROM COMPRA_SALDO
            WHERE ID_SALDO = P_ID_SALDO;

            SELECT COUNT(1) INTO STRICT L_CANT 
            FROM VW_PURCHASES_MOV
            WHERE ID_ENTIDAD = L_ID_ENTIDAD
            AND ID_DEPTO = L_ID_DEPTO
            AND ID_ANHO = L_ID_ANHO
            AND ID_PROVEEDOR = L_ID_PROVEEDOR
            AND ID_COMPROBANTE = L_ID_COMPROBANTE
            AND SERIE = L_SERIE
            AND NUMERO = L_NUMERO;

            IF L_CANT = 1 THEN 
                
                DELETE FROM COMPRA_SALDO
                WHERE ID_SALDO = P_ID_SALDO;

                P_ERROR:=0;
                P_MSG :='OK';
            ELSE
                P_ERROR:=1;
                P_MSG :='ERROR: La compra ya tiene ya esta cancelada, no se puede Eliminar';
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_delete_compra_saldo (P_ID_SALDO bigint, P_ERROR OUT bigint, P_MSG OUT text) FROM PUBLIC;
