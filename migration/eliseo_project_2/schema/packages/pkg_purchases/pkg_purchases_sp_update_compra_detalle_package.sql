-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_update_compra_detalle (P_ID_COMPRA bigint,P_ID_DETALLE bigint,P_CANTIDAD bigint,P_IMPORTE bigint, P_ID_CTIPOIGV bigint DEFAULT NULL) AS $body$
DECLARE

        L_ID_CTIPOIGV varchar(2);
        L_PRECIO decimal(10,2);
        L_BASE decimal(10,2);
        L_IGV decimal(10,2);
        L_ID_IGV decimal(10,2);

    
BEGIN
        SELECT coalesce(ID_IGV,18) INTO STRICT L_ID_IGV FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;

        --INSERT INTO TEST1(ID_TEST,NOM)VALUES(1,P_ID_CTIPOIGV||'***'||P_ID_COMPRA);
        
        IF P_ID_CTIPOIGV = 0 OR coalesce(P_ID_CTIPOIGV::text, '') = '' THEN
            SELECT ID_CTIPOIGV INTO STRICT L_ID_CTIPOIGV FROM COMPRA_DETALLE 
            WHERE ID_DETALLE = P_ID_DETALLE;
        ELSE
            L_ID_CTIPOIGV := P_ID_CTIPOIGV;
        END IF;

        --SELECT ID_CTIPOIGV INTO L_ID_CTIPOIGV FROM COMPRA_DETALLE 
        --WHERE ID_DETALLE = P_ID_DETALLE;
        
        IF L_ID_CTIPOIGV = 1 OR L_ID_CTIPOIGV = 2 OR L_ID_CTIPOIGV = 3 THEN 
            L_PRECIO := P_IMPORTE/P_CANTIDAD;
            L_BASE := P_IMPORTE/(1+(L_ID_IGV/100));
            L_IGV := L_BASE*(L_ID_IGV/100);
        ELSE
            L_PRECIO := P_IMPORTE/P_CANTIDAD;
            L_IGV := 0;
            L_BASE := P_IMPORTE;
        END IF;

        UPDATE COMPRA_DETALLE SET ID_CTIPOIGV = L_ID_CTIPOIGV, CANTIDAD = P_CANTIDAD, PRECIO = L_PRECIO, BASE = L_BASE, IGV = L_IGV, IMPORTE = P_IMPORTE
        WHERE ID_DETALLE = P_ID_DETALLE;

        CALL pkg_purchases_sp_actualizar_total_compra(P_ID_COMPRA);

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_update_compra_detalle (P_ID_COMPRA bigint,P_ID_DETALLE bigint,P_CANTIDAD bigint,P_IMPORTE bigint, P_ID_CTIPOIGV bigint DEFAULT NULL) FROM PUBLIC;
