-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;

    
    /*
    PROCEDURE SP_COMPRA_ACTUALIZAR(
        P_TIPO varchar,
        P_ID_PROVEEDOR numeric,
        P_ID_COMPROBANTE varchar,
        P_ES_ELECTRONICA IN varchar,
        P_ES_TRANSPORTE_CARGA IN varchar,
        P_ID_PARENT IN OUT numeric,
        P_SERIE IN varchar,
        P_NUMERO IN varchar,
        P_FECHA_DOC IN timestamp,
        P_ID_MONEDA IN numeric,
        P_IMPORTE IN numeric,
        P_TAXS IN numeric,
        P_BASE_INAFECTA IN numeric,
        P_OTROS IN OUT numeric,
        P_ES_RET_DET IN varchar,
        P_TIPOCAMBIO IN numeric,
        
        P_ID_VOUCHER numeric,
        -- P_ID_ENTIDAD numeric,
        -- P_ID_DEPTO numeric,
        -- P_ID_PERSONA numeric,
        -- P_ID_ANHO numeric,
        -- P_ID_MES numeric,
        
        P_ERROR OUT numeric,
        P_ID_COMPRA IN OUT numeric,
        P_MSGERROR OUT varchar
    ) IS
     L_ID_TIPOTRANSACCION numeric(10,2);
        L_ID_TIPONOTA varchar(3);
        L_FECHA_ALMACEN timestamp;
        L_FECHA_PROVISION timestamp := sysdate;
        
        L_ESTADO numeric;
        L_ES_ACTIVO varchar(1);
        L_TIENE_KARDEX varchar(1);
        L_IMPORTE_RENTA numeric(10,2);
        L_TIENE_SUSPENCION varchar(1);
        L_BASE_OF_TABLE numeric(10,2) := NULL;
        
        -- VARIABLES DE CALCULO.
        L_BASE numeric(10,2) := 0;
        L_IGV numeric(10,2) := 0;
        L_OUT_INAFECTA numeric(10,2) := 0;
        L_TOTAL numeric(10,2) := 0;
        L_IMPORTE_ME numeric(10,2) := 0;
        
        
        -- VARIABLES DE DESTINO
        L_BASE_GRAVADA numeric(10,2);
        L_IGV_GRAVADO numeric(10,2);
        L_BASE_MIXTA numeric(10,2);
        L_IGV_MIXTO numeric(10,2);
        L_BASE_NOGRAVADA numeric(10,2);
        L_IGV_NOGRAVADO numeric(10,2);

        L_BASE_SINCREDITO numeric(10,2); -- SOLO PARA NO BOLETAS DE VENTAS
        L_BASE_INAFECTA numeric(10,2); -- SOLO PARA BOLETAS DE VENTAS
        L_OTROS numeric(10,2);
        
        -- RETURN DATOS
        L_MSGERROR varchar(200):= '';
        L_ERROR numeric := 0;
        L_ID_COMPRA numeric := 0;
    BEGIN
            pkg_purchases_sp_compra_calcular(
            -- IN
            P_ID_COMPROBANTE, P_TIPOCAMBIO, P_ID_MONEDA, P_IMPORTE, P_TAXS, P_BASE_INAFECTA, P_OTROS, 
            -- OUT
            L_BASE, L_IGV, L_OUT_INAFECTA, L_TOTAL, L_IMPORTE_ME);
            
            pkg_purchases_sp_compra_destino_operacion(
            -- IN
            P_ID_COMPROBANTE, P_TIPO, L_BASE, L_IGV, L_OUT_INAFECTA,
            -- OUT
            L_BASE_GRAVADA, L_IGV_GRAVADO, L_BASE_MIXTA, L_IGV_MIXTO,
            L_BASE_NOGRAVADA, L_IGV_NOGRAVADO, L_BASE_SINCREDITO, L_BASE_INAFECTA, L_OTROS);
            
            IF P_ID_COMPROBANTE='01' then -- FACTURA
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='02' then -- RECIBO POR HONORARIO 
                L_ERROR := 1;
                L_MSGERROR := 'Tipo de documento no aceptado.';
            ELSIF P_ID_COMPROBANTE='03' then -- BOLETA DE VENTA
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='04' then -- LIQUIDACIÃ“N COMPRA
                 -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='05' then -- BOLETA AEREO
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='07' then -- NOTA DE CREDITO
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := '04';       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='08' then -- NOTA DE DEBITO
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := '11';       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='87' then -- NOTA DE CREDITO ESPECIAL
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := '04';       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='88' then -- NOTA DE DEBITO ESPECIAL
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := '11';       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
             
            ELSIF P_ID_COMPROBANTE='14' then -- SERVICIOS PUBLICO
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
                
            ELSIF P_ID_COMPROBANTE='12' then -- TICKET O CINTA EMITIDA
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
             
            ELSIF P_ID_COMPROBANTE='15' then -- BOLETA SERVICIO TRANSPORTE TERRESTRE
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
            ELSIF P_ID_COMPROBANTE='13' then -- DOCUMENTO SISTEMA FINANCIERO SEGUROS
                -- ID_TIPONOTA
                -- 04	07	Descuento global
                -- 11	08	Aumento en el valor
                L_ID_TIPOTRANSACCION := 17; -- COMPRAS DIVERSAS        
                L_ID_TIPONOTA := NULL;       
                L_FECHA_ALMACEN := NULL;     
                P_ID_PARENT := NULL;
                
                L_ESTADO := 0;
                L_ES_ACTIVO := NULL;
                L_TIENE_KARDEX := NULL;
                L_IMPORTE_RENTA := NULL;
                L_TIENE_SUSPENCION := NULL;
            ELSE
                L_ERROR := 1;
                L_MSGERROR := 'Tipo de documento no aceptado.';
            END IF;
            
            
            IF L_ERROR = 0 THEN
                L_BASE_OF_TABLE := (L_BASE_GRAVADA+L_BASE_NOGRAVADA+L_BASE_MIXTA);
                
                UPDATE COMPRA
                SET ID_PARENT = P_ID_PARENT,
                    -- ID_ENTIDAD = P_ID_ENTIDAD, ID_ANHO = P_ID_ANHO, ID_DEPTO = P_ID_DEPTO, ID_MES = P_ID_MES, ID_PERSONA = P_ID_PERSONA,
                    ID_PROVEEDOR = P_ID_PROVEEDOR, ID_COMPROBANTE = P_ID_COMPROBANTE, ID_MONEDA = P_ID_MONEDA, ID_VOUCHER = P_ID_VOUCHER, ID_TIPOTRANSACCION = L_ID_TIPOTRANSACCION,
                    TIPOCAMBIO = P_TIPOCAMBIO, FECHA_ALMACEN = L_FECHA_ALMACEN, FECHA_PROVISION = L_FECHA_PROVISION, FECHA_DOC = P_FECHA_DOC, SERIE = P_SERIE,
                    NUMERO = P_NUMERO, IMPORTE = L_TOTAL, IMPORTE_ME = L_IMPORTE_ME, IGV = (L_IGV_GRAVADO+L_IGV_MIXTO+L_IGV_NOGRAVADO), BASE_GRAVADA = L_BASE_GRAVADA,
                    BASE_NOGRAVADA = L_BASE_NOGRAVADA, BASE_MIXTA = L_BASE_MIXTA, BASE_SINCREDITO = L_BASE_SINCREDITO, BASE_INAFECTA = L_BASE_INAFECTA, IGV_GRAVADO = L_IGV_GRAVADO,
                    IGV_NOGRAVADO = L_IGV_NOGRAVADO, IGV_MIXTO = L_IGV_MIXTO, ESTADO = L_ESTADO, OTROS = L_OTROS, ES_RET_DET = P_ES_RET_DET, ES_ACTIVO = L_ES_ACTIVO,
                    TIENE_KARDEX = L_TIENE_KARDEX, ES_ELECTRONICA = P_ES_ELECTRONICA, IMPORTE_RENTA = L_IMPORTE_RENTA, TIENE_SUSPENCION = L_TIENE_SUSPENCION, BASE = L_BASE_OF_TABLE
                WHERE ID_COMPRA = L_ID_COMPRA;
                
                 -- Crear Asientos por defecto
                pkg_purchases_sp_compra_asiento_default_gene(
                P_ID_ENTIDAD, P_ID_PROVEEDOR, 
                L_BASE, L_TOTAL, L_IGV, L_IMPORTE_ME,
                P_ID_DEPTO, P_ID_ANHO, L_ID_COMPRA);
             END IF;
            
            P_ERROR := L_ERROR;
            P_MSGERROR := L_MSGERROR;
            P_ID_COMPRA := L_ID_COMPRA;
    END SP_COMPRA_ACTUALIZAR;
    */
    


CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_compra_asiento_default_gene ( P_ID_COMPRA bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE


        --L_CANTIDAD_DINAMICAS numeric;
        --L_NOMBRETIPOTRANSACCION varchar(100);
    
        --L_ID_DINAMICA numeric := NULL;
        L_ID_ASIENTO bigint;
        L_ID_PARENT bigint;
        L_ID_TIPO_PLAN bigint;
        L_ID_RESTRICCION varchar(50);
        L_ID_CUENTAAASI varchar(10);
        L_DC varchar(1);
        L_DESTINO varchar(1);
        L_ID_INDICADOR varchar(35);
        L_UNICO varchar(1);
        L_UNICOCTACTE varchar(1);
        L_PORCENTAJE decimal(10,2);
        L_DESCRIPCION varchar(255);
        L_AGRUPA varchar(1);

        --L_IMPORTEASIENTO numeric(10,2);
        L_IMPORTEASIENTO decimal(10,2);
        L_IMPORTEASIENTO_ME decimal(10,2);

        L_DEPTO varchar(10);
        l_DEPTOS varchar(200) := '';
        L_CUENTA_CTE varchar(50);
        L_CTATES varchar(200);

        L_BUSCAR bigint;

        L_CTAS varchar(200);

        L_ACTAS tablastring;
        L_ADEPTOS tablastring;
        L_ACTATES tablastring;

        --validacion
        L_CONT bigint;

        L_ID_CASIENTO varchar(50);
        L_ID_FONDO varchar(50);
        L_CORRELATIVO bigint;
        L_ID_COMPROBANTE varchar(20);
        L_ID_COMPROBANTE_NC varchar(25);
        L_ID_DEPTO_COMPRA varchar(20);
        L_ES_CREDITO varchar(1);
        L_ID_PROVEEDOR bigint;
        L_SERIE varchar(50);
        L_NUMERO varchar(50);
        L_ID_DINAMICA bigint;
		L_IMPORTE decimal(10,2);
        L_IMPORTE_ME decimal(10,2);
        L_IGV decimal(10,2);
        L_BASE decimal(10,2);
        L_ID_ENTIDAD bigint;
        L_EDITABLE varchar(1) := 'N';

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,
        a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA,A.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =L_ID_DINAMICA
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC;

    
BEGIN
    
        P_ERROR :=0;
        /*
        SELECT COUNT(ID_DINAMICA) INTO L_CANTIDAD_DINAMICAS
        FROM CONTA_DINAMICA
        WHERE ID_ENTIDAD=P_ID_ENTIDAD 
            AND ID_DEPTO=P_ID_DEPTO
            AND ID_ANHO=P_ID_ANHO
            AND ID_MODULO=P_ID_MODULO
            AND ID_TIPOTRANSACCION=P_ID_TIPOTRANSACCION
            AND ACTIVO='S';
        
        SELECT NOMBRE INTO L_NOMBRETIPOTRANSACCION FROM TIPO_TRANSACCION WHERE ID_TIPOTRANSACCION = P_ID_TIPOTRANSACCION;
        
        IF L_CANTIDAD_DINAMICAS = 0 THEN 
            P_ERROR :=1;
            P_MSGERROR := 'No existe dinÃ¡mica contable para el tipo de transacciÃ³n: ' || L_NOMBRETIPOTRANSACCION;
        ELSIF L_CANTIDAD_DINAMICAS > 1 THEN
            P_ERROR :=1;
            P_MSGERROR := 'Existe mas de una dinÃ¡mica contable para el tipo de transacciÃ³n: ' || L_NOMBRETIPOTRANSACCION;
        END IF;
        */
        IF P_ERROR = 0 THEN
        /*
            SELECT ID_DINAMICA INTO L_ID_DINAMICA FROM CONTA_DINAMICA
            WHERE ID_ENTIDAD=P_ID_ENTIDAD 
                AND ID_DEPTO=P_ID_DEPTO
                AND ID_ANHO=P_ID_ANHO
                AND ID_MODULO=P_ID_MODULO
                AND ID_TIPOTRANSACCION=P_ID_TIPOTRANSACCION
                AND ACTIVO='S';
                */
            
            -- Datos de la compra.
            SELECT ID_ENTIDAD,CORRELATIVO, ID_DEPTO, ES_CREDITO, ID_COMPROBANTE, ID_PROVEEDOR, SERIE, NUMERO, ID_DINAMICA, 
                CASE WHEN ID_ENTIDAD=7124 THEN COALESCE(IMPORTE,0)-COALESCE(IMPORTE_RENTA,0)  ELSE COALESCE(IMPORTE,0) END ,
            	--COALESCE(IMPORTE,0), 
            	COALESCE(IMPORTE_ME,0), COALESCE(IGV,0), COALESCE(BASE,0)
            INTO STRICT L_ID_ENTIDAD, L_CORRELATIVO, L_ID_DEPTO_COMPRA, L_ES_CREDITO, L_ID_COMPROBANTE, L_ID_PROVEEDOR, L_SERIE, L_NUMERO, L_ID_DINAMICA,
            	L_IMPORTE, L_IMPORTE_ME, L_IGV, L_BASE
            FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;

            IF L_ID_ENTIDAD = 7124 THEN
                L_EDITABLE := 'S';
            END IF;

            SELECT NOMBRE_CORTO INTO STRICT L_ID_COMPROBANTE_NC FROM TIPO_COMPROBANTE WHERE ID_COMPROBANTE=L_ID_COMPROBANTE;

            --IF L_ID_DINAMICA IS NOT NULL THEN
                OPEN casi;
                FETCH casi INTO L_ID_ASIENTO, L_ID_PARENT, L_ID_TIPO_PLAN, L_ID_RESTRICCION,
                            L_ID_CUENTAAASI,L_DC, L_DESTINO, L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,
                            L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA, L_ID_FONDO;
                WHILE casi%FOUND LOOP

                    SELECT CASE L_ID_INDICADOR WHEN 'IMPORTE' then (L_IMPORTE)*(L_PORCENTAJE)
                          WHEN 'BASE' then (L_BASE)*(L_PORCENTAJE)
                          WHEN 'IGV' then (L_IGV)*(L_PORCENTAJE)
                          ELSE
                          0
                          END INTO STRICT L_IMPORTEASIENTO
;

                    
                    L_DEPTO:=NULL;
                    L_CUENTA_CTE:=NULL;

                    IF L_UNICO='U' THEN  -- Ãšnico
                        -- SELECT MAX(ID_DEPTO) INTO L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ENTIDAD=P_ID_ENTIDAD;
                        SELECT MAX(ID_DEPTO) INTO STRICT L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ASIENTO=L_ID_ASIENTO;
                    ELSIF (L_UNICO='M') THEN  -- Muchos
                        SELECT position('|' in l_DEPTOS) INTO STRICT L_BUSCAR;
                        IF L_BUSCAR>0 THEN
                            SELECT FC_SPLIT(L_CTAS,'|') INTO STRICT L_ACTAS;
                            SELECT FC_SPLIT(L_DEPTOS,'|') INTO STRICT L_ADEPTOS;
                            SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ADEPTOS ,L_ID_CUENTAAASI) INTO STRICT L_DEPTO;
                        ELSE
                            L_DEPTO:=L_DEPTOS;
                        END IF;
                    ELSIF L_UNICO='S' THEN  -- Si es sesiÃ³n
                        L_DEPTO := L_ID_DEPTO_COMPRA;
                    END IF;

                    IF L_ES_CREDITO = 'S' AND L_UNICOCTACTE='U' THEN
                        SELECT pkg_purchases_fc_ruc(L_ID_PROVEEDOR) into STRICT L_CUENTA_CTE;
                    ELSE
                        IF L_UNICOCTACTE='U' THEN
                          SELECT  count(*) INTO STRICT L_CONT FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=L_ID_ASIENTO;
                          if L_CONT>0 THEN
                            SELECT ID_CTACTE INTO STRICT L_CUENTA_CTE FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=L_ID_ASIENTO;
                          END IF;
                        ELSIF (L_UNICOCTACTE='M') THEN
                           SELECT position('|' in L_CTATES) INTO STRICT L_BUSCAR;
                           if l_buscar>0 THEN
                             SELECT FC_SPLIT(L_CTAS,'|') INTO STRICT L_ACTAS;
                             SELECT FC_SPLIT(L_CTATES,'|') INTO STRICT L_ACTATES;
                             SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ACTATES ,L_ID_CUENTAAASI) INTO STRICT L_CUENTA_CTE;
                           ELSE
                            L_CUENTA_CTE:=L_CTATES;
                           END IF;
                        ELSIF (L_UNICOCTACTE='X') THEN
                            SELECT pkg_purchases_fc_ruc(L_ID_PROVEEDOR) into STRICT L_CUENTA_CTE;
                        END IF;
                    END IF;
                   
                    IF L_DC='C' THEN
                        L_IMPORTEASIENTO:=L_IMPORTEASIENTO*(-1);
                        L_IMPORTEASIENTO_ME:=L_IMPORTE_ME*(-1);
                     ELSE
                        L_IMPORTEASIENTO := L_IMPORTEASIENTO;
                        L_IMPORTEASIENTO_ME := L_IMPORTE_ME;
                    END IF;

                    IF L_IMPORTEASIENTO<>0 THEN
                        --IF L_CONT=0 THEN
                        
                            --SELECT NVL(MAX(ID_CASIENTO),0)+1 INTO L_ID_CASIENTO FROM COMPRA_ASIENTO;
                            
                            INSERT INTO COMPRA_ASIENTO(
                             --ID_CASIENTO,
                             ID_COMPRA, ID_CUENTAAASI, ID_RESTRICCION, ID_CTACTE,
                             ID_FONDO, ID_DEPTO, IMPORTE,
                             DESCRIPCION,EDITABLE, ID_PARENT, ID_TIPOREGISTRO, DC, IMPORTE_ME, FECHA_ACTUALIZACION, AGRUPA
                            ) VALUES (
                             --L_ID_CASIENTO,
                             P_ID_COMPRA, L_ID_CUENTAAASI, L_ID_RESTRICCION, L_CUENTA_CTE,
                             L_ID_FONDO, L_DEPTO, L_IMPORTEASIENTO,
                             
                             SUBSTR((L_CORRELATIVO || ' | ' || L_ID_COMPROBANTE_NC || '. ' || L_SERIE || '-' || L_NUMERO || ' | ' || L_DESCRIPCION),1,50),
                             
                             L_EDITABLE, NULL, NULL, L_DC, L_IMPORTEASIENTO_ME, statement_timestamp(), L_AGRUPA
                            );
                         -- END IF;
                      END IF;

                    FETCH casi INTO L_ID_ASIENTO, L_ID_PARENT, L_ID_TIPO_PLAN, L_ID_RESTRICCION,
                            L_ID_CUENTAAASI,L_DC, L_DESTINO, L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,
                            L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA, L_ID_FONDO;
                    END LOOP;
                CLOSE casi;
            --END IF;
            P_ERROR :=0;
        END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_compra_asiento_default_gene ( P_ID_COMPRA bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
