-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_sp_crear_ajuste (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_COMPRA bigint, ID_DINAMICA bigint,P_ID_VOUCHER bigint,P_FECHA timestamp(0), P_IMPORTE bigint,P_IMPORTE_ME bigint,P_DC text, P_ID_AJUSTE OUT bigint,P_ERROR OUT bigint,P_ESTADO text default '1',P_ID_PROVEEDOR bigint DEFAULT NULL) AS $body$
DECLARE

        L_AJUSTE bigint;	
        L_ID_PROVEEDOR bigint;
        L_ID_MONEDA bigint;
        L_NUMERO varchar(8);
        L_TIPOORIGEN bigint :=4; --COMPRA TRANSFERENCIA O AJUS
        L_CANT bigint := 0;
        L_ID_COMPRA bigint;
        L_ID_SALDO bigint;

        L_ID_ANHO bigint := 2021;

        
BEGIN
            P_ERROR :=0;
            --BORRAS OPER CON ESTADO 0
            IF P_ID_ENTIDAD = 7124 THEN  --UPN HACE OTRO PROCESO
                SELECT COUNT(ID_AJUSTE) INTO STRICT L_CANT FROM COMPRA_AJUSTE WHERE ID_PERSONA = P_ID_PERSONA AND ESTADO = '0';
                IF L_CANT > 0 THEN
                    SELECT ID_AJUSTE INTO STRICT L_AJUSTE FROM COMPRA_AJUSTE WHERE ID_PERSONA = P_ID_PERSONA AND ESTADO = '0';
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_TIPOORIGEN AND ID_ORIGEN = L_AJUSTE AND coalesce(VOUCHER::text, '') = '';
                    DELETE FROM COMPRA_AJUSTE WHERE ID_PERSONA = P_ID_PERSONA AND ESTADO = '0';
                END IF;
            END IF;
                --P_ID_ANHO := 2021; --TEMPORAL
            L_ID_ANHO := P_ID_ANHO;
            SELECT COALESCE(MAX(ID_AJUSTE),0)+1 INTO STRICT L_AJUSTE FROM COMPRA_AJUSTE;

            SELECT COUNT(1) INTO STRICT L_CANT FROM COMPRA
            WHERE ID_COMPRA = P_ID_COMPRA
            AND ID_PROVEEDOR = case when coalesce(P_ID_PROVEEDOR::text, '') = '' then ID_PROVEEDOR else P_ID_PROVEEDOR end  -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Per
            AND ID_ANHO = L_ID_ANHO;
            IF L_CANT > 0 THEN
                SELECT ID_PROVEEDOR,ID_MONEDA INTO STRICT L_ID_PROVEEDOR, L_ID_MONEDA FROM COMPRA
                WHERE ID_COMPRA = P_ID_COMPRA
                AND ID_PROVEEDOR = case when coalesce(P_ID_PROVEEDOR::text, '') = '' then ID_PROVEEDOR else P_ID_PROVEEDOR end  -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Per
                AND ID_ANHO = L_ID_ANHO;
                L_ID_COMPRA := P_ID_COMPRA;
                L_ID_SALDO := NULL;
            ELSE
                SELECT COUNT(1) INTO STRICT L_CANT FROM COMPRA_SALDO
                WHERE ID_SALDO = P_ID_COMPRA
                AND ID_PROVEEDOR = case when coalesce(P_ID_PROVEEDOR::text, '') = '' then ID_PROVEEDOR else P_ID_PROVEEDOR end  -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Per
                AND ID_ANHO = L_ID_ANHO;
                IF L_CANT > 0 THEN
                    SELECT ID_PROVEEDOR,ID_MONEDA INTO STRICT L_ID_PROVEEDOR, L_ID_MONEDA FROM COMPRA_SALDO
                    WHERE ID_SALDO = P_ID_COMPRA
                    AND ID_PROVEEDOR = case when coalesce(P_ID_PROVEEDOR::text, '') = '' then ID_PROVEEDOR else P_ID_PROVEEDOR end  -- Si el valor de P_ID_PROVEEDOR es null entonces no validamos el proveedor (ello ocurre en los casos especiales de la Alma Mater) atte Ame del Per
                    AND ID_ANHO = L_ID_ANHO;
                    L_ID_SALDO := P_ID_COMPRA;
                    L_ID_COMPRA := NULL;
                ELSE
                    P_ERROR:=1;
                END IF;
            END IF;

            IF P_ERROR = 0 THEN
                SELECT LPAD(COALESCE(MAX((NUMERO)::numeric ),0)+1,8,0) INTO STRICT L_NUMERO FROM COMPRA_AJUSTE
                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                AND ID_DEPTO = P_ID_DEPTO;

                INSERT INTO COMPRA_AJUSTE(
                        ID_AJUSTE, 
                        ID_ENTIDAD,
                        ID_DEPTO,
                        ID_ANHO,
                        ID_MES,
                        ID_COMPRA,
                        ID_PERSONA,
                        ID_PROVEEDOR,
                        ID_DINAMICA,
                        ID_MONEDA,
                        ID_VOUCHER,
                        ID_TIPOORIGEN,
                        FECHA, 
                        NUMERO, 
                        IMPORTE,
                        IMPORTE_ME,
                        DC, 
                        ESTADO,
                        ID_SALDO
                )VALUES (
                        L_AJUSTE,
                        P_ID_ENTIDAD,
                        P_ID_DEPTO,
                        L_ID_ANHO,
                        P_ID_MES,
                        L_ID_COMPRA,
                        P_ID_PERSONA,
                        L_ID_PROVEEDOR,
                        ID_DINAMICA,
                        L_ID_MONEDA,
                        P_ID_VOUCHER,
                        L_TIPOORIGEN,
                        P_FECHA,
                        L_NUMERO,
                        P_IMPORTE,
                        P_IMPORTE_ME,
                        P_DC,
                        P_ESTADO,
                        L_ID_SALDO
                );
                P_ID_AJUSTE := L_AJUSTE;
                /*
                IF P_ID_ENTIDAD = 7124 THEN
                    P_ERROR:=0;
                    --GENERA ASIENTO CONTABLE
                END IF;
                */
                P_ERROR:=0;
            END IF;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_sp_crear_ajuste (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_COMPRA bigint, ID_DINAMICA bigint,P_ID_VOUCHER bigint,P_FECHA timestamp(0), P_IMPORTE bigint,P_IMPORTE_ME bigint,P_DC text, P_ID_AJUSTE OUT bigint,P_ERROR OUT bigint,P_ESTADO text default '1',P_ID_PROVEEDOR bigint DEFAULT NULL) FROM PUBLIC;
