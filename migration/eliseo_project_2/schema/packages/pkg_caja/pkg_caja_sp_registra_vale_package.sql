-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_registra_vale (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TIPOVALE integer,P_ID_PERSONA bigint,P_ID_EMPLEADO bigint, P_ID_MONEDA integer, P_FECHA timestamp(0), P_IMPORTE bigint, P_IMPORTE_ME bigint, P_DETALLE text,P_CELULAR text, P_EMAIL text, P_ID_VALE OUT bigint,P_FECHA_VENCIMIENTO timestamp(0),P_TERMINO_CONDICION text) AS $body$
DECLARE

        L_ID_VALE integer;
        L_TC decimal(10,3);
        L_ID_MONEDA_TC bigint;
        L_NRO_VALE varchar(20);
        L_IMPORTE decimal(10,2);
        L_CELULAR varchar(20);

        
BEGIN   
            L_CELULAR:= replace(P_CELULAR,' ','');
            L_ID_MONEDA_TC:=9;
            --obtiene tipo de cambio del dia
            SELECT FC_TIPOCAMBIO(L_ID_MONEDA_TC,CURRENT_DATE,'D' ) INTO STRICT L_TC;
            -- SELECT NVL(MAX(ID_VALE),0)+1 INTO L_ID_VALE FROM CAJA_VALE;
            IF P_ID_MONEDA = 9 THEN
                L_IMPORTE := P_IMPORTE_ME*L_TC;
            ELSE
                L_IMPORTE := P_IMPORTE;
            END IF;

            SELECT  --(COUNT(1)+1) INTO L_NRO_VALE
                    coalesce(MAX((NRO_VALE)::numeric ),0)+1 INTO L_NRO_VALE
            FROM CAJA_VALE WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO=P_ID_DEPTO;
            INSERT INTO CAJA_VALE(
                                    --ID_VALE,
                                    ID_ENTIDAD,
                                    ID_DEPTO,
                                    ID_ANHO,
                                    ID_MES,
                                    ID_TIPOVALE,
                                    ID_PERSONA,
                                    ID_EMPLEADO,
                                    ID_MONEDA,
                                    FECHA,
                                    FECHA_REG,
                                    FECHA_VENCIMIENTO,
                                    IMPORTE,
                                    IMPORTE_ME,
                                    TIPO_CAMBIO,
                                    DETALLE,
                                    CELULAR,
                                    EMAIL,
                                    TERMINO_CONDICION,
                                    ESTADO,
                                    NRO_VALE)VALUES (
                                    --L_ID_VALE,
                                    P_ID_ENTIDAD,
                                    P_ID_DEPTO,
                                    P_ID_ANHO,
                                    P_ID_MES,
                                    P_ID_TIPOVALE,
                                    P_ID_PERSONA,
                                    P_ID_EMPLEADO,
                                    P_ID_MONEDA,
                                    P_FECHA,
                                    clock_timestamp(),
                                    P_FECHA_VENCIMIENTO,
                                    L_IMPORTE,
                                    P_IMPORTE_ME,
                                    L_TC,
                                    P_DETALLE,
                                    L_CELULAR,
                                    P_EMAIL,
                                    P_TERMINO_CONDICION,
                                    '1',
                                    L_NRO_VALE
                                ) RETURNING ID_VALE INTO L_ID_VALE;
            P_ID_VALE := L_ID_VALE;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_registra_vale (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TIPOVALE integer,P_ID_PERSONA bigint,P_ID_EMPLEADO bigint, P_ID_MONEDA integer, P_FECHA timestamp(0), P_IMPORTE bigint, P_IMPORTE_ME bigint, P_DETALLE text,P_CELULAR text, P_EMAIL text, P_ID_VALE OUT bigint,P_FECHA_VENCIMIENTO timestamp(0),P_TERMINO_CONDICION text) FROM PUBLIC;
