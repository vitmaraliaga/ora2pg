-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_crear_pago_compra (P_ID_PAGO bigint,P_ID_DINAMICA bigint,P_ID_PROVEEDOR bigint,P_ID_COMPRA bigint, P_IMPORTE bigint,P_IMPORTE_ME bigint, P_ID_PAGO_COMPRA INOUT bigint, P_ERROR out bigint, P_MSGERROR out text) AS $body$
DECLARE

        l_id_pcompra bigint := 0;
        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        L_ID_PERSONA bigint :=null;
        L_IMPORTE_SALDO decimal(10,2);
        L_IMPORTE_SALDO_ME decimal(10,2);

        L_ID_TIPOORIGEN bigint := 8;

        L_IMPORTE_PAGADO decimal(10,2);
        L_IMPORTE_PAGADO_ME decimal(10,2);
        L_PROVEEDOR varchar(200);
        --L_CORRELATIVO numeric;
        L_DETALLE varchar(80);
        L_ID_MONEDA bigint;
        L_TIPOCAMBIO bigint;

        L_IMPORTE bigint;
        L_ID_COMPRA bigint :=NULL;
        L_ID_SALDO bigint :=NULL;
        L_DOC varchar(40);
        L_ID_ANHO varchar(5);

        
BEGIN
        
            --- CADA VEZ QUE SE ACTUALIZE O SE AGREGUE ALGO DE DETALLE AL PAGO EL PAGO AUTOMATICAMENTE SE PONE EN ESTADO 0
            UPDATE ELISEO.CAJA_PAGO SET ESTADO='0' WHERE ID_PAGO=P_ID_PAGO;
            ---
            l_error:=0;
            if l_error=0 then
                /*SELECT 
                        SUBSTR(FC_NOMBRE_PERSONA(ID_PROVEEDOR),1,100) PROVEEDOR
                        --- ,CORRELATIVO
                        INTO
                        L_PROVEEDOR
                        -- ,L_CORRELATIVO
                FROM COMPRA
                WHERE ID_COMPRA = P_ID_COMPRA;*/
                SELECT COUNT(1) INTO STRICT l_contar FROM COMPRA_SALDO WHERE ID_SALDO = P_ID_COMPRA;
                IF l_contar = 1 THEN
                    L_ID_SALDO := P_ID_COMPRA;
                    SELECT id_anho INTO STRICT L_ID_ANHO FROM COMPRA_SALDO WHERE ID_SALDO = P_ID_COMPRA;
                ELSE
                    L_ID_COMPRA := P_ID_COMPRA;
                    SELECT id_anho INTO STRICT L_ID_ANHO FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;
                END IF;

                SELECT SUBSTR(FC_NOMBRE_PERSONA(P_ID_PROVEEDOR),1,100) PROVEEDOR INTO STRICT L_PROVEEDOR
;

                SELECT DISTINCT CASE WHEN ID_COMPROBANTE='01' THEN 'FAC:' WHEN ID_COMPROBANTE='03' THEN 'BOL:' WHEN ID_COMPROBANTE='02' THEN 'RH:'  ELSE 'DOC:' END ||SERIE||'-'||NUMERO INTO STRICT L_DOC
                FROM VW_PURCHASES_MOV
                WHERE ID_COMPRA = P_ID_COMPRA
                AND ID_PROVEEDOR = P_ID_PROVEEDOR
                AND ID_ANHO = L_ID_ANHO;

                SELECT 
                SUBSTR((CASE ID_ENTIDAD 
                WHEN 7124 
                THEN ID_ENTIDAD||'-'||L_DOC||'-'||SUBSTR(L_PROVEEDOR,1,20)||'-'||CASE WHEN ID_MEDIOPAGO='001' THEN 'TLC' WHEN ID_MEDIOPAGO='007' THEN 'CHQ' WHEN ID_MEDIOPAGO='008' THEN 'EFEC' END ||'-'||(NUMERO)::numeric ||'-'||TO_CHAR(FECHA,'DD/MM/YYYY')
                WHEN 9415 
                THEN ID_ENTIDAD||'-'||L_DOC||'-'||SUBSTR(L_PROVEEDOR,1,20)||'-'||CASE WHEN ID_MEDIOPAGO='001' THEN 'TLC' WHEN ID_MEDIOPAGO='007' THEN 'CHQ' WHEN ID_MEDIOPAGO='008' THEN 'EFEC' END ||'-'||(NUMERO)::numeric ||'-'||TO_CHAR(FECHA,'DD/MM/YYYY')
                --THEN DECODE(ID_MEDIOPAGO,'001','TLC','007','CHQ','008','EFEC')||'-'||NUMERO||'-'||TO_CHAR(FECHA,'DD/MM/YYYY')||'-'||pkg_caja_fc_cuenta_bancaria(ID_CTABANCARIA)||'-'||L_PROVEEDOR
                ELSE 
                -- TO_CHAR(FECHA,'DD/MM/YYYY')||'-'||DECODE(ID_MEDIOPAGO,'001','TLC','007','CHQ','008','EFEC')||'-'||NUMERO||'-'||pkg_caja_fc_cuenta_bancaria(ID_CTABANCARIA)
                CASE WHEN ID_MEDIOPAGO='001' THEN 'TLC' WHEN ID_MEDIOPAGO='007' THEN 'CHQ' WHEN ID_MEDIOPAGO='008' THEN 'EFEC' END ||'-'||NUMERO||' | '||TO_CHAR(FECHA,'DD/MM/YYYY')||' | '||pkg_caja_fc_cuenta_bancaria(ID_CTABANCARIA)
                END ),1,80) AS GLOSA, ID_MONEDA, TIPOCAMBIO INTO STRICT L_DETALLE, L_ID_MONEDA, L_TIPOCAMBIO
                FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;

                SELECT coalesce(IMPORTE,0),coalesce(IMPORTE_ME,0) INTO STRICT L_IMPORTE_SALDO,L_IMPORTE_SALDO_ME
                FROM VW_PURCHASES_SALDO
                WHERE ID_COMPRA = P_ID_COMPRA
                AND ID_PROVEEDOR = P_ID_PROVEEDOR
                AND ID_ANHO = L_ID_ANHO;

                
                
                IF P_ID_PAGO_COMPRA <> 0 THEN  -- UPDATE
                    -- ELIMINAR CONTA_ASIENTO
                    SELECT ID_TIPOORIGEN INTO STRICT L_ID_TIPOORIGEN FROM CAJA_PAGO_COMPRA WHERE ID_PCOMPRA=P_ID_PAGO_COMPRA;
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN=P_ID_PAGO_COMPRA;

                    SELECT coalesce(IMPORTE,0), coalesce(IMPORTE_ME,0) INTO STRICT L_IMPORTE_PAGADO, L_IMPORTE_PAGADO_ME FROM CAJA_PAGO_COMPRA WHERE ID_PCOMPRA = P_ID_PAGO_COMPRA;

                    IF L_ID_MONEDA = '7' THEN  -- Soles
                        IF coalesce(P_IMPORTE,0) > (coalesce(L_IMPORTE_SALDO,0)+coalesce(L_IMPORTE_PAGADO,0)) THEN
                            l_error := 1;
                            l_msgerror:='El importe en soles, es mayor al saldo del documento.'||ABS(coalesce(P_IMPORTE,0)-(coalesce(L_IMPORTE_SALDO,0)+coalesce(L_IMPORTE_PAGADO,0)));
                            l_id_pcompra := P_ID_PAGO_COMPRA;
                        END IF;
                        L_IMPORTE := P_IMPORTE;
                    ELSE
                        IF coalesce(P_IMPORTE_ME,0) > (coalesce(L_IMPORTE_SALDO_ME,0)+coalesce(L_IMPORTE_PAGADO_ME,0)) THEN
                            l_error := 1;
                            l_msgerror:='El importe en moneda extranjera, es mayor al saldo del documento.';
                            l_id_pcompra := P_ID_PAGO_COMPRA;
                        END IF;
                        --L_IMPORTE := (P_IMPORTE_ME * L_TIPOCAMBIO);
                        L_IMPORTE := P_IMPORTE;
                    END IF;

                    IF l_error = 0 THEN
                        UPDATE CAJA_PAGO_COMPRA
                            SET ID_DINAMICA = P_ID_DINAMICA, 
                            IMPORTE = L_IMPORTE, IMPORTE_ME = P_IMPORTE_ME
                        WHERE ID_PCOMPRA=P_ID_PAGO_COMPRA;

                        l_id_pcompra := P_ID_PAGO_COMPRA;

                        --SELECT IMPORTE_ME INTO L_IMPORTE  FROM CAJA_PAGO_COMPRA WHERE ID_PCOMPRA=P_ID_PAGO_COMPRA;
                        --l_msgerror := L_IMPORTE;
                        --l_error:=1;
                    END IF;

                ELSE 
                    
                    IF coalesce(P_IMPORTE,0)+coalesce(P_IMPORTE_ME,0) > 0 THEN
                    
                        IF L_ID_MONEDA = '7' THEN  -- Soles
                            IF coalesce(P_IMPORTE,0) > coalesce(L_IMPORTE_SALDO,0) THEN
                                 
                                IF (coalesce(P_IMPORTE,0)-coalesce(L_IMPORTE_SALDO,0)) >= 0.02 THEN 
                                    l_error := 1;
                                    l_msgerror:='El importe en soles, es mayor al saldo del documento ..' ||coalesce(P_IMPORTE,0)||coalesce(L_IMPORTE_SALDO,0);
                                    l_id_pcompra := P_ID_PAGO_COMPRA;
                                END IF;
                            END IF;
                            L_IMPORTE := P_IMPORTE;
                        ELSE
                            IF coalesce(P_IMPORTE_ME,0) > coalesce(L_IMPORTE_SALDO_ME,0) THEN
                                l_error := 1;
                                l_msgerror:='El importe en moneda extranjera, es mayor al saldo del documento.';
                                l_id_pcompra := P_ID_PAGO_COMPRA;
                            END IF;
                            --L_IMPORTE := (P_IMPORTE_ME * L_TIPOCAMBIO);
                            L_IMPORTE := P_IMPORTE;
                        END IF;

                       IF l_error = 0 THEN
                            -- <<COMENTADO POR VITMAR>> SELECT COALESCE(MAX(ID_PCOMPRA),0)+1 into l_id_pcompra FROM CAJA_PAGO_COMPRA;
                            --SELECT DECODE(ID_MEDIOPAGO,'001',9,'007',8,'008',7) INTO L_ID_TIPOORIGEN FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
                            INSERT INTO CAJA_PAGO_COMPRA(
                                --ID_PCOMPRA,
                                ID_PAGO,
                                ID_PROVEEDOR,
                                ID_COMPRA,
                                ID_DINAMICA,
                                --ID_TIPOORIGEN,
                                IMPORTE,
                                IMPORTE_ME,
                                DETALLE,
                                ID_SALDO
                            )values (
                                --l_id_pcompra,
                                P_ID_PAGO,
                                P_ID_PROVEEDOR,
                                L_ID_COMPRA,
                                P_ID_DINAMICA,
                                --L_ID_TIPOORIGEN,
                                L_IMPORTE,
                                P_IMPORTE_ME,
                                SUBSTR(L_DETALLE,1,80),
                                L_ID_SALDO
                            ) returning ID_PCOMPRA into l_id_pcompra;

                            l_msgerror:='El pago se agregó con éxito.';
                        END IF;

                    ELSE
                        l_error := 1;
                        l_msgerror:='No existen importes';
                    END IF;
                END IF;
            end if;

        P_ERROR:=l_error;
        P_ID_PAGO_COMPRA:=l_id_pcompra;
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_crear_pago_compra (P_ID_PAGO bigint,P_ID_DINAMICA bigint,P_ID_PROVEEDOR bigint,P_ID_COMPRA bigint, P_IMPORTE bigint,P_IMPORTE_ME bigint, P_ID_PAGO_COMPRA INOUT bigint, P_ERROR out bigint, P_MSGERROR out text) FROM PUBLIC;
