-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_documento_asiento (P_ID_DOCUMENTO bigint,P_ID_DINAMICA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_ASIENTO bigint;
        L_ID_PARENT bigint;
        L_ID_TIPO_PLAN bigint;
        L_ID_RESTRICCION varchar(50);
        L_ID_CUENTAAASI varchar(10);
        L_DC varchar(1);
        L_DESTINO varchar(1);
        L_ID_INDICADOR varchar(35);
        L_UNICO varchar(1);
        L_UNICOCTACTE varchar(1);
        L_PORCENTAJE decimal(10,2);
        L_DESCRIPCION varchar(255);
        L_AGRUPA varchar(1);

        L_IMPORTEASIENTO decimal(10,2);
        L_IMPORTEASIENTO_ME decimal(10,2);

        L_DEPTO varchar(10);
        L_DEPTOS varchar(200) := '';
        L_CUENTA_CTE varchar(50);
        L_CTATES varchar(200);
        L_BUSCAR bigint;
        L_CTAS varchar(200);

        L_ACTAS TABLASTRING;
        L_ADEPTOS TABLASTRING;
        L_ACTATES TABLASTRING;

        --validacion
        L_CONT bigint;

        L_ID_CASIENTO varchar(50);
        L_ID_FONDO varchar(50);
        L_CORRELATIVO bigint;
        L_ID_COMPROBANTE varchar(20);
        L_ID_COMPROBANTE_NC varchar(25);
        L_ID_DEPTO_COMPRA varchar(20);
        L_ES_CREDITO varchar(1);
        L_ID_PROVEEDOR bigint;
        L_SERIE varchar(50);
        L_NUMERO varchar(50);
		L_IMPORTE decimal(10,2);
        L_IMPORTE_ME decimal(10,2) := 0;
        L_IGV decimal(10,2);
        L_BASE decimal(10,2);
        L_ID_ENTIDAD bigint;
        L_EDITABLE varchar(1) := 'N';

        CASI CURSOR FOR		
            SELECT 
                    A.ID_ASIENTO,A.ID_PARENT,A.ID_TIPOPLAN,A.ID_RESTRICCION,
                    A.ID_CUENTAAASI,A.DC,A.DESTINO,A.ID_INDICADOR,A.UNICO,A.UNICO_CTACTE,A.PORCENTAJE,
                    A.NOMBRE,A.AGRUPA,A.ID_FONDO
            FROM CONTA_DINAMICA_ASIENTO A
            WHERE A.ID_DINAMICA =P_ID_DINAMICA
            AND COALESCE(A.ID_PARENT,0)=0 
            AND A.DC = 'D' -- SOLO ASIENTOS DE GASTOS
 
            ORDER BY A.NRO_ASIENTO,A.DC;

    
BEGIN
        P_ERROR :=0;
        IF P_ERROR = 0 THEN

            OPEN CASI;
            FETCH CASI INTO L_ID_ASIENTO, L_ID_PARENT, L_ID_TIPO_PLAN, L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC, L_DESTINO, L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA, L_ID_FONDO;
            WHILE CASI%FOUND LOOP

                SELECT CASE L_ID_INDICADOR 
                    WHEN 'IMPORTE' THEN (L_IMPORTE)*(L_PORCENTAJE)
                    WHEN 'BASE' THEN (L_BASE)*(L_PORCENTAJE)
                    WHEN 'IGV' THEN (L_IGV)*(L_PORCENTAJE)
                    ELSE 0 END INTO STRICT L_IMPORTEASIENTO
;

                SELECT IMPORTE,IMPORTE_ME INTO STRICT L_IMPORTEASIENTO,L_IMPORTEASIENTO_ME  FROM CAJA_DOCUMENTO WHERE ID_DOCUMENTO = P_ID_DOCUMENTO;

                L_DEPTO:=NULL;
                L_CUENTA_CTE:=NULL;

                IF L_UNICO='U' THEN  -- Único
                    -- SELECT MAX(ID_DEPTO) INTO L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ENTIDAD=P_ID_ENTIDAD;
                    SELECT MAX(ID_DEPTO) INTO STRICT L_DEPTO FROM CONTA_DINAMICA_DEPTO WHERE ID_ASIENTO=L_ID_ASIENTO;
                ELSIF (L_UNICO='M') THEN  -- Muchos
                    SELECT position('|' in L_DEPTOS) INTO STRICT L_BUSCAR;
                    IF L_BUSCAR>0 THEN
                        SELECT FC_SPLIT(L_CTAS,'|') INTO STRICT L_ACTAS;
                        SELECT FC_SPLIT(L_DEPTOS,'|') INTO STRICT L_ADEPTOS;
                        SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ADEPTOS ,L_ID_CUENTAAASI) INTO STRICT L_DEPTO;
                    ELSE
                        L_DEPTO:=L_DEPTOS;
                    END IF;
                ELSIF L_UNICO='S' THEN  -- Si es sesión
                    L_DEPTO := L_ID_DEPTO_COMPRA;
                END IF;

                IF L_ES_CREDITO = 'S' AND L_UNICOCTACTE='U' THEN
                    SELECT pkg_caja_fc_ruc(L_ID_PROVEEDOR) INTO STRICT L_CUENTA_CTE;
                ELSE
                    IF L_UNICOCTACTE='U' THEN
                      SELECT  COUNT(1) INTO STRICT L_CONT FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=L_ID_ASIENTO;
                      IF L_CONT>0 THEN
                        SELECT ID_CTACTE INTO STRICT L_CUENTA_CTE FROM CONTA_DINAMICA_CTA_CTE WHERE ID_ASIENTO=L_ID_ASIENTO;
                      END IF;
                    ELSIF (L_UNICOCTACTE='M') THEN
                       SELECT position('|' in L_CTATES) INTO STRICT L_BUSCAR;
                       IF L_BUSCAR>0 THEN
                         SELECT FC_SPLIT(L_CTAS,'|') INTO STRICT L_ACTAS;
                         SELECT FC_SPLIT(L_CTATES,'|') INTO STRICT L_ACTATES;
                         SELECT FC_OBTENER_DPTOCTCTE(L_ACTAS,L_ACTATES ,L_ID_CUENTAAASI) INTO STRICT L_CUENTA_CTE;
                       ELSE
                        L_CUENTA_CTE:=L_CTATES;
                       END IF;
                    ELSIF (L_UNICOCTACTE='X') THEN
                        SELECT pkg_caja_fc_ruc(L_ID_PROVEEDOR) INTO STRICT L_CUENTA_CTE;
                    END IF;
                END IF;
                   
                IF L_DC='C' THEN
                    L_IMPORTEASIENTO:=L_IMPORTEASIENTO*(-1);
                    L_IMPORTEASIENTO_ME:=L_IMPORTE_ME*(-1);
                 ELSE
                    L_IMPORTEASIENTO := L_IMPORTEASIENTO;
                    L_IMPORTEASIENTO_ME := L_IMPORTE_ME;
                END IF;

                IF L_IMPORTEASIENTO<>0 THEN
                    
                    SELECT coalesce(MAX(ID_CASIENTO),0)+1 INTO STRICT L_ID_CASIENTO FROM CAJA_DOCUMENTO_ASIENTO;

                    INSERT INTO CAJA_DOCUMENTO_ASIENTO(ID_CASIENTO,ID_DOCUMENTO,ID_CUENTAAASI,ID_RESTRICCION,ID_CTACTE,ID_FONDO,ID_DEPTO,IMPORTE,IMPORTE_ME,DC,EDITABLE,AGRUPA) 
                    VALUES (L_ID_CASIENTO,P_ID_DOCUMENTO, L_ID_CUENTAAASI, L_ID_RESTRICCION,L_CUENTA_CTE,L_ID_FONDO,L_DEPTO,L_IMPORTEASIENTO,L_IMPORTEASIENTO_ME,L_DC,L_EDITABLE,L_AGRUPA);
                  END IF;

            FETCH CASI INTO L_ID_ASIENTO, L_ID_PARENT, L_ID_TIPO_PLAN, L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC, L_DESTINO, L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA, L_ID_FONDO;
            END LOOP;
            CLOSE CASI;
            P_ERROR :=0;
        END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_documento_asiento (P_ID_DOCUMENTO bigint,P_ID_DINAMICA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
