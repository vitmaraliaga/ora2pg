-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_conta_asiento_vale (P_ID_VALE bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_ASIENTO bigint;
        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_ID_ANHO bigint;
        L_ID_MES bigint;
        L_ID_VOUCHER bigint;
        L_ID_TIPOORIGEN bigint;
        L_ERROR bigint;
        L_MSGERROR varchar(200);
        L_ID_FONDO bigint;
        L_ID_CUENTAAASI varchar(10);
        L_ID_CTACTE varchar(50);
        L_ID_RESTRICCION varchar(50);
        L_IMPORTE bigint;
        L_IMPORTE_ME bigint;
        L_DESCRIPCION varchar(255);
        L_ESTADO varchar(1);
        L_CONT bigint;
        L_AGRUPA varchar(1);
        L_DC varchar(1);
        L_ID_CTABANCARIA bigint;
        L_BANCO varchar(50);
        L_GLOSA varchar(500);

        CUR_VALE_ASIENTO CURSOR FOR
        SELECT ID_FONDO,ID_DEPTO,ID_CUENTAAASI,ID_CTACTE,ID_RESTRICCION,IMPORTE,IMPORTE_ME,DESCRIPCION,AGRUPA,DC
        FROM CAJA_VALE_ASIENTO
        WHERE ID_VALE = P_ID_VALE;

BEGIN
        P_ERROR := 0;
        P_MSGERROR := '';
        SELECT ID_ENTIDAD,ID_ANHO,ID_MES,ID_VOUCHER,ID_TIPOORIGEN,ID_CTABANCARIA,ESTADO INTO STRICT L_ID_ENTIDAD,L_ID_ANHO,L_ID_MES,L_ID_VOUCHER,L_ID_TIPOORIGEN,L_ID_CTABANCARIA,L_ESTADO
        FROM CAJA_VALE
        WHERE ID_VALE = P_ID_VALE;

        SELECT B.SIGLA INTO STRICT L_BANCO FROM CAJA_CUENTA_BANCARIA A JOIN CAJA_ENTIDAD_FINANCIERA B
        ON A.ID_BANCO = B.ID_BANCO
        WHERE A.ID_CTABANCARIA = L_ID_CTABANCARIA;

        SELECT A.ID_ENTIDAD||'-'||A.ID_DEPTO||'-[VALE-'||A.NRO_VALE||']-'||CASE WHEN A.ID_MEDIOPAGO='001' THEN 'TLC' WHEN A.ID_MEDIOPAGO='007' THEN 'CHQ'  ELSE 'EFE' END ||'-'||L_BANCO||'-OP-'||(A.NUMERO)::numeric ||'-'||TO_CHAR(A.FECHA,'DD/MM/YY')||'-'||A.DETALLE INTO STRICT L_GLOSA
        FROM CAJA_VALE A
        WHERE ID_VALE = P_ID_VALE;

        OPEN CUR_VALE_ASIENTO;
            FETCH CUR_VALE_ASIENTO INTO L_ID_FONDO,L_ID_DEPTO,L_ID_CUENTAAASI,L_ID_CTACTE,L_ID_RESTRICCION,L_IMPORTE,L_IMPORTE_ME,L_DESCRIPCION,L_AGRUPA, L_DC;
            WHILE CUR_VALE_ASIENTO%FOUND LOOP
                IF L_IMPORTE <> 0 THEN

                    IF L_DC = 'C' then
                        BEGIN
                            SELECT ID_TIPOCTACTE into STRICT L_ID_CTACTE FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = L_ID_CTABANCARIA;
                            EXCEPTION WHEN no_data_found THEN
                            L_ID_CTACTE := '';
                        END;
                    END IF;

                    SELECT coalesce(MAX(ID_ASIENTO),0)+1 INTO STRICT L_ID_ASIENTO FROM CONTA_ASIENTO;
                    INSERT INTO CONTA_ASIENTO(ID_ASIENTO,
                                               ID_TIPOORIGEN,
                                               ID_ORIGEN,
                                               FONDO,
                                               DEPTO,
                                               CUENTA,
                                               CUENTA_CTE,
                                               RESTRICCION,
                                               IMPORTE,
                                               DESCRIPCION,
                                               MEMO,
                                               VOUCHER,
                                               AGRUPA,
                                               IMPORTE_ME)
                         VALUES (L_ID_ASIENTO,
                                 L_ID_TIPOORIGEN,
                                 P_ID_VALE,
                                 L_ID_FONDO,
                                 L_ID_DEPTO,
                                 L_ID_CUENTAAASI,
                                 L_ID_CTACTE,
                                 L_ID_RESTRICCION,
                                 L_IMPORTE,
                                 --L_DESCRIPCION,
                                 L_GLOSA,
                                 P_ID_VALE,
                                 L_ID_VOUCHER,
                                 L_AGRUPA,
                                 L_IMPORTE_ME);
                END IF;
            FETCH CUR_VALE_ASIENTO INTO L_ID_FONDO,L_ID_DEPTO,L_ID_CUENTAAASI,L_ID_CTACTE,L_ID_RESTRICCION,L_IMPORTE,L_IMPORTE_ME,L_DESCRIPCION,L_AGRUPA, L_DC;
            END LOOP;
        CLOSE CUR_VALE_ASIENTO;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_conta_asiento_vale (P_ID_VALE bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
