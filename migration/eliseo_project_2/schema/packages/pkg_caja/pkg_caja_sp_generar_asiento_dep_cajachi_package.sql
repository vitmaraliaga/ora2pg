-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_generar_asiento_dep_cajachi (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_dinamica bigint;
        l_id_persona bigint;
        l_detalle varchar(100);
        l_detalle_in varchar(100);
        l_importe decimal(10,2);
        l_es_credito varchar(1);

        l_id_asiento bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_destino varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);

        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_fondo varchar(10);
        l_importeasiento decimal(10,2);
        l_descripcion varchar(255);
        l_memo varchar(255);
        l_voucher varchar(10);
        l_ref_id varchar(100);

        l_id_entidad bigint;
        l_id_depto_pago varchar(20);

        --validacion
        l_contar bigint;
        l_cont bigint;
        l_agrupa varchar(1);
        l_id_ctabancaria bigint;
        l_pgasto bigint;
        l_tipoorigen bigint;

        cdet CURSOR FOR	
        SELECT 
        ID_PGASTO, ID_TIPOORIGEN,ID_DINAMICA,ID_PERSONA,SUBSTR(DETALLE, 1, 50),IMPORTE
        FROM CAJA_PAGO_GASTO
        WHERE ID_PAGO = P_ID_PAGO;

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO, a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA, a.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =l_dinamica
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        l_error bigint:=0;
        l_msgerror varchar(200):='';

        
BEGIN
            
            l_detalle:='';--P_DETALLE;
            l_detalle_in:='';--P_DETALLE Ya preparado para guardar;
            
            --OBTIENE DATOS DEL PAGO
            SELECT ID_ENTIDAD,ID_DEPTO,
                    ID_CTABANCARIA,
                    ID_VOUCHER
                into STRICT l_id_entidad,l_id_depto_pago,
                    l_id_ctabancaria,
                    l_voucher
            FROM CAJA_PAGO WHERE ID_PAGO=P_ID_PAGO;

            OPEN cdet;

            FETCH cdet INTO l_pgasto, l_tipoorigen,l_dinamica,l_id_persona,l_detalle, l_importe;
            WHILE cdet%FOUND LOOP
                l_memo :=l_tipoorigen || '-' || l_pgasto;
                ---DiNAMICA ASIENTO
                OPEN casi;
                FETCH casi INTO l_id_asiento, l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                WHILE casi%FOUND LOOP

                    l_detalle_in := SUBSTR(l_id_entidad || '-(Rep-Caja chica), ' || l_detalle, 1,50);

                    select case when l_id_indicador='IMPORTE' then (l_importe)*(l_porcentaje)
                              else
                              0
                              end into STRICT l_importeasiento
;

                    l_depto:=null;
                    l_cuenta_cte:=null;

                    if l_unico='U' then
                        select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                    ELSIF l_unico='S' THEN  -- Si es sesiÃ³n
                        l_depto := l_id_depto_pago;
                    END IF;

                    if l_unicoctate='U' then
                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                    elsif (l_unicoctate='B') then
                        SELECT ID_TIPOCTACTE, ID_CUENTAAASI into STRICT l_cuenta_cte, l_id_cuentaaasi FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;
                    elsif (l_unicoctate='X') then
                        SELECT pkg_caja_fc_ruc(l_id_persona) into STRICT l_cuenta_cte;
                    end if;
                
                    if l_dc='C' then
                        l_importeasiento:=l_importeasiento*(-1);
                    end if;

                    select count(*) into STRICT l_cont from CONTA_ASIENTO
                    where ID_TIPOORIGEN=l_tipoorigen
                    and ID_ORIGEN=l_pgasto
                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                    and CUENTA =l_id_cuentaaasi
                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                    and case when importe>0 then 'D' else 'C' end=l_dc;

                    if l_importeasiento<>0 then
                        if l_cont=0 then
                        --if l_cont=0 and l_agrupa = 'N' then 
                            INSERT INTO CONTA_ASIENTO(
                                ID_TIPOORIGEN,
                                ID_ORIGEN, 
                                FONDO,
                                DEPTO,
                                CUENTA, 
                                CUENTA_CTE,
                                RESTRICCION,
                                IMPORTE,
                                DESCRIPCION,
                                MEMO,
                                VOUCHER, 
                                PARENT_ID,
                                REF_ID,
                                AGRUPA
                            )VALUES ( 
                                l_tipoorigen,
                                l_pgasto,
                                l_fondo,
                                l_depto,
                                l_id_cuentaaasi,
                                l_cuenta_cte,
                                l_id_restriccion,
                                l_importeasiento,
                                l_detalle_in,
                                l_memo,
                                l_voucher,
                                null,
                                l_ref_id,
                                l_agrupa
                            );
                        else

                            update CONTA_ASIENTO set IMPORTE=l_importeasiento
                            where ID_TIPOORIGEN=l_tipoorigen
                            and ID_ORIGEN=l_pgasto
                            and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                            and CUENTA =l_id_cuentaaasi
                            and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                            and case when importe>0 then 'D' else 'C' end=l_dc;
                        end if;
                    end if;
                FETCH casi INTO l_id_asiento, l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                END LOOP;
                CLOSE casi;

            FETCH cdet INTO l_pgasto, l_tipoorigen,l_dinamica,l_id_persona,l_detalle,l_importe;
            END LOOP;
            CLOSE cdet;

            P_ERROR:=l_error;
            P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_generar_asiento_dep_cajachi (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
