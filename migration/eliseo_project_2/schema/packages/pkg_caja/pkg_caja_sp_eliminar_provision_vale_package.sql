-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_eliminar_provision_vale (P_ID_VALE integer,P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_TIPOVALE bigint;
        L_ID_VOUCHER bigint;
        L_ID_TIPOORIGEN bigint;
        L_ID_REGISTRO bigint;
        L_ID_PROCESO bigint := 5;--PROCESO DE VALES
        L_PASO_AUTORIZADO bigint :=14;
        L_PASO_PROVISIONADO bigint := 227;
        L_ACTIVO varchar(1);
        L_ERROR bigint :=0;
        L_MSGERROR varchar(200);
        L_CANT bigint :=0;

BEGIN
            SELECT ID_VOUCHER,ID_TIPOVALE,ID_TIPOORIGEN INTO STRICT L_ID_VOUCHER,L_ID_TIPOVALE,L_ID_TIPOORIGEN FROM CAJA_VALE WHERE ID_VALE = P_ID_VALE;
            SELECT ACTIVO INTO STRICT L_ACTIVO FROM CONTA_VOUCHER WHERE ID_VOUCHER = L_ID_VOUCHER;
            IF L_ACTIVO = 'S' THEN
                IF L_ID_TIPOVALE = 1 THEN  --A RENDIR
                    SELECT COUNT(1) INTO STRICT L_CANT FROM CAJA_PAGO WHERE ID_VALE = P_ID_VALE AND ESTADO <> '0';
                    IF L_CANT > 0 THEN  -- YA ESTA REDIDO
                        L_MSGERROR := 'VALE: Ya est√° Rendido o e Proceso';
                        L_ERROR := 1;
                    ELSE
                        DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = P_ID_VALE;
                        UPDATE CAJA_VALE SET ID_VOUCHER  = NULL, NUMERO = '',PAGADO = '' WHERE ID_VALE = P_ID_VALE;
                        DELETE FROM CAJA_VALE_FILE  WHERE ID_VALE = P_ID_VALE AND TIPO = '2';--CONSTANCIA DE DEPOSITO
                        SELECT ID_REGISTRO INTO STRICT L_ID_REGISTRO  FROM PROCESS_RUN WHERE ID_PROCESO = L_ID_PROCESO AND ID_OPERACION = P_ID_VALE;
                        DELETE FROM PROCESS_PASO_RUN WHERE ID_REGISTRO = L_ID_REGISTRO AND ID_PASO = L_PASO_PROVISIONADO;--PASO DE PROVISIONADO
                        UPDATE PROCESS_PASO_RUN SET ESTADO = '0' WHERE ID_REGISTRO = L_ID_REGISTRO AND ID_PASO = L_PASO_AUTORIZADO;--PASO DE AUTORIZADO
                        UPDATE PROCESS_RUN SET ESTADO = '0', ID_PASO_ACTUAL = L_PASO_AUTORIZADO WHERE ID_PROCESO = L_ID_PROCESO AND ID_OPERACION = P_ID_VALE; --PASO 14 = AUTORIZADO
                        L_MSGERROR := 'VALE: OK';
                        L_ERROR := 0;
                    END IF;
                ELSE  --AC ELIMINA
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = P_ID_VALE;
                    UPDATE CAJA_VALE SET ID_VOUCHER  = NULL, NUMERO = '',PAGADO = '' WHERE ID_VALE = P_ID_VALE;
                    DELETE FROM CAJA_VALE_FILE  WHERE ID_VALE = P_ID_VALE AND TIPO = '2';--CONSTANCIA DE DEPOSITO;
                    SELECT ID_REGISTRO INTO STRICT L_ID_REGISTRO FROM PROCESS_RUN WHERE ID_PROCESO = L_ID_PROCESO AND ID_OPERACION = P_ID_VALE;
                    DELETE FROM PROCESS_PASO_RUN WHERE ID_REGISTRO = L_ID_REGISTRO AND ID_PASO = L_PASO_PROVISIONADO;--PASO DE PRROVISIONADO
                    UPDATE PROCESS_PASO_RUN SET ESTADO = '0' WHERE ID_REGISTRO = L_ID_REGISTRO AND ID_PASO = L_PASO_AUTORIZADO;--PASO DE AUTORIZADO
                    UPDATE PROCESS_RUN SET ESTADO = '0', ID_PASO_ACTUAL = L_PASO_AUTORIZADO WHERE ID_PROCESO = L_ID_PROCESO AND ID_OPERACION = P_ID_VALE;
                    L_MSGERROR := 'VALE: OK';
                    L_ERROR := 0;
                END IF;
            ELSE
                --NO SE PUEDE ELIMINAR, YA ESTA CONTABILIZADO
                L_MSGERROR := 'VALE: Voucher Contabilizado';
                L_ERROR := 1;
            END IF;
            P_MSGERROR := L_MSGERROR;
            P_ERROR := L_ERROR;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_eliminar_provision_vale (P_ID_VALE integer,P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
