-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_generar_asiento_ret_det (P_ID_OPERORIGEN bigint,P_ID_ORIGEN bigint,P_ID_DINAMICA bigint,P_ID_CTABANCARIA bigint,P_IMPORTE bigint,P_DETALLE text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_dinamica bigint;
        l_asiento bigint;
        l_detalle varchar(255);
        l_base decimal(10,2);
        l_igv decimal(10,2);
        l_descuento decimal(10,2);
        l_importe decimal(10,2);
        l_precio_alm decimal(10,2);
        l_ctas varchar(200);
        l_deptos varchar(200);
        l_ctates varchar(200);

        l_actas tablastring;
        l_adeptos tablastring;
        l_actates tablastring;

        l_id_asiento bigint;
        l_id_parent bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_destino varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);

        l_id_asientod bigint;
        l_id_tipopland bigint;
        l_id_restricciond varchar(50);
        l_id_cuentaaasid varchar(10);
        l_dcd varchar(1);
        l_id_indicadord  varchar(35);
        l_unicod varchar(1);
        l_porcentajed decimal(10,2);
        l_unicoctated varchar(1);

        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_fondo varchar(10);
        l_importeasiento decimal(10,2);
        l_importe_tarjeta decimal(10,2);
        l_importe_trans decimal(10,2);
        l_descripcion varchar(255);
        l_memo varchar(255);
        l_voucher varchar(10);
        l_ref_id varchar(100);

        l_id_entidad bigint;
        l_buscar bigint;

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_operorigen bigint:=11; --DETRACCIONES
        
        --validacion
        l_contar bigint;
        l_debito decimal(10,2);
        l_credito decimal(10,2);
        l_cont bigint;
        l_serie varchar(5);
        l_numero varchar(15);
        l_fecha timestamp(0);
        l_agrupa varchar(1);
        l_id_cliente bigint;
        l_id_depto_ret_det varchar(20);

        cdet CURSOR FOR	
        SELECT  ID_DINAMICA,ID_ENTIDAD
        FROM CONTA_DINAMICA 
        WHERE ID_DINAMICA=P_ID_DINAMICA;

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =l_dinamica
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        casides CURSOR FOR		
        SELECT ID_ASIENTO,ID_TIPOPLAN,ID_RESTRICCION,ID_CUENTAAASI,DC,ID_INDICADOR,UNICO,UNICO_CTACTE,PORCENTAJE,NOMBRE,AGRUPA
        FROM CONTA_DINAMICA_ASIENTO
        WHERE ID_PARENT=l_asiento
        ORDER BY NRO_ASIENTO,DC desc;


BEGIN
     
        l_detalle:=P_DETALLE;
        l_importe:= P_IMPORTE;

        l_fondo:='10';
        IF P_ID_OPERORIGEN = 12 THEN
            SELECT ID_DEPTO, ID_PROVEEDOR,ID_VOUCHER INTO STRICT l_id_depto_ret_det, l_id_cliente,l_voucher FROM CAJA_RETENCION WHERE ID_RETENCION = P_ID_ORIGEN;
        ELSE
            SELECT ID_DEPTO, ID_PROVEEDOR,ID_VOUCHER INTO STRICT l_id_depto_ret_det, l_id_cliente,l_voucher FROM CAJA_DETRACCION WHERE ID_DETRACCION = P_ID_ORIGEN;
        END IF;

        SELECT P_ID_OPERORIGEN::text || '-' ||P_ID_ORIGEN::text INTO STRICT l_memo;

     --DETALLE
      OPEN cdet;
      FETCH cdet INTO l_dinamica,l_id_entidad;

      WHILE cdet%FOUND LOOP

            ---DENAMICA ASIENTO
            OPEN casi;
            FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
            WHILE casi%FOUND LOOP

                select case when l_id_indicador='IMPORTE' then (l_importe)*(l_porcentaje)
                          when l_id_indicador='IMPORTE_TARJETA' then (l_importe_tarjeta)*(l_porcentaje)
                          when l_id_indicador='IMPORTE_TRANS' then (l_importe_trans)*(l_porcentaje)
                              
                          else
                          0
                          end into STRICT l_importeasiento
;

                l_depto:=null;
                l_cuenta_cte:=null;

                if l_unico='U' then
                  select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                elsif (l_unico='M') then
                   SELECT position('|' in l_deptos) into STRICT l_buscar;
                   if l_buscar>0 then
                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                     select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                     select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasi) into STRICT l_depto;
                   else
                    l_depto:=l_deptos;
                   end if;
                elsif (l_unico='X') then
                   select FC_DEPTO_CLIENTE(l_id_cliente) into STRICT l_depto;
                ELSIF l_unico='S' THEN  -- Si es sesión
                    l_depto := l_id_depto_ret_det;
                end if;

                if l_unicoctate='U' then
                  select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                  if l_cont>0 then
                    select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                  end if;
                elsif (l_unicoctate='M') then
                   SELECT position('|' in l_ctates) into STRICT l_buscar;
                   if l_buscar>0 then
                     select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                     select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                     select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into STRICT l_cuenta_cte;
                   else
                    l_cuenta_cte:=l_ctates;
                   end if;
                elsif (l_unicoctate='X') then
                    select ID_RUC into STRICT l_cuenta_cte from MOISES.VW_PERSONA_JURIDICA where ID_PERSONA=l_id_cliente;
                elsif (l_unicoctate='B') then --LA CTA CTE SE OBTIENE DEL LA CTA BANCARIA
                    SELECT ID_TIPOCTACTE into STRICT l_cuenta_cte FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = P_ID_CTABANCARIA;
                end if;

                
                
                if l_dc='C' then
                  l_importeasiento:=l_importeasiento*(-1);
                end if;

                
                select count(*) into STRICT l_cont from CONTA_ASIENTO
                where ID_TIPOORIGEN=P_ID_OPERORIGEN
                and ID_ORIGEN=P_ID_ORIGEN
                and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                and CUENTA =l_id_cuentaaasi
                and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                and case when importe>0 then 'D' else 'C' end=l_dc;

                --NUEVA GLOSA 
                IF P_ID_OPERORIGEN = 11 THEN
                    IF l_dc = 'C' THEN
                        SELECT 
                        A.ID_ENTIDAD||'-'||A.ID_DEPTO||'- '||C.SIGLA||' - Det. - '||A.NRO_OPERACION||' - '||TO_CHAR(A.FECHA_EMISION,'DD/MM/YY')||'-'||D.NOMBRE||'-'||D.ID_RUC AS GLOSA INTO STRICT l_detalle
                        FROM CAJA_DETRACCION A JOIN CAJA_CUENTA_BANCARIA B
                        ON A.ID_CTABANCARIA = B.ID_CTABANCARIA
                        JOIN CAJA_ENTIDAD_FINANCIERA C
                        ON B.ID_BANCO = C.ID_BANCO
                        LEFT JOIN MOISES.VW_PERSONA_NATURAL_LEGAL D
                        ON A.ID_PROVEEDOR = D.ID_PERSONA
                        WHERE A.ID_DETRACCION = P_ID_ORIGEN  LIMIT 1;
                    /*ELSE
                        SELECT 
                        ID_ENTIDAD||'-'||ID_DEPTO||'- Det. - '||NRO_OPERACION||' - '||TO_CHAR(FECHA_EMISION,'DD/MM/YY')||'-'||B.NOMBRE||'-'||B.ID_RUC AS GLOSA INTO l_detalle
                        FROM CAJA_DETRACCION A LEFT JOIN MOISES.VW_PERSONA_NATURAL_LEGAL B
                        ON A.ID_PROVEEDOR = B.ID_PERSONA
                        WHERE ID_DETRACCION = P_ID_ORIGEN;*/
                    END IF;
                END IF;

                if l_importeasiento<>0 then
                
                  if l_cont=0 then
                    INSERT INTO CONTA_ASIENTO(
                    ID_TIPOORIGEN,
                    ID_ORIGEN, 
                    FONDO,
                    DEPTO,
                    CUENTA, 
                    CUENTA_CTE,
                    RESTRICCION,
                    IMPORTE,
                    DESCRIPCION,
                    MEMO,
                    VOUCHER, 
                    PARENT_ID,
                    REF_ID,
                    AGRUPA
                    )VALUES ( 
                    P_ID_OPERORIGEN,
                    P_ID_ORIGEN,
                    l_fondo,
                    l_depto,
                    l_id_cuentaaasi,
                    l_cuenta_cte,
                    l_id_restriccion,
                    l_importeasiento,
                    substr(l_detalle,1,50),
                    l_memo,
                    l_voucher,
                    null,
                    l_ref_id,
                    l_agrupa
                    );
                  else

                    update CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                    where ID_TIPOORIGEN=P_ID_OPERORIGEN
                    and ID_ORIGEN=P_ID_ORIGEN
                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                    and CUENTA =l_id_cuentaaasi
                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                    and case when importe>0 then 'D' else 'C' end=l_dc;

                  end if;
                end if;
                  --DESTINO
                  OPEN casides;
                  FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                  WHILE casides%FOUND LOOP

                    -- En la distribución de gasto de la compra tiene otros departamentos?
                    
                  
                    select case when l_id_indicadord='IMPORTE' then (l_importe)*(l_porcentaje)
                          when l_id_indicadord='IMPORTE_TARJETA' then (l_importe_tarjeta)*(l_porcentaje)
                          when l_id_indicadord='IMPORTE_TRANS' then (l_importe_trans)*(l_porcentaje)
                          else
                          0
                          end into STRICT l_importeasiento
;

                    l_depto:=null;
                    l_cuenta_cte:=null;

                    if l_unicod='U' then
                      select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                    elsif (l_unicod='M') then
                       SELECT position('|' in l_deptos) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasid) into STRICT l_depto;
                       else
                        l_depto:=l_deptos;
                       end if;
                    elsif (l_unicod='X') then
                       select FC_DEPTO_CLIENTE(l_id_cliente) into STRICT l_depto;
                    end if;

                    if l_unicoctated='U' then
                      select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                      if l_cont>0 then
                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                      end if;

                    elsif (l_unicoctated='M') then
                       SELECT position('|' in l_ctates) into STRICT l_buscar;
                       if l_buscar>0 then
                         select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                         select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                         select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasid) into STRICT l_cuenta_cte;
                       else
                        l_cuenta_cte:=l_ctates;
                       end if;
                    elsif (l_unicoctated='X') then
                      select NUM_DOCUMENTO into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente;
                    end if;

                    if l_dc='C' then
                      l_importeasiento:=l_importeasiento*(-1);
                    end if;
                    if l_importeasiento<>0 then

                      select count(*) into STRICT l_cont from CONTA_ASIENTO
                      where ID_TIPOORIGEN=P_ID_OPERORIGEN
                      and ID_ORIGEN=P_ID_ORIGEN
                      and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                      and CUENTA =l_id_cuentaaasid
                      and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                      and case when importe>0 then 'D' else 'C' end=l_dc;

                    
                      IF l_agrupa='S' and l_cont>0 THEN
                        update  CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento
                        where ID_TIPOORIGEN=P_ID_OPERORIGEN
                        and ID_ORIGEN=P_ID_ORIGEN
                        and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                        and CUENTA =l_id_cuentaaasid
                        and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                        and case when importe>0 then 'D' else 'C' end=l_dc;

                      ELSE
                        INSERT INTO CONTA_ASIENTO(
                        ID_TIPOORIGEN,
                        ID_ORIGEN, 
                        FONDO,
                        DEPTO,
                        CUENTA, 
                        CUENTA_CTE,
                        RESTRICCION,
                        IMPORTE,
                        DESCRIPCION,
                        MEMO,
                        VOUCHER, 
                        PARENT_ID,
                        REF_ID,
                        AGRUPA
                        )VALUES ( 
                        P_ID_OPERORIGEN,
                        P_ID_ORIGEN,
                        l_fondo,
                        l_depto,
                        l_id_cuentaaasid,
                        l_cuenta_cte,
                        l_id_restricciond,
                        l_importeasiento,
                        l_detalle,
                        l_memo,
                        l_voucher,
                        null,
                        l_ref_id,
                        l_agrupa
                        );
                      END IF;

                      
                    end if;
                    FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;
                  END LOOP;
                  CLOSE casides;
                
                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa;

              END LOOP;
              CLOSE casi;

            FETCH cdet INTO l_dinamica,l_id_entidad;

        END LOOP;
        CLOSE cdet;
        
        
        select count(*) into STRICT l_contar from CONTA_ASIENTO
        where ID_TIPOORIGEN=P_ID_OPERORIGEN
        and ID_ORIGEN=P_ID_ORIGEN;

        if l_contar=0 then
            l_error:=3; --no se ha generado el asiento
            if P_ID_OPERORIGEN = 11 then
                l_msgerror:='Asiento Detraccion: No se ha generado el asiento';
            else
                l_msgerror:='Asiento Retencion: No se ha generado el asiento';
            end if;
        else
            select COALESCE(sum(case when IMPORTE>0 then IMPORTE else 0 end),0) as debito,
            COALESCE(sum(case when IMPORTE<0 then IMPORTE*(-1) else 0 end),0) as credito
            into STRICT l_debito,l_credito
            from CONTA_ASIENTO
            where ID_TIPOORIGEN=P_ID_OPERORIGEN
            and ID_ORIGEN=P_ID_ORIGEN;

            if l_credito=0 or l_credito=0 then
                l_error:=4; --importe de debito o credito igual a cero
                if P_ID_OPERORIGEN = 11 then
                    l_msgerror:='Asiento Detraccion: Importe de débito o crédito igual a cero';
                else
                    l_msgerror:='Asiento Retencion: Importe de débito o crédito igual a cero';
                end if;

            else
                if l_credito<>l_credito then
                    l_error:=5; --descuadre de asiento
                    if P_ID_OPERORIGEN = 11 then
                        l_msgerror:='Asiento Detraccion: Descuadre de asiento';
                    else
                        l_msgerror:='Asiento Retencion: Descuadre de asiento';
                    end if;

                end if;
            end if;

        end if;

        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_generar_asiento_ret_det (P_ID_OPERORIGEN bigint,P_ID_ORIGEN bigint,P_ID_DINAMICA bigint,P_ID_CTABANCARIA bigint,P_IMPORTE bigint,P_DETALLE text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
