-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_crear_deposito_detalle (P_ID_DEPOSITO bigint,P_VENTAS text,P_IMP_VENTAS text,P_TIPO text,P_ID_MONEDA bigint,P_TIPO_CAMBIO bigint,P_ID_DINAMICA bigint,P_ERROR out bigint, P_MSGERROR out text) AS $body$
DECLARE

    l_id_ddetalle bigint;
    l_id_voucher bigint;
    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_total decimal(10,2);
    l_importe decimal(10,2);
    l_importe_me decimal(10,2);
    s_ventas tablastring;
    s_importes tablastring;
    s_tipo tablastring;
    l_id_venta bigint;
    l_imp  decimal(10,2);
    l_cont bigint;
    l_id_saldo bigint;
    l_id_cliente bigint;
    l_id_transferencia bigint;

BEGIN
 
      
      select FC_SPLIT_1(P_VENTAS,'|') into STRICT s_ventas;
      select FC_SPLIT_1(P_IMP_VENTAS,'|') into STRICT s_importes;
      select FC_SPLIT_1(P_TIPO,'|') into STRICT s_tipo;

    IF  s_ventas.count > 0  AND s_tipo.count = 1 THEN
        s_tipo.extend(s_ventas.count);
        FOR a IN s_ventas.first..s_ventas.last LOOP
            s_tipo(a) := P_TIPO;
        END LOOP;
    END IF;

      FOR i IN s_ventas.FIRST .. s_ventas.LAST
      LOOP
          select cast(s_ventas(i) as bigint) into STRICT l_id_venta;

          select cast(s_importes(i) as bigint) into STRICT l_imp;

          
          l_importe:=0;

          select id_cliente into STRICT l_id_cliente from caja_deposito
          where id_deposito = P_ID_DEPOSITO;

          --select count(1) into l_cont from VENTA where ID_VENTA=l_id_venta and id_cliente = l_id_cliente;
          
          --if l_cont > 0 then
          if s_tipo(i)='V' then
            select total into STRICT l_total from VENTA where ID_VENTA=l_id_venta and id_cliente = l_id_cliente;
            --L_ID_SALDO := NULL;
            select coalesce(sum(IMPORTE),0) into STRICT l_importe from CAJA_DEPOSITO_DETALLE where ID_VENTA=l_id_venta;
          else
            if s_tipo(i)='S' then
                select total into STRICT l_total from VENTA_SALDO where id_saldo = l_id_venta and id_cliente = l_id_cliente;
                select coalesce(sum(IMPORTE),0) into STRICT l_importe from CAJA_DEPOSITO_DETALLE where ID_SALDO=l_id_venta;
            else
                select importe into STRICT l_total from VENTA_TRANSFERENCIA where id_transferencia = l_id_venta and id_cliente = l_id_cliente;
                select coalesce(sum(IMPORTE),0) into STRICT l_importe from CAJA_DEPOSITO_DETALLE where ID_TRANSFERENCIA=l_id_venta;
            end if;
            --l_id_venta :=NULL;
            --L_ID_SALDO := l_id_venta;
          end if;

          
          --select coalesce(sum(IMPORTE),0) into l_importe from CAJA_DEPOSITO_DETALLE where ID_VENTA=l_id_venta;
          
          l_importe:=l_importe + l_imp;

          select coalesce(max(ID_DDETALLE),0)+1 into STRICT l_id_ddetalle from CAJA_DEPOSITO_DETALLE;

          if l_importe > l_total then
              l_error:=1; --no existe voucher
              l_msgerror:='Depósito Detalle: Importe pago mayor a total venta';
          end if;

         l_importe_me:=0;
         if P_ID_MONEDA=9 then
           l_importe_me:=l_imp;
           l_imp:=l_imp*P_TIPO_CAMBIO;
         end if;

         --Valida si la venta y deposito tiene a misma cuenta contable
         select count(*) into STRICT l_contar from VENTA_DETALLE A,CONTA_DINAMICA B, CONTA_DINAMICA_ASIENTO C
         WHERE A.ID_DINAMICA=B.ID_DINAMICA
         AND B.ID_DINAMICA=C.ID_DINAMICA
         AND A.ID_VENTA=ID_VENTA
         and C.ID_INDICADOR='IMPORTE'
         AND C.ID_CUENTAAASI IN (
            SELECT ID_CUENTAAASI from CONTA_DINAMICA_ASIENTO where ID_DINAMICA=P_ID_DINAMICA
         );

         if l_contar=0 then
              l_error:=2; --no existe voucher
              l_msgerror:='Depósito Detalle: Cuenta contable del depósito es distinto a la cuenta contable de venta';
         end if;

         if l_error=0 then
         
        --if l_cont > 0 then
        if s_tipo(i)='V' then
            l_id_saldo := NULL;
            l_id_transferencia := NULL;
        else
            if s_tipo(i)='S' then
                l_id_saldo := l_id_venta;
                l_id_venta :=NULL;
                l_id_transferencia := NULL;
            else
                l_id_transferencia := l_id_venta;
                l_id_saldo := NULL;
                l_id_venta :=NULL;
            end if;
        end if;

          insert into CAJA_DEPOSITO_DETALLE(
            --ID_DDETALLE,
            ID_DEPOSITO,
            ID_VENTA,
            IMPORTE,
            IMPORTE_ME,
            ID_SALDO,
            ID_TRANSFERENCIA
          )values (
            --l_id_ddetalle,
            P_ID_DEPOSITO,
            l_id_venta,
            l_imp,
            l_importe_me,
            l_id_saldo,
            l_id_transferencia
          );
        end if;
    END LOOP;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_crear_deposito_detalle (P_ID_DEPOSITO bigint,P_VENTAS text,P_IMP_VENTAS text,P_TIPO text,P_ID_MONEDA bigint,P_TIPO_CAMBIO bigint,P_ID_DINAMICA bigint,P_ERROR out bigint, P_MSGERROR out text) FROM PUBLIC;
