-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_eliminar_pago_detalle (P_ID_PAGO bigint,P_ID_DETALLE text,P_TIPO bigint,P_PLACE bigint) AS $body$
DECLARE

        P_TABLA varchar(1);
        L_ID_DETALLE bigint;
        L_IMPORTE bigint := 0;
        L_IMPORTE_ME bigint := 0;
        L_COUNT_DETALLE bigint := 0;
        L_ID_TIPOORIGEN bigint;
        L_ID_TRANSFERENCIA bigint;
        L_ID_VOUCHER bigint;
        L_ID_USER bigint;
        L_ID_USER_FILE bigint;
        L_CANT bigint;
        L_ID_DOCUMENTO bigint;
        L_CODIGO varchar(10);
        L_ID_DPROCESO bigint;

BEGIN
            SELECT SUBSTR(P_ID_DETALLE,1,1)::text, (SUBSTR(P_ID_DETALLE,2))::numeric  INTO STRICT P_TABLA, L_ID_DETALLE;
            --SELECT DECODE(ID_MEDIOPAGO,'001',9,'007',8,'008',7) INTO L_ID_TIPOORIGEN FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
            SELECT ID_USER,ID_VOUCHER INTO STRICT L_ID_USER,L_ID_VOUCHER FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
            if P_TIPO=0 then  -- Solo un detalle
                IF P_TABLA = 'G' THEN  --gastos
                 RAISE NOTICE 'ERA--> 00 : %', P_TABLA;

                    SELECT ID_TIPOORIGEN INTO STRICT L_ID_TIPOORIGEN FROM CAJA_PAGO_GASTO WHERE ID_PGASTO = L_ID_DETALLE;
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = L_ID_DETALLE;
                    DELETE FROM CAJA_PAGO_GASTO_ASIENTO WHERE ID_PGASTO = L_ID_DETALLE;
                    SELECT COUNT(1) INTO STRICT L_CANT FROM CAJA_VALE_FILE WHERE ID_PGASTO = L_ID_DETALLE AND TIPO = '3' AND ORIGEN = '2';
                    IF L_CANT > 0 THEN
                        SELECT ID_USER INTO STRICT L_ID_USER_FILE FROM CAJA_VALE_FILE WHERE ID_PGASTO = L_ID_DETALLE AND TIPO = '3';
                    END IF;

                    IF L_ID_USER = L_ID_USER_FILE THEN
                        DELETE FROM CAJA_VALE_FILE WHERE ID_PGASTO = L_ID_DETALLE AND TIPO = '3' AND ORIGEN = '2';
                    ELSE
                        UPDATE CAJA_VALE_FILE SET ID_PGASTO  = NULL WHERE ID_PGASTO = L_ID_DETALLE AND TIPO = '3';
                    END IF;

                    SELECT COUNT(1) INTO STRICT L_CANT FROM CAJA_VALE_GASTO WHERE ID_PGASTO = L_ID_DETALLE;
                    IF L_CANT > 0 THEN
                        UPDATE CAJA_VALE_GASTO SET ID_PGASTO  = NULL WHERE ID_PGASTO = L_ID_DETALLE;
                    END IF;

                    SELECT COUNT(1) INTO STRICT L_CANT FROM CAJA_DOCUMENTO WHERE ID_PGASTO = L_ID_DETALLE;
                    IF L_CANT > 0 THEN
                        SELECT ID_DOCUMENTO,CODIGO INTO STRICT L_ID_DOCUMENTO,L_CODIGO
                        FROM CAJA_DOCUMENTO WHERE ID_PGASTO = L_ID_DETALLE;

                        IF L_CODIGO = 'PRODOC' THEN 
                            SELECT ID_DPROCESO INTO STRICT L_ID_DPROCESO FROM PROCESO_DOCUMENTO WHERE CODIGO = L_CODIGO;
                            DELETE FROM CAJA_DOCUMENTO_PROCESO WHERE ID_DOCUMENTO = L_ID_DOCUMENTO AND ID_DPROCESO = L_ID_DPROCESO;
                        END IF;
                        UPDATE CAJA_DOCUMENTO SET ID_PGASTO  = NULL, CODIGO = 'AUTDOC' WHERE ID_PGASTO = L_ID_DETALLE;
                    END IF;

                    DELETE FROM CAJA_PAGO_GASTO WHERE ID_PGASTO = L_ID_DETALLE;
                    DELETE FROM CAJA_PAGO_ASIENTO WHERE  ID_PAGO = P_ID_PAGO;

                    
                /*ELSE --ESTA PARA ANALIZAR
                    DELETE FROM CONTA_ASIENTO WHERE ID_ORIGEN IN (
                                    SELECT ID_AJUSTE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN 
                                        (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO AND ID_PCOMPRA = L_ID_DETALLE))
                    AND ID_TIPOORIGEN = L_ID_TIPOORIGEN; -- COMPRA TRANSFERENCIA O AJUS 
                    
                    DELETE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO AND ID_PCOMPRA = L_ID_DETALLE);
                    -- Eliminar conta_asiento
                    
                    DELETE FROM CONTA_ASIENTO WHERE ID_ORIGEN IN (SELECT ID_PCOMPRA FROM CAJA_PAGO_COMPRA WHERE ID_PAGO=P_ID_PAGO AND ID_PCOMPRA=L_ID_DETALLE)
                    AND ID_TIPOORIGEN = L_ID_TIPOORIGEN; --Cheques o tranferencias
                    
                    DELETE from CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO
                    AND ID_PCOMPRA = L_ID_DETALLE;*/
                END IF;

                IF P_TABLA = 'D' THEN  --COMPRA
                
                    SELECT coalesce(MAX(ID_TIPOORIGEN),0) INTO STRICT L_ID_TIPOORIGEN FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO AND ID_PCOMPRA = L_ID_DETALLE);

                    IF L_ID_TIPOORIGEN <> 0 THEN
                        DELETE FROM CONTA_ASIENTO WHERE ID_ORIGEN IN (
                                        SELECT ID_AJUSTE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO AND ID_PCOMPRA = L_ID_DETALLE) )
                        AND ID_TIPOORIGEN = L_ID_TIPOORIGEN; -- COMPRA TRANSFERENCIA O AJUS 
                        DELETE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO AND ID_PCOMPRA = L_ID_DETALLE);
                    END IF;

                    SELECT ID_TIPOORIGEN INTO STRICT L_ID_TIPOORIGEN FROM CAJA_PAGO_COMPRA WHERE ID_PCOMPRA = L_ID_DETALLE;
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = L_ID_DETALLE;
                    DELETE from CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO AND ID_PCOMPRA = L_ID_DETALLE;
                END IF;
                IF P_TABLA = 'V' THEN  --VENTA
                    SELECT ID_TIPOORIGEN INTO STRICT L_ID_TIPOORIGEN FROM CAJA_PAGO_VENTA WHERE ID_PVENTA = L_ID_DETALLE;
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = L_ID_DETALLE AND VOUCHER = L_ID_VOUCHER;
                    SELECT ID_TRANSFERENCIA INTO STRICT L_ID_TRANSFERENCIA FROM VENTA_TRANSFERENCIA_DETALLE WHERE ID_PVENTA = L_ID_DETALLE;
                    UPDATE VENTA_TRANSFERENCIA SET IMPORTE = 0 , GLOSA = '<< Anulado >>' WHERE ID_TRANSFERENCIA = L_ID_TRANSFERENCIA;
                    UPDATE VENTA_TRANSFERENCIA_DETALLE SET ID_PVENTA  = NULL, IMPORTE = 0, DETALLE = '<< Anulado >>' WHERE ID_TRANSFERENCIA = L_ID_TRANSFERENCIA;
                    DELETE FROM CAJA_PAGO_VENTA WHERE ID_PAGO = P_ID_PAGO AND ID_PVENTA = L_ID_DETALLE;
                END IF;
                IF P_TABLA = 'X' THEN  --VALES
                    SELECT ID_TIPOORIGEN INTO STRICT L_ID_TIPOORIGEN FROM CAJA_VALE WHERE ID_VALE = L_ID_DETALLE;
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = L_ID_DETALLE;
                    --UPDATE CAJA_VALE SET 
                    --WHERE ID_VALE = L_ID_DETALLE;
                END IF;
            --else --- Eliminar todos los detalles del pago.
                /*
                IF P_TABLA = 'G' THEN --GASTO
                    DELETE FROM CAJA_PAGO_GASTO_ASIENTO WHERE ID_PGASTO IN (SELECT ID_PGASTO FROM CAJA_PAGO_GASTO where ID_PAGO = P_ID_PAGO);
                    DELETE from CAJA_PAGO_GASTO where ID_PAGO = P_ID_PAGO;
                --ELSE
                    
                    --DELETE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO);
                    
                    --DELETE from CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO;
                END IF;
                --ESTA PARA ANALIZAR
                IF P_TABLA = 'D' THEN --COMPRA
                    DELETE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO);
                
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = L_ID_DETALLE;
                    DELETE from CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO;
                END IF;
                IF P_TABLA = 'V' THEN --VENTA
                    DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN = L_ID_DETALLE;
                    DELETE from CAJA_PAGO_VENTA where ID_PAGO = P_ID_PAGO;
                END IF;
                */
            end if;

            IF P_PLACE = 2 THEN
            
                -- Recalculamos el monto del pago
                SELECT 
                    coalesce(SUM(IMPORTE),0) IMPORTE,
                    coalesce(SUM(IMPORTE_ME),0) IMPORTE_ME INTO STRICT L_IMPORTE,L_IMPORTE_ME
                FROM (
                    SELECT IMPORTE,IMPORTE_ME FROM CAJA_PAGO_COMPRA
                    WHERE ID_PAGO = P_ID_PAGO
                    
UNION ALL

                    SELECT IMPORTE,IMPORTE_ME FROM CAJA_PAGO_GASTO
                    WHERE ID_PAGO = P_ID_PAGO
                    
UNION ALL

                    SELECT IMPORTE, IMPORTE_ME FROM CAJA_PAGO_VENTA
                    WHERE ID_PAGO = P_ID_PAGO
                ) alias4;

                IF L_IMPORTE+L_IMPORTE_ME > 0 THEN
                    UPDATE CAJA_PAGO SET IMPORTE = L_IMPORTE, 
                                        IMPORTE_ME = L_IMPORTE_ME, 
                                        ESTADO = '1'
                    WHERE ID_PAGO = P_ID_PAGO;
                END IF;
                --
            
                -- Si ya no tiene detalle lo eliminamos
                SELECT SUM(CANTIDAD) INTO STRICT L_COUNT_DETALLE  FROM (SELECT COUNT(1) CANTIDAD FROM CAJA_PAGO_GASTO where ID_PAGO = P_ID_PAGO

UNION ALL
 
                SELECT COUNT(1) CANTIDAD FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO
                
UNION ALL

                SELECT COUNT(1) CANTIDAD FROM CAJA_PAGO_VENTA WHERE ID_PAGO = P_ID_PAGO) alias4;

                RAISE NOTICE 'ERA--> 01 : %', L_COUNT_DETALLE;
                RAISE NOTICE 'ERA--> 02 : %', P_ID_PAGO;
                IF L_COUNT_DETALLE = 0 THEN
                    DELETE FROM CAJA_PAGO_FILE WHERE  ID_PAGO = P_ID_PAGO;
                    DELETE FROM CAJA_PAGO_ASIENTO WHERE  ID_PAGO = P_ID_PAGO;
                    DELETE FROM CAJA_PAGO WHERE  ID_PAGO = P_ID_PAGO;
                END IF;

                    
            END IF;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_eliminar_pago_detalle (P_ID_PAGO bigint,P_ID_DETALLE text,P_TIPO bigint,P_PLACE bigint) FROM PUBLIC;
