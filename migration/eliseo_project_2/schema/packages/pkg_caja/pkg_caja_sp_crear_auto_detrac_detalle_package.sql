-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_crear_auto_detrac_detalle (P_ID_DETRACCION bigint,P_ID_VENTA bigint,P_ID_DINAMICA bigint,P_IMPORTE bigint,P_IMPORTE_ME bigint, P_ERROR out bigint, P_MSGERROR out text) AS $body$
DECLARE

        l_id_detdetalle bigint;
        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_importe_me decimal(10,2);
        L_NRO_OPERACION varchar(20);
        L_DETALLE varchar(255);

        
BEGIN
            l_error:=0;

            SELECT NRO_OPERACION INTO STRICT L_NRO_OPERACION
            FROM CAJA_DETRACCION
            WHERE ID_DETRACCION = P_ID_DETRACCION;

            SELECT 
                ID_ENTIDAD||'-'||ID_DEPTO||', Det.:'||L_NRO_OPERACION||' Doc:'||SERIE||'-'||NUMERO||' '||FC_NOMBRE_PERSONA(ID_CLIENTE) INTO STRICT L_DETALLE
            FROM VENTA
            WHERE ID_VENTA = P_ID_VENTA;

            --SELECT coalesce(max(ID_DETDETALLE),0)+1 into l_id_detdetalle FROM CAJA_DETRACCION_VENTA;
        
            if l_error=0 then
                IF coalesce(P_IMPORTE,0)+coalesce(P_IMPORTE_ME,0) > 0 THEN
                    INSERT INTO CAJA_DETRACCION_VENTA(
                    --ID_DETDETALLE,
                    ID_DETRACCION,
                    ID_VENTA,
                    ID_DINAMICA,
                    IMPORTE,
                    IMPORTE_ME,
                    DETALLE
                    )values (
                    --l_id_detdetalle,
                    P_ID_DETRACCION,
                    P_ID_VENTA,
                    P_ID_DINAMICA,
                    P_IMPORTE,
                    P_IMPORTE_ME,
                    L_DETALLE
                    ) returning id_detdetalle INTO l_id_detdetalle;
                    l_msgerror:='Pago OK';
                ELSE
                    l_error := 1;
                    l_msgerror:='No existen Importes';
                END IF;
            end if;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_crear_auto_detrac_detalle (P_ID_DETRACCION bigint,P_ID_VENTA bigint,P_ID_DINAMICA bigint,P_IMPORTE bigint,P_IMPORTE_ME bigint, P_ERROR out bigint, P_MSGERROR out text) FROM PUBLIC;
