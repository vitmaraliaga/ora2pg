-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_eliminar_pago (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        L_ID_TIPOORIGEN bigint;
        L_ACTIVO varchar(4);

BEGIN
            SELECT B.ACTIVO INTO STRICT L_ACTIVO
            FROM CAJA_PAGO A JOIN CONTA_VOUCHER B
            ON A.ID_VOUCHER = B.ID_VOUCHER
            WHERE A.ID_PAGO = P_ID_PAGO;

            IF L_ACTIVO = 'S' THEN
        
                IF l_error = 0 THEN 
                
                    -- Seleccionar id_tipoorigen de las COMPRA AJUSTE.
                    SELECT coalesce(MAX(ID_TIPOORIGEN),0) INTO STRICT L_ID_TIPOORIGEN FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO);
                    IF L_ID_TIPOORIGEN <> 0 THEN
                        -- Eliminar asientos de ajuste
                        DELETE FROM CONTA_ASIENTO WHERE ID_ORIGEN IN (
                            SELECT ID_AJUSTE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (
                                SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA WHERE ID_PAGO=P_ID_PAGO
                            )
                        )
                        AND ID_TIPOORIGEN = L_ID_TIPOORIGEN; --COMPRA TRANSFERENCIA O AJUS
                        -- Eliminar compra ajuste
                        DELETE FROM COMPRA_AJUSTE WHERE ID_COMPRA IN (SELECT ID_COMPRA FROM CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO);
                    END IF;

                    -- Seleccionar id_tipoorigen de los PAGO COMPRA.
                    SELECT coalesce(MAX(ID_TIPOORIGEN),0) INTO STRICT L_ID_TIPOORIGEN FROM CAJA_PAGO_COMPRA WHERE ID_PAGO = P_ID_PAGO;
                    IF L_ID_TIPOORIGEN <> 0 THEN
                    -- Eliminar asientos de pago compra
                        DELETE FROM CONTA_ASIENTO WHERE ID_ORIGEN IN (SELECT ID_PCOMPRA FROM CAJA_PAGO_COMPRA WHERE ID_PAGO=P_ID_PAGO)
                                AND ID_TIPOORIGEN =L_ID_TIPOORIGEN;
                                --AND ID_TIPOORIGEN IN (8, 9); --Cheques o tranferencias.
                    -- Eliminar caja pago compra
                        DELETE from CAJA_PAGO_COMPRA where ID_PAGO = P_ID_PAGO;
                    END IF;

                    
                    -- Seleccionar id_tipoorigen de los PAGO GASTO.
                    SELECT coalesce(MAX(ID_TIPOORIGEN),0) INTO STRICT L_ID_TIPOORIGEN FROM CAJA_PAGO_GASTO WHERE ID_PAGO = P_ID_PAGO;
                    IF L_ID_TIPOORIGEN <> 0 THEN
                    -- Eliminar asientos de pago gasto.
                        DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN IN (SELECT ID_PGASTO FROM CAJA_PAGO_GASTO WHERE ID_PAGO=P_ID_PAGO);
                    -- Eliminar caja pago gasto asiento
                        DELETE FROM CAJA_PAGO_GASTO_ASIENTO WHERE ID_PGASTO IN (SELECT ID_PGASTO FROM CAJA_PAGO_GASTO WHERE ID_PAGO=P_ID_PAGO);
                    -- Eliminar caja pago gasto
                        DELETE from CAJA_PAGO_GASTO where ID_PAGO = P_ID_PAGO;
                    END IF;

                    
                    -- Seleccionar id_tipoorigen de los PAGOS VENTA.
                    SELECT coalesce(MAX(ID_TIPOORIGEN),0) INTO STRICT L_ID_TIPOORIGEN FROM CAJA_PAGO_VENTA WHERE ID_PAGO = P_ID_PAGO;
                    IF L_ID_TIPOORIGEN <> 0 THEN
                        -- Eliminar asientos de pago venta.
                        DELETE FROM CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_ID_TIPOORIGEN AND ID_ORIGEN IN (SELECT ID_PVENTA FROM CAJA_PAGO_VENTA WHERE ID_PAGO=P_ID_PAGO);
                        -- Eliminar caja pago venta
                        DELETE FROM CAJA_PAGO_VENTA where ID_PAGO = P_ID_PAGO;
                    END IF;
                    --ELIMINO EL ASIENTO TEMP DE REDNICION
                    DELETE from CAJA_PAGO_ASIENTO where ID_PAGO = P_ID_PAGO;
                    -- Eliminar PAGO
                    DELETE from CAJA_PAGO where ID_PAGO = P_ID_PAGO;
                END IF;
            ELSE
                l_error :=1;
                l_msgerror :='ALTO: Voucher Exportado, No se puede Eliminar';
            END IF;

        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_eliminar_pago (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
