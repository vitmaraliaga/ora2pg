-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_generar_asiento_pago (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_dinamica bigint;
        l_asiento bigint;
        l_id_persona bigint;
        l_detalle varchar(100);
        l_detalle_in varchar(100);
        l_base decimal(10,2);
        l_igv decimal(10,2);
        l_descuento decimal(10,2);
        l_importe decimal(10,2);
        l_importe_me decimal(10,2);
        l_correlativo decimal(10,2); --Add by @vitmar
        l_precio_alm decimal(10,2);
        l_ctas varchar(200);
        l_deptos varchar(200);
        l_ctates varchar(200);

        l_actas tablastring;
        l_adeptos tablastring;
        l_actates tablastring;

        l_id_asiento bigint;
        l_id_parent bigint;
        l_id_tipoplan bigint;
        l_id_restriccion varchar(50);
        l_id_cuentaaasi varchar(10);
        l_dc varchar(1);
        l_destino varchar(1);
        l_id_indicador  varchar(35);
        l_unico varchar(1);
        l_porcentaje decimal(10,2);
        l_unicoctate varchar(1);

        l_id_asientod bigint;
        l_id_tipopland bigint;
        l_id_restricciond varchar(50);
        l_id_cuentaaasid varchar(10);
        l_dcd varchar(1);
        l_id_indicadord  varchar(35);
        l_unicod varchar(1);
        l_porcentajed decimal(10,2);
        l_unicoctated varchar(1);

        l_depto varchar(10);
        l_cuenta_cte varchar(50);
        l_count_cuenta_cte bigint;
        l_fondo varchar(10);
        l_importeasiento decimal(10,2);
        l_importeasiento_me decimal(10,2);
        l_importe_cheque decimal(10,2);
        l_importe_trans decimal(10,2);
        l_descripcion varchar(255);
        l_memo varchar(255);
        l_voucher varchar(10);
        l_ref_id varchar(100);

        l_id_entidad bigint;
        l_id_depto_pago varchar(20);
        l_buscar bigint;

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_operorigen bigint:=5;

        --validacion
        l_contar bigint;
        l_debito decimal(10,2);
        l_credito decimal(10,2);
        l_cont bigint;
        l_serie varchar(5);
        l_numero varchar(15);
        l_fecha timestamp(0);
        l_agrupa varchar(1);
        --l_id_cliente numeric;
        l_id_ctabancaria bigint;
        l_id_mediopago varchar(4);
        l_pgasto bigint;
        l_tipoorigen bigint;
        l_origen bigint;
        l_pago varchar(10);
        l_fecha_oper varchar(10);
        l_numero_oper varchar(10);
        L_BANCO varchar(20);
        l_det varchar(20);
        ES_VALE bigint;
        L_ID_VALE bigint;
        L_GLOSA varchar(200);

        cdet CURSOR FOR	
        SELECT 
        ID_PGASTO, ID_PGASTO as ID_ORIGEN, ID_TIPOORIGEN,ID_DINAMICA,ID_PERSONA,SUBSTR(DETALLE, 1, 50),IMPORTE,IMPORTE_ME, 0 as CORRELATIVO, 'Pagos Diversos' AS DET
        FROM CAJA_PAGO_GASTO
        WHERE ID_PAGO = P_ID_PAGO
        AND (ID_DINAMICA IS NOT NULL AND ID_DINAMICA::text <> '') 
        
UNION ALL

        SELECT 
        A.ID_PCOMPRA, A.ID_PCOMPRA AS ID_ORIGEN, A.ID_TIPOORIGEN,A.ID_DINAMICA,A.ID_PROVEEDOR, SUBSTR(A.DETALLE, 1, 50), A.IMPORTE,A.IMPORTE_ME, C.CORRELATIVO,'Pagos Proveedores' AS DET
        FROM CAJA_PAGO_COMPRA A
        INNER JOIN COMPRA C ON A.ID_COMPRA=C.ID_COMPRA
        WHERE A.ID_PAGO = P_ID_PAGO
        
UNION ALL

         SELECT 
        A.ID_PCOMPRA, A.ID_PCOMPRA AS ID_ORIGEN, A.ID_TIPOORIGEN,A.ID_DINAMICA,A.ID_PROVEEDOR, SUBSTR(A.DETALLE, 1, 50), A.IMPORTE,A.IMPORTE_ME, 1 AS CORRELATIVO,'Pagos Proveedores' AS DET
        FROM CAJA_PAGO_COMPRA A
        INNER JOIN COMPRA_SALDO C ON A.ID_SALDO=C.ID_SALDO
        WHERE A.ID_PAGO = P_ID_PAGO
        
UNION ALL

        SELECT 
        A.ID_PVENTA, A.ID_PVENTA AS ID_ORIGEN, A.ID_TIPOORIGEN,A.ID_DINAMICA,A.ID_CLIENTE, SUBSTR((A.DETALLE || '-' || ' Clientes'), 1, 50),A.IMPORTE, A.IMPORTE_ME, 0 as CORRELATIVO,'Pagos Clientes' AS DET
        FROM CAJA_PAGO_VENTA A LEFT JOIN VENTA B ON A.ID_VENTA=B.ID_VENTA
        WHERE A.ID_PAGO = P_ID_PAGO;

        casi CURSOR FOR		
        SELECT a.ID_ASIENTO,a.ID_PARENT,a.ID_TIPOPLAN,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.DESTINO,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,a.PORCENTAJE,
        a.NOMBRE,a.AGRUPA, a.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a
        WHERE a.ID_DINAMICA =l_dinamica
        AND COALESCE(a.ID_PARENT,0)=0  
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        casides CURSOR FOR		
        SELECT ID_ASIENTO,ID_TIPOPLAN,ID_RESTRICCION,ID_CUENTAAASI,DC,ID_INDICADOR,UNICO,UNICO_CTACTE,PORCENTAJE,NOMBRE,AGRUPA, ID_FONDO 
        FROM CONTA_DINAMICA_ASIENTO
        WHERE ID_PARENT=l_asiento
        ORDER BY NRO_ASIENTO,DC desc;

        gastos_otros_deptos CURSOR FOR		
        SELECT ID_DEPTO, IMPORTE, IMPORTE_ME FROM COMPRA_ASIENTO
        WHERE ID_COMPRA=l_origen
        AND ID_DEPTO <> l_depto;

        l_gastos_otros_id_depto varchar(10);
        l_gastos_otros_importe decimal(10,2);
        l_gastos_otros_importe_me decimal(10,2);

        
BEGIN
            SELECT COUNT(ID_VALE) INTO STRICT ES_VALE FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
            IF ES_VALE > 0 THEN
                SELECT ID_VALE INTO STRICT L_ID_VALE  FROM CAJA_PAGO WHERE ID_PAGO = P_ID_PAGO;
                SELECT ID_ENTIDAD||'-'||ID_DEPTO||'-[Vale :'||NRO_VALE||']-Rendicion-'||FC_NOMBRE_PERSONA(ID_EMPLEADO) INTO STRICT L_GLOSA
                FROM CAJA_VALE WHERE ID_VALE = L_ID_VALE;
            END IF;

        
            
            l_detalle:='';--P_DETALLE;
            l_detalle_in:='';--P_DETALLE Ya preparado para guardar;
            -- l_fondo:='10';
            
            --OBTIENE DATOS DEL PAGO
            SELECT
                    ID_ENTIDAD,ID_DEPTO,ID_CTABANCARIA,ID_VOUCHER,ID_MEDIOPAGO,CASE WHEN ID_MEDIOPAGO='008' THEN 7 WHEN ID_MEDIOPAGO='007' THEN 8 WHEN ID_MEDIOPAGO='001' THEN 9 END  AS ID_OPERACION,CASE WHEN ID_MEDIOPAGO='001' THEN 'TLC' WHEN ID_MEDIOPAGO='007' THEN 'CHQ' WHEN ID_MEDIOPAGO='008' THEN 'EFEC' WHEN ID_MEDIOPAGO='999' THEN 'REND' END  AS PAGO,TO_CHAR(FECHA,'DD/MM/YY') AS FECHA,NUMERO
                    --ID_ENTIDAD,ID_DEPTO,ID_CTABANCARIA,ID_VOUCHER,ID_MEDIOPAGO,DECODE(ID_MEDIOPAGO,'008',7,'007',8,'001',9) 
                    into STRICT l_id_entidad,l_id_depto_pago, l_id_ctabancaria,l_voucher,l_id_mediopago,l_id_operorigen,l_pago,l_fecha_oper,l_numero_oper
            FROM CAJA_PAGO WHERE ID_PAGO=P_ID_PAGO;

            SELECT B.SIGLA INTO STRICT L_BANCO FROM CAJA_CUENTA_BANCARIA A JOIN CAJA_ENTIDAD_FINANCIERA B
            ON A.ID_BANCO = B.ID_BANCO
            WHERE A.ID_CTABANCARIA = l_id_ctabancaria;
            --DETALLE
            OPEN cdet;

            FETCH cdet INTO l_pgasto, l_origen, l_tipoorigen,l_dinamica,l_id_persona,l_detalle,l_importe,l_importe_me,l_correlativo,l_det;
            WHILE cdet%FOUND LOOP
                l_memo :=l_tipoorigen || '-' || l_pgasto;
                ---DiNAMICA ASIENTO
                OPEN casi;
                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                WHILE casi%FOUND LOOP
                    IF l_id_entidad <> 7124 THEN
                        IF l_agrupa = 'S' THEN 
                            --l_detalle_in := SUBSTR(l_id_entidad || '-' || l_detalle, 1,50);
                            l_detalle_in := SUBSTR(l_id_entidad||'-'||l_id_depto_pago||'-'||l_pago||'-'||L_BANCO||'-OP-'||l_numero_oper||'-'||l_fecha_oper||'-'||l_det, 1,50);
                        ELSE
                            l_detalle_in:=l_detalle;
                            --l_detalle_in := SUBSTR( l_id_entidad || '-' || l_correlativo || '-' || l_detalle || '-' || SUBSTR(FC_NOMBRE_PERSONA(l_id_persona),1,100), 1,50);
                        END IF;
                    ELSE
                        IF l_agrupa = 'S' THEN 
                            l_detalle_in := SUBSTR(l_id_entidad||'-'||l_id_depto_pago||'-'||l_pago||'-'||L_BANCO||'-OP-'||l_numero_oper||'-'||l_fecha_oper||'-'||l_det, 1,50);
                        ELSE
                            l_detalle_in:=l_detalle;
                        END IF;
                    END IF;

                    select (case when l_id_indicador='IMPORTE' then (l_importe)*(l_porcentaje)
                              else
                              0
                              end), 
                              (case when l_id_indicador='IMPORTE' then (l_importe_me)*(l_porcentaje)
                              else
                              0
                              end)
                              into STRICT l_importeasiento, l_importeasiento_me
;

                    l_depto:=null;
                    l_cuenta_cte:=null;

                    if l_unico='U' then
                        select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                    elsif (l_unico='M') then
                        SELECT position('|' in l_deptos) into STRICT l_buscar;
                        if l_buscar>0 then
                            select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                            select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                            select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasi) into STRICT l_depto;
                        else
                            l_depto:=l_deptos;
                        end if;
                    elsif (l_unico='X') then
                       --select FC_DEPTO_CLIENTE(l_id_cliente) into l_depto from dual;
                       select FC_DEPTO_CLIENTE(l_id_persona) into STRICT l_depto;
                    elsif l_unico='S' THEN  -- Si es sesión
                        l_depto := l_id_depto_pago;
                    end if;

                    if l_unicoctate='U' then
                        select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                        if l_cont>0 then
                            if l_id_mediopago = '008' then
                                select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                            else
                                if l_dc = 'D' then
                                    select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asiento;
                                else
                                    SELECT ID_TIPOCTACTE into STRICT l_cuenta_cte FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;
                                end if;
                            end if;
                        end if;
                    elsif (l_unicoctate='M') then
                        if l_dc = 'C' then
                            SELECT ID_TIPOCTACTE into STRICT l_cuenta_cte FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;
                        end if;
                        /*SELECT INSTR(l_ctates, '|') into l_buscar FROM dual;
                        if l_buscar>0 then
                            select FC_SPLIT(l_ctas,'|') into l_actas  from dual;
                            select FC_SPLIT(l_ctates,'|') into l_actates  from dual; 
                            select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasi) into l_cuenta_cte from dual;
                        else
                            l_cuenta_cte:=l_ctates;
                        end if;*/
                    elsif (l_unicoctate='B') then
                        if l_dc = 'C' then
                            SELECT ID_TIPOCTACTE, ID_CUENTAAASI into STRICT l_cuenta_cte, l_id_cuentaaasi FROM CAJA_CUENTA_BANCARIA WHERE ID_CTABANCARIA = l_id_ctabancaria;
                        end if;
                    elsif (l_unicoctate='X') then
                        --select NUM_DOCUMENTO into l_cuenta_cte from VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente;
                        select count(ID_RUC) into STRICT l_count_cuenta_cte from MOISES.VW_PERSONA_JURIDICA where ID_PERSONA=l_id_persona;
                        if (l_count_cuenta_cte = 1) then  --CTA CTE RUC PROVEEDOR
                            select ID_RUC into STRICT l_cuenta_cte from MOISES.VW_PERSONA_JURIDICA where ID_PERSONA=l_id_persona;
                        else  --CTA CTE PERSONAL - EMPLEADO
                            select COUNT(1) into STRICT l_cont from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_persona and id_tipodocumento = 1;
                            IF l_cont > 0 THEN
                                select MIN(NUM_DOCUMENTO) into STRICT l_cuenta_cte from MOISES.VW_PERSONA_NATURAL where ID_PERSONA=l_id_persona and id_tipodocumento = 1;
                            END IF;
                        end if;
                    end if;
                
                    if l_dc='C' then
                        l_importeasiento:=l_importeasiento*(-1);
                        l_importeasiento_me:=l_importeasiento_me*(-1);
                         ---=====
                        IF ES_VALE > 0 THEN
                            SELECT B.CUENTA,CUENTA_CTE INTO STRICT l_id_cuentaaasi,l_cuenta_cte
                            FROM CAJA_VALE A JOIN CONTA_ASIENTO B ON A.ID_TIPOORIGEN = B.ID_TIPOORIGEN 
                            AND A.ID_VALE = B.ID_ORIGEN AND A.ID_VOUCHER = B.VOUCHER 
                            WHERE A.ID_VALE = L_ID_VALE
                            AND B.IMPORTE > 0;
                            l_detalle_in := L_GLOSA;
                            l_agrupa := 'S';
                        END IF;
                        --------
                    end if;

                    select count(1) into STRICT l_cont from CONTA_ASIENTO
                    where ID_TIPOORIGEN=l_tipoorigen
                    and ID_ORIGEN=l_pgasto
                    and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                    and CUENTA =l_id_cuentaaasi
                    and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                    and case when importe>0 then 'D' else 'C' end=l_dc;

                    if l_importeasiento<>0 then
                        if l_cont=0 then
                        --if l_cont=0 and l_agrupa = 'N' then 
                            INSERT INTO CONTA_ASIENTO(
                                            ID_TIPOORIGEN,
                                            ID_ORIGEN, 
                                            FONDO,
                                            DEPTO,
                                            CUENTA, 
                                            CUENTA_CTE,
                                            RESTRICCION,
                                            IMPORTE,
                                            DESCRIPCION,
                                            MEMO,
                                            VOUCHER, 
                                            PARENT_ID,
                                            REF_ID,
                                            AGRUPA,
                                            IMPORTE_ME
                            )VALUES ( 
                                            l_tipoorigen,
                                            l_pgasto,
                                            l_fondo,
                                            l_depto,
                                            l_id_cuentaaasi,
                                            l_cuenta_cte,
                                            l_id_restriccion,
                                            l_importeasiento,
                                            l_detalle_in,
                                            l_memo,
                                            l_voucher,
                                            null,
                                            l_ref_id,
                                            l_agrupa,
                                            l_importeasiento_me
                            );

                        else
                        
                            update CONTA_ASIENTO set IMPORTE=l_importeasiento, IMPORTE_ME = l_importeasiento_me
                            where ID_TIPOORIGEN=l_tipoorigen
                            and ID_ORIGEN=l_pgasto
                            and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                            and CUENTA =l_id_cuentaaasi
                            and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                            and case when importe>0 then 'D' else 'C' end=l_dc;
                            --AND 1=2;
                        end if;

                        --l_error:=0; --no se ha generado el asiento
                        --l_msgerror:=l_id_operorigen||'-'||P_ID_PAGO||'-'||l_depto||'-'||l_id_cuentaaasi||'-'||l_cuenta_cte||'-'||l_dc;
                    end if;

                    
                    -- Add by @vitmar INTERDEPARTAMENTOS.
                    IF l_id_entidad <> 7124 THEN 
                        l_asiento := l_id_asiento;
                        --l_depto := '0000';
                        -- Saber si el gasto de la proivision esta en diferenctes departamentos
                        OPEN gastos_otros_deptos;
                        FETCH gastos_otros_deptos INTO l_gastos_otros_id_depto, l_gastos_otros_importe, l_gastos_otros_importe_me;
                        WHILE gastos_otros_deptos%FOUND LOOP

                            OPEN casides;
                            FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctated,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                            WHILE casides%FOUND LOOP

                                 select case when l_id_indicadord='IMPORTE' then (l_gastos_otros_importe)*(l_porcentaje)
                                  else
                                  0
                                  end into STRICT l_gastos_otros_importe
;
                               
                               select case when l_id_indicadord='IMPORTE' then (l_gastos_otros_importe_me)*(l_porcentaje)
                                  else
                                  0
                                  end into STRICT l_gastos_otros_importe_me
;
                                
                                l_depto:=null;
                                l_cuenta_cte:=null;

                                if l_unicod='N' then
                                    l_depto := l_gastos_otros_id_depto;
                                elsif l_unicod='U' then
                                    select  count(*) into STRICT l_cont from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                                    if l_cont=1 then
                                        select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                                    end if;

                                end if;

                                if l_unicoctated='N' then
                                    l_cuenta_cte := l_gastos_otros_id_depto;
                                    --l_cuenta_cte := 'XXXX';
                                elsif l_unicoctated='U' then
                                    select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                                    if l_cont=1 then
                                        select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                                    end if;
                                end if;
                                if l_dcd='C' then
                                    l_gastos_otros_importe:=l_gastos_otros_importe*(-1);
                                    l_gastos_otros_importe_me:=l_gastos_otros_importe_me*(-1);
                                end if;

                                if l_gastos_otros_importe<>0 then
                                    INSERT INTO CONTA_ASIENTO(
                                        ID_TIPOORIGEN,
                                        ID_ORIGEN, 
                                        FONDO,
                                        DEPTO,
                                        CUENTA, 
                                        CUENTA_CTE,
                                        RESTRICCION,
                                        IMPORTE,
                                        DESCRIPCION,
                                        MEMO,
                                        VOUCHER, 
                                        PARENT_ID,
                                        REF_ID,
                                        AGRUPA,
                                        IMPORTE_ME
                                    )VALUES ( 
                                        l_tipoorigen,
                                        l_pgasto,
                                        l_fondo,
                                        l_depto,
                                        l_id_cuentaaasid,
                                        l_cuenta_cte,
                                        l_id_restricciond,
                                        l_gastos_otros_importe,
                                        l_detalle_in ,
                                        l_memo,
                                        l_voucher,
                                        null,
                                        l_ref_id,
                                        l_agrupa,
                                        l_gastos_otros_importe_me
                                    );

                                end if;

                                FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctated,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                            END LOOP;
                            CLOSE casides;
                            
                            FETCH gastos_otros_deptos INTO l_gastos_otros_id_depto, l_gastos_otros_importe, l_gastos_otros_importe_me;
                        END LOOP;
                        CLOSE gastos_otros_deptos;
                        l_asiento := 0;
                    END IF;

                    --DESTINO
                    OPEN casides;
                    FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                    WHILE casides%FOUND LOOP

                        select (case when l_id_indicadord='IMPORTE' then (l_importe)*(l_porcentaje)
                              when l_id_indicadord='IMPORTE_TARJETA' then (l_importe_cheque)*(l_porcentaje)
                              when l_id_indicadord='IMPORTE_TRANS' then (l_importe_trans)*(l_porcentaje)
                              else
                              0
                              end),
                              (case when l_id_indicadord='IMPORTE' then (l_importe_me)*(l_porcentaje)
                              when l_id_indicadord='IMPORTE_TARJETA' then (l_importe_cheque)*(l_porcentaje)
                              when l_id_indicadord='IMPORTE_TRANS' then (l_importe_trans)*(l_porcentaje)
                              else
                              0
                              end) into STRICT l_importeasiento,l_importeasiento_me
;

                        l_depto:=null;
                        l_cuenta_cte:=null;

                        if l_unicod='U' then
                            select ID_DEPTO into STRICT l_depto from CONTA_DINAMICA_DEPTO where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                        elsif (l_unicod='M') then
                            SELECT position('|' in l_deptos) into STRICT l_buscar;
                           if l_buscar>0 then
                                select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                select FC_SPLIT(l_deptos,'|') into STRICT l_adeptos;
                                select FC_OBTENER_DPTOCTCTE(l_actas,l_adeptos ,l_id_cuentaaasid) into STRICT l_depto;
                            else
                                l_depto:=l_deptos;
                            end if;
                        elsif (l_unicod='X') then
                           --select FC_DEPTO_CLIENTE(l_id_cliente) into l_depto from dual;
                           select FC_DEPTO_CLIENTE(l_id_persona) into STRICT l_depto;
                        end if;

                        if l_unicoctated='U' then
                            select  count(*) into STRICT l_cont from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                            if l_cont>0 then
                                select ID_CTACTE into STRICT l_cuenta_cte from CONTA_DINAMICA_CTA_CTE where id_entidad=l_id_entidad and id_asiento=l_id_asientod;
                            end if;

                        elsif (l_unicoctated='M') then
                            SELECT position('|' in l_ctates) into STRICT l_buscar;
                            if l_buscar>0 then
                                select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                                select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,l_id_cuentaaasid) into STRICT l_cuenta_cte;
                            else
                                l_cuenta_cte:=l_ctates;
                            end if;
                        elsif (l_unicoctated='X') then
                            --select NUM_DOCUMENTO into l_cuenta_cte from VW_PERSONA_NATURAL where ID_PERSONA=l_id_cliente;
                            select count(ID_RUC) into STRICT l_count_cuenta_cte from MOISES.VW_PERSONA_JURIDICA where ID_PERSONA=l_id_persona;
                            if (l_count_cuenta_cte = 1) then
                                select ID_RUC into STRICT l_cuenta_cte from MOISES.VW_PERSONA_JURIDICA where ID_PERSONA=l_id_persona;
                            end if;
                        end if;

                        if l_dc='C' then
                            l_importeasiento:=l_importeasiento*(-1);
                            l_importeasiento_me:=l_importeasiento_me*(-1);
                        end if;
                        if l_importeasiento<>0 then
                            select count(*) into STRICT l_cont from CONTA_ASIENTO
                            where ID_TIPOORIGEN=l_tipoorigen
                            and ID_ORIGEN=l_pgasto
                            and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                            and CUENTA =l_id_cuentaaasid
                            and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                            and case when importe>0 then 'D' else 'C' end=l_dc;

                            IF l_agrupa='S' and l_cont>0 THEN
                                update  CONTA_ASIENTO set IMPORTE=IMPORTE+l_importeasiento,IMPORTE_ME=IMPORTE_ME+l_importeasiento_me
                                where ID_TIPOORIGEN=l_tipoorigen
                                and ID_ORIGEN=l_pgasto
                                and coalesce(DEPTO,'-') =coalesce(l_depto,'-')
                                and CUENTA =l_id_cuentaaasid
                                and coalesce(CUENTA_CTE,'-')=coalesce(l_cuenta_cte,'-')
                                and case when importe>0 then 'D' else 'C' end=l_dc;
                            ELSE
                                INSERT INTO CONTA_ASIENTO(
                                ID_TIPOORIGEN,
                                ID_ORIGEN,
                                FONDO,
                                DEPTO,
                                CUENTA, 
                                CUENTA_CTE,
                                RESTRICCION,
                                IMPORTE,
                                DESCRIPCION,
                                MEMO,
                                VOUCHER, 
                                PARENT_ID,
                                REF_ID,
                                AGRUPA,
                                IMPORTE_ME
                                )VALUES ( 
                                l_tipoorigen,
                                l_pgasto,
                                l_fondo,
                                l_depto,
                                l_id_cuentaaasid,
                                l_cuenta_cte,
                                l_id_restricciond,
                                l_importeasiento,
                                l_detalle_in,
                                l_memo,
                                l_voucher,
                                null,
                                l_ref_id,
                                l_agrupa,
                                l_importeasiento_me
                                );
                            END IF;
                        end if;
                    FETCH casides INTO l_id_asientod,l_id_tipopland,l_id_restricciond,l_id_cuentaaasid,l_dcd,l_id_indicadord,l_unicod,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                    END LOOP;
                    CLOSE casides;
                
                FETCH casi INTO l_id_asiento,l_id_parent,l_id_tipoplan,l_id_restriccion,l_id_cuentaaasi,l_dc,l_destino,l_id_indicador,l_unico,l_unicoctate,l_porcentaje,l_descripcion,l_agrupa, l_fondo;
                END LOOP;
                CLOSE casi;

            FETCH cdet INTO l_pgasto,l_origen, l_tipoorigen,l_dinamica,l_id_persona,l_detalle,l_importe, l_importe_me, l_correlativo,l_det;
            END LOOP;
            CLOSE cdet;

            select count(*) into STRICT l_contar from CONTA_ASIENTO
            where ID_TIPOORIGEN=l_tipoorigen
            and ID_ORIGEN=l_pgasto;

            if l_contar=0 then
              l_error:=3; --no se ha generado el asiento
              l_msgerror:='Asiento Pago: No se ha generado el asiento';
            else
                select COALESCE(sum(case when IMPORTE>0 then IMPORTE else 0 end),0) as debito,
                COALESCE(sum(case when IMPORTE<0 then IMPORTE*(-1) else 0 end),0) as credito
                into STRICT l_debito,l_credito
                from CONTA_ASIENTO
                where ID_TIPOORIGEN=l_tipoorigen
                and ID_ORIGEN=l_pgasto;

                if l_credito=0 or l_credito=0 then
                    l_error:=4; --importe de debito o credito igual a cero
                    l_msgerror:='Asiento Pago: Importe de débito o crédito igual a cero';
                else
                    if l_credito<>l_credito then
                        l_error:=5; --descuadre de asiento
                        l_msgerror:='Asiento Pago: Descuadre de asiento';
                    end if;
                end if;
            end if;

            P_ERROR:=l_error;
            P_MSGERROR:=l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_generar_asiento_pago (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
