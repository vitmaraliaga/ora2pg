-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_sp_autoriza_vale (P_ID_VALE integer, P_ID_DINAMICA integer, P_ID_PERSONA_AUTO bigint,P_ID_MEDIOPAGO text,P_ID_CTABANCARIA bigint, P_CTA_BANCARIA text,P_FECHA_VENC timestamp(0),P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_ASIENTO integer;
        L_ERROR bigint :=0;
        L_MSGERROR varchar(200);
        L_CONT bigint :=0;

BEGIN
            SELECT COUNT(*) INTO STRICT L_CONT FROM CAJA_VALE_AUTORIZA
            WHERE ID_PERSONA = P_ID_PERSONA_AUTO;
            IF L_CONT = 0 THEN
                P_MSGERROR := 'VALE: No Existe Cta Cte Configurada para el Tesorero(a)';
                P_ERROR := 1;
            ELSE
                IF P_ID_MEDIOPAGO = '007' THEN
                    UPDATE CAJA_VALE SET ID_PERSONA_AUTO = P_ID_PERSONA_AUTO,
                                        ID_DINAMICA = P_ID_DINAMICA,
                                        ID_MEDIOPAGO = P_ID_MEDIOPAGO,
                                        FECHA_VENCIMIENTO = P_FECHA_VENC
                    WHERE ID_VALE = P_ID_VALE;
                ELSE
                    UPDATE CAJA_VALE SET ID_PERSONA_AUTO = P_ID_PERSONA_AUTO,
                                        ID_DINAMICA = P_ID_DINAMICA,
                                        ID_MEDIOPAGO = P_ID_MEDIOPAGO,
                                        ID_CTABANCARIA = P_ID_CTABANCARIA,
                                        CTA_BANCARIA = P_CTA_BANCARIA,
                                        FECHA_VENCIMIENTO = P_FECHA_VENC
                    WHERE ID_VALE = P_ID_VALE;
                END IF;

                
                CALL pkg_caja_sp_asiento_vale(P_ID_VALE,L_ERROR,L_MSGERROR);
                P_MSGERROR := L_MSGERROR;
                P_ERROR := L_ERROR;
            END IF;
            /*
            SELECT NVL(MAX(ID_ASIENTO),0)+1 INTO L_ID_ASIENTO FROM CAJA_VALE_ASIENTO;
            INSERT INTO CAJA_VALE_ASIENTO ( ID_ASIENTO,
                                            ID_VALE,
                                            ID_CUENTAAASI,
                                            ID_CTACTE,
                                            ID_DEPTO,
                                            ID_RESTRICCION,
                                            DC
                                            -- ,ESTADO
                                        )VALUES(
                                            L_ID_ASIENTO,
                                            P_ID_VALE,
                                            P_ID_CUENTAAASI,
                                            P_ID_CTACTE,
                                            P_ID_DEPTO,
                                            P_ID_RESTRICCION,
                                            'D'
                                            --, '1'
                                        );*/
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_sp_autoriza_vale (P_ID_VALE integer, P_ID_DINAMICA integer, P_ID_PERSONA_AUTO bigint,P_ID_MEDIOPAGO text,P_ID_CTABANCARIA bigint, P_CTA_BANCARIA text,P_FECHA_VENC timestamp(0),P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
