-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_finalizar_devolucion_venta (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        L_IMPORTE bigint;
        L_IMPORTE_ME bigint;
        L_ENTIDAD_PAGO bigint;

       
        l_error bigint:=0;
        l_msgerror varchar(200):='';

BEGIN
        
        SELECT COALESCE(ID_ENTIDAD, 0) INTO STRICT L_ENTIDAD_PAGO FROM CAJA_PAGO WHERE ID_PAGO=P_ID_PAGO;

        SELECT 
                coalesce(SUM(IMPORTE),0) IMPORTE,
                coalesce(SUM(IMPORTE_ME),0) IMPORTE_ME INTO STRICT L_IMPORTE,L_IMPORTE_ME
        FROM (
            SELECT IMPORTE,IMPORTE_ME FROM CAJA_PAGO_COMPRA
            WHERE ID_PAGO = P_ID_PAGO
            
UNION ALL

            SELECT IMPORTE,IMPORTE_ME FROM CAJA_PAGO_GASTO
            WHERE ID_PAGO = P_ID_PAGO
            
UNION ALL

            SELECT IMPORTE,IMPORTE_ME FROM CAJA_PAGO_VENTA
            WHERE ID_PAGO = P_ID_PAGO
        ) alias4;

        IF l_error=0 AND L_ENTIDAD_PAGO <> 0 THEN
            
            IF L_IMPORTE+L_IMPORTE_ME > 0 THEN
                UPDATE CAJA_PAGO SET    IMPORTE = L_IMPORTE, 
                                        IMPORTE_ME = L_IMPORTE_ME, 
                                        ESTADO = '1'
                WHERE ID_PAGO = P_ID_PAGO;
                if l_error=0  then
                    pkg_caja_school_sp_generar_asiento_dev_venta(P_ID_PAGO,l_error,l_msgerror);
                    pkg_caja_school_sp_generar_asiento_inter_dev(P_ID_PAGO);
                end if;
            ELSE
                l_error := 1;
                l_msgerror := 'Error, la suma del importe de los items es cero(0).';
            END IF;
        END IF;
        P_ERROR := l_error;
        P_MSGERROR := l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_finalizar_devolucion_venta (P_ID_PAGO bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
