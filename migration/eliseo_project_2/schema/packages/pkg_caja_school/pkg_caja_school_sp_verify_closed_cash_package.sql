-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_verify_closed_cash (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint, P_ERROR out bigint,P_MSGERROR out text) AS $body$
DECLARE


        L_ERROR bigint :=0;
        L_MSGERROR varchar(200) :='';
        l_primero bigint := 1;
        l_cantidad bigint := 0;

        
       voucher_no_cerrados CURSOR FOR
        SELECT cm.NOMBRE , count(1) cantidad FROM (
            SELECT A.ID_MES,
                        CASE WHEN A.IMPORTE = coalesce(SUM(B.IMPORTE),0) THEN 'S' ELSE 'N' END AS VALIDA_CIERRE
                FROM (
                        SELECT 
                                A.id_mes, C.ID_CIERRE,A.ID_VOUCHER,SUM(B.IMPORTE) AS IMPORTE
                        FROM CONTA_VOUCHER A LEFT JOIN CAJA_DEPOSITO B
                        ON A.ID_VOUCHER = B.ID_VOUCHER
                        LEFT JOIN CAJA_CIERRE C
                        ON A.ID_VOUCHER = C.ID_VOUCHER
                        WHERE A.ID_ENTIDAD = P_ID_ENTIDAD
						AND A.ID_DEPTO = P_ID_DEPTO
						AND A.ID_ANHO = P_ID_ANHO
                        AND A.ID_TIPOVOUCHER = 5
                        AND A.ACTIVO = 'S'
                        AND B.ID_MEDIOPAGO = '008' 
                        GROUP BY A.id_mes,C.ID_CIERRE,A.ID_VOUCHER
                ) A LEFT JOIN CAJA_DEPOSITO_BANCO B
                ON A.ID_CIERRE = B.ID_CIERRE 
                GROUP BY A.id_mes, A.ID_CIERRE,A.ID_VOUCHER,A.IMPORTE
                ) X
                INNER JOIN CONTA_MES cm ON cm.ID_MES = X.id_MES 
                WHERE VALIDA_CIERRE = 'N'
                GROUP BY cm.NOMBRE 
;

        
BEGIN
          --goto salida_rapida;
          FOR voucher in voucher_no_cerrados
            LOOP
            
                l_cantidad := l_cantidad + voucher.cantidad;
                L_ERROR := 1;
                if l_primero = 1 then
                    L_MSGERROR := L_MSGERROR || ' Cierres de caja pendientes: ';
                end if;
                L_MSGERROR := L_MSGERROR || voucher.nombre || ': ' ||voucher.cantidad || '; ';

                l_primero := 0;
            end loop;
            RAISE NOTICE '%', L_ERROR;
            RAISE NOTICE '%', L_MSGERROR;
            RAISE NOTICE '*******************';
--           <<salida_rapida>>

          if P_ID_ENTIDAD = 7124 and P_ID_DEPTO = '4' then
                if l_cantidad < 8 then 
                 L_ERROR := 0;
                end if;
          else
                if l_cantidad < 14 then 
                 L_ERROR := 0;
                end if;

          end if;

          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_verify_closed_cash (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint, P_ERROR out bigint,P_MSGERROR out text) FROM PUBLIC;
