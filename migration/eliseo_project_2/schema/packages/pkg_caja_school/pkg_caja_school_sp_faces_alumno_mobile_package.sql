-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_faces_alumno_mobile ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CLIENTE bigint, P_ID_ANHO bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';

BEGIN
    
    /*
	  OPEN cursor FOR
	  
	  SELECT 
		id_anho, id_mes, 
		(SELECT max(nombre) FROM conta_mes x WHERE x.id_mes =a.id_mes) AS nombre_mes, 
		CASE WHEN sum(RED) > 0 THEN 'red' ELSE 
			CASE WHEN sum(YELLOW)>0 THEN 'yellow' ELSE 'green' END END  AS color
		FROM (
		SELECT smc.ID_ANHO, smc.ID_MES, ss.ID_VENTA,
		smc.FECHA-trunc(v.FECHA) AS cant_dias_deuda, 
		CASE WHEN smc.FECHA-trunc(v.FECHA) BETWEEN 0 and 3 THEN 1 ELSE 0 END AS green,
		CASE WHEN smc.FECHA-trunc(v.FECHA) BETWEEN 4 and 90 THEN 1 ELSE 0 END AS yellow,
		CASE WHEN smc.FECHA-trunc(v.FECHA) > 90 THEN 1 ELSE 0 END AS red,
		ss.IMPORTE AS importe_saldo 
		FROM SEGCLI_SALDOS ss
		INNER JOIN venta v ON v.ID_VENTA = ss.ID_VENTA 
		INNER JOIN SEGCLI_MES_CORTE smc ON ss.ID_MESCORTE = smc.ID_MESCORTE 
		WHERE 7=7
		AND smc.ID_ENTIDAD = P_ID_ENTIDAD
		AND smc.ID_DEPTO = P_ID_DEPTO
		AND v.ID_CLIENTE = P_ID_CLIENTE
		AND smc.ID_ANHO =P_ID_ANHO
		) a
		GROUP BY ID_ANHO, ID_MES ORDER BY id_mes;
        */
        
        OPEN CURSOR FOR
        SELECT 
                    ID_ANHO, orden AS ID_MES, NOMBRE AS NOMBRE_MES, 
                    CASE WHEN sum(RED) > 0 THEN 'red' ELSE 
                    CASE WHEN sum(YELLOW)>0 THEN 'yellow' ELSE 'green' END END  AS color,
                    sum(importe_saldo) AS importe, 
                    sum(dias_deuda) AS dias_deuda
                    FROM (
                    SELECT ss.ID_ARTICULO, coalesce(mm.ID_MES,0) AS orden, COALESCE(ia.NOMBRE, 'Sin Nombre') AS nombre, v.ID_CLIENTE, v.ID_VENTA, v.SERIE, v.NUMERO, v.FECHA, smc.ID_ANHO, smc.ID_MES, ss.ID_VENTA,
                    CASE WHEN ss.IMPORTE <= 0 THEN 0 ELSE (CASE WHEN date_trunc('month', smc.FECHA) = date_trunc('month', clock_timestamp()) THEN date_trunc('day', clock_timestamp()) ELSE date_trunc('day', smc.FECHA) END)-date_trunc('day', v.FECHA) END AS cant_dias_deuda, 
                    CASE WHEN CASE WHEN ss.IMPORTE <= 0 THEN 0 ELSE (CASE WHEN date_trunc('month', smc.FECHA) = date_trunc('month', clock_timestamp()) THEN date_trunc('day', clock_timestamp()) ELSE date_trunc('day', smc.FECHA) END)-date_trunc('day', v.FECHA) END BETWEEN 0 and 3 THEN 1 ELSE 0 END AS green,
                    CASE WHEN CASE WHEN ss.IMPORTE <= 0 THEN 0 ELSE (CASE WHEN date_trunc('month', smc.FECHA) = date_trunc('month', clock_timestamp()) THEN date_trunc('day', clock_timestamp()) ELSE date_trunc('day', smc.FECHA) END)-date_trunc('day', v.FECHA) END BETWEEN 4 and 90 THEN 1 ELSE 0 END AS yellow,
                    CASE WHEN CASE WHEN ss.IMPORTE <= 0 THEN 0 ELSE (CASE WHEN date_trunc('month', smc.FECHA) = date_trunc('month', clock_timestamp()) THEN date_trunc('day', clock_timestamp()) ELSE date_trunc('day', smc.FECHA) END)-date_trunc('day', v.FECHA) END > 90 THEN 1 ELSE 0 END AS red,
                    ss.IMPORTE AS importe_saldo,
                    CASE WHEN ss.IMPORTE <= 0 THEN 0 ELSE (CASE WHEN date_trunc('month', smc.FECHA) = date_trunc('month', clock_timestamp()) THEN date_trunc('day', clock_timestamp()) ELSE date_trunc('day', smc.FECHA) END) -date_trunc('day', v.FECHA) END AS dias_deuda
                    FROM SEGCLI_SALDOS_DETALLE ss
                    INNER JOIN venta v ON v.ID_VENTA = ss.ID_VENTA 
                    INNER JOIN SEGCLI_MES_CORTE smc ON ss.ID_MESCORTE = smc.ID_MESCORTE 
                    INNER JOIN jose.SCHOOL_INSTITUCION si ON si.ID_CAMPO = v.ID_ENTIDAD AND si.ID_DEPTO = v.ID_DEPTO 
                    LEFT OUTER JOIN eliseo.INVENTARIO_ARTICULO ia ON ia.ID_ARTICULO = ss.ID_ARTICULO 
                    LEFT OUTER JOIN jose.MAT_MES mm ON mm.ID_ARTICULO = ia.ID_ARTICULO 
                    WHERE 7=7
                    AND si.ID_CAMPO = P_ID_ENTIDAD
                    AND si.ID_DEPTO = P_ID_DEPTO
                    AND smc.ID_ANHO = P_ID_ANHO
                    AND smc.ID_MES = CASE WHEN P_ID_ANHO = TO_CHAR(clock_timestamp(),'yyyy') THEN TO_CHAR(clock_timestamp(),'mm') ELSE '12' end
                    AND v.ID_CLIENTE = P_ID_CLIENTE 
                    ) H     
                    GROUP BY ID_ANHO, orden, nombre, ID_ARTICULO 
                    ORDER BY ID_ANHO, orden, ID_ARTICULO
;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_faces_alumno_mobile ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CLIENTE bigint, P_ID_ANHO bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
