-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_inter_dep (P_ID_DEPOSITO bigint) AS $body$
DECLARE


        l_contar bigint;
        L_GENERAR_INTER varchar(1);
        L_ID_DEPTO varchar(20);

        
BEGIN
        
        L_GENERAR_INTER := 'S';

        SELECT ID_DEPTO, case when id_entidad in (
        7124,
        7722,
        7322,
        7422,
        7522,
        7022,
        72122,
        7922
        ) then 'N' else 'S' end 
        INTO STRICT L_ID_DEPTO, L_GENERAR_INTER
        FROM CAJA_DEPOSITO
        WHERE ID_DEPOSITO = P_ID_DEPOSITO;

        
        if L_GENERAR_INTER = 'S' then 
        
            select count(1) into STRICT l_contar from (
                SELECT distinct depto from eliseo.conta_asiento 
                where id_tipoorigen in (7)
                and id_origen = P_ID_DEPOSITO 
            ) alias2;

            if l_contar >1 then 
                insert into conta_asiento
                SELECT id_asiento, id_tipoorigen, id_origen, fondo, L_ID_DEPTO,
                '2136080', 
                depto
                , '0A', 
                importe as importe, 'Asiento por Interdepartamento', memo, voucher, parent_id, ref_id, 'S', importe_me, 'N'
                from conta_asiento a
                
                where id_tipoorigen = 7
                and id_origen = P_ID_DEPOSITO
                and importe < 0
                
union all
 
                SELECT id_asiento, id_tipoorigen, id_origen, fondo, depto,
                '1136080', 
                L_ID_DEPTO
                , '0A', 
                importe*-1, 'Asiento por Interdepartamento', memo, voucher, parent_id, ref_id, 'S', importe_me, 'N'
                from conta_asiento a
                
                where id_tipoorigen = 7
                and id_origen = P_ID_DEPOSITO
                and importe < 0
                order by id_origen, importe
;
            end if;
        end if;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_generar_asiento_inter_dep (P_ID_DEPOSITO bigint) FROM PUBLIC;
