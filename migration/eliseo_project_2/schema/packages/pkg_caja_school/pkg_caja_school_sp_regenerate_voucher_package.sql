-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_caja_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_caja_school_sp_regenerate_voucher (P_ID_VOUCHER bigint, P_ERROR out bigint,P_MSGERROR out text) AS $body$
DECLARE


        L_ERROR bigint :=0;
        L_MSGERROR varchar(200) :='';
        l_contar bigint :=0;
        L_ID_DINAMICA_CLI_SALDO_INI bigint;
        L_ID_DEPTO varchar(20);
       depositos CURSOR FOR
        SELECT id_entidad, id_deposito, id_dinamica, id_ctabancaria,
        case when id_mediopago = '008' then importe else 0 end as importe, 
        case when id_mediopago = '006' then importe else 0 end as importe_tarjeta,    
        case when id_mediopago = '001' then importe else 0 end as importe_transferencia       
        from eliseo.caja_deposito
        where id_VOUCHER = P_ID_VOUCHER
;

        
BEGIN
          --goto salida_rapida;
          FOR deposito in depositos
            LOOP
                select max(id_dinamica), MAX(ID_DEPTO) into STRICT L_ID_DINAMICA_CLI_SALDO_INI, L_ID_DEPTO from conta_dinamica
                where id_entidad = deposito.id_entidad
                and id_tipotransaccion = 169
                and id_depto in (SELECT id_depto from caja_deposito where id_deposito = deposito.id_deposito);

                -- Limpiamos los depositos
                delete from eliseo.conta_asiento 
                where id_tipoorigen = 7
                and id_origen = deposito.id_deposito;

                RAISE NOTICE '*******************';
                RAISE NOTICE '%', deposito.id_deposito;
                RAISE NOTICE '%', deposito.id_dinamica;
                RAISE NOTICE '%', L_ID_DINAMICA_CLI_SALDO_INI;
                RAISE NOTICE '%', deposito.id_ctabancaria;
                RAISE NOTICE '%', deposito.importe;
                RAISE NOTICE '%', deposito.importe_tarjeta;
                RAISE NOTICE '%', deposito.importe_transferencia;
                RAISE NOTICE '%', L_ERROR;
                RAISE NOTICE '%', L_MSGERROR;
                RAISE NOTICE '*******************';
                pkg_caja_school_sp_generar_asiento_deposito(
                            deposito.id_deposito, deposito.id_dinamica,L_ID_DINAMICA_CLI_SALDO_INI,
                            deposito.id_ctabancaria, deposito.importe, deposito.importe_tarjeta, 
                            deposito.importe_transferencia,'', L_ERROR, L_MSGERROR, null);

                
                if L_ERROR != 0 then 
--                     goto salida_rapida;
                end if;

                if deposito.id_entidad <> 7124 then 
                 pkg_caja_school_sp_generar_asiento_inter_dep(deposito.id_deposito);
                end if;
               
                
                pkg_caja_school_sp_generar_asiento_inter_dep(deposito.id_deposito);

            end loop;

--           <<salida_rapida>>
          P_ERROR:=l_error;
          P_MSGERROR:=l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_caja_school_sp_regenerate_voucher (P_ID_VOUCHER bigint, P_ERROR out bigint,P_MSGERROR out text) FROM PUBLIC;
