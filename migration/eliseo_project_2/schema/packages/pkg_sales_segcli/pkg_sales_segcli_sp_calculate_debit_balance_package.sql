-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_segcli,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_segcli_sp_calculate_debit_balance ( P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint, P_ID_MES bigint) AS $body$
BEGIN

    /*
    -- LIMPIAMOS LOS SALDOS
    delete FROM SEGCLI_SALDOS
    WHERE ID_MESCORTE IN (
    SELECT ID_MESCORTE FROM SEGCLI_MES_CORTE 
    WHERE ID_ENTIDAD = P_ID_ENTIDAD
    AND ID_DEPTO = P_ID_DEPTO
    AND ID_ANHO = P_ID_ANHO
    AND ID_MES = P_ID_MES
    );
        
    INSERT INTO SEGCLI_SALDOS
    SELECT smc.ID_MESCORTE, vsm.ID_VENTA, sum(vsm.TOTAL) 
    FROM SEGCLI_MES_CORTE smc 
    INNER JOIN VW_SALES_MOV vsm ON vsm.ID_ENTIDAD = smc.ID_ENTIDAD 
                                AND vsm.ID_DEPTO = smc.ID_DEPTO 
                                AND vsm.ID_ANHO = smc.ID_ANHO 
    WHERE 7=7
    AND smc.ID_ENTIDAD = P_ID_ENTIDAD
    AND smc.ID_DEPTO = P_ID_DEPTO
    AND smc.ID_ANHO = P_ID_ANHO
    AND smc.ID_MES = P_ID_MES
    AND trunc(vsm.FECHA) <= smc.FECHA 
    GROUP BY smc.ID_MESCORTE, vsm.ID_VENTA
    HAVING sum(vsm.TOTAL) > 0.01
    ORDER BY smc.ID_MESCORTE, vsm.ID_VENTA
    ;
    
    */
    -- LIMPIAMOS LOS SALDOS DETALLE
    delete FROM SEGCLI_SALDOS_DETALLE
    WHERE ID_MESCORTE IN (
    SELECT ID_MESCORTE FROM SEGCLI_MES_CORTE 
    WHERE ID_ENTIDAD = P_ID_ENTIDAD
    AND ID_DEPTO = P_ID_DEPTO
    AND ID_ANHO = P_ID_ANHO
    AND ID_MES = P_ID_MES
    );

    INSERT INTO SEGCLI_SALDOS_DETALLE
    SELECT smc.ID_MESCORTE, vsm.ID_VENTA, COALESCE(vsm.ID_ARTICULO,0), sum(vsm.IMPORTE) 
    FROM SEGCLI_MES_CORTE smc 
    INNER JOIN VW_SALES_DETAIL_MOV_COL vsm ON vsm.ID_ENTIDAD = smc.ID_ENTIDAD 
                                AND vsm.ID_DEPTO = smc.ID_DEPTO 
                                AND vsm.ID_ANHO = smc.ID_ANHO 
    WHERE 7=7
    AND smc.ID_ENTIDAD = P_ID_ENTIDAD
    AND smc.ID_DEPTO = P_ID_DEPTO
    AND smc.ID_ANHO = P_ID_ANHO
    AND smc.ID_MES = P_ID_MES
    AND date_trunc('day', vsm.FECHA) <= smc.FECHA  
    GROUP BY smc.ID_MESCORTE, vsm.ID_VENTA, vsm.ID_ARTICULO
    --HAVING sum(vsm.IMPORTE) > 0.01
    ORDER BY smc.ID_MESCORTE, vsm.ID_VENTA, vsm.ID_ARTICULO
;


  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_segcli_sp_calculate_debit_balance ( P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint, P_ID_MES bigint) FROM PUBLIC;
