-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_sehs,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sehs_sp_iupd_despacho_detalle ( P_ID_VDESPACHO bigint,P_ID_VDETALLE bigint,P_ID_ARTICULO bigint,P_ID_DINAMICA bigint, P_CANTIDAD bigint,P_DETALLE text, P_ID_DDETALLE INOUT bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


    	/*
        l_igv numeric(10,2);
        l_tc numeric(10,3);
        l_id_moneda_tc numeric;
        l_automatico varchar(2);
        l_id_voucher numeric;
        l_contar numeric;
        l_id_tipotransaccion numeric :=5;--ventas de almacen por defecto regustra y configurar solo un asiento por lamacen
        L_DOCUMENTO numeric :=0;
       
        l_id_cliente numeric;
        l_totaldescuento numeric;
        
        L_ID_VENTA numeric;
        L_ERROR numeric  := 0;
        L_MSGERROR varchar(100) :='';
       
        CURSOR ARTICULOS IS
        SELECT ID_VDETALLE,CANTIDAD, ID_ARTICULO 
        FROM VENTA_DETALLE
        WHERE ID_VENTA = P_ID_VENTA;
       
       	L_ID_VDETALLE numeric;
        L_CANTIDAD numeric(10,2);
        L_ID_ARTICULO numeric;
        L_ID_ALMACEN numeric;
        */
    	L_ID_ALMACEN bigint;
    	L_ID_VENTA bigint;
    	L_ID_ANHO bigint;

    	L_PRECIO decimal(10,2);
        L_IMPORTE decimal(10,2);
       	L_CANTIDAD decimal(10,2);
       	L_PRECIO_ALM decimal(10,2);

        L_STOCK decimal(10,2);
        L_STOCK_T decimal(10,2);
        L_COSTO_ST decimal(10,2);

    	L_ID_DDETALLE bigint;
        L_ERROR bigint  := 0;
        L_MSGERROR varchar(30) :='';

        
BEGIN
	       
           SELECT ID_ALMACEN,ID_VENTA, CANTIDAD, PRECIO, IMPORTE, PRECIO_ALM INTO STRICT L_ID_ALMACEN, L_ID_VENTA,L_CANTIDAD, L_PRECIO,L_IMPORTE, L_PRECIO_ALM  FROM VENTA_DETALLE 
	       WHERE ID_VDETALLE =P_ID_VDETALLE;
	       SELECT ID_ANHO INTO STRICT L_ID_ANHO FROM VENTA WHERE ID_VENTA = L_ID_VENTA;
	
	       /* COMENTADO POR PEDRO
	       pkg_inventories_sp_articulo_stock(L_ID_ALMACEN,P_ID_ARTICULO,L_ID_ANHO,L_STOCK,L_COSTO_ST,L_MSGERROR);
           pkg_inventories_sp_articulo_stock_temp(L_ID_ALMACEN,P_ID_ARTICULO,L_ID_ANHO,L_STOCK_T,L_MSGERROR);
            
	       -- Valida que hay en stock el artículo.
	       IF (L_STOCK-L_STOCK_T) < P_CANTIDAD THEN
      		L_ERROR := 1;
        	--L_MSGERROR := 'Alto! Stock: '||(L_STOCK-L_STOCK_T)||' en el almacén, no puede hacer el despacho.';
--         	GOTO salida_rapida;
           END IF; */
         
	       L_IMPORTE := (L_IMPORTE/L_CANTIDAD)*P_CANTIDAD;
	
	       IF P_ID_DDETALLE = 0 THEN
	        	INSERT INTO VENTA_DESPACHO_DETALLE(ID_VDESPACHO,ID_ARTICULO,ID_VDETALLE,
	        	ID_DINAMICA,CANTIDAD,DETALLE, PRECIO, IMPORTE, PRECIO_ALM)
	        	VALUES (P_ID_VDESPACHO,P_ID_ARTICULO,P_ID_VDETALLE,
	        	P_ID_DINAMICA,P_CANTIDAD,P_DETALLE,L_PRECIO, L_IMPORTE, L_PRECIO_ALM)
	        	RETURNING ID_DDETALLE INTO L_ID_DDETALLE;
	       ELSE
	        	UPDATE VENTA_DESPACHO_DETALLE
	        	SET
	        	--ID_VDESPACHO =P_ID_VDESPACHO,
	        	--ID_ARTICULO =P_ID_ARTICULO,
	        	ID_VDETALLE =P_ID_VDETALLE,
	        	--ID_DINAMICA = P_ID_DINAMICA,
	        	CANTIDAD = P_CANTIDAD,
	        	DETALLE= P_DETALLE,PRECIO=L_PRECIO,IMPORTE=L_IMPORTE, PRECIO_ALM = L_PRECIO_ALM
	        	WHERE ID_DDETALLE = P_ID_DDETALLE;
	        	L_ID_DDETALLE := P_ID_DDETALLE;
	       END IF;
	
--         <<salida_rapida>>
        
        P_ID_DDETALLE := L_ID_DDETALLE;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sehs_sp_iupd_despacho_detalle ( P_ID_VDESPACHO bigint,P_ID_VDETALLE bigint,P_ID_ARTICULO bigint,P_ID_DINAMICA bigint, P_CANTIDAD bigint,P_DETALLE text, P_ID_DDETALLE INOUT bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
