-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_actualizar_cantidad_detalle (P_ID_VENTA bigint,P_ID_VDETALLE bigint,P_CANTIDAD bigint) AS $body$
DECLARE

        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda bigint;
        l_descuento decimal(10,2):=0;
        l_totaldescuento decimal(10,2):=0;
        l_precio decimal(10,2);
        l_importe decimal(10,2);
        l_base decimal(10,2);
        l_igv_item decimal(10,2);
        l_precio_base decimal(10,2);
        l_importe_me decimal(10,2);
        l_base_me decimal(10,2);
        l_igv_item_me decimal(10,2);
        l_precio_base_me decimal(10,2);
        l_descuento_me decimal(10,2):=0;

        l_gravado varchar(5);
        l_id_tipoigv varchar(5);
        l_contar bigint;
        l_igv_me decimal(10,2);

BEGIN
        --obtiene igv,TC
        select ID_IGV,TIPOCAMBIO,ID_MONEDA into STRICT l_igv,l_tc,l_id_moneda 
        from venta 
        where id_venta=P_ID_VENTA;

        l_igv:=l_igv/100;

        select PRECIO,ID_TIPOIGV into STRICT l_precio,l_id_tipoigv
        from VENTA_DETALLE where id_venta=P_ID_VENTA
        AND ID_VDETALLE=P_ID_VDETALLE;

        select count(*) into STRICT l_contar from TIPO_IGV where ID_TIPOIGV=l_id_tipoigv;
        if l_contar>0 then
            select GRAVADO into STRICT l_gravado from TIPO_IGV where ID_TIPOIGV=l_id_tipoigv;
        end if;

        l_totaldescuento:=l_descuento*P_CANTIDAD;
        l_precio:=l_precio;
        l_precio_base:=l_precio;
        l_importe:=(l_precio*P_CANTIDAD)-(l_totaldescuento);
        l_base:=l_importe;
        l_igv_item:=0;
        if l_gravado in ('G') then
            l_precio_base:=l_precio/(1+l_igv);
            l_base:=l_importe/(1+l_igv);
            l_igv_item:=l_importe-l_base;
        end if;
        l_descuento:=l_totaldescuento;
        l_precio_base_me:=0;
        l_base_me:=0;
        l_igv_me:=0;
        l_descuento_me:=0;
        l_importe_me:=0;
          
        if l_id_moneda=9 then
            l_totaldescuento:=l_descuento*P_CANTIDAD;
            l_totaldescuento:=l_totaldescuento/l_tc;
            l_importe_me:=l_importe/l_tc;
            l_base_me:=l_base/l_tc;
            l_igv_me:=l_igv_item/l_tc;
            l_descuento_me:=l_totaldescuento;
        end if;
           
        UPDATE VENTA_DETALLE SET
                                CANTIDAD=P_CANTIDAD,
                                BASE=l_base, 
                                IGV=l_igv_item, 
                                DESCUENTO=l_descuento, 
                                IMPORTE=l_importe, 
                                BASE_ME=l_base_me, 
                                IGV_ME=l_igv_me, 
                                DESCUENTO_ME=l_descuento_me, 
                                IMPORTE_ME=l_importe_me
        where id_venta=P_ID_VENTA
        AND ID_VDETALLE=P_ID_VDETALLE;
            
        CALL pkg_sales_sp_actualizar_total_venta(P_ID_VENTA);

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_actualizar_cantidad_detalle (P_ID_VENTA bigint,P_ID_VDETALLE bigint,P_CANTIDAD bigint) FROM PUBLIC;
