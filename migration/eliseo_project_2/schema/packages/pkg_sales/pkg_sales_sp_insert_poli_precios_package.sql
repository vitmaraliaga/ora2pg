-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_insert_poli_precios (P_ID_POLITICA bigint,P_ID_ANHO bigint,P_ID_PARENT bigint, P_POR_VENTA bigint, P_POR_DESCUENTO bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        L_ID_ALMACEN bigint;
        L_ID_ARTICULO bigint;
        L_COSTO decimal(10,2);
        L_DESCUENTO decimal(10,2);
        L_PRECIO decimal(10,2);
        L_DATO smallint;
        L_IGV decimal(10,2);
        LIGVB decimal(10,2);

        ARTICULOS CURSOR FOR
        SELECT 
        B.ID_ARTICULO,--B.COSTO,B.ID_TIPOIGV,
        CASE WHEN B.ID_TIPOIGV=10 THEN ROUND(ROUND((round((B.COSTO)::numeric,2)*L_IGV+round((B.COSTO)::numeric,2))+((round((B.COSTO)::numeric,2)*L_IGV+round((B.COSTO)::numeric,2))*P_POR_VENTA),2)/LIGVB,2)  ELSE ROUND(B.COSTO+(B.COSTO*P_POR_VENTA),2) END  BI,coalesce(P_POR_DESCUENTO,0),
        CASE WHEN B.ID_TIPOIGV=10 THEN ROUND((round((B.COSTO)::numeric,2)*L_IGV+round((B.COSTO)::numeric,2))+((round((B.COSTO)::numeric,2)*L_IGV+round((B.COSTO)::numeric,2))*P_POR_VENTA),2)  ELSE ROUND(B.COSTO+(B.COSTO*P_POR_VENTA),2) END  PRECIO
        FROM INVENTARIO_ARTICULO A, INVENTARIO_ALMACEN_ARTICULO B
        WHERE A.ID_ARTICULO = B.ID_ARTICULO
        AND B.ID_ALMACEN = L_ID_ALMACEN
        AND B.ID_ANHO = P_ID_ANHO
        AND A.ID_PARENT = P_ID_PARENT
        AND B.COSTO > 0
        AND B.ESTADO = '1'
        AND B.ID_ARTICULO NOT IN (SELECT ID_ARTICULO FROM VENTA_POLITICA_ARTICULO WHERE ID_POLITICA = P_ID_POLITICA AND ID_ALMACEN = L_ID_ALMACEN AND ID_ANHO = P_ID_ANHO);

        
BEGIN
            IF P_POR_VENTA < 0 OR P_POR_VENTA > 5 THEN
                P_ERROR:=1;
                P_MSGERROR:='PORCENTAJE DE VENTA FUERA DEL INTERVALO';
            ELSE
                IF P_POR_DESCUENTO < 0 OR P_POR_DESCUENTO > 1 THEN
                    P_ERROR:=1;
                    P_MSGERROR:='PORCENTAJE DE DESCUENTO FUERA DEL INTERVALO';
                ELSE
                    SELECT ID_ALMACEN INTO STRICT L_ID_ALMACEN
                    FROM VENTA_POLITICA
                    WHERE ID_POLITICA = P_ID_POLITICA;

                    SELECT 
                            round((ID_IGV/100)::numeric,2) IGV,1+round((ID_IGV/100)::numeric,2) IGVB INTO STRICT L_IGV,LIGVB
                    FROM CONTA_IGV
                    WHERE TO_DATE(clock_timestamp()) BETWEEN FECHA_INI AND coalesce(FECHA_FIN,TO_DATE(clock_timestamp())) 
                    AND ES_VENTA = 'S';

                    OPEN ARTICULOS;
                        FETCH ARTICULOS INTO L_ID_ARTICULO,L_COSTO,L_DESCUENTO,L_PRECIO;
                        WHILE ARTICULOS%FOUND LOOP
                            L_DATO :=1;
                            INSERT INTO VENTA_POLITICA_ARTICULO(ID_POLITICA,ID_ALMACEN,ID_ARTICULO,ID_ANHO,P_VENTA,COSTO,DESCUENTO,PRECIO,ESTADO)
                            VALUES (P_ID_POLITICA,L_ID_ALMACEN,L_ID_ARTICULO,P_ID_ANHO,P_POR_VENTA,L_COSTO,L_DESCUENTO,L_PRECIO,'1');
                            FETCH ARTICULOS INTO L_ID_ARTICULO,L_COSTO,L_DESCUENTO,L_PRECIO;
                        END LOOP;
                    CLOSE ARTICULOS;

                    IF L_DATO = 1 THEN 
                        P_ERROR:=0;
                        P_MSGERROR:= 'OK';
                    ELSE
                        P_ERROR:=1;
                        P_MSGERROR:='NO SE HAN REGISTRADO PRECIOS';
                    END IF;
                END IF;
            END IF;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_insert_poli_precios (P_ID_POLITICA bigint,P_ID_ANHO bigint,P_ID_PARENT bigint, P_POR_VENTA bigint, P_POR_DESCUENTO bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
