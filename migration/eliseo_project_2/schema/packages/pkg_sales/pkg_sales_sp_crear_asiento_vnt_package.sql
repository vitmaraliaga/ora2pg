-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_asiento_vnt (P_ID_VENTA bigint,P_ID_DINAMICA bigint,P_ID_CUENTAAASI text,P_ID_RESTRICCION text,P_ID_CTACTE text,P_ID_FONDO bigint,P_ID_DEPTO text,P_IMPORTE bigint,P_IMPORTE_ME bigint,P_DESCRIPCION text, P_EDITABLE text, P_DC text,P_AGRUPA text,P_MODO text,P_ERROR OUT bigint, P_MSN OUT text) AS $body$
DECLARE


        L_ID_ASIENTO bigint;

        L_ID_RESTRICCION varchar(50);
        L_ID_CUENTAAASI varchar(10);
        L_ID_CTACTE varchar(10);
        L_DC varchar(1);
        L_DESTINO varchar(10);
        L_ORIGEN varchar(10);
        L_ID_INDICADOR varchar(35);
        L_UNICO varchar(1);
        L_UNICOCTACTE varchar(1);
        L_PORCENTAJE decimal(10,2);
        L_DESCRIPCION varchar(255);
        L_ID_CASIENTO varchar(50);
        L_ID_FONDO varchar(50);
        L_BASE decimal(10,2);
        L_IGV decimal(10,2);
        L_IMPORTE decimal(10,2);
        L_IMPORTE_ME decimal(10,2);
        L_DEPTO varchar(10);
        L_CONT bigint;
        L_AGRUPA varchar(1) :='N';
        L_SERIE varchar(4);
        L_NUMERO varchar(8);
        L_CORRELATIVO varchar(20);
        l_EDITABLE varchar(1) :='S';
        l_ctas varchar(200);
        l_ctates varchar(200);
        l_actas tablastring;
        l_actates tablastring;
        l_buscar bigint;
        l_unicoctated varchar(1);
        P_ID_ASIENTO bigint;
        L_ERROR bigint :=0;
        L_MSN varchar(200);
        L_DC_VNT varchar(1) := 'D';
        L_ID_TIPOORIGEN bigint :=1;
        L_ID_VDETALLE bigint;
        L_DETALLE varchar(100);
        L_ID_TIPOIGV varchar(2) := '30'; --VENTA INAFECTA
        L_ID_VASIENTO bigint;
        L_ID_CLIENTE bigint;

        casi CURSOR FOR
        SELECT 
                a.ID_ASIENTO,a.ID_RESTRICCION,a.ID_CUENTAAASI,a.DC,a.ID_INDICADOR,a.UNICO,a.UNICO_CTACTE,round((a.PORCENTAJE*100)::numeric,2),a.NOMBRE,coalesce(a.AGRUPA,'N'),a.ID_FONDO
        FROM CONTA_DINAMICA_ASIENTO a,CONTA_DINAMICA d
        WHERE a.ID_DINAMICA=d.ID_DINAMICA 
        AND a.ID_DINAMICA =P_ID_DINAMICA 
        ORDER BY a.NRO_ASIENTO,a.DC desc;

        
BEGIN
            --DELETE VENTA_ASIENTO WHERE ID_VENTA = P_ID_VENTA;
            --DELETE VENTA_DETALLE WHERE ID_VENTA = P_ID_VENTA;
            SELECT ID_CLIENTE, GLOSA INTO STRICT L_ID_CLIENTE,L_DETALLE FROM VENTA
            WHERE ID_VENTA = P_ID_VENTA;

            SELECT COUNT(1) INTO STRICT L_CONT FROM VENTA_DETALLE WHERE ID_VENTA = P_ID_VENTA;
            IF L_CONT = 0 THEN
                INSERT INTO  VENTA_DETALLE(ID_VENTA,ID_TIPOIGV,DETALLE,DC,CANTIDAD,PRECIO,PRECIO_BASE,BASE,IGV,DESCUENTO,IMPORTE,ID_TIPOORIGEN)
                VALUES (P_ID_VENTA,L_ID_TIPOIGV,L_DETALLE,L_DC_VNT,1,P_IMPORTE,P_IMPORTE,P_IMPORTE,0,0,P_IMPORTE,L_ID_TIPOORIGEN) RETURNING ID_VDETALLE INTO L_ID_VDETALLE;
            ELSE
                SELECT ID_VDETALLE INTO STRICT L_ID_VDETALLE FROM VENTA_DETALLE WHERE ID_VENTA = P_ID_VENTA;
            END IF;

            L_ERROR :=0;
            IF P_MODO = '1' THEN
                OPEN casi;
                FETCH casi INTO L_ID_ASIENTO,L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC,L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA,L_ID_FONDO;
                    WHILE casi%FOUND LOOP
                        L_DEPTO:=null;
                        L_ID_CTACTE:=null;

                        if L_UNICO='U' then
                            select count(1) into STRICT L_CONT from CONTA_DINAMICA_DEPTO where id_asiento=L_ID_ASIENTO;
                            if L_CONT>0 then
                                select ID_DEPTO into STRICT L_DEPTO from CONTA_DINAMICA_DEPTO where id_asiento=L_ID_ASIENTO;
                            end if;
                        elsif (L_UNICO='X') then
                            L_DEPTO := '';
                        ELSIF L_UNICO = 'E' THEN
                            SELECT ID_DEPTO INTO STRICT L_DEPTO FROM (
                                SELECT A.NOM_ESCUELA,B.ID_DEPTO
                                FROM DAVID.VW_ALUMNO_PLAN_PROGRAMA A JOIN ORG_SEDE_AREA B ON A.ID_SEDEAREA = B.ID_SEDEAREA WHERE A.ID_PERSONA = L_ID_CLIENTE AND A.ESTADO = 1
                                ORDER BY ID_NIVEL_ENSENANZA 
                            ) alias0 LIMIT 1;
                        end if;

                        if L_UNICOCTACTE='U' then
                            SELECT  count(1) into STRICT L_CONT FROM CONTA_DINAMICA_CTA_CTE WHERE id_asiento = L_ID_ASIENTO;
                            if L_CONT>0 then
                                SELECT ID_CTACTE into STRICT L_ID_CTACTE FROM CONTA_DINAMICA_CTA_CTE WHERE id_asiento = L_ID_ASIENTO;
                            end if;
                        elsif (l_unicoctated='M') then
                            SELECT position('|' in l_ctates) into STRICT l_buscar;
                            if l_buscar>0 then
                                select FC_SPLIT(l_ctas,'|') into STRICT l_actas;
                                select FC_SPLIT(l_ctates,'|') into STRICT l_actates;
                                select FC_OBTENER_DPTOCTCTE(l_actas,l_actates ,L_ID_CUENTAAASI) into STRICT L_ID_CTACTE;
                            else
                                L_ID_CTACTE:=l_ctates;
                            end if;
                        end if;
                        IF L_DC='C' THEN
                            L_IMPORTE:=P_IMPORTE*(-1);
                            L_IMPORTE_ME:=P_IMPORTE_ME*(-1);
                        ELSE
                            L_IMPORTE := P_IMPORTE;
                            L_IMPORTE_ME := P_IMPORTE_ME;
                        END IF;

                        IF P_IMPORTE<>0 THEN
                            P_ERROR :=0;
                            INSERT INTO VENTA_ASIENTO(ID_VENTA,ID_CUENTAAASI,ID_RESTRICCION,ID_CTACTE,ID_FONDO,ID_DEPTO,IMPORTE,IMPORTE_ME,DESCRIPCION,EDITABLE,DC,AGRUPA,ID_VDETALLE)
                            VALUES (P_ID_VENTA,L_ID_CUENTAAASI,L_ID_RESTRICCION,L_ID_CTACTE,L_ID_FONDO,L_DEPTO,L_IMPORTE,L_IMPORTE_ME,L_DESCRIPCION,l_EDITABLE,L_DC,L_AGRUPA,L_ID_VDETALLE);
                        END IF;

                    FETCH casi INTO L_ID_ASIENTO,L_ID_RESTRICCION,L_ID_CUENTAAASI,L_DC,L_ID_INDICADOR,L_UNICO,L_UNICOCTACTE,L_PORCENTAJE,L_DESCRIPCION,L_AGRUPA,L_ID_FONDO;

                END LOOP;
                CLOSE casi;
                SELECT COUNT(1) INTO STRICT L_CONT FROM VENTA_ASIENTO
                WHERE ID_VENTA = P_ID_VENTA;

                IF L_CONT = 0 THEN
                    L_ERROR :=  1;
                    L_MSN := 'No se Regsitro los Asiento de la Dinamica-'||P_ID_VENTA||'-'||P_ID_DINAMICA||'-'||P_MODO;
                END IF;

            ELSE
                INSERT INTO VENTA_ASIENTO(ID_VENTA,ID_CUENTAAASI,ID_RESTRICCION,ID_CTACTE,ID_FONDO,ID_DEPTO,IMPORTE,IMPORTE_ME,DESCRIPCION,EDITABLE,DC,AGRUPA,ID_VDETALLE)
                VALUES (P_ID_VENTA,P_ID_CUENTAAASI,P_ID_RESTRICCION,P_ID_CTACTE,P_ID_FONDO,P_ID_DEPTO,P_IMPORTE,P_IMPORTE_ME,P_DESCRIPCION,P_EDITABLE,P_DC,P_AGRUPA,L_ID_VDETALLE);-- RETURNING ID_VASIENTO INTO L_ID_VASIENTO;
            END IF;

            P_ERROR := L_ERROR;
            P_MSN := L_MSN;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_asiento_vnt (P_ID_VENTA bigint,P_ID_DINAMICA bigint,P_ID_CUENTAAASI text,P_ID_RESTRICCION text,P_ID_CTACTE text,P_ID_FONDO bigint,P_ID_DEPTO text,P_IMPORTE bigint,P_IMPORTE_ME bigint,P_DESCRIPCION text, P_EDITABLE text, P_DC text,P_AGRUPA text,P_MODO text,P_ERROR OUT bigint, P_MSN OUT text) FROM PUBLIC;
