-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_transferencia (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_EMPLEADO bigint,P_ID_CLIENTE bigint,P_ID_TIPOTRANSACCION bigint,P_ID_DINAMICA bigint,P_ID_MONEDA bigint, P_GLOSA text,P_ID_TIPOVENTA bigint,P_DC text,P_IMPORTE bigint,P_ID_TRANSFERENCIA OUT bigint,P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

        --l_cont numeric;	
        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda bigint;
        l_id_moneda_tc bigint;
        --l_contar numeric;
        L_DOCUMENTO bigint :=0;
        l_id_empleado bigint;

        L_ID_TIPOTRANSACCION bigint;
        L_ID_DINAMICA bigint;

        L_ID_TRANSFERENCIA bigint :=0;
        L_ERROR bigint :=0;
        L_MSGERROR varchar(100) :='';
        L_ES_ANTICIPO varchar(1)  := 'N';

        
BEGIN
            IF P_ID_TIPOVENTA = 6 THEN
                L_ERROR :=1;
                L_MSGERROR := 'Alto! Transferencias SOLO para operaciones Diversas: 6';
--                 goto salida_rapida;
            END IF;
            L_ERROR :=0;
            DELETE FROM VENTA_TRANSFERENCIA_DETALLE WHERE ID_TRANSFERENCIA IN (SELECT ID_TRANSFERENCIA FROM VENTA_TRANSFERENCIA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
            DELETE FROM VENTA_TRANSFERENCIA_ASIENTO WHERE ID_TRANSFERENCIA IN (SELECT ID_TRANSFERENCIA FROM VENTA_TRANSFERENCIA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
            DELETE FROM VENTA_FILE WHERE ID_TRANSFERENCIA IN (SELECT ID_TRANSFERENCIA FROM VENTA_TRANSFERENCIA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
            DELETE FROM VENTA_TRANSFERENCIA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0;

            --SELECT COALESCE(MAX(ID_TRANSFERENCIA),0)+1 INTO l_cont FROM VENTA_TRANSFERENCIA;
            
            IF coalesce(P_ID_TIPOTRANSACCION::text, '') = '' OR P_ID_TIPOTRANSACCION = 0 THEN
                L_ID_TIPOTRANSACCION  := NULL;
            ELSE
                L_ID_TIPOTRANSACCION :=  P_ID_TIPOTRANSACCION;
            END IF;
            IF coalesce(P_ID_DINAMICA::text, '') = '' OR P_ID_DINAMICA = 0 THEN
                L_ID_DINAMICA  := NULL;
            ELSE
                L_ID_DINAMICA :=  P_ID_DINAMICA;
            END IF;

            l_id_moneda:=7; --SOLES
            l_id_moneda_tc:=9;

            --obtiene tipo de cambio del dia
            select FC_TIPOCAMBIO(l_id_moneda_tc,CURRENT_DATE,'D' ) into STRICT l_tc;

            if coalesce(l_tc::text, '') = '' then
                l_tc:=0;
            end if;

            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,'99',P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                L_ERROR :=1;
                L_MSGERROR := 'Alto! El usuario no tiene asignado un punto de impresi√≥n para el tipo de documento: 99';
--                 goto salida_rapida;
            END IF;

            IF P_ID_EMPLEADO = '' OR P_ID_EMPLEADO = 0 THEN
                l_id_empleado := NULL;
            ELSE
                l_id_empleado := P_ID_EMPLEADO;
            END IF;

            INSERT INTO VENTA_TRANSFERENCIA(ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_PERSONA,ID_EMPLEADO,ID_CLIENTE,ID_TIPOTRANSACCION,ID_DINAMICA,ID_MONEDA,TIPOCAMBIO,SERIE,NUMERO,FECHA,GLOSA,ESTADO,ES_ANTICIPO,ID_TIPOVENTA)
            VALUES (P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,P_ID_PERSONA,l_id_empleado,P_ID_CLIENTE,L_ID_TIPOTRANSACCION,L_ID_DINAMICA,l_id_moneda,l_tc,'-','-',clock_timestamp(),P_GLOSA,0,L_ES_ANTICIPO,coalesce(P_ID_TIPOVENTA,1))
                    RETURNING ID_TRANSFERENCIA INTO L_ID_TRANSFERENCIA;

--         <<salida_rapida>>
        
        P_ID_TRANSFERENCIA := L_ID_TRANSFERENCIA;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_transferencia (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_PERSONA bigint,P_ID_EMPLEADO bigint,P_ID_CLIENTE bigint,P_ID_TIPOTRANSACCION bigint,P_ID_DINAMICA bigint,P_ID_MONEDA bigint, P_GLOSA text,P_ID_TIPOVENTA bigint,P_DC text,P_IMPORTE bigint,P_ID_TRANSFERENCIA OUT bigint,P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
