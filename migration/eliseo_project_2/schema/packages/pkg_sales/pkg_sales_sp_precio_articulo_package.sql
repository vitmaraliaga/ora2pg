-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_precio_articulo (P_ID_CLIENTE bigint,P_ID_ALMACEN bigint, P_ID_ARTICULO bigint, P_ID_ANHO bigint, P_ID_TIPOIGV OUT text,P_PRECIO_ALM OUT bigint,P_PRECIO OUT bigint,P_DESCUENTO OUT bigint) AS $body$
DECLARE

        L_ID_POLITICA bigint;
        L_CONTA bigint :=0;

BEGIN
            P_ID_TIPOIGV := 0;
            P_PRECIO_ALM := 0;
            P_PRECIO := 0;
            P_DESCUENTO := 0;
            IF coalesce(P_ID_CLIENTE::text, '') = '' OR P_ID_CLIENTE = 0 THEN
                SELECT
                        B.ID_TIPOIGV,B.COSTO,C.PRECIO,ROUND(C.PRECIO*(coalesce(C.DESCUENTO,0)),2) INTO STRICT P_ID_TIPOIGV,P_PRECIO_ALM,P_PRECIO,P_DESCUENTO
                FROM INVENTARIO_ARTICULO A ,INVENTARIO_ALMACEN_ARTICULO B, VENTA_PRECIO C
                WHERE A.ID_ARTICULO = B.ID_ARTICULO 
                AND B.ID_ALMACEN = C.ID_ALMACEN
                AND B.ID_ARTICULO = C.ID_ARTICULO
                AND B.ID_ANHO = C.ID_ANHO
                AND B.ID_ALMACEN = P_ID_ALMACEN
                AND B.ID_ANHO = P_ID_ANHO
                AND B.ID_ARTICULO = P_ID_ARTICULO
                AND B.STOCK_ACTUAL > 0;
            ELSE
                SELECT COUNT(1) INTO STRICT L_CONTA FROM VENTA_POLITICA_PERSONA WHERE ID_PERSONA = P_ID_CLIENTE AND coalesce(ACTIVO,'1') = '1' AND ID_POLITICA IN (SELECT ID_POLITICA FROM VENTA_POLITICA WHERE ID_ALMACEN = P_ID_ALMACEN);
                IF L_CONTA > 0 THEN
                    SELECT ID_POLITICA into STRICT L_ID_POLITICA FROM VENTA_POLITICA_PERSONA WHERE ID_PERSONA = P_ID_CLIENTE AND coalesce(ACTIVO,'1') = '1' AND ID_POLITICA IN (SELECT ID_POLITICA FROM VENTA_POLITICA WHERE ID_ALMACEN = P_ID_ALMACEN);
                END IF;
                L_CONTA :=0;
                SELECT
                       COUNT(1) INTO STRICT L_CONTA
                FROM INVENTARIO_ARTICULO A ,INVENTARIO_ALMACEN_ARTICULO B, VENTA_POLITICA_ARTICULO C
                WHERE A.ID_ARTICULO = B.ID_ARTICULO 
                AND B.ID_ALMACEN = C.ID_ALMACEN
                AND B.ID_ARTICULO = C.ID_ARTICULO
                AND B.ID_ANHO = C.ID_ANHO
                AND C.ID_POLITICA = L_ID_POLITICA
                AND B.ID_ANHO = P_ID_ANHO
                AND B.ID_ARTICULO = P_ID_ARTICULO
                AND B.STOCK_ACTUAL > 0;
                IF L_CONTA > 0 THEN
                    SELECT
                           B.ID_TIPOIGV,B.COSTO,C.PRECIO,ROUND(C.PRECIO*(coalesce(C.DESCUENTO,0)),2) INTO STRICT P_ID_TIPOIGV,P_PRECIO_ALM,P_PRECIO,P_DESCUENTO
                    FROM INVENTARIO_ARTICULO A ,INVENTARIO_ALMACEN_ARTICULO B, VENTA_POLITICA_ARTICULO C
                    WHERE A.ID_ARTICULO = B.ID_ARTICULO 
                    AND B.ID_ALMACEN = C.ID_ALMACEN
                    AND B.ID_ARTICULO = C.ID_ARTICULO
                    AND B.ID_ANHO = C.ID_ANHO
                    AND C.ID_POLITICA = L_ID_POLITICA
                    AND B.ID_ANHO = P_ID_ANHO
                    AND B.ID_ARTICULO = P_ID_ARTICULO
                    AND B.STOCK_ACTUAL > 0;
                ELSE
                    BEGIN
                        SELECT 
                                B.ID_TIPOIGV,B.COSTO,C.PRECIO,ROUND(C.PRECIO*(coalesce(C.DESCUENTO,0)),2) INTO STRICT P_ID_TIPOIGV,P_PRECIO_ALM,P_PRECIO,P_DESCUENTO
                        FROM INVENTARIO_ARTICULO A ,INVENTARIO_ALMACEN_ARTICULO B, VENTA_PRECIO C
                        WHERE A.ID_ARTICULO = B.ID_ARTICULO 
                        AND B.ID_ALMACEN = C.ID_ALMACEN
                        AND B.ID_ARTICULO = C.ID_ARTICULO
                        AND B.ID_ANHO = C.ID_ANHO
                        AND B.ID_ALMACEN = P_ID_ALMACEN
                        AND B.ID_ANHO = P_ID_ANHO
                        AND B.ID_ARTICULO = P_ID_ARTICULO
                        AND B.STOCK_ACTUAL > 0;
                    EXCEPTION
                        WHEN OTHERS THEN
                        P_ID_TIPOIGV :=0;
                        P_PRECIO_ALM :=0;
                        P_PRECIO := 0;
                        P_DESCUENTO := 0;
                    END;

                END IF;
            END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_precio_articulo (P_ID_CLIENTE bigint,P_ID_ALMACEN bigint, P_ID_ARTICULO bigint, P_ID_ANHO bigint, P_ID_TIPOIGV OUT text,P_PRECIO_ALM OUT bigint,P_PRECIO OUT bigint,P_DESCUENTO OUT bigint) FROM PUBLIC;
