-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_actualizar_venta (P_ID_VENTA bigint,P_ID_CLIENTE bigint,P_ID_SUCURSAL bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint,P_ID_TIPOTRANSACCION bigint,P_AGRUPADO text,P_GLOSA text,P_ERROR OUT bigint) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_ID_PERSONA bigint;
        l_id_moneda bigint;
        l_tc decimal(10,3);
        l_igv decimal(10,2);
        l_id_cliente bigint;
        l_totaldescuento decimal(10,2);
        l_id_sucursal bigint;
        l_glosa varchar(80);
        L_DOCUMENTO bigint :=0;

        
BEGIN
            select ID_ENTIDAD,ID_DEPTO,ID_PERSONA,TIPOCAMBIO,ID_MONEDA,ID_CLIENTE into STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_PERSONA,l_tc,l_id_moneda,l_id_cliente from venta where id_venta=P_ID_VENTA;

            l_id_sucursal:=P_ID_SUCURSAL;
            if P_ID_SUCURSAL=0 then
                l_id_sucursal:=null;
            end if;

            l_glosa:=P_GLOSA;
            if length(l_glosa)=0 or l_glosa=''  or coalesce(l_glosa::text, '') = '' then
                select NOMBRE INTO STRICT l_glosa from TIPO_TRANSACCION where ID_TIPOTRANSACCION=P_ID_TIPOTRANSACCION;
            end if;

            SELECT pkg_sales_fc_documento_impresion_user(L_ID_PERSONA,P_ID_COMPROBANTE,L_ID_ENTIDAD,L_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                P_ERROR :=1;
            END IF;

            --ACTUALIZA CABECERA
            update VENTA set
                      ID_CLIENTE= P_ID_CLIENTE,
                      ID_SUCURSAL=l_id_sucursal,
                      ID_COMPROBANTE=P_ID_COMPROBANTE,
                      ID_MONEDA=P_ID_MONEDA,
                      ID_TIPOTRANSACCION=P_ID_TIPOTRANSACCION,
                      AGRUPADO=P_AGRUPADO,
                      GLOSA=l_glosa
            where ID_VENTA=P_ID_VENTA;

            --si cambio cliente actualizar detalle
            if l_id_cliente<>P_ID_CLIENTE then
                l_totaldescuento:=0;
            end if;
            --se cambia moneda actualiza detalle
            if l_id_moneda<>P_ID_MONEDA then

                if l_id_moneda=9 then
                    update VENTA_DETALLE set
                    PRECIO = PRECIO_ME*l_tc,
                    PRECIO_BASE=PRECIO_BASE_ME*l_tc, 
                    PRECIO_ALM=PRECIO_ALM_ME*l_tc, 
                    BASE=BASE*l_tc, 
                    IGV=IGV*l_tc, 
                    DESCUENTO=DESCUENTO*l_tc, 
                    IMPORTE=IMPORTE*l_tc, 
                    PRECIO_ME=0, 
                    PRECIO_BASE_ME=0, 
                    PRECIO_ALM_ME=0, 
                    BASE_ME=0, 
                    IGV_ME=0, 
                    DESCUENTO_ME=0, 
                    IMPORTE_ME=0
                    where id_venta=P_ID_VENTA;
                else
                    update VENTA_DETALLE set
                    PRECIO_ME=PRECIO/l_tc,
                    PRECIO_BASE_ME=PRECIO_BASE/l_tc, 
                    PRECIO_ALM_ME=PRECIO_ALM/l_tc, 
                    BASE_ME=BASE/l_tc, 
                    IGV_ME=IGV/l_tc, 
                    DESCUENTO_ME=DESCUENTO/l_tc, 
                    IMPORTE_ME=IMPORTE/l_tc
                    where id_venta=P_ID_VENTA;
                end if;
            end if;
        CALL pkg_sales_sp_actualizar_total_venta(P_ID_VENTA);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_actualizar_venta (P_ID_VENTA bigint,P_ID_CLIENTE bigint,P_ID_SUCURSAL bigint,P_ID_COMPROBANTE text,P_ID_MONEDA bigint,P_ID_TIPOTRANSACCION bigint,P_AGRUPADO text,P_GLOSA text,P_ERROR OUT bigint) FROM PUBLIC;
