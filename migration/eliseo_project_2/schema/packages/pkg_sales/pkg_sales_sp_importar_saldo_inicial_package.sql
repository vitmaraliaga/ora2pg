-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_importar_saldo_inicial (P_ID_ENTIDAD bigint, P_ID_DEPTO bigint, P_ID_ANHO bigint, P_ID_VENTA bigint, P_ID_MONEDA bigint, P_ID_PERSONA bigint, P_DOCUMENTO text, P_ID_COMPROBANTE text, P_SERIE text, P_NUMERO text, P_FECHA timestamp(0), P_TOTAL bigint, P_TOTAL_ME bigint, P_TIPO_CLIENTE text, P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

    L_ID_CLIENTE bigint;
    L_ID_VENTA bigint;
    L_CANT bigint;
    L_ERROR bigint;
    L_MSGERROR varchar(200);
    L_DC varchar(1);
    L_CODIGO varchar(2);
    L_ID_MES bigint;
    L_ID_TIPOVENTA bigint;

BEGIN
        L_ERROR := 0;
        IF P_TIPO_CLIENTE = 'A' THEN   --ALUMNOS
            --SELECT COUNT(1) INTO L_CANT FROM MOISES.PERSONA_NATURAL A JOIN MOISES.PERSONA_NATURAL_ALUMNO B ON A.ID_PERSONA = B.ID_PERSONA  WHERE A.NUM_DOCUMENTO = P_DOCUMENTO; --AUMENTADO
            SELECT COUNT(1) INTO STRICT L_CANT
            FROM MOISES.PERSONA_NATURAL_ALUMNO
            WHERE CODIGO = P_DOCUMENTO; --ORIGINAL
            L_ID_TIPOVENTA := 1;
        ELSE
            SELECT COUNT(1) INTO STRICT L_CANT  --CLIENTES
            FROM MOISES.PERSONA_JURIDICA
            WHERE ID_RUC = P_DOCUMENTO;
            L_ID_TIPOVENTA := 5;
        END IF;

        
        IF L_CANT = 0 THEN
            L_ERROR := 1;
            L_MSGERROR := P_DOCUMENTO||' No Existe';
        ELSE

            IF P_TIPO_CLIENTE = 'A' THEN   --ALUMNOS
                --SELECT MAX(B.ID_PERSONA) INTO L_ID_CLIENTE FROM MOISES.PERSONA_NATURAL A JOIN MOISES.PERSONA_NATURAL_ALUMNO B ON A.ID_PERSONA = B.ID_PERSONA  WHERE A.NUM_DOCUMENTO = P_DOCUMENTO; --AUMENTADO SOLO CEPRE
                SELECT MAX(ID_PERSONA) INTO STRICT L_ID_CLIENTE
                FROM MOISES.PERSONA_NATURAL_ALUMNO
                WHERE CODIGO = P_DOCUMENTO; --ASI ERA ORIGINAL
            ELSE
                SELECT ID_PERSONA INTO STRICT L_ID_CLIENTE  --CLIENTES
                FROM MOISES.PERSONA_JURIDICA
                WHERE ID_RUC = P_DOCUMENTO;
            END IF;

            SELECT COUNT(1) INTO STRICT L_CANT
            FROM VENTA_SALDO
            WHERE ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_DEPTO = P_ID_DEPTO
            AND ID_ANHO = P_ID_ANHO
            AND ID_CLIENTE = L_ID_CLIENTE
            AND ID_COMPROBANTE = P_ID_COMPROBANTE
            AND SERIE = P_SERIE
            AND NUMERO = P_NUMERO;

            IF L_CANT > 0 THEN
                L_ERROR := 1;
                L_MSGERROR := P_SERIE||'-'||P_NUMERO||' YA Existe';
            END IF;
        END IF;

        IF L_ERROR = 0 THEN
            IF P_ID_VENTA = 0 THEN 
                L_ID_VENTA := NULL;
            ELSE
                L_ID_VENTA := P_ID_VENTA;
            END IF;
            SELECT (TO_CHAR(clock_timestamp(),'MM'))::numeric  INTO STRICT L_ID_MES;
            IF ABS(coalesce(P_TOTAL,0))+ABS(coalesce(P_TOTAL_ME,0)) <> 0 THEN
                INSERT INTO VENTA_SALDO( ID_ENTIDAD,
                                          ID_DEPTO,
                                          ID_ANHO,
                                          ID_VENTA,
                                          ID_MONEDA,
                                          ID_PERSONA,
                                          ID_CLIENTE,
                                          ID_COMPROBANTE,
                                          SERIE,
                                          NUMERO,
                                          FECHA,
                                          TOTAL,
                                          TOTAL_ME,
                                          ID_MES,
                                          ID_TIPOVENTA)
                     VALUES (P_ID_ENTIDAD,
                             P_ID_DEPTO,
                             P_ID_ANHO,
                             L_ID_VENTA,
                             P_ID_MONEDA,
                             P_ID_PERSONA,
                             L_ID_CLIENTE,
                             P_ID_COMPROBANTE,
                             P_SERIE,
                             P_NUMERO,
                             P_FECHA,
                             P_TOTAL,
                             P_TOTAL_ME,
                             L_ID_MES,
                             L_ID_TIPOVENTA);
                L_MSGERROR := 'OK';
                IF P_TOTAL < 0 THEN
                    L_DC :='D';
                    L_CODIGO := 'AN';
                ELSE
                    L_DC :='C';
                END IF;

                IF P_TOTAL < 0 THEN  --GENERA ANTICIPO SI TIENE SALDO A FAVOR
                    CALL pkg_sales_sp_crear_anticipos_clientes(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,L_ID_MES,L_ID_CLIENTE,P_ID_PERSONA,NULL,P_TOTAL,L_DC,L_CODIGO,L_ERROR,L_MSGERROR);
                END IF;
                IF L_ERROR <> 0 THEN
                    ROLLBACK;
                END IF;
            ELSE
                L_ERROR := 1;
                L_MSGERROR := P_TOTAL||' Importe en Cero';
            END IF;

        END IF;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;
    END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_importar_saldo_inicial (P_ID_ENTIDAD bigint, P_ID_DEPTO bigint, P_ID_ANHO bigint, P_ID_VENTA bigint, P_ID_MONEDA bigint, P_ID_PERSONA bigint, P_DOCUMENTO text, P_ID_COMPROBANTE text, P_SERIE text, P_NUMERO text, P_FECHA timestamp(0), P_TOTAL bigint, P_TOTAL_ME bigint, P_TIPO_CLIENTE text, P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
