-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_fc_format_glosa_assinet_sales (P_ID_ASIENTO bigint) RETURNS varchar AS $body$
DECLARE

        L_GLOSA_2 varchar(255);
        L_DESCRIPCION_2 varchar(100);

BEGIN
    
     BEGIN
       /* SELECT (   
        PKG_SALES.FC_DOCUMENTO_CLIENTE_ASSINET(
    V.id_cliente,
   V.id_comprobante
  )
                    || '/' ||
                CASE
                    WHEN LENGTH(v.SERIE || '-' || v.NUMERO) <= 13 THEN v.SERIE || '-' || v.NUMERO
                    ELSE SUBSTR(v.SERIE || '-' || v.NUMERO, 1, 13)
                    END || '/' ||
                CASE
                    WHEN LENGTH(vd.DETALLE) <= 34 THEN vd.DETALLE
                    ELSE SUBSTR(vd.DETALLE, 1, 34)
                    END)
        INTO L_DESCRIPCION_2
        FROM ELISEO.CONTA_ASIENTO ca
                 JOIN ELISEO.VENTA_DETALLE vd ON vd.ID_VDETALLE = ca.ID_ORIGEN
                 JOIN ELISEO.VENTA v ON v.ID_VENTA = vd.ID_VENTA
                
        WHERE ca.id_asiento = P_ID_ASIENTO
        AND (ca.CUENTA LIKE '1%' OR ca.CUENTA LIKE '2%');*/
        
        SELECT 
            --Documento
            (CASE WHEN '1'=CASE WHEN ca.cuenta='1132001' THEN '1' WHEN ca.cuenta='1132006' THEN '1' WHEN ca.cuenta='2161004' THEN '1' WHEN ca.cuenta='2162006' THEN '1'  ELSE 'X' END  
                    THEN COALESCE((SELECT 'C/'||codigo||'/' FROM MOISES.persona_natural_alumno WHERE id_persona=v.id_cliente),
                          (SELECT y.id_tipodocumento||'/'||x.num_documento||'/' FROM MOISES.persona_documento x 
                                JOIN MOISES.tipo_documento y ON y.id_tipodocumento=x.id_tipodocumento 
                                WHERE x.id_persona=v.id_cliente AND y.id_tipodocumento IN ('1','4','6','7','0','31')   LIMIT 1),(''))
            END)||
            --Corelativo
            (v.serie||'-'||v.numero||'/')||
            --IGV
            (CASE WHEN ca.cuenta='2130359' THEN 'IGV'||'/' END)||
            --GLOSA
            SUBSTR(V.glosa,1,CASE WHEN ca.cuenta='1132001' THEN 34 WHEN ca.cuenta='1132006' THEN 34 WHEN ca.cuenta='2161004' THEN 34 WHEN ca.cuenta='2162006' THEN 34  ELSE 45 END ) INTO STRICT L_DESCRIPCION_2 
                FROM ELISEO.CONTA_ASIENTO ca
                JOIN ELISEO.VENTA_DETALLE vd ON vd.ID_VDETALLE=ca.ID_ORIGEN
                JOIN ELISEO.VENTA v ON v.ID_VENTA=vd.ID_VENTA
                WHERE ca.cuenta IN ('1132001','1132006','2161004','2162006','1139090','1131001','2130359')
                AND ca.id_asiento=P_ID_ASIENTO;

        L_GLOSA_2 := L_DESCRIPCION_2;

        EXCEPTION
        WHEN no_data_found THEN
            L_GLOSA_2 := NULL;
        END;
            
            RETURN(L_GLOSA_2);
    END;
    FUNCTION
        FC_DOCUMENTO_CLIENTE_ASSINET(ID_CLIENTE IN bigint, ID_COMPROBANTE IN text) RETURN text IS
        P_RET varchar(100);
    BEGIN
        -- Si es factura imprime RUC
        IF ID_COMPROBANTE = '01' THEN 
            --  6 por ser REGISTRO ÃšNICO DE CONTRIBUYENTES (RUC)
            BEGIN
            SELECT '6' ||'/'|| PJ.ID_RUC INTO STRICT P_RET
                FROM MOISES.PERSONA_JURIDICA PJ
            WHERE PJ.ID_PERSONA = ID_CLIENTE;
             EXCEPTION
                WHEN no_data_found THEN
            P_RET := '6/RUC_NULL';
        END;
        ELSE 
            -- C = Codigo de alumno
            
            BEGIN 
            SELECT
                'C'||'/'|| CODIGO INTO STRICT P_RET
                FROM MOISES.PERSONA_NATURAL_ALUMNO PNA
                WHERE PNA.ID_PERSONA=ID_CLIENTE;
              EXCEPTION
        WHEN no_data_found THEN
            P_RET := NULL;
        END;
                
            IF coalesce(P_RET::text, '') = '' THEN 
            BEGIN
                SELECT PD.ID_TIPODOCUMENTO || '/' || PD.NUM_DOCUMENTO INTO STRICT P_RET
                FROM MOISES.PERSONA_NATURAL PN
                         INNER JOIN MOISES.PERSONA_DOCUMENTO PD ON PN.ID_PERSONA = PD.ID_PERSONA
                WHERE PN.ID_PERSONA = ID_CLIENTE
                  and PD.ES_ACTIVO = 1  LIMIT 1;
                         EXCEPTION
        WHEN no_data_found THEN
            P_RET := '0/DOC_NULL';
        END;
            END IF;
        END IF;
        RETURN P_RET;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE NOTICE 'ERROR EN DOCUMENTO CLIENTE ASSINET: %', SQLERRM;
    END;

    
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_fc_format_glosa_assinet_sales (P_ID_ASIENTO bigint) FROM PUBLIC;
