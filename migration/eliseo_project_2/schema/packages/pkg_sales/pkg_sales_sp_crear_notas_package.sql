-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;

    --SP NOTAS DE CREDITO Y DEBITO
CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_notas (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_VENTA bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint, P_ID_COMPROBANTE text,P_ID_TIPONOTA text,P_ID_TIPOTRANSACCION bigint,P_SERIE_REF text,P_NUMERO_REF text, P_GLOSA text,P_ID_COMPROBANTE_REF text,P_ID_NOTA OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


        L_CONT bigint;	
        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda_tc bigint;
        l_automatico varchar(2);
        l_id_voucher bigint;
        l_contar bigint;
        L_DOCUMENTO bigint :=0;
        L_ID_SUCURSAL bigint;
        L_ID_MONEDA bigint;
        L_ID_PARENT bigint;

        l_id_nota bigint;
        l_error bigint;
        l_msgerror varchar(200):='';

BEGIN
            l_error :=0;
            DELETE FROM VENTA_DETALLE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE IN ('07','08') AND ESTADO = 0 );
            DELETE FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ID_COMPROBANTE IN ('07','08') AND ESTADO = 0;

            --SELECT COALESCE(MAX(ID_VENTA),0)+1 INTO L_CONT FROM VENTA;
            IF P_ID_VENTA = 0 OR P_ID_VENTA = '' OR coalesce(P_ID_VENTA::text, '') = '' THEN
                L_ID_PARENT := NULL;
                L_ID_SUCURSAL := NULL;
                L_ID_MONEDA := 7;
            ELSE
                SELECT ID_SUCURSAL,ID_MONEDA INTO STRICT L_ID_SUCURSAL,L_ID_MONEDA FROM VENTA
                WHERE ID_VENTA = P_ID_VENTA;
                L_ID_PARENT := P_ID_VENTA;
            END IF;

            l_id_moneda_tc:=9;

            --obtiene IGV de la fecha actual
            select FC_IGV(CURRENT_DATE ) into STRICT l_igv;

            --obtiene tipo de cambio del dia
            select FC_TIPOCAMBIO(l_id_moneda_tc,CURRENT_DATE,'V' ) into STRICT l_tc;

            if coalesce(l_tc::text, '') = '' then
                l_tc:=0;
            end if;

            /*SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,'03',P_ID_ENTIDAD,P_ID_DEPTO) INTO L_DOCUMENTO FROM DUAL;
            IF L_DOCUMENTO = 0 THEN
                P_ERROR :=1;
            END IF;*/
            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,'03',P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                l_error :=1;
                l_msgerror := 'Alto! El usuario no tiene asignado un punto de impresi√≥n para el tipo de documento: 03';
--                 goto salida_rapida;
            END IF;
            
            IF l_error = 0 THEN
            INSERT INTO VENTA(
                    --ID_VENTA, 
                    ID_PARENT,
                    ID_ENTIDAD,
                    ID_DEPTO,
                    ID_ANHO,
                    ID_MES,
                    ID_PERSONA,
                    ID_CLIENTE,
                    ID_SUCURSAL,
                    ID_COMPROBANTE,
                    ID_TIPONOTA,
                    ID_IGV, 
                    ID_MONEDA, 
                    ID_LEYENDA,
                    ID_TIPOTRANSACCION,
                    TIPOCAMBIO,
                    SERIE, 
                    NUMERO, 
                    FECHA, 
                    GLOSA,
                    ESTADO,
                    ID_COMPROBANTE_REF,
                    SERIE_REF,
                    NUMERO_REF
            )VALUES (
                    --L_CONT,
                    L_ID_PARENT,
                    P_ID_ENTIDAD,
                    P_ID_DEPTO,
                    P_ID_ANHO,
                    P_ID_MES,
                    P_ID_PERSONA,
                    P_ID_CLIENTE,
                    L_ID_SUCURSAL,
                    P_ID_COMPROBANTE,
                    P_ID_TIPONOTA,
                    l_igv,
                    L_ID_MONEDA,
                    '1000',
                    P_ID_TIPOTRANSACCION,
                    l_tc,
                    '-',
                    '-',
                    clock_timestamp(),
                    P_GLOSA,
                    0,
                    P_ID_COMPROBANTE_REF,
                    P_SERIE_REF,
                    P_NUMERO_REF
            ) returning ID_VENTA INTO l_id_nota;

          END IF;
--           <<salida_rapida>>
        P_ID_NOTA:=l_id_nota;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_notas (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_VENTA bigint,P_ID_PERSONA bigint,P_ID_CLIENTE bigint, P_ID_COMPROBANTE text,P_ID_TIPONOTA text,P_ID_TIPOTRANSACCION bigint,P_SERIE_REF text,P_NUMERO_REF text, P_GLOSA text,P_ID_COMPROBANTE_REF text,P_ID_NOTA OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
