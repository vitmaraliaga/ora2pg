-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_venta_forma_pago (P_ID_VENTA bigint,P_ID_CREDITO OUT bigint) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);
        L_ID_ANHO bigint;
        L_ID_CLIENTE bigint;
        L_ID_COMPROBANTE varchar(2);
        L_CREDITO decimal(10,2);
        L_DEBITO decimal(10,2);
        L_TOTAL decimal(10,2);
        L_TOTAL_ME decimal(10,2);
        L_ID_CREDITO bigint;
        L_FECHA_PAGO timestamp(0);

BEGIN
            SELECT ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_CLIENTE,ID_COMPROBANTE,TOTAL,TOTAL_ME INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_ANHO,L_ID_CLIENTE,L_ID_COMPROBANTE,L_TOTAL,L_TOTAL_ME
            FROM VENTA WHERE ID_VENTA = P_ID_VENTA;
            --DEFINIR SI EL PAGO DE LA VENTA ES AL CONTADO O AL CREDITO, DEPENDE DEL SALDO DEL CLIENTE
            IF L_ID_COMPROBANTE = '01' THEN  --SOLO FACUTRAS
                BEGIN
                    SELECT
                        CASE WHEN SUM(TOTAL) < 0 THEN ABS(SUM(TOTAL)) ELSE 0 END AS CREDITO,
                        CASE WHEN SUM(TOTAL) > 0 THEN (SUM(TOTAL)) ELSE 0 END AS DEBITO
                        INTO STRICT L_CREDITO,L_DEBITO
                    FROM (
                            SELECT 
                                    TOTAL
                            FROM VW_SALES_MOV
                            WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_DEPTO = L_ID_DEPTO AND ID_ANHO = L_ID_ANHO
                            AND ID_CLIENTE = L_ID_CLIENTE
                            AND ID_TIPOVENTA IN (1,2,3,4,6) 
                            
UNION ALL

                            SELECT 
                                    SUM(IMPORTE)*CASE WHEN SIGN(SUM(IMPORTE))=1 THEN -1  ELSE 0 END  AS TOTAL
                            FROM VW_SALES_ADVANCES
                            WHERE ID_ENTIDAD =  L_ID_ENTIDAD AND ID_DEPTO = L_ID_DEPTO AND ID_ANHO = L_ID_ANHO
                            AND ID_CLIENTE = L_ID_CLIENTE
                    ) alias10;
                EXCEPTION WHEN no_data_found THEN
                    L_CREDITO := 0;
                END;

                IF L_CREDITO >= L_TOTAL THEN
                    L_ID_CREDITO := 1; --PAGO AL CONTADO
                ELSE
                    L_ID_CREDITO := 2; --PAGO AL CREDITO
                END IF;
                IF L_ID_CREDITO = 2 THEN
                    SELECT clock_timestamp() + interval '3 days' INTO STRICT L_FECHA_PAGO;
                    --INSERTAMOS SOLO 1 CUOTA DE PAGO
                    INSERT INTO VENTA_FORMA_PAGO(ID_VENTA,NRO_CUOTA,IMPORTE,IMPORTE_ME,FECHA_PAGO)VALUES (P_ID_VENTA,'CUO001',L_TOTAL,L_TOTAL_ME,L_FECHA_PAGO);
                END IF;
            ELSE
                L_ID_CREDITO := 1; --TODAS LAS BOLETAS PAGO AL CONTADO
            END IF;
	
        P_ID_CREDITO := L_ID_CREDITO;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_venta_forma_pago (P_ID_VENTA bigint,P_ID_CREDITO OUT bigint) FROM PUBLIC;
