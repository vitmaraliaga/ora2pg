-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_insert_precios_all (P_ID_ALMACEN bigint,P_ID_ANHO bigint,P_ID_ARTICULO bigint, P_PRECIO bigint, P_DESCUENTO bigint) AS $body$
DECLARE

        L_COSTO decimal(10,2);
        LIGVB decimal(10,2);
        L_BI decimal(10,2);
        L_CANT bigint;
        L_ID_POLITICA bigint;

        POLI CURSOR FOR
        SELECT ID_POLITICA 
        FROM VENTA_POLITICA
        WHERE ID_ALMACEN = P_ID_ALMACEN
        AND ESTADO = '1';

BEGIN
        SELECT 
                1+round((ID_IGV/100)::numeric,2) IGVB INTO STRICT LIGVB
        FROM CONTA_IGV
        WHERE TO_DATE(clock_timestamp()) BETWEEN FECHA_INI AND coalesce(FECHA_FIN,TO_DATE(clock_timestamp())) 
        AND ES_VENTA = 'S';

        SELECT CASE WHEN B.ID_TIPOIGV=10 THEN LIGVB  ELSE 1 END  INTO STRICT L_BI
        FROM INVENTARIO_ARTICULO A, INVENTARIO_ALMACEN_ARTICULO B
        WHERE A.ID_ARTICULO = B.ID_ARTICULO
        AND B.ID_ALMACEN = P_ID_ALMACEN
        AND B.ID_ANHO = P_ID_ANHO
        AND B.ID_ARTICULO = P_ID_ARTICULO
        AND B.ESTADO = '1';

        L_COSTO := round((P_PRECIO/L_BI)::numeric,2);

        SELECT COUNT(1) INTO STRICT L_CANT FROM VENTA_PRECIO
        WHERE ID_ALMACEN = P_ID_ALMACEN
        AND ID_ARTICULO = P_ID_ARTICULO
        AND ID_ANHO = P_ID_ANHO;

        IF L_CANT > 0 THEN
            UPDATE VENTA_PRECIO SET COSTO = L_COSTO,
                                    DESCUENTO = P_DESCUENTO,
                                    PRECIO = P_PRECIO
            WHERE ID_ALMACEN = P_ID_ALMACEN
            AND ID_ARTICULO = P_ID_ARTICULO
            AND ID_ANHO = P_ID_ANHO;
        ELSE
            INSERT INTO VENTA_PRECIO(ID_ALMACEN,ID_ARTICULO,ID_ANHO,COSTO,DESCUENTO,PRECIO,ESTADO)
            VALUES (P_ID_ALMACEN,P_ID_ARTICULO,P_ID_ANHO,L_COSTO,P_DESCUENTO,P_PRECIO,'1');
        END IF;

        OPEN POLI;
            FETCH POLI INTO L_ID_POLITICA;
            WHILE POLI%FOUND LOOP
                SELECT COUNT(1) INTO STRICT L_CANT FROM VENTA_POLITICA_ARTICULO
                WHERE ID_POLITICA = L_ID_POLITICA
                AND ID_ALMACEN = P_ID_ALMACEN
                AND ID_ARTICULO = P_ID_ARTICULO
                AND ID_ANHO = P_ID_ANHO;

                IF L_CANT > 0 THEN
                    UPDATE VENTA_POLITICA_ARTICULO SET  COSTO = L_COSTO,
                                                        DESCUENTO = P_DESCUENTO,
                                                        PRECIO = P_PRECIO
                    WHERE ID_POLITICA = L_ID_POLITICA
                    AND ID_ALMACEN = P_ID_ALMACEN
                    AND ID_ARTICULO = P_ID_ARTICULO
                    AND ID_ANHO = P_ID_ANHO;
                ELSE
                    INSERT INTO VENTA_POLITICA_ARTICULO(ID_POLITICA,ID_ALMACEN,ID_ARTICULO,ID_ANHO,COSTO,DESCUENTO,PRECIO,ESTADO)
                    VALUES (L_ID_POLITICA,P_ID_ALMACEN,P_ID_ARTICULO,P_ID_ANHO,L_COSTO,P_DESCUENTO,P_PRECIO,'1');
                END IF;
                FETCH POLI INTO L_ID_POLITICA;
            END LOOP;
        CLOSE POLI;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_insert_precios_all (P_ID_ALMACEN bigint,P_ID_ANHO bigint,P_ID_ARTICULO bigint, P_PRECIO bigint, P_DESCUENTO bigint) FROM PUBLIC;
