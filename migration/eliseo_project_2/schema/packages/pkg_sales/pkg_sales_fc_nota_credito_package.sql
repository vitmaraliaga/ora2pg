-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_fc_nota_credito (P_ID_VENTA bigint) RETURNS varchar AS $body$
DECLARE

        S_DETALLE       varchar(4000);
        S_VENTA         varchar(4000);
        S_CONTA         integer;

          S_TIPODOC       varchar(2);
        L_ID_TIPOVENTA bigint;

        S_ID_RUC      varchar(20);
        S_ERROR         varchar(1) := 'N';


        
        VENTA REFCURSOR;

    
BEGIN  
    S_CONTA:=0;
    SELECT COALESCE(MAX(M.ID_RUC),'') INTO STRICT S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
    AND E.ID_EMPRESA = M.ID_EMPRESA
    AND V.ID_VENTA = P_ID_VENTA;

    SELECT ID_COMPROBANTE,ID_TIPOVENTA INTO STRICT S_TIPODOC, L_ID_TIPOVENTA FROM VENTA WHERE ID_VENTA=P_ID_VENTA;

        IF S_TIPODOC='07' THEN  -- NOTA
                open VENTA FOR  
SELECT 'CC'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'07'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
		'|'||S_ID_RUC|| 
		'|'||CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN 1  ELSE 0 END  END || 
    '|'||CASE WHEN CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN coalesce(eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_legal,A.ID_CLIENTE)),'-')  ELSE CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal))  ELSE '0000' END  END ||
    '|'||CASE WHEN CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN eliseo.FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE_legal,A.ID_CLIENTE))  ELSE eliseo.FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)) END ||
		'|'||REGEXP_REPLACE(coalesce(trim(both eliseo.pkg_sales_facturacion_fc_cliente_direccion(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','', 'g')|| 
		'|'||''|| 
		'|'||CASE WHEN CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN trim(both eliseo.FC_EMAIL(A.ID_CLIENTE_legal))  ELSE trim(both eliseo.FC_EMAIL(A.ID_CLIENTE)) END ||
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END) END ||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END) END ||
		'|'||'0.00'|| 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END) END ||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END) END || 
    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.DESCUENTO,0) = 0 THEN '0.00' WHEN coalesce(A.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.DESCUENTO,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999999D99')),',','.') END) END ||
		'|'||'0.00'||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END) END || 
        '|'||'1000'|| 
        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
        '|'||CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '01'  ELSE '03' END || 
        '|'||a.serie_ref||'-'||a.numero_ref|| 
        '|'||'01'|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM eliseo.VENTA A
        WHERE A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       
UNION ALL
 
 SELECT  'DC'||	'|'||ROWNUM||
			'|'||coalesce(B.ID_ARTICULO,'86121701001')|| 
			'|'||coalesce(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121701')|| 
			'|'||'NIU'|| 
			'|'||b.cantidad|| 
			'|'||coalesce(b.detalle,'Venta UPeU')|| 
	    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
			'|'||b.ID_TIPOIGV|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN trim(both TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN trim(both TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END) END ||    
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2),'9999999999D99')),',','.') END) END || 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN coalesce(B.BASE,0)  BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE,0) ,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE,0) ,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.BASE_ME,0)  = 0 THEN '0.00' WHEN coalesce(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE_ME,0),'9999999999D99')),',','.') END) END ||			
			'|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;
                
    ELSIF S_TIPODOC = '08' THEN   -- DEBITO
        
            open VENTA FOR         
    SELECT 'CD'||'|'||'0101'||
		'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		'|'||'08'|| 
		'|'||A.SERIE||'-'||A.NUMERO||
		'|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
		'|'||S_ID_RUC|| 
		'|'||CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END || 
    '|'||CASE WHEN CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN coalesce(eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_legal,A.ID_CLIENTE)),'-')  ELSE eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)) END ||
    '|'||CASE WHEN CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN eliseo.FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE_legal,A.ID_CLIENTE))  ELSE eliseo.FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)) END ||
		'|'||REGEXP_REPLACE(coalesce(trim(both CASE WHEN CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN eliseo.FC_DIRECCION_CLIENTE(coalesce(A.ID_CLIENTE_legal,A.ID_CLIENTE))  ELSE eliseo.FC_DIRECCION_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)) END ),'Sin Direccion'),'-','', 'g')|| 
		'|'||''|| 
		'|'||CASE WHEN CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN trim(both eliseo.FC_EMAIL(A.ID_CLIENTE_legal))  ELSE trim(both eliseo.FC_EMAIL(A.ID_CLIENTE)) END ||		
		'|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
    '|'||''|| 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
		'|'||'0.00'|| 
		'|'||'0.00'|| 
    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END) END ||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END) END ||
		'|'||'0.00'|| 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END) END ||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
		'|'||'0.00'||
                    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END) END || 
    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END || 
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.DESCUENTO,0) = 0 THEN '0.00' WHEN coalesce(A.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.DESCUENTO,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999999D99')),',','.') END) END ||
		'|'||'0.00'||
		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END || 
        '|'||'1000'|| 
        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
        '|'||CASE WHEN SUBSTR(a.serie_ref,1,1)='F' THEN '01'  ELSE '03' END || 
        '|'||a.serie_ref||'-'||a.numero_ref|| 
        '|'||'01'|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''|| 
        '|'||''||    
        '|' CAB 
        FROM eliseo.VENTA A
        WHERE A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       
UNION ALL
 
 SELECT  'DD'||	'|'||ROWNUM||
			'|'||''|| 
			'|'||''|| 
			'|'||'NIU'|| 
			'|'||b.cantidad|| 
			'|'||coalesce(b.detalle,'Venta UPeU')|| 
	    '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
			'|'||b.ID_TIPOIGV|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN TO_CHAR(B.BASE,'9999999999.99') ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN TO_CHAR(B.BASE_ME,'9999999999.99') ELSE '0.00' END) END ||    
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO,0)/coalesce(B.BASE,1))::numeric,2),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2)  = 0 THEN '0.00' WHEN round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((coalesce(B.DESCUENTO_ME,0)/coalesce(B.BASE_ME,1))::numeric,2),'9999999999D99')),',','.') END) END || 
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999999D99')),',','.') END) END ||
			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN coalesce(B.BASE,0)  BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE,0) ,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE,0) ,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.BASE_ME,0)  = 0 THEN '0.00' WHEN coalesce(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE_ME,0),'9999999999D99')),',','.') END) END ||			
			'|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;

        END IF;

    
    fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
            END IF;

            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	

        RETURN(S_DETALLE);
    END;

    
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_fc_nota_credito (P_ID_VENTA bigint) FROM PUBLIC;
