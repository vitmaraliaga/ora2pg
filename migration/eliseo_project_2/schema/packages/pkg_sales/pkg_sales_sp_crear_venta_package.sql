-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_crear_venta (P_ID_PERSONA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ES_AUTOENTREGA bigint DEFAULT '1', P_ID_VENTA OUT bigint,P_ERROR OUT bigint) AS $body$
DECLARE

        -- l_cont numeric;	
        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda bigint;
        l_id_moneda_tc bigint;
        l_automatico varchar(2);
        l_id_voucher bigint;
        l_contar bigint;
        L_DOCUMENTO bigint :=0;

        
BEGIN
            P_ERROR :=0;
            --DELETE VENTA_ASIENTO WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0); 
            --DELETE VENTA_DETALLE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
            --DELETE VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0;
            
            -- SELECT COALESCE(MAX(ID_VENTA),0)+1 INTO l_cont FROM VENTA;
          
            l_id_moneda:=7; --SOLES
            l_id_moneda_tc:=9;

           
            -- Obtiene IGV de la fecha actual
            select FC_IGV(CURRENT_DATE ) into STRICT l_igv;

            -- Obtiene tipo de cambio del dia
            select FC_TIPOCAMBIO(l_id_moneda_tc,CURRENT_DATE,'D' ) into STRICT l_tc;

            if coalesce(l_tc::text, '') = '' then
                l_tc:=0;
            end if;

            --SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,'03',P_ID_ENTIDAD,P_ID_DEPTO) INTO L_DOCUMENTO FROM DUAL;
            SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,'03',P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
            IF L_DOCUMENTO = 0 THEN
                P_ERROR :=1;
            END IF;
            INSERT INTO VENTA(
            -- ID_VENTA, 
            ID_PERSONA,
            ID_ENTIDAD,
            ID_DEPTO,
            ID_ANHO,
            ID_MES,
            ID_COMPROBANTE, 
            ID_IGV, 
            ID_MONEDA, 
            ID_LEYENDA,
            TIPOCAMBIO,
            SERIE, 
            NUMERO, 
            FECHA, 
            ES_AUTOENTREGA,
            ESTADO 
            )VALUES (
            -- l_cont,
            P_ID_PERSONA,
            P_ID_ENTIDAD,
            P_ID_DEPTO,
            P_ID_ANHO,
            P_ID_MES,
            '03',--BOLETA
            l_igv,
            l_id_moneda,--SOLES
            '1000',
            l_tc,
            '-',--SERIE
            '-',--NRO
            clock_timestamp(),
            P_ES_AUTOENTREGA,
            0--
            ) RETURNING ID_VENTA INTO P_ID_VENTA;
            --SELECT NVL(MAX(ID_VENTA),0) INTO P_ID_VENTA FROM VENTA;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_crear_venta (P_ID_PERSONA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ES_AUTOENTREGA bigint DEFAULT '1', P_ID_VENTA OUT bigint,P_ERROR OUT bigint) FROM PUBLIC;
