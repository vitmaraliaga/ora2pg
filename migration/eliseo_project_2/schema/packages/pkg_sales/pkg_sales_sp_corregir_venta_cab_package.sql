-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_sp_corregir_venta_cab (P_ID_VENTA bigint) AS $body$
DECLARE

        L_ID_VENTA bigint;
        L_ID_COMPROBANTE varchar(2);
        L_IGV decimal(10,2);
        L_GRAVADA decimal(10,2);
        L_INAFECTA decimal(10,2);
        L_EXONERADA decimal(10,2);
        L_GRATUITA decimal(10,2);
        L_DESCUENTO decimal(10,2);
        L_TOTAL decimal(10,2);
        L_ID_VDETALLE bigint;
        L_BASE_D decimal(10,2);
        L_IGV_D decimal(10,2);

        CAB CURSOR FOR
        SELECT 
        ID_VENTA,ID_COMPROBANTE --,SERIE,NUMERO,FECHA,
        --TOTAL,GRAVADA,INAFECTA,EXONERADA,DESCUENTO,IGV,OTROS_CARGOS,
        --TOTAL-(GRAVADA+INAFECTA+EXONERADA+IGV) AS DIF
        FROM VENTA
        WHERE TOTAL<>(GRAVADA+INAFECTA+EXONERADA+IGV+OTROS_CARGOS)
        AND OTROS_CARGOS > 0;



        
BEGIN
        
            OPEN CAB;
            FETCH CAB INTO L_ID_VENTA,L_ID_COMPROBANTE;
                WHILE CAB%FOUND LOOP

                    --CALCULA DETALLE DE LA VENTA
                    SELECT SUM(BASE) INTO STRICT L_BASE_D 
                    FROM VENTA_DETALLE
                    WHERE ID_VENTA = L_ID_VENTA
                    AND ID_TIPOIGV = '10';

                    --ACTUALIZA CABECERA DE LA VENTA
                  
                    UPDATE VENTA SET
                                    GRAVADA=L_BASE_D
                    WHERE ID_VENTA=L_ID_VENTA;

                    --GENERAMOS EL ASIENTO
                    CALL pkg_sales_sp_re_genera_asiento_sales(L_ID_VENTA);

                    --VENTA ELECTRONICA
                    DELETE FROM VENTA_ELECTRONICA
                    WHERE ORIGENID = L_ID_VENTA;

                    DELETE FROM UPEU_COMPROBANTE@DBL_ARON_APP
                    WHERE ORIGENID = L_ID_VENTA::text;

                    CALL pkg_sales_sp_venta_electronica(L_ID_VENTA,L_ID_COMPROBANTE);
                    FETCH CAB INTO L_ID_VENTA,L_ID_COMPROBANTE;

                END LOOP;
            CLOSE CAB;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_sp_corregir_venta_cab (P_ID_VENTA bigint) FROM PUBLIC;
