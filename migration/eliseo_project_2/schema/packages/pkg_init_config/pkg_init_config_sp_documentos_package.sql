-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_init_config,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_init_config_sp_documentos (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint := 0;
        l_id_entidad_base bigint := 72122;
        l_id_depto_base varchar(15) := '121211';
        l_id_user bigint := 7932;
        l_id_sistemaexterno bigint;
        l_id_documento_new bigint;
        l_id_docip_calculo bigint;
        l_id_docip bigint;

        datos_base CURSOR FOR
        SELECT * from eliseo.CONTA_DOCUMENTO
        where id_entidad = l_id_entidad_base
        and id_depto = l_id_depto_base
;


BEGIN
        
         select max(id_docip) into STRICT l_id_docip_calculo from eliseo.conta_documento_ip;

        FOR dato_base in datos_base LOOP

            select count(1), max(id_documento) into STRICT l_contar, l_id_documento_new from eliseo.CONTA_DOCUMENTO
                where id_entidad = P_ID_ENTIDAD
                and id_depto = P_ID_DEPTO
                and id_comprobante = dato_base.id_comprobante;

            if l_contar = 0 then
                insert into eliseo.CONTA_DOCUMENTO(
                    ID_COMPROBANTE,
                    ID_ENTIDAD,
                    ID_DEPTO,
                    NOMBRE,
                    PUERTO,
                    NUMLINE,
                    NUMCOL,
                    SERIE,
                    CONTADOR,
                    ACTIVO,
                    DOCID,
                    ID_COMPROBANTE_AFECTO
                )
                values (
                    dato_base.ID_COMPROBANTE,
                    P_ID_ENTIDAD,
                    P_ID_DEPTO,
                    dato_base.NOMBRE,
                    dato_base.PUERTO,
                    dato_base.NUMLINE,
                    dato_base.NUMCOL,
                    dato_base.SERIE,
                    0,
                    dato_base.ACTIVO,
                    dato_base.DOCID,
                    dato_base.ID_COMPROBANTE_AFECTO
                ) returning id_documento into l_id_documento_new;

                insert into eliseo.CONTA_DOCUMENTO_DETALLE
                SELECT 
                    null, 
                    l_id_documento_new, 
                    CONTENIDO,
                    MODO,
                    TIPO,
                    POS_X,
                    POS_Y
                from eliseo.CONTA_DOCUMENTO_DETALLE
                where id_documento = dato_base.id_documento;

                l_id_docip_calculo := l_id_docip_calculo +1;
                l_id_docip := l_id_docip_calculo;

                insert into eliseo.CONTA_DOCUMENTO_IP
                SELECT 
                    l_id_docip, 
                    l_id_documento_new, 
                    ID_TIPOTRANSACCION,
                    (SELECT max(b.ID_DINAMICA) FROM CONTA_DINAMICA a, conta_dinamica b
					WHERE a.ID_DINAMICA = ip.ID_DINAMICA 
					AND a.NOMBRE = b.NOMBRE 
					AND b.ID_ENTIDAD = P_ID_ENTIDAD
					AND b.ID_DEPTO = P_ID_DEPTO),
                    NOMBRE,
                    '10.171.11.185',
                    ESTADO,
                    IMPRIMIR
                from eliseo.CONTA_DOCUMENTO_IP ip
                where id_documento = dato_base.id_documento;

                RAISE NOTICE 'documentos creado';
            else
                RAISE NOTICE 'documentos existente';
            end if;

            

        end loop;
        P_ERROR := 0;
        P_MSGERROR := 'Documentos revisado y actualizado';
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_init_config_sp_documentos (P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
