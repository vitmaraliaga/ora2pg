-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_nodom_imp (P_ID_COMPRAS_PRELI bigint, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;
      l_id_empresa bigint;
      l_periodo  varchar(20);
      l_id_entidad bigint:=7124;

BEGIN
    
      select ID_EMPRESA, PERIODO into STRICT
      l_id_empresa,l_periodo
      from SIRE_COMPRAS_PRELI
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI;
    
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=l_id_empresa;

      delete from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in (
        SELECT id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and id_depto  in ('3');

      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI;

      
      insert into SIRE_COMPRAS_PRELI_DET(
        ID_COMPRAS_PRELI_DET,
        ID_COMPRAS_PRELI,
        ID_ENTIDAD,
        ID_DEPTO,
        TIPO,
        ORDEN,
        CARSUNAT,	
        FEMISION,	
        TIPOCOMP,	
        SERIE,
        ANHO, 
        MES,
        NRODOCINICIAL,
        VALORADQNG,	
        NDCONCEPTO_ADIC,	
        TOTALCP,	
        NDTIPOCOMP,	
        NDSERIE,	
        NDANHO,	
        NDNRODOCINICIAL,	
        IGVIPMDNG,	
        MONEDA,	
        TIPOCAMBIO,	
        NDPAIS,	
        RAZONSOCIAL,	
        NDDOMICILIO,	
        NRODOCUMENTO,	
        NDNRODOCPAGO,	
        NDRAZONSOCIALPAGO,	
        NDPAISPAGO,	
        NDVINCULO,	
        BIGRAVADODG,	
        BIGRAVADODGNG,	
        BIGRAVADODNG,	
        IGVIPMDGNG,	
        IGVIPMDG,	
        NDDOBLETRIB,	
        NDEXOAPLI,	
        NDTIPORENTA,	
        NDMODERV,	
        NDAPLIRENTA,	
        CARORIGINDEOI,
        VIGENCIA,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT
        'ND'||l_id_empresa::text||TO_CHAR(w.FECHA_PROV,'YYYY')::text||LPAD(TO_CHAR(w.FECHA_PROV,'MM')::text,2,'0')|| to_char((row_number() OVER ( ORDER BY w.id_mov_comp ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
        P_ID_COMPRAS_PRELI,
        7124 as id_entidad,
        '3' AS id_depto,
        'C',
        ((row_number() OVER ( ORDER BY w.id_mov_comp ASC )) + l_orden) as ORDEN,
        w.RUC ||w.TIPO_DOC||w.SERIE||LPAD(w.NUMDOC,20,'0') as CARSUNAT,
        w.FECHA_DOC,
        w.TIPO_DOC,
        w.SERIE,
        TO_CHAR(w.FECHA_PROV,'YYYY'),        
        TO_CHAR(w.FECHA_PROV,'MM'),
        (w.NUMDOC)::numeric ::text as NUMERO ,
        coalesce(w.BASEIMP1,0) as VALORADQNG,
        0 as NDCONCEPTO_ADIC,
        coalesce(w.IMPORTE,0) as TOTALCP,
        '' as NDTIPOCOMP,	
        '' as NDSERIE,	
        '' as NDANHO,	
        '' as NDNRODOCINICIAL,
        0 as IGVIPMDNG,
        w.MONEDA,
        coalesce(w.TIPO_CAMBIO,0),
        '' as NDPAIS,
        w.NOMBRE as RAZONSOCIAL,
        '' as NDDOMICILIO,
        w.RUC as NRODOCUMENTO,
        '' as NDNRODOCPAGO,	
        '' as NDRAZONSOCIALPAGO,	
        '' as NDPAISPAGO,	
        '' as NDVINCULO,
        0 as BIGRAVADODG,	
        0 as BIGRAVADODGNG,	
        0 as BIGRAVADODNG,	
        0 as IGVIPMDGNG,	
        0 as IGVIPMDG,
        '00' as NDDOBLETRIB, --00-ninguno
        '' as NDEXOAPLI,	
        '' as NDTIPORENTA,	
        '' as NDMODERV,	
        '' as NDAPLIRENTA,	
        '' as CARORIGINDEOI,
        1,
        P_ID_USER,
        clock_timestamp()        
      FROM(
        SELECT 
        A.FECHA_PROV,
        A.id_mov_comp,
        A.FECHA_DOC,
        A.TIPO_DOC, 
        A.SERIE,
        A.NUMDOC,
        B.RUC,
        B.NOMBRE,
        A.BASEIMP1,
        A.IGV1,
        A.BASEIMP5,
        A.IGV5,
        A.BASEIMP2,
        A.IGV2,
        coalesce(A.BASEIMP3,A.BASEIMP4) AS INAFECTA,
        A.ICBPER,
        A.IMPORTE,
        CASE WHEN A.MONEDA='00' THEN 'PEN'  ELSE 'USD' END  AS MONEDA,
        A.TIPO_CAMBIO,
        null as FEMISIONDOCMOD,
        '' as TIPOCPMOD,
        '' as  SERIECPMOD,
        '' as CODDAMODSI,
        '' as NROCPMOD,
        case when A.DETRAC= 'D' then  'D' else '' end  as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON A.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE A.ID_COMPRAS = '001-' ||SUBSTR(l_periodo,0,4)
        AND TO_CHAR(A.FECHA_PROV,'MM') = SUBSTR(l_periodo,5,2) 
        AND A.ESTADO = 'P'
        AND A.TIPO_DOC  in ('91','97','98')           
        
UNION ALL

        SELECT 
        X.FECHA_PROV,
        X.id_mov_not as id_mov_comp,
        X.FECHA_DOC,
        X.TIPO_DOC, 
        X.SERIE,
        X.NUMDOC,
        B.RUC,
        B.NOMBRE,
        (CASE X.TIPO_BI WHEN '1' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP1,
        (CASE X.TIPO_BI WHEN '1' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV1,
        (CASE X.TIPO_BI WHEN '5' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP5,
        (CASE X.TIPO_BI WHEN '5' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV5,
        (CASE X.TIPO_BI WHEN '2' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP2,
        (CASE X.TIPO_BI WHEN '2' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV2,
        (CASE X.TIPO_BI WHEN '4' THEN X.IMPORTE END) AS INAFECTA,
        A.ICBPER,
        X.IMPORTE,
        CASE WHEN X.MONEDA='00' THEN 'PEN'  ELSE 'USD' END  AS MONEDA,
        A.TIPO_CAMBIO,
        A.FECHA_DOC as FEMISIONDOCMOD,
        A.TIPO_DOC as TIPOCPMOD,
        A.SERIE as  SERIECPMOD,
        '' as CODDAMODSI,
        A.NUMDOC as NROCPMOD,
        '' as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A JOIN COMPRAS_NOTAS@DBL_ARON_APP X ON A.ID_MOV_COMP = X.ID_MOV_COMP
        LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON X.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE X.ID_COMPRAS = '001-' ||SUBSTR(l_periodo,0,4)
        AND TO_CHAR(X.FECHA_PROV,'MM') = SUBSTR(l_periodo,5,2) 
        and X.TIPO_DOC  in ('91','97','98')    
      )w
      order by w.TIPO_DOC,
      w.SERIE,
      (w.NUMDOC)::numeric;

       update SIRE_COMPRAS_PRELI_DET set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        NDCONCEPTO_ADIC=NDCONCEPTO_ADIC*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in (
        SELECT id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and TIPOCOMP in ('97')
      and TOTALCP>0
      and id_depto  in ('3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_nodom_imp (P_ID_COMPRAS_PRELI bigint, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
