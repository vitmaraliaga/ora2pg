-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_contribuy (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;

BEGIN
    
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;

      delete from SIRE_COMPRAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto not in ('2','3');

      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_COMPRAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;

      
      insert into SIRE_COMPRAS_CONTRIBUY(
        ID_COMPRAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        INCAL,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT 
      distinct 
      P_ID_EMPRESA::text||a.id_anho::text||LPAD(a.id_mes::text,2,'0')|| to_char((row_number() OVER ( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
      P_ID_EMPRESA as ID_EMPRESA,
      a.id_entidad,
      a.id_depto,
      a.id_anho::text||LPAD(a.id_mes::text,2,'0') as PERIODO,
      ((row_number() OVER ( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ORDEN,
      a.FECHA_DOC,
      null,--a.FECHA_VENCIMIENTO,
      a.id_comprobante,
      a.SERIE,
      a.id_anho::text as anho,
      LPAD(a.id_mes::text,2,'0') as mes,
      (a.NUMERO)::numeric ::text as NUMERO ,
      '' as NRODOFINAL,
      '6' as TIPODOC,
      B.ID_RUC as NRODOCUMENTO,
      b.NOMBRE as RAZONSOCIAL,
      coalesce(a.BASE_GRAVADA,0) as BASE_GRAVADA,
      coalesce(a.IGV_GRAVADO,0) as IGV_GRAVADO,
      coalesce(a.IGV,0) as BASE_MIXTA,
      coalesce(a.IGV_MIXTO,0) as IGV_MIXTO,
      coalesce(a.BASE_NOGRAVADA,0) as BASE_NOGRAVADA,
      coalesce(a.IGV_NOGRAVADO,0)  as IGV_NOGRAVADO,
      coalesce(a.BASE_SINCREDITO,0)  as BASE_SINCREDITO,
      0 as ISC,
      0 as ICBPER,
      coalesce(a.OTROS,0) as OTROS,
      coalesce(a.IMPORTE,0) as TOTALCP,
      CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END  as MONEDA,
      coalesce(a.TIPOCAMBIO,0),
      c.FECHA_DOC as FEMISIONDOCMOD,
      c.id_comprobante as TIPOCPMOD,
      c.SERIE as  SERIECPMOD,
      '' as CODDAMODSI,
      (c.NUMERO)::numeric ::text as NROCPMOD,
      '' as CLASIFDEBSSYSSS,
      '' as IDPROYOPERATRI,
      '' as PORCPART,
      null as IMB,
      '' as CARORIGINDEOI,
      case when a.ES_RET_DET= 'D' then  'D' else '' end as DETRACCION,
      a.ID_TIPONOTA,
      '' as INCAL,
      B.ID_RUC ||a.ID_COMPROBANTE||a.SERIE||LPAD(a.NUMERO::text,20,'0') as CARSUNAT,
      P_ID_USER,
      clock_timestamp()
      from COMPRA a inner join MOISES.VW_PERSONA_NATURAL_LEGAL B on a.ID_PROVEEDOR = b.ID_PERSONA
      LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
      where a.id_entidad in (
        SELECT id_entidad from conta_entidad where id_empresa=P_ID_EMPRESA 
      )
      and a.id_anho::text||LPAD(a.id_mes::text,2,'0')=P_PERIODO
      and a.estado='1'
      and a.id_comprobante not IN ('02','91','97','98','87','88')
      order by a.id_comprobante,
      a.SERIE,
      (a.NUMERO)::numeric;

 
      update SIRE_COMPRAS_CONTRIBUY set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP in ('07','87')
      and TOTALCP>0
      and id_depto not in ('2','3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_contribuy (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
