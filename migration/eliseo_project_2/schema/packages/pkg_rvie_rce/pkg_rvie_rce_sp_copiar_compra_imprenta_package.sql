-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_imprenta (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;

BEGIN
    
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;

      delete from SIRE_COMPRAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto  in ('3');

      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_COMPRAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;

      
      insert into SIRE_COMPRAS_CONTRIBUY(
        ID_COMPRAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        INCAL,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT
        P_ID_EMPRESA::text||TO_CHAR(w.FECHA_PROV,'YYYY')::text||LPAD(TO_CHAR(w.FECHA_PROV,'MM')::text,2,'0')|| to_char((row_number() OVER ( ORDER BY w.id_mov_comp ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
        P_ID_EMPRESA as ID_EMPRESA,
        7124 as id_entidad,
        '3' AS id_depto,
        TO_CHAR(w.FECHA_PROV,'YYYYMM') as PERIODO,
        ((row_number() OVER ( ORDER BY w.id_mov_comp ASC )) + l_orden) as ORDEN,
        w.FECHA_DOC,
        null,
        w.TIPO_DOC,
        w.SERIE,
        TO_CHAR(w.FECHA_PROV,'YYYY'),        
        TO_CHAR(w.FECHA_PROV,'MM'),
        (w.NUMDOC)::numeric ::text as NUMERO ,
        '' as NRODOFINAL,
        '6' as TIPODOC,
        w.RUC as NRODOCUMENTO,
        w.NOMBRE as RAZONSOCIAL,
        coalesce(w.BASEIMP1,0) as BIGRAVADODG,
        coalesce(w.IGV1,0) as IGVIPMDG,
        coalesce(w.BASEIMP5,0) as BIGRAVADODGNG,
        coalesce(w.IGV5,0) as IGVIPMDGNG,
        coalesce(w.BASEIMP2,0) as BIGRAVADODNG,
        coalesce(w.IGV2,0)  as IGVIPMDNG,
        coalesce(w.INAFECTA,0)  as VALORADQNG,
        coalesce(w.ICBPER,0) as ISC,
        0 as ICBPER,
        0 as OTROS,
        coalesce(w.IMPORTE,0) as TOTALCP,
        w.MONEDA,
        coalesce(w.TIPO_CAMBIO,0),   
        w.FEMISIONDOCMOD,
        w.TIPOCPMOD,
        w.SERIECPMOD,
        w.CODDAMODSI,
        w.NROCPMOD,
        '' as CLASIFDEBSSYSSS,
        '' as IDPROYOPERATRI,
        '' as PORCPART,
        null as IMB,
        '' as CARORIGINDEOI,
        w.DETRACCION,
        case when w.TIPO_DOC='07' then '01' when w.TIPO_DOC='08' then '11' else '' end as ID_TIPONOTA,
        '' as INCAL,
        w.RUC ||w.TIPO_DOC||w.SERIE||LPAD(w.NUMDOC,20,'0') as CARSUNAT,
        P_ID_USER,
        clock_timestamp()
        
      FROM(
        SELECT 
        A.FECHA_PROV,
        A.id_mov_comp,
        A.FECHA_DOC,
        A.TIPO_DOC, 
        A.SERIE,
        A.NUMDOC,
        B.RUC,
        B.NOMBRE,
        A.BASEIMP1,
        A.IGV1,
        A.BASEIMP5,
        A.IGV5,
        A.BASEIMP2,
        A.IGV2,
        coalesce(A.BASEIMP3,A.BASEIMP4) AS INAFECTA,
        A.ICBPER,
        A.IMPORTE,
        CASE WHEN A.MONEDA='00' THEN 'PEN'  ELSE 'USD' END  AS MONEDA,
        A.TIPO_CAMBIO,
        null as FEMISIONDOCMOD,
        '' as TIPOCPMOD,
        '' as  SERIECPMOD,
        '' as CODDAMODSI,
        '' as NROCPMOD,
        case when A.DETRAC= 'D' then  'D' else '' end  as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON A.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE A.ID_COMPRAS = '001-' ||SUBSTR(P_PERIODO,0,4)
        AND TO_CHAR(A.FECHA_PROV,'MM') = SUBSTR(P_PERIODO,5,2) 
        AND A.ESTADO = 'P'
        AND A.TIPO_DOC not in ('91','97','98')           
        
UNION ALL

        SELECT 
        X.FECHA_PROV,
        X.id_mov_not as id_mov_comp,
        X.FECHA_DOC,
        X.TIPO_DOC, 
        X.SERIE,
        X.NUMDOC,
        B.RUC,
        B.NOMBRE,
        (CASE X.TIPO_BI WHEN '1' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP1,
        (CASE X.TIPO_BI WHEN '1' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV1,
        (CASE X.TIPO_BI WHEN '5' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP5,
        (CASE X.TIPO_BI WHEN '5' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV5,
        (CASE X.TIPO_BI WHEN '2' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP2,
        (CASE X.TIPO_BI WHEN '2' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV2,
        (CASE X.TIPO_BI WHEN '4' THEN X.IMPORTE END) AS INAFECTA,
        A.ICBPER,
        X.IMPORTE,
        CASE WHEN X.MONEDA='00' THEN 'PEN'  ELSE 'USD' END  AS MONEDA,
        A.TIPO_CAMBIO,
        A.FECHA_DOC as FEMISIONDOCMOD,
        A.TIPO_DOC as TIPOCPMOD,
        A.SERIE as  SERIECPMOD,
        '' as CODDAMODSI,
        A.NUMDOC as NROCPMOD,
        '' as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A JOIN COMPRAS_NOTAS@DBL_ARON_APP X ON A.ID_MOV_COMP = X.ID_MOV_COMP
        LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON X.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE X.ID_COMPRAS = '001-' ||SUBSTR(P_PERIODO,0,4)
        AND TO_CHAR(X.FECHA_PROV,'MM') = SUBSTR(P_PERIODO,5,2) 
        and X.TIPO_DOC not in ('91','97','98')    
      )w
      order by w.TIPO_DOC,
      w.SERIE,
      (w.NUMDOC)::numeric;

 
      update SIRE_COMPRAS_CONTRIBUY set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP in ('07','87')
      and TOTALCP>0
      and id_depto  in ('3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_compra_imprenta (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
