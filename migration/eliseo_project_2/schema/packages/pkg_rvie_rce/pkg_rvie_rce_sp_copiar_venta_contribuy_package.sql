-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_rvie_rce,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_venta_contribuy (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_error bigint:=0;
      l_msgerror varchar(200):='ok';
      l_contar bigint;
      l_ruc  varchar(20);
      l_orden bigint;

BEGIN
    
      select id_ruc into STRICT l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;

      delete from SIRE_VENTAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto not in ('2','3');

      select coalesce(max(coalesce(orden,0)),0) into STRICT l_orden from SIRE_VENTAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;

      
      insert into SIRE_VENTAS_CONTRIBUY(
        ID_VENTAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        VALFACEXPO,
        BIGRAVADA,
        DSCTOBI,
        IGVIPM,
        DSCTOIGVIPM,
        MTOEXONERADO,
        MTOINAFECTO,
        ISC,
        BIGRAVIVAP,
        IVAP,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        NROCPMOD,
        IDPROYOPERATRI,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT 
      P_ID_EMPRESA::text||a.id_anho::text||LPAD(a.id_mes::text,2,'0')|| to_char((row_number() OVER ( ORDER BY a.ID_venta ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
      P_ID_EMPRESA as ID_EMPRESA,
      a.id_entidad,
      a.id_depto,
      a.id_anho::text||LPAD(a.id_mes::text,2,'0') as PERIODO,
      ((row_number() OVER ( ORDER BY a.ID_venta ASC )) + l_orden) as ORDEN,
      a.FECHA,
      null,--a.FECHA_VENCIMIENTO,
      a.id_comprobante,
      a.SERIE,
      (a.NUMERO)::numeric ::text as NUMERO ,
      '' as NRODOFINAL,
      case 
      when a.id_comprobante='03' then
          CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN 1  ELSE 0 END 
      when a.id_comprobante='01' then
          6
      else 
      	CASE WHEN SUBSTR(a.serie,1,1)='F' THEN 6  ELSE CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN 1  ELSE 0 END  END 

      end as TIPODOC,
      case 
      when a.id_comprobante='03' then
          CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal))  ELSE '0000' END 
      when a.id_comprobante='01' then
        coalesce(FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')
      else
        CASE WHEN CASE WHEN SUBSTR(a.serie,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN coalesce(eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_legal,A.ID_CLIENTE)),'-')  ELSE CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal))  ELSE '0000' END  END 
      end as NRODOCUMENTO,
      
      case 
      when a.id_comprobante='03' then
        case when a.ID_TIPOVENTA IN (1,2,3,4) THEN
          coalesce(trim(both FC_NOMBRE_CLIENTE(A.ID_CLIENTE)),'Cliente Varios')
        else
          coalesce(trim(both FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')
        end
      when a.id_comprobante='01' then
        
          FC_NOMBRE_PERSONA(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))
      else
          CASE WHEN CASE WHEN SUBSTR(a.serie,1,1)='F' THEN '6'  ELSE '1' END ='6' THEN eliseo.FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE_legal,A.ID_CLIENTE))  ELSE eliseo.FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)) END 
      end as RAZONSOCIAL,
      0 as VALFACEXPO,
      coalesce(a.GRAVADA,0) as BIGRAVADA,
      coalesce(a.DESCUENTO_GLOBAL,0) as DSCTOBI,
      coalesce(a.IGV,0) as IGVIPM,
      0 as DSCTOIGVIPM,
      coalesce(a.EXONERADA,0) as MTOEXONERADO,
      coalesce(a.INAFECTA,0)  as MTOINAFECTO,
      0 as ISC,
      0 as BIGRAVIVAP,
      0 as IVAP,
      coalesce(a.OTROS_CARGOS,0) as ICBPER,
      coalesce(a.OTROS_CARGOS,0) as OTROSTRIBUTOS,
      coalesce(a.TOTAL,0) as TOTALCP,
      CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END  as MONEDA,
      coalesce(a.TIPOCAMBIO,0),
      a.FECHA_REF as FEMISIONDOCMOD,
      a.ID_COMPROBANTE_REF as TIPOCPMOD,
      a.SERIE_REF as  SERIECPMOD,
      a.NUMERO_REF as NROCPMOD,
      '' as IDPROYOPERATRI,
      l_ruc ||a.ID_COMPROBANTE||a.SERIE||LPAD(a.NUMERO::text,10,'0') as CARSUNAT,
      P_ID_USER,
      clock_timestamp()
      from venta a
      where a.id_entidad in (
        SELECT id_entidad from conta_entidad where id_empresa=P_ID_EMPRESA 
      )
      and a.id_anho::text||LPAD(a.id_mes::text,2,'0')=P_PERIODO
      and a.estado='1'
      order by a.id_comprobante,
      a.SERIE,
      (a.NUMERO)::numeric ::text;

      
      update SIRE_VENTAS_CONTRIBUY set
        VALFACEXPO=VALFACEXPO*(-1),
        BIGRAVADA=BIGRAVADA*(-1),
        DSCTOBI=DSCTOBI*(-1),
        IGVIPM=IGVIPM*(-1),
        DSCTOIGVIPM=DSCTOIGVIPM*(-1),
        MTOEXONERADO=MTOEXONERADO*(-1),
        MTOINAFECTO=MTOINAFECTO*(-1),
        ISC=ISC*(-1),
        BIGRAVIVAP=BIGRAVIVAP*(-1),
        IVAP=IVAP*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP='07'
      and TOTALCP>0
      and id_depto not in ('2','3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_rvie_rce_sp_copiar_venta_contribuy (P_ID_EMPRESA bigint,P_PERIODO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
