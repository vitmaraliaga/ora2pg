-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_school,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_school_sp_crear_venta (P_ID_PERSONA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint, P_ID_CLIENTE bigint,P_ID_CLIENTE_LEGAL bigint,P_ID_COMPROBANTE text, P_ID_MONEDA bigint, P_ID_VENTA INOUT bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE


        L_DOCUMENTO bigint :=0;
        l_igv decimal(10,2);
        l_tc decimal(10,3);
        l_id_moneda bigint;
        l_id_moneda_tc bigint;

        l_contar bigint;

        L_ID_VENTA bigint :=0;
        L_ERROR bigint :=0;
        L_MSGERROR varchar(200) :='';

        
BEGIN
        
        --DELETE VENTA_DETALLE WHERE ID_VENTA IN (SELECT ID_VENTA FROM VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0);
        --DELETE VENTA WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_PERSONA = P_ID_PERSONA AND ESTADO = 0;
            
        l_id_moneda:= P_ID_MONEDA; --SOLES
        l_id_moneda_tc:=9;

        -- Obtiene IGV de la fecha actual
        --select FC_IGV(CURRENT_DATE ) into l_igv from dual;
       
       	-- Obtiene el impuesto de la fecha actual   --agregado por Ulices
        select ELISEO.FC_IMPUESTO(P_ID_ENTIDAD, CURRENT_DATE) into STRICT l_igv;   --agregado por Ulices
        -- Obtiene tipo de cambio del dia
        select FC_TIPOCAMBIO(l_id_moneda_tc,CURRENT_DATE,'D' ) into STRICT l_tc;
        if coalesce(l_tc::text, '') = '' then
            l_tc:=0;
        end if;

       --========================= CONFIG TO VISA ONLINE=====================================
        IF P_ID_PERSONA = 2 THEN  -- USUARIO VISA ONLINE
	        SELECT COUNT(1) INTO STRICT l_contar FROM FIN_DOCUMENTO_DEPTO
	        WHERE ID_ENTIDAD = P_ID_ENTIDAD
	        AND ID_DEPTO = P_ID_DEPTO
	        AND ID_COMPROBANTE = P_ID_COMPROBANTE;
	
	        if l_contar <> 1 THEN
	         	L_ERROR := 1;
	        	L_MSGERROR := 'Alto! Solo debe haber un documento activo de venta para el usuario VISA. [tipo de documento: '||P_ID_COMPROBANTE||']';
	        END IF;
        ELSE
	        SELECT pkg_sales_fc_documento_impresion_user(P_ID_PERSONA,P_ID_COMPROBANTE,P_ID_ENTIDAD,P_ID_DEPTO) INTO STRICT L_DOCUMENTO;
	        IF L_DOCUMENTO = 0 THEN
	            L_ERROR :=1;
	            L_MSGERROR := 'Alto! El usuario no tiene asignado un punto de impresi√≥n para el tipo de documento: ' || P_ID_COMPROBANTE;
	        END IF;
	    END IF;
        --========================= CONFIG TO VISA ONLINE=====================================
        
        -- L_ERROR := 1;
        -- L_MSGERROR:= P_ID_COMPROBANTE;
        IF L_ERROR = 0 THEN
            RAISE NOTICE 'AQUI .... ';
            RAISE NOTICE '%', P_ID_CLIENTE;
            RAISE NOTICE '%', P_ID_CLIENTE_LEGAL;
            RAISE NOTICE 'HASTA AQUI .... ';

            IF P_ID_VENTA = 0 THEN
                INSERT INTO VENTA(
                -- ID_VENTA, 
                ID_PERSONA,
                ID_ENTIDAD,
                ID_DEPTO,
                ID_ANHO,
                ID_MES,
                ID_COMPROBANTE, 
                ID_IGV, 
                ID_MONEDA, 
                ID_LEYENDA,
                ID_CLIENTE,
                ID_CLIENTE_LEGAL,
                TIPOCAMBIO,
                SERIE, 
                NUMERO, 
                FECHA,
                GLOSA,
                ESTADO,
                ID_TIPOTRANSACCION
                )VALUES (
                -- l_cont,
                P_ID_PERSONA,
                P_ID_ENTIDAD,
                P_ID_DEPTO,
                P_ID_ANHO,
                P_ID_MES,
                P_ID_COMPROBANTE,
                l_igv,
                l_id_moneda,-- SOLES
                '1000',
                P_ID_CLIENTE,
                P_ID_CLIENTE_LEGAL,
                l_tc,
                '-',-- SERIE
                '-',-- NRO
                clock_timestamp(),
                'MENSUALIDAD.',
                0, --
                163
                ) RETURNING ID_VENTA INTO L_ID_VENTA;

            ELSE 
                UPDATE
                    VENTA
                    SET ID_CLIENTE = P_ID_CLIENTE,
                        ID_CLIENTE_LEGAL = P_ID_CLIENTE_LEGAL,
                        ID_COMPROBANTE = P_ID_COMPROBANTE
                WHERE ID_VENTA = P_ID_VENTA;

            L_ID_VENTA := P_ID_VENTA;
            END IF;

        END IF;

        P_ID_VENTA := L_ID_VENTA;
        P_ERROR := L_ERROR;
        P_MSGERROR := L_MSGERROR;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_school_sp_crear_venta (P_ID_PERSONA bigint,P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint, P_ID_CLIENTE bigint,P_ID_CLIENTE_LEGAL bigint,P_ID_COMPROBANTE text, P_ID_MONEDA bigint, P_ID_VENTA INOUT bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
