-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_human_talent,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_human_talent_sp_genera_control_culto (P_ID_ENTIDAD bigint) AS $body$
DECLARE

    l_id bigint;
    l_nrodia varchar(3);

BEGIN
  
    select coalesce(max(ID_CONTROL_CULTO),0) into STRICT l_id from APS_CONTROL_CULTO;

    select
            to_char(clock_timestamp(),'D') as dias
            into STRICT l_nrodia
;

    if l_nrodia not in ('1','7') then

      insert into aps_control_culto(
      ID_CONTROL_CULTO,
      ID_PERSONA,
      ID_ENTIDAD,
      ID_DEPTO,
      FEC_FECHA,
      LETRA,
      NUMERO,
      ASISTENCIA,
      ASISTENCIA_CULTO,
      ESTADO,
      ACCION
      )
      SELECT 
      row_number() OVER () + l_id AS ID_CONTROL_CULTO,
      w.ID_PERSONA,
      w.ID_ENTIDAD,
      w.ID_DEPTO,
      clock_timestamp(),
      w.LETRA,
      w.NUMERO,
      w.confianza,--0,1
      w.confianza,--0,1
      'R',--'R:Registrado,'J:justificado'
      '0'--0 control no registrado  1 control registrado para los casos
      from (
      select
        a.ID_PERSONA,
        a.ID_ENTIDAD,
        a.ID_DEPTO,
        a.LETRA,
        a.NUMERO,
        case when coalesce(a.confianza,'0')='1' then 1 else 0 end as confianza
        from aps_trabajador a
        where a.id_entidad=P_ID_ENTIDAD
        AND a.ID_PERSONA IN(
          SELECT x.ID_PERSONA FROM APS_EMPLEADO  x
          WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
          AND x.ID_DEPTO=a.ID_DEPTO
          AND x.estado='A'
        ) AND a.ID_PERSONA NOT IN(
          SELECT ID_PERSONA FROM aps_control_culto
          WHERE to_char(FEC_FECHA,'DDMMYYYY') = to_char(SYSDATE,'DDMMYYYY')
        )
        and a.id_depto is not null
      )w;
  end if;
  END pkg_human_talent_sp_genera_control_culto;
  
  
  PROCEDURE pkg_human_talent_sp_genera_control_culto_limp(P_ID_ENTIDAD numeric) IS
    l_id numeric;
    l_nrodia varchar(3);
  BEGIN
  
    select coalesce(max(ID_CONTROL),0) into l_id from SERV_CONTROL;

    select 
            to_char(sysdate,'D') as dias
            into l_nrodia
            from dual;
            
    --if l_nrodia not in('1','7') then
      insert into SERV_CONTROL(
      ID_CONTROL,
      ID_GRUPO,
      ID_PERSONA,
      FECHA,
      ASISTENCIA,
      ASISTENCIA_CULTO,
      ESTADO,
      ACCION
      )
      select 
      ROWNUM + l_id AS ID_CONTROL,
      w.ID_GRUPO,
      w.ID_PERSONA,
      sysdate,
      0,--0,1
      0,--0,1
      'R',--'R:Registrado,'J:justificado'
      '0'--0 control no registrado  1 control registrado para los casos
      from (
      SELECT
        a.ID_PERSONA,
        a.ID_GRUPO
        FROM SERV_GRUPO_INTEGRANTES a,SERV_GRUPO G
        where A.ID_GRUPO=G.ID_GRUPO
        AND G.id_entidad=P_ID_ENTIDAD
        AND a.ID_PERSONA IN (
          SELECT x.ID_PERSONA FROM APS_EMPLEADO  x
          WHERE X.ID_ENTIDAD=P_ID_ENTIDAD
          AND x.ID_DEPTO='12010102'
          AND x.estado='A'
        ) AND a.ID_PERSONA NOT IN (
          SELECT ID_PERSONA FROM SERV_CONTROL
          WHERE to_char(FECHA,'DDMMYYYY') = to_char(clock_timestamp(),'DDMMYYYY') 
        ) 
      )w;
  --end if;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_human_talent_sp_genera_control_culto (P_ID_ENTIDAD bigint) FROM PUBLIC;
