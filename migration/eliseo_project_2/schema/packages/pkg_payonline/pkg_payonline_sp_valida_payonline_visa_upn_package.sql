-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_payonline,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_payonline_sp_valida_payonline_visa_upn ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_contar bigint:=0;

        l_id_visa bigint;

    
BEGIN
	    
	    l_error:=1;
	  l_msgerror:='En migración.';
-- 	  goto salida_val;
	
	 
	   -- VALIDACIONES PAYONLINE
	     
	      SELECT  count(1), MAX(ID_VISA) into STRICT l_contar, l_id_visa FROM PAYONLINE_VISA
	      WHERE ID_ENTIDAD = P_ID_ENTIDAD
	      AND ID_DEPTO =P_ID_DEPTO;

	      if l_contar < 1 then
	          l_error:=1;
	          l_msgerror:='Alto: No existe un payonline VISA configurado para la entidad: '||P_ID_ENTIDAD::text|| ', y el depto: ' || P_ID_DEPTO::text;
-- 	          GOTO salida_val;
	      elsif l_contar > 1 then
	          l_error:=1;
	          l_msgerror:='Alto: Existe más de un payonline VISA configurado para la entidad: '||P_ID_ENTIDAD::text|| ', y el depto: ' || P_ID_DEPTO::text;
-- 	          GOTO salida_val;
	      end if;
	
	      SELECT  count(1) into STRICT l_contar FROM PAYONLINE_VISA_ORDEN
	      WHERE ID_VISA = l_id_visa;

	      if l_contar < 1 then
	          l_error:=1;
	          l_msgerror:='Alto: No existe un payonline visa orden, configurado para el payonline de la entidad: '||P_ID_ENTIDAD::text|| ', y el depto: ' || P_ID_DEPTO::text;
-- 	          GOTO salida_val;
	      elsif l_contar > 1 then
	          l_error:=1;
	          l_msgerror:='Alto: Existe más de un payonline visa orden, configurado para el payonline de la entidad: '||P_ID_ENTIDAD::text|| ', y el depto: ' || P_ID_DEPTO::text;
-- 	          GOTO salida_val;
	      end if;
	
	     
--        <<salida_val>> 
       P_ERROR:=l_error;
       P_MSGERROR:=l_msgerror;

      
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_payonline_sp_valida_payonline_visa_upn ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
