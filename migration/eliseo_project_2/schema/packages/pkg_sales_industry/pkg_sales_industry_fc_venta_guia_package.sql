-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_industry,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_industry_fc_venta_guia (P_ID_VENTA_GUIA bigint) RETURNS text AS $body$
DECLARE

        S_DETALLE 		text;
        S_VENTA         varchar(4000);
        S_CONTA         integer;
        S_TIPODOC       varchar(2);
        S_ID_RUC      varchar(20);
        S_ERROR         varchar(1) := 'N';

        VENTA REFCURSOR;

	    
BEGIN  
	    S_CONTA:=0;
	    SELECT COALESCE(MAX(M.ID_RUC),'') INTO STRICT S_ID_RUC FROM VENTA_GUIA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
	    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
	    AND E.ID_EMPRESA = M.ID_EMPRESA
	    AND V.ID_VENTA_GUIA = P_ID_VENTA_GUIA;
	
	    open VENTA FOR  
		  	SELECT distinct'CG'||
		  	    --'|'||'0200'||
		        
		        --'|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO|| --1
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')|| --2
		        '|'||'09'||  --3
		        '|'||COALESCE(A.INFO_ADICIONAL,'')|| --4 
		        '|'|| --5
		        '|'|| --6
		        '|'||B.SERIE||'-'||B.NUMERO|| --7
		        '|'||B.ID_COMPROBANTE|| --8
		        --
		        '|'||A.NUM_DOCUMENTO|| --9
		        '|'||A.ID_TIPODOCUMENTO|| --10
		        '|'||trim(both FC_NOMBRE_PERSONA(A.ID_PERSONA))|| --11
		        --
		        '|'||A.NUM_DOCUMENTODES|| --12
		        '|'||A.ID_TIPODOCUMENTODES|| --13
		        '|'||trim(both FC_NOMBRE_PERSONA(A.ID_DESTINO))|| --14
		        --
		        '|'||COALESCE(A.NUM_DOCUMENTOPRO,'')|| --15
		        '|'||COALESCE(A.ID_TIPODOCUMENTOPRO::text,'')|| --16
		        '|'||trim(both FC_NOMBRE_PERSONA(A.ID_PROVEEDOR))|| --17
		        --
		        '|'||C.CODIGO_SUNAT|| --18
		        '|'||(CASE WHEN A.TRANSBORDO_PROGRAMADO = '1' THEN 'True' ELSE 'False' END)|| --19
		        '|'||A.BRUTO_TOTAL|| --20
		        '|'||D.CODIGO_SUNAT|| -- Unidad de medida --21
		        '|'||A.NRO_BULTOS|| --22
		        '|'||E.CODIGO_SUNAT|| -- Codigo modalidad traslado --23
		        '|'||TO_CHAR(A.FEC_INICIO_TRASLADO,'YYYY-MM-DD')|| --24
		        --
		        '|'||A.NUM_DOCUMENTOTRA|| --25
		        '|'||trim(both FC_NOMBRE_PERSONA(A.ID_TRANSPORTISTA))|| --26
		        '|'||A.PLACA|| --27
		        '|'||A.REGISTRO_MTC|| --28
		        '|'||A.ID_UBIGEO_LLEG|| --29
		        '|'||A.DIRECCION_LLEG|| --30
		        '|'||A.ID_UBIGEO_PAR|| --31
		        '|'||A.DIRECCION_PAR|| --32
		        '|'||A.NUM_CONTENEDOR|| --33
		        '|'||A.PUERTO_AEROPUERTO|| --34
		        '|'||COALESCE(A.EMAIL_CLIENTE,'')|| --35
		        '|'||A.INFO_ADICIONAL|| --36
		        --
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN A.ID_TIPODOCUMENTOCON::text ELSE '' END)||
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN A.NUM_DOCUMENTOCON ELSE '' END)||
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN trim(both FC_NOMBRE_PERSONA(A.ID_CONDUCTOR)) ELSE '' END)|| -- NOMBRE
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN trim(both FC_NOMBRE_PERSONA(A.ID_CONDUCTOR)) ELSE '' END)|| -- APELLIDOS
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN A.NUM_LICENCIA ELSE '' END)||
		        '|0000'||
		        '|'||  
		        '|'||  
		        '|' CAB 
		        FROM VENTA_GUIA A
		        LEFT JOIN VENTA_GUIA_REF B ON A.ID_VENTA_GUIA=B.ID_VENTA_GUIA
		        LEFT JOIN TIPO_MOTIVO_TRASLADO C ON A.ID_MOTIVOTRASLADO=C.ID_MOTIVOTRASLADO
		        LEFT JOIN INVENTARIO_UNIDAD_MEDIDA D ON A.ID_UNIDADMEDIDA=D.ID_UNIDADMEDIDA
		        LEFT JOIN TIPO_MOD_TRASLADO E ON A.ID_TIPO_MOD_TRASLADO=E.ID_TIPO_MOD_TRASLADO
		        WHERE A.ID_VENTA_GUIA = P_ID_VENTA_GUIA
		        AND A.ESTADO = 1 		
				
UNION ALL

	         	SELECT  'DG'||	'|'||ROWNUM||
	         				'|'||(case when length(trim(both to_char(b.cantidad,'9999999990D99')))=3 then 0||trim(both to_char(b.cantidad,'9999999990D99'))else trim(both to_char(b.cantidad,'9999999990D99')) END)|| 
	         				'|'||B.CODUM_SUNAT|| 
							'|'||COALESCE(B.DESCRIPCION, 'Venta') ||
							'|'||COALESCE(B.CODIGO_ITEM, '55101528' || LPAD(ROW_NUMBER() OVER (ORDER BY NULL), 8, '0')) ||
							'|'||COALESCE(B.CODIGO_SUNAT, '55101528') ||
							'|'||
	                        '|'||(CASE WHEN A.ID_MOTIVOTRASLADO =12 THEN '7020' ELSE '' END) || 
	                        '|' DET 			
	                FROM VENTA_GUIA A
	                INNER JOIN VENTA_GUIA_DET B ON A.ID_VENTA_GUIA = B.ID_VENTA_GUIA    
	                WHERE A.ID_VENTA_GUIA = P_ID_VENTA_GUIA  
	                AND A.ESTADO = 1
		        	;
	
        fetch VENTA into S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                BEGIN
                    IF S_ERROR = 'N' THEN
                        S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                    END IF;
                EXCEPTION
                WHEN OTHERS THEN
                    S_DETALLE :='';
                    S_ERROR := 'S';
                END;
            END IF;
            S_CONTA:=S_CONTA+1;

        fetch VENTA into S_VENTA;
        end loop;
        close VENTA;	

       RETURN(S_DETALLE);
       --RETURN (S_DETALLE);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_industry_fc_venta_guia (P_ID_VENTA_GUIA bigint) FROM PUBLIC;
