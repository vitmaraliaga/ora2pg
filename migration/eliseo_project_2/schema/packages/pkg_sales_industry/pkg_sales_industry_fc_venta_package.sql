-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_industry,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_industry_fc_venta (P_ID_VENTA bigint) RETURNS text AS $body$
DECLARE

        S_DETALLE 		text;
        S_VENTA         varchar(4000);
        S_CONTA         integer;
        S_TIPODOC       varchar(2);
        S_ID_RUC      varchar(20);
        S_ERROR         varchar(1) := 'N';

        VENTA REFCURSOR;

	    
BEGIN  
	    S_CONTA:=0;
	    SELECT COALESCE(MAX(M.ID_RUC),'') INTO STRICT S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
	    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
	    AND E.ID_EMPRESA = M.ID_EMPRESA
	    AND V.ID_VENTA = P_ID_VENTA;
	
	    SELECT ID_COMPROBANTE INTO STRICT S_TIPODOC FROM VENTA WHERE ID_VENTA=P_ID_VENTA;

	    IF S_TIPODOC='03' THEN  -- BOLETA
	           --VENTAS SERVICIOS
	        open VENTA FOR
	        SELECT distinct'CB'||
	            '|'||'0101'||
	            '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
	            '|'||'03'|| 
	            '|'||A.SERIE||'-'||A.NUMERO||
	            '|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
	            '|'||S_ID_RUC|| 
	            --'|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0)||
	            --'|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000')||
	            --'|'||NVL(TRIM(FC_NOMBRE_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')||
	            --'|'||REGEXP_REPLACE (nvl(TRIM(pkg_sales_facturacion_fc_cliente_direccion(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','')||
	            '|'||REGEXP_REPLACE(CASE WHEN length(A.NRO_DOC_CLI)=8 THEN 1  ELSE 0 END ,'[A-Za-z]*', 'g')||
	            '|'||REGEXP_REPLACE(A.NRO_DOC_CLI,'[A-Za-z]*', 'g')||
	            '|'||REGEXP_REPLACE(COALESCE(A.RAZON_SOCIAL_CLI,'Cliente Varios'),'|','', 'g')||
	            '|'||REGEXP_REPLACE(COALESCE(A.DIRECCION_CLI,'Sin Direccion'),'[-|]','', 'g')||
	            '|'||''|| 
	            '|'||trim(both eliseo.FC_EMAIL(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL)))|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END) END ||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END) END ||
				'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999990D99')),',','.') END) END ||
				'|'||'0.00'|| 
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END) END || 
		        '|'||'1000'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA   
	        AND A.ID_VENTA = P_ID_VENTA 
	        AND A.ESTADO = 1 		
	        
UNION ALL
 
	        SELECT  'DB'||	'|'||ROWNUM||
	                --'|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
	                --'|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||   
		            '|'||CASE WHEN (B.ID_ARTICULO IS NOT NULL AND B.ID_ARTICULO::text <> '') THEN eliseo.FC_CODIGO_ARTICULO(b.id_articulo,'1')
							ELSE '55101528'||lpad(row_number() over (),8,0) END ||   -- Libros religionsos si no hay un id_articulo
					'|'||CASE WHEN (B.ID_ARTICULO IS NOT NULL AND B.ID_ARTICULO::text <> '') THEN COALESCE(eliseo.FC_CODIGO_UNSP(b.id_articulo),'55101528')
							ELSE '55101528' END ||  -- Libros religionsos si no hay un id_articulo
	        		'|'||'NIU'|| 
		            '|'||(case when length(trim(both to_char(b.cantidad,'9999999990D99')))=3 then 0||trim(both to_char(b.cantidad,'9999999990D99'))else trim(both to_char(b.cantidad,'9999999990D99')) END)|| 
		            '|'||coalesce(b.detalle,'Venta Varios')|| 
		            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE_FULL,0) = 0 THEN '0.00' WHEN coalesce(B.PRECIO_BASE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_FULL_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_FULL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') END) END ||
					'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END) END ||
	                --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
	                '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
	                '|'||b.ID_TIPOIGV|| 
	                '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN coalesce(B.BASE,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.BASE_ME,0) = 0 THEN '0.00' WHEN coalesce(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE_ME,0),'9999999990D99')),',','.') END) END ||
	                '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||''|| 
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END) END ||    
			        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END))|| 
					'|'||(CASE WHEN round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5)  = 0 THEN '0.00' WHEN round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5),'9999990D99999')),',','.') END)||  
					'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END) END ||
			        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||			
	                '|'||''|| 
	                '|'||''||
	                '|' DET 			
		        FROM VENTA A, VENTA_DETALLE B  
		        WHERE A.ID_VENTA = B.ID_VENTA    
		        AND A.ID_VENTA = P_ID_VENTA  
		        AND A.ESTADO = 1
                
UNION ALL

                SELECT 
                      'FDP'||'|'||'Credito'||
                      '|'||CASE WHEN ID_MONEDA='7' THEN (CASE  WHEN coalesce(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END) END ||
                      '|'CAB 
                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
                
UNION ALL

                SELECT x.DET FROM (SELECT 
                      --'CUO'||'|'||DECODE(B.NRO_CUOTA,'CUO001','Cuota001','Cuota002')||
                      'CUO'||'|Cuota'||SUBSTR(COALESCE(B.NRO_CUOTA,'CUO001'),4)||
                      '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END) END ||                  
                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
                      '|' DET
                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
                AND A.ID_CREDITO = 2
                ORDER BY B.NRO_CUOTA) x;
	
	        
		ELSIF S_TIPODOC = '01' THEN   -- FACTURA
	        
	        open VENTA FOR  
		  	SELECT distinct'CF'
		  		||'|'
		  		||'0101'||
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		        '|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO||
		        '|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
		        '|'||S_ID_RUC||
		        --'|6'||
		        --'|'||NVL(FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
		        --'|'||FC_NOMBRE_PERSONA(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		        --'|'||REGEXP_REPLACE (nvl(TRIM(pkg_sales_facturacion_fc_cliente_direccion(nvl(nvl(a.id_sucursal,A.ID_CLIENTE_LEGAL),A.ID_CLIENTE))),'Sin Direccion'),'-','')||
		        --'|'||REGEXP_REPLACE(A.ID_TIPODOCUMENTO_CLI,'[A-Za-z]*')||
		        '|6'||
	            '|'||REGEXP_REPLACE(A.NRO_DOC_CLI,'[A-Za-z]*', 'g')||
	            '|'||REGEXP_REPLACE(COALESCE(A.RAZON_SOCIAL_CLI,'Cliente Varios'),'|','', 'g')||
	            '|'||REGEXP_REPLACE(COALESCE(A.DIRECCION_CLI,'Sin Direccion'),'[-|]','', 'g')||
	            '|'||''|| 
		        '|'||trim(both coalesce(eliseo.FC_EMAIL(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END) END ||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END) END ||
				'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END) END ||
				'|'||'0.00'|| 
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END) END || 
		        '|'||'1000'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
		        FROM VENTA A
		        WHERE A.ID_VENTA = P_ID_VENTA 
		        AND A.ESTADO = 1 		
		        
UNION ALL
 
		         SELECT  'DF'||	'|'||ROWNUM||
		                        --'|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
		                        --'|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||  
		                        '|'||CASE WHEN (B.ID_ARTICULO IS NOT NULL AND B.ID_ARTICULO::text <> '') THEN eliseo.FC_CODIGO_ARTICULO(b.id_articulo,'1')
										ELSE '55101528'||lpad(row_number() over (),8,0) END ||   -- Libros religionsos si no hay un id_articulo
								'|'||CASE WHEN (B.ID_ARTICULO IS NOT NULL AND B.ID_ARTICULO::text <> '') THEN COALESCE(eliseo.FC_CODIGO_UNSP(b.id_articulo),'55101528')
										ELSE '55101528' END ||  -- Libros religionsos si no hay un id_articulo
		                   --     '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
		                    --    '|86121503'|| 
		                        '|'||'NIU'|| 
		                         '|'||(case when length(trim(both to_char(b.cantidad,'9999999990D99')))=3 then 0||trim(both to_char(b.cantidad,'9999999990D99'))else trim(both to_char(b.cantidad,'9999999990D99')) END)|| 
		                        '|'||coalesce(b.detalle,'Venta')|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE_FULL,0) = 0 THEN '0.00' WHEN coalesce(B.PRECIO_BASE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_FULL_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_FULL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') END) END ||
	            				'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.PRECIO_ME,0) = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END) END ||
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||b.ID_TIPOIGV|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN coalesce(B.BASE,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.BASE_ME,0) = 0 THEN '0.00' WHEN coalesce(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.BASE_ME,0),'9999999990D99')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||''|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END) END ||    
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END))|| 
    							'|'||(CASE WHEN round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5)  = 0 THEN '0.00' WHEN round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(round((B.DESCUENTO_PORCENTAJE_FULL)::numeric,5),'9999990D99999')),',','.') END)||  
    							'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.PRECIO_BASE_FULL,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.PRECIO_BASE_FULL_ME,0)*coalesce(B.CANTIDAD,0)*coalesce(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||			
		                        '|'||''|| 
		                        '|'||''||
		                        '|' DET 			
		                FROM VENTA A, VENTA_DETALLE B  
		                WHERE A.ID_VENTA = B.ID_VENTA    
		                AND A.ID_VENTA = P_ID_VENTA  
		                AND A.ESTADO = 1
		                
UNION ALL

		                SELECT 
		                      'FDP'||'|'||'Credito'||
		                      '|'||CASE WHEN ID_MONEDA='7' THEN (CASE  WHEN coalesce(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END) END ||
		                      '|'CAB 
		                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
		                
UNION ALL

		                SELECT x.DET FROM (SELECT 
		                      --'CUO'||'|'||DECODE(B.NRO_CUOTA,'CUO001','Cuota001','Cuota002')||
		                      'CUO'||'|Cuota'||SUBSTR(COALESCE(B.NRO_CUOTA,'CUO001'),4)||
		                      '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END) END ||                  
		                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
		                      '|' DET
		                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
		                AND A.ID_CREDITO = 2
		                ORDER BY B.NRO_CUOTA) x;
		
	   END IF;
	
        fetch VENTA into S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                BEGIN
                    IF S_ERROR = 'N' THEN
                        S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                    END IF;
                EXCEPTION
                WHEN OTHERS THEN
                    S_DETALLE :='';
                    S_ERROR := 'S';
                END;
            END IF;
            S_CONTA:=S_CONTA+1;

        fetch VENTA into S_VENTA;
        end loop;
        close VENTA;	

       RETURN(S_DETALLE);
       --RETURN (S_DETALLE);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_industry_fc_venta (P_ID_VENTA bigint) FROM PUBLIC;
