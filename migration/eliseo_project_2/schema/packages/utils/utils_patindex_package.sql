-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,utils,public;




CREATE OR REPLACE FUNCTION eliseo.utils_patindex (p_pattern text, p_expr text, p_format text) RETURNS bigint AS $body$
DECLARE

    v_search_pattern varchar(100);
    v_pos bigint := 0;
    v_charsfmt varchar(20) := 'using chars';
    v_charactersfmt  varchar(20) := 'using characters';
    v_bytesfmt varchar(20) := 'using bytes';
    v_format varchar(20);
    v_errmsg varchar(50) := 'Invalid format: ';

BEGIN
      IF coalesce(p_pattern::text, '') = '' OR coalesce(p_expr::text, '') = '' THEN
         RETURN NULL;
      END IF;

      IF NOT DBMS_DB_VERSION.VER_LE_9_2 THEN
        v_search_pattern := p_pattern;
        v_search_pattern := REPLACE(v_search_pattern, '\', '\\');
        v_search_pattern := REPLACE(v_search_pattern, '*', '\*');
        v_search_pattern := REPLACE(v_search_pattern, '+', '\+');
        v_search_pattern := REPLACE(v_search_pattern, '?', '\?');
        v_search_pattern := REPLACE(v_search_pattern, '|', '\|');
        v_search_pattern := REPLACE(v_search_pattern, '^', '\^');
        v_search_pattern := REPLACE(v_search_pattern, '$', '\$');
        v_search_pattern := REPLACE(v_search_pattern, '.', '\.');
        v_search_pattern := REPLACE(v_search_pattern, '{', '\{');
        v_search_pattern := REPLACE(v_search_pattern, '_', '.');

        v_format := lower(p_format);
        IF v_format = v_charsfmt OR v_format = v_charactersfmt THEN
           IF SUBSTR(v_search_pattern, 1, 1) != '%' AND
              SUBSTR(v_search_pattern, -1, 1) != '%' THEN
               v_search_pattern := '^' || v_search_pattern || '$';
           ELSIF SUBSTR(v_search_pattern, 1, 1) != '%' THEN
               v_search_pattern := '^' || SUBSTR(v_search_pattern, 1, LENGTH(v_search_pattern) - 1);
           ELSIF SUBSTR(v_search_pattern, -1, 1) != '%' THEN
               v_search_pattern := SUBSTR(v_search_pattern, 2) || '$';
           ELSE
               v_search_pattern := SUBSTR(v_search_pattern, 2, LENGTH(v_search_pattern) - 2);
           END IF;
        ELSIF v_format = v_bytesfmt THEN    
           IF substr(v_search_pattern, 1, 1) != '%' AND 
              substr(v_search_pattern, -1, 1) != '%' THEN
               v_search_pattern := '^' || v_search_pattern || '$';
           ELSIF substr(v_search_pattern, 1, 1) != '%' THEN
               v_search_pattern := '^' || substr(v_search_pattern, 1, LENGTHB(v_search_pattern) - 1);
           ELSIF substr(v_search_pattern, -1, 1) != '%' THEN
               v_search_pattern := substr(v_search_pattern, 2) || '$';
           ELSE
               v_search_pattern := substr(v_search_pattern, 2, LENGTHB(v_search_pattern) - 2);
           END IF;
        ELSE
            v_errmsg := v_errmsg || p_format;
            RAISE EXCEPTION '%', v_errmsg USING ERRCODE = '45001';
        END IF;
        v_pos := REGEXP_INSTR(p_expr, v_search_pattern);
      ELSE
        v_pos := 0;
      END IF;

      RETURN v_pos;
EXCEPTION
    WHEN OTHERS THEN
      RAISE EXCEPTION '%', DBMS_UTILITY.FORMAT_ERROR_STACK USING ERRCODE = '45000';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON FUNCTION eliseo.utils_patindex (p_pattern text, p_expr text, p_format text) FROM PUBLIC;
