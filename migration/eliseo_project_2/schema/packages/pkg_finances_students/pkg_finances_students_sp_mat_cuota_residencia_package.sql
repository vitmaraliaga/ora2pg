-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_mat_cuota_residencia (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_semestre_programa bigint;
    l_id_persona bigint;

    l_id_criterio	bigint;
    l_importe	decimal(10,2);
    l_tipo_proceso	varchar(2);
    l_tipo_valor	varchar(2);
    l_id_resid_tipo_habitacion bigint;
    l_id_semestre bigint;
    l_nombre varchar(150);
    l_dc varchar(1);
    l_nom_crit varchar(150);
    l_id_plan_programa bigint;

BEGIN
  
    SELECT ID_SEMESTRE_PROGRAMA,ID_PERSONA, ID_PLAN_PROGRAMA
    INTO STRICT l_id_semestre_programa,l_id_persona,l_id_plan_programa
    FROM DAVID.ACAD_ALUMNO_CONTRATO
    WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

    SELECT ID_SEMESTRE INTO STRICT l_id_semestre FROM DAVID.ACAD_SEMESTRE_PROGRAMA WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa;

    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE
      INTO STRICT
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nom_crit
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

    
    SELECT COUNT(*) INTO STRICT l_contar  FROM VW_MAT_CRITERIO_SEMESTRE WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa AND ID_CRITERIO_PROC=l_id_criterio;
        RAISE NOTICE '%', l_contar;

    IF l_contar=0 THEN
        l_error:=1;
        l_msgerror:='No esta asociado a un a criterio de cobranza de resisdencia';
--         goto cuota_residencia;
    END IF;

    select COUNT(*) INTO STRICT l_contar
    from DAVID.Acad_Reserva_Residencia arr
    inner join DAVID.residencia_habitacion rh on Rh.Id_Habitacion=Arr.Id_Habitacion
    inner join DAVID.Residencia_Bloque rb on Rb.Id_Bloque=Rh.Id_Bloque
    inner join DAVID.residencia_tipo_habitacion rth on Rth.Id_Residencia=Rb.Id_Residencia and Rth.Id_Resid_Tipo_Habitacion=Rh.Id_Resid_Tipo_Habitacion and Rth.Estado='1'
    WHERE rth.ID_CRITERIO IN (
      SELECT ID_CRITERIO  FROM VW_MAT_CRITERIO_SEMESTRE WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa AND ID_CRITERIO_PROC=l_id_criterio
    ) 
    AND arr.ID_SEMESTRE=l_id_semestre
    AND arr.ID_PERSONA=l_id_persona
    and arr.ID_PLAN_PROGRAMA=l_id_plan_programa
    AND arr.ESTADO='6';
        /*dbms_output.put_line(l_id_semestre_programa || 'SEMESTRE PROGAMA');
        dbms_output.put_line(l_id_criterio || 'l_id_criterio');
        dbms_output.put_line(l_id_persona || 'l_id_persona');
        dbms_output.put_line(l_id_plan_programa || 'l_id_plan_programa');

        dbms_output.put_line(l_contar);*/
 
    IF l_contar>0 THEN
      if l_contar=1 then
      
        /*select rth.nombre INTO l_nombre
        from DAVID.Acad_Reserva_Residencia arr
        inner join DAVID.residencia_habitacion rh on Rh.Id_Habitacion=Arr.Id_Habitacion
        inner join DAVID.Residencia_Bloque rb on Rb.Id_Bloque=Rh.Id_Bloque and rh.id_habitacion=1
        inner join DAVID.residencia_tipo_habitacion rth on Rth.Id_Residencia=Rb.Id_Residencia and Rth.Id_Tipo_Habitacion=Rh.Id_Tipo_Habitacion 
        WHERE rth.ID_CRITERIO IN(
          SELECT ID_CRITERIO  FROM VW_MAT_CRITERIO_SEMESTRE WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa AND ID_CRITERIO_PROC=l_id_criterio
        ) 
        AND arr.ID_SEMESTRE=l_id_semestre
        AND arr.ID_PERSONA=l_id_persona
        AND arr.ESTADO='3';*/
    
              
         SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
         WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

         insert into MAT_CONCEPTO_ASIGN_ALUM(
          ID_ALUMNO_CONTRATO,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          TOTAL,
          TIPO_VALOR
          )VALUES (
          P_ID_ALUMNO_CONTRATO,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nom_crit,
          l_dc,
          l_importe,
          l_tipo_valor
          );
      else
        l_error:=1;
        l_msgerror:='Mas de una residencia Reservada';
      end if;

     END IF;

--     <<cuota_residencia>>
    
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_mat_cuota_residencia (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
