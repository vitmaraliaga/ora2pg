-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;

  
  ---descuentos
CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_desctos_alum_contrato (P_ID_ALUMNO_CONTRATO bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

   l_id_semestre_programa bigint;

    l_id_criterio_semestre	bigint;

    l_importe	decimal(10,2);
    l_formula	varchar(4000);
    l_tipo_proceso	varchar(2);

    l_codigo varchar(15);
    l_dc varchar(2);
    l_items bigint:=0;
    l_items_padre bigint:=0;
    l_nombre varchar(150);
    l_tipo_valor varchar(2);

    l_id_criterio	bigint;
    l_numhijo	bigint;
    l_tipo_alumno varchar(5);

    curDES CURSOR FOR
    SELECT
      A.ID_CRITERIO_SEMESTRE,
      A.ID_CRITERIO,
      A.IMPORTE,
      A.FORMULA,
      A.TIPO_PROCESO,
      A.TIPO_VALOR,
      A.DC,
      A.NOMBRE,
      A.ORDEN
    FROM VW_MAT_CRITERIO_SEMESTRE A
    WHERE  A.DC='C'
    AND A.ESTADO='1'
    AND A.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
    AND A.TIPO_ALUMNO=P_TIPO_ALUMNO
    AND coalesce(A.ID_AFECTA,0) IN (
      SELECT
            X.ID_CRITERIO
            FROM VW_MAT_CRITERIO_SEMESTRE X, MAT_CONCEPTO_ASIGN_ALUM Z
            WHERE X.ID_CRITERIO_SEMESTRE=Z.ID_CRITERIO_SEMESTRE
            AND X.DC='D'
            AND X.ESTADO='1'
            AND X.ID_SEMESTRE_PROGRAMA = l_id_semestre_programa
            AND Z.ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO
    ) 
    
    ORDER BY A.DC DESC,A.ORDEN;

 
    l_total decimal(10,2);
    l_total_hijo decimal(10,2);

    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';

    l_id_persona bigint;
    l_orden bigint;

  
BEGIN
  
    SELECT ID_SEMESTRE_PROGRAMA,ID_PERSONA 
    INTO STRICT l_id_semestre_programa,l_id_persona
    FROM DAVID.ACAD_ALUMNO_CONTRATO
    WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

     
    OPEN curDES;
    FETCH curDES INTO l_id_criterio_semestre,l_id_criterio,l_importe,l_formula,l_tipo_proceso,l_tipo_valor,l_dc,l_nombre,l_orden;

    WHILE curDES%FOUND LOOP

      l_total:= 0;

      CASE 
        WHEN l_tipo_proceso = 'PF' OR l_tipo_proceso = 'P'  THEN
         
          EXECUTE 'BEGIN PKG_FINANCES_STUDENTS.'||l_formula||'(:P_ID_ALUMNO_CONTRATO,:P_ID_CRITERIO_SEMESTRE,:P_TIPO_ALUMNO,:l_error,:l_msgerror);end;'
          --INTO l_error,l_msgerror
          USING P_ID_ALUMNO_CONTRATO,l_id_criterio_semestre,P_TIPO_ALUMNO,IN OUT l_error,IN OUT l_msgerror;


          
          if l_error=1 then
            --CLOSE curDES;
            --goto salida_descuento;
             Exit when l_error=1;
          end if;
        WHEN l_tipo_proceso = 'F' then
           SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
           WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

           insert into MAT_CONCEPTO_ASIGN_ALUM(
            ID_ALUMNO_CONTRATO,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES (
            P_ID_ALUMNO_CONTRATO,
            l_id_criterio_semestre,
            l_items,
            l_id_semestre_programa,
            l_nombre,
            l_dc,
            l_importe,
            l_tipo_valor
            );
        WHEN coalesce(l_tipo_proceso::text, '') = '' THEN

           SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
           WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

           insert into MAT_CONCEPTO_ASIGN_ALUM(
            ID_ALUMNO_CONTRATO,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES (
            P_ID_ALUMNO_CONTRATO,
            l_id_criterio_semestre,
            l_items,
            l_id_semestre_programa,
            l_nombre,
            l_dc,
            NULL,
            l_tipo_valor
            );

      END CASE;

      FETCH curDES INTO l_id_criterio_semestre,l_id_criterio,l_importe,l_formula,l_tipo_proceso,l_tipo_valor,l_dc,l_nombre,l_orden;

    END LOOP;
    CLOSE curDES;

--     <<salida_descuento>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_desctos_alum_contrato (P_ID_ALUMNO_CONTRATO bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
