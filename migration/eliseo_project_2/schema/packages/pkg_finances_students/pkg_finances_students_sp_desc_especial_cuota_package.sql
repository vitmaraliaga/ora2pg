-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_desc_especial_cuota (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';

    l_id_semestre_programa bigint;
    l_id_persona bigint;

    l_id_criterio bigint;
    l_importe decimal(10,2);
    l_dc varchar(5);
    l_dias decimal(10,2);
    l_nombre varchar(150);
    l_tipo_valor varchar(2);
    l_tipo_dscto varchar(3);
    l_id_semestre_act bigint;
     l_id_plan_pago_semestre bigint;
     l_cuotas decimal(10,2):=0;

BEGIN
    SELECT ID_SEMESTRE_PROGRAMA,ID_PERSONA ,ID_PLANPAGO_SEMESTRE
    INTO STRICT l_id_semestre_programa,l_id_persona,l_id_plan_pago_semestre
    FROM DAVID.ACAD_ALUMNO_CONTRATO
    WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

    SELECT ID_SEMESTRE INTO STRICT l_id_semestre_act FROM DAVID.ACAD_SEMESTRE_PROGRAMA WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa;

    select 
      COUNT(*) INTO STRICT l_contar
      FROM MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
      WHERE B.ID_PLANPAGO=C.ID_PLANPAGO
      AND B.ID_PLANPAGO_SEMESTRE=l_id_plan_pago_semestre;

    if l_contar>0 then
      select 
      C.CUOTAS INTO STRICT l_cuotas
      FROM MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
      WHERE B.ID_PLANPAGO=C.ID_PLANPAGO
      AND B.ID_PLANPAGO_SEMESTRE=l_id_plan_pago_semestre;
    end if;

    if l_cuotas>1 then
      SELECT 
          ID_CRITERIO,
          DC,
          NOMBRE,
         TIPO_DSCTO
          INTO STRICT
          l_id_criterio,
          l_dc,
          l_nombre,
          l_tipo_dscto
      FROM VW_MAT_CRITERIO_SEMESTRE
      WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

      SELECT COUNT(*) INTO STRICT l_contar 
      FROM FIN_ALUMNO_DESCUENTO_VICE a,FIN_TIPO_DSCTO b 
      WHERE a.tipo_dscto=b.tipo_dscto
      and a.ID_PERSONA=l_id_persona
      and a.tipo_dscto=l_tipo_dscto
      and case when b.consemestre='S' then a.ID_SEMESTRE else l_id_semestre_act end =l_id_semestre_act
      AND a.ESTADO='1';

      IF l_contar>0 THEN
      
        SELECT COALESCE(a.ENSENANZA,0),a.TIPO_ENSE INTO STRICT l_importe,l_tipo_valor 
         FROM FIN_ALUMNO_DESCUENTO_VICE a,FIN_TIPO_DSCTO b 
        WHERE a.tipo_dscto=b.tipo_dscto
        and a.ID_PERSONA=l_id_persona
        and a.tipo_dscto=l_tipo_dscto
        and case when b.consemestre='S' then a.ID_SEMESTRE else l_id_semestre_act end =l_id_semestre_act
        AND a.ESTADO='1';

        
   
        if l_importe>0 then
          
          
          SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
         WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

         insert into MAT_CONCEPTO_ASIGN_ALUM(
          ID_ALUMNO_CONTRATO,
          ID_CRITERIO_SEMESTRE,
          ITEM,
          ID_SEMESTRE_PROGRAMA,
          DESCRIPCION,
          DC,
          TOTAL,
          TIPO_VALOR
          )VALUES (
          P_ID_ALUMNO_CONTRATO,
          P_ID_CRITERIO_SEMESTRE,
          l_items,
          l_id_semestre_programa,
          l_nombre,
          l_dc,
          l_importe,
          l_tipo_valor
          );
        end if;

      END IF;
   end if;
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_desc_especial_cuota (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
