-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_mat_beca18_ciclo (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_semestre_programa bigint;
    l_id_persona bigint;

    l_id_criterio	bigint;
    l_importe	decimal(10,2);
    l_tipo_proceso	varchar(2);
    l_tipo_valor	varchar(2);
    l_nombre varchar(150);
    l_dc varchar(1);
    l_ciclo bigint:=0;

BEGIN
  
    SELECT ID_SEMESTRE_PROGRAMA,ID_PERSONA,ciclo
    INTO STRICT l_id_semestre_programa,l_id_persona,l_ciclo
    FROM DAVID.VW_ACAD_ALUMNO_CONTRATO
    WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

    
    SELECT 
      ID_CRITERIO,
      IMPORTE,
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      nombre
      INTO STRICT
      l_id_criterio,
      l_importe,
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nombre
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

    if l_tipo_proceso = 'P' then
      
      SELECT COUNT(*) INTO STRICT l_contar  FROM MAT_CICLO_COSTO a
      WHERE a.ID_SEMESTRE_PROGRAMA =l_id_semestre_programa
      AND a.ID_CRITERIO=l_id_criterio
      AND a.CICLO= l_ciclo;

      IF l_contar>0 THEN
        if l_contar=1 then
          SELECT a.IMPORTE,a.CICLO::text INTO STRICT l_importe,l_nombre 
          FROM MAT_CICLO_COSTO a
          WHERE a.ID_SEMESTRE_PROGRAMA =l_id_semestre_programa
          AND a.ID_CRITERIO=l_id_criterio
          AND a.CICLO= l_ciclo;

          if coalesce(l_importe,0)=0 then
            l_error:=1;
            l_msgerror:='Costo por ciclo de matrícula igual a cero';
          else
           SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
           WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

           insert into MAT_CONCEPTO_ASIGN_ALUM(
            ID_ALUMNO_CONTRATO,
            ID_CRITERIO_SEMESTRE,
            ITEM,
            ID_SEMESTRE_PROGRAMA,
            DESCRIPCION,
            DC,
            TOTAL,
            TIPO_VALOR
            )VALUES (
            P_ID_ALUMNO_CONTRATO,
            P_ID_CRITERIO_SEMESTRE,
            l_items,
            l_id_semestre_programa,
            'Matrícula ciclo '||l_nombre,
            l_dc,
            l_importe,
            l_tipo_valor
            );
          end if;
        ELSE
          l_error:=1;
          l_msgerror:='Esta asignado más de un costo por ciclo de matrícula';
        END IF;
      ELSE
          l_error:=1;
          l_msgerror:='No esta asignado costo por ciclo de matrícula: '||P_ID_CRITERIO_SEMESTRE;
      END IF;
    else
      if l_importe>0 then
       SELECT COALESCE(MAX(ITEM),0)+1  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
           WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

       insert into MAT_CONCEPTO_ASIGN_ALUM(
        ID_ALUMNO_CONTRATO,
        ID_CRITERIO_SEMESTRE,
        ITEM,
        ID_SEMESTRE_PROGRAMA,
        DESCRIPCION,
        DC,
        TOTAL,
        TIPO_VALOR
        )VALUES (
        P_ID_ALUMNO_CONTRATO,
        P_ID_CRITERIO_SEMESTRE,
        l_items,
        l_id_semestre_programa,
        l_nombre,
        l_dc,
        l_importe,
        l_tipo_valor
        );
      else
        l_error:=1;
        l_msgerror:='No esta asignado costo por ciclo de matrícula';
      end if;
    end if;
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_mat_beca18_ciclo (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
