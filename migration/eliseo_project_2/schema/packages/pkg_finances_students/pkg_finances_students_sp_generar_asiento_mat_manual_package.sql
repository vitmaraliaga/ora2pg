-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_generar_asiento_mat_manual (P_ID_ALUMNO_CONTRATO bigint,P_ID_ENTIDAD bigint,P_ID_VENTA bigint) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_contar bigint;
        l_id_tipoorigen bigint:=1; --venta
        l_fondo varchar(10):='10';
        l_serie varchar(10);
        l_numero varchar(20);
        l_fecha timestamp(0);
        l_voucher bigint;
        l_debito decimal(10,2);
        l_credito decimal(10,2);
        l_glosa varchar(100);
        l_nombre varchar(100);

BEGIN
      
      SELECT SERIE, NUMERO, FECHA,ID_VOUCHER, GLOSA, FC_NOMBRE_PERSONA(ID_CLIENTE) INTO STRICT l_serie,l_numero,l_fecha, l_voucher, l_glosa, l_nombre FROM VENTA WHERE ID_VENTA=P_ID_VENTA;

      INSERT INTO CONTA_ASIENTO(
        ID_TIPOORIGEN,
        ID_ORIGEN, 
        FONDO,
        DEPTO,
        CUENTA, 
        CUENTA_CTE,
        RESTRICCION,
        IMPORTE,
        DESCRIPCION,
        MEMO,
        VOUCHER, 
        PARENT_ID,
        AGRUPA
        )
        SELECT 
        l_id_tipoorigen,
        VD.ID_VDETALLE,
        l_fondo,
        COALESCE(B.ID_DEPTO,A.ID_DEPTO),
        B.ID_CUENTAAASI,
        B.ID_CTACTE,
        B.ID_RESTRICCION,
        (CASE WHEN b.TIPO_DC='C' THEN VD.IMPORTE*(-1) ELSE VD.IMPORTE END)*(b.porcentaje/100),
        CASE WHEN VD.DC='D' THEN (CASE b.TIPO_DC WHEN 'D' THEN 7124||'-'||'(Doc: '||l_serie||'-'||(l_numero)::numeric ||')-'||l_glosa||'-'||l_nombre            ELSE                7124||' - (Doc: '||l_serie||'-'||l_numero||')-'||CS.NOMBRE||to_char(l_fecha,'DD/MM/YYYY')            END)  ELSE (CASE b.TIPO_DC WHEN 'C' THEN 7124||'-'||'(Doc: '||l_serie||'-'||(l_numero)::numeric ||')-'||l_glosa||'-'||l_nombre            ELSE                7124||' - (Doc: '||l_serie||'-'||l_numero||')-'||CS.NOMBRE||' '||to_char(l_fecha,'DD/MM/YYYY')            END) END ,
        (l_id_tipoorigen::text || '-' || VD.ID_VDETALLE::text),
        l_voucher,
        NULL,
        CASE WHEN VD.DC='D' THEN CASE WHEN b.TIPO_DC='C' THEN 'N'  ELSE 'S' END   ELSE CASE WHEN b.TIPO_DC='C' THEN 'S'  ELSE 'N' END  END  AS AGRUPA
        from VW_MAT_CRITERIO_SEMESTRE CS, mat_alumno_contrato_det a, mat_criterio_semestre_asiento b, VENTA_DETALLE VD
        where CS.id_criterio_semestre=A.id_criterio_semestre
        AND a.id_criterio_semestre=b.id_criterio_semestre
        AND A.ID_ALUMNO_CONTRATO=VD.ID_ALUMNO_CONTRATO
        AND A.ID_ALUMNO_CONTRATO_DET=VD.ID_ALUMNO_CONTRATO_DET
        and a.ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO
        AND VD.ID_VENTA =P_ID_VENTA
        --and case when P_APLAZADO='S' then a.aplazado else 'N' end = P_APLAZADO
        AND TO_CHAR(B.FECHA_FIN,'DD/MM/YYYY') = '31/08/2021' 
        ORDER BY A.ID_ALUMNO_CONTRATO_DET,A.DC DESC;

        
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_generar_asiento_mat_manual (P_ID_ALUMNO_CONTRATO bigint,P_ID_ENTIDAD bigint,P_ID_VENTA bigint) FROM PUBLIC;
