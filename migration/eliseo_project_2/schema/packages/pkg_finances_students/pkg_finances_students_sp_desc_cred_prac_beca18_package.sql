-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_finances_students_sp_desc_cred_prac_beca18 (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

    l_items bigint;
    l_contar bigint;
    l_contar1 bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id_semestre_programa bigint;
    l_id_persona bigint;

    l_id_criterio	bigint;
    l_importe	decimal(10,2);
    l_costo	decimal(10,2);
    l_tipo_proceso	varchar(2);
    l_tipo_valor	varchar(2);
    l_id_semestre bigint;
    l_nombre varchar(150);
    l_id_plan_programa bigint;
    l_id_plan bigint;
    l_dc varchar(1);
    l_id_semestre_act bigint;
    l_creditos decimal(10,2);
    l_id_criterio_proc bigint;
    l_id_criterio_semestre bigint;

BEGIN
  
    SELECT ID_SEMESTRE_PROGRAMA,ID_PERSONA,ID_PLAN_PROGRAMA
    INTO STRICT l_id_semestre_programa,l_id_persona,l_id_plan_programa
    FROM DAVID.ACAD_ALUMNO_CONTRATO
    WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

     SELECT ID_SEMESTRE INTO STRICT l_id_semestre_act FROM DAVID.ACAD_SEMESTRE_PROGRAMA WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa;

    
    SELECT 
      TIPO_PROCESO,
      TIPO_VALOR,
      DC,
      NOMBRE,
      id_criterio_proc
      INTO STRICT
      l_tipo_proceso,
      l_tipo_valor,
      l_dc,
      l_nombre,
      l_id_criterio_proc
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=P_ID_CRITERIO_SEMESTRE;

    SELECT 
    count(*)
    INTO STRICT
    l_contar
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND ID_CRITERIO=l_id_criterio_proc;

    if l_contar<>1 then
--       goto salida_desc_cp_b18;
    end if;

    SELECT 
    ID_CRITERIO_SEMESTRE
    INTO STRICT
    l_id_criterio_semestre
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND ID_CRITERIO=l_id_criterio_proc;

    SELECT 
    id_criterio
    INTO STRICT
    l_id_criterio
    FROM VW_MAT_CRITERIO_SEMESTRE
    WHERE ID_CRITERIO_SEMESTRE=l_id_criterio_semestre;

    
    DELETE FROM TT_CURSOS_X_PLAN;

    INSERT INTO TT_CURSOS_X_PLAN(
      ID_ALUMNO_CONTRATO,
      ID_SEMESTRE_PROGRAMA,
      ID_PROGRAMA_ESTUDIO,
      ID_PLAN,
      NOM_PLAN,
      NOM_ESCUELA,
      ID_SEMESTRE,
      CREDITOS
    )
    SELECT ID_ALUMNO_CONTRATO,ID_SEMESTRE_PROGRAMA,ID_PROGRAMA_ESTUDIO,ID_PLAN,NOMBRE,NOMBRE_ESCUELA,ID_SEMESTRE, sum(CP)  as CREDITOS
    FROM VW_MAT_CURSOS_PLAN_ALUMNO
    WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO
    AND DESCUENTO_CREDITO='S'
    AND  ID_CARGA_CURSO IN (
      SELECT
           A.ID_CARGA_CURSO
        FROM DAVID.ACAD_CURSO_ALUMNO A, DAVID.VW_ACAD_CARGA_ACADEMICA B
        WHERE A.ID_CARGA_CURSO=B.ID_CARGA_CURSO
        AND B.ORIGEN='O'
        AND A.ID_PERSONA=l_id_persona
        AND B.ID_SEMESTRE=l_id_semestre_act
        AND B.ID_CURSO_DETALLE NOT IN (  --LO QUE NO SE HA REPROBADO
          SELECT Y.CURSO_EQUIV
          FROM DAVID.ACAD_CURSO_ALUMNO X,
          DAVID.VW_CURSO_EQUIVALENTE Y
          WHERE X.ID_CURSO_DETALLE=Y.ID_CURSO_DETALLE
          AND X.ID_PERSONA=l_id_persona
          AND X.ID_TIPO_CONDICION=2
        ) 
    ) 
    group by ID_ALUMNO_CONTRATO,ID_SEMESTRE_PROGRAMA,ID_PROGRAMA_ESTUDIO,ID_PLAN,NOMBRE,NOMBRE_ESCUELA,ID_SEMESTRE
    ORDER BY CREDITOS;

    
    SELECT ID_PLAN INTO STRICT l_id_plan from DAVID.ACAD_PLAN_PROGRAMA WHERE ID_PLAN_PROGRAMA=l_id_plan_programa;

    
    select coalesce(sum(CREDITOS),0) into STRICT l_creditos from TT_CURSOS_X_PLAN;

    if l_creditos=0 then
--       goto salida_desc_cp_b18;
    end if;

       
     SELECT  coalesce(IMPORTE,0) into STRICT  l_costo  FROM MAT_PLAN_COSTO a
    WHERE a.id_plan=l_id_plan
    AND A.ID_SEMESTRE_PROGRAMA=l_id_semestre_programa
    AND a.ID_CRITERIO=l_id_criterio;

   
    
    SELECT COALESCE(MAX(ITEM),0)  INTO STRICT l_items FROM MAT_CONCEPTO_ASIGN_ALUM
    WHERE ID_ALUMNO_CONTRATO=P_ID_ALUMNO_CONTRATO;

    
    insert into MAT_CONCEPTO_ASIGN_ALUM(
      ID_ALUMNO_CONTRATO,
      ID_CRITERIO_SEMESTRE,
      ITEM,
      ID_SEMESTRE_PROGRAMA,
      DESCRIPCION,
      DC,
      CANTIDAD,
      UNITARIO,
      TOTAL,
      TIPO_VALOR,
      ID_PLAN,
      CREDITOS,
      UNITARIO_CRED
    )VALUES (
    P_ID_ALUMNO_CONTRATO,
    P_ID_CRITERIO_SEMESTRE,
    l_items, 
    l_id_semestre_programa,
    l_nombre,
    l_dc,
    l_creditos,
    l_costo,
    l_creditos*l_costo,
    l_tipo_valor,
    null,
    l_creditos,
    l_costo
    );

--     <<salida_desc_cp_b18>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_finances_students_sp_desc_cred_prac_beca18 (P_ID_ALUMNO_CONTRATO bigint,P_ID_CRITERIO_SEMESTRE bigint,P_TIPO_ALUMNO text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
