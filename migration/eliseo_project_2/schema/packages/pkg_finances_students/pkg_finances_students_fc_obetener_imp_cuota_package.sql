-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_finances_students,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_finances_students_fc_obetener_imp_cuota (P_ID_ALUMNO_CONTRATO bigint) RETURNS bigint AS $body$
DECLARE

    l_cuotas decimal(10,2);
    l_imp_cuota1 decimal(10,2);
    l_imp_cuota2 decimal(10,2);
    l_imp_cuota decimal(10,2):=0;
    l_codigo_mod varchar(10);
    l_creditosvar decimal(10,2);

BEGIN
      SELECT C.CUOTAS,COALESCE(A.CREDITOSVAR,0)
      INTO STRICT l_cuotas,l_creditosvar
      FROM DAVID.ACAD_ALUMNO_CONTRATO A, MAT_PLANPAGO_SEMESTRE B,MAT_PLANPAGO C
      WHERE A.ID_PLANPAGO_SEMESTRE=B.ID_PLANPAGO_SEMESTRE
      AND B.ID_PLANPAGO=C.ID_PLANPAGO
      AND A.ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

      select
       COALESCE(SUM((CASE WHEN x.DC='C' THEN -1 ELSE 1 END)*( x.IMPORTE)),0)/l_cuotas
       into STRICT l_imp_cuota1
      from (SELECT 
          a.importe,
          b.tipo_cobro,
          case when l_codigo_mod = 'V' and l_creditosvar<0 then  
            case when a.dc='D' then 'C' else 'D' end
          else 
            a.dc
          end as DC
        from mat_alumno_contrato_det a,vw_mat_criterio_semestre b 
        where a.id_criterio_semestre=b.id_criterio_semestre
        and a.id_alumno_contrato=P_ID_ALUMNO_CONTRATO
        and b.TIPO_COBRO='M'
        AND B.TIENE_HIJO=0
        and B.RESI_MEN=0
      )x;

    select
       COALESCE(SUM((CASE WHEN x.DC='C' THEN -1 ELSE 1 END)*( x.IMPORTE)),0)/(l_cuotas-1)
       into STRICT l_imp_cuota2
      from (SELECT 
        a.importe,
        b.tipo_cobro,
        case when l_codigo_mod = 'V' and l_creditosvar<0 then  
          case when a.dc='D' then 'C' else 'D' end
        else 
          a.dc
        end as DC
      from mat_alumno_contrato_det a,vw_mat_criterio_semestre b 
      where a.id_criterio_semestre=b.id_criterio_semestre
      and a.id_alumno_contrato=P_ID_ALUMNO_CONTRATO
      and b.TIPO_COBRO='M'
      AND B.TIENE_HIJO=0
      and B.RESI_MEN=1
    )x;
    l_imp_cuota:=l_imp_cuota1 + l_imp_cuota2;

    RETURN(l_imp_cuota);

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_finances_students_fc_obetener_imp_cuota (P_ID_ALUMNO_CONTRATO bigint) FROM PUBLIC;
