-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_estado_resultado_cons (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_ID_MES bigint) AS $body$
DECLARE

        L_ID_NIVEL_PARENT bigint;
        L_ID_NIVEL bigint;
        L_LEVEL bigint;
        L_ID_CUENTA bigint;
        L_ID_CUENTA_PADRE bigint;
        L_IMPORTE decimal(10,2);

        L_NOMBRE_NIVEL_PARENT varchar(100);
        L_NOMBRE_NIVEL varchar(100);
        L_NOMBRE_CUENTA_PARENT varchar(100);
        L_NOMBRE_CUENTA varchar(100);
        L_CODIGO varchar(100);
        L_GRUPO_CUENTA varchar(100);
        L_CANT bigint :=0;
        L_ERROR bigint;

        C_CUENTAS CURSOR FOR
        SELECT 
        ID_CUENTA_PARENT,ID_CUENTA,NOMBRE_CUENTA_PARENT,NOMBRE_CUENTA,SUM(IMPORTE) AS IMPORTE
        FROM EF_ESTADO_RESULTADO WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_ANHO = P_ID_ANHO AND ID_MES = P_ID_MES 
        GROUP BY ID_CUENTA_PARENT,ID_CUENTA,NOMBRE_CUENTA_PARENT,NOMBRE_CUENTA;

        
BEGIN 
            DELETE FROM EF_ESTADO_RESULTADO WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_ANHO = P_ID_ANHO AND ID_MES = P_ID_MES AND ID_NIVEL IN (SELECT ID_NIVEL FROM CONTA_NIVEL WHERE ID_TIPOREPORTE = 5 AND NIVEL = 0);

            SELECT ID_PARENT,ID_NIVEL,NOMBRE,NOMBRE INTO STRICT L_ID_NIVEL_PARENT,L_ID_NIVEL,L_NOMBRE_NIVEL_PARENT,L_NOMBRE_NIVEL
            FROM CONTA_NIVEL WHERE ID_TIPOREPORTE = 5 AND NIVEL = 0 AND (ID_PARENT IS NOT NULL AND ID_PARENT::text <> '');

            OPEN C_CUENTAS;
            FETCH C_CUENTAS INTO L_ID_CUENTA_PADRE,L_ID_CUENTA,L_NOMBRE_CUENTA_PARENT,L_NOMBRE_CUENTA,L_IMPORTE;
                WHILE C_CUENTAS%FOUND LOOP

                INSERT INTO EF_ESTADO_RESULTADO(ID_ENTIDAD,ID_ANHO,ID_MES,ID_NIVEL_PARENT,ID_NIVEL,ID_CUENTA_PARENT,ID_CUENTA,NOMBRE_NIVEL_PARENT,NOMBRE_NIVEL,NOMBRE_CUENTA_PARENT,NOMBRE_CUENTA,IMPORTE )
                VALUES (P_ID_ENTIDAD,P_ID_ANHO,P_ID_MES,L_ID_NIVEL_PARENT,L_ID_NIVEL,L_ID_CUENTA_PADRE,L_ID_CUENTA,L_NOMBRE_NIVEL_PARENT,L_NOMBRE_NIVEL,L_NOMBRE_CUENTA_PARENT,L_NOMBRE_CUENTA,L_IMPORTE);

                        
                --EXCEPTION WHEN OTHERS THEN
                --L_ERROR :=0;
                   -- END;
                    FETCH C_CUENTAS INTO L_ID_CUENTA_PADRE,L_ID_CUENTA,L_NOMBRE_CUENTA_PARENT,L_NOMBRE_CUENTA,L_IMPORTE;
                END LOOP;
            CLOSE C_CUENTAS;
                    
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_estado_resultado_cons (P_ID_ENTIDAD bigint,P_ID_ANHO bigint,P_ID_MES bigint) FROM PUBLIC;
