-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_update_curso_duplicado (P_ID_ENTIDAD bigint) AS $body$
DECLARE


        L_ID_PLAN_CURSO bigint;
        L_ID_CURSO_DETALLE bigint;
        L_ID_TIPO_CONDICION bigint;
        L_ID_PERSONA bigint;
        L_ID_TIPO_TRAMITE bigint;
        L_PROMEDIO decimal(10,2);
        L_CANT bigint;

        L_LISTA CURSOR FOR
        SELECT ID_PLAN_CURSO,ID_CURSO_DETALLE,ID_TIPO_CONDICION,
            ID_PERSONA,ID_TIPO_TRAMITE,PROMEDIO
            --COUNT(1)
        FROM DAVID.ACAD_CURSO_ALUMNO ACA 
        WHERE ACA.ID_TIPO_CONDICION =1 
        GROUP BY ID_PLAN_CURSO,ID_CURSO_DETALLE,ID_TIPO_CONDICION,
        ID_PERSONA, ID_TIPO_TRAMITE,PROMEDIO
        HAVING COUNT(1)>1 
        ORDER BY 1,2,3,4;

        
BEGIN

        OPEN L_LISTA;
        FETCH L_LISTA INTO L_ID_PLAN_CURSO,L_ID_CURSO_DETALLE,L_ID_TIPO_CONDICION,L_ID_PERSONA,L_ID_TIPO_TRAMITE,L_PROMEDIO;
            WHILE L_LISTA%FOUND LOOP

            SELECT COUNT(1) INTO STRICT L_CANT FROM DAVID.ACAD_CURSO_ALUMNO  
            WHERE ID_PLAN_CURSO = L_ID_PLAN_CURSO 
            and ID_CURSO_DETALLE = L_ID_CURSO_DETALLE
            AND ID_TIPO_CONDICION = L_ID_TIPO_CONDICION
            AND ID_PERSONA = L_ID_PERSONA
            AND PROMEDIO =  L_PROMEDIO
            AND ID_TIPO_TRAMITE = L_ID_TIPO_TRAMITE;

            IF L_CANT > 1 THEN
                /*INSERT INTO ACAD_CURSO_ALUMNO_X(ID_CURSO_ALUMNO,
                                              ID_PERSONA,
                                              ID_PLAN_PROGRAMA,
                                              ID_CARGA_CURSO,
                                              ID_CURSO_DETALLE,
                                              ID_HORARIO_PRACTICA,
                                              ID_TIPO_TRAMITE,
                                              ID_TIPO_CONDICION,
                                              ID_PLAN_CURSO,
                                              PROMEDIO,
                                              LOGRO,
                                              ALCANZADO,
                                              CODIGO,
                                              ESTADO,
                                              ID_USUARIO_REG,
                                              FECHA_REGISTRO,
                                              ID_USUARIO_ACT,
                                              FECHA_ACTUALIZACION)
                SELECT ID_CURSO_ALUMNO,
                    ID_PERSONA,
                    ID_PLAN_PROGRAMA,
                    ID_CARGA_CURSO,
                    ID_CURSO_DETALLE,
                    ID_HORARIO_PRACTICA,
                    ID_TIPO_TRAMITE,
                    ID_TIPO_CONDICION,
                    ID_PLAN_CURSO,
                    PROMEDIO,
                    LOGRO,
                    ALCANZADO,
                    CODIGO,
                    ESTADO,
                    ID_USUARIO_REG,
                    FECHA_REGISTRO,
                    ID_USUARIO_ACT,
                    FECHA_ACTUALIZACION 
                FROM DAVID.ACAD_CURSO_ALUMNO  
                WHERE ID_PLAN_CURSO = L_ID_PLAN_CURSO and ID_CURSO_DETALLE = L_ID_CURSO_DETALLE
                AND ID_TIPO_CONDICION = L_ID_TIPO_CONDICION
                AND ID_PERSONA =L_ID_PERSONA 
                AND PROMEDIO = L_PROMEDIO
                AND ROWNUM = 1;
                
                DELETE FROM DAVID.ACAD_CURSO_ALUMNO  
                WHERE ID_PLAN_CURSO = L_ID_PLAN_CURSO and ID_CURSO_DETALLE = L_ID_CURSO_DETALLE
                AND ID_TIPO_CONDICION = L_ID_TIPO_CONDICION
                AND ID_PERSONA =L_ID_PERSONA 
                AND PROMEDIO = L_PROMEDIO
                AND ROWNUM = 1;*/
                UPDATE DAVID.ACAD_CURSO_ALUMNO SET ESTADO = '7'
                WHERE ID_PLAN_CURSO = L_ID_PLAN_CURSO and ID_CURSO_DETALLE = L_ID_CURSO_DETALLE
                AND ID_TIPO_CONDICION = L_ID_TIPO_CONDICION
                AND ID_PERSONA =L_ID_PERSONA 
                AND PROMEDIO = L_PROMEDIO
                AND ID_TIPO_TRAMITE = L_ID_TIPO_TRAMITE  LIMIT 1;
            END IF;

            FETCH L_LISTA INTO L_ID_PLAN_CURSO,L_ID_CURSO_DETALLE,L_ID_TIPO_CONDICION,L_ID_PERSONA,L_ID_TIPO_TRAMITE,L_PROMEDIO;
            END LOOP;
        CLOSE L_LISTA;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_update_curso_duplicado (P_ID_ENTIDAD bigint) FROM PUBLIC;
