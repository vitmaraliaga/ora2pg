-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_cancel_contract (P_ID_ALUMNO_CONTRATO bigint,P_ID_VENTA text,P_ID_USER text,P_OPER text,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_VENTA bigint;
        L_ID_ANHO bigint := 2020;
        L_IMPORTE decimal(10,2);
        L_ERROR bigint;
        L_MSGERROR varchar(200);
        L_CANT bigint;
        L_ID_CLIENTE bigint;
        L_GLOSA varchar(155);

        
BEGIN
            SELECT ID_PERSONA INTO STRICT L_ID_CLIENTE FROM  DAVID.ACAD_ALUMNO_CONTRATO 
            WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

            IF P_OPER = '0' THEN  -- SOLO ANULA LA VENTA SI ESTE CASO 
                SELECT SERIE||'-'||NUMERO||', '||GLOSA,TOTAL INTO STRICT L_GLOSA, L_IMPORTE
                FROM VENTA WHERE ID_VENTA = P_ID_VENTA;

                CALL pkg_sales_sp_anular_ventas(P_ID_VENTA,L_ERROR, L_MSGERROR);
            ELSIF P_OPER = '2' THEN  -- ANULA TRASNFERENCIA
                SELECT SERIE||'-'||NUMERO||', '||GLOSA,IMPORTE INTO STRICT L_GLOSA, L_IMPORTE
                FROM VENTA_TRANSFERENCIA WHERE ID_TRANSFERENCIA = P_ID_VENTA;
                --FALTA ANULAR LA TRANSFERENCIA
                --pkg_sales_sp_anular_transferencia(P_ID_VENTA,L_ERROR,L_MSGERROR);
                L_ERROR := 0;
            ELSE
                L_ERROR := 0;
            END IF;
            IF L_ERROR = 0 THEN
                UPDATE  DAVID.ACAD_ALUMNO_CONTRATO SET ESTADO = 'M'
                WHERE ID_PERSONA = L_ID_CLIENTE
                AND ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

                UPDATE DAVID.ACAD_CURSO_ALUMNO
                SET ESTADO = 'M'
                WHERE ID_CURSO_ALUMNO IN (
                SELECT ACA.ID_CURSO_ALUMNO
                FROM DAVID.ACAD_CURSO_ALUMNO ACA INNER JOIN DAVID.ACAD_CARGA_CURSO ACC ON ACC.ID_CARGA_CURSO=ACA.ID_CARGA_CURSO AND ACA.ESTADO='1'
                INNER JOIN DAVID.ACAD_SEMESTRE_PROGRAMA ASP ON ASP.ID_SEMESTRE_PROGRAMA=ACC.ID_SEMESTRE_PROGRAMA
                INNER JOIN DAVID.ACAD_SEMESTRE ASM ON ASM.ID_SEMESTRE=ASP.ID_SEMESTRE 
                INNER JOIN DAVID.ACAD_ALUMNO_CONTRATO AAC ON AAC.ID_PERSONA=ACA.ID_PERSONA AND AAC.ID_PLAN_PROGRAMA=ACA.ID_PLAN_PROGRAMA
                INNER JOIN DAVID.ACAD_MATRICULA_DETALLE AMD ON AMD.ID_MATRICULA_DETALLE=AAC.ID_MATRICULA_DETALLE AND REPLACE(AMD.ID_MODO_CONTRATO,4,1)=ACC.ID_CURSO_MODO
                INNER JOIN DAVID.ACAD_SEMESTRE_PROGRAMA ASPC ON ASPC.ID_SEMESTRE_PROGRAMA=AAC.ID_SEMESTRE_PROGRAMA AND ASPC.ID_SEMESTRE=ASP.ID_SEMESTRE 
                WHERE AAC.ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO);

                DELETE FROM DAVID.ACAD_ALUMNO_CONTRATO_ADJUNTO WHERE ID_ALUMNO_CONTRATO = P_ID_ALUMNO_CONTRATO;

                INSERT INTO FIN_CONTRATO_BK(ID_ALUMNO_CONTRATO,ID_PERSONA,ID_USER,ID_VENTA,GLOSA,IMPORTE,FECHA)VALUES (P_ID_ALUMNO_CONTRATO,L_ID_CLIENTE,P_ID_USER,P_ID_VENTA,L_GLOSA,L_IMPORTE,clock_timestamp());

                P_ERROR:= 0;
                L_MSGERROR:= 'OK, Contrato Anulado';
                P_MSGERROR:= L_MSGERROR;
             ELSE
                P_ERROR:= L_ERROR;
                P_MSGERROR:= L_MSGERROR;
             END IF;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_cancel_contract (P_ID_ALUMNO_CONTRATO bigint,P_ID_VENTA text,P_ID_USER text,P_OPER text,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
