-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_execute_pago (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_PERSONA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_CLIENTE bigint;
        L_IMPORTE decimal(10,2);
        L_ERROR bigint;
        L_MSGERROR varchar(200);

        L_LISTA CURSOR FOR
        SELECT ID_CLIENTE, SUM(IMPORTE) AS TOTAL 
        FROM VW_SALES_ADVANCES
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_ANHO = P_ID_ANHO
        --AND ID_CLIENTE IN (197577)
        AND ID_CLIENTE IN (SELECT ID_CLIENTE FROM VW_SALES_MOV WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_ANHO = P_ID_ANHO AND ID_TIPOVENTA IN (1,2,3,4) HAVING SUM(TOTAL) > 0  GROUP BY ID_CLIENTE)
        HAVING SUM(IMPORTE) > 0 
        GROUP BY ID_CLIENTE;

        
BEGIN
    
        OPEN L_LISTA;
        FETCH L_LISTA INTO L_ID_CLIENTE,L_IMPORTE;
            WHILE L_LISTA%FOUND LOOP
                CALL pkg_sales_finances_sp_paga_doc_con_anticipo(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_PERSONA,L_ID_CLIENTE,L_ERROR,L_MSGERROR); --ANHO AUTOMATICO
                --pkg_sales_finances_sp_paga_doc_con_anticipo2(P_ID_ENTIDAD,P_ID_DEPTO,P_ID_PERSONA,L_ID_CLIENTE,L_ERROR,L_MSGERROR); --ANHO ESTATICO 2023
            FETCH L_LISTA INTO L_ID_CLIENTE,L_IMPORTE;
            END LOOP;
        CLOSE L_LISTA;
        P_ERROR:=L_ERROR;
        P_MSGERROR:= L_MSGERROR;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_execute_pago (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_PERSONA bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
