-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_finances,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_sales_finances_sp_resultado_alumnos (P_ID_ENTIDAD bigint,P_ID_ANHO bigint) AS $body$
DECLARE

        L_ID_NIVEL bigint;
        L_ID_PROGRAMA_ESTUDIO varchar(20);
        L_ID_SEMESTRE bigint;
        L_SEMESTRE varchar(10);
        L_CANTIDAD bigint;

        C_NIVELES CURSOR FOR
        SELECT ID_NIVEL,ID_PROGRAMA_ESTUDIO FROM CONTA_NIVEL
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_TIPOREPORTE = 3
        AND (ID_PROGRAMA_ESTUDIO IS NOT NULL AND ID_PROGRAMA_ESTUDIO::text <> '');

BEGIN
        
        DELETE FROM CONTA_NIVEL_ALUMNOS WHERE ID_ANHO = P_ID_ANHO;

        OPEN C_NIVELES;
                FETCH C_NIVELES INTO L_ID_NIVEL,L_ID_PROGRAMA_ESTUDIO;
                WHILE C_NIVELES%FOUND LOOP

                    INSERT INTO CONTA_NIVEL_ALUMNOS  --(ID_NIVEL,ID_ANHO,SEMESTRE,CANTIDAD)
                    SELECT L_ID_NIVEL,P_ID_ANHO,B.CODIGO,COUNT(A.ID_ALUMNO_CONTRATO) AS CANTIDAD  --INTO L_SEMESTRE, L_CANTIDAD
                    FROM DAVID.VW_ACAD_ALUMNO_CONTRATO A
                    JOIN DAVID.ACAD_SEMESTRE B ON A.ID_SEMESTRE=B.ID_SEMESTRE
                    WHERE A.ID_SEMESTRE IN (
                        SELECT ID_SEMESTRE FROM DAVID.ACAD_SEMESTRE 
                        WHERE SUBSTR(CODIGO, 0, 4) = P_ID_ANHO AND (CODIGO LIKE '%-1' OR CODIGO LIKE '%-2') 
                    )
                    AND A.ID_PROGRAMA_ESTUDIO IN (L_ID_PROGRAMA_ESTUDIO)
                    AND A.ID_MODO_CONTRATO = 1
                    AND A.ESTADO = '1' 
                    GROUP BY A.ID_SEMESTRE, B.CODIGO, A.ID_PROGRAMA_ESTUDIO, A.NOMBRE_ESCUELA;

                    --INSERT INTO CONTA_NIVEL_ALUMNOS(ID_NIVEL,ID_ANHO,SEMESTRE,CANTIDAD) VALUES(L_ID_NIVEL,P_ID_ANHO,L_SEMESTRE,L_CANTIDAD);
                
                FETCH C_NIVELES INTO L_ID_NIVEL,L_ID_PROGRAMA_ESTUDIO;
                END LOOP;
        CLOSE C_NIVELES;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_sales_finances_sp_resultado_alumnos (P_ID_ENTIDAD bigint,P_ID_ANHO bigint) FROM PUBLIC;
