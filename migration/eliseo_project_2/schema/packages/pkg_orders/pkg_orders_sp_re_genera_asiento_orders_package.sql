-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_orders_sp_re_genera_asiento_orders (P_ID_VOUCHER bigint) AS $body$
DECLARE

        L_ID_PEDIDO bigint;
        L_ID_VOUCHER bigint;
        L_ERROR bigint;
        L_MSN_ERROR varchar(200);

        ASIENTO CURSOR FOR	
        
        SELECT DISTINCT
                C.ID_PEDIDO,A.ID_VOUCHER
        FROM PEDIDO_DESPACHO A JOIN PEDIDO_DETALLE B
        ON A.ID_DETALLE = B.ID_DETALLE
        JOIN PEDIDO_REGISTRO C
        ON B.ID_PEDIDO = C.ID_PEDIDO
        JOIN ORG_SEDE_AREA X
        ON C.ID_AREADESTINO = X.ID_SEDEAREA
        WHERE A.ID_VOUCHER = P_ID_VOUCHER
        AND A.ESTADO = '1'
        AND C.id_tipopedido in (3,4,5,6)
        AND SUBSTR(X.ID_DEPTO,1,1) = '1'
        --AND C.ESTADO = '1'
 
        ORDER BY C.ID_PEDIDO;
        /*
        SELECT DISTINCT
        A.ID_PEDIDO,C.ID_VOUCHER--, A.NUMERO
        FROM PEDIDO_REGISTRO A JOIN PEDIDO_MOVILIDAD B
        ON A.ID_PEDIDO = B.ID_PEDIDO
        JOIN PEDIDO_DESPACHO C
        ON B.ID_MOVILIDAD = C.ID_MOVILIDAD
        WHERE C.ESTADO = '1'
        AND A.ID_TIPOPEDIDO = 5
        AND C.ID_VOUCHER IS NOT NULL;*/
        	

BEGIN 
        
            DELETE FROM CONTA_ASIENTO
            WHERE VOUCHER = P_ID_VOUCHER;

            OPEN ASIENTO;
              FETCH ASIENTO INTO L_ID_PEDIDO,L_ID_VOUCHER;
                WHILE ASIENTO%FOUND LOOP

                    CALL pkg_orders_sp_generar_asiento_orders(L_ID_PEDIDO,L_ID_VOUCHER,L_ERROR,L_MSN_ERROR);

                    FETCH ASIENTO INTO L_ID_PEDIDO,L_ID_VOUCHER;
                END LOOP;
            CLOSE ASIENTO;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_orders_sp_re_genera_asiento_orders (P_ID_VOUCHER bigint) FROM PUBLIC;
