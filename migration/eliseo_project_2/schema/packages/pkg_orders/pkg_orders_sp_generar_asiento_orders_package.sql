-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_orders_sp_generar_asiento_orders (P_ID_PEDIDO bigint,P_ID_VOUCHER bigint,P_ERROR OUT bigint,P_MSN_ERROR OUT text) AS $body$
DECLARE

        L_ID_CUENTAAASI varchar(10);
        L_ID_RESTRICCION varchar(50);
        L_ID_FONDO bigint;
        L_ID_CTACTE varchar(50);
        L_ID_DEPTO varchar(10);
        L_DC varchar(1);
        L_PORCENTAJE decimal(10,2);
        L_GLOSA varchar(150);
        L_NUMERO varchar(10);
        L_FECHA varchar(20);
        L_IMPORTE decimal(10,2);
        L_IMP decimal(10,2);
        l_memo varchar(255);
        l_ref_id varchar(100);
        L_AGRUPA varchar(1);
        L_ID_TIPOPEDIDO bigint;

        ASIENTO CURSOR FOR	
        SELECT 
                ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,ID_CTACTE,ID_DEPTO,DC,PORCENTAJE,GLOSA,coalesce(AGRUPA,'N')
        FROM PEDIDO_ASIENTO
        WHERE ID_PEDIDO = P_ID_PEDIDO;
        	

BEGIN 
            SELECT ID_TIPOPEDIDO,NUMERO,TO_CHAR(FECHA,'DD/MM/YYYY') INTO STRICT L_ID_TIPOPEDIDO,L_NUMERO,L_FECHA
            FROM PEDIDO_REGISTRO
            WHERE ID_PEDIDO = P_ID_PEDIDO;

            IF L_ID_TIPOPEDIDO = 5 THEN
                SELECT 
                    SUM(IMPORTE) INTO STRICT L_IMPORTE
                FROM PEDIDO_DESPACHO
                WHERE ID_MOVILIDAD IN (
                SELECT ID_MOVILIDAD FROM PEDIDO_MOVILIDAD
                WHERE ID_PEDIDO = P_ID_PEDIDO
                )
                AND ID_VOUCHER = P_ID_VOUCHER
                AND ESTADO = '1';
            ELSE
                SELECT
                    SUM(IMPORTE) INTO STRICT L_IMPORTE
                FROM PEDIDO_DESPACHO
                WHERE ID_DETALLE IN (
                SELECT ID_DETALLE FROM PEDIDO_DETALLE
                WHERE ID_PEDIDO = P_ID_PEDIDO
                )
                AND ID_VOUCHER = P_ID_VOUCHER
                AND ESTADO = '1';
            END IF;

            
            
            OPEN ASIENTO;
              FETCH ASIENTO INTO L_ID_CUENTAAASI,L_ID_RESTRICCION,L_ID_FONDO,L_ID_CTACTE,L_ID_DEPTO,L_DC,L_PORCENTAJE,L_GLOSA,L_AGRUPA;
                WHILE ASIENTO%FOUND LOOP
                    IF L_DC = 'C' THEN
                        L_IMP := ROUND(L_IMPORTE*(L_PORCENTAJE/100),2)*-1;
                    ELSE
                        L_IMP := ROUND(L_IMPORTE*(L_PORCENTAJE/100),2);
                    END IF;

                    
                    INSERT INTO CONTA_ASIENTO(ID_TIPOORIGEN,ID_ORIGEN,FONDO,DEPTO,CUENTA,CUENTA_CTE,RESTRICCION,IMPORTE,DESCRIPCION,MEMO,VOUCHER,PARENT_ID,REF_ID,AGRUPA
                        )VALUES ('13',P_ID_PEDIDO,L_ID_FONDO,L_ID_DEPTO,L_ID_CUENTAAASI,L_ID_CTACTE,L_ID_RESTRICCION,L_IMP,
                        L_GLOSA||' - (PI.: '||L_NUMERO||')-'||L_FECHA::text,
                        l_memo,P_ID_VOUCHER,null,l_ref_id, L_AGRUPA
                        );
                    FETCH ASIENTO INTO L_ID_CUENTAAASI,L_ID_RESTRICCION,L_ID_FONDO,L_ID_CTACTE,L_ID_DEPTO,L_DC,L_PORCENTAJE,L_GLOSA,L_AGRUPA;
                END LOOP;
            CLOSE ASIENTO;

        P_ERROR:=0;
        P_MSN_ERROR:='OK';
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_orders_sp_generar_asiento_orders (P_ID_PEDIDO bigint,P_ID_VOUCHER bigint,P_ERROR OUT bigint,P_MSN_ERROR OUT text) FROM PUBLIC;
