-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_orders_sp_orders_delete (P_ID_PERSONA bigint) AS $body$
DECLARE

        L_ID_PROCESO bigint;
        L_ID_ENTIDAD bigint;
        L_ID_DEPTO varchar(10);

BEGIN 
        
            SELECT MAX(ID_ENTIDAD),MAX(ID_DEPTO) INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO
            FROM PEDIDO_REGISTRO
            WHERE     ID_PERSONA = P_ID_PERSONA
            AND coalesce(NUMERO::text, '') = ''
            AND ESTADO = '0'
            AND ID_TIPOPEDIDO BETWEEN 3 AND 6;

            IF (L_ID_ENTIDAD IS NOT NULL AND L_ID_ENTIDAD::text <> '') AND (L_ID_DEPTO IS NOT NULL AND L_ID_DEPTO::text <> '') THEN
                SELECT max(ID_PROCESO) INTO STRICT L_ID_PROCESO
                FROM PROCESS
                WHERE  ID_ENTIDAD = L_ID_ENTIDAD
                AND ID_DEPTO = L_ID_DEPTO 
                AND CODIGO = 6;
            ELSE
--                 goto salida_rapida;
            END IF;


            IF (L_ID_PROCESO IS NOT NULL AND L_ID_PROCESO::text <> '') THEN
            
                DELETE FROM PROCESS_PASO_RUN
                WHERE ID_REGISTRO IN (
                    SELECT ID_REGISTRO
                    FROM PROCESS_RUN
                    WHERE     ID_PROCESO = L_ID_PROCESO
                    AND ID_OPERACION  IN (
                        SELECT ID_PEDIDO
                        FROM PEDIDO_REGISTRO
                        WHERE     ID_PERSONA = P_ID_PERSONA
                        AND coalesce(NUMERO::text, '') = ''
                        AND ESTADO = '0'
                        AND ID_TIPOPEDIDO BETWEEN 3 AND 6
                        AND ID_PEDIDO NOT IN (SELECT ID_PEDIDO FROM PEDIDO_DETALLE) 
                    ) 
                );

                DELETE FROM PROCESS_RUN
                WHERE     ID_PROCESO = L_ID_PROCESO
                AND ID_OPERACION  IN (
                    SELECT ID_PEDIDO
                    FROM PEDIDO_REGISTRO
                    WHERE     ID_PERSONA = P_ID_PERSONA
                    AND coalesce(NUMERO::text, '') = ''
                    AND ESTADO = '0'
                    AND ID_TIPOPEDIDO BETWEEN 3 AND 6
                    AND ID_PEDIDO NOT IN (SELECT ID_PEDIDO FROM PEDIDO_DETALLE)
                );
                DELETE FROM PEDIDO_DETALLE WHERE ID_PEDIDO IN ( SELECT ID_PEDIDO FROM PEDIDO_REGISTRO WHERE ID_PERSONA = P_ID_PERSONA AND coalesce(NUMERO::text, '') = '' AND ESTADO = '0' AND ID_TIPOPEDIDO BETWEEN 3 AND 6 );
                DELETE FROM PEDIDO_MOVILIDAD WHERE ID_PEDIDO IN ( SELECT ID_PEDIDO FROM PEDIDO_REGISTRO WHERE ID_PERSONA = P_ID_PERSONA AND coalesce(NUMERO::text, '') = '' AND ESTADO = '0' AND ID_TIPOPEDIDO BETWEEN 3 AND 6 );
                DELETE FROM PEDIDO_FILE WHERE ID_PEDIDO IN ( SELECT ID_PEDIDO FROM PEDIDO_REGISTRO WHERE ID_PERSONA = P_ID_PERSONA AND coalesce(NUMERO::text, '') = '' AND ESTADO = '0' AND ID_TIPOPEDIDO BETWEEN 3 AND 6 );
                DELETE
                FROM PEDIDO_REGISTRO
                WHERE ID_PERSONA = P_ID_PERSONA
                AND coalesce(NUMERO::text, '') = ''
                AND ESTADO = '0'
                AND ID_TIPOPEDIDO BETWEEN 3 AND 6
                AND ID_PEDIDO NOT IN (SELECT ID_PEDIDO FROM PEDIDO_DETALLE
UNION ALL
 SELECT ID_PEDIDO FROM PEDIDO_MOVILIDAD);
            ELSE
--                 goto salida_rapida;
            END IF;

--             <<salida_rapida>>
            L_ID_PROCESO := L_ID_PROCESO;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_orders_sp_orders_delete (P_ID_PERSONA bigint) FROM PUBLIC;
