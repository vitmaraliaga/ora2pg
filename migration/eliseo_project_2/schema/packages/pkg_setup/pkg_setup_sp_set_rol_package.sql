-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_setup,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_setup_sp_set_rol ( P_ID_ROL bigint, P_ID_PERSONA bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_SET_DEFAULT text, P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

        	l_error bigint:=0;
	        l_msgerror varchar(200):='';
	        l_contar bigint:=0;

BEGIN
	        
		    SELECT COUNT(1) INTO STRICT l_contar FROM ELISEO.CONTA_ENTIDAD_USUARIO WHERE ID_PERSONA =P_ID_PERSONA AND ID_ENTIDAD = P_ID_ENTIDAD;
		   	IF l_contar=0 THEN
		   		INSERT INTO ELISEO.CONTA_ENTIDAD_USUARIO(ID_ENTIDAD,ID_PERSONA,ESTADO)
		   		VALUES (P_ID_ENTIDAD,P_ID_PERSONA,'0');
		   	--ELSE
		   	--	UPDATE ELISEO.CONTA_ENTIDAD_USUARIO SET ESTADO = '0' WHERE ID_PERSONA =P_ID_PERSONA AND ID_ENTIDAD = P_ID_ENTIDAD;
		   	END IF;
		
		    SELECT COUNT(1) INTO STRICT l_contar FROM ELISEO.LAMB_USERS_DEPTO WHERE ID =P_ID_PERSONA AND ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO=P_ID_DEPTO;
		   	IF l_contar=0 THEN
		   		INSERT INTO ELISEO.LAMB_USERS_DEPTO(ID_ENTIDAD,ID,ID_DEPTO,ESTADO, ACTIVO)
		   		VALUES (P_ID_ENTIDAD,P_ID_PERSONA,P_ID_DEPTO,'0','1');
		   	--ELSE
		   	--	UPDATE ELISEO.LAMB_USERS_DEPTO SET ESTADO = '0' WHERE ID =P_ID_PERSONA AND ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO=P_ID_DEPTO;
		   	END IF;
		
		    IF P_SET_DEFAULT = '1' THEN
	        	UPDATE ELISEO.CONTA_ENTIDAD_USUARIO SET ESTADO = '0' WHERE ID_PERSONA =P_ID_PERSONA;
	            UPDATE ELISEO.CONTA_ENTIDAD_USUARIO SET ESTADO = '1' WHERE ID_PERSONA =P_ID_PERSONA AND ID_ENTIDAD = P_ID_ENTIDAD;
	
	            UPDATE ELISEO.LAMB_USERS_DEPTO SET ESTADO = '0' WHERE ID =P_ID_PERSONA AND ID_ENTIDAD = P_ID_ENTIDAD;
	            UPDATE ELISEO.LAMB_USERS_DEPTO SET ESTADO = '1' WHERE ID =P_ID_PERSONA AND ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO=P_ID_DEPTO;
	        END IF;
			
	       SELECT COUNT(1) INTO STRICT l_contar FROM ELISEO.LAMB_USUARIO_ROL WHERE ID_PERSONA =P_ID_PERSONA AND ID_ENTIDAD =P_ID_ENTIDAD AND ID_ROL=P_ID_ROL;
		   	IF l_contar=0 THEN
		   		INSERT INTO ELISEO.LAMB_USUARIO_ROL(ID_ENTIDAD,ID_PERSONA,ID_ROL,ID_USER)
		   		VALUES (P_ID_ENTIDAD,P_ID_PERSONA,P_ID_ROL,P_ID_PERSONA);
		   	END IF;
		
-- 	       <<salida_val>> 
	       P_ERROR:=l_error;
	       P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_setup_sp_set_rol ( P_ID_ROL bigint, P_ID_PERSONA bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_SET_DEFAULT text, P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
