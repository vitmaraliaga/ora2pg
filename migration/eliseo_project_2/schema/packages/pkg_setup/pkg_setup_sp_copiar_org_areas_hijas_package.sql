-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_setup,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_setup_sp_copiar_org_areas_hijas (P_ID_USER bigint,P_ID_ENTIDAD_FROM bigint,P_ID_AREA_FROM bigint, P_ID_ENTIDAD_TO bigint,P_ID_AREA_TO bigint,P_IN_DEPTO bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

		
		L_ERROR bigint:=0;
		L_MSGERROR varchar(5000):='';
		L_ID_PARENT bigint:=NULL;
		L_ID_AREA_NEW bigint:=NULL;
	
		
  ITEM RECORD;

BEGIN
			
			L_ID_PARENT := P_ID_AREA_TO;
		
		   FOR ITEM IN (
		   		SELECT * FROM (WITH RECURSIVE cte AS (
SELECT A.*,1 AS NIVEL_COPIA,(SELECT COUNT(*) FROM ORG_AREA X WHERE X.ID_PARENT=A.ID_AREA ) AS TIENEHIJO
				from ELISEO.ORG_AREA A WHERE ID_AREA = P_ID_AREA_FROM
  UNION ALL
SELECT A.*,(c.level+1) AS NIVEL_COPIA,(SELECT COUNT(*) FROM ORG_AREA X WHERE X.ID_PARENT=A.ID_AREA ) AS TIENEHIJO
				from ELISEO.ORG_AREA A JOIN cte c ON (c.prior ID_AREA = A.ID_PARENT)

) SELECT * FROM cte WHERE ID_ENTIDAD = P_ID_ENTIDAD_FROM) alias2
				WHERE ID_AREA <> P_ID_AREA_FROM AND NIVEL_COPIA = 2
				)
		   LOOP
			   
			  BEGIN
				   INSERT INTO ELISEO.ORG_AREA(ID_PARENT,ID_ENTIDAD,ID_TIPOAREA,NOMBRE,NIVEL,IZQUIERDA,DERECHA,ORDEN,ESTADO,CODIGO,NIVELHIJO,TIPO,GTH,SIGLA)
				   VALUES (L_ID_PARENT,P_ID_ENTIDAD_TO,ITEM.ID_TIPOAREA,ITEM.NOMBRE,ITEM.NIVEL_COPIA,ITEM.IZQUIERDA,ITEM.DERECHA,ITEM.ORDEN,ITEM.ESTADO,ITEM.CODIGO,ITEM.NIVELHIJO,ITEM.TIPO,ITEM.GTH,ITEM.SIGLA)
				   RETURNING ID_AREA INTO L_ID_AREA_NEW;
			  EXCEPTION
			  WHEN unique_violation THEN
				  	L_ERROR := ITEM.ID_AREA;
					L_MSGERROR := 'Se encontró el área de "'||ITEM.NOMBRE||'", registrado con el mismo nombre en la entidad '||P_ID_ENTIDAD_TO||'.';
-- 					GOTO salida_val;
			  WHEN OTHERS THEN
					L_ERROR := ITEM.ID_AREA;
					L_MSGERROR := 'No se pudo registrar el área "'||ITEM.NOMBRE||'" en la entidad '||P_ID_ENTIDAD_TO||' por algún motivo.';
-- 					GOTO salida_val;
			  END;
			  IF P_IN_DEPTO = 1 THEN
			
			  	INSERT INTO ELISEO.ORG_SEDE_AREA(ID_ENTIDAD,ID_DEPTO,ID_SEDE,ID_AREA,ID_PERSONA,ESTADO,CODIGO) 
			  	SELECT P_ID_ENTIDAD_TO,ID_DEPTO,ID_SEDE,L_ID_AREA_NEW,P_ID_USER,ESTADO,CODIGO 
			  	FROM ELISEO.ORG_SEDE_AREA A 
				WHERE ID_AREA = ITEM.ID_AREA AND ID_ENTIDAD = P_ID_ENTIDAD_FROM;
			  	
			  END IF;
			  IF ITEM.TIENEHIJO > 0 THEN
			  		ELISEO.CALL pkg_setup_sp_copiar_org_areas_hijas(P_ID_USER,P_ID_ENTIDAD_FROM,ITEM.ID_AREA,
			  		P_ID_ENTIDAD_TO,L_ID_AREA_NEW,P_IN_DEPTO,L_ERROR,L_MSGERROR);
			  	IF L_ERROR<>0 THEN
-- 			  		GOTO salida_val;
			  	END IF;
			  END IF;
			
		   END LOOP;
	
-- 	  <<salida_val>> 
	   P_ERROR:= L_ERROR;
	   P_MSGERROR:= L_MSGERROR;
	END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_setup_sp_copiar_org_areas_hijas (P_ID_USER bigint,P_ID_ENTIDAD_FROM bigint,P_ID_AREA_FROM bigint, P_ID_ENTIDAD_TO bigint,P_ID_AREA_TO bigint,P_IN_DEPTO bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
