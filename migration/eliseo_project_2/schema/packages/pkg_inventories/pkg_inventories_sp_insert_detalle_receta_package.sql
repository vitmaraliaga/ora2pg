-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_inventories,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_inventories_sp_insert_detalle_receta (P_ID_MOVIMIENTO bigint, P_ID_DINAMICA bigint, P_ERROR OUT bigint,P_MSN_ERROR OUT text) AS $body$
DECLARE

    L_ID_RECETA bigint;
    L_CANTIDAD_R decimal(10,2);
    L_ID_ARTICULO bigint;
    L_CANTIDAD decimal(10,2);
    L_COSTO decimal(10,2);
    N_ERROR bigint;
    L_MSN_ERROR varchar(300);
    L_DATO smallint;
    L_ID_ANHO bigint;

    ARTICULOS CURSOR FOR
    SELECT 
    B.ID_ARTICULO,round((B.CANTIDAD*L_CANTIDAD_R)::numeric,2),C.COSTO
    FROM INVENTARIO_RECETA A, INVENTARIO_RECETA_ARTICULO B, INVENTARIO_ALMACEN_ARTICULO C
    WHERE A.ID_RECETA = B.ID_RECETA
    AND A.ID_ALMACEN = C.ID_ALMACEN
    AND B.ID_ARTICULO = C.ID_ARTICULO
    AND C.ID_ANHO = L_ID_ANHO
    AND A.ID_RECETA = L_ID_RECETA;

BEGIN
        
        SELECT ID_RECETA,CANTIDAD,ID_ANHO INTO STRICT L_ID_RECETA,L_CANTIDAD_R,L_ID_ANHO FROM INVENTARIO_MOVIMIENTO
        WHERE ID_MOVIMIENTO = P_ID_MOVIMIENTO
        AND ESTADO = '0';

        OPEN ARTICULOS;
            FETCH ARTICULOS INTO L_ID_ARTICULO,L_CANTIDAD,L_COSTO;
            WHILE ARTICULOS%FOUND LOOP
                L_DATO :=1;
                CALL pkg_inventories_sp_insert_inventario_detalle(P_ID_MOVIMIENTO, L_ID_ARTICULO,P_ID_DINAMICA, L_CANTIDAD,L_COSTO,N_ERROR,L_MSN_ERROR);
                FETCH ARTICULOS INTO L_ID_ARTICULO,L_CANTIDAD,L_COSTO;
            END LOOP;
        CLOSE ARTICULOS;
        IF L_DATO = 1 THEN 
            P_ERROR:=N_ERROR;
            P_MSN_ERROR:=L_MSN_ERROR;
        ELSE
            P_ERROR:=1;
            P_MSN_ERROR:='LA RECETA NO TIENE ARTICULOS';
        END IF;

      
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_inventories_sp_insert_detalle_receta (P_ID_MOVIMIENTO bigint, P_ID_DINAMICA bigint, P_ERROR OUT bigint,P_MSN_ERROR OUT text) FROM PUBLIC;
