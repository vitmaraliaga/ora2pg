-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_inventories,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_inventories_fc_tipo_operacion (P_ID_TIPOORIGEN bigint,P_ID bigint) RETURNS varchar AS $body$
DECLARE

    P_NOMBRE varchar(100);

BEGIN
        IF P_ID_TIPOORIGEN = 6 THEN  --OPERACION DE ALMACEN
            SELECT 
                    '(DOC: '||A.SERIE||' - '||A.NUMERO||'): '||C.NOMBRE INTO STRICT P_NOMBRE
            FROM INVENTARIO_MOVIMIENTO A JOIN INVENTARIO_DETALLE B 
            ON A.ID_MOVIMIENTO = B.ID_MOVIMIENTO
            JOIN TIPO_OPERACION C
            ON A.ID_TIPOOPERACION = C.ID_TIPOOPERACION
            WHERE B.ID_MOVDETALLE = P_ID;
        END IF;

        IF P_ID_TIPOORIGEN = 1 THEN  --OPERACION DE VENTA
            SELECT 
                    '(DOC: '||COALESCE(C.NOMBRE_CORTO,'') ||'. '||A.SERIE||' - '||A.NUMERO||'): '||CASE WHEN A.ID_COMPROBANTE='01' THEN 'VENTA NACIONAL' WHEN A.ID_COMPROBANTE='03' THEN 'VENTA NACIONAL' END  INTO STRICT P_NOMBRE 
            FROM VENTA A JOIN VENTA_DETALLE B ON A.ID_VENTA = B.ID_VENTA
            LEFT JOIN TIPO_COMPROBANTE C ON A.ID_COMPROBANTE = C.ID_COMPROBANTE 
            WHERE B.ID_VDETALLE = P_ID;
        END IF;

        IF P_ID_TIPOORIGEN = 3 THEN  --OPERACION DE COMPRA
            SELECT 
                    '(DOC: '||COALESCE(C.NOMBRE_CORTO,'') ||'. '||A.SERIE||' - '||A.NUMERO||'): '||CASE WHEN A.ID_COMPROBANTE='01' THEN 'COMPRA NACIONAL' WHEN A.ID_COMPROBANTE='03' THEN 'COMPRA NACIONAL' END  INTO STRICT P_NOMBRE 
            FROM COMPRA A JOIN COMPRA_DETALLE B
            ON A.ID_COMPRA = B.ID_COMPRA
            LEFT JOIN TIPO_COMPROBANTE C ON A.ID_COMPROBANTE = C.ID_COMPROBANTE 
            WHERE B.ID_DETALLE = P_ID;
        END IF;
        IF P_ID_TIPOORIGEN = 13 THEN  --OPERACION DE PEDIDOS INTERNOS
            SELECT
            '(PI: '||A.NUMERO||'):'||'RETIRO'   INTO STRICT P_NOMBRE
            FROM PEDIDO_REGISTRO A JOIN PEDIDO_DETALLE B
            ON A.ID_PEDIDO = B.ID_PEDIDO
            JOIN PEDIDO_DESPACHO C
            ON B.ID_DETALLE = C.ID_DETALLE
            WHERE C.ID_DESPACHO = P_ID;
        END IF;

       IF P_ID_TIPOORIGEN = 21 THEN  --OPERACION DE COMPRA MOVIMIENTO
           	
           	SELECT CASE WHEN cmd.importe = 0 THEN 
	           	'ANULADO | '||'(DOC: '||COALESCE(tc.NOMBRE_CORTO,'') ||'. '||c.SERIE||' - '||c.NUMERO||'): '
	           	||CASE WHEN c.ID_COMPROBANTE='01' THEN 'COMPRA NACIONAL' WHEN c.ID_COMPROBANTE='03' THEN 'COMPRA NACIONAL' END  || '|'||cm.SERIE||' - '||cm.NUMERO
           	ELSE
	           	'(DOC: '||COALESCE(tc.NOMBRE_CORTO,'') ||'. '||c.SERIE||' - '||c.NUMERO||'): '
	           	||CASE WHEN c.ID_COMPROBANTE='01' THEN 'COMPRA NACIONAL' WHEN c.ID_COMPROBANTE='03' THEN 'COMPRA NACIONAL' END  || '|'||cm.SERIE||' - '||cm.NUMERO
           	END  INTO STRICT P_NOMBRE 
           	FROM COMPRA_MOVIMIENTO_DETALLE cmd
			INNER JOIN COMPRA_DETALLE cd ON cd.ID_DETALLE = cmd.ID_CDETALLE
			INNER JOIN COMPRA_MOVIMIENTO cm ON  cmd.ID_CMOVIMIENTO = cm.ID_CMOVIMIENTO
			INNER JOIN COMPRA c ON c.ID_COMPRA = cd.ID_COMPRA
			LEFT JOIN TIPO_COMPROBANTE tc ON c.ID_COMPROBANTE = tc.ID_COMPROBANTE
			WHERE cmd.ID_CMDETALLE = P_ID;
        END IF;
       IF P_ID_TIPOORIGEN = 17 THEN  --OPERACION DE VENTA MOVIMIENTO
           	
           	SELECT CASE WHEN vmd.importe = 0 THEN  'ANULADO | '||'(DOC: '||COALESCE(tc.NOMBRE_CORTO,'') ||'. '||v.SERIE||' - '||v.NUMERO||'): '
           	||top.nombre || '|'||vm.SERIE||' - '||vm.NUMERO
           	ELSE '(DOC: '||COALESCE(tc.NOMBRE_CORTO,'') ||'. '||v.SERIE||' - '||v.NUMERO||'): '
           	||top.nombre || '|'||vm.SERIE||' - '||vm.NUMERO end INTO STRICT P_NOMBRE 
           	FROM VENTA_MOVIMIENTO_DETALLE vmd
			INNER JOIN VENTA_DETALLE vd ON vd.id_vdetalle = vmd.id_vdetalle
			INNER JOIN VENTA_MOVIMIENTO vm ON  vm.id_vmovimiento = vmd.id_vmovimiento
			INNER JOIN venta v ON v.id_venta = vd.id_venta
			LEFT JOIN TIPO_COMPROBANTE tc ON v.ID_COMPROBANTE = tc.ID_COMPROBANTE
			LEFT JOIN TIPO_OPERACION top ON top.id_tipooperacion = vm.id_tipooperacion 
			WHERE vmd.ID_VMDETALLE = P_ID;
        END IF;

        IF P_ID_TIPOORIGEN = 24 THEN  --OPERACION DE UNIONITO.MOVIMIENTO_DETALLE
           	
           	SELECT CASE WHEN md.importe = 0 THEN  'ANULADO | '||'(DOC: '||m.SERIE||' - '||m.NUMERO||'): '
           	||top.nombre  
           	ELSE (CASE WHEN (ot.id_ordentrabajo IS NOT NULL AND ot.id_ordentrabajo::text <> '') THEN	
		           	'(DOC: '|| m.SERIE||' - '||m.NUMERO||'): '
		           	||top.nombre || ' | JOBS: '||ot.SERIE||' - '||ot.NUMERO 
		           	ELSE '(DOC: '|| m.SERIE||' - '||m.NUMERO||'): '
		           	||top.nombre 
		         END)
		     END INTO STRICT P_NOMBRE 
           	FROM UNIONITO.MOVIMIENTO_DETALLE md
			INNER JOIN UNIONITO.MOVIMIENTO m ON m.id_movimiento = md.id_movimiento
			LEFT JOIN  UNIONITO.ORDEN_TRABAJO ot ON  ot.codigo_origen = m.codigo_origen 
			AND ot.id_ordentrabajo = m.id_origen
			LEFT JOIN TIPO_OPERACION top ON top.id_tipooperacion = m.id_tipooperacion 
			WHERE md.id_mdetalle = P_ID;
        END IF;
        /*SELECT NOMBRE INTO P_NOMBRE
        FROM TIPO_OPERACION
        WHERE ID_TIPOOPERACION = P_ID_TIPOOPERACION;*/
        RETURN(P_NOMBRE);
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_inventories_fc_tipo_operacion (P_ID_TIPOORIGEN bigint,P_ID bigint) FROM PUBLIC;
