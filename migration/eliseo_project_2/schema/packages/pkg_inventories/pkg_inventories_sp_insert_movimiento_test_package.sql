-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_inventories,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_inventories_sp_insert_movimiento_test (P_ID_ALMACEN bigint, P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint,P_ID_MES bigint,P_ID_RECETA bigint,P_ID_PERSONA bigint, P_ID_TIPOOPERACION text,P_ID_DOCUMENTO bigint,P_TIPO text,P_IP text,P_CANTIDAD bigint,P_GUIA text, P_ID_MOVIMIENTO OUT bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_MOVIMIENTO integer;
        L_ID_TIPOASIENTO varchar(3) := 'MI';
        L_ID_TIPOVOUCHER bigint := 13;
        L_CONTAR bigint;

BEGIN
        IF P_ID_ENTIDAD = 7124 AND P_ID_DEPTO = '1' THEN
            L_ID_TIPOASIENTO := 'MI';
        ELSIF P_ID_ENTIDAD = 7124 AND P_ID_DEPTO = '4' THEN
            L_ID_TIPOASIENTO := 'MIC';
        ELSIF P_ID_ENTIDAD = 7124 AND P_ID_DEPTO = '5' THEN
            L_ID_TIPOASIENTO := 'MIJ';
        ELSIF P_ID_ENTIDAD = 7124 AND P_ID_DEPTO = '6' THEN
            L_ID_TIPOASIENTO := 'MIT';
        ELSIF P_ID_ENTIDAD = 7124 AND P_ID_DEPTO = '3' THEN  -- Temporal
            L_ID_TIPOASIENTO := 'MII';
        END IF;

        /*
        DELETE FROM INVENTARIO_DETALLE
        WHERE ID_MOVIMIENTO IN (
            SELECT ID_MOVIMIENTO 
            FROM INVENTARIO_MOVIMIENTO
            WHERE ID_ALMACEN = P_ID_ALMACEN
            AND ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_DEPTO = ID_DEPTO
            AND ID_PERSONA = P_ID_PERSONA
            AND ESTADO = '0'
        )
        AND ESTADO = '0';
        
         DELETE FROM INVENTARIO_MOVIMIENTO_ASIENTO
        WHERE ID_MOVIMIENTO IN (
            SELECT ID_MOVIMIENTO 
            FROM INVENTARIO_MOVIMIENTO
            WHERE ID_ALMACEN = P_ID_ALMACEN
            AND ID_ENTIDAD = P_ID_ENTIDAD
            AND ID_DEPTO = ID_DEPTO
            AND ID_PERSONA = P_ID_PERSONA
            AND ESTADO = '0'
        );
        
        DELETE FROM INVENTARIO_MOVIMIENTO
        WHERE ID_ALMACEN = P_ID_ALMACEN
        AND ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = ID_DEPTO
        AND ID_PERSONA = P_ID_PERSONA
        AND ESTADO = '0';
        */
        
        SELECT COUNT(1) INTO STRICT L_CONTAR FROM CONTA_VOUCHER_CONFIG  
        WHERE ID_ENTIDAD=P_ID_ENTIDAD 
        AND ID_DEPTO= P_ID_DEPTO
        AND ID_TIPOASIENTO=L_ID_TIPOASIENTO 
        AND ID_ANHO=P_ID_ANHO
        AND ID_TIPOVOUCHER = L_ID_TIPOVOUCHER;
        IF L_CONTAR > 0 THEN
        
            SELECT coalesce(MAX(ID_MOVIMIENTO),0)+1 INTO STRICT L_ID_MOVIMIENTO FROM INVENTARIO_MOVIMIENTO;

            INSERT INTO INVENTARIO_MOVIMIENTO(ID_MOVIMIENTO,ID_ALMACEN,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_RECETA,ID_PERSONA,ID_TIPOOPERACION,ID_DOCUMENTO,TIPO,FECHA,CANTIDAD,IP,ESTADO,GUIA)
                                        VALUES (L_ID_MOVIMIENTO,P_ID_ALMACEN,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_ANHO,P_ID_MES,P_ID_RECETA,P_ID_PERSONA,P_ID_TIPOOPERACION,P_ID_DOCUMENTO,P_TIPO,clock_timestamp(),P_CANTIDAD,P_IP,'0',P_GUIA) 
                                        RETURNING ID_MOVIMIENTO INTO L_ID_MOVIMIENTO;
            P_ID_MOVIMIENTO := L_ID_MOVIMIENTO;
        ELSE
            P_ID_MOVIMIENTO := NULL;
        END IF;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_inventories_sp_insert_movimiento_test (P_ID_ALMACEN bigint, P_ID_ENTIDAD bigint,P_ID_DEPTO text, P_ID_ANHO bigint,P_ID_MES bigint,P_ID_RECETA bigint,P_ID_PERSONA bigint, P_ID_TIPOOPERACION text,P_ID_DOCUMENTO bigint,P_TIPO text,P_IP text,P_CANTIDAD bigint,P_GUIA text, P_ID_MOVIMIENTO OUT bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
