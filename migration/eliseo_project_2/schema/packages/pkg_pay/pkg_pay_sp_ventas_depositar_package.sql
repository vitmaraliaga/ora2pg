-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pay,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pay_sp_ventas_depositar ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_ANHO bigint, P_ID_PERSONA bigint, P_IMPORE bigint, P_VENTAS OUT text, P_VENTAS_IMP out text, P_TIPO out text ) AS $body$
DECLARE

        L_VENTAS varchar(3000):=NULL;
        L_VENTA_IMP varchar(3000):=NULL;
        L_TIPO varchar(3000):=NULL;
        curventa CURSOR FOR SELECT
        id_venta,
        sum(total) as total,
        tipo
        FROM VW_SALES_MOV
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_ANHO = P_ID_ANHO
        AND ID_CLIENTE = P_ID_PERSONA
        AND ID_TIPOVENTA IN (1,2,3,4) 
        group by id_venta,tipo
        having sum(TOTAL)>0 
        order by tipo,id_venta;

        l_i bigint:=0;
        l_importe decimal(10,2);
        l_saldo decimal(10,2);

BEGIN
      l_importe:= P_IMPORE;
      FOR cur in curventa LOOP
        BEGIN
          if l_importe>0 then
            if l_importe>cur.total then
              l_saldo:=cur.total;
            else
              --l_saldo:=cur.total - l_importe;
              l_saldo:=l_importe;
            end if;
            if l_i=0 then
              L_VENTAS:=cur.id_venta::text;
              L_VENTA_IMP:=l_saldo::text;
              L_TIPO:=cur.tipo;
            else
              L_VENTAS:=L_VENTAS||'|'||cur.id_venta::text;
              L_VENTA_IMP:=L_VENTA_IMP||'|'||l_saldo::text;
              L_TIPO:=L_TIPO||'|'||cur.tipo;
            end if;
            l_importe:= l_importe - cur.total;
            if l_importe<=0 then
              Exit when l_importe<=0;
            end if;
            l_i:=l_i +1;
          end if;

        END;
      END LOOP;
      P_VENTAS:=L_VENTAS;
      --L_VENTA_IMP:=L_VENTAS;
      P_VENTAS_IMP:=L_VENTA_IMP;
      P_TIPO:=L_TIPO;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pay_sp_ventas_depositar ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_ANHO bigint, P_ID_PERSONA bigint, P_IMPORE bigint, P_VENTAS OUT text, P_VENTAS_IMP out text, P_TIPO out text ) FROM PUBLIC;
