-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_pay,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_pay_sp_valida_deposito_tram ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_COMPROBANTE text, P_ID_ANHO bigint, P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_tipoasiento varchar(5) := 'MB';
        l_id_tipovoucher bigint := 1;--5;
        l_id_comprobante varchar(3):='00';  --deposito
        l_serie varchar(4);
        l_correlativo bigint :=0;
        l_contar bigint:=0;

        L_ID_TIPOCOMPROBANTET varchar(4) := '99'; --TRANSFERENCIAS DE VENTAS
        L_ID_TIPOASIENTOT varchar(5):='RV';
        L_ID_TIPOVOUCHERT bigint := 7;
        l_id_dinamica bigint:=0;
        l_glosa varchar(150);

    
BEGIN
        
        SELECT COUNT(1) INTO STRICT l_contar FROM FIN_DOCUMENTO_DEPTO
        WHERE ID_ENTIDAD=P_ID_ENTIDAD
        AND ID_DEPTO=P_ID_DEPTO
        AND ID_COMPROBANTE= P_ID_COMPROBANTE;

        IF l_contar=0 THEN
          l_error:=1;
          l_msgerror:='Alto: No esta configurado documento para entidad y departamento';
--           GOTO salida_val;
        END IF;

        
      SELECT COUNT(1) INTO STRICT l_contar FROM CONTA_VOUCHER_CONFIG
      WHERE ID_ENTIDAD = P_ID_ENTIDAD
      AND ID_DEPTO = P_ID_DEPTO
      AND ID_ANHO = P_ID_ANHO
      AND ID_TIPOVOUCHER = l_id_tipovoucher;

       IF l_contar=0 THEN
          l_error:=1;
          l_msgerror:='Alto: No esta configurado vocuhcer de venta para entidad y departamento';
--           GOTO salida_val;
        END IF;

        l_id_tipovoucher:= 5;

      SELECT COUNT(1) INTO STRICT l_contar FROM CONTA_VOUCHER_CONFIG
      WHERE ID_ENTIDAD = P_ID_ENTIDAD
      AND ID_DEPTO = P_ID_DEPTO
      AND ID_ANHO = P_ID_ANHO
      AND ID_TIPOVOUCHER = l_id_tipovoucher;

       IF l_contar=0 THEN
          l_error:=1;
          l_msgerror:='Alto: No esta configurado vocuhcer de deposito para entidad y departamento';
--           GOTO salida_val;
        END IF;
      --valida vouche
      
         
        SELECT COUNT(1) INTO STRICT l_contar FROM FIN_DOCUMENTO_DEPTO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_COMPROBANTE = l_id_comprobante;

      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Alto: No existe serie y número de documento ('||l_id_comprobante||')';
--           GOTO salida_val;
      end if;

      SELECT COUNT(1) INTO STRICT l_contar FROM FIN_DOCUMENTO_DEPTO
        WHERE ID_ENTIDAD = P_ID_ENTIDAD
        AND ID_DEPTO = P_ID_DEPTO
        AND ID_COMPROBANTE = P_ID_COMPROBANTE;

      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Alto: No existe serie y número de documento ('||P_ID_COMPROBANTE||')';
--           GOTO salida_val;
      end if;

                 
      --valida se esta asignado contador
      SELECT COUNT(1) INTO STRICT l_contar FROM FIN_CONTADOR_DEPTO
      WHERE ID_ENTIDAD = P_ID_ENTIDAD
      AND ID_DEPTO = P_ID_DEPTO;

      IF l_contar = 0 THEN
          l_error:=1; --no existe serie y numero del documento
          l_msgerror:='Alto: Falta Asignar Contador - Sede por Departamento';
--           GOTO salida_val;
      END IF;

         
--        <<salida_val>>
       P_ERROR:=l_error;
       P_MSGERROR:=l_msgerror;

      
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_pay_sp_valida_deposito_tram ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_COMPROBANTE text, P_ID_ANHO bigint, P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
