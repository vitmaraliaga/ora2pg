-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_orders_sp_requerimiento_compra (P_ID_ENTIDAD integer, P_ID_DEPTO text, P_ID_ANHO integer, P_ID_MES integer, P_ID_PERSONA integer, P_ID_TIPOPEDIDO integer, P_ID_AREAORIGEN integer, P_ID_AREADESTINO integer, P_MOTIVO text, P_COMENTARIO text, P_ID_TASK bigint, P_ID_MONEDA bigint, P_ID_PEDIDO OUT integer, P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

        L_ID_PEDIDO bigint;
        L_MSN varchar(200);
        L_ESTADO varchar(1):='0';
        L_NUMERO varchar(10);
        L_ID_AREADESTINO integer;

BEGIN
            IF coalesce(P_ID_AREADESTINO::text, '') = '' OR P_ID_AREADESTINO = 0 THEN
                L_ID_AREADESTINO := NULL;
            ELSE
                L_ID_AREADESTINO := P_ID_AREADESTINO;
            END IF;

            --Para Obtener el Correlativo, vamos a obtener por tipo pediddo: 10 = Pedido Compra, 11 = Stcok
            SELECT LPAD(coalesce(MAX((NUMERO)::numeric ),0)+1,8,0) INTO STRICT L_NUMERO
            FROM PEDIDO_REGISTRO WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND ID_TIPOPEDIDO IN (10,11); --= P_ID_TIPOPEDIDO;
            INSERT INTO PEDIDO_REGISTRO(
                ID_ENTIDAD,--SESSION
                ID_DEPTO,--SESSION
                ID_ANHO,--FUNCTION
                ID_MES,--FUNCTION
                ID_PERSONA,--USER-SESSION
                ID_TIPOPEDIDO,--10 PEDIDO COMPRA-REQUERIMIENTO
                ID_AREAORIGEN,--LOGISTICA
                ID_AREADESTINO,--OPCIONAL
                NUMERO,--FORMATO DE REQUERIMIENTO
                FECHA,--SYSDATE
                FECHA_PEDIDO,--SYSDATE
                MOTIVO,--COMENTARIO
                ESTADO,--0
                COMENTARIO,
                ID_TASK
            ) VALUES (
                P_ID_ENTIDAD,
                P_ID_DEPTO,
                P_ID_ANHO,
                P_ID_MES,
                P_ID_PERSONA,
                P_ID_TIPOPEDIDO,
                P_ID_AREAORIGEN,
                L_ID_AREADESTINO,
                L_NUMERO,
                clock_timestamp(),
                clock_timestamp(),
                P_MOTIVO,
                L_ESTADO,
                P_COMENTARIO,
                P_ID_TASK
                )RETURNING ID_PEDIDO INTO L_ID_PEDIDO;
                P_ID_PEDIDO := L_ID_PEDIDO;
                P_ERROR :=0;
                L_MSN := 'OK';
                P_MSGERROR := L_MSN;
        EXCEPTION
            WHEN OTHERS THEN
            L_MSN := 'ERROR AL REGISTRAR EL REQUERIMIENTO'||SQLSTATE||' -ERROR- '||SQLERRM;
            P_ID_PEDIDO := L_ID_PEDIDO;
            P_ERROR :=1;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_orders_sp_requerimiento_compra (P_ID_ENTIDAD integer, P_ID_DEPTO text, P_ID_ANHO integer, P_ID_MES integer, P_ID_PERSONA integer, P_ID_TIPOPEDIDO integer, P_ID_AREAORIGEN integer, P_ID_AREADESTINO integer, P_MOTIVO text, P_COMENTARIO text, P_ID_TASK bigint, P_ID_MONEDA bigint, P_ID_PEDIDO OUT integer, P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
