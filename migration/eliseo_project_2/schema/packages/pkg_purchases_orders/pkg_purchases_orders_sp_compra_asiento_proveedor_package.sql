-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_orders_sp_compra_asiento_proveedor ( P_ID_COMPRA integer, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

        L_ID_ENTIDAD bigint;
        L_ID_DEPTO_CAMPUS varchar(10);
        L_ID_PROVEEDOR bigint;
        L_ID_TIPOPLAN bigint := 1;
        L_ID_FONDO bigint := 10;
        L_ID_CUENTAAASI varchar(10) := '2130101';
        L_ID_RESTRICCION varchar(10) := '0A';
        L_ID_CTACTE varchar(10) := '1';
        L_ID_DEPTO varchar(10);
        L_DC varchar(1) := 'C';
        L_PORCENTAJE decimal(10,2) := 100;
        L_GLOSA varchar(100) := 'Cuenta Proveedores';
        L_INDICADOR varchar(100) := 'IMPORTE';
        L_AGRUPA varchar(1) := 'S';
        L_NRO_ASIENTO bigint := 1;
        L_EDITABLE varchar(1) := 'S';
        L_ID_TIPOPEDIDO integer;
        L_IMPORTE NUMERIC(10,2);
        L_IMPORTE_ME NUMERIC(10,2);
        L_SERIE varchar(4);
        L_NUMERO varchar(12);
        L_CORRELATIVO varchar(20);
        L_DESCRIPCION varchar(200);

        
BEGIN
            SELECT ID_ENTIDAD,ID_DEPTO,ID_PROVEEDOR,SERIE,NUMERO,IMPORTE,IMPORTE_ME, pkg_purchases_fc_ruc(ID_PROVEEDOR)||'-'||FC_NOMBRE_PERSONA(ID_PROVEEDOR) 
            INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO_CAMPUS,L_ID_PROVEEDOR,L_SERIE,L_NUMERO,L_IMPORTE, L_IMPORTE_ME,L_DESCRIPCION
            FROM COMPRA WHERE ID_COMPRA = P_ID_COMPRA;

            
            L_ID_CUENTAAASI := '2130101';
            IF L_ID_DEPTO_CAMPUS = 1 THEN
                L_ID_DEPTO          := '11010101';
            ELSIF L_ID_DEPTO_CAMPUS = 3 THEN
                L_ID_DEPTO          := '31010101';
            ELSIF L_ID_DEPTO_CAMPUS = 4 THEN
                L_ID_DEPTO          := '41010101';
            ELSIF L_ID_DEPTO_CAMPUS = 5 THEN
                L_ID_DEPTO          := '51010101';
            ELSIF L_ID_DEPTO_CAMPUS = 6 THEN
                L_ID_DEPTO          := '61010101';
            ELSIF L_ID_DEPTO_CAMPUS = 7 THEN
                L_ID_DEPTO          := '71010101';
            ELSE
                L_ID_DEPTO          := '81010101';
            END IF;

            P_ERROR :=0;
            P_MSGERROR := 'OK';

            INSERT INTO COMPRA_ASIENTO(ID_COMPRA,
                                        ID_CUENTAAASI,
                                        ID_RESTRICCION,
                                        ID_CTACTE,
                                        ID_FONDO,
                                        ID_DEPTO,
                                        IMPORTE,
                                        DESCRIPCION,
                                        EDITABLE,
                                        ID_PARENT,
                                        ID_TIPOREGISTRO,
                                        DC,
                                        IMPORTE_ME,
                                        FECHA_ACTUALIZACION,
                                        AGRUPA,
                                        NRO_ASIENTO)
                    VALUES (
                              P_ID_COMPRA,
                              L_ID_CUENTAAASI,
                              L_ID_RESTRICCION,
                              L_ID_CTACTE,
                              L_ID_FONDO,
                              L_ID_DEPTO,
                              L_IMPORTE*-1,
                              SUBSTR((   L_ID_ENTIDAD|| '-'|| L_SERIE|| '-'|| L_NUMERO|| ' | '|| L_DESCRIPCION),1,70),
                              l_EDITABLE,
                              NULL,
                              NULL,
                              L_DC,
                              L_IMPORTE_ME*-1,
                              statement_timestamp(),
                              L_AGRUPA,
                              L_NRO_ASIENTO);
          EXCEPTION
            WHEN OTHERS THEN
            P_MSGERROR := 'ERROR AL REGISTRAR ASIENTO'||SQLSTATE||' -ERROR- '||SQLERRM;
            P_ERROR :=1;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_orders_sp_compra_asiento_proveedor ( P_ID_COMPRA integer, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
