-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_orders_sp_insert_presupuesto (P_ID_ENTIDAD integer) AS $body$
DECLARE

        L_ID_MES bigint;
        L_ID_CUENTAAASI varchar(10);
        L_ID_RESTRICCION varchar(10);
        L_ID_CTACTE varchar(10);
        L_ID_DEPTO varchar(10);
        L_IMPORTE decimal(10,2);
        L_IMP decimal(10,2);
        L_ID_PRESUPUESTO integer;

        
        C_PSPTO CURSOR FOR
        SELECT CUENTA,RESTRICCION,CUENTA_CORRIENTE,DEPTO,IMPORTE FROM PRESUPUESTO_TEST;

        C_MESES CURSOR FOR
        SELECT ID_MES 
        FROM CONTA_MES WHERE ID_MES IN (3,4,5,6,8,9,10,11);

        
BEGIN
                
            OPEN C_PSPTO;
                FETCH C_PSPTO INTO L_ID_CUENTAAASI,L_ID_RESTRICCION,L_ID_CTACTE,L_ID_DEPTO,L_IMPORTE;
                WHILE C_PSPTO%FOUND LOOP

                    L_IMP := L_IMPORTE/8;

                    OPEN C_MESES;
                        FETCH C_MESES INTO L_ID_MES;
                            WHILE C_MESES%FOUND LOOP

                                SELECT MAX(ID_PRESUPUESTO) + 1 INTO STRICT L_ID_PRESUPUESTO FROM CONTA_PRESUPUESTO;

                                INSERT INTO CONTA_PRESUPUESTO(ID_PRESUPUESTO,ID_ANHO,ID_MES,ID_CUENTAAASI,ID_RESTRICCION,ID_FONDO,COS_VALOR,ID_ENTIDAD,ID_CTACTE,ID_DEPTO) 
                                VALUES (L_ID_PRESUPUESTO,2023,L_ID_MES,L_ID_CUENTAAASI,L_ID_RESTRICCION,10,L_IMP,P_ID_ENTIDAD,L_ID_CTACTE,L_ID_DEPTO);

                            FETCH C_MESES INTO L_ID_MES;
                        END LOOP;
                    CLOSE C_MESES;

                    L_IMP := 0;

                    FETCH C_PSPTO INTO L_ID_CUENTAAASI,L_ID_RESTRICCION,L_ID_CTACTE,L_ID_DEPTO,L_IMPORTE;
                END LOOP;
            CLOSE C_PSPTO;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_orders_sp_insert_presupuesto (P_ID_ENTIDAD integer) FROM PUBLIC;
