-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_purchases_orders,public;




CREATE OR REPLACE PROCEDURE eliseo.pkg_purchases_orders_sp_delete_orden_compra (P_ID_ORDEN bigint,P_ERROR OUT bigint,P_MSG OUT text) AS $body$
DECLARE

        L_ID_PEDIDO bigint;
        L_ID_DEXEC bigint;
        L_ID_EXECUTE bigint;
        L_ID_DEXEC_MAX bigint;
        L_ID_PASO_ACTUAL bigint;
        L_ID_PED bigint;

        C_PEDIDOS CURSOR FOR
        SELECT ID_PEDIDO
        FROM (
            SELECT ID_PEDIDO,
            coalesce((SELECT SUM(XX.CANTIDAD) FROM ELISEO.PEDIDO_REQUERIMIENTO XX WHERE XX.ID_PEDIDO = PEDIDO_DETALLE.ID_PEDIDO AND  XX.ID_DETALLE_ORIGEN = PEDIDO_DETALLE.ID_DETALLE), 0) AS C_ENTREGADO, CANTIDAD
            FROM PEDIDO_DETALLE
            WHERE ID_PEDIDO IN (SELECT ID_PEDIDO FROM PEDIDO_REQUERIMIENTO WHERE ID_REQUERIMIENTO = L_ID_PEDIDO )
        ) alias4 GROUP BY ID_PEDIDO
        HAVING(SUM(CANTIDAD) - SUM(C_ENTREGADO)) = 0;

        
BEGIN
            SELECT ID_PEDIDO INTO STRICT L_ID_PEDIDO FROM COMPRA_ORDEN WHERE ID_ORDEN = P_ID_ORDEN;

            SELECT ID_DEXEC INTO STRICT L_ID_DEXEC FROM PEDIDO_REGISTRO WHERE ID_PEDIDO = L_ID_PEDIDO;

            SELECT ID_EXECUTE INTO STRICT L_ID_EXECUTE FROM LAMB_PROCESS_EXEC_PASO WHERE ID_DEXEC = L_ID_DEXEC;

            UPDATE PEDIDO_REGISTRO SET ID_DEXEC  = NULL
            WHERE ID_PEDIDO = L_ID_PEDIDO;

            DELETE FROM LAMB_PROCESS_EXEC_PASO WHERE ID_DEXEC = L_ID_DEXEC;

            SELECT MAX(ID_DEXEC) INTO STRICT L_ID_DEXEC_MAX FROM LAMB_PROCESS_EXEC_PASO WHERE ID_EXECUTE = L_ID_EXECUTE;

            SELECT ID_PASO_ACTUAL INTO STRICT L_ID_PASO_ACTUAL FROM LAMB_PROCESS_EXEC_PASO WHERE ID_DEXEC = L_ID_DEXEC_MAX;

            UPDATE LAMB_PROCESS_EXECUTE SET ID_PASO_ACTUAL = L_ID_PASO_ACTUAL
            WHERE ID_EXECUTE = L_ID_EXECUTE;

            UPDATE PEDIDO_REGISTRO SET ID_DEXEC = L_ID_DEXEC_MAX
            WHERE ID_PEDIDO = L_ID_PEDIDO;

            DELETE FROM COMPRA_ORDEN_DETALLE WHERE ID_ORDEN = P_ID_ORDEN;

            DELETE FROM COMPRA_ORDEN WHERE ID_ORDEN = P_ID_ORDEN;

           	UPDATE PEDIDO_COTIZACION SET ES_ELEGIDO  = NULL, COMENTARIO  = NULL WHERE ID_PEDIDO = L_ID_PEDIDO;

            --UPDATE PEDIDO_FILE SET ESTADO = '1' WHERE ID_PEDIDO = L_ID_PEDIDO;
            
            
            --UPDATE PASO DEL PEDIDO ORIGEN
            OPEN C_PEDIDOS;
                FETCH C_PEDIDOS INTO L_ID_PED;
                WHILE C_PEDIDOS%FOUND LOOP

                    SELECT ID_DEXEC INTO STRICT L_ID_DEXEC FROM PEDIDO_REGISTRO WHERE ID_PEDIDO = L_ID_PED;

                    SELECT ID_EXECUTE INTO STRICT L_ID_EXECUTE FROM LAMB_PROCESS_EXEC_PASO WHERE ID_DEXEC = L_ID_DEXEC;

                    UPDATE PEDIDO_REGISTRO SET ID_DEXEC  = NULL WHERE ID_PEDIDO = L_ID_PED;

                    DELETE FROM LAMB_PROCESS_EXEC_PASO WHERE ID_DEXEC = L_ID_DEXEC;

                    SELECT MAX(ID_DEXEC) INTO STRICT L_ID_DEXEC_MAX FROM LAMB_PROCESS_EXEC_PASO WHERE ID_EXECUTE = L_ID_EXECUTE;

                    SELECT ID_PASO_ACTUAL INTO STRICT L_ID_PASO_ACTUAL FROM LAMB_PROCESS_EXEC_PASO WHERE ID_DEXEC = L_ID_DEXEC_MAX;

                    UPDATE LAMB_PROCESS_EXECUTE SET ID_PASO_ACTUAL = L_ID_PASO_ACTUAL WHERE ID_EXECUTE = L_ID_EXECUTE;

                    UPDATE PEDIDO_REGISTRO SET ID_DEXEC = L_ID_DEXEC_MAX WHERE ID_PEDIDO = L_ID_PED;

                    UPDATE LAMB_PROCESS_EXEC_PASO SET ESTADO = '1' WHERE ID_DEXEC = L_ID_DEXEC_MAX;

                    
                    FETCH C_PEDIDOS INTO L_ID_PED;
                END LOOP;
            CLOSE C_PEDIDOS;

              
            P_MSG := 'OK, ORDEN DE COMPRA ELIMINADA';
            P_ERROR := 0;
        EXCEPTION
            WHEN OTHERS THEN
            P_MSG := 'ERROR AL ELIMINAR ORDEN DE COMPRA '||SQLSTATE||' -ERROR- '||SQLERRM;
            P_ERROR :=1;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eliseo.pkg_purchases_orders_sp_delete_orden_compra (P_ID_ORDEN bigint,P_ERROR OUT bigint,P_MSG OUT text) FROM PUBLIC;
