-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = eliseo,pkg_sales_industry_test,public;




CREATE OR REPLACE FUNCTION eliseo.pkg_sales_industry_test_fc_venta (P_ID_VENTA bigint) RETURNS varchar AS $body$
DECLARE

        S_DETALLE       varchar(4000);
        --S_DETALLE       LONG;
        S_VENTA         varchar(4000);
        --S_VENTA         LONG;
        S_CONTA         integer;
        S_TIPODOC       varchar(2);
        L_ID_TIPOVENTA bigint;
        S_ID_TIPOIGV         varchar(4000);

        S_ID_RUC      varchar(20);
        S_ERROR         varchar(1) := 'N';

        
        VENTA REFCURSOR;

    
BEGIN  
    S_CONTA:=0;
    SELECT COALESCE(MAX(M.ID_RUC),'') INTO STRICT S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
    AND E.ID_EMPRESA = M.ID_EMPRESA
    AND V.ID_VENTA = P_ID_VENTA;

    SELECT ID_COMPROBANTE,ID_TIPOVENTA INTO STRICT S_TIPODOC, L_ID_TIPOVENTA FROM VENTA WHERE ID_VENTA=P_ID_VENTA;
    SELECT MAX(ID_TIPOIGV) INTO STRICT S_ID_TIPOIGV FROM VENTA_DETALLE WHERE ID_VENTA=P_ID_VENTA;

    IF S_ID_TIPOIGV = '10' THEN  --GRABADO
    
	    IF S_TIPODOC='03' THEN  -- BOLETA
	           --VENTAS SERVICIOS
	        open VENTA FOR  
	        SELECT distinct'CB'||'|'||'0101'||
	            '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
	            '|'||'03'|| 
	            '|'||A.SERIE||'-'||A.NUMERO||
	            '|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
	            '|'||S_ID_RUC|| 
	            '|'||CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN 1  ELSE 0 END ||
	            '|'||CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal))  ELSE '0000' END ||
	            '|'||coalesce(trim(both FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')||
	            '|'||REGEXP_REPLACE(coalesce(trim(both pkg_sales_facturacion_fc_cliente_direccion(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','', 'g')||
	            '|'||''|| 
	            '|'||trim(both FC_EMAIL(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL)))|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END || 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.INAFECTA_ME,0) = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END) END ||
	            '|'||'0.00'|| 
	            '|'||CASE WHEN b.id_tipoigv='40' THEN CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END   ELSE '0.00' END ||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END) END || 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.DESCUENTO_ME,0) = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999999D99')),',','.') END) END ||
	            '|'||'0.00'||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END) END || 
	            '|'||'1000'|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''||    
	            '|' CAB 
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA   
	        AND A.ID_VENTA = P_ID_VENTA 
	        AND A.ESTADO = 1 		
	        
UNION ALL
 
	        SELECT  'DB'||	'|'||ROWNUM||
	                '|'||CASE WHEN a.serie='B150' THEN '85101503'||lpad(row_number() over (),3,0)  ELSE coalesce(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)) END || 
	                '|'||CASE WHEN a.serie='B150' THEN '85101503'  ELSE coalesce(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503') END ||   
	            '|'||'NIU'|| 
	            '|'||(case when length(trim(both to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(both to_char(b.cantidad,'9999999999.99'))else trim(both to_char(b.cantidad,'9999999999.99')) END)|| 
	            '|'||coalesce(b.detalle,'Venta Varios')|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN(B.PRECIO/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR((B.PRECIO/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO/1.18),'9999999D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN(B.PRECIO_ME/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR((B.PRECIO_ME/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO_ME/1.18),'9999999D99999')),',','.') END) END ||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_INICIAL_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
	            '|'||b.ID_TIPOIGV|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||''|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN trim(both TO_CHAR(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN trim(both TO_CHAR(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END) END ||    
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE (case when B.BASE<1 then 0  end)||REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END) END || 
	    		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN coalesce(B.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.DESCUENTO,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.DESCUENTO_ME,0) = 0 THEN '0.00' WHEN coalesce(B.DESCUENTO_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.DESCUENTO_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.DESCUENTO_ME,0),'9999999999D99')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END) END ||			
	            '|'||''|| 
	            '|'||''||
	            '|' DET 			
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA    
	        AND A.ID_VENTA = P_ID_VENTA  
	        AND A.ESTADO = 1;
	
	        
		ELSIF S_TIPODOC = '01' THEN   -- FACTURA
	        
	        open VENTA FOR  
		  	SELECT distinct'CF'||'|'||'0101'||
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		        '|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO||
		        '|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
		        '|'||S_ID_RUC||'|6'||
		        '|'||coalesce(FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
		        '|'||FC_NOMBRE_PERSONA(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		        '|'||REGEXP_REPLACE(coalesce(trim(both pkg_sales_facturacion_fc_cliente_direccion(coalesce(coalesce(a.id_sucursal,A.ID_CLIENTE_LEGAL),A.ID_CLIENTE))),'Sin Direccion'),'-','', 'g')||
		        '|'||''|| 
		        '|'||trim(both coalesce(FC_EMAIL(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END) END ||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END) END ||
		        '|'||'0.00'|| 
				'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END) END ||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END) END || 
		        '|'||'1000'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
		        FROM VENTA A
		        WHERE A.ID_VENTA = P_ID_VENTA 
		        AND A.ESTADO = 1 		
		        
UNION ALL
 
		         SELECT  'DF'||	'|'||ROWNUM||
		                        '|'||CASE WHEN a.serie='B150' THEN '85101503'||lpad(row_number() over (),3,0)  ELSE coalesce(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)) END || 
		                        '|'||CASE WHEN a.serie='B150' THEN '85101503'  ELSE coalesce(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503') END ||     
		                   --     '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
		                    --    '|86121503'|| 
		                        '|'||'NIU'|| 
		                         '|'||(case when length(trim(both to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(both to_char(b.cantidad,'9999999999.99'))else trim(both to_char(b.cantidad,'9999999999.99')) END)|| 
		                        '|'||coalesce(b.detalle,'Venta')|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN(B.PRECIO/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR((B.PRECIO/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO/1.18),'9999999D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN(B.PRECIO_ME/1.18) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR((B.PRECIO_ME/1.18),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR((B.PRECIO_ME/1.18),'9999999D99999')),',','.') END) END ||
	            				--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_INICIAL_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||b.ID_TIPOIGV|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||''|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN trim(both TO_CHAR(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN trim(both TO_CHAR(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END) END ||    
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END) END || 
		            			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.base,0) = 0 THEN '0.00' WHEN B.base BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.base,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.base,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||			
		                        '|'||''|| 
		                        '|'||''||
		                        '|' DET 			
		                FROM VENTA A, VENTA_DETALLE B  
		                WHERE A.ID_VENTA = B.ID_VENTA    
		                AND A.ID_VENTA = P_ID_VENTA  
		                AND A.ESTADO = 1
		                
UNION ALL

		                SELECT 
		                      'FDP'||'|'||'Credito'||
		                      '|'||CASE WHEN ID_MONEDA='7' THEN (CASE  WHEN coalesce(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END) END ||
		                      '|'CAB 
		                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
		                
UNION ALL

		                SELECT 
		                      'CUO'||'|'||CASE WHEN B.NRO_CUOTA='CUO001' THEN 'Cuota001'  ELSE 'Cuota002' END ||
		                      '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END) END ||                  
		                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
		                      '|' DET
		                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
		                AND A.ID_CREDITO = 2;
		
		  
	    END IF;
	ELSE  -- INAFECTO O EXONERADO
		IF S_TIPODOC='03' THEN  -- BOLETA
	           --VENTAS SERVICIOS
	        open VENTA FOR
	        SELECT distinct'CB'||'|'||'0101'||
	            '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
	            '|'||'03'|| 
	            '|'||A.SERIE||'-'||A.NUMERO||
	            '|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
	            '|'||S_ID_RUC|| 
	            '|'||CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN 1  ELSE 0 END ||
	            '|'||CASE WHEN length(trim(both REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*', 'g')))=8 THEN eliseo.FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_legal))  ELSE '0000' END ||
	            '|'||coalesce(trim(both FC_NOMBRE_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')||
	            '|'||REGEXP_REPLACE(coalesce(trim(both pkg_sales_facturacion_fc_cliente_direccion(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','', 'g')||
	            '|'||''|| 
	            '|'||trim(both FC_EMAIL(coalesce(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL)))|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END || 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.INAFECTA_ME,0) = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999999D99')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999999D99')),',','.') END) END ||
	            '|'||'0.00'|| 
	            '|'||CASE WHEN b.id_tipoigv='40' THEN CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME,0) = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999999D99')),',','.') END) END   ELSE '0.00' END ||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END) END || 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END))|| 
	            '|'||'0.00'||
	            '|'||'0.00'||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.TOTAL_ME,0) = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999999D99')),',','.') END) END || 
	            '|'||'1000'|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''||    
	            '|' CAB 
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA   
	        AND A.ID_VENTA = P_ID_VENTA 
	        AND A.ESTADO = 1 		
	        
UNION ALL
 
	        SELECT  'DB'||	'|'||ROWNUM||
	                '|'||CASE WHEN a.serie='B150' THEN '85101503'||lpad(row_number() over (),3,0)  ELSE coalesce(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)) END || 
	                '|'||CASE WHEN a.serie='B150' THEN '85101503'  ELSE coalesce(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503') END ||   
	            '|'||'NIU'|| 
	            '|'||(case when length(trim(both to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(both to_char(b.cantidad,'9999999999.99'))else trim(both to_char(b.cantidad,'9999999999.99')) END)|| 
	            '|'||coalesce(b.detalle,'Venta Varios')|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_ME,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999D99999')),',','.') END) END ||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_INICIAL_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
	            '|'||b.ID_TIPOIGV|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END) END ||
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||''|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||'0.00'|| 
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN trim(both TO_CHAR(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN trim(both TO_CHAR(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END) END ||    
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE (case when B.BASE<1 then 0  end)||REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999999D99')),',','.') END))||
	            --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END) END || 
	    		'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN coalesce(B.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.DESCUENTO,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(B.DESCUENTO_ME,0) = 0 THEN '0.00' WHEN coalesce(B.DESCUENTO_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(B.DESCUENTO_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(B.DESCUENTO_ME,0),'9999999999D99')),',','.') END) END ||
	            '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END) END ||			
	            '|'||''|| 
	            '|'||''||
	            '|' DET 			
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA    
	        AND A.ID_VENTA = P_ID_VENTA  
	        AND A.ESTADO = 1;
	
	        
		ELSIF S_TIPODOC = '01' THEN   -- FACTURA
	        
	        open VENTA FOR  
		  	SELECT distinct'CF'||'|'||'0101'||
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		        '|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO||
		        '|'||CASE WHEN A.ID_MONEDA=7 THEN 'PEN'  ELSE 'USD' END || 
		        '|'||S_ID_RUC||'|6'||
		        '|'||coalesce(FC_DOCUMENTO_CLIENTE(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
		        '|'||FC_NOMBRE_PERSONA(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		        '|'||REGEXP_REPLACE(coalesce(trim(both pkg_sales_facturacion_fc_cliente_direccion(coalesce(coalesce(a.id_sucursal,A.ID_CLIENTE_LEGAL),A.ID_CLIENTE))),'Sin Direccion'),'-','', 'g')||
		        '|'||''|| 
		        '|'||trim(both coalesce(FC_EMAIL(coalesce(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV,0),'9999999990D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.IGV_ME,0),'9999999990D99')),',','.') END) END || 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END) END ||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END) END ||
		        '|'||'0.00'|| 
				'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END) END ||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999999D99')),',','.') END) END || 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA,0)+coalesce(A.INAFECTA,0)+coalesce(A.EXONERADA,0)+coalesce(A.IGV,0),'9999999999D99')),',','.') END)  ELSE (CASE  WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(coalesce(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999999D99')),',','.') END) END || 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END) END || 
		        '|'||'1000'|| 
		        '|'||CASE WHEN A.ID_MONEDA='7' THEN UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL))))||' Soles'  ELSE UPPER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares' END || 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
		        FROM VENTA A
		        WHERE A.ID_VENTA = P_ID_VENTA 
		        AND A.ESTADO = 1 		
		        
UNION ALL
 
		         SELECT  'DF'||	'|'||ROWNUM||
		                        '|'||CASE WHEN a.serie='B150' THEN '85101503'||lpad(row_number() over (),3,0)  ELSE coalesce(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)) END || 
		                        '|'||CASE WHEN a.serie='B150' THEN '85101503'  ELSE coalesce(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503') END ||     
		                   --     '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
		                    --    '|86121503'|| 
		                        '|'||'NIU'|| 
		                         '|'||(case when length(trim(both to_char(b.cantidad,'9999999999.99')))=3 then 0||trim(both to_char(b.cantidad,'9999999999.99'))else trim(both to_char(b.cantidad,'9999999999.99')) END)|| 
		                        '|'||coalesce(b.detalle,'Venta')|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_BASE,0) = 0 THEN '0.00' WHEN B.PRECIO_BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE,'9999999D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_BASE_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.PRECIO_BASE_ME,'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_ME,'9999999D99999')),',','.') END) END ||
	            				--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.PRECIO_INICIAL,0) = 0 THEN '0.00' WHEN B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL-(coalesce(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_INICIAL_ME-(coalesce(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||b.ID_TIPOIGV|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||''|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE WHEN coalesce(B.DESCUENTO,0) >0 THEN trim(both TO_CHAR(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0),'9999999999.99')) ELSE '0.00' END)  ELSE (CASE WHEN B.DESCUENTO_ME >0 THEN trim(both TO_CHAR(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0),'9999999999.99')) ELSE '0.00' END) END ||    
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO,0)/(coalesce(B.BASE,0)+coalesce(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END)  ELSE (CASE  WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(coalesce(B.DESCUENTO_ME,0)/(coalesce(B.BASE_ME,0)+coalesce(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END) END || 
		            			'|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999990D99')),',','.') END) END ||
		                        '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.base,0) = 0 THEN '0.00' WHEN B.base BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.base,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.base,'9999999990D99')),',','.') END)  ELSE (CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END) END ||			
		                        '|'||''|| 
		                        '|'||''||
		                        '|' DET 			
		                FROM VENTA A, VENTA_DETALLE B  
		                WHERE A.ID_VENTA = B.ID_VENTA    
		                AND A.ID_VENTA = P_ID_VENTA  
		                AND A.ESTADO = 1
		                
UNION ALL

		                SELECT 
		                      'FDP'||'|'||'Credito'||
		                      '|'||CASE WHEN ID_MONEDA='7' THEN (CASE  WHEN coalesce(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END) END ||
		                      '|'CAB 
		                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
		                
UNION ALL

		                SELECT 
		                      'CUO'||'|'||CASE WHEN B.NRO_CUOTA='CUO001' THEN 'Cuota001'  ELSE 'Cuota002' END ||
		                      '|'||CASE WHEN A.ID_MONEDA='7' THEN (CASE  WHEN coalesce(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END)  ELSE (CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(trim(both TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END) END ||                  
		                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
		                      '|' DET
		                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
		                AND A.ID_CREDITO = 2;
		
		  
	    END IF;
	
	END IF;

        fetch VENTA into
        S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                /*IF LENGTH(S_DETALLE||chr(13)||S_VENTA) <= 4000 THEN
                    S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                ELSE
                    S_DETALLE :='';
                END IF;*/
                BEGIN 
                    IF S_ERROR = 'N' THEN
                        S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                    END IF;
                EXCEPTION
                WHEN OTHERS THEN
                    S_DETALLE :='';
                    S_ERROR := 'S';
                END;

            END IF;

            S_CONTA:=S_CONTA+1;

        fetch VENTA into
            S_VENTA;
        end loop;
        close VENTA;	

        RETURN(S_DETALLE);
    END;

   
   
   
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
 STABLE;
-- REVOKE ALL ON FUNCTION eliseo.pkg_sales_industry_test_fc_venta (P_ID_VENTA bigint) FROM PUBLIC;
