-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_sales_detail_mov_col_diario (id_entidad, id_depto, id_anho, id_mes, id_voucher, id_venta, id_articulo, id_cliente, id_sucursal, id_comprobante, id_moneda, serie, numero, documento_venta, serie_mov, numero_mov, documento_mov, fecha, glosa, detalle, importe, importe_me, id_tipotransaccion, id_depto_ccosto) AS SELECT ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_VOUCHER,ID_VENTA,ID_ARTICULO,ID_CLIENTE,ID_SUCURSAL,ID_COMPROBANTE,ID_MONEDA,SERIE,NUMERO,DOCUMENTO_VENTA,SERIE_MOV,NUMERO_MOV,DOCUMENTO_MOV,FECHA,GLOSA,DETALLE,IMPORTE,IMPORTE_ME,ID_TIPOTRANSACCION,ID_DEPTO_CCOSTO FROM (
  SELECT 	  A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          NULL AS id_voucher,
          A.ID_VENTA,
          A.ID_ARTICULO,
          B.ID_CLIENTE,
          B.ID_SUCURSAL,
          B.ID_COMPROBANTE,
          B.ID_MONEDA,
          B.SERIE,
          B.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          B.SERIE AS SERIE_MOV,
          B.NUMERO AS NUMERO_MOV,
          'Sal Ini' as DOCUMENTO_MOV,
          B.FECHA,
          B.GLOSA,
          A.DETALLE AS DETALLE,
          A.TOTAL AS IMPORTE,
          A.TOTAL_ME AS IMPORTE_ME,
          B.ID_TIPOTRANSACCION,
          B.ID_DEPTO_CCOSTO 
   FROM ELISEO.VENTA_SALDO A
        INNER JOIN eliseo.VENTA B ON A.ID_VENTA = B.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = B.ID_COMPROBANTE
   
UNION all

  SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          A.ID_VENTA,
          B.ID_ARTICULO,
          A.ID_CLIENTE,
          A.ID_SUCURSAL,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.SERIE,
          A.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,   
          T.NOMBRE_CORTO AS DOCUMENTO_MOV,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          B.IMPORTE,
          B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION,
          A.ID_DEPTO_CCOSTO
   FROM VENTA A 
   INNER JOIN VENTA_DETALLE B ON A.ID_VENTA = B.ID_VENTA
   LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = A.ID_COMPROBANTE
   WHERE A.ID_COMPROBANTE NOT IN ('07','08')
   AND A.ESTADO = 1 
   
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          B.ID_ARTICULO,
          A.ID_CLIENTE,
          D.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,   
          'Dep' as DOCUMENTO_MOV,
          A.FECHA,
          A.GLOSA, -- before D.glosa
          A.GLOSA,
          B.IMPORTE *-1,
		  B.IMPORTE_ME *-1,
          A.ID_TIPOTRANSACCION,
          D.ID_DEPTO_CCOSTO
     FROM CAJA_DEPOSITO A
        INNER JOIN CAJA_DEPOSITO_DETALLE B ON A.ID_DEPOSITO = B.ID_DEPOSITO
        INNER JOIN VENTA_SALDO C ON B.ID_VENTA = C.ID_VENTA AND A.ID_ANHO = C.ID_ANHO 
        INNER JOIN VENTA D ON B.ID_VENTA = D.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'

UNION ALL
 
    SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          B.ID_ARTICULO,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,   
          'Dep' as DOCUMENTO_MOV,
          A.FECHA,
          A.GLOSA, -- before C.glosa
          A.GLOSA,
          B.IMPORTE *-1,
		  B.IMPORTE_ME *-1,
          A.ID_TIPOTRANSACCION,
          C.ID_DEPTO_CCOSTO
     FROM CAJA_DEPOSITO A
        INNER JOIN CAJA_DEPOSITO_DETALLE B ON A.ID_DEPOSITO = B.ID_DEPOSITO
        INNER JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'
    AND NOT EXISTS (SELECT x.ID_VENTA FROM VENTA_SALDO x WHERE x.ID_ENTIDAD= A.ID_ENTIDAD AND x.ID_ANHO=A.ID_ANHO AND x.ID_VENTA = B.ID_VENTA)
    and not coalesce(B.id_articulo::text, '') = ''  
    
UNION ALL
 
    SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          D.ID_ARTICULO,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,   
          'Dep' as DOCUMENTO_MOV,
          A.FECHA,
          A.GLOSA, -- before C.glosa
          A.GLOSA,
          CASE WHEN COALESCE(C.TOTAL,0) = 0 THEN 
          	0 ELSE (D.IMPORTE/C.TOTAL*B.IMPORTE) * -1
          	END,
          CASE WHEN COALESCE(C.TOTAL_ME,0) = 0 THEN 
          	0 ELSE (D.IMPORTE_ME/C.TOTAL_ME*B.IMPORTE_ME) * -1
          	END,
          A.ID_TIPOTRANSACCION,
          C.ID_DEPTO_CCOSTO
     FROM CAJA_DEPOSITO A
        INNER JOIN CAJA_DEPOSITO_DETALLE B ON A.ID_DEPOSITO = B.ID_DEPOSITO
        INNER JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA
        INNER JOIN VENTA_DETALLE D ON D.ID_VENTA = C.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'
    AND NOT EXISTS (SELECT x.ID_VENTA FROM VENTA_SALDO x WHERE x.ID_ENTIDAD= A.ID_ENTIDAD AND x.ID_ANHO=A.ID_ANHO AND x.ID_VENTA = B.ID_VENTA)
    and coalesce(B.id_articulo::text, '') = ''  
    
UNION ALL

    SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          B.ID_VENTA,
          D.ID_ARTICULO,
          A.ID_CLIENTE,
          B.ID_SUCURSAL,
          B.ID_COMPROBANTE, 
          A.ID_MONEDA,
          B.SERIE,
          B.NUMERO,
          U.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,
          T.NOMBRE_CORTO AS DOCUMENTO_MOV,
          A.FECHA,
          A.GLOSA,
          D.DETALLE,
          CASE WHEN D.DC='C' THEN -1  ELSE 1 END *D.IMPORTE AS TOTAL,
          CASE WHEN D.DC='C' THEN -1  ELSE 1 END *D.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          A.ID_DEPTO_CCOSTO
   FROM VENTA A 
   INNER JOIN VENTA_DETALLE D ON A.ID_VENTA = D.ID_VENTA 
   INNER JOIN VENTA B ON A.ID_PARENT = B.ID_VENTA
   LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = A.ID_COMPROBANTE
   LEFT OUTER JOIN TIPO_COMPROBANTE U ON U.ID_COMPROBANTE = B.ID_COMPROBANTE
   WHERE A.ID_COMPROBANTE IN ('07','08')
   AND A.ESTADO = 1 
   
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO, 
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          B.ID_ARTICULO,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,
          'Trs.' AS DOCUMENTO_MOV,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          C.ID_DEPTO_CCOSTO
     FROM VENTA_TRANSFERENCIA A
        INNER JOIN VENTA_TRANSFERENCIA_DETALLE B ON A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
        INNER JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'
    
UNION ALL

   SELECT C.ID_ENTIDAD,
          C.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          B.ID_ARTICULO_DESTINO,
          C.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,
          'Trs.' AS DOCUMENTO_MOV,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          CASE WHEN B.DC='C' THEN 1  ELSE -1 END *B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN 1  ELSE -1 END *B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          C.ID_DEPTO_CCOSTO
     FROM VENTA_TRANSFERENCIA A
        INNER JOIN VENTA_TRANSFERENCIA_DETALLE B ON A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
        INNER JOIN VENTA C ON B.ID_VENTA_DESTINO = C.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'
    	AND A.ES_ENTRECLIENTES = 'S'
    
UNION ALL
 
        SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          B.ID_ARTICULO,
          B.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          '' AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,
          'Dev.' AS DOCUMENTO_MOV,
          A.FECHA,
          C.GLOSA,
          B.DETALLE,
          B.IMPORTE,
          B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION,
          C.ID_DEPTO_CCOSTO
     FROM CAJA_PAGO A
        INNER JOIN CAJA_PAGO_VENTA B ON A.ID_PAGO = B.ID_PAGO
        INNER JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
     WHERE A.ESTADO = '1'
)a;

