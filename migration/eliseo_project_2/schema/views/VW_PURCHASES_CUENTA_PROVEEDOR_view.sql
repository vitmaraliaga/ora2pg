-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_purchases_cuenta_proveedor (id, id_entidad, id_depto, id_anho, id_mes, cuenta, fecha, lote, operacion, numero, importe, proveedor, id_ruc, debito, credito, tipo_operacion) AS SELECT
	ID,
	ID_ENTIDAD,
	ID_DEPTO,
	ID_ANHO,
	ID_MES,
	CUENTA,
	FECHA_PROVISION FECHA,
	LOTE,
	ID_TIPOASIENTO ||' - '|| CASE WHEN ID_COMPROBANTE='07' THEN 'NOTA CREDITO'  ELSE 'COMPRA' END  AS OPERACION,
	NUMERO,
	IMPORTE,
	PROVEEDOR,
	ID_RUC,
	SUM(DEBITO) AS DEBITO, 
	ABS(SUM(CREDITO)) AS CREDITO, 'COMPRAS' TIPO_OPERACION
FROM (
SELECT A.ID_COMPRA ID,A.ID_ENTIDAD,A.ID_DEPTO, A.ID_ANHO, A.ID_MES,X.CUENTA,C.ID_TIPOASIENTO,A.ID_COMPROBANTE,
A.FECHA_PROVISION,C.LOTE,A.SERIE||'-'||A.NUMERO AS NUMERO,A.IMPORTE,D.NOMBRE AS PROVEEDOR,D.ID_RUC,
(CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END) AS DEBITO,
(CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END) AS CREDITO
FROM COMPRA A 
JOIN CONTA_VOUCHER C
ON A.ID_VOUCHER = C.ID_VOUCHER
LEFT JOIN MOISES.VW_PERSONA_NATURAL_LEGAL D
ON A.ID_PROVEEDOR = D.ID_PERSONA
JOIN CONTA_ASIENTO X
ON A.ID_VOUCHER = X.VOUCHER
AND A.ID_TIPOORIGEN = X.ID_TIPOORIGEN
AND A.ID_COMPRA = X.ID_ORIGEN
WHERE A.ESTADO = '1') alias9 
GROUP BY ID,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,CUENTA,FECHA_PROVISION,LOTE,ID_TIPOASIENTO,ID_COMPROBANTE,NUMERO,IMPORTE,PROVEEDOR,ID_RUC

UNION ALL

SELECT
ID,
ID_ENTIDAD,
ID_DEPTO,
ID_ANHO,
ID_MES,
CUENTA,
FECHA,
LOTE,
ID_TIPOASIENTO ||' - '|| CASE WHEN ID_MEDIOPAGO='07' THEN 'CHEQUE'  ELSE 'TLC' END  AS OPERACION,
NUMERO,
IMPORTE,
NOMBRE PROVEEDOR,
ID_RUC,
SUM(DEBITO) AS DEBITO, 
ABS(SUM(CREDITO)) AS CREDITO, 'PAGOS' TIPO_OPERACION
FROM (
SELECT DISTINCT B.ID_PCOMPRA ID,A.ID_ENTIDAD,A.ID_DEPTO,A.ID_ANHO,A.ID_MES,X.CUENTA,C.ID_TIPOASIENTO,A.ID_MEDIOPAGO,
A.FECHA,C.LOTE,A.NUMERO AS NUMERO,A.IMPORTE,D.NOMBRE,D.ID_RUC,
(CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END) AS DEBITO,
(CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END) AS CREDITO
FROM CAJA_PAGO A JOIN CAJA_PAGO_COMPRA B
ON A.ID_PAGO = B.ID_PAGO
JOIN CONTA_VOUCHER C
ON A.ID_VOUCHER = C.ID_VOUCHER
JOIN MOISES.VW_PERSONA_NATURAL_LEGAL D
ON B.ID_PROVEEDOR = D.ID_PERSONA
JOIN CONTA_ASIENTO X
ON A.ID_VOUCHER = X.VOUCHER
AND B.ID_TIPOORIGEN = X.ID_TIPOORIGEN
AND B.ID_PCOMPRA = X.ID_ORIGEN
WHERE A.ESTADO = '1') alias19 
GROUP BY ID,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,CUENTA,FECHA,LOTE,NUMERO,ID_TIPOASIENTO,ID_MEDIOPAGO,IMPORTE,NOMBRE,ID_RUC

UNION ALL

SELECT 
ID,
ID_ENTIDAD,
ID_DEPTO,
ID_ANHO,
ID_MES,
CUENTA,
FECHA,
LOTE,
ID_TIPOASIENTO ||' - DETRACCIONES' AS OPERACION,
NUMERO,
IMPORTE,
NOMBRE PROVEEDOR,
ID_RUC,
SUM(DEBITO) AS DEBITO, 
ABS(SUM(CREDITO)) AS CREDITO, 'DETRACCIONES' TIPO_OPERACION
FROM (
SELECT DISTINCT A.ID_DETRACCION ID,A.ID_ENTIDAD,A.ID_DEPTO,A.ID_ANHO,A.ID_MES,X.CUENTA,C.ID_TIPOASIENTO,
A.FECHA,C.LOTE,A.NRO_OPERACION AS NUMERO,A.IMPORTE,D.NOMBRE,D.ID_RUC,
(CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END) AS DEBITO,
(CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END) AS CREDITO
FROM CAJA_DETRACCION A JOIN CAJA_DETRACCION_COMPRA B
ON A.ID_DETRACCION = B.ID_DETRACCION
JOIN CONTA_VOUCHER C
ON A.ID_VOUCHER = C.ID_VOUCHER
JOIN MOISES.VW_PERSONA_NATURAL_LEGAL D
ON A.ID_PROVEEDOR = D.ID_PERSONA
JOIN CONTA_ASIENTO X
ON A.ID_VOUCHER = X.VOUCHER
AND B.ID_TIPOORIGEN = X.ID_TIPOORIGEN
AND B.ID_DETRACCION = X.ID_ORIGEN
WHERE A.ESTADO = '1') alias29 
GROUP BY ID,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,CUENTA,FECHA,LOTE,NUMERO,ID_TIPOASIENTO,IMPORTE,NOMBRE,ID_RUC

UNION ALL

SELECT 
ID_RETENCION ID,
ID_ENTIDAD,
ID_DEPTO,
ID_ANHO,
ID_MES,
CUENTA,
FECHA,
LOTE,
ID_TIPOASIENTO ||' - RETENCIONES' AS OPERACION,
NUMERO,
IMPORTE,
NOMBRE PROVEEDOR,
ID_RUC,
SUM(DEBITO) AS DEBITO, 
ABS(SUM(CREDITO)) AS CREDITO, 'RETENCIONES' TIPO_OPERACION
FROM (
SELECT DISTINCT A.ID_RETENCION,A.ID_ENTIDAD,A.ID_DEPTO,A.ID_ANHO,A.ID_MES,X.CUENTA,C.ID_TIPOASIENTO,
A.FECHA,C.LOTE,A.SERIE||'-'||A.NRO_RETENCION AS NUMERO,A.IMPORTE,D.NOMBRE,D.ID_RUC,
(CASE WHEN(X.IMPORTE) > 0 THEN (X.IMPORTE) ELSE 0 END) AS DEBITO,
(CASE WHEN(X.IMPORTE) < 0 THEN (X.IMPORTE) ELSE 0 END) AS CREDITO
FROM CAJA_RETENCION A JOIN CAJA_RETENCION_COMPRA B
ON A.ID_RETENCION = B.ID_RETENCION
JOIN CONTA_VOUCHER C
ON A.ID_VOUCHER = C.ID_VOUCHER
JOIN MOISES.VW_PERSONA_NATURAL_LEGAL D
ON A.ID_PROVEEDOR = D.ID_PERSONA
JOIN CONTA_ASIENTO X
ON A.ID_VOUCHER = X.VOUCHER
AND B.ID_TIPOORIGEN = X.ID_TIPOORIGEN
AND B.ID_RETENCION = X.ID_ORIGEN
WHERE A.ESTADO = '1') alias39 
GROUP BY ID_RETENCION,ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,CUENTA,FECHA,LOTE,NUMERO,ID_TIPOASIENTO,IMPORTE,NOMBRE,ID_RUC;

