-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_saldo_alumno_mes (id_entidad, id_depto, id_anho, id_mes, id_cliente, credito, debito, saldo) AS SELECT ID_ENTIDAD,
            ID_DEPTO,
            ID_ANHO,
            ID_MES,
            ID_CLIENTE,
            SUM(CREDITO) AS CREDITO,SUM(DEBITO) AS DEBITO,
            /*CASE WHEN SUM (TOTAL) < 0 THEN ABS (SUM (TOTAL)) ELSE 0 END
               AS CREDITO,
            CASE WHEN SUM (TOTAL) > 0 THEN (SUM (TOTAL)) ELSE 0 END AS DEBITO,*/
            SUM(TOTAL) AS SALDO
       FROM (
       SELECT ID_ENTIDAD,
                    ID_DEPTO,
                    ID_ANHO,
                    ID_MES,
                    ID_CLIENTE,
                    (CASE WHEN TOTAL < 0 THEN TOTAL ELSE 0 END) AS CREDITO,
                    --(CASE WHEN TOTAL > 0 THEN TOTAL ELSE 0 END) AS DEBITO,
                    (CASE WHEN TOTAL > 0 THEN (CASE WHEN ID_MES = 1 AND coalesce(VOUCHER::text, '') = '' THEN 0 ELSE TOTAL END) ELSE 0 END) AS DEBITO,
                    TOTAL
               FROM VW_SALES_MOV
              WHERE ID_TIPOVENTA IN (1,2,3,4)
              --AND NUMERO_LEGAL <> 'S001-00000001'   --NO SE CONSIDERA EL SALDO INICIAL
              --AND (CASE WHEN ID_MES = 1 AND VOUCHER IS NULL THEN 'N' ELSE 'S' END) <> 'N' --NO SE CONSIDERA EL SALDO INICIAL
             /*UNION ALL
               SELECT ID_ENTIDAD,
                      ID_DEPTO,
                      ID_ANHO,
                      ID_MES,
                      ID_CLIENTE,
                      (CASE WHEN SIGN (SUM (IMPORTE)) = 1 THEN SUM (IMPORTE)*-1 ELSE 0 END) AS CREDITO,
                      (CASE WHEN SIGN (SUM (IMPORTE)) = -1 THEN SUM (IMPORTE) ELSE 0 END) AS DEBITO,
                      SUM (IMPORTE) * DECODE (SIGN (SUM (IMPORTE)), 1, -1, 0)
                         AS TOTAL
                 FROM VW_SALES_ADVANCES
             GROUP BY ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_CLIENTE*/
 
                      ) alias8 
   GROUP BY ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_CLIENTE;

