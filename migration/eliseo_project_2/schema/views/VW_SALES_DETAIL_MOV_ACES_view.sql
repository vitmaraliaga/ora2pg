-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_sales_detail_mov_aces (id_entidad, id_depto, id_anho, id_mes, id_venta, id_articulo, id_vdetalle, id_cliente, id_sucursal, id_comprobante, id_moneda, serie, numero, fecha, glosa, detalle, importe, importe_me, id_tipotransaccion) AS SELECT ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_VENTA,ID_ARTICULO,ID_VDETALLE,ID_CLIENTE,ID_SUCURSAL,ID_COMPROBANTE,ID_MONEDA,SERIE,NUMERO,FECHA,GLOSA,DETALLE,IMPORTE,IMPORTE_ME,ID_TIPOTRANSACCION FROM (
  SELECT 	  A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.ID_VENTA,
          C.ID_ARTICULO,
          C.ID_VDETALLE,
          B.ID_CLIENTE,
          B.ID_SUCURSAL,
          B.ID_COMPROBANTE, 
          B.ID_MONEDA,
          B.SERIE,
          B.NUMERO,
          B.FECHA,
          B.GLOSA,
          C.DETALLE AS DETALLE,
          C.IMPORTE AS IMPORTE,
          C.IMPORTE_ME AS IMPORTE_ME,
          B.ID_TIPOTRANSACCION
   FROM ELISEO.VENTA_SALDO A, eliseo.VENTA B, eliseo.VENTA_DETALLE C
   WHERE A.ID_VENTA = B.ID_VENTA
   AND B.ID_VENTA = C.ID_VENTA
   
UNION all

  SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.ID_VENTA,
          B.ID_ARTICULO,
          B.ID_VDETALLE,
          A.ID_CLIENTE,
          A.ID_SUCURSAL,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.SERIE,
          A.NUMERO,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          B.IMPORTE,
          B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION
   FROM VENTA A INNER JOIN VENTA_DETALLE B ON A.ID_VENTA = B.ID_VENTA
   WHERE A.ID_COMPROBANTE NOT IN ('07','08')
   AND A.ESTADO = 1 
   
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          D.ID_ARTICULO,
          D.ID_VDETALLE,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          C.GLOSA,
          A.GLOSA,--
          CASE WHEN COALESCE(C.TOTAL,0) = 0 THEN 
          	0 ELSE (D.IMPORTE/C.TOTAL*B.IMPORTE) * -1
          	END,
          CASE WHEN COALESCE(C.TOTAL_ME,0) = 0 THEN 
          	0 ELSE (D.IMPORTE_ME/C.TOTAL_ME*B.IMPORTE_ME) * -1
          	END,
          A.ID_TIPOTRANSACCION
     FROM CAJA_DEPOSITO A, CAJA_DEPOSITO_DETALLE B, VENTA C, VENTA_DETALLE D
    WHERE A.ID_DEPOSITO = B.ID_DEPOSITO AND B.ID_VENTA = C.ID_VENTA AND D.ID_VENTA = C.ID_VENTA
    	AND coalesce(B.ID_VDETALLE::text, '') = ''  
    	
UNION ALL

   	SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          D.ID_ARTICULO,
          D.ID_VDETALLE,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          C.GLOSA,
          A.GLOSA,
          B.IMPORTE* -1,
          B.IMPORTE_ME* -1,
          A.ID_TIPOTRANSACCION
     FROM CAJA_DEPOSITO A, CAJA_DEPOSITO_DETALLE B, VENTA C, VENTA_DETALLE D
    WHERE A.ID_DEPOSITO = B.ID_DEPOSITO AND B.ID_VENTA = C.ID_VENTA AND D.ID_VENTA = C.ID_VENTA
    	AND B.ID_VDETALLE=D.ID_VDETALLE
    
UNION ALL

    SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_VENTA,
          D.ID_ARTICULO,
          D.ID_VDETALLE,
          A.ID_CLIENTE,
          B.ID_SUCURSAL,
          B.ID_COMPROBANTE, 
          A.ID_MONEDA,
          B.SERIE,
          B.NUMERO,
          A.FECHA,
          A.GLOSA,
          D.DETALLE,
          CASE WHEN D.DC='C' THEN -1  ELSE 1 END *D.IMPORTE AS TOTAL,
          CASE WHEN D.DC='C' THEN -1  ELSE 1 END *D.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION
   FROM VENTA A INNER JOIN VENTA_DETALLE D ON A.ID_VENTA = D.ID_VENTA INNER JOIN VENTA B ON A.ID_PARENT = B.ID_VENTA
   WHERE A.ID_COMPROBANTE IN ('07','08')
   AND A.ESTADO = 1 
   
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          D.ID_ARTICULO,
          D.ID_VDETALLE,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION
     FROM VENTA_TRANSFERENCIA A, VENTA_TRANSFERENCIA_DETALLE B, VENTA C, VENTA_DETALLE D
    WHERE A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA AND B.ID_VENTA = C.ID_VENTA AND C.ID_VENTA = D.ID_VENTA AND B.ID_ARTICULO = D.ID_ARTICULO
    
UNION ALL

	SELECT B.ID_ENTIDAD,
	  B.ID_DEPTO,
	  B.ID_ANHO,
	  B.ID_MES,
	  C.ID_VENTA,
	  null AS ID_ARTICULO,
	  NULL AS ID_VDETALLE,
	  B.ID_CLIENTE,
	  C.ID_SUCURSAL,
	  C.ID_COMPROBANTE,
	  A.ID_MONEDA,
	  C.SERIE,
	  C.NUMERO,
	  A.FECHA,
	  C.GLOSA,
	  B.GLOSA,
	  A.IMPORTE * CASE WHEN A.DC='C' THEN -1  ELSE 1 END  AS IMPORTE,
	  A.IMPORTE_ME * CASE WHEN A.DC='C' THEN -1  ELSE 1 END  AS IMPORTE_ME,
	  B.ID_TIPOTRANSACCION
    FROM CAJA_DEPOSITO_AJUSTE A, CAJA_DEPOSITO B,VENTA C 
    WHERE A.ID_DEPOSITO = B.ID_DEPOSITO AND A.ID_VENTA = C.ID_VENTA
    AND A.ESTADO = 1
)a;

