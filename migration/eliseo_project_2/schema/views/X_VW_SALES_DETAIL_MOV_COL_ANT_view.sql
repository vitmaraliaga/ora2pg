-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW x_vw_sales_detail_mov_col_ant (id_entidad, id_depto, id_anho, id_mes, id_venta, id_articulo, id_cliente, id_sucursal, id_comprobante, id_moneda, serie, numero, fecha, glosa, detalle, importe, importe_me, id_tipotransaccion) AS SELECT ID_ENTIDAD,ID_DEPTO,ID_ANHO,ID_MES,ID_VENTA,ID_ARTICULO,ID_CLIENTE,ID_SUCURSAL,ID_COMPROBANTE,ID_MONEDA,SERIE,NUMERO,FECHA,GLOSA,DETALLE,IMPORTE,IMPORTE_ME,ID_TIPOTRANSACCION FROM (
  SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.ID_VENTA,
          B.ID_ARTICULO,
          A.ID_CLIENTE,
          A.ID_SUCURSAL,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.SERIE,
          A.NUMERO,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          B.IMPORTE,
          B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION
   FROM VENTA A INNER JOIN VENTA_DETALLE B ON A.ID_VENTA = B.ID_VENTA
   WHERE A.ID_COMPROBANTE NOT IN ('07','08')
   AND A.ESTADO = 1 
    
UNION ALL

    SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_VENTA,
          D.ID_ARTICULO,
          A.ID_CLIENTE,
          B.ID_SUCURSAL,
          B.ID_COMPROBANTE, 
          A.ID_MONEDA,
          B.SERIE,
          B.NUMERO,
          A.FECHA,
          A.GLOSA,
          D.DETALLE,
          CASE WHEN D.DC='C' THEN -1  ELSE 1 END *D.IMPORTE AS TOTAL,
          CASE WHEN D.DC='C' THEN -1  ELSE 1 END *D.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION
   FROM VENTA A INNER JOIN VENTA_DETALLE D ON A.ID_VENTA = D.ID_VENTA INNER JOIN VENTA B ON A.ID_PARENT = B.ID_VENTA
   WHERE A.ID_COMPROBANTE IN ('07')
   AND A.ID_ANHO = B.ID_ANHO 
   AND A.ESTADO = 1 
   
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          B.ID_ARTICULO,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION
     FROM VENTA_TRANSFERENCIA A, VENTA_TRANSFERENCIA_DETALLE B, VENTA C, VENTA_DETALLE D
    WHERE A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA AND B.ID_VENTA = C.ID_VENTA AND C.ID_VENTA = D.ID_VENTA
    AND B.DC = 'D'
    AND A.ES_ANTICIPO = 'S'
    
UNION ALL
 
    SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          --B.ID_ARTICULO,
          60867 AS ID_ARTICULO,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          B.DETALLE,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN -1  ELSE 1 END *B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION
     FROM VENTA_TRANSFERENCIA A, VENTA_TRANSFERENCIA_DETALLE B, VENTA C, VENTA_DETALLE D
    WHERE A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA AND B.ID_VENTA = C.ID_VENTA AND C.ID_VENTA = D.ID_VENTA
    AND B.DC = 'C'
    AND B.ID_ARTICULO IN (SELECT mm.ID_ARTICULO FROM jose.MAT_MES mm )
    -- AND NOT A.ES_ANTICIPO = 'S'
 
)a 
-- WHERE ID_ENTIDAD = 7222
-- AND ID_CLIENTE = 100730
;

