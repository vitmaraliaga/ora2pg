-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_sales_mov_ssi (id_entidad, id_depto, id_anho, id_mes, id_venta, id_cliente, id_sucursal, id_comprobante, id_moneda, serie, numero, fecha, glosa, total, total_me, id_tipotransaccion, id_tipoventa, tipo, mov, voucher, lote, tipo_documento, numero_legal) AS SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.ID_VENTA,
          A.ID_CLIENTE,
          A.ID_SUCURSAL,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.SERIE,
          A.NUMERO,
          A.FECHA,
          A.GLOSA,
          A.TOTAL,
          A.TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          A.ID_TIPOVENTA,
          'V' AS TIPO,
          'VNT: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          B.NUMERO::text AS VOUCHER,
          B.LOTE,
          A.ID_COMPROBANTE AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA A LEFT JOIN CONTA_VOUCHER B ON A.ID_VOUCHER = B.ID_VOUCHER
    WHERE     A.ID_COMPROBANTE NOT IN ('07', '08')
          AND A.ESTADO = 1::varchar
          AND A.TOTAL <> 0
   
UNION ALL
                                --DEPOSITOS PAGAN VENTAS QUERY 1.1
   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          B.IMPORTE * -1,
          B.IMPORTE_ME * -1,
          A.ID_TIPOTRANSACCION,
          C.ID_TIPOVENTA,
          'V' AS TIPO,
          'DEP: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          D.NUMERO::text AS VOUCHER,
          D.LOTE,
          '00' AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM CAJA_DEPOSITO A,
          CAJA_DEPOSITO_DETALLE B,
          VENTA C,
          CONTA_VOUCHER D
    WHERE     A.ID_DEPOSITO = B.ID_DEPOSITO
          AND B.ID_VENTA = C.ID_VENTA
          AND A.ID_CLIENTE = C.ID_CLIENTE
          AND A.ID_VOUCHER = D.ID_VOUCHER
          AND B.IMPORTE <> 0
   
UNION ALL
                     --NOTAS DE CREDITO AFECTAN A VENTAS QUERY 1.2
   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_VENTA,
          A.ID_CLIENTE,
          B.ID_SUCURSAL,
          B.ID_COMPROBANTE,
          A.ID_MONEDA,
          B.SERIE,
          B.NUMERO,
          A.FECHA,
          A.GLOSA,
          CASE WHEN A.ID_COMPROBANTE='07' THEN  -1  ELSE 1 END  * A.TOTAL AS TOTAL,
          CASE WHEN A.ID_COMPROBANTE='07' THEN  -1  ELSE 1 END  * A.TOTAL_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          B.ID_TIPOVENTA,
          'V' AS TIPO,
          'NCD: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          C.NUMERO::text AS VOUCHER,
          C.LOTE,
          A.ID_COMPROBANTE AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA A
          JOIN VENTA B
             ON A.ID_PARENT = B.ID_VENTA AND A.ID_CLIENTE = B.ID_CLIENTE
          LEFT JOIN CONTA_VOUCHER C ON A.ID_VOUCHER = C.ID_VOUCHER
    WHERE     A.ID_COMPROBANTE IN ('07', '08')         --FROM VENTA A, VENTA B
                                              --WHERE A.ID_PARENT = B.ID_VENTA
                                             --AND A.ID_CLIENTE = B.ID_CLIENTE
          AND A.ID_COMPROBANTE IN ('07', '08')
          AND A.ESTADO = 1::varchar
          AND A.TOTAL <> 0 
   
UNION ALL
                       --TRANSFERENCIAS AFECTAN A VENTAS QUERY 1.3
   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          CASE WHEN B.DC='C' THEN  -1  ELSE 1 END  * B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN  -1  ELSE 1 END  * B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          C.ID_TIPOVENTA,
          'V' AS TIPO,
          'TRAN: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          D.NUMERO::text AS VOUCHER,
          D.LOTE,
          '99' AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA_TRANSFERENCIA A
          JOIN VENTA_TRANSFERENCIA_DETALLE B
             ON A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
          JOIN VENTA C
             ON B.ID_VENTA = C.ID_VENTA AND A.ID_CLIENTE = C.ID_CLIENTE
          LEFT JOIN CONTA_VOUCHER D ON A.ID_VOUCHER = D.ID_VOUCHER
    
    WHERE B.IMPORTE <> 0 AND A.ESTADO = '1'
   
UNION ALL

   --TRANSFERENCIAS AFECTAN A ENTRECLIENTES
   SELECT C.ID_ENTIDAD,
          C.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          C.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          CASE WHEN B.DC='C' THEN  1  ELSE -1 END  * B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN  1  ELSE -1 END  * B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          C.ID_TIPOVENTA,
          'V' AS TIPO,
          'TRAN: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          '' AS VOUCHER,
          '' AS LOTE,
          '99' AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA_TRANSFERENCIA A, VENTA_TRANSFERENCIA_DETALLE B, VENTA C
    WHERE     A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
          AND B.ID_VENTA_DESTINO = C.ID_VENTA
          AND B.IMPORTE <> 0
          AND A.ESTADO = '1'
          AND A.ES_ENTRECLIENTES = 'S'
   
UNION ALL

   -- DEVOLUCION
   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          B.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          C.GLOSA,
          B.IMPORTE,
          B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION,
          C.ID_TIPOVENTA,
          'P' AS TIPO,
          'DEV: OP.' || A.NUMERO AS MOV,
          '' AS VOUCHER,
          '' AS LOTE,
          '00' AS TIPO_DOCUMENTO,
          A.NUMERO AS NUMERO_LEGAL
     FROM CAJA_PAGO A
          INNER JOIN CAJA_PAGO_VENTA B ON A.ID_PAGO = B.ID_PAGO
          INNER JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA
          LEFT OUTER JOIN TIPO_COMPROBANTE T
             ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'
   
UNION ALL
                     --NOTAS DE CREDITO AFECTAN AL SALOD QUERY 2.2
             --TRANSFERENCIAS QUE SON DOCUMENTOS A PAGAR QUERY 3
   SELECT DISTINCT A.ID_ENTIDAD,
                   A.ID_DEPTO,
                   A.ID_ANHO,
                   A.ID_MES,
                   A.ID_TRANSFERENCIA AS ID_VENTA,
                   A.ID_CLIENTE,
                   0 AS ID_SUCURSAL,
                   '99' AS ID_COMPROBANTE,
                   A.ID_MONEDA,
                   A.SERIE,
                   A.NUMERO,
                   A.FECHA,
                   A.GLOSA,
                   A.IMPORTE AS TOTAL,
                   A.IMPORTE_ME AS TOTAL_ME,
                   A.ID_TIPOTRANSACCION,
                   A.ID_TIPOVENTA,
                   'T' AS TIPO,
                   'TRAN: ' || A.SERIE || '-' || A.NUMERO AS MOV,
                   C.NUMERO::text AS VOUCHER,
                   C.LOTE,
                   '99' AS TIPO_DOCUMENTO,
                   A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA_TRANSFERENCIA A
          JOIN VENTA_TRANSFERENCIA_DETALLE B
             ON A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
          JOIN CONTA_VOUCHER C ON A.ID_VOUCHER = C.ID_VOUCHER
    WHERE     A.ES_ANTICIPO = 'N'
          AND coalesce(B.ID_VENTA::text, '') = ''
          AND coalesce(B.ID_SALDO::text, '') = ''
          AND coalesce(B.ID_TRANSFERENCIA_P::text, '') = ''
          AND A.ESTADO = 1::varchar
          AND A.IMPORTE <> 0 
   
UNION ALL
                        --DEPOSITOS PAGAN TRANSFERENCIAS QUERY 3.1
   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_TRANSFERENCIA AS ID_VENTA,
          A.ID_CLIENTE,
          0 AS ID_SUCURSAL,
          '99' AS ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          B.IMPORTE * -1,
          B.IMPORTE_ME * -1,
          A.ID_TIPOTRANSACCION,
          C.ID_TIPOVENTA,
          'T' AS TIPO,
          'DEP: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          D.NUMERO::text AS VOUCHER,
          D.LOTE,
          '99' AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM CAJA_DEPOSITO A,
          CAJA_DEPOSITO_DETALLE B,
          VENTA_TRANSFERENCIA C,
          CONTA_VOUCHER D
    WHERE     A.ID_DEPOSITO = B.ID_DEPOSITO
          AND B.ID_TRANSFERENCIA = C.ID_TRANSFERENCIA
          AND A.ID_CLIENTE = C.ID_CLIENTE
          AND A.ID_VOUCHER = D.ID_VOUCHER
          AND A.ESTADO = '1'
          AND B.IMPORTE <> 0
   
UNION ALL
             --NOTAS DE CREDITO AFECTAN A TRANSFERENCIAS QUERY 3.2
   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          B.ID_TRANSFERENCIA AS ID_VENTA,
          A.ID_CLIENTE,
          A.ID_SUCURSAL,
          '99' AS ID_COMPROBANTE,
          A.ID_MONEDA,
          B.SERIE,
          B.NUMERO,
          A.FECHA,
          A.GLOSA,
          CASE WHEN A.ID_COMPROBANTE='07' THEN  -1  ELSE 1 END  * A.TOTAL AS TOTAL,
          CASE WHEN A.ID_COMPROBANTE='07' THEN  -1  ELSE 1 END  * A.TOTAL_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          A.ID_TIPOVENTA,
          'T' AS TIPO,
          'NCD: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          C.NUMERO::text AS VOUCHER,
          C.LOTE,
          A.ID_COMPROBANTE AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA A, VENTA_TRANSFERENCIA B, CONTA_VOUCHER C
    WHERE     A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
          AND A.ID_CLIENTE = B.ID_CLIENTE
          AND A.ID_VOUCHER = C.ID_VOUCHER
          AND A.ID_COMPROBANTE IN ('07', '08')
          AND A.ESTADO = 1::varchar
          AND A.TOTAL <> 0 
   
UNION ALL

   SELECT A.ID_ENTIDAD, --ANTICIPO (AUTOMATICO) QUE PAGA UNA TRANSFERENCIA QUERY 3.3
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_TRANSFERENCIA,
          A.ID_CLIENTE,
          0 AS ID_SUCURSAL,
          '99' AS ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          A.FECHA,
          A.GLOSA,
          CASE WHEN B.DC='C' THEN  -1  ELSE 1 END  * B.IMPORTE AS TOTAL,
          CASE WHEN B.DC='C' THEN  -1  ELSE 1 END  * B.IMPORTE_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          C.ID_TIPOVENTA,
          'T' AS TIPO,
          'TRAN: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          D.NUMERO::text AS VOUCHER,
          D.LOTE,
          '99' AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA_TRANSFERENCIA A
          JOIN VENTA_TRANSFERENCIA_DETALLE B
             ON A.ID_TRANSFERENCIA = B.ID_TRANSFERENCIA
          JOIN VENTA_TRANSFERENCIA C
             ON     A.ID_CLIENTE = C.ID_CLIENTE
                AND B.ID_TRANSFERENCIA_P = C.ID_TRANSFERENCIA
          LEFT JOIN CONTA_VOUCHER D ON A.ID_VOUCHER = D.ID_VOUCHER
    WHERE                                                 --A.ES_ANTICIPO = 'S'
          --AND B.DC = 'C'
          --AND
          A.ESTADO = 1::varchar AND B.IMPORTE <> 0
   
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.ID_VENTA,
          A.ID_CLIENTE,
          A.ID_SUCURSAL,
          A.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.SERIE,
          A.NUMERO,
          A.FECHA,
          A.GLOSA,
          CASE WHEN A.ID_COMPROBANTE='07' THEN  -1  ELSE 1 END  * A.TOTAL AS TOTAL,
          CASE WHEN A.ID_COMPROBANTE='07' THEN  -1  ELSE 1 END  * A.TOTAL_ME AS TOTAL_ME,
          A.ID_TIPOTRANSACCION,
          A.ID_TIPOVENTA,
          'V' AS TIPO,
          'NCD: ' || A.SERIE || '-' || A.NUMERO AS MOV,
          B.NUMERO::text AS VOUCHER,
          B.LOTE,
          A.ID_COMPROBANTE AS TIPO_DOCUMENTO,
          A.SERIE || '-' || A.NUMERO AS NUMERO_LEGAL
     FROM VENTA A LEFT JOIN CONTA_VOUCHER B ON A.ID_VOUCHER = B.ID_VOUCHER
    WHERE     A.ID_COMPROBANTE IN ('07', '08')
          AND coalesce(A.ID_PARENT::text, '') = ''
          AND coalesce(A.ID_SALDO::text, '') = ''
          AND coalesce(A.ID_TRANSFERENCIA::text, '') = ''
          AND A.ESTADO = 1::varchar
          AND A.TOTAL <> 0 
   
UNION ALL

   SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          C.ID_VENTA,
          A.ID_PROVEEDOR,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          C.SERIE,
          C.NUMERO,
          C.FECHA,
          SUBSTR(B.DETALLE, 0, 50) AS GLOSA,
          B.IMPORTE * -1 AS TOTAL,
          B.IMPORTE_ME * -1 AS TOTAL_ME,
          C.ID_TIPOTRANSACCION,
          C.ID_TIPOVENTA,
          'D' AS TIPO,
          'DET.-' || A.NRO_OPERACION AS MOV,
          D.NUMERO::text AS VOUCHER,
          D.LOTE,
          '99' AS TIPO_DOCUMENTO,
          A.NUMERO || '-' || A.NRO_OPERACION AS NUMERO_LEGAL
     FROM CAJA_DETRACCION A
          JOIN CAJA_DETRACCION_VENTA B ON A.ID_DETRACCION = B.ID_DETRACCION
          JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA AND A.ID_ANHO = C.ID_ANHO
          LEFT JOIN CONTA_VOUCHER D ON A.ID_VOUCHER = D.ID_VOUCHER
    WHERE A.ESTADO = '1';

