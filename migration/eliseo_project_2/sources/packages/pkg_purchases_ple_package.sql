-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE package        pkg_purchases_ple is
    
    PROCEDURE SP_COMPRA_PLE_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,
        
        cursor OUT SYS_REFCURSOR
    );

    PROCEDURE SP_COMPRA_PLE_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );
    PROCEDURE SP_COMPRA_PLE_5_1_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );

    PROCEDURE SP_COMPRA_PLE_5_1_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );   
    PROCEDURE SP_COMPRA_PLE_5_2_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );

    PROCEDURE SP_COMPRA_PLE_5_2_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );     
end;


CREATE OR REPLACE package body        pkg_purchases_ple is
    
    PROCEDURE SP_COMPRA_PLE_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,
        
        cursor OUT SYS_REFCURSOR
    ) IS
    BEGIN

    if P_ID_ANHO < 2020 then 
        SP_COMPRA_PLE_5_1_SHOW(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
    end if;

    if P_ID_ANHO = 2020 then 
        if P_ID_MES < 11 then 
            SP_COMPRA_PLE_5_1_SHOW(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
        else 
            SP_COMPRA_PLE_5_2_SHOW(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
        end if;
    end if;

    if P_ID_ANHO > 2020 then 
        SP_COMPRA_PLE_5_2_SHOW(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
    end if;

    END SP_COMPRA_PLE_SHOW;

    PROCEDURE SP_COMPRA_PLE_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    BEGIN

    if P_ID_ANHO < 2020 then 
        SP_COMPRA_PLE_5_1_TXT(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
    end if;

    if P_ID_ANHO = 2020 then 
        if P_ID_MES < 11 then 
            SP_COMPRA_PLE_5_1_TXT(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
        else 
            SP_COMPRA_PLE_5_2_TXT(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
        end if;
    end if;

    if P_ID_ANHO > 2020 then 
        SP_COMPRA_PLE_5_2_TXT(P_ID_EMPRESA,P_ID_ENTIDAD,P_ID_DEPTO,P_ID_MES,P_ID_ANHO,cursor);
    end if;

    END SP_COMPRA_PLE_TXT;

    PROCEDURE SP_COMPRA_PLE_5_1_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    BEGIN

    OPEN cursor FOR

    SELECT
                    fecha_ord, ID_COMPRA,
                    id_entidad,
                    FC_NOMBRE_PERSONA(per_user) as usuario,
                    voucher as voucher,
                    trim(periodo) as campo1, 
                    trim(cuo) as campo2,
                    trim(cuo_correlativo) as campo3,
                    trim(fecha_doc) as campo4,
                    trim(fecha_venc) as campo5,
					trim(tipo_doc) as campo6,
					trim(serie) as campo7,
					'0' as campo8, 
					trim(numdoc) as campo9,
					'' as campo10,
                    trim(tipo_doc_identidad) as campo11,
					trim(ruc) as campo12,
					trim(nombre) as campo13,
					trim(baseimp1) as campo14, 
					trim(igv1) as campo15,
					trim(baseimp2) as campo16,  
					trim(igv2) as campo17,
					trim(baseimp3) as campo18, 
					trim(igv3) as campo19,
					trim(baseimp4) as campo20, 
					trim('0.00') as campo21,
					trim(baseimp5) as campo22,
					trim(importe) as campo23,
					trim(moneda) as campo24,  --moneda
					trim(tipo_cambio) as campo25,  --tipo de cambio
					trim(fecha_doc_modifica) as campo26,  --fecha de emision comprobante que modifica
					trim(tipo_doc_modifica) as campo27, --tipo de comprobante de pago que modifica
					trim(serie_modifica) as campo28, --numero de serie del comprobante de pago que se modifica
					'' as campo29,  --codigo de la dependencia aduanera
					trim(numdoc_modifica) as campo30, --numero de comprobante de pago que modifica
					trim(fechadetraccion) as campo31,
					trim(numerodetraccion) as campo32,
					case detrac when 'R' then '1' else '' end as campo33, --marca del comprobante de pago sujeto a retencion
					'' as campo34, 
					'' as campo35, 
					'' as campo36, 
					'' as campo37, 
					'' as campo38, 
					'' as campo39, 
					'' as campo40, 
                                        case 
                                            when (tipo_doc = '03' or tipo_doc = '16')  
                                                then '0' 
                                                else 
                                                    case when 
                                                                (
                                                                TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') =
                                                                TRUNC(fecha_documento, 'month')
                                                                )
                                                        then '1' 
                                                        else 
                                                            case when   
                                                                        (
                                                                        TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') - interval '1' year <=
                                                                        TRUNC(fecha_documento, 'month')
                                                                        )
                                                                        then '6'
                                                                        else '7'
                                                            end
                                                        end                                                                                                 
                                        end as campo41,  --estado que identifica ...
                                        '' as datos
                        from (
                            SELECT 
					A.ID_COMPRA,
                    A.FECHA_DOC as fecha_documento,  
					A.FECHA_PROVISION as fecha_provision, 
                    lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0')||'00' AS periodo, 
                    to_char(A.FECHA_DOC,'MM') as mes_doc,
                    coalesce(ELISEO.FC_CONTA_CUO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo, 
                    coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo_correlativo, 
                    coalesce(to_char(A.FECHA_DOC,'yyyymmdd'),' ') AS fecha_ord, 
                    case A.ID_COMPROBANTE when '104' then '' else 
                    coalesce(to_char(A.FECHA_DOC,'dd/mm/yyyy'),' ') end AS fecha_doc,  
                    coalesce(to_char(A.FECHA_PROVISION,'dd/mm/yyyy'),' ') AS fecha_prov, 
                    case A.ID_COMPROBANTE when '14' then  
                        coalesce(to_char(A.FECHA_VENCIMIENTO,'dd/mm/yyyy'),' ')
                        else '' end AS fecha_venc, 
					coalesce(A.ID_COMPROBANTE,'') AS tipo_doc,  
                    coalesce(A.SERIE,'0') AS serie,  
                    coalesce(A.SERIE,'0') AS serie_after,  
					A.ID_ANHO AS anio,  
                    coalesce(A.NUMERO,'') AS numdoc,  
                    coalesce(A.NUMERO,'') AS numdoc_after,  
					to_char(coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe,
					to_char(coalesce(A.IMPORTE_ME * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe_e,    
					--coalesce(A.ESTADO,' ') AS estado, 
					0 AS diascred, 
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999909.99') AS baseimp5,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3,  
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1_e,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2_e,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3_e,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4_e,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp5_e,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1_e,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2_e,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3_e,
                    to_char(coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS rec_igv_total,
					coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS importe_n,
					coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp1_n,  
					coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp2_n,  
					coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp3_n,  
					coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp4_n,  
					coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp5_n,  
                    coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv1_n,  
					coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv2_n,  
					coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv3_n,  
					coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS rec_igv_total_n,
                    ELISEO.FC_MONEDA_COD_SUNAT(A.ID_MONEDA) AS moneda,
                    to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.OTROS,0),'99999990.99') AS aux_otros,
					coalesce(A.ES_RET_DET,'N') AS detrac,
                    to_char(coalesce(A.IMPORTE-A.IGV,0),'99999990.99') AS rec_importe_neto,    
					coalesce(trim(FC_CAJA_DETRACCION_NUMERO(A.id_compra)),'') AS numerodetraccion, 	--				
					coalesce(FC_CAJA_DETRACCION_FECHA(A.id_compra),'') AS fechadetraccion, --
					coalesce(to_char(C.FECHA_DOC,'dd/mm/yyyy'),'') AS fecha_doc_modifica,
					coalesce(C.ID_COMPROBANTE,' ') AS tipo_doc_modifica,  
					coalesce(C.SERIE,'0') AS serie_modifica,  
					coalesce(C.NUMERO,'0') AS numdoc_modifica,  
					B.NOMBRE AS nombre_before,
					b.NOMBRE AS nombre,                                        
					B.ID_PERSONA as prv_id,  
                    '6' AS tipo_doc_identidad,  
					B.ID_RUC AS ruc,
                    A.ID_ENTIDAD as entidad,
                    A.ID_ENTIDAD AS ID_ENTIDAD,
                    A.ID_PERSONA as per_user,
                    A.ID_VOUCHER as voucher
			FROM CONTA_ENTIDAD E, MOISES.VW_PERSONA_NATURAL_LEGAL B, COMPRA A LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
			WHERE A.ID_PROVEEDOR = b.ID_PERSONA
			AND A.ID_ENTIDAD = E.ID_ENTIDAD
			--AND E.ID_EMPRESA = 207
			AND E.ID_EMPRESA = P_ID_EMPRESA
      AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
      AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
			AND A.ID_ANHO = P_ID_ANHO
			--AND A.id_mes = 3
			AND A.id_mes = P_ID_MES
            AND A.ID_COMPROBANTE NOT IN ('02')
			AND A.Estado = '1'
                    ) a;
    END SP_COMPRA_PLE_5_1_SHOW;

    PROCEDURE SP_COMPRA_PLE_5_1_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    BEGIN

    OPEN cursor FOR

    select
                    fecha_ord, ID_COMPRA, RUC,
                    trim(periodo)||'|'|| 
                    trim(cuo)||'|'||
                    trim(cuo_correlativo)||'|'||
                    trim(fecha_doc)||'|'|| 
                    trim(fecha_venc)||'|'||
					trim(tipo_doc)||'|'||  
					trim(serie)||'|'||  
					'0'||'|'||  
					trim(numdoc)||'|'||  
					''||'|'||
					trim(tipo_doc_identidad)||'|'||
					trim(ruc)||'|'||
					trim(nombre)||'|'||
					trim(baseimp1)||'|'||  
					trim(igv1)||'|'||  
					trim(baseimp2)||'|'||  
					trim(igv2)||'|'||  
					trim(baseimp3)||'|'|| 
					trim(igv3)||'|'||  
					trim(baseimp4)||'|'|| 
					trim('0.00')||'|'|| 
					trim(baseimp5)||'|'|| 
					trim(importe)||'|'||
					trim(moneda)||'|'||  --tipo de cambio
					trim(tipo_cambio)||'|'||  --tipo de cambio
					trim(fecha_doc_modifica)||'|'||  --fecha de emision comprobante que modifica
					trim(tipo_doc_modifica)||'|'||  --tipo de comprobante de pago que modifica
					trim(serie_modifica)||'|'||  --numero de serie del comprobante de pago que se modifica
					''||'|'||  --codigo de la dependencia aduanera
					trim(numdoc_modifica)||'|'||  --numero de comprobante de pago que modifica

					trim(fechadetraccion)||'|'||                                         
					trim(numerodetraccion)||'|'||
					case detrac when 'R' then '1' else '' end ||'|'||  --marca del comprobante de pago sujeto a retencion
					''||'|'||  --34
					''||'|'||  --35
					''||'|'||  --36
					''||'|'||  --37
					''||'|'||  --38
					''||'|'||  --39
					'1'||'|'||  --40
                                        case 
                                            when (tipo_doc = '03' or tipo_doc = '16') 
                                                then '0' 
                                                else 
                                                    case when 
                                                                (
                                                                TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') =
                                                                TRUNC(fecha_documento, 'month')
                                                                )
                                                        then '1' 
                                                        else 
                                                            case when   
                                                                        (
                                                                        TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') - interval '1' year <=
                                                                        TRUNC(fecha_documento, 'month')
                                                                        )
                                                                        then '6'
                                                                        else '7'
                                                            end
                                                        end                                                                                                 
                                        end ||'||'||  --estado que identifica ...
                                        '' as datos

                        from (
                            SELECT 
					A.ID_COMPRA,
                    A.FECHA_DOC as fecha_documento,  
					A.FECHA_PROVISION as fecha_provision, 
                    lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0')||'00' AS periodo, 
                    to_char(A.FECHA_DOC,'MM') as mes_doc,
                    coalesce(ELISEO.FC_CONTA_CUO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo, 
                    coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo_correlativo, 
                    coalesce(to_char(A.FECHA_DOC,'yyyymmdd'),' ') AS fecha_ord, 
                    case A.ID_COMPROBANTE when '104' then '' else 
                    coalesce(to_char(A.FECHA_DOC,'dd/mm/yyyy'),' ') end AS fecha_doc,  
					coalesce(to_char(A.FECHA_PROVISION,'dd/mm/yyyy'),' ') AS fecha_prov, 
                    case A.ID_COMPROBANTE when '14' then  
                        coalesce(to_char(A.FECHA_VENCIMIENTO,'dd/mm/yyyy'),' ')
                        else '' end AS fecha_venc, 
					coalesce(A.ID_COMPROBANTE,'') AS tipo_doc,  
                    coalesce(A.SERIE,'0') AS serie,  
                    coalesce(A.SERIE,'0') AS serie_after,  
					A.ID_ANHO AS anio,  
                    coalesce(A.NUMERO,'') AS numdoc,  
                    coalesce(A.NUMERO,'') AS numdoc_after,  
					to_char(coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe,
					to_char(coalesce(A.IMPORTE_ME * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe_e,    
					--coalesce(A.ESTADO,' ') AS estado, 
					0 AS diascred, 
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999909.99') AS baseimp5,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3,  
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1_e,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2_e,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3_e,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4_e,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp5_e,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1_e,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2_e,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3_e,
                    to_char(coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS rec_igv_total,
					coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS importe_n,
					coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp1_n,  
					coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp2_n,  
					coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp3_n,  
					coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp4_n,  
					coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp5_n,  
                    coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv1_n,  
					coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv2_n,  
					coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv3_n,  
					coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS rec_igv_total_n,
                    ELISEO.FC_MONEDA_COD_SUNAT(A.ID_MONEDA) AS moneda,
                    to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.OTROS,0),'99999990.99') AS aux_otros,
					coalesce(A.ES_RET_DET,'N') AS detrac,
                    to_char(coalesce(A.IMPORTE-A.IGV,0),'99999990.99') AS rec_importe_neto,    
					coalesce(trim(FC_CAJA_DETRACCION_NUMERO(A.id_compra)),'') AS numerodetraccion, 	--				
					coalesce(FC_CAJA_DETRACCION_FECHA(A.id_compra),'') AS fechadetraccion, --
					coalesce(to_char(C.FECHA_DOC,'dd/mm/yyyy'),'') AS fecha_doc_modifica,
					coalesce(C.ID_COMPROBANTE,' ') AS tipo_doc_modifica,  
					coalesce(C.SERIE,'0') AS serie_modifica,  
					coalesce(C.NUMERO,'0') AS numdoc_modifica,  
					B.NOMBRE AS nombre_before,
					b.NOMBRE AS nombre,                                        
					B.ID_PERSONA as prv_id,  
                    '6' AS tipo_doc_identidad,  
					B.ID_RUC AS ruc,
                    A.ID_ENTIDAD as entidad,
                    A.ID_ENTIDAD AS ID_ENTIDAD,
                    A.ID_PERSONA as per_user,
                    A.ID_VOUCHER as voucher
			FROM CONTA_ENTIDAD E, MOISES.VW_PERSONA_NATURAL_LEGAL B, COMPRA A LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
			WHERE A.ID_PROVEEDOR = b.ID_PERSONA
			AND A.ID_ENTIDAD = E.ID_ENTIDAD
			AND E.ID_EMPRESA = P_ID_EMPRESA
      AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
      AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
			AND A.id_mes = P_ID_MES
			AND A.id_anho = P_ID_ANHO
            AND A.ID_COMPROBANTE NOT IN ('02')
			AND A.Estado = '1'
                    ) a;
    END SP_COMPRA_PLE_5_1_TXT;
    PROCEDURE SP_COMPRA_PLE_5_2_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    BEGIN

    OPEN cursor FOR

    SELECT
                    fecha_ord, ID_COMPRA,
                    id_entidad,
                    FC_NOMBRE_PERSONA(per_user) as usuario,
                    voucher as voucher,
                    trim(periodo) as campo1, 
                    trim(cuo) as campo2,
                    trim(cuo_correlativo) as campo3,
                    trim(fecha_doc) as campo4,
                    trim(fecha_venc) as campo5,
					trim(tipo_doc) as campo6,
					trim(serie) as campo7,
					'0' as campo8, 
					trim(numdoc) as campo9,
					'' as campo10,
                    trim(tipo_doc_identidad) as campo11,
					trim(ruc) as campo12,
					trim(nombre) as campo13,
					trim(baseimp1) as campo14, 
					trim(igv1) as campo15,
					trim(baseimp2) as campo16,  
					trim(igv2) as campo17,
					trim(baseimp3) as campo18, 
					trim(igv3) as campo19,
					trim(baseimp4) as campo20, 
					trim(isc) as campo21,
					trim('0.00') as campo22,
					trim(baseimp5) as campo23,
					trim(importe) as campo24,
					trim(moneda) as campo25,  --moneda
					trim(tipo_cambio) as campo26,  --tipo de cambio
					trim(fecha_doc_modifica) as campo27,  --fecha de emision comprobante que modifica
					trim(tipo_doc_modifica) as campo28, --tipo de comprobante de pago que modifica
					trim(serie_modifica) as campo29, --numero de serie del comprobante de pago que se modifica
					'' as campo30,  --codigo de la dependencia aduanera
					trim(numdoc_modifica) as campo31, --numero de comprobante de pago que modifica
					trim(fechadetraccion) as campo32,
					trim(numerodetraccion) as campo33,
					case detrac when 'R' then '1' else '' end as campo34, --marca del comprobante de pago sujeto a retencion
					'' as campo35, 
					'' as campo36, 
					'' as campo37, 
					'' as campo38, 
					'' as campo39, 
					'' as campo40, 
					'' as campo41, 
                                        case 
                                            when (tipo_doc = '03' or tipo_doc = '16')  
                                                then '0' 
                                                else 
                                                    case when 
                                                                (
                                                                TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') =
                                                                TRUNC(fecha_documento, 'month')
                                                                )
                                                        then '1' 
                                                        else 
                                                            case when   
                                                                        (
                                                                        TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') - interval '1' year <=
                                                                        TRUNC(fecha_documento, 'month')
                                                                        )
                                                                        then '6'
                                                                        else '7'
                                                            end
                                                        end                                                                                                 
                                        end as campo42,  --estado que identifica ...
                                        '' as datos
                        from (
                            SELECT 
					A.ID_COMPRA,
                    A.FECHA_DOC as fecha_documento,  
					A.FECHA_PROVISION as fecha_provision, 
                    lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0')||'00' AS periodo, 
                    to_char(A.FECHA_DOC,'MM') as mes_doc,
                    coalesce(ELISEO.FC_CONTA_CUO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo, 
                    coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo_correlativo, 
                    coalesce(to_char(A.FECHA_DOC,'yyyymmdd'),' ') AS fecha_ord, 
                    case A.ID_COMPROBANTE when '104' then '' else 
                    coalesce(to_char(A.FECHA_DOC,'dd/mm/yyyy'),' ') end AS fecha_doc,  
                    coalesce(to_char(A.FECHA_PROVISION,'dd/mm/yyyy'),' ') AS fecha_prov, 
                    case A.ID_COMPROBANTE when '14' then  
                        coalesce(to_char(A.FECHA_VENCIMIENTO,'dd/mm/yyyy'),' ')
                        else '' end AS fecha_venc, 
					coalesce(A.ID_COMPROBANTE,'') AS tipo_doc,  
                    coalesce(A.SERIE,'0') AS serie,  
                    coalesce(A.SERIE,'0') AS serie_after,  
					A.ID_ANHO AS anio,  
                    coalesce(A.NUMERO,'') AS numdoc,  
                    coalesce(A.NUMERO,'') AS numdoc_after,  
					to_char(coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe,
					to_char(coalesce(A.IMPORTE_ME * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe_e,    
					--coalesce(A.ESTADO,' ') AS estado, 
					0 AS diascred, 
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4,  
					to_char(coalesce(A.isc * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999909.99') AS isc,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999909.99') AS baseimp5,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3,  
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1_e,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2_e,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3_e,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4_e,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp5_e,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1_e,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2_e,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3_e,
                    to_char(coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS rec_igv_total,
					coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS importe_n,
					coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp1_n,  
					coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp2_n,  
					coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp3_n,  
					coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp4_n,  
					coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp5_n,  
                    coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv1_n,  
					coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv2_n,  
					coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv3_n,  
					coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS rec_igv_total_n,
                    ELISEO.FC_MONEDA_COD_SUNAT(A.ID_MONEDA) AS moneda,
                    to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.OTROS,0),'99999990.99') AS aux_otros,
					coalesce(A.ES_RET_DET,'N') AS detrac,
                    to_char(coalesce(A.IMPORTE-A.IGV,0),'99999990.99') AS rec_importe_neto,    
					coalesce(trim(FC_CAJA_DETRACCION_NUMERO(A.id_compra)),'') AS numerodetraccion, 	--				
					coalesce(FC_CAJA_DETRACCION_FECHA(A.id_compra),'') AS fechadetraccion, --
					coalesce(to_char(C.FECHA_DOC,'dd/mm/yyyy'),'') AS fecha_doc_modifica,
					coalesce(C.ID_COMPROBANTE,' ') AS tipo_doc_modifica,  
					coalesce(C.SERIE,'0') AS serie_modifica,  
					coalesce(C.NUMERO,'0') AS numdoc_modifica,  
					B.NOMBRE AS nombre_before,
					b.NOMBRE AS nombre,                                        
					B.ID_PERSONA as prv_id,  
                    '6' AS tipo_doc_identidad,  
					B.ID_RUC AS ruc,
                    A.ID_ENTIDAD as entidad,
                    A.ID_ENTIDAD AS ID_ENTIDAD,
                    A.ID_PERSONA as per_user,
                    A.ID_VOUCHER as voucher
			FROM CONTA_ENTIDAD E, MOISES.VW_PERSONA_NATURAL_LEGAL B, COMPRA A LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
			WHERE A.ID_PROVEEDOR = b.ID_PERSONA
			AND A.ID_ENTIDAD = E.ID_ENTIDAD
			--AND E.ID_EMPRESA = 207
			AND E.ID_EMPRESA = P_ID_EMPRESA
      AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
      AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
			AND A.ID_ANHO = P_ID_ANHO
			--AND A.id_mes = 3
			AND A.id_mes = P_ID_MES
            AND A.ID_COMPROBANTE NOT IN ('02')
			AND A.Estado = '1'
                    ) a;
    END SP_COMPRA_PLE_5_2_SHOW;

    PROCEDURE SP_COMPRA_PLE_5_2_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    BEGIN

    OPEN cursor FOR

    select
                    fecha_ord, ID_COMPRA, RUC,
                    trim(periodo)||'|'|| 
                    trim(cuo)||'|'||
                    trim(cuo_correlativo)||'|'||
                    trim(fecha_doc)||'|'|| 
                    trim(fecha_venc)||'|'||
					trim(tipo_doc)||'|'||  
					trim(serie)||'|'||  
					'0'||'|'||  
					trim(numdoc)||'|'||  
					''||'|'||
					trim(tipo_doc_identidad)||'|'||
					trim(ruc)||'|'||
					trim(nombre)||'|'||
					trim(baseimp1)||'|'||  
					trim(igv1)||'|'||  
					trim(baseimp2)||'|'||  
					trim(igv2)||'|'||  
					trim(baseimp3)||'|'|| 
					trim(igv3)||'|'||  
					trim(baseimp4)||'|'|| 
					trim(isc)||'|'|| 
					trim('0.00')||'|'|| 
					trim(baseimp5)||'|'|| 
					trim(importe)||'|'||
					trim(moneda)||'|'||  --tipo de cambio
					trim(tipo_cambio)||'|'||  --tipo de cambio
					trim(fecha_doc_modifica)||'|'||  --fecha de emision comprobante que modifica
					trim(tipo_doc_modifica)||'|'||  --tipo de comprobante de pago que modifica
					trim(serie_modifica)||'|'||  --numero de serie del comprobante de pago que se modifica
					''||'|'||  --codigo de la dependencia aduanera
					trim(numdoc_modifica)||'|'||  --numero de comprobante de pago que modifica

					trim(fechadetraccion)||'|'||                                         
					trim(numerodetraccion)||'|'||
					case detrac when 'R' then '1' else '' end ||'|'||  --marca del comprobante de pago sujeto a retencion
					''||'|'||  --35
					''||'|'||  --36
					''||'|'||  --37
					''||'|'||  --38
					''||'|'||  --39
					''||'|'||  --40
					'1'||'|'||  --41
                                        case 
                                            when (tipo_doc = '03' or tipo_doc = '16') 
                                                then '0' 
                                                else 
                                                    case when 
                                                                (
                                                                TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') =
                                                                TRUNC(fecha_documento, 'month')
                                                                )
                                                        then '1' 
                                                        else 
                                                            case when   
                                                                        (
                                                                        TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') - interval '1' year <=
                                                                        TRUNC(fecha_documento, 'month')
                                                                        )
                                                                        then '6'
                                                                        else '7'
                                                            end
                                                        end                                                                                                 
                                        end ||'||'||  --estado que identifica ...
                                        '' as datos

                        from (
                            SELECT 
					A.ID_COMPRA,
                    A.FECHA_DOC as fecha_documento,  
					A.FECHA_PROVISION as fecha_provision, 
                    lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0')||'00' AS periodo, 
                    to_char(A.FECHA_DOC,'MM') as mes_doc,
                    coalesce(ELISEO.FC_CONTA_CUO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo, 
                    coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo_correlativo, 
                    coalesce(to_char(A.FECHA_DOC,'yyyymmdd'),' ') AS fecha_ord, 
                    case A.ID_COMPROBANTE when '104' then '' else 
                    coalesce(to_char(A.FECHA_DOC,'dd/mm/yyyy'),' ') end AS fecha_doc,  
					coalesce(to_char(A.FECHA_PROVISION,'dd/mm/yyyy'),' ') AS fecha_prov, 
                    case A.ID_COMPROBANTE when '14' then  
                        coalesce(to_char(A.FECHA_VENCIMIENTO,'dd/mm/yyyy'),' ')
                        else '' end AS fecha_venc, 
					coalesce(A.ID_COMPROBANTE,'') AS tipo_doc,  
                    coalesce(A.SERIE,'0') AS serie,  
                    coalesce(A.SERIE,'0') AS serie_after,  
					A.ID_ANHO AS anio,  
                    coalesce(A.NUMERO,'') AS numdoc,  
                    coalesce(A.NUMERO,'') AS numdoc_after,  
					to_char(coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe,
					to_char(coalesce(A.IMPORTE_ME * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe_e,    
					--coalesce(A.ESTADO,' ') AS estado, 
					0 AS diascred, 
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4,  
					to_char(coalesce(A.ISC * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999909.99') AS isc,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999909.99') AS baseimp5,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3,  
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1_e,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2_e,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3_e,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4_e,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp5_e,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1_e,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2_e,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3_e,
                    to_char(coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS rec_igv_total,
					coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS importe_n,
					coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp1_n,  
					coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp2_n,  
					coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp3_n,  
					coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp4_n,  
					coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp5_n,  
                    coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv1_n,  
					coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv2_n,  
					coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv3_n,  
					coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS rec_igv_total_n,
                    ELISEO.FC_MONEDA_COD_SUNAT(A.ID_MONEDA) AS moneda,
                    to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.OTROS,0),'99999990.99') AS aux_otros,
					coalesce(A.ES_RET_DET,'N') AS detrac,
                    to_char(coalesce(A.IMPORTE-A.IGV,0),'99999990.99') AS rec_importe_neto,    
					coalesce(trim(FC_CAJA_DETRACCION_NUMERO(A.id_compra)),'') AS numerodetraccion, 	--				
					coalesce(FC_CAJA_DETRACCION_FECHA(A.id_compra),'') AS fechadetraccion, --
					coalesce(to_char(C.FECHA_DOC,'dd/mm/yyyy'),'') AS fecha_doc_modifica,
					coalesce(C.ID_COMPROBANTE,' ') AS tipo_doc_modifica,  
					coalesce(C.SERIE,'0') AS serie_modifica,  
					coalesce(C.NUMERO,'0') AS numdoc_modifica,  
					B.NOMBRE AS nombre_before,
					b.NOMBRE AS nombre,                                        
					B.ID_PERSONA as prv_id,  
                    '6' AS tipo_doc_identidad,  
					B.ID_RUC AS ruc,
                    A.ID_ENTIDAD as entidad,
                    A.ID_ENTIDAD AS ID_ENTIDAD,
                    A.ID_PERSONA as per_user,
                    A.ID_VOUCHER as voucher
			FROM CONTA_ENTIDAD E, MOISES.VW_PERSONA_NATURAL_LEGAL B, COMPRA A LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
			WHERE A.ID_PROVEEDOR = b.ID_PERSONA
			AND A.ID_ENTIDAD = E.ID_ENTIDAD
			AND E.ID_EMPRESA = P_ID_EMPRESA
      AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
      AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
			AND A.id_mes = P_ID_MES
			AND A.id_anho = P_ID_ANHO
            AND A.ID_COMPROBANTE NOT IN ('02')
			AND A.Estado = '1'
                    ) a;
    END SP_COMPRA_PLE_5_2_TXT;    

end pkg_purchases_ple;