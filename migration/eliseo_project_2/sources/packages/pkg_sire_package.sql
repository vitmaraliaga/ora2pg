-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE        PKG_SIRE
AS
	PROCEDURE SP_SIRE_RCE_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );
    PROCEDURE SP_SIRE_RCE_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );
   
   	PROCEDURE SP_SIRE_RVIE_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    );
    
   	FUNCTION FC_PROVEEDOR_RUC(P_RUC_PROVEEDOR VARCHAR2) RETURN NUMBER;
    FUNCTION FC_CLIENTE_NUMDOC(P_NUMDOC_CLIENTE VARCHAR2) RETURN NUMBER;
  	FUNCTION FC_PROVEEDOR(P_ID_PROVEEDOR NUMBER) RETURN VARCHAR2;
 	FUNCTION FC_RUC(P_ID_PROVEEDOR NUMBER) RETURN VARCHAR2;
-- Package header
END PKG_SIRE;


CREATE OR REPLACE PACKAGE BODY        PKG_SIRE
AS

   	PROCEDURE SP_SIRE_RCE_SHOW(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    	l_empresa_ruc VARCHAR2(20) := '';
    	l_empresa_rs VARCHAR2(250) := '';
    BEGIN
	    
		SELECT ce2.ID_RUC, ce2.RAZON_SOCIAL INTO l_empresa_ruc, l_empresa_rs FROM CONTA_EMPRESA ce2 
		WHERE ce2.ID_EMPRESA =P_ID_EMPRESA;
		

    OPEN cursor FOR

    SELECT
                    fecha_ord, ID_COMPRA,
                    id_entidad,
                    FC_NOMBRE_PERSONA(per_user) as usuario,
                    voucher as voucher,
                    -- Se agrega
                    TRIM(l_empresa_ruc) AS campo1,
                    TRIM(l_empresa_rs) AS campo2,
                    TRIM(periodo) AS campo3,
                    '' as campo4, 
                    
                    --Se elimina
                    --trim(periodo) as campo1, 
                    --trim(cuo) as campo2,
                    --trim(cuo_correlativo) as campo3,
                    -- Se mantiene
                    trim(fecha_doc) as campo5,
                    trim(fecha_venc) as campo6,
					trim(tipo_doc) as campo7,
					trim(serie) as campo8,
					'0' as campo9, 
					trim(numdoc) as campo10,
					'' as campo11,
                    trim(tipo_doc_identidad) as campo12,
					trim(ruc) as campo13,
					trim(nombre) as campo14,
					trim(baseimp1) as campo15, 
					trim(igv1) as campo16,
					trim(baseimp2) as campo17,  
					trim(igv2) as campo18,
					trim(baseimp3) as campo19, 
					trim(igv3) as campo20,
					trim(baseimp4) as campo21, 
					trim(isc) as campo22,
					trim('0.00') as campo23,
					trim(baseimp5) as campo24,
					trim(importe) as campo25,
					trim(moneda) as campo26,  --moneda
					trim(tipo_cambio) as campo27,  --tipo de cambio
					trim(fecha_doc_modifica) as campo28,  --fecha de emision comprobante que modifica
					trim(tipo_doc_modifica) as campo29, --tipo de comprobante de pago que modifica
					trim(serie_modifica) as campo30, --numero de serie del comprobante de pago que se modifica
					'' as campo31,  --codigo de la dependencia aduanera
					trim(numdoc_modifica) as campo32, --numero de comprobante de pago que modifica
					--trim(fechadetraccion) as campo33,
					'' as campo33,
					--trim(numerodetraccion) as campo34,
					'' as campo34,
					--
					--case detrac when 'R' then '1' else '' end as campo34, --marca del comprobante de pago sujeto a retencion
					 '' as campo35, 
					 '' as campo36, 
					 '' as campo37, 
					 '' as campo38, 
					 '' as campo39, 
					 '' as campo40, 
					 '' as campo41
					,'' AS campo42
					,'' AS campo43
					/*
                                        case 
                                            when (tipo_doc = '03' or tipo_doc = '16')  
                                                then '0' 
                                                else 
                                                    case when 
                                                                (
                                                                TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') =
                                                                TRUNC(fecha_documento, 'month')
                                                                )
                                                        then '1' 
                                                        else 
                                                            case when   
                                                                        (
                                                                        TRUNC(to_date(lpad(P_ID_ANHO,4,'0')||'-'||lpad(P_ID_MES,2,'0')||'-01','yyyy-mm-dd'), 'month') - interval '1' year <=
                                                                        TRUNC(fecha_documento, 'month')
                                                                        )
                                                                        then '6'
                                                                        else '7'
                                                            end
                                                        end                                                                                                 
                                        end as campo42,  --estado que identifica ...
                                        '' as datos
                                        */
                        from (
                            SELECT 
					A.ID_COMPRA,
                    A.FECHA_DOC as fecha_documento,  
					A.FECHA_PROVISION as fecha_provision, 
                    --lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0')||'00' AS periodo, 
                    lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0') AS periodo, 
					to_char(A.FECHA_DOC,'MM') as mes_doc,
                    coalesce(ELISEO.FC_CONTA_CUO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo, 
                    coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo_correlativo, 
                    coalesce(to_char(A.FECHA_DOC,'yyyymmdd'),' ') AS fecha_ord, 
                    case A.ID_COMPROBANTE when '104' then '' else 
                    coalesce(to_char(A.FECHA_DOC,'dd/mm/yyyy'),' ') end AS fecha_doc,  
                    coalesce(to_char(A.FECHA_PROVISION,'dd/mm/yyyy'),' ') AS fecha_prov, 
                    case A.ID_COMPROBANTE when '14' then  
                        coalesce(to_char(A.FECHA_VENCIMIENTO,'dd/mm/yyyy'),' ')
                        else '' end AS fecha_venc, 
					coalesce(A.ID_COMPROBANTE,'') AS tipo_doc,  
                    coalesce(A.SERIE,'0') AS serie,  
                    coalesce(A.SERIE,'0') AS serie_after,  
					A.ID_ANHO AS anio,  
                    coalesce(A.NUMERO,'') AS numdoc,  
                    coalesce(A.NUMERO,'') AS numdoc_after,  
					to_char(coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe,
					to_char(coalesce(A.IMPORTE_ME * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe_e,    
					--coalesce(A.ESTADO,' ') AS estado, 
					0 AS diascred, 
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4,  
					to_char(coalesce(A.isc * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999990.99') AS isc,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999990.99') AS baseimp5,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3,  
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1_e,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2_e,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3_e,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4_e,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp5_e,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1_e,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2_e,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3_e,
                    to_char(coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS rec_igv_total,
					coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS importe_n,
					coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp1_n,  
					coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp2_n,  
					coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp3_n,  
					coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp4_n,  
					coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp5_n,  
                    coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv1_n,  
					coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv2_n,  
					coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv3_n,  
					coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS rec_igv_total_n,
                    ELISEO.FC_MONEDA_COD_SUNAT(A.ID_MONEDA) AS moneda,
                    --to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.OTROS,0),'99999990.99') AS aux_otros,
					coalesce(A.ES_RET_DET,'N') AS detrac,
                    to_char(coalesce(A.IMPORTE-A.IGV,0),'99999990.99') AS rec_importe_neto,    
					coalesce(trim(FC_CAJA_DETRACCION_NUMERO(A.id_compra)),'') AS numerodetraccion, 	--				
					coalesce(FC_CAJA_DETRACCION_FECHA(A.id_compra),'') AS fechadetraccion, --
					coalesce(to_char(C.FECHA_DOC,'dd/mm/yyyy'),'') AS fecha_doc_modifica,
					coalesce(C.ID_COMPROBANTE,' ') AS tipo_doc_modifica,  
					coalesce(C.SERIE,'0') AS serie_modifica,  
					coalesce(C.NUMERO,'0') AS numdoc_modifica,  
					B.NOMBRE AS nombre_before,
					b.NOMBRE AS nombre,                                        
					B.ID_PERSONA as prv_id,  
                    '6' AS tipo_doc_identidad,  
					B.ID_RUC AS ruc,
                    A.ID_ENTIDAD as entidad,
                    A.ID_ENTIDAD AS ID_ENTIDAD,
                    A.ID_PERSONA as per_user,
                    A.ID_VOUCHER as voucher
			FROM CONTA_ENTIDAD E, MOISES.VW_PERSONA_NATURAL_LEGAL B, COMPRA A LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
			WHERE A.ID_PROVEEDOR = b.ID_PERSONA
			AND A.ID_ENTIDAD = E.ID_ENTIDAD
			--AND E.ID_EMPRESA = 207
			AND E.ID_EMPRESA = P_ID_EMPRESA
      AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
      AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
			AND A.ID_ANHO = P_ID_ANHO
			--AND A.id_mes = 3
			AND A.id_mes = P_ID_MES
            AND A.ID_COMPROBANTE NOT IN ('02')
			AND A.Estado = '1'
                    ) a;
    END SP_SIRE_RCE_SHOW;
   
   PROCEDURE SP_SIRE_RCE_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    	l_empresa_ruc VARCHAR2(20) := '';
    	l_empresa_rs VARCHAR2(250) := '';
    BEGIN
	    
		SELECT ce2.ID_RUC, ce2.RAZON_SOCIAL INTO l_empresa_ruc, l_empresa_rs FROM CONTA_EMPRESA ce2 
		WHERE ce2.ID_EMPRESA =P_ID_EMPRESA;

    OPEN cursor FOR

    select
                    fecha_ord, ID_COMPRA, RUC,
                    TRIM(l_empresa_ruc)||'|'|| 
                    TRIM(l_empresa_rs)||'|'|| 
                    TRIM(periodo)||'|'|| 
                    ''||'|'|| 
                    trim(fecha_doc)||'|'|| 
                    trim(fecha_venc)||'|'||
					trim(tipo_doc)||'|'||  
					trim(serie)||'|'||  
					''||'|'||  
					trim(numdoc)||'|'||  
					''||'|'||
					trim(tipo_doc_identidad)||'|'||
					trim(ruc)||'|'||
					trim(nombre)||'|'||
					trim(baseimp1)||'|'||  
					trim(igv1)||'|'||  
					trim(baseimp2)||'|'||  
					trim(igv2)||'|'||  
					trim(baseimp3)||'|'|| 
					trim(igv3)||'|'||  
					trim(baseimp4)||'|'|| 
					trim(isc)||'|'|| 
					trim('0.00')||'|'|| 
					trim(baseimp5)||'|'|| 
					trim(importe)||'|'||
					trim(moneda)||'|'||  --moneda
					CASE WHEN moneda <> 'PEN' THEN trim(tipo_cambio) ELSE '' END ||'|'||  --tipo de cambio
					trim(fecha_doc_modifica)||'|'||  --fecha de emision comprobante que modifica
					trim(tipo_doc_modifica)||'|'||  --tipo de comprobante de pago que modifica
					CASE WHEN tipo_doc IN ('07','08','87','88') then trim(serie_modifica) ELSE '' END ||'|'||  --numero de serie del comprobante de pago que se modifica
					''||'|'||  --codigo de la dependencia aduanera
					trim(numdoc_modifica)||'|'||  --numero de comprobante de pago que modifica
					''||'|'|| 
					''||'|'|| 
					''||'|'||  --35
					''||'|'||  --36
					''||'|'||  --37
					''||'|'||  --38
					''||'|'||  --39
					''||'|'||  --40
					''||'|'||  --41
					''||'|'||  --42
					''||'|'||  --43
					'' as datos
                        from (
                            SELECT 
					A.ID_COMPRA,
                    A.FECHA_DOC as fecha_documento,  
					A.FECHA_PROVISION as fecha_provision, 
                    lpad(A.ID_ANHO,4,'0')||lpad(A.ID_MES,2,'0') AS periodo, 
                    to_char(A.FECHA_DOC,'MM') as mes_doc,
                    coalesce(ELISEO.FC_CONTA_CUO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo, 
                    coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO(A.ID_TIPOORIGEN, A.ID_COMPRA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES),'') AS cuo_correlativo, 
                    coalesce(to_char(A.FECHA_DOC,'yyyymmdd'),' ') AS fecha_ord, 
                    case A.ID_COMPROBANTE when '104' then '' else 
                    coalesce(to_char(A.FECHA_DOC,'dd/mm/yyyy'),' ') end AS fecha_doc,  
					coalesce(to_char(A.FECHA_PROVISION,'dd/mm/yyyy'),' ') AS fecha_prov, 
                    case A.ID_COMPROBANTE when '14' then  
                        coalesce(to_char(A.FECHA_VENCIMIENTO,'dd/mm/yyyy'),' ')
                        else '' end AS fecha_venc, 
					coalesce(A.ID_COMPROBANTE,'') AS tipo_doc,  
                    coalesce(A.SERIE,'0') AS serie,  
                    coalesce(A.SERIE,'0') AS serie_after,  
					A.ID_ANHO AS anio,  
                    coalesce(A.NUMERO,'') AS numdoc,  
                    coalesce(A.NUMERO,'') AS numdoc_after,  
					to_char(coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe,
					to_char(coalesce(A.IMPORTE_ME * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS importe_e,    
					0 AS diascred, 
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4,  
					to_char(coalesce(A.ISC * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999990.99') AS isc,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'999999990.99') AS baseimp5,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3,  
					to_char(coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp1_e,  
					to_char(coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp2_e,  
					to_char(coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp3_e,  
					to_char(coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp4_e,  
					to_char(coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS baseimp5_e,  
					to_char(coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv1_e,  
					to_char(coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv2_e,  
					to_char(coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS igv3_e,
                    to_char(coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0),'99999990.99') AS rec_igv_total,
					coalesce(A.IMPORTE * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS importe_n,
					coalesce(A.BASE_GRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp1_n,  
					coalesce(A.BASE_MIXTA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp2_n,  
					coalesce(A.BASE_NOGRAVADA * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp3_n,  
					coalesce(A.BASE_SINCREDITO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp4_n,  
					coalesce(A.OTROS * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS baseimp5_n,  
                    coalesce(A.IGV_GRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv1_n,  
					coalesce(A.IGV_MIXTO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv2_n,  
					coalesce(A.IGV_NOGRAVADO * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS igv3_n,  
					coalesce(A.IGV * case when A.ID_COMPROBANTE like '07' then -1 when A.ID_COMPROBANTE like '87' then -1 else 1 end,0) AS rec_igv_total_n,
                    ELISEO.FC_MONEDA_COD_SUNAT(A.ID_MONEDA) AS moneda,
                    to_char(coalesce(A.TIPOCAMBIO,0),'0.000') AS tipo_cambio,
                    to_char(coalesce(A.OTROS,0),'99999990.99') AS aux_otros,
					coalesce(A.ES_RET_DET,'N') AS detrac,
                    to_char(coalesce(A.IMPORTE-A.IGV,0),'99999990.99') AS rec_importe_neto,    
					coalesce(trim(FC_CAJA_DETRACCION_NUMERO(A.id_compra)),'') AS numerodetraccion, 	--				
					coalesce(FC_CAJA_DETRACCION_FECHA(A.id_compra),'') AS fechadetraccion, --
					coalesce(to_char(C.FECHA_DOC,'dd/mm/yyyy'),'') AS fecha_doc_modifica,
					coalesce(C.ID_COMPROBANTE,' ') AS tipo_doc_modifica,  
					coalesce(C.SERIE,'0') AS serie_modifica,  
					coalesce(C.NUMERO,'0') AS numdoc_modifica,  
					B.NOMBRE AS nombre_before,
					b.NOMBRE AS nombre,                                        
					B.ID_PERSONA as prv_id,  
                    '6' AS tipo_doc_identidad,  
					B.ID_RUC AS ruc,
                    A.ID_ENTIDAD as entidad,
                    A.ID_ENTIDAD AS ID_ENTIDAD,
                    A.ID_PERSONA as per_user,
                    A.ID_VOUCHER as voucher
			FROM COMPRA A 
				INNER JOIN CONTA_ENTIDAD E ON A.ID_ENTIDAD = E.ID_ENTIDAD
				INNER JOIN MOISES.VW_PERSONA_NATURAL_LEGAL B ON A.ID_PROVEEDOR = b.ID_PERSONA
				LEFT JOIN COMPRA C ON A.ID_PARENT = c.ID_COMPRA
			WHERE E.ID_EMPRESA = P_ID_EMPRESA
		      	AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
		      	AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
				AND A.ID_MES = P_ID_MES
				AND A.ID_ANHO = P_ID_ANHO
	            AND A.ID_COMPROBANTE NOT IN ('02',
	            -- menos compras duas y invoices
	            '00', '46', '50', '91', '97', '98'
	            )
				AND A.Estado = '1'
                    ) a;
    END SP_SIRE_RCE_TXT;
   
    PROCEDURE SP_SIRE_RVIE_TXT(
        P_ID_EMPRESA NUMBER, 
        P_ID_ENTIDAD NUMBER, 
        P_ID_DEPTO VARCHAR2,
        P_ID_MES NUMBER,
        P_ID_ANHO NUMBER,

        cursor OUT SYS_REFCURSOR
    ) IS
    	l_empresa_ruc VARCHAR2(20) := '';
    	l_empresa_rs VARCHAR2(250) := '';
    BEGIN
	    
		SELECT ce2.ID_RUC, ce2.RAZON_SOCIAL INTO l_empresa_ruc, l_empresa_rs FROM CONTA_EMPRESA ce2 
		WHERE ce2.ID_EMPRESA =P_ID_EMPRESA;

    OPEN cursor FOR

    SELECT
        A.id_depto,
        A.id_venta,
        A.glosa,
        A.total,
        trim(campo_1) as campo1,
        trim(campo_2) as campo2,
        trim(campo_3) as campo3,
        trim(campo_4) as campo4,
        trim(campo_5) as campo5,
        trim(campo_6) as campo6,
        trim(campo_7) as campo7,
        trim(campo_8) as campo8,
        trim(campo_9) as campo9,
        trim(campo_10) as campo10,
        trim(campo_11) as campo11,
        trim(campo_12) as campo12,
        trim(campo_13) as campo13,
        trim(campo_14) as campo14,
        trim(campo_15) as campo15,
        trim(campo_16) as campo16,
        trim(campo_17) as campo17,
        trim(campo_18) as campo18,
        trim(campo_19) as campo19,
        trim(campo_20) as campo20,
        trim(campo_21) as campo21,
        trim(campo_22) as campo22,
        trim(campo_23) as campo23,
        trim(campo_24) as campo24,
        trim(campo_25) as campo25,
        trim(campo_26) as campo26,
        trim(campo_27) as campo27,
        trim(campo_28) as campo28,
        trim(campo_29) as campo29,
        trim(campo_30) as campo30,
        trim(campo_31) as campo31,
        trim(campo_32) as campo32,
        trim(campo_33) as campo33,
        trim(campo_34) as campo34,
        trim(campo_35) as campo35,
        trim(campo_35) as campo36,
        --
        trim(campo_1)||'|'||
        trim(campo_2)||'|'||
        trim(campo_3)||'|'||
        trim(campo_4)||'|'||
        trim(campo_5)||'|'||
        trim(campo_6)||'|'||
        trim(campo_7)||'|'||
        trim(campo_8)||'|'||
        trim(campo_9)||'|'||
        trim(campo_10)||'|'||
        trim(campo_11)||'|'||
        trim(campo_12)||'|'||
        trim(campo_13)||'|'||
        trim(campo_14)||'|'||
        trim(campo_15)||'|'||
        trim(campo_16)||'|'||
        trim(campo_17)||'|'||
        trim(campo_18)||'|'||
        trim(campo_19)||'|'||
        trim(campo_20)||'|'||
        trim(campo_21)||'|'||
        trim(campo_22)||'|'||
        trim(campo_23)||'|'||
        trim(campo_24)||'|'||
        trim(campo_25)||'|'||
        trim(campo_26)||'|'||
        trim(campo_27)||'|'||
        trim(campo_28)||'|'||
        trim(campo_29)||'|'||
        trim(campo_30)||'|'||
        trim(campo_31)||'|'||
        trim(campo_32)||'|'||
        trim(campo_33)||'|'||
        trim(campo_34)||'|'||
        trim(campo_35)||'|'||
        trim(campo_36)||'|'||
        '' as datos 
from (
select
        A.ID_VENTA ,A.fecha,A.NUMERO ,A.id_voucher, A.glosa, A.TOTAL,A.ID_DEPTO,
        A.ID_ANHO ||lpad(A.ID_MES,2,'0')||'00' AS campo_1,
        coalesce(ELISEO.FC_CONTA_CUO_VENTA(A.ID_VENTA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES ),'') AS campo_2,
        coalesce(ELISEO.FC_CONTA_CUO_CORRELATIVO_VENTA(A.ID_VENTA, A.ID_ENTIDAD, A.ID_ANHO, A.ID_MES ),'') AS campo_3,
        to_char(A.fecha,'DD/MM/YYYY') AS campo_4,
        to_char(A.fecha,'DD/MM/YYYY') AS campo_5,
        A.ID_COMPROBANTE AS campo_6,
        lpad(COALESCE(A.serie,'0'),4,'0') AS campo_7,
        COALESCE(A.numero,'') AS campo_8,
        '' as campo_9,
        CASE A.ID_COMPROBANTE WHEN '01' THEN  6
        ELSE
        CASE (
            SELECT to_char(min(pd.ID_TIPODOCUMENTO ))
            FROM moises.VW_PERSONA_NATURAL pd
            WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL
            AND rownum = 1
            ) WHEN '99' THEN 0 
            WHEN '23' THEN 0 
            ELSE
            (
            SELECT min(pd.ID_TIPODOCUMENTO )
            FROM moises.VW_PERSONA_NATURAL pd
            WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL
            AND rownum = 1
            ) end
        end as campo_10,
        CASE A.ID_COMPROBANTE
            WHEN '01' THEN (SELECT max(ID_RUC)
                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                        WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL
                        AND rownum = 1)
            WHEN '07' THEN CASE B.ID_COMPROBANTE WHEN '01' THEN (SELECT max(ID_RUC)
                                                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                                                        WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL
                                                        AND rownum = 1)
                            ELSE (SELECT max(pd.NUM_DOCUMENTO )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL
                                AND rownum = 1) END
            ELSE (SELECT max(pd.NUM_DOCUMENTO )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL
                                AND rownum = 1) end as campo_11,
        CASE A.ID_COMPROBANTE
            WHEN '01' THEN (SELECT max(NOMBRE )
                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                        WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL
                        AND rownum = 1)
            WHEN '07' THEN CASE B.ID_COMPROBANTE WHEN '01' THEN (SELECT max(nombre)
                                                        FROM moises.VW_PERSONA_NATURAL_LEGAL pd
                                                        WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL
                                                        AND rownum = 1)  ELSE (SELECT max(pd.nom_persona )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = B.ID_CLIENTE_LEGAL
                                AND rownum = 1) END
            ELSE (SELECT max(pd.nom_persona )
                                FROM moises.VW_PERSONA_NATURAL pd
                                WHERE pd.ID_PERSONA = A.ID_CLIENTE_LEGAL
                                AND rownum = 1) end as campo_12,
        '0.00' as campo_13,

        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.GRAVADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.GRAVADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_14,

        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') != to_char(B.fecha, 'yyyymm') then
                trim(to_char((A.GRAVADA+A.EXONERADA+A.INAFECTA) * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            '0.00'
        end
        as campo_15,

        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.IGV * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.IGV * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_16,
        '0.00' as campo_17,
        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.EXONERADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.EXONERADA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_18,
        case when A.ID_COMPROBANTE in ('07','08') then
            case when to_char(A.fecha, 'yyyymm') = to_char(B.fecha, 'yyyymm') then
                trim(to_char(A.INAFECTA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
            else '0.00'
            end
        else
            trim(to_char(A.INAFECTA * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99'))
        end
        as campo_19,
        '' as campo_20,
        '' as campo_21,
        '' as campo_22,
        '0.00' as campo_23,
        '' as campo_24,
        trim(to_char( A.TOTAL * (case when A.ID_COMPROBANTE = '07' then -1 else 1 end) ,'99999990.99')) as campo_25, -- importe total
        'PEN' as campo_26,
        '1.000' as campo_27,
        COALESCE(to_char(B.FECHA,'DD/MM/YYYY'),'') as campo_28, -- fecha de emision del comprobante que modifica
        COALESCE(B.ID_COMPROBANTE ,'') as campo_29,
        COALESCE(B.SERIE ,'') AS campo_30, -- numero de serie del comprobante que modifica
        COALESCE(B.NUMERO ,'') as campo_31, -- numdoc_ref
        '' as campo_32,
        '' as campo_33,
        '' as campo_34,
        '1' as campo_35,
        '' as campo_36,
        '' as other
	FROM eliseo.venta A
	LEFT OUTER JOIN eliseo.venta B ON A.ID_PARENT = B.ID_VENTA
	            where 7=7
	            AND (A.ID_ENTIDAD = P_ID_ENTIDAD OR 0 = P_ID_ENTIDAD )
		      	AND (A.ID_DEPTO = P_ID_DEPTO OR '*' = P_ID_DEPTO )
		      	AND A.ESTADO = '1'
				AND A.ID_MES = P_ID_MES
				AND A.ID_ANHO = P_ID_ANHO
            ) a
            ORDER BY fecha, NUMERO ;
    END SP_SIRE_RVIE_TXT;
   
  
   FUNCTION FC_PROVEEDOR_RUC(P_RUC_PROVEEDOR VARCHAR2) RETURN NUMBER AS
        L_ID_PERSONA NUMBER;
   BEGIN
        SELECT ID_PERSONA INTO L_ID_PERSONA FROM (
       		SELECT ID_PERSONA
	        FROM MOISES.VW_PERSONA_JURIDICA
	        WHERE ID_RUC = P_RUC_PROVEEDOR
	        UNION ALL
	        SELECT ID_PERSONA
	        FROM MOISES.VW_PERSONA_NATURAL
	        WHERE ID_TIPODOCUMENTO=6 AND NUM_DOCUMENTO=P_RUC_PROVEEDOR
        ) X where rownum =1;
        
        RETURN(L_ID_PERSONA);
   END;
  
   FUNCTION FC_CLIENTE_NUMDOC(P_NUMDOC_CLIENTE VARCHAR2) RETURN NUMBER AS
        L_ID_PERSONA NUMBER;
   BEGIN
        SELECT ID_PERSONA INTO L_ID_PERSONA FROM (
        	SELECT  
                ID_PERSONA
                FROM MOISES.VW_PERSONA_NATURAL
                WHERE NUM_DOCUMENTO=P_NUMDOC_CLIENTE
                AND ID_TIPODOCUMENTO NOT IN (97,98) --DOCUMENTOS DE AFP - ONP
                UNION 
                SELECT 
                    ID_PERSONA
                FROM MOISES.VW_PERSONA_JURIDICA 
                WHERE ID_RUC=P_NUMDOC_CLIENTE
         ) X where rownum =1;
        
        RETURN(L_ID_PERSONA);
   END;
   
   FUNCTION FC_PROVEEDOR(P_ID_PROVEEDOR NUMBER) RETURN VARCHAR2 AS
        NOM_PERSONA VARCHAR2(100);
    BEGIN
            SELECT  
                    NOMBRE INTO NOM_PERSONA
            FROM MOISES.PERSONA
            WHERE ID_PERSONA=P_ID_PROVEEDOR;
            
            RETURN(NOM_PERSONA);
    END;
   
   
   FUNCTION FC_RUC(P_ID_PROVEEDOR NUMBER) RETURN VARCHAR2 AS
        L_ID_RUC VARCHAR2(50);
    BEGIN
            SELECT ID_RUC INTO L_ID_RUC FROM (
            SELECT ID_RUC AS ID_RUC
            FROM MOISES.VW_PERSONA_JURIDICA
            WHERE ID_PERSONA = P_ID_PROVEEDOR
            UNION ALL
            SELECT NUM_DOCUMENTO AS ID_RUC
            FROM MOISES.VW_PERSONA_NATURAL
            WHERE ID_PERSONA = P_ID_PROVEEDOR
            AND ID_TIPODOCUMENTO=6
             ) X where rownum =1;
            
            RETURN(L_ID_RUC);
    END;
   
   
END PKG_SIRE;