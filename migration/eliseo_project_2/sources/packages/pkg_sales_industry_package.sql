-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE        PKG_SALES_INDUSTRY
AS

	FUNCTION FC_VENTA(P_ID_VENTA IN NUMBER) RETURN CLOB;
	FUNCTION FC_VENTA_GUIA(P_ID_VENTA_GUIA IN NUMBER) RETURN CLOB;
	FUNCTION FC_VENTA_EXPORTACION(P_ID_VENTA IN NUMBER) RETURN CLOB;
	FUNCTION FC_NOTA(P_ID_VENTA IN NUMBER) RETURN CLOB;
	PROCEDURE SP_ANULAR_VENTAS_REG(P_ID_VENTA NUMBER, P_ID_PERSONA NUMBER, P_MOTIVO VARCHAR2, P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2);

    PROCEDURE SP_MIGRAR_VENTA_JESUS(P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2);
	PROCEDURE SP_MIGRAR_VENTA_JESUS_VALIDAR(P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2);
    
    PROCEDURE SP_VENTA_GUIA_ELECTRONICA(P_ID_VENTA_GUIA IN NUMBER);
-- Package header
END PKG_SALES_INDUSTRY;


CREATE OR REPLACE PACKAGE BODY        PKG_SALES_INDUSTRY
AS

	FUNCTION FC_NOTA(P_ID_VENTA IN NUMBER) RETURN CLOB IS
        S_DETALLE       CLOB;
        S_VENTA         VARCHAR2(4000);
        S_CONTA         INT;
      	S_TIPODOC       VARCHAR2(2);
        S_ID_RUC      VARCHAR2(20);
        S_ERROR         VARCHAR2(1) := 'N';
        TYPE cv_typ IS REF CURSOR;
        VENTA cv_typ; 
    BEGIN  
    S_CONTA:=0;
    SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
    AND E.ID_EMPRESA = M.ID_EMPRESA
    AND V.ID_VENTA = P_ID_VENTA;
    
    SELECT ID_COMPROBANTE INTO S_TIPODOC FROM VENTA WHERE ID_VENTA=P_ID_VENTA;
    
	open VENTA FOR  
		SELECT DISTINCT DECODE(S_TIPODOC,'07','CC','CD')||
			'|'||'0101'||
			'|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
			'|'||S_TIPODOC|| 
			'|'||A.SERIE||'-'||A.NUMERO||
			'|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
			'|'||S_ID_RUC|| 
			--'|'||decode(SUBSTR(a.serie_ref,1,1),'F','6',DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0))|| 
	    	--'|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',NVL(eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_legal,A.ID_CLIENTE)),'-'),DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000'))||
	    	--'|'||decode(decode(SUBSTR(a.serie_ref,1,1),'F','6','1'),'6',eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE_legal,A.ID_CLIENTE)),eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE,A.ID_CLIENTE_legal)))||
			--'|'||REGEXP_REPLACE (nvl(TRIM(eliseo.PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','')|| 
			'|'||REGEXP_REPLACE(A.ID_TIPODOCUMENTO_CLI,'[A-Za-z]*')||
            '|'||REGEXP_REPLACE(A.NRO_DOC_CLI,'[A-Za-z]*')||
            '|'||REGEXP_REPLACE(COALESCE(A.RAZON_SOCIAL_CLI,'Cliente Varios'),'|','')||
            '|'||REGEXP_REPLACE(COALESCE(A.DIRECCION_CLI,'Sin Direccion'),'[-|]','')||
			'|'||''|| 
			'|'||trim(FC_EMAIL(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL)))|| 
			'|'||''|| 
	    	'|'||''|| 
	    	'|'||''|| 
	    	'|'||''|| 
	    	'|'||''|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
			'|'||'0.00'|| --21
			'|'||'0.00'||--22 
	    	'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999990D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.VALOR_EXPORTACION,0) = 0 THEN '0.00' WHEN A.VALOR_EXPORTACION BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.VALOR_EXPORTACION,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.VALOR_EXPORTACION,'9999999999D99')),',','.') END),(CASE  WHEN A.VALOR_EXPORTACION_ME = 0 THEN '0.00' WHEN A.VALOR_EXPORTACION_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.VALOR_EXPORTACION_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.VALOR_EXPORTACION_ME,'9999999999D99')),',','.') END))||
			'|'||'0.00'|| --27
			'|'||'0.00'|| --28
			'|'||'0.00'|| --29
			'|'||'0.00'|| --30
			'|'||'0.00'|| --31
	       	'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0),'9999999990D99')),',','.') END))|| 
	    	'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0),'9999999999D99')),',','.') END))|| 
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN nvl(A.DESCUENTO,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.DESCUENTO,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.DESCUENTO,0),'9999999999D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999999D99')),',','.') END))||
			'|'||'0.00'|| --34
			'|'||'0.00'|| --35
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
	        '|'||'1000'|| 
	        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
	        '|'||decode(SUBSTR(a.serie_ref,1,1),'F','01','03')|| 
	        '|'||a.serie_ref||'-'||a.numero_ref|| 
	        '|'||coalesce(b.codigo,'01')|| 
	        '|'||''|| 
	        '|'||''|| 
	        '|'||''|| 
	        '|'||''||    
	        '|' CAB 
        FROM eliseo.VENTA A
        INNER JOIN eliseo.tipo_nota_dc b ON A.id_tiponota=b.id_tiponota
        WHERE A.ID_VENTA = P_ID_VENTA      
        AND A.ESTADO = 1 		
       	UNION ALL 
 		SELECT  DECODE(S_TIPODOC,'07','DC','DD')||
 			'|'||ROWNUM||
			'|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN eliseo.FC_CODIGO_ARTICULO(b.id_articulo,'1')
						ELSE '55101528'||lpad(ROWNUM,8,0) END ||   -- Libros religionsos si no hay un id_articulo
			'|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN COALESCE(eliseo.FC_CODIGO_UNSP(b.id_articulo),'55101528')
						ELSE '55101528' END ||  -- Libros religionsos si no hay un id_articulo
			'|'||'NIU'|| 
			'|'||trim(to_char(b.cantidad,'9999999990D99'))|| 
			'|'||nvl(b.detalle,'Venta')|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE_FULL,0) = 0 THEN '0.00' WHEN nvl(B.PRECIO_BASE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_FULL_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_FULL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') END))||
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999990D99999')),',','.') END))||
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999999D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999999D99')),',','.') END))||
			'|'||b.ID_TIPOIGV|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN nvl(B.BASE,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(B.BASE_ME,0) = 0 THEN '0.00' WHEN nvl(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE_ME,0),'9999999999D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN nvl(B.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.IGV,0),'9999999999D99')),',','.') END),(CASE  WHEN nvl(B.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(B.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.IGV_ME,0),'9999999999D99')),',','.') END))||
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||''|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||'0.00'|| 
			'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END))|| 
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(B.BASE,'9999999999.99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(B.BASE_ME,'9999999999.99')) ELSE '0.00' END))||    
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO,0)/(NVL(B.BASE,0)+NVL(B.DESCUENTO,0)),5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5)  = 0 THEN '0.00' WHEN ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(NVL(B.DESCUENTO_ME,0)/(NVL(B.BASE_ME,0)+NVL(B.DESCUENTO_ME,0)),5),'9999990D99999')),',','.') END))|| 
            '|'||(CASE WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END)||  
			--'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.DESCUENTO,0) = 0 THEN '0.00' WHEN B.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO,'9999999999D99')),',','.') END),(CASE  WHEN B.DESCUENTO_ME = 0 THEN '0.00' WHEN B.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.DESCUENTO_ME,'9999999999D99')),',','.') END))||
			'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END),(CASE  WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END))||
            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN nvl(B.BASE,0)  BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE,0) ,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE,0) ,'9999999999D99')),',','.') END),(CASE  WHEN nvl(B.BASE_ME,0)  = 0 THEN '0.00' WHEN nvl(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE_ME,0),'9999999999D99')),',','.') END))||			
			'|'||''|| 
			'|'||''||
			'|' DET 			
        FROM eliseo.VENTA A, eliseo.VENTA_DETALLE B  
        WHERE A.ID_VENTA = B.ID_VENTA    
        AND A.ID_VENTA = P_ID_VENTA       
        AND A.ESTADO = 1;
    	fetch VENTA INTO S_VENTA;
	        while VENTA%found loop
	            IF S_CONTA = 0 THEN
	                S_DETALLE := S_VENTA;
	            ELSE
	                S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
	            END IF;
	            S_CONTA:=S_CONTA+1;
	        fetch VENTA into
	            S_VENTA;
	        end loop;
        close VENTA;
        
        RETURN(TO_CLOB(S_DETALLE));
    END;
   
	 FUNCTION FC_VENTA(P_ID_VENTA IN NUMBER) RETURN CLOB IS
        S_DETALLE 		CLOB;
        S_VENTA         VARCHAR2(4000);
        S_CONTA         INT;
        S_TIPODOC       VARCHAR2(2);
        S_ID_RUC      VARCHAR2(20);
        S_ERROR         VARCHAR2(1) := 'N';
        TYPE cv_typ IS REF CURSOR;
        VENTA cv_typ;
        
	    BEGIN  
	    S_CONTA:=0;
	    SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
	    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
	    AND E.ID_EMPRESA = M.ID_EMPRESA
	    AND V.ID_VENTA = P_ID_VENTA;
	    
	    SELECT ID_COMPROBANTE INTO S_TIPODOC FROM VENTA WHERE ID_VENTA=P_ID_VENTA;

	    IF S_TIPODOC='03' THEN -- BOLETA
	           --VENTAS SERVICIOS
	        open VENTA FOR  
	        SELECT distinct'CB'||
	            '|'||'0101'||
	            '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
	            '|'||'03'|| 
	            '|'||A.SERIE||'-'||A.NUMERO||
	            '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
	            '|'||S_ID_RUC|| 
	            --'|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0)||
	            --'|'||DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000')||
	            --'|'||NVL(TRIM(FC_NOMBRE_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')||
	            --'|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL))),'Sin Direccion'),'-','')||
	            '|'||REGEXP_REPLACE(DECODE(length(A.NRO_DOC_CLI),8,1,0),'[A-Za-z]*')||
	            '|'||REGEXP_REPLACE(A.NRO_DOC_CLI,'[A-Za-z]*')||
	            '|'||REGEXP_REPLACE(COALESCE(A.RAZON_SOCIAL_CLI,'Cliente Varios'),'|','')||
	            '|'||REGEXP_REPLACE(COALESCE(A.DIRECCION_CLI,'Sin Direccion'),'[-|]','')||
	            '|'||''|| 
	            '|'||trim(eliseo.FC_EMAIL(nvl(A.ID_CLIENTE,A.ID_CLIENTE_LEGAL)))|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||''|| 
	            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999990D99')),',','.') END))||
				'|'||'0.00'|| 
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||'1000'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
	        FROM VENTA A, VENTA_DETALLE B  
	        WHERE A.ID_VENTA = B.ID_VENTA   
	        AND A.ID_VENTA = P_ID_VENTA 
	        AND A.ESTADO = 1 		
	        UNION ALL 
	        SELECT  'DB'||	'|'||ROWNUM||
	                --'|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
	                --'|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||   
		            '|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN eliseo.FC_CODIGO_ARTICULO(b.id_articulo,'1')
							ELSE '55101528'||lpad(ROWNUM,8,0) END ||   -- Libros religionsos si no hay un id_articulo
					'|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN COALESCE(eliseo.FC_CODIGO_UNSP(b.id_articulo),'55101528')
							ELSE '55101528' END ||  -- Libros religionsos si no hay un id_articulo
	        		'|'||'NIU'|| 
		            '|'||(case when length(trim(to_char(b.cantidad,'9999999990D99')))=3 then 0||trim(to_char(b.cantidad,'9999999990D99'))else trim(to_char(b.cantidad,'9999999990D99')) END)|| 
		            '|'||nvl(b.detalle,'Venta Varios')|| 
		            '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE_FULL,0) = 0 THEN '0.00' WHEN nvl(B.PRECIO_BASE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_FULL_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_FULL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') END))||
					'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
	                --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
	                '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
	                '|'||b.ID_TIPOIGV|| 
	                '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN nvl(B.BASE,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(B.BASE_ME,0) = 0 THEN '0.00' WHEN nvl(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE_ME,0),'9999999990D99')),',','.') END))||
	                '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||''|| 
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||'0.00'|| 
	                '|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END))||    
			        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END))|| 
					'|'||(CASE WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END)||  
					'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END),(CASE  WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END))||
			        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
	                '|'||''|| 
	                '|'||''||
	                '|' DET 			
		        FROM VENTA A, VENTA_DETALLE B  
		        WHERE A.ID_VENTA = B.ID_VENTA    
		        AND A.ID_VENTA = P_ID_VENTA  
		        AND A.ESTADO = 1
                UNION ALL
                SELECT 
                      'FDP'||'|'||'Credito'||
                      '|'||DECODE(ID_MONEDA, '7',(CASE  WHEN NVL(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END))||
                      '|'CAB 
                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
                UNION ALL
                SELECT x.DET FROM (SELECT 
                      --'CUO'||'|'||DECODE(B.NRO_CUOTA,'CUO001','Cuota001','Cuota002')||
                      'CUO'||'|Cuota'||SUBSTR(COALESCE(B.NRO_CUOTA,'CUO001'),4)||
                      '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END))||                  
                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
                      '|' DET
                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
                AND A.ID_CREDITO = 2
                ORDER BY B.NRO_CUOTA) x;
	          
	        
		ELSIF S_TIPODOC = '01' THEN  -- FACTURA
	        
	        open VENTA FOR  
		  	SELECT distinct'CF'
		  		||'|'
		  		||'0101'||
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		        '|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO||
		        '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		        '|'||S_ID_RUC||
		        --'|6'||
		        --'|'||NVL(FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
		        --'|'||FC_NOMBRE_PERSONA(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		        --'|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(nvl(a.id_sucursal,A.ID_CLIENTE_LEGAL),A.ID_CLIENTE))),'Sin Direccion'),'-','')||
		        --'|'||REGEXP_REPLACE(A.ID_TIPODOCUMENTO_CLI,'[A-Za-z]*')||
		        '|6'||
	            '|'||REGEXP_REPLACE(A.NRO_DOC_CLI,'[A-Za-z]*')||
	            '|'||REGEXP_REPLACE(COALESCE(A.RAZON_SOCIAL_CLI,'Cliente Varios'),'|','')||
	            '|'||REGEXP_REPLACE(COALESCE(A.DIRECCION_CLI,'Sin Direccion'),'[-|]','')||
	            '|'||''|| 
		        '|'||trim(coalesce(eliseo.FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END))||
				'|'||'0.00'|| 
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||'1000'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
		        FROM VENTA A
		        WHERE A.ID_VENTA = P_ID_VENTA 
		        AND A.ESTADO = 1 		
		        UNION ALL 
		         SELECT  'DF'||	'|'||ROWNUM||
		                        --'|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
		                        --'|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||  
		                        '|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN eliseo.FC_CODIGO_ARTICULO(b.id_articulo,'1')
										ELSE '55101528'||lpad(ROWNUM,8,0) END ||   -- Libros religionsos si no hay un id_articulo
								'|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN COALESCE(eliseo.FC_CODIGO_UNSP(b.id_articulo),'55101528')
										ELSE '55101528' END ||  -- Libros religionsos si no hay un id_articulo
		                   --     '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
		                    --    '|86121503'|| 
		                        '|'||'NIU'|| 
		                         '|'||(case when length(trim(to_char(b.cantidad,'9999999990D99')))=3 then 0||trim(to_char(b.cantidad,'9999999990D99'))else trim(to_char(b.cantidad,'9999999990D99')) END)|| 
		                        '|'||nvl(b.detalle,'Venta')|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE_FULL,0) = 0 THEN '0.00' WHEN nvl(B.PRECIO_BASE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_FULL_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_FULL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') END))||
	            				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN nvl(B.PRECIO_ME,0) = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||b.ID_TIPOIGV|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN nvl(B.BASE,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(B.BASE_ME,0) = 0 THEN '0.00' WHEN nvl(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE_ME,0),'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||''|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END))||    
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END))|| 
    							'|'||(CASE WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END)||  
    							'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END),(CASE  WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
		                        '|'||''|| 
		                        '|'||''||
		                        '|' DET 			
		                FROM VENTA A, VENTA_DETALLE B  
		                WHERE A.ID_VENTA = B.ID_VENTA    
		                AND A.ID_VENTA = P_ID_VENTA  
		                AND A.ESTADO = 1
		                UNION ALL
		                SELECT 
		                      'FDP'||'|'||'Credito'||
		                      '|'||DECODE(ID_MONEDA, '7',(CASE  WHEN NVL(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END))||
		                      '|'CAB 
		                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
		                UNION ALL
		                SELECT x.DET FROM (SELECT 
		                      --'CUO'||'|'||DECODE(B.NRO_CUOTA,'CUO001','Cuota001','Cuota002')||
		                      'CUO'||'|Cuota'||SUBSTR(COALESCE(B.NRO_CUOTA,'CUO001'),4)||
		                      '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END))||                  
		                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
		                      '|' DET
		                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
		                AND A.ID_CREDITO = 2
		                ORDER BY B.NRO_CUOTA) x;
		        
	   END IF;
	   
        fetch VENTA into S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                BEGIN 
                    IF S_ERROR = 'N' THEN
                        S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                    END IF;
                EXCEPTION
                WHEN OTHERS THEN
                    S_DETALLE :='';
                    S_ERROR := 'S';
                END;
            END IF;
            S_CONTA:=S_CONTA+1;

        fetch VENTA into S_VENTA;
        end loop;
        close VENTA;	
        
       RETURN(TO_CLOB(S_DETALLE));
       --RETURN (S_DETALLE);
    END;
   
       FUNCTION FC_VENTA_GUIA(P_ID_VENTA_GUIA IN NUMBER) RETURN CLOB IS
        S_DETALLE 		CLOB;
        S_VENTA         VARCHAR2(4000);
        S_CONTA         INT;
        S_TIPODOC       VARCHAR2(2);
        S_ID_RUC      VARCHAR2(20);
        S_ERROR         VARCHAR2(1) := 'N';
        TYPE cv_typ IS REF CURSOR;
        VENTA cv_typ;
        
	    BEGIN  
	    S_CONTA:=0;
	    SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA_GUIA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
	    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
	    AND E.ID_EMPRESA = M.ID_EMPRESA
	    AND V.ID_VENTA_GUIA = P_ID_VENTA_GUIA;
	    
	    open VENTA FOR  
		  	SELECT distinct'CG'||
		  	    --'|'||'0200'||
		        
		        --'|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO|| --1
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')|| --2
		        '|'||'09'||  --3
		        '|'||COALESCE(A.INFO_ADICIONAL,'')|| --4 
		        '|'|| --5
		        '|'|| --6
		        '|'||B.SERIE||'-'||B.NUMERO|| --7
		        '|'||B.ID_COMPROBANTE|| --8
		        --
		        '|'||A.NUM_DOCUMENTO|| --9
		        '|'||A.ID_TIPODOCUMENTO|| --10
		        '|'||trim(FC_NOMBRE_PERSONA(A.ID_PERSONA))|| --11
		        --
		        '|'||A.NUM_DOCUMENTODES|| --12
		        '|'||A.ID_TIPODOCUMENTODES|| --13
		        '|'||trim(FC_NOMBRE_PERSONA(A.ID_DESTINO))|| --14
		        --
		        '|'||COALESCE(A.NUM_DOCUMENTOPRO,'')|| --15
		        '|'||COALESCE(TO_CHAR(A.ID_TIPODOCUMENTOPRO),'')|| --16
		        '|'||trim(FC_NOMBRE_PERSONA(A.ID_PROVEEDOR))|| --17
		        --
		        '|'||C.CODIGO_SUNAT|| --18
		        '|'||(CASE WHEN A.TRANSBORDO_PROGRAMADO = '1' THEN 'True' ELSE 'False' END)|| --19
		        '|'||A.BRUTO_TOTAL|| --20
		        '|'||D.CODIGO_SUNAT|| -- Unidad de medida --21
		        '|'||A.NRO_BULTOS|| --22
		        '|'||E.CODIGO_SUNAT|| -- Codigo modalidad traslado --23
		        '|'||TO_CHAR(A.FEC_INICIO_TRASLADO,'YYYY-MM-DD')|| --24
		        --
		        '|'||A.NUM_DOCUMENTOTRA|| --25
		        '|'||trim(FC_NOMBRE_PERSONA(A.ID_TRANSPORTISTA))|| --26
		        '|'||A.PLACA|| --27
		        '|'||A.REGISTRO_MTC|| --28
		        '|'||A.ID_UBIGEO_LLEG|| --29
		        '|'||A.DIRECCION_LLEG|| --30
		        '|'||A.ID_UBIGEO_PAR|| --31
		        '|'||A.DIRECCION_PAR|| --32
		        '|'||A.NUM_CONTENEDOR|| --33
		        '|'||A.PUERTO_AEROPUERTO|| --34
		        '|'||COALESCE(A.EMAIL_CLIENTE,'')|| --35
		        '|'||A.INFO_ADICIONAL|| --36
		        --
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN TO_CHAR(A.ID_TIPODOCUMENTOCON) ELSE '' END)||
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN A.NUM_DOCUMENTOCON ELSE '' END)||
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN trim(FC_NOMBRE_PERSONA(A.ID_CONDUCTOR)) ELSE '' END)|| -- NOMBRE
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN trim(FC_NOMBRE_PERSONA(A.ID_CONDUCTOR)) ELSE '' END)|| -- APELLIDOS
		        '|'||(CASE WHEN E.CODIGO_SUNAT = '02' THEN A.NUM_LICENCIA ELSE '' END)||
		        '|0000'||
		        '|'||  
		        '|'||  
		        '|' CAB 
		        FROM VENTA_GUIA A
		        LEFT JOIN VENTA_GUIA_REF B ON A.ID_VENTA_GUIA=B.ID_VENTA_GUIA
		        LEFT JOIN TIPO_MOTIVO_TRASLADO C ON A.ID_MOTIVOTRASLADO=C.ID_MOTIVOTRASLADO
		        LEFT JOIN INVENTARIO_UNIDAD_MEDIDA D ON A.ID_UNIDADMEDIDA=D.ID_UNIDADMEDIDA
		        LEFT JOIN TIPO_MOD_TRASLADO E ON A.ID_TIPO_MOD_TRASLADO=E.ID_TIPO_MOD_TRASLADO
		        WHERE A.ID_VENTA_GUIA = P_ID_VENTA_GUIA
		        AND A.ESTADO = 1 		
				UNION ALL
	         	SELECT  'DG'||	'|'||ROWNUM||
	         				'|'||(case when length(trim(to_char(b.cantidad,'9999999990D99')))=3 then 0||trim(to_char(b.cantidad,'9999999990D99'))else trim(to_char(b.cantidad,'9999999990D99')) END)|| 
	         				'|'||B.CODUM_SUNAT|| 
							'|'||COALESCE(B.DESCRIPCION, 'Venta') ||
							'|'||COALESCE(B.CODIGO_ITEM, '55101528' || LPAD(ROW_NUMBER() OVER (ORDER BY NULL), 8, '0')) ||
							'|'||COALESCE(B.CODIGO_SUNAT, '55101528') ||
							'|'||
	                        '|'||(CASE WHEN A.ID_MOTIVOTRASLADO =12 THEN '7020' ELSE '' END) || 
	                        '|' DET 			
	                FROM VENTA_GUIA A
	                INNER JOIN VENTA_GUIA_DET B ON A.ID_VENTA_GUIA = B.ID_VENTA_GUIA    
	                WHERE A.ID_VENTA_GUIA = P_ID_VENTA_GUIA  
	                AND A.ESTADO = 1
		        	;
	   
        fetch VENTA into S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                BEGIN 
                    IF S_ERROR = 'N' THEN
                        S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                    END IF;
                EXCEPTION
                WHEN OTHERS THEN
                    S_DETALLE :='';
                    S_ERROR := 'S';
                END;
            END IF;
            S_CONTA:=S_CONTA+1;

        fetch VENTA into S_VENTA;
        end loop;
        close VENTA;	
        
       RETURN(TO_CLOB(S_DETALLE));
       --RETURN (S_DETALLE);
    END;
   
   
   FUNCTION FC_VENTA_EXPORTACION(P_ID_VENTA IN NUMBER) RETURN CLOB IS
        S_DETALLE 		CLOB;
        S_VENTA         VARCHAR2(4000);
        S_CONTA         INT;
        S_ID_RUC      VARCHAR2(20);
        S_ERROR         VARCHAR2(1) := 'N';
        TYPE cv_typ IS REF CURSOR;
        VENTA cv_typ;
        
	    BEGIN  
	    S_CONTA:=0;
	    SELECT COALESCE(MAX(M.ID_RUC),'') INTO S_ID_RUC FROM VENTA V, CONTA_ENTIDAD E, CONTA_EMPRESA M
	    WHERE V.ID_ENTIDAD = E.ID_ENTIDAD
	    AND E.ID_EMPRESA = M.ID_EMPRESA
	    AND V.ID_VENTA = P_ID_VENTA;
	    
		-- FACTURA
	        
	        open VENTA FOR  
		  	SELECT distinct'CF'||
		  	    '|'||'0200'||
		        '|'||TO_CHAR(A.FECHA,'YYYY-MM-DD')||
		        '|'||'01'|| 
		        '|'||A.SERIE||'-'||A.NUMERO||
		        '|'||DECODE(A.ID_MONEDA,7,'PEN','USD')|| 
		        '|'||S_ID_RUC||
		        --'|6'||
		        --'|'||NVL(FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')||
		        --'|'||FC_NOMBRE_PERSONA(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))||
		        --'|'||REGEXP_REPLACE (nvl(TRIM(PKG_SALES_FACTURACION.FC_CLIENTE_DIRECCION(nvl(nvl(a.id_sucursal,A.ID_CLIENTE_LEGAL),A.ID_CLIENTE))),'Sin Direccion'),'-','')||
		        --'|'||REGEXP_REPLACE(A.ID_TIPODOCUMENTO_CLI,'[A-Za-z]*')||
		        '|0'||
	            '|'||REGEXP_REPLACE(A.NRO_DOC_CLI,'[A-Za-z]*')||
	            '|'||REGEXP_REPLACE(COALESCE(A.RAZON_SOCIAL_CLI,'Cliente Varios'),'|','')||' INCOTERM '||COALESCE(A.ID_INCOTERM,'-')||
	            '|'||REGEXP_REPLACE(COALESCE(A.DIRECCION_CLI,'Sin Direccion'),'[-|]','')||
	            '|'||''|| 
		        '|'||trim(coalesce(eliseo.FC_EMAIL(nvl(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'it.upn@outlook.com'))|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0) = 0 THEN '0.00' WHEN A.GRAVADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA,'9999999990D99')),',','.') END),(CASE  WHEN A.GRAVADA_ME = 0 THEN '0.00' WHEN A.GRAVADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRAVADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRAVADA_ME,'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||'0.00'|| 
		        '|'||'0.00'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.INAFECTA,0) = 0 THEN '0.00' WHEN A.INAFECTA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA,'9999999990D99')),',','.') END),(CASE  WHEN A.INAFECTA_ME = 0 THEN '0.00' WHEN A.INAFECTA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.INAFECTA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.INAFECTA_ME,'9999999990D99')),',','.') END))||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.EXONERADA,0) = 0 THEN '0.00' WHEN A.EXONERADA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA,'9999999990D99')),',','.') END),(CASE  WHEN A.EXONERADA_ME = 0 THEN '0.00' WHEN A.EXONERADA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.EXONERADA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.EXONERADA_ME,'9999999990D99')),',','.') END))||
				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRATUITA,0) = 0 THEN '0.00' WHEN A.GRATUITA BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA,'9999999999D99')),',','.') END),(CASE  WHEN A.GRATUITA_ME = 0 THEN '0.00' WHEN A.GRATUITA_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.GRATUITA_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.GRATUITA_ME,'9999999999D99')),',','.') END))||
				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.VALOR_EXPORTACION,0) = 0 THEN '0.00' WHEN A.VALOR_EXPORTACION BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.VALOR_EXPORTACION,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.VALOR_EXPORTACION,'9999999999D99')),',','.') END),(CASE  WHEN A.VALOR_EXPORTACION_ME = 0 THEN '0.00' WHEN A.VALOR_EXPORTACION_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.VALOR_EXPORTACION_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.VALOR_EXPORTACION_ME,'9999999999D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME,0),'9999999990D99')),',','.') END))|| 
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.IGV,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.IGV,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.IGV,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA,0)+nvl(A.INAFECTA,0)+nvl(A.EXONERADA,0)+nvl(A.VALOR_EXPORTACION,0)+nvl(A.IGV,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0) = 0 THEN '0.00' WHEN nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(A.GRAVADA_ME+A.INAFECTA_ME+A.EXONERADA_ME+A.VALOR_EXPORTACION_ME+A.IGV_ME,0),'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.DESCUENTO,0) = 0 THEN '0.00' WHEN A.DESCUENTO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO,'9999999990D99')),',','.') END),(CASE  WHEN A.DESCUENTO_ME = 0 THEN '0.00' WHEN A.DESCUENTO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.DESCUENTO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.DESCUENTO_ME,'9999999990D99')),',','.') END))||
		        '|'||'0.00'||
		        '|'||'0.00'||
		        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(A.TOTAL,0) = 0 THEN '0.00' WHEN A.TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL,'9999999990D99')),',','.') END),(CASE  WHEN A.TOTAL_ME = 0 THEN '0.00' WHEN A.TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(A.TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(A.TOTAL_ME,'9999999990D99')),',','.') END))|| 
		        '|'||'1000'|| 
		        '|'||DECODE(A.ID_MONEDA, '7',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL))))||' Soles',UPPER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME),1, 1)) || LOWER(SUBSTR(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME), 2, LENGTH(eliseo.FC_NUMERO_TEXTO(A.TOTAL_ME))))||' Dolares')|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''|| 
		        '|'||''||    
		        '|' CAB 
		        FROM VENTA A
		        WHERE A.ID_VENTA = P_ID_VENTA 
		        AND A.ESTADO = 1 		
		        UNION ALL 
		         SELECT  'DF'||	'|'||ROWNUM||
		                        --'|'||decode(a.serie,'B150','85101503'||lpad(ROWNUM,3,0),nvl(b.id_articulo,'86121503'||lpad(ROWNUM,3,0)))|| 
		                        --'|'||decode(a.serie,'B150','85101503',nvl(eliseo.FC_CODIGO_UNSP(b.id_articulo),'86121503'))||  
		                        '|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN eliseo.FC_CODIGO_ARTICULO(b.id_articulo,'1')
										ELSE '55101528'||lpad(ROWNUM,8,0) END ||   -- Libros religionsos si no hay un id_articulo
								'|'||CASE WHEN B.ID_ARTICULO IS NOT NULL THEN COALESCE(eliseo.FC_CODIGO_UNSP(b.id_articulo),'55101528')
										ELSE '55101528' END ||  -- Libros religionsos si no hay un id_articulo
		                   --     '|'||(SELECT COALESCE(MAX(IA.CODIGO),'86121503') FROM INVENTARIO_ARTICULO IA WHERE IA.ID_ARTICULO = B.ID_ARTICULO)|| 
		                    --    '|86121503'|| 
		                        '|'||'NIU'|| 
		                         '|'||(case when length(trim(to_char(b.cantidad,'9999999990D99')))=3 then 0||trim(to_char(b.cantidad,'9999999990D99'))else trim(to_char(b.cantidad,'9999999990D99')) END)|| 
		                        '|'||nvl(b.detalle,'Venta')|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO_BASE_FULL,0) = 0 THEN '0.00' WHEN nvl(B.PRECIO_BASE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL,'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_BASE_FULL_ME = 0 THEN '0.00' WHEN B.PRECIO_BASE_FULL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_BASE_FULL_ME,'9999990D99999')),',','.') END))||
	            				'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO,'9999999990D99')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME,'9999999990D99')),',','.') END))||
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.PRECIO,0) = 0 THEN '0.00' WHEN B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO-(nvl(B.DESCUENTO,0)/B.CANTIDAD),'9999990D99999')),',','.') END),(CASE  WHEN B.PRECIO_ME = 0 THEN '0.00' WHEN B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.PRECIO_ME-(nvl(B.DESCUENTO_ME,0)/B.CANTIDAD),'9999990D99999')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||b.ID_TIPOIGV|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.BASE,0) = 0 THEN '0.00' WHEN nvl(B.BASE,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE,0),'9999999990D99')),',','.') END),(CASE  WHEN nvl(B.BASE_ME,0) = 0 THEN '0.00' WHEN nvl(B.BASE_ME,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(nvl(B.BASE_ME,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(nvl(B.BASE_ME,0),'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN nvl(B.IGV,0) = 0 THEN '0.00' WHEN B.IGV BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV,'9999999990D99')),',','.') END),(CASE  WHEN B.IGV_ME = 0 THEN '0.00' WHEN B.IGV_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IGV_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IGV_ME,'9999999990D99')),',','.') END))||
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||''|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||'0.00'|| 
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE WHEN NVL(B.DESCUENTO,0) >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END),(CASE WHEN B.DESCUENTO_ME >0 THEN trim(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0),'9999999990D99')) ELSE '0.00' END))||    
		                        --'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END),(CASE  WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END))|| 
    							'|'||(CASE WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5)  = 0 THEN '0.00' WHEN ROUND(B.DESCUENTO_PORCENTAJE_FULL,5) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'90D99999')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(ROUND(B.DESCUENTO_PORCENTAJE_FULL,5),'9999990D99999')),',','.') END)||  
    							'|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END),(CASE  WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) = 0 THEN '0.00' WHEN NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0) BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(NVL(B.PRECIO_BASE_FULL_ME,0)*NVL(B.CANTIDAD,0)*NVL(B.DESCUENTO_PORCENTAJE_FULL,0),'9999999990D99')),',','.') END))||
		                        '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.BASE,0) = 0 THEN '0.00' WHEN B.BASE BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE,'9999999990D99')),',','.') END),(CASE  WHEN B.BASE_ME = 0 THEN '0.00' WHEN B.BASE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.BASE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.BASE_ME,'9999999990D99')),',','.') END))||			
		                        '|'||''|| 
		                        '|'||''||
		                        '|' DET 			
		                FROM VENTA A, VENTA_DETALLE B  
		                WHERE A.ID_VENTA = B.ID_VENTA    
		                AND A.ID_VENTA = P_ID_VENTA  
		                AND A.ESTADO = 1
		                UNION ALL
		                SELECT 
		                      'FDP'||'|'||'Credito'||
		                      '|'||DECODE(ID_MONEDA, '7',(CASE  WHEN NVL(TOTAL,0) = 0 THEN '0.00' WHEN TOTAL BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL,'9999999999D99')),',','.') END),(CASE  WHEN TOTAL_ME = 0 THEN '0.00' WHEN TOTAL_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(TOTAL_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(TOTAL_ME,'9999999999D99')),',','.') END))||
		                      '|'CAB 
		                FROM ELISEO.VENTA WHERE ID_VENTA = P_ID_VENTA AND ID_CREDITO = 2
		                UNION ALL
		                SELECT x.DET FROM (SELECT 
		                      --'CUO'||'|'||DECODE(B.NRO_CUOTA,'CUO001','Cuota001','Cuota002')||
		                      'CUO'||'|Cuota'||SUBSTR(COALESCE(B.NRO_CUOTA,'CUO001'),4)||
		                      '|'||DECODE(A.ID_MONEDA, '7',(CASE  WHEN NVL(B.importe,0) = 0 THEN '0.00' WHEN B.importe BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.importe,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.importe,'9999999999D99')),',','.') END),(CASE  WHEN B.IMPORTE_ME = 0 THEN '0.00' WHEN B.IMPORTE_ME BETWEEN 0.01 AND 0.99 THEN REPLACE(TRIM(TO_CHAR(B.IMPORTE_ME,'90D99')),',','.') ELSE REPLACE(LTRIM(TO_CHAR(B.IMPORTE_ME,'9999999999D99')),',','.') END))||                  
		                      '|'||to_char(B.fecha_pago,'YYYY-MM-DD')||
		                      '|' DET
		                FROM ELISEO.VENTA A JOIN ELISEO.VENTA_FORMA_PAGO B ON A.ID_VENTA = B.ID_VENTA  WHERE A.ID_VENTA = P_ID_VENTA
		                AND A.ID_CREDITO = 2
		                ORDER BY B.NRO_CUOTA) x;
	   
        fetch VENTA into S_VENTA;
        while VENTA%found loop
            IF S_CONTA = 0 THEN
                S_DETALLE := S_VENTA;
            ELSE
                BEGIN 
                    IF S_ERROR = 'N' THEN
                        S_DETALLE := S_DETALLE||chr(13)||S_VENTA;
                    END IF;
                EXCEPTION
                WHEN OTHERS THEN
                    S_DETALLE :='';
                    S_ERROR := 'S';
                END;
            END IF;
            S_CONTA:=S_CONTA+1;

        fetch VENTA into S_VENTA;
        end loop;
        close VENTA;	
        
       RETURN(TO_CLOB(S_DETALLE));
    END;
   
   PROCEDURE SP_ANULAR_VENTAS_REG(P_ID_VENTA NUMBER, P_ID_PERSONA NUMBER, P_MOTIVO VARCHAR2, P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2) IS
        L_ID_VOUCHER NUMBER;
        L_ACTIVO VARCHAR2(1);
        L_ID_KARDEX NUMBER;
        L_ID_ALMACEN NUMBER;
        L_ID_ARTICULO NUMBER;
        L_ID_ANHO NUMBER;
        L_ID_TIPOORIGEN NUMBER := 1;
        L_ID_ASIENTO NUMBER;
        L_DATA VARCHAR2(255);

        L_ID_DEPOSITO NUMBER;
        L_ID_VOUCHER_DEP NUMBER;
        L_ID_TIPOORIGEN_DEP NUMBER;
        L_CANT NUMBER;

        CURSOR articulos IS	
        SELECT 
                ID_KARDEX,A.ID_ALMACEN,A.ID_ARTICULO,A.ID_ANHO 
        FROM INVENTARIO_KARDEX A JOIN VENTA_DETALLE B
        ON A.ID_ORIGEN = B.ID_VDETALLE 
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND B.ID_VENTA = P_ID_VENTA;

        CURSOR asientos IS
        SELECT 
                ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN VENTA_DETALLE B
        ON A.ID_ORIGEN = B.ID_VDETALLE
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND B.ID_VENTA = P_ID_VENTA
        AND A.VOUCHER = L_ID_VOUCHER;

        CURSOR asientos_dep is
        SELECT 
                A.ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN CAJA_DEPOSITO B
        ON A.ID_ORIGEN = B.ID_DEPOSITO
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN_DEP
        AND A.ID_ORIGEN = L_ID_DEPOSITO
        AND A.VOUCHER = L_ID_VOUCHER_DEP;

        BEGIN
            SELECT ID_VOUCHER, 'SERIE: '||SERIE||', NUMERO: '||NUMERO||'GRAVADA: '||GRAVADA||', INAFECTA: '||INAFECTA||', EXONERADA: '||EXONERADA||', DESCUENTO: '||DESCUENTO||', IGV: '||IGV||', TOTAL: '||TOTAL 
            INTO L_ID_VOUCHER, L_DATA
            FROM VENTA WHERE ID_VENTA = P_ID_VENTA;
            
            SELECT ACTIVO INTO L_ACTIVO FROM CONTA_VOUCHER  WHERE ID_VOUCHER = L_ID_VOUCHER;
            IF L_ACTIVO <> 'S' THEN 
            	P_ERROR := 1;
                P_MSGERROR := 'El Voucher ya esta CONTABILIZADO';
                GOTO salida_rapida;
            END IF;
           
                Insert into ARREGLO (
                ID_ENTIDAD, ID_DEPTO, ID_TIPOARREGLO, ID_PERSONA, ID_MODULO, ID_ORIGEN, ID_TIPOORIGEN, 
                MOTIVO, FECHA, INFO_BACKUP, ESTADO
                ) 
                select ID_ENTIDAD, id_depto, 1 as id_tipoarreglo, P_ID_PERSONA, 13, id_venta, id_tipoorigen, P_MOTIVO, sysdate, 
                'IMPORTE: '||total||' Glosa: '||glosa, 1
                from VENTA 
                where id_venta = P_ID_VENTA;
        
            --ANULA KARDEX
            OPEN articulos;
              FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO;
                WHILE articulos%FOUND LOOP

                    UPDATE INVENTARIO_KARDEX SET CANTIDAD = 0, COSTO_UNITARIO = 0, COSTO_TOTAL = 0
                    WHERE ID_KARDEX = L_ID_KARDEX;

                    UPDATE INVENTARIO_ALMACEN_ARTICULO SET ESTADO = '1'
                    WHERE ID_ALMACEN = L_ID_ALMACEN
                    AND ID_ARTICULO = L_ID_ARTICULO
                    AND ID_ANHO = L_ID_ANHO;

                    FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO;
                END LOOP;
            CLOSE articulos;
           
            --ANULA ASIENTO DE LA VENTA
            OPEN asientos;
              FETCH asientos INTO L_ID_ASIENTO;
                WHILE asientos%FOUND LOOP

                    UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                    WHERE ID_ASIENTO = L_ID_ASIENTO;

                    FETCH asientos INTO L_ID_ASIENTO;
                END LOOP;
            CLOSE asientos;
            --ANULAR DEPOSITO
            /*
            SELECT COUNT(1) INTO L_CANT FROM CAJA_DEPOSITO_DETALLE
            WHERE ID_VENTA = P_ID_VENTA;

            IF L_CANT > 0 THEN

                SELECT ID_DEPOSITO INTO L_ID_DEPOSITO FROM CAJA_DEPOSITO_DETALLE
                WHERE ID_VENTA = P_ID_VENTA;
                SELECT ID_VOUCHER,ID_TIPOORIGEN INTO L_ID_VOUCHER_DEP,L_ID_TIPOORIGEN_DEP
                FROM CAJA_DEPOSITO
                WHERE ID_DEPOSITO = L_ID_DEPOSITO;

                OPEN asientos_dep;
                  FETCH asientos_dep INTO L_ID_ASIENTO;
                    WHILE asientos_dep%FOUND LOOP

                        UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                        WHERE ID_ASIENTO = L_ID_ASIENTO;

                        FETCH asientos_dep INTO L_ID_ASIENTO;
                    END LOOP;
                CLOSE asientos_dep;

                UPDATE CAJA_DEPOSITO_DETALLE SET IMPORTE = 0, IMPORTE_ME = 0
                WHERE ID_DEPOSITO = L_ID_DEPOSITO;

                UPDATE CAJA_DEPOSITO SET IMPORTE = 0, IMPORTE_ME = 0, GLOSA = '<< Anulado >>'
                WHERE ID_DEPOSITO = L_ID_DEPOSITO;
            END IF;
            */
            --ANULAR VENTA
            UPDATE VENTA_DETALLE SET    DETALLE = '<< Anulado>>',CANTIDAD = 0,PRECIO = 0,PRECIO_BASE = 0,PRECIO_ALM = 0,BASE = 0,IGV = 0,DESCUENTO = 0,IMPORTE = 0,IMPORTE_ADESCONTAR = 0,OTROS_CARGOS = 0,
                                        PRECIO_ME = 0,PRECIO_BASE_ME = 0,PRECIO_ALM_ME = 0,BASE_ME = 0,IGV_ME = 0,DESCUENTO_ME = 0,IMPORTE_ME = 0,OTROS_CARGOS_ME = 0
            WHERE ID_VENTA = P_ID_VENTA;

            UPDATE VENTA SET    GLOSA = '<< Anulado>>', GRAVADA = 0,INAFECTA = 0,EXONERADA = 0,GRATUITA = 0,DESCUENTO = 0,IGV = 0,TOTAL = 0,DESCUENTO_GLOBAL = 0,IMPORTE_ADESCONTAR = 0,OTROS_CARGOS = 0,
                                GRAVADA_ME = 0,INAFECTA_ME = 0,EXONERADA_ME = 0,GRATUITA_ME = 0,DESCUENTO_ME = 0,IGV_ME = 0,TOTAL_ME = 0,DESCUENTO_GLOBAL_ME = 0,IMPORTE_ADESCONTAR_ME = 0,OTROS_CARGOS_ME = 0
            WHERE ID_VENTA = P_ID_VENTA;

            UPDATE ARREGLO SET ESTADO = '2',INFO_BACKUP = L_DATA
            WHERE ID_ORIGEN = P_ID_VENTA
            AND ID_TIPOORIGEN = L_ID_TIPOORIGEN
            AND ESTADO = '1';
            P_ERROR := 0;
            P_MSGERROR := 'OK: Anulado con Exito';
           
           <<salida_rapida>>
           P_ERROR := P_ERROR; --AREGLO 
            
    END SP_ANULAR_VENTAS_REG;

    PROCEDURE SP_MIGRAR_VENTA_JESUS(P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2) IS
       
        l_id_anho_current number;
        l_id_anho number;
        l_id_mes number;
        l_id_persona_register number:=198574; --Sistema
        l_id_cliente number;
        l_count number := 0;
        
        l_id_moneda number;
        l_gravado number;
        l_igv number;
        l_inafecta number;
        l_id_tipoigv varchar2(20);
        
        l_id_venta number;
        /*
        cursor saldos is
           SELECT 
          id_entidad, 
          id_depto, 
          serie,
          numero, 
          ruc_cliente, 
          razon_social_cliente,
          fecha,
          fecha_venc,
          id_comprobante,
          moneda,
          glosa,
          es_gravado,
          importe,
          importe_me,
          cuenta_cte,
          id_articulo
          from vv_importa_venta_jesus
          where ya_existe is null
          and id_venta is null 
          order by fecha;
          
          */
        L_ERROR NUMBER;
        L_MSGERROR VARCHAR2(100) :='';
            
    BEGIN
            
            SELECT EXTRACT(YEAR FROM SYSDATE) into l_id_anho_current FROM DUAL;
            
            /*
            FOR sal in saldos
                LOOP
                select TO_CHAR(sal.fecha, 'YYYY') , TO_CHAR(sal.fecha, 'MM')into l_id_anho, l_id_mes from dual;
                
                select max(x.id_persona) into l_id_cliente from moises.persona_juridica x where x.id_ruc=sal.ruc_cliente;
            
                if l_id_cliente is null then 
                    select max(x.id_persona) into l_id_cliente from moises.persona_documento x 
                            where x.num_documento=sal.ruc_cliente and x.id_tipodocumento in (1,4,6);
                end if;
                
                
              SELECT count(v.id_venta) into l_count FROM VENTA v WHERE v.ID_ENTIDAD =sal.id_entidad
              --AND ID_DEPTO =sal.id_depto
              AND SERIE =sal.serie
              AND NUMERO =sal.numero;
                
                if l_count >0 then 
                    L_ERROR:=1; 
                    L_MSGERROR:='El comprobante ya existe  '||sal.serie||'-'||sal.numero;
                    GOTO salida_rapida;
                end if;
                
                if l_id_cliente is null then 
                    L_ERROR:=1; 
                    L_MSGERROR:='No se encuentra el cliente con num_doc '||sal.ruc_cliente;
                    GOTO salida_rapida;
                end if;
                
                if not (sal.moneda = 'PEN' or sal.moneda = 'USD') then 
                    L_ERROR:=1; 
                    L_MSGERROR:='Monedas disponibles (PEN/USD) ';
                    GOTO salida_rapida;
                end if;
                
                IF sal.moneda = 'PEN' THEN 
                    l_id_moneda := 7;
                else 
                    l_id_moneda := 9;
                end if;
                
                if sal.es_gravado ='1' then 
                    l_gravado := round(sal.importe/1.18,2);
                    l_igv := round(sal.importe-(sal.importe/1.18),2);
                    l_inafecta := 0;
                    l_id_tipoigv := '10';
                else 
                    l_gravado := 0;
                    l_igv := 0;
                    l_inafecta := sal.importe;
                    l_id_tipoigv := '30';
                end if;
                
                insert into venta(id_entidad,id_depto,id_anho,id_mes,id_persona,id_cliente,id_voucher,id_comprobante,id_igv,id_moneda,tipocambio, 
               id_leyenda, id_credito, ID_TIPOTRANSACCION, serie, numero,fecha,fecha_vencimiento,glosa,GRAVADA,IGV,inafecta,total,estado
               )
               values(
               sal.id_entidad,sal.id_depto,l_id_anho,l_id_mes,l_id_persona_register,l_id_cliente,null,sal.id_comprobante,18,l_id_moneda,0, 
               '1000', 1, null, sal.serie, sal.numero,sal.fecha,sal.fecha_venc,sal.glosa,l_gravado,l_igv,l_inafecta,sal.importe, '1'
               ) return id_venta into l_id_venta;
               
               
               -- Add venta_detalle
               insert into venta_detalle(id_venta,id_tipoigv,id_almacen,id_articulo,id_dinamica,detalle,cantidad,precio,base,igv,importe
               )
               values(l_id_venta,l_id_tipoigv,null,sal.id_articulo,null,sal.glosa,1,sal.importe,round(sal.importe-l_igv,2),l_igv,sal.importe
               );
               
  
          if l_id_anho < l_id_anho_current then 
                insert into eliseo.venta_saldo (
                ID_ENTIDAD,
                ID_DEPTO,
                ID_ANHO,
                id_mes,
                ID_VENTA,
                ID_MONEDA,
                ID_PERSONA,
                ID_CLIENTE,
                ID_COMPROBANTE,
                id_articulo,
                SERIE,
                NUMERO,
                FECHA,
                TOTAL,
                TOTAL_ME,
                IP,
                detalle,
                id_tipoventa
                )
                values(
                sal.id_entidad,
                sal.id_depto,
                l_id_anho_current,
                1,
                l_id_venta,
                l_id_moneda,
                l_id_persona_register, -- Usuariio sistema sistema
                l_id_cliente,
                sal.id_comprobante,
                --60131, -- Aos Anteriores
                null,
                sal.serie,
                sal.numero,
                TO_DATE('01-01-' || TO_CHAR(l_id_anho_current), 'dd-mm-yyyy'),
                sal.importe,
                0,
                null,
                'SALDO INICIAL',
                6
                );
            end if;
            
            update vv_importa_venta_jesus x
            set id_venta=l_id_venta
            where 1=1
            and x.numero=sal.numero
            and x.serie=sal.serie
            and x.ruc_cliente=sal.ruc_cliente
            ;
            
            
        end loop;
  */
       /*
        INSERT INTO CONTA_ASIENTO
        SELECT NULL, ca.ID_TIPOORIGEN, vd.ID_VDETALLE, ca.FONDO , ca.DEPTO , ca.CUENTA , ca.CUENTA_CTE , ca.RESTRICCION 
        , vd.IMPORTE , 
        xx.id_entidad||'-'||xx.id_depto||' ('||xx.SERIE||'-'||xx.NUMERO||') Migrated '||to_char(SYSDATE, 'DD/MM/YYYY') ,
        '1-'||vd.id_vdetalle ,null , ca.PARENT_ID , ca.REF_ID , ca.AGRUPA , ca.IMPORTE_ME , ca.PRIMARIO 
        FROM CONTA_ASIENTO ca,
        vv_importa_venta_jesus xx,
        VENTA_DETALLE vd 
        WHERE ca.ID_TIPOORIGEN =1
        AND ca.ID_ORIGEN =2896970
        AND xx.ID_VENTA =vd.ID_VENTA ;
        */
    
        DBMS_OUTPUT.PUT_LINE('P_ERROR = ' || L_ERROR);
        DBMS_OUTPUT.PUT_LINE('P_MSGERROR = ' || L_MSGERROR);     
                
        <<salida_rapida>>
        P_ERROR:=L_ERROR;
        P_MSGERROR:=L_MSGERROR;
            
    END SP_MIGRAR_VENTA_JESUS;

    PROCEDURE SP_MIGRAR_VENTA_JESUS_VALIDAR(P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2) IS
        l_count number := 0;
        /*
        cursor saldos is
           SELECT 
          id_entidad, 
          id_depto, 
          serie,
          numero, 
          ruc_cliente, 
          razon_social_cliente,
          fecha,
          fecha_venc,
          id_comprobante,
          moneda,
          glosa,
          es_gravado,
          importe,
          importe_me,
          cuenta_cte,
          id_articulo
          from vv_importa_venta_jesus
          order by fecha;
          */
        L_ERROR NUMBER;
        L_MSGERROR VARCHAR2(100) :='';
            
    BEGIN
            /*
            FOR sal in saldos
                LOOP
                
              SELECT count(v.id_venta) into l_count FROM VENTA v WHERE v.ID_ENTIDAD =sal.id_entidad
              --AND ID_DEPTO =sal.id_depto
              AND SERIE =sal.serie
              AND NUMERO =sal.numero;
                
                if l_count >0 then 
                     update vv_importa_venta_jesus x
                    set ya_existe='1'
                    where 1=1
                    and x.numero=sal.numero
                    and x.serie=sal.serie
                    and x.ruc_cliente=sal.ruc_cliente
                    ;
                end if;
               
        end loop;
         */
        DBMS_OUTPUT.PUT_LINE('P_ERROR = ' || L_ERROR);
        DBMS_OUTPUT.PUT_LINE('P_MSGERROR = ' || L_MSGERROR);     
                
        <<salida_rapida>>
        P_ERROR:=L_ERROR;
        P_MSGERROR:=L_MSGERROR;
            
    END SP_MIGRAR_VENTA_JESUS_VALIDAR;
    
    
    PROCEDURE SP_VENTA_GUIA_ELECTRONICA(P_ID_VENTA_GUIA IN NUMBER) IS
        L_ID_ENTIDAD NUMBER;
        L_RUC VARCHAR2(11);
        L_ID_COMPROBANTE VARCHAR2(2);
        L_SERIE VARCHAR2(4);
        L_NUMERO VARCHAR2(8);
    
        L_DET CLOB;
        L_EMISOR_ID NUMBER:=101; --acesssss EMPRESA CON RUC UPeU
        L_HASH VARCHAR2(50);
        	
    BEGIN  
        SELECT 
                ID_ENTIDAD,ID_COMPROBANTE,SERIE,NUMERO
                INTO L_ID_ENTIDAD,L_ID_COMPROBANTE,L_SERIE,L_NUMERO
        FROM VENTA_GUIA
        WHERE ID_VENTA_GUIA = P_ID_VENTA_GUIA;
        
        SELECT B.ID_RUC INTO L_RUC
        FROM CONTA_ENTIDAD A, CONTA_EMPRESA B
        WHERE A.ID_EMPRESA = B.ID_EMPRESA
        AND A.ID_ENTIDAD = L_ID_ENTIDAD;
        
        SELECT TO_CLOB(PKG_SALES_INDUSTRY.FC_VENTA_GUIA(P_ID_VENTA_GUIA)) INTO L_DET FROM DUAL;
        IF L_ID_ENTIDAD =7124 THEN -- upeu
			SELECT ID INTO L_EMISOR_ID FROM VENTA_EMISOR WHERE RUC=L_RUC;
        	INSERT INTO VENTA_ELECTRONICA(EMISORID,ORIGENID,FECHA,TIPO,NROCOMPROBANTE,COMPROBANTE,NOMBREARCHIVO,PROCESADO,ENVIADO)
        	VALUES(L_EMISOR_ID,P_ID_VENTA_GUIA,SYSDATE,L_ID_COMPROBANTE,L_SERIE||'-'||L_NUMERO,L_DET,L_RUC||'-'||L_ID_COMPROBANTE||'-'||L_SERIE||'-'||L_NUMERO||'.txt',0,0);
        ELSIF L_ID_ENTIDAD =9415 THEN --ACES
			SELECT ID INTO L_EMISOR_ID FROM VENTA_EMISOR_ACES vea WHERE RUC=L_RUC;
        	INSERT INTO VENTA_ELECTRONICA_ACES(EMISORID,ORIGENID,FECHA,TIPO,NROCOMPROBANTE,COMPROBANTE,NOMBREARCHIVO,PROCESADO,ENVIADO)
        	VALUES(L_EMISOR_ID,P_ID_VENTA_GUIA,SYSDATE,L_ID_COMPROBANTE,L_SERIE||'-'||L_NUMERO,L_DET,L_RUC||'-'||L_ID_COMPROBANTE||'-'||L_SERIE||'-'||L_NUMERO||'.txt',0,0);
        END IF;
        
    END SP_VENTA_GUIA_ELECTRONICA;
    
-- Package body
END PKG_SALES_INDUSTRY;