-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE PKG_RVIE_RCE AS 

  /* TODO enter package declarations (types, exceptions, methods etc) here */ 
  PROCEDURE SP_COPIAR_VENTA_CONTRIBUY(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_COPIAR_VENTA_IMPRENTA(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_CREAR_VENTAS_PRELIMINAR(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2,P_TIPO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_COPIAR_COMPRA_CONTRIBUY(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_COPIAR_COMPRA_IMPRENTA(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_CREAR_COMPRAS_PRELIMINAR(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2,P_TIPO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_CREAR_COMPRAS_NODOM(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2,P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_COPIAR_COMPRA_NODOM(P_ID_COMPRAS_PRELI NUMBER, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_COPIAR_COMPRA_NODOM_IMP(P_ID_COMPRAS_PRELI NUMBER, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
END PKG_RVIE_RCE;


CREATE OR REPLACE PACKAGE BODY PKG_RVIE_RCE AS
  PROCEDURE SP_COPIAR_VENTA_CONTRIBUY(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
    begin
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;
      
      delete from SIRE_VENTAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto not in('2','3');
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_VENTAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;
      
      
      insert into SIRE_VENTAS_CONTRIBUY(
        ID_VENTAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        VALFACEXPO,
        BIGRAVADA,
        DSCTOBI,
        IGVIPM,
        DSCTOIGVIPM,
        MTOEXONERADO,
        MTOINAFECTO,
        ISC,
        BIGRAVIVAP,
        IVAP,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        NROCPMOD,
        IDPROYOPERATRI,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      select 
      to_char(P_ID_EMPRESA)||to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0')|| to_char((row_number() OVER( ORDER BY a.ID_venta ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
      P_ID_EMPRESA as ID_EMPRESA,
      a.id_entidad,
      a.id_depto,
      to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0') as PERIODO,
      ((row_number() OVER( ORDER BY a.ID_venta ASC )) + l_orden) as ORDEN,
      a.FECHA,
      null,--a.FECHA_VENCIMIENTO,
      a.id_comprobante,
      a.SERIE,
      to_char(to_number(a.NUMERO)) as NUMERO ,
      '' as NRODOFINAL,
      case 
      when a.id_comprobante='03' then
          DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0)
      when a.id_comprobante='01' then
          6
      else 
      	decode(SUBSTR(a.serie,1,1),'F',6,DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,1,0))

      end as TIPODOC,
      case 
      when a.id_comprobante='03' then
          DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000')
      when a.id_comprobante='01' then
        NVL(FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE)),'-')
      else
        decode(decode(SUBSTR(a.serie,1,1),'F','6','1'),'6',NVL(eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE_legal,A.ID_CLIENTE)),'-'),DECODE(length(trim(REGEXP_REPLACE(ELISEO.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'[A-Za-z]*'))),8,eliseo.FC_DOCUMENTO_CLIENTE(NVL(A.ID_CLIENTE,A.ID_CLIENTE_legal)),'0000'))
      end as NRODOCUMENTO,
      
      case 
      when a.id_comprobante='03' then
        case when a.ID_TIPOVENTA IN (1,2,3,4) THEN
          NVL(TRIM(FC_NOMBRE_CLIENTE(A.ID_CLIENTE)),'Cliente Varios')
        else
          NVL(TRIM(FC_NOMBRE_CLIENTE(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))),'Cliente Varios')
        end
      when a.id_comprobante='01' then
        
          FC_NOMBRE_PERSONA(NVL(A.ID_CLIENTE_LEGAL,A.ID_CLIENTE))
      else
          decode(decode(SUBSTR(a.serie,1,1),'F','6','1'),'6',eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE_legal,A.ID_CLIENTE)),eliseo.FC_NOMBRE_CLIENTE(nvl(A.ID_CLIENTE,A.ID_CLIENTE_legal)))
      end as RAZONSOCIAL,
      0 as VALFACEXPO,
      coalesce(a.GRAVADA,0) as BIGRAVADA,
      coalesce(a.DESCUENTO_GLOBAL,0) as DSCTOBI,
      coalesce(a.IGV,0) as IGVIPM,
      0 as DSCTOIGVIPM,
      coalesce(a.EXONERADA,0) as MTOEXONERADO,
      coalesce(a.INAFECTA,0)  as MTOINAFECTO,
      0 as ISC,
      0 as BIGRAVIVAP,
      0 as IVAP,
      coalesce(a.OTROS_CARGOS,0) as ICBPER,
      coalesce(a.OTROS_CARGOS,0) as OTROSTRIBUTOS,
      coalesce(a.TOTAL,0) as TOTALCP,
      DECODE(A.ID_MONEDA,7,'PEN','USD') as MONEDA,
      coalesce(a.TIPOCAMBIO,0),
      a.FECHA_REF as FEMISIONDOCMOD,
      a.ID_COMPROBANTE_REF as TIPOCPMOD,
      a.SERIE_REF as  SERIECPMOD,
      a.NUMERO_REF as NROCPMOD,
      '' as IDPROYOPERATRI,
      l_ruc ||a.ID_COMPROBANTE||a.SERIE||LPAD(to_char(a.NUMERO),10,'0') as CARSUNAT,
      P_ID_USER,
      SYSDATE
      from venta a
      where a.id_entidad in(
        select id_entidad from conta_entidad where id_empresa=P_ID_EMPRESA 
      )
      and to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0')=P_PERIODO
      and a.estado='1'
      order by a.id_comprobante,
      a.SERIE,
      to_char(to_number(a.NUMERO));
      
      
      update SIRE_VENTAS_CONTRIBUY set
        VALFACEXPO=VALFACEXPO*(-1),
        BIGRAVADA=BIGRAVADA*(-1),
        DSCTOBI=DSCTOBI*(-1),
        IGVIPM=IGVIPM*(-1),
        DSCTOIGVIPM=DSCTOIGVIPM*(-1),
        MTOEXONERADO=MTOEXONERADO*(-1),
        MTOINAFECTO=MTOINAFECTO*(-1),
        ISC=ISC*(-1),
        BIGRAVIVAP=BIGRAVIVAP*(-1),
        IVAP=IVAP*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP='07'
      and TOTALCP>0
      and id_depto not in('2','3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_COPIAR_VENTA_CONTRIBUY;
    
    PROCEDURE SP_COPIAR_VENTA_IMPRENTA(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
    begin
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;
      
      delete from SIRE_VENTAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto  in('3');
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_VENTAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;
      
      
      insert into SIRE_VENTAS_CONTRIBUY(
        ID_VENTAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        VALFACEXPO,
        BIGRAVADA,
        DSCTOBI,
        IGVIPM,
        DSCTOIGVIPM,
        MTOEXONERADO,
        MTOINAFECTO,
        ISC,
        BIGRAVIVAP,
        IVAP,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        NROCPMOD,
        IDPROYOPERATRI,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      
      select
          to_char(P_ID_EMPRESA)||P_PERIODO|| to_char((row_number() OVER( ORDER BY ID_MOV ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
          P_ID_EMPRESA as ID_EMPRESA,
          7124 AS ID_ENTIDAD,
          '3' AS ID_DEPTO,
          TO_CHAR(FECHA,'YYYYMM') AS PERIODO,
          ((row_number() OVER( ORDER BY ID_MOV ASC )) + l_orden) as ORDEN,
          FECHA,
          NULL AS FECHA_VENCIMIENTO,
          ID_COMPROBANTE,
          SERIE,
          NUMERO,
          '' AS NRODOFINAL,
          TIPO_DOC,
          NRODOCUMENTO,
          RAZON_SOCIAL,
          0 AS VALFACEXPO,
          BIGRABADA,
          0 AS DSCTOBI,
          IGVIMP,
          0 AS DSCTOIGVIPM,
          MTOEXONERADO,
          MTOINAFECTO,
          0 AS ISC,
          0 AS BIGRAVIVAP,
          0 AS IVAP,
          0 AS ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPO_CAMBIO,
          null AS FECHA_REF,
          TIPOCPMOD,
          SERIECPMOD,
          NROCPMOD,
          '' AS IDPROYOPERATRI,
          CARSUNAT,
          P_ID_USER,
          SYSDATE
        from(
          SELECT
            a.ID_MOV_DOC as ID_MOV ,
            A.FECHA,
            A.TIPODOC_VNT AS ID_COMPROBANTE, 
            (CASE A.TIPODOC_VNT WHEN '07' THEN A.SERIE_NOT WHEN '08' THEN A.SERIE_NOT ELSE DECODE(A.SERIE_VNT,'X',' ',A.SERIE_VNT) END) AS SERIE,
            to_char(to_number((CASE A.TIPODOC_VNT WHEN '07' THEN A.NUMNOT WHEN '08' THEN A.NUMNOT ELSE A.NUMDOC END))) AS NUMERO,
            (CASE SUBSTR(A.SERIE_VNT,1,1) WHEN 'F' THEN 6 ELSE DECODE(LENGTH(TRIM(REGEXP_REPLACE (UPPER(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL)), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', '')) ),8,1,0) END) AS TIPO_DOC,
            (CASE SUBSTR(A.SERIE_VNT,1,1) WHEN 'F' THEN TRIM(NVL(RUC4@DBL_ARON_APP(A.ID_PERSONAL),RUC@DBL_ARON_APP(A.ID_PERSONAL))) ELSE DECODE(LENGTH(TRIM(REGEXP_REPLACE (UPPER(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL)), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', ''))),8,FC_DNI@DBL_ARON_APP(A.ID_PERSONAL),nvl(trim(RUC@DBL_ARON_APP(A.ID_PERSONAL)),'0000')) END) AS NRODOCUMENTO,
            (CASE SUBSTR(A.SERIE_VNT,1,1) WHEN 'F' THEN TRIM(NVL(APELLIDO2@DBL_ARON_APP(A.ID_PERSONAL),'Cliente Aces Peru')) ELSE TRIM(nvl(APELLIDO2@DBL_ARON_APP(A.ID_PERSONAL),'Cliente UPeU')) END) AS RAZON_SOCIAL,
            DECODE(A.TIPO_VENTA,'10',NVL(A.BASE_IMP,0),0) AS BIGRABADA,
            NVL(A.IGV,0) AS IGVIMP,
            DECODE(A.TIPO_VENTA,'20',NVL(A.BASE_IMP,0),0) AS MTOEXONERADO,
            DECODE(A.TIPO_VENTA,'30',NVL(A.BASE_IMP,0),0) AS MTOINAFECTO,
            0 as OTROSTRIBUTOS,
            NVL(A.IMPORTE,0) AS TOTALCP,
            DECODE(A.MONEDA,'00','PEN','USD') AS MONEDA,
            coalesce(A.TIPO_CAMBIO,0) as TIPO_CAMBIO,
            (CASE A.TIPODOC_VNT WHEN '07' THEN A.TIPODOC_NOT WHEN '08' THEN A.TIPODOC_NOT ELSE '' END) AS TIPOCPMOD,
            (CASE A.TIPODOC_VNT WHEN '07' THEN A.SERIE_VNT WHEN '08' THEN A.SERIE_VNT ELSE '' END) AS SERIECPMOD,
            (CASE A.TIPODOC_VNT WHEN '07' THEN LPAD(A.NUMDOC,8,'0') WHEN '08' THEN LPAD(A.NUMDOC,8,'0') ELSE '' END) AS NROCPMOD,
            l_ruc||A.TIPODOC_VNT||(CASE A.TIPODOC_VNT WHEN '07' THEN A.SERIE_NOT WHEN '08' THEN A.SERIE_NOT ELSE DECODE(A.SERIE_VNT,'X',' ',A.SERIE_VNT) END)||(CASE A.TIPODOC_VNT WHEN '07' THEN LPAD(A.NUMNOT,10,'0') WHEN '08' THEN LPAD(A.NUMNOT,10,'0') ELSE LPAD(A.NUMDOC,10,'0') END) AS CARSUNAT
          FROM IMP_REG_VNT2@DBL_ARON_APP A, DATOS_CLIENTES@DBL_ARON_APP B 
          WHERE A.ID_PERSONAL = B.ID_PERSONAL 
          AND A.ID_VENTA = '001-' ||SUBSTR(P_PERIODO,0,4)
          AND TO_CHAR(A.FECHA,'MM') = SUBSTR(P_PERIODO,5,2) 
          union all
          SELECT  
            id_mov_vnt as ID_MOV,
            A.FECHA_DOC as FECHA,  
            A.TIPODOC AS ID_COMPROBANTE,
            A.SERIE,  
            A.NUMDOC AS NUMERO,
            DECODE(A.TIPODOC,'01',6,DECODE(LENGTH(TRIM(REGEXP_REPLACE (UPPER(NVL(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL),DNI@DBL_ARON_APP(A.ID_PERSONAL))), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', '')) ),8,1,0)) AS TIPO_DOC,
            DECODE(LENGTH(TRIM(REGEXP_REPLACE (UPPER(NVL(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL),DNI@DBL_ARON_APP(A.ID_PERSONAL))), 'A|B|C|D|E|F|G|H|I|J|K|M|N|O|P|Q|R|S|T|U|V|W|X|Y|Z', ''))),8,NVL(FC_DNI_MKT@DBL_ARON_APP(A.ID_PERSONAL),DNI@DBL_ARON_APP(A.ID_PERSONAL)),NVL(RUC@DBL_ARON_APP(ID_PERSONAL),'0000')) AS NRODOCUMENTO,
            TRIM(NVL(APELLIDO2@DBL_ARON_APP(A.ID_PERSONAL),'Cliente UPeU')) AS RAZON_SOCIAL,
            NVL(A.BASE_IMP,0) AS BIGRABADA, 
            NVL(A.IGV,0) AS IGVIMP,
            NVL(A.IMP_EXONERADA,0) AS MTOEXONERADO,
            NVL(A.IMP_INAFECTA,0) AS MTOINAFECTO,
            NVL(A.OTROS_CARGOS,0) AS OTROSTRIBUTOS, 
            NVL(A.IMPORTE,0) AS TOTALCP, 
            DECODE(NVL(A.MONEDA,'00'),'00','PEN','USD') AS MONEDA,
            NVL(A.TIPO_CAMBIO,1) AS TIPO_CAMBIO,
            '' AS TIPOCPMOD,
            '' AS SERIECPMOD,
            '' AS NROCPMOD,
            l_ruc||A.TIPODOC||A.SERIE||LPAD(A.NUMDOC,10,'0') AS CARSUNAT
          FROM MKT_REGVENTAS@DBL_ARON_APP A       
          WHERE A.ID_NIVEL_CONT  LIKE '3%' 
          AND   A.ID_VENTA='001-'||SUBSTR(P_PERIODO,0,4)
          AND   A.ESTADO='V'         
          AND   TO_CHAR(A.FECHA_PED,'MM')=SUBSTR(P_PERIODO,5,2)
        )
        ORDER BY ID_COMPROBANTE, serie, NUMERO;
      
      
      update SIRE_VENTAS_CONTRIBUY set
        VALFACEXPO=VALFACEXPO*(-1),
        BIGRAVADA=BIGRAVADA*(-1),
        DSCTOBI=DSCTOBI*(-1),
        IGVIPM=IGVIPM*(-1),
        DSCTOIGVIPM=DSCTOIGVIPM*(-1),
        MTOEXONERADO=MTOEXONERADO*(-1),
        MTOINAFECTO=MTOINAFECTO*(-1),
        ISC=ISC*(-1),
        BIGRAVIVAP=BIGRAVIVAP*(-1),
        IVAP=IVAP*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP='07'
      and TOTALCP>0
      and id_depto  in('3');


    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_COPIAR_VENTA_IMPRENTA;
    
    PROCEDURE SP_CREAR_VENTAS_PRELIMINAR(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2,P_TIPO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
      l_id number:=0;
      l_corr number:=0;
    begin
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;
      
      select count(1) into l_contar from SIRE_VENTAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO and ID_ESTADO_PREL_RVIE not in('00');
      
      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Primero elimine los registros anteriores del mes';
        goto salida;
      end if;
      
     select coalesce(max(ID_VENTAS_PRELI),0) +1 into l_id from SIRE_VENTAS_PRELI;
     
     if P_TIPO='R' then
      select coalesce(max(CORRELATIVO),0) + 1 into l_corr from SIRE_VENTAS_PRELI
      where id_empresa=P_ID_EMPRESA
      and periodo=P_PERIODO;
     end if;
      
     INSERT INTO SIRE_VENTAS_PRELI(
      ID_VENTAS_PRELI,
      ID_EMPRESA,
      PERIODO,
      TIPO,
      ID_ESTADO_PREL_RVIE,
      CORRELATIVO,
      ID_USER_REG,
      FECHA_REG
      )VALUES(
        l_id,
        P_ID_EMPRESA,
        P_PERIODO,
        P_TIPO,
        '01',
        l_corr,
        P_ID_USER,
        sysdate
      );
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_VENTAS_PRELI_DET 
      where ID_VENTAS_PRELI in(
        select ID_VENTAS_PRELI from SIRE_VENTAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO
      );
      
      if P_TIPO='P' then
        insert into SIRE_VENTAS_PRELI_DET(
          ID_VENTAS_PRELI_DET,
          ID_VENTAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          VALFACEXPO,
          BIGRAVADA,
          DSCTOBI,
          IGVIPM,
          DSCTOIGVIPM,
          MTOEXONERADO,
          MTOINAFECTO,
          ISC,
          BIGRAVIVAP,
          IVAP,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          NROCPMOD,
          IDPROYOPERATRI,
          TIPODENOTA,
          ESTCOMP,
          VALORFOBEMBO,
          VALOROPGRAT,
          TIPOOPERACION,
          DAMCP,
          CLU,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        select 
        to_char(P_ID_EMPRESA)||PERIODO|| to_char((row_number() OVER( ORDER BY ID_VENTAS_SUNAT ASC )) + l_orden) as ID_VENTAS_PRELI_DET,
        l_id,
        (row_number() OVER( ORDER BY ID_VENTAS_SUNAT ASC )) + l_orden,
        'P',
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        VALFACEXPO,
        BIGRAVADA,
        DSCTOBI,
        IGVIPM,
        DSCTOIGVIPM,
        MTOEXONERADO,
        MTOINAFECTO,
        ISC,
        BIGRAVIVAP,
        IVAP,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        NROCPMOD,
        IDPROYOPERATRI,
        TIPODENOTA,
        ESTCOMP,
        VALORFOBEMBO,
        VALOROPGRAT,
        TIPOOPERACION,
        DAMCP,
        CLU,
        CARSUNAT,
        1,
        0,
        P_ID_USER,
        SYSDATE
        from SIRE_VENTAS_SUNAT 
        where id_empresa=P_ID_EMPRESA 
        and periodo=P_PERIODO
        order by TIPOCOMP,SERIE,NRODOCINICIAL;
    else
      insert into SIRE_VENTAS_PRELI_DET(
          ID_VENTAS_PRELI_DET,
          ID_VENTAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          VALFACEXPO,
          BIGRAVADA,
          DSCTOBI,
          IGVIPM,
          DSCTOIGVIPM,
          MTOEXONERADO,
          MTOINAFECTO,
          ISC,
          BIGRAVIVAP,
          IVAP,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          NROCPMOD,
          IDPROYOPERATRI,
          TIPODENOTA,
          ESTCOMP,
          VALORFOBEMBO,
          VALOROPGRAT,
          TIPOOPERACION,
          DAMCP,
          CLU,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        select 
        to_char(P_ID_EMPRESA)||a.PERIODO|| to_char((row_number() OVER( ORDER BY a.ID_VENTAS_SUNAT ASC )) + l_orden) as ID_VENTAS_PRELI_DET,
        l_id,
        (row_number() OVER( ORDER BY a.ID_VENTAS_SUNAT ASC )) + l_orden,
        'P',
        a.FEMISION,
        a.FVCTOPAGO,
        a.TIPOCOMP,
        a.SERIE,
        a.NRODOCINICIAL,
        a.NRODOFINAL,
        a.TIPODOC,
        a.NRODOCUMENTO,
        a.RAZONSOCIAL,
        a.VALFACEXPO,
        a.BIGRAVADA,
        a.DSCTOBI,
        a.IGVIPM,
        a.DSCTOIGVIPM,
        a.MTOEXONERADO,
        a.MTOINAFECTO,
        a.ISC,
        a.BIGRAVIVAP,
        a.IVAP,
        a.ICBPER,
        a.OTROSTRIBUTOS,
        a.TOTALCP,
        a.MONEDA,
        a.TIPOCAMBIO,
        a.FEMISIONDOCMOD,
        a.TIPOCPMOD,
        a.SERIECPMOD,
        a.NROCPMOD,
        a.IDPROYOPERATRI,
        a.TIPODENOTA,
        a.ESTCOMP,
        a.VALORFOBEMBO,
        a.VALOROPGRAT,
        a.TIPOOPERACION,
        a.DAMCP,
        a.CLU,
        a.CARSUNAT,
        1,
        0,
        P_ID_USER,
        SYSDATE
        from SIRE_VENTAS_SUNAT a
        where a.id_empresa=P_ID_EMPRESA 
        and a.periodo=P_PERIODO
        and a.CARSUNAT in(
          /*select w.CARSUNAT from SIRE_VENTAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
          and w.TIPODOC=a.TIPODOC
          and w.NRODOCUMENTO=a.NRODOCUMENTO
          and lower(w.RAZONSOCIAL)=lower(a.RAZONSOCIAL)
          union*/
          select w.CARSUNAT from SIRE_VENTAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
          and coalesce(w.VALFACEXPO,0)= coalesce(a.VALFACEXPO,0)
          and coalesce(w.BIGRAVADA,0)= coalesce(a.BIGRAVADA,0)
          and coalesce(w.DSCTOBI,0)= coalesce(a.DSCTOBI,0)
          and coalesce(w.IGVIPM,0)= coalesce(a.IGVIPM,0)
          and coalesce(w.DSCTOIGVIPM,0)= coalesce(a.DSCTOIGVIPM,0)
          and coalesce(w.MTOEXONERADO,0)= coalesce(a.MTOEXONERADO,0)
          and coalesce(w.MTOINAFECTO,0)= coalesce(a.MTOINAFECTO,0)
          and coalesce(w.ISC,0)= coalesce(a.ISC,0)
          and coalesce(w.BIGRAVIVAP,0)= coalesce(a.BIGRAVIVAP,0)
          and coalesce(w.IVAP,0)= coalesce(a.IVAP,0)
          and coalesce(w.ICBPER,0)= coalesce(a.ICBPER,0)
          and coalesce(w.OTROSTRIBUTOS,0)= coalesce(a.OTROSTRIBUTOS,0)
          and coalesce(w.TOTALCP,0)= coalesce(a.TOTALCP,0)
        )
        order by a.TIPOCOMP,a.SERIE,a.NRODOCINICIAL;
        
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_VENTAS_PRELI_DET 
      where ID_VENTAS_PRELI in(
        select ID_VENTAS_PRELI from SIRE_VENTAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO
      );
      
      insert into SIRE_VENTAS_PRELI_DET(
          ID_VENTAS_PRELI_DET,
          ID_VENTAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          VALFACEXPO,
          BIGRAVADA,
          DSCTOBI,
          IGVIPM,
          DSCTOIGVIPM,
          MTOEXONERADO,
          MTOINAFECTO,
          ISC,
          BIGRAVIVAP,
          IVAP,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          NROCPMOD,
          IDPROYOPERATRI,
          TIPODENOTA,
          ESTCOMP,
          VALORFOBEMBO,
          VALOROPGRAT,
          TIPOOPERACION,
          DAMCP,
          CLU,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        select 
        to_char(P_ID_EMPRESA)||a.PERIODO|| to_char((row_number() OVER( ORDER BY a.ID_VENTAS_SUNAT ASC )) + l_orden) as ID_VENTAS_PRELI_DET,
        l_id,
        (row_number() OVER( ORDER BY a.ID_VENTAS_SUNAT ASC )) + l_orden,
        'P',
        a.FEMISION,
        a.FVCTOPAGO,
        a.TIPOCOMP,
        a.SERIE,
        a.NRODOCINICIAL,
        a.NRODOFINAL,
        a.TIPODOC,
        a.NRODOCUMENTO,
        a.RAZONSOCIAL,
        a.VALFACEXPO,
        a.BIGRAVADA,
        a.DSCTOBI,
        a.IGVIPM,
        a.DSCTOIGVIPM,
        a.MTOEXONERADO,
        a.MTOINAFECTO,
        a.ISC,
        a.BIGRAVIVAP,
        a.IVAP,
        a.ICBPER,
        a.OTROSTRIBUTOS,
        a.TOTALCP,
        a.MONEDA,
        a.TIPOCAMBIO,
        a.FEMISIONDOCMOD,
        a.TIPOCPMOD,
        a.SERIECPMOD,
        a.NROCPMOD,
        a.IDPROYOPERATRI,
        a.TIPODENOTA,
        a.ESTCOMP,
        a.VALORFOBEMBO,
        a.VALOROPGRAT,
        a.TIPOOPERACION,
        a.DAMCP,
        a.CLU,
        a.CARSUNAT,
        1,
        0,
        P_ID_USER,
        SYSDATE
        from SIRE_VENTAS_SUNAT a
        where a.id_empresa=P_ID_EMPRESA 
        and a.periodo=P_PERIODO
        and a.CARSUNAT not in(
          select w.CARSUNAT from SIRE_VENTAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
        )
        order by a.TIPOCOMP,a.SERIE,a.NRODOCINICIAL;
      
    end if;
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_CREAR_VENTAS_PRELIMINAR;
    
    PROCEDURE SP_COPIAR_COMPRA_CONTRIBUY(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
    begin
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;
      
      delete from SIRE_COMPRAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto not in('2','3');
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_COMPRAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;
      
      
      insert into SIRE_COMPRAS_CONTRIBUY(
        ID_COMPRAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        INCAL,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      select 
      distinct 
      to_char(P_ID_EMPRESA)||to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0')|| to_char((row_number() OVER( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
      P_ID_EMPRESA as ID_EMPRESA,
      a.id_entidad,
      a.id_depto,
      to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0') as PERIODO,
      ((row_number() OVER( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ORDEN,
      a.FECHA_DOC,
      null,--a.FECHA_VENCIMIENTO,
      a.id_comprobante,
      a.SERIE,
      to_char(a.id_anho) as anho,
      LPAD(to_char(a.id_mes),2,'0') as mes,
      to_char(to_number(a.NUMERO)) as NUMERO ,
      '' as NRODOFINAL,
      '6' as TIPODOC,
      B.ID_RUC as NRODOCUMENTO,
      b.NOMBRE as RAZONSOCIAL,
      coalesce(a.BASE_GRAVADA,0) as BASE_GRAVADA,
      coalesce(a.IGV_GRAVADO,0) as IGV_GRAVADO,
      coalesce(a.IGV,0) as BASE_MIXTA,
      coalesce(a.IGV_MIXTO,0) as IGV_MIXTO,
      coalesce(a.BASE_NOGRAVADA,0) as BASE_NOGRAVADA,
      coalesce(a.IGV_NOGRAVADO,0)  as IGV_NOGRAVADO,
      coalesce(a.BASE_SINCREDITO,0)  as BASE_SINCREDITO,
      0 as ISC,
      0 as ICBPER,
      coalesce(a.OTROS,0) as OTROS,
      coalesce(a.IMPORTE,0) as TOTALCP,
      DECODE(A.ID_MONEDA,7,'PEN','USD') as MONEDA,
      coalesce(a.TIPOCAMBIO,0),
      c.FECHA_DOC as FEMISIONDOCMOD,
      c.id_comprobante as TIPOCPMOD,
      c.SERIE as  SERIECPMOD,
      '' as CODDAMODSI,
      to_char(to_number(c.NUMERO)) as NROCPMOD,
      '' as CLASIFDEBSSYSSS,
      '' as IDPROYOPERATRI,
      '' as PORCPART,
      null as IMB,
      '' as CARORIGINDEOI,
      case when a.ES_RET_DET= 'D' then  'D' else '' end as DETRACCION,
      a.ID_TIPONOTA,
      '' as INCAL,
      B.ID_RUC ||a.ID_COMPROBANTE||a.SERIE||LPAD(to_char(a.NUMERO),20,'0') as CARSUNAT,
      P_ID_USER,
      SYSDATE
      from COMPRA a inner join MOISES.VW_PERSONA_NATURAL_LEGAL B on a.ID_PROVEEDOR = b.ID_PERSONA
      LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
      where a.id_entidad in(
        select id_entidad from conta_entidad where id_empresa=P_ID_EMPRESA 
      )
      and to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0')=P_PERIODO
      and a.estado='1'
      and a.id_comprobante not IN('02','91','97','98','87','88')
      order by a.id_comprobante,
      a.SERIE,
      to_number(a.NUMERO);
      
 
      update SIRE_COMPRAS_CONTRIBUY set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP in('07','87')
      and TOTALCP>0
      and id_depto not in('2','3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_COPIAR_COMPRA_CONTRIBUY;
    
    PROCEDURE SP_COPIAR_COMPRA_IMPRENTA(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
    begin
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;
      
      delete from SIRE_COMPRAS_CONTRIBUY 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and id_depto  in('3');
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_COMPRAS_CONTRIBUY where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO;
      
      
      insert into SIRE_COMPRAS_CONTRIBUY(
        ID_COMPRAS_CONTRIBUY,
        ID_EMPRESA,
        ID_ENTIDAD,
        ID_DEPTO,
        PERIODO,
        ORDEN,
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        INCAL,
        CARSUNAT,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT
        to_char(P_ID_EMPRESA)||to_char(TO_CHAR(w.FECHA_PROV,'YYYY'))||LPAD(to_char(TO_CHAR(w.FECHA_PROV,'MM')),2,'0')|| to_char((row_number() OVER( ORDER BY w.id_mov_comp ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
        P_ID_EMPRESA as ID_EMPRESA,
        7124 as id_entidad,
        '3' AS id_depto,
        TO_CHAR(w.FECHA_PROV,'YYYYMM') as PERIODO,
        ((row_number() OVER( ORDER BY w.id_mov_comp ASC )) + l_orden) as ORDEN,
        w.FECHA_DOC,
        null,
        w.TIPO_DOC,
        w.SERIE,
        TO_CHAR(w.FECHA_PROV,'YYYY'),        
        TO_CHAR(w.FECHA_PROV,'MM'),
        to_char(to_number(w.NUMDOC)) as NUMERO ,
        '' as NRODOFINAL,
        '6' as TIPODOC,
        w.RUC as NRODOCUMENTO,
        w.NOMBRE as RAZONSOCIAL,
        coalesce(w.BASEIMP1,0) as BIGRAVADODG,
        coalesce(w.IGV1,0) as IGVIPMDG,
        coalesce(w.BASEIMP5,0) as BIGRAVADODGNG,
        coalesce(w.IGV5,0) as IGVIPMDGNG,
        coalesce(w.BASEIMP2,0) as BIGRAVADODNG,
        coalesce(w.IGV2,0)  as IGVIPMDNG,
        coalesce(w.INAFECTA,0)  as VALORADQNG,
        coalesce(w.ICBPER,0) as ISC,
        0 as ICBPER,
        0 as OTROS,
        coalesce(w.IMPORTE,0) as TOTALCP,
        w.MONEDA,
        coalesce(w.TIPO_CAMBIO,0),   
        w.FEMISIONDOCMOD,
        w.TIPOCPMOD,
        w.SERIECPMOD,
        w.CODDAMODSI,
        w.NROCPMOD,
        '' as CLASIFDEBSSYSSS,
        '' as IDPROYOPERATRI,
        '' as PORCPART,
        null as IMB,
        '' as CARORIGINDEOI,
        w.DETRACCION,
        case when w.TIPO_DOC='07' then '01' when w.TIPO_DOC='08' then '11' else '' end as ID_TIPONOTA,
        '' as INCAL,
        w.RUC ||w.TIPO_DOC||w.SERIE||LPAD(w.NUMDOC,20,'0') as CARSUNAT,
        P_ID_USER,
        SYSDATE
        
      FROM(
        SELECT 
        A.FECHA_PROV,
        A.id_mov_comp,
        A.FECHA_DOC,
        A.TIPO_DOC, 
        A.SERIE,
        A.NUMDOC,
        B.RUC,
        B.NOMBRE,
        A.BASEIMP1,
        A.IGV1,
        A.BASEIMP5,
        A.IGV5,
        A.BASEIMP2,
        A.IGV2,
        NVL(A.BASEIMP3,A.BASEIMP4) AS INAFECTA,
        A.ICBPER,
        A.IMPORTE,
        DECODE(A.MONEDA,'00','PEN','USD') AS MONEDA,
        A.TIPO_CAMBIO,
        null as FEMISIONDOCMOD,
        '' as TIPOCPMOD,
        '' as  SERIECPMOD,
        '' as CODDAMODSI,
        '' as NROCPMOD,
        case when A.DETRAC= 'D' then  'D' else '' end  as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON A.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE A.ID_COMPRAS = '001-' ||SUBSTR(P_PERIODO,0,4)
        AND TO_CHAR(A.FECHA_PROV,'MM') = SUBSTR(P_PERIODO,5,2) 
        AND A.ESTADO = 'P'
        AND A.TIPO_DOC not in('91','97','98')          
        UNION ALL
        SELECT 
        X.FECHA_PROV,
        X.id_mov_not as id_mov_comp,
        X.FECHA_DOC,
        X.TIPO_DOC, 
        X.SERIE,
        X.NUMDOC,
        B.RUC,
        B.NOMBRE,
        (CASE X.TIPO_BI WHEN '1' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP1,
        (CASE X.TIPO_BI WHEN '1' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV1,
        (CASE X.TIPO_BI WHEN '5' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP5,
        (CASE X.TIPO_BI WHEN '5' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV5,
        (CASE X.TIPO_BI WHEN '2' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP2,
        (CASE X.TIPO_BI WHEN '2' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV2,
        (CASE X.TIPO_BI WHEN '4' THEN X.IMPORTE END) AS INAFECTA,
        A.ICBPER,
        X.IMPORTE,
        DECODE(X.MONEDA,'00','PEN','USD') AS MONEDA,
        A.TIPO_CAMBIO,
        A.FECHA_DOC as FEMISIONDOCMOD,
        A.TIPO_DOC as TIPOCPMOD,
        A.SERIE as  SERIECPMOD,
        '' as CODDAMODSI,
        A.NUMDOC as NROCPMOD,
        '' as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A JOIN COMPRAS_NOTAS@DBL_ARON_APP X ON A.ID_MOV_COMP = X.ID_MOV_COMP
        LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON X.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE X.ID_COMPRAS = '001-' ||SUBSTR(P_PERIODO,0,4)
        AND TO_CHAR(X.FECHA_PROV,'MM') = SUBSTR(P_PERIODO,5,2) 
        and X.TIPO_DOC not in('91','97','98')   
      )w
      order by w.TIPO_DOC,
      w.SERIE,
      to_number(w.NUMDOC);
      
 
      update SIRE_COMPRAS_CONTRIBUY set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO
      AND id_entidad=7124
      and TIPOCOMP in('07','87')
      and TOTALCP>0
      and id_depto  in('3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_COPIAR_COMPRA_IMPRENTA;
    
    PROCEDURE SP_CREAR_COMPRAS_PRELIMINAR(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2,P_TIPO VARCHAR2, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
      l_id number:=0;
      l_corr number:=0;
    begin
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;
      
      select count(1) into l_contar from SIRE_COMPRAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO and ID_ESTADO_PREL_RVIE not in('00');
      
      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Primero elimine los registros anteriores del mes';
        goto salida;
      end if;
      
     select coalesce(max(ID_COMPRAS_PRELI),0) +1 into l_id from SIRE_COMPRAS_PRELI;
     
     if P_TIPO='R' then
      select coalesce(max(CORRELATIVO),0) + 1 into l_corr from SIRE_COMPRAS_PRELI
      where id_empresa=P_ID_EMPRESA
      and periodo=P_PERIODO;
     end if;
      
     INSERT INTO SIRE_COMPRAS_PRELI(
      ID_COMPRAS_PRELI,
      ID_EMPRESA,
      PERIODO,
      TIPO,
      TIPO_COMPRA,
      ID_ESTADO_PREL_RVIE,
      CORRELATIVO,
      ID_USER_REG,
      FECHA_REG
      )VALUES(
        l_id,
        P_ID_EMPRESA,
        P_PERIODO,
        P_TIPO,
        'CO',
        '01',
        l_corr,
        P_ID_USER,
        sysdate
      );
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI in(
        select ID_COMPRAS_PRELI from SIRE_COMPRAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO
      );
      
      if P_TIPO='P' then
        insert into SIRE_COMPRAS_PRELI_DET(
          ID_COMPRAS_PRELI_DET,
          ID_COMPRAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          ANHO,
          MES,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          BIGRAVADODG,
          IGVIPMDG,
          BIGRAVADODGNG,
          IGVIPMDGNG,
          BIGRAVADODNG,
          IGVIPMDNG,
          VALORADQNG,
          ISC,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          CODDAMODSI,
          NROCPMOD,
          CLASIFDEBSSYSSS,
          IDPROYOPERATRI,
          PORCPART,
          IMB,
          CARORIGINDEOI,
          DETRACCION,
          TIPODENOTA,
          ESTCOMP,
          INCAL,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        select 
        to_char(P_ID_EMPRESA)||PERIODO|| to_char((row_number() OVER( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
        l_id,
        (row_number() OVER( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden,
        'P',
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        ESTCOMP,
        INCAL,
        CARSUNAT,
        1,
        0,
        P_ID_USER,
        SYSDATE
        from SIRE_COMPRAS_SUNAT 
        where id_empresa=P_ID_EMPRESA 
        and periodo=P_PERIODO
        order by TIPOCOMP,SERIE,NRODOCINICIAL;
    else
      insert into SIRE_COMPRAS_PRELI_DET(
          ID_COMPRAS_PRELI_DET,
          ID_COMPRAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          ANHO,
          MES,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          BIGRAVADODG,
          IGVIPMDG,
          BIGRAVADODGNG,
          IGVIPMDGNG,
          BIGRAVADODNG,
          IGVIPMDNG,
          VALORADQNG,
          ISC,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          CODDAMODSI,
          NROCPMOD,
          CLASIFDEBSSYSSS,
          IDPROYOPERATRI,
          PORCPART,
          IMB,
          CARORIGINDEOI,
          DETRACCION,
          TIPODENOTA,
          ESTCOMP,
          INCAL,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        select 
        to_char(P_ID_EMPRESA)||PERIODO|| to_char((row_number() OVER( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
        l_id,
        (row_number() OVER( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden,
        'P',
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        ESTCOMP,
        INCAL,
        CARSUNAT,
        1,
        0,
        P_ID_USER,
        SYSDATE
        from SIRE_COMPRAS_SUNAT a
        where a.id_empresa=P_ID_EMPRESA 
        and a.periodo=P_PERIODO
        and a.CARSUNAT in(
          /*select w.CARSUNAT from SIRE_VENTAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
          and w.TIPODOC=a.TIPODOC
          and w.NRODOCUMENTO=a.NRODOCUMENTO
          and lower(w.RAZONSOCIAL)=lower(a.RAZONSOCIAL)
          union*/
          select w.CARSUNAT from SIRE_COMPRAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
          and coalesce(w.BIGRAVADODG,0)= coalesce(a.BIGRAVADODG,0)
          and coalesce(w.IGVIPMDG,0)= coalesce(a.IGVIPMDG,0)
          and coalesce(w.BIGRAVADODGNG,0)= coalesce(a.BIGRAVADODGNG,0)
          and coalesce(w.IGVIPMDGNG,0)= coalesce(a.IGVIPMDGNG,0)
          and coalesce(w.BIGRAVADODNG,0)= coalesce(a.BIGRAVADODNG,0)
          and coalesce(w.IGVIPMDNG,0)= coalesce(a.IGVIPMDNG,0)
          and coalesce(w.VALORADQNG,0)= coalesce(a.VALORADQNG,0)
          and coalesce(w.ISC,0)= coalesce(a.ISC,0)
          and coalesce(w.ICBPER,0)= coalesce(a.ICBPER,0)
          and coalesce(w.OTROSTRIBUTOS,0)= coalesce(a.OTROSTRIBUTOS,0)
          and coalesce(w.TOTALCP,0)= coalesce(a.TOTALCP,0)
        )
        order by a.TIPOCOMP,a.SERIE,a.NRODOCINICIAL;
        
        
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI in(
        select ID_COMPRAS_PRELI from SIRE_COMPRAS_PRELI where id_empresa=P_ID_EMPRESA and periodo=P_PERIODO
      );
      
      insert into SIRE_COMPRAS_PRELI_DET(
          ID_COMPRAS_PRELI_DET,
          ID_COMPRAS_PRELI,
          ORDEN,
          TIPO,
          FEMISION,
          FVCTOPAGO,
          TIPOCOMP,
          SERIE,
          ANHO,
          MES,
          NRODOCINICIAL,
          NRODOFINAL,
          TIPODOC,
          NRODOCUMENTO,
          RAZONSOCIAL,
          BIGRAVADODG,
          IGVIPMDG,
          BIGRAVADODGNG,
          IGVIPMDGNG,
          BIGRAVADODNG,
          IGVIPMDNG,
          VALORADQNG,
          ISC,
          ICBPER,
          OTROSTRIBUTOS,
          TOTALCP,
          MONEDA,
          TIPOCAMBIO,
          FEMISIONDOCMOD,
          TIPOCPMOD,
          SERIECPMOD,
          CODDAMODSI,
          NROCPMOD,
          CLASIFDEBSSYSSS,
          IDPROYOPERATRI,
          PORCPART,
          IMB,
          CARORIGINDEOI,
          DETRACCION,
          TIPODENOTA,
          ESTCOMP,
          INCAL,
          CARSUNAT,
          VIGENCIA,
          EDITADO,
          ID_USER_REG,
          FECHA_REG
        )
        select 
        to_char(P_ID_EMPRESA)||PERIODO|| to_char((row_number() OVER( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
        l_id,
        (row_number() OVER( ORDER BY ID_COMPRAS_SUNAT ASC )) + l_orden,
        'P',
        FEMISION,
        FVCTOPAGO,
        TIPOCOMP,
        SERIE,
        ANHO,
        MES,
        NRODOCINICIAL,
        NRODOFINAL,
        TIPODOC,
        NRODOCUMENTO,
        RAZONSOCIAL,
        BIGRAVADODG,
        IGVIPMDG,
        BIGRAVADODGNG,
        IGVIPMDGNG,
        BIGRAVADODNG,
        IGVIPMDNG,
        VALORADQNG,
        ISC,
        ICBPER,
        OTROSTRIBUTOS,
        TOTALCP,
        MONEDA,
        TIPOCAMBIO,
        FEMISIONDOCMOD,
        TIPOCPMOD,
        SERIECPMOD,
        CODDAMODSI,
        NROCPMOD,
        CLASIFDEBSSYSSS,
        IDPROYOPERATRI,
        PORCPART,
        IMB,
        CARORIGINDEOI,
        DETRACCION,
        TIPODENOTA,
        ESTCOMP,
        INCAL,
        CARSUNAT,
        1,
        0,
        P_ID_USER,
        SYSDATE
        from SIRE_COMPRAS_SUNAT a
        where a.id_empresa=P_ID_EMPRESA 
        and a.periodo=P_PERIODO
        and a.CARSUNAT not in(
          select w.CARSUNAT from SIRE_COMPRAS_CONTRIBUY w
          where w.id_empresa=P_ID_EMPRESA
          and w.periodo=P_PERIODO
        )
        order by a.TIPOCOMP,a.SERIE,a.NRODOCINICIAL;
      
    end if;
    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_CREAR_COMPRAS_PRELIMINAR;
    PROCEDURE SP_CREAR_COMPRAS_NODOM(P_ID_EMPRESA IN NUMBER,P_PERIODO VARCHAR2,P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
      l_id number:=0;
      l_corr number:=0;
    begin
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=P_ID_EMPRESA;
      
      select count(1) into l_contar from SIRE_COMPRAS_PRELI 
      where id_empresa=P_ID_EMPRESA 
      and periodo=P_PERIODO 
      and TIPO_COMPRA='ND'
      and ID_ESTADO_PREL_RVIE not in('00');
      
      if l_contar>0 then
        l_error:=1;
        l_msgerror:='Primero elimine los registros anteriores del mes';
        goto salida;
      end if;
      
     select coalesce(max(ID_COMPRAS_PRELI),0) +1 into l_id from SIRE_COMPRAS_PRELI;
     
     select coalesce(max(CORRELATIVO),0) + 1 into l_corr from SIRE_COMPRAS_PRELI
      where id_empresa=P_ID_EMPRESA
      and periodo=P_PERIODO;

      
     INSERT INTO SIRE_COMPRAS_PRELI(
      ID_COMPRAS_PRELI,
      ID_EMPRESA,
      PERIODO,
      TIPO,
      TIPO_COMPRA,
      ID_ESTADO_PREL_RVIE,
      CORRELATIVO,
      ID_USER_REG,
      FECHA_REG
      )VALUES(
        l_id,
        P_ID_EMPRESA,
        P_PERIODO,
        'ND',
        'ND',
        '01',
        l_corr,
        P_ID_USER,
        sysdate
      );

    <<salida>>
    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_CREAR_COMPRAS_NODOM;
    
    PROCEDURE SP_COPIAR_COMPRA_NODOM(P_ID_COMPRAS_PRELI NUMBER, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
      l_id_empresa number;
      l_periodo  varchar2(20);
      l_id_entidad number:=7124;
    begin
    
      select ID_EMPRESA, PERIODO into
      l_id_empresa,l_periodo
      from SIRE_COMPRAS_PRELI
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI; 

      
      select id_ruc into l_ruc from conta_empresa where id_empresa=l_id_empresa;
      
      delete from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in(
        select id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and id_depto not in('2','3');
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI;
      
      
      insert into SIRE_COMPRAS_PRELI_DET(
        ID_COMPRAS_PRELI_DET,
        ID_COMPRAS_PRELI,
        ID_ENTIDAD,
        ID_DEPTO,
        TIPO,
        ORDEN,
        CARSUNAT,	
        FEMISION,	
        TIPOCOMP,	
        SERIE,
        ANHO, 
        MES,
        NRODOCINICIAL,
        VALORADQNG,	
        NDCONCEPTO_ADIC,	
        TOTALCP,	
        NDTIPOCOMP,	
        NDSERIE,	
        NDANHO,	
        NDNRODOCINICIAL,	
        IGVIPMDNG,	
        MONEDA,	
        TIPOCAMBIO,	
        NDPAIS,	
        RAZONSOCIAL,	
        NDDOMICILIO,	
        NRODOCUMENTO,	
        NDNRODOCPAGO,	
        NDRAZONSOCIALPAGO,	
        NDPAISPAGO,	
        NDVINCULO,	
        BIGRAVADODG,	
        BIGRAVADODGNG,	
        BIGRAVADODNG,	
        IGVIPMDGNG,	
        IGVIPMDG,	
        NDDOBLETRIB,	
        NDEXOAPLI,	
        NDTIPORENTA,	
        NDMODERV,	
        NDAPLIRENTA,	
        CARORIGINDEOI,
        VIGENCIA,
        ID_USER_REG,
        FECHA_REG
      )
      select 
      DISTINCT
      'ND'||to_char(l_id_empresa)||to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0')|| to_char((row_number() OVER( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ID_COMPRAS_PRELI_DET,
      P_ID_COMPRAS_PRELI,
      a.id_entidad,
      A.ID_DEPTO,
      'C',
      ((row_number() OVER( ORDER BY a.ID_COMPRA ASC )) + l_orden) as ORDEN,
      B.ID_RUC ||a.ID_COMPROBANTE||a.SERIE||LPAD(to_char(a.NUMERO),20,'0') as CARSUNAT,
      a.FECHA_DOC,
      a.id_comprobante,
      a.SERIE,
      to_char(a.id_anho) as anho,
      LPAD(to_char(a.id_mes),2,'0') as mes,
      CASE WHEN LENGTH(TRIM(TRANSLATE(a.NUMERO, ' .0123456789', ' '))) IS NULL THEN to_char(to_number(a.NUMERO)) ELSE a.NUMERO end,
      coalesce(a.base,0) as VALORADQNG,
      0 as NDCONCEPTO_ADIC,
      coalesce(a.IMPORTE,0) as TOTALCP,
      '' as NDTIPOCOMP,	
      '' as NDSERIE,	
      '' as NDANHO,	
      '' as NDNRODOCINICIAL,
      0 as IGVIPMDNG,
      DECODE(A.ID_MONEDA,7,'PEN','USD') as MONEDA,
      coalesce(a.TIPOCAMBIO,0),
      tp.COD_SUNAT as NDPAIS,--pendiente
      b.NOMBRE as RAZONSOCIAL,
      '' as NDDOMICILIO,
      B.ID_RUC as NRODOCUMENTO,
      '' as NDNRODOCPAGO,	
      '' as NDRAZONSOCIALPAGO,	
      '' as NDPAISPAGO,	
      '' as NDVINCULO,
      0 as BIGRAVADODG,	
      0 as BIGRAVADODGNG,	
      0 as BIGRAVADODNG,	
      0 as IGVIPMDGNG,	
      0 as IGVIPMDG,
      '00' as NDDOBLETRIB, --00-ninguno
      '' as NDEXOAPLI,	
      '' as NDTIPORENTA,	
      '' as NDMODERV,	
      '' as NDAPLIRENTA,	
      '' as CARORIGINDEOI,
      1,
      P_ID_USER,
      SYSDATE
      from COMPRA a inner join MOISES.VW_PERSONA_NATURAL_LEGAL B on a.ID_PROVEEDOR = b.ID_PERSONA
      left join MOISES.PERSONA_JURIDICA pj on pj.ID_PERSONA=a.ID_PROVEEDOR
      left join MOISES.TIPO_PAIS tp on tp.ID_TIPOPAIS=pj.ID_TIPOPAIS
      LEFT JOIN COMPRA c ON (A.ID_PARENT = c.ID_COMPRA )
      where a.id_entidad in(
        select id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and to_char(a.id_anho)||LPAD(to_char(a.id_mes),2,'0')=l_periodo
      and a.estado='1'
      and a.id_comprobante  in('91','97','98')
      order by a.id_comprobante,
      a.SERIE,
      CASE WHEN LENGTH(TRIM(TRANSLATE(a.NUMERO, ' .0123456789', ' '))) IS NULL THEN to_char(to_number(a.NUMERO)) ELSE a.NUMERO end;
      --to_char(to_number(a.NUMERO));
      
      update SIRE_COMPRAS_PRELI_DET set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        NDCONCEPTO_ADIC=NDCONCEPTO_ADIC*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in(
        select id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and TIPOCOMP in('97')
      and TOTALCP>0
      and id_depto not in('2','3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_COPIAR_COMPRA_NODOM;
    
    PROCEDURE SP_COPIAR_COMPRA_NODOM_IMP(P_ID_COMPRAS_PRELI NUMBER, P_ID_USER NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
    is
      l_error number:=0;
      l_msgerror varchar2(200):='ok';
      l_contar number;
      l_ruc  varchar2(20);
      l_orden number;
      l_id_empresa number;
      l_periodo  varchar2(20);
      l_id_entidad number:=7124;
    begin
    
      select ID_EMPRESA, PERIODO into
      l_id_empresa,l_periodo
      from SIRE_COMPRAS_PRELI
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI; 
    
      select id_ruc into l_ruc from conta_empresa where id_empresa=l_id_empresa;
      
      delete from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in(
        select id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and id_depto  in('3');
      
      select coalesce(max(coalesce(orden,0)),0) into l_orden from SIRE_COMPRAS_PRELI_DET 
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI;
      
      
      insert into SIRE_COMPRAS_PRELI_DET(
        ID_COMPRAS_PRELI_DET,
        ID_COMPRAS_PRELI,
        ID_ENTIDAD,
        ID_DEPTO,
        TIPO,
        ORDEN,
        CARSUNAT,	
        FEMISION,	
        TIPOCOMP,	
        SERIE,
        ANHO, 
        MES,
        NRODOCINICIAL,
        VALORADQNG,	
        NDCONCEPTO_ADIC,	
        TOTALCP,	
        NDTIPOCOMP,	
        NDSERIE,	
        NDANHO,	
        NDNRODOCINICIAL,	
        IGVIPMDNG,	
        MONEDA,	
        TIPOCAMBIO,	
        NDPAIS,	
        RAZONSOCIAL,	
        NDDOMICILIO,	
        NRODOCUMENTO,	
        NDNRODOCPAGO,	
        NDRAZONSOCIALPAGO,	
        NDPAISPAGO,	
        NDVINCULO,	
        BIGRAVADODG,	
        BIGRAVADODGNG,	
        BIGRAVADODNG,	
        IGVIPMDGNG,	
        IGVIPMDG,	
        NDDOBLETRIB,	
        NDEXOAPLI,	
        NDTIPORENTA,	
        NDMODERV,	
        NDAPLIRENTA,	
        CARORIGINDEOI,
        VIGENCIA,
        ID_USER_REG,
        FECHA_REG
      )
      SELECT
        'ND'||to_char(l_id_empresa)||to_char(TO_CHAR(w.FECHA_PROV,'YYYY'))||LPAD(to_char(TO_CHAR(w.FECHA_PROV,'MM')),2,'0')|| to_char((row_number() OVER( ORDER BY w.id_mov_comp ASC )) + l_orden) as ID_VENTAS_CONTRIBUY,
        P_ID_COMPRAS_PRELI,
        7124 as id_entidad,
        '3' AS id_depto,
        'C',
        ((row_number() OVER( ORDER BY w.id_mov_comp ASC )) + l_orden) as ORDEN,
        w.RUC ||w.TIPO_DOC||w.SERIE||LPAD(w.NUMDOC,20,'0') as CARSUNAT,
        w.FECHA_DOC,
        w.TIPO_DOC,
        w.SERIE,
        TO_CHAR(w.FECHA_PROV,'YYYY'),        
        TO_CHAR(w.FECHA_PROV,'MM'),
        to_char(to_number(w.NUMDOC)) as NUMERO ,
        coalesce(w.BASEIMP1,0) as VALORADQNG,
        0 as NDCONCEPTO_ADIC,
        coalesce(w.IMPORTE,0) as TOTALCP,
        '' as NDTIPOCOMP,	
        '' as NDSERIE,	
        '' as NDANHO,	
        '' as NDNRODOCINICIAL,
        0 as IGVIPMDNG,
        w.MONEDA,
        coalesce(w.TIPO_CAMBIO,0),
        '' as NDPAIS,
        w.NOMBRE as RAZONSOCIAL,
        '' as NDDOMICILIO,
        w.RUC as NRODOCUMENTO,
        '' as NDNRODOCPAGO,	
        '' as NDRAZONSOCIALPAGO,	
        '' as NDPAISPAGO,	
        '' as NDVINCULO,
        0 as BIGRAVADODG,	
        0 as BIGRAVADODGNG,	
        0 as BIGRAVADODNG,	
        0 as IGVIPMDGNG,	
        0 as IGVIPMDG,
        '00' as NDDOBLETRIB, --00-ninguno
        '' as NDEXOAPLI,	
        '' as NDTIPORENTA,	
        '' as NDMODERV,	
        '' as NDAPLIRENTA,	
        '' as CARORIGINDEOI,
        1,
        P_ID_USER,
        SYSDATE        
      FROM(
        SELECT 
        A.FECHA_PROV,
        A.id_mov_comp,
        A.FECHA_DOC,
        A.TIPO_DOC, 
        A.SERIE,
        A.NUMDOC,
        B.RUC,
        B.NOMBRE,
        A.BASEIMP1,
        A.IGV1,
        A.BASEIMP5,
        A.IGV5,
        A.BASEIMP2,
        A.IGV2,
        NVL(A.BASEIMP3,A.BASEIMP4) AS INAFECTA,
        A.ICBPER,
        A.IMPORTE,
        DECODE(A.MONEDA,'00','PEN','USD') AS MONEDA,
        A.TIPO_CAMBIO,
        null as FEMISIONDOCMOD,
        '' as TIPOCPMOD,
        '' as  SERIECPMOD,
        '' as CODDAMODSI,
        '' as NROCPMOD,
        case when A.DETRAC= 'D' then  'D' else '' end  as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON A.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE A.ID_COMPRAS = '001-' ||SUBSTR(l_periodo,0,4)
        AND TO_CHAR(A.FECHA_PROV,'MM') = SUBSTR(l_periodo,5,2) 
        AND A.ESTADO = 'P'
        AND A.TIPO_DOC  in('91','97','98')          
        UNION ALL
        SELECT 
        X.FECHA_PROV,
        X.id_mov_not as id_mov_comp,
        X.FECHA_DOC,
        X.TIPO_DOC, 
        X.SERIE,
        X.NUMDOC,
        B.RUC,
        B.NOMBRE,
        (CASE X.TIPO_BI WHEN '1' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP1,
        (CASE X.TIPO_BI WHEN '1' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV1,
        (CASE X.TIPO_BI WHEN '5' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP5,
        (CASE X.TIPO_BI WHEN '5' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV5,
        (CASE X.TIPO_BI WHEN '2' THEN ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as BASEIMP2,
        (CASE X.TIPO_BI WHEN '2' THEN ABS(X.IMPORTE)-ROUND((X.IMPORTE/((A.VALOR_IGV/100)+1)),2) ELSE 0 END) as IGV2,
        (CASE X.TIPO_BI WHEN '4' THEN X.IMPORTE END) AS INAFECTA,
        A.ICBPER,
        X.IMPORTE,
        DECODE(X.MONEDA,'00','PEN','USD') AS MONEDA,
        A.TIPO_CAMBIO,
        A.FECHA_DOC as FEMISIONDOCMOD,
        A.TIPO_DOC as TIPOCPMOD,
        A.SERIE as  SERIECPMOD,
        '' as CODDAMODSI,
        A.NUMDOC as NROCPMOD,
        '' as DETRACCION
        FROM COMPRAS_REGISTRO@DBL_ARON_APP A JOIN COMPRAS_NOTAS@DBL_ARON_APP X ON A.ID_MOV_COMP = X.ID_MOV_COMP
        LEFT JOIN DATOS_PROVEEDOR@DBL_ARON_APP B ON X.ID_PROVEEDOR = B.ID_PROVEEDOR
        WHERE X.ID_COMPRAS = '001-' ||SUBSTR(l_periodo,0,4)
        AND TO_CHAR(X.FECHA_PROV,'MM') = SUBSTR(l_periodo,5,2) 
        and X.TIPO_DOC  in('91','97','98')   
      )w
      order by w.TIPO_DOC,
      w.SERIE,
      to_number(w.NUMDOC);
      
       update SIRE_COMPRAS_PRELI_DET set
        BIGRAVADODG=BIGRAVADODG*(-1),
        IGVIPMDG=IGVIPMDG*(-1),
        BIGRAVADODGNG=BIGRAVADODGNG*(-1),
        IGVIPMDGNG=IGVIPMDGNG*(-1),
        BIGRAVADODNG=BIGRAVADODNG*(-1),
        IGVIPMDNG=IGVIPMDNG*(-1),
        VALORADQNG=VALORADQNG*(-1),
        NDCONCEPTO_ADIC=NDCONCEPTO_ADIC*(-1),
        ISC=ISC*(-1),
        ICBPER=ICBPER*(-1),
        OTROSTRIBUTOS=OTROSTRIBUTOS*(-1),
        TOTALCP=TOTALCP*(-1)
      where ID_COMPRAS_PRELI=P_ID_COMPRAS_PRELI
      AND id_entidad in(
        select id_entidad from conta_entidad where id_empresa=l_id_empresa 
      )
      and TIPOCOMP in('97')
      and TOTALCP>0
      and id_depto  in('3');

    P_ERROR:=l_error;
    P_MSGERROR:= l_msgerror;
      
    END SP_COPIAR_COMPRA_NODOM_IMP;
    
END PKG_RVIE_RCE;