-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_saldos (id_empresa, id_entidad, id_anho, id_mes, id_depto, id_fondo, id_tipoplan, id_cuentaaasi, id_restriccion, id_ctacte, debe, haber, saldo) AS SELECT Entidad.ID_EMPRESA,
            Diario.ID_ENTIDAD,
            Diario.ID_ANHO,
            Diario.ID_MES,
            Diario_Detalle.ID_DEPTO,
            Diario_Detalle.ID_FONDO,
            Diario_Detalle.ID_TIPOPLAN,
            Diario_Detalle.ID_CUENTAAASI,
            Diario_Detalle.ID_RESTRICCION,
            Diario_Detalle.ID_CTACTE,
            SUM (
               CASE
                  WHEN Diario_Detalle.COS_VALOR > 0
                  THEN
                     ABS (utils.round_ (Diario_Detalle.COS_VALOR, 2))
                  ELSE
                     0
               END)
               DEBE,
            SUM (
               CASE
                  WHEN Diario_Detalle.COS_VALOR < 0
                  THEN
                     ABS (utils.round_ (Diario_Detalle.COS_VALOR, 2))
                  ELSE
                     0
               END)
               HABER,
              SUM (
                 CASE
                    WHEN Diario_Detalle.COS_VALOR > 0
                    THEN
                       ABS (utils.round_ (Diario_Detalle.COS_VALOR, 2))
                    ELSE
                       0
                 END)
            - SUM (
                 CASE
                    WHEN Diario_Detalle.COS_VALOR < 0
                    THEN
                       ABS (utils.round_ (Diario_Detalle.COS_VALOR, 2))
                    ELSE
                       0
                 END)
               SALDO
       FROM CONTA_ENTIDAD Entidad
            JOIN CONTA_DIARIO Diario ON Entidad.ID_ENTIDAD = Diario.ID_ENTIDAD
            JOIN CONTA_DIARIO_DETALLE Diario_Detalle
               ON     Diario.ID_ENTIDAD = Diario_Detalle.ID_ENTIDAD
                  AND Diario.ID_DIARIO = Diario_Detalle.ID_DIARIO
      WHERE     NOT Diario.ID_TIPOASIENTO LIKE 'EA%'
            AND NOT Diario.ID_TIPOASIENTO LIKE 'EB%'
            AND NOT Diario.ID_TIPOASIENTO LIKE 'AJ%'
   GROUP BY Entidad.ID_EMPRESA,
            Diario.ID_ENTIDAD,
            Diario.ID_ANHO,
            Diario.ID_MES,
            Diario_Detalle.ID_DEPTO,
            Diario_Detalle.ID_FONDO,
            Diario_Detalle.ID_TIPOPLAN,
            Diario_Detalle.ID_CUENTAAASI,
            Diario_Detalle.ID_RESTRICCION,
            Diario_Detalle.ID_CTACTE;

