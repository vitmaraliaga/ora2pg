-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_income_mov_col (id_entidad, id_depto, id_anho, id_mes, id_voucher, id_venta, id_articulo, id_cliente, id_sucursal, id_comprobante, id_moneda, id_mediopago, serie, numero, documento_venta, serie_mov, numero_mov, documento_mov, fecha, glosa, detalle, importe, importe_me, id_tipotransaccion, id_persona) AS SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          B.ID_ARTICULO,
          A.ID_CLIENTE,
          D.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.ID_MEDIOPAGO,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,   
          'Dep' as DOCUMENTO_MOV,
          A.FECHA,
          D.GLOSA,
          A.GLOSA,
          B.IMPORTE,
		  B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION,
          A.ID_PERSONA
     FROM CAJA_DEPOSITO A
        INNER JOIN CAJA_DEPOSITO_DETALLE B ON A.ID_DEPOSITO = B.ID_DEPOSITO
        INNER JOIN VENTA_SALDO C ON B.ID_VENTA = C.ID_VENTA AND A.ID_ANHO = C.ID_ANHO 
        INNER JOIN VENTA D ON B.ID_VENTA = D.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'
UNION ALL 
    SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          COALESCE (B.ID_ARTICULO, D.ID_ARTICULO ),
          --D.ID_ARTICULO,
          A.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          A.ID_MEDIOPAGO,
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          A.SERIE AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,   
          'Dep' as DOCUMENTO_MOV,
          A.FECHA,
          C.GLOSA,
          A.GLOSA,
          CASE WHEN B.ID_ARTICULO IS NULL THEN 
          CASE WHEN COALESCE(C.TOTAL,0) = 0 THEN 
          	0 ELSE 
          	(D.IMPORTE/C.TOTAL*B.IMPORTE)
          	END
          ELSE  
          	B.IMPORTE
          END ,
		  CASE WHEN B.ID_ARTICULO IS NULL THEN 
          CASE WHEN COALESCE(C.TOTAL_ME,0) = 0 THEN 
          	0 ELSE 
          	(D.IMPORTE_ME/C.TOTAL_ME*B.IMPORTE_ME)
          	END
          ELSE 
          	B.IMPORTE_ME
          END,
          A.ID_TIPOTRANSACCION,
          A.ID_PERSONA
     FROM CAJA_DEPOSITO A
        INNER JOIN CAJA_DEPOSITO_DETALLE B ON A.ID_DEPOSITO = B.ID_DEPOSITO
        INNER JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA
        INNER JOIN VENTA_DETALLE D ON D.ID_VENTA = C.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
    WHERE A.ESTADO = '1'
    AND COALESCE (B.ID_ARTICULO, D.ID_ARTICULO ) = D.ID_ARTICULO  
    AND NOT EXISTS (SELECT x.ID_VENTA FROM VENTA_SALDO x WHERE x.ID_ENTIDAD= A.ID_ENTIDAD AND x.ID_ANHO=A.ID_ANHO AND x.ID_VENTA = B.ID_VENTA) 
    /*
        UNION ALL 
        SELECT A.ID_ENTIDAD,
          A.ID_DEPTO,
          A.ID_ANHO,
          A.ID_MES,
          A.id_voucher,
          C.ID_VENTA,
          B.ID_ARTICULO,
          B.ID_CLIENTE,
          C.ID_SUCURSAL,
          C.ID_COMPROBANTE,
          A.ID_MONEDA,
          'Dev',
          C.SERIE,
          C.NUMERO,
          T.NOMBRE_CORTO AS DOCUMENTO_VENTA,
          '' AS SERIE_MOV,
          A.NUMERO AS NUMERO_MOV,
          'Dev.' AS DOCUMENTO_MOV,
          A.FECHA,
          C.GLOSA,
          B.DETALLE,
          B.IMPORTE*-1,
          B.IMPORTE_ME,
          A.ID_TIPOTRANSACCION,
          A.ID_USER AS ID_USUARIO
     FROM CAJA_PAGO A
        INNER JOIN CAJA_PAGO_VENTA B ON A.ID_PAGO = B.ID_PAGO
        INNER JOIN VENTA C ON B.ID_VENTA = C.ID_VENTA
        LEFT OUTER JOIN TIPO_COMPROBANTE T ON T.ID_COMPROBANTE = C.ID_COMPROBANTE
     WHERE A.ESTADO = '1'
     */
 ;

