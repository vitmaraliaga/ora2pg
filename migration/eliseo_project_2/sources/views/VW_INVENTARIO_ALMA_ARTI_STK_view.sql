-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_inventario_alma_arti_stk (id_almacen, id_articulo, id_anho, stock_actual) AS SELECT z.ID_ALMACEN,
  		 z.ID_ARTICULO,
         z.ID_ANHO,
         sum (z.STOCK_ACTUAL) AS stock_actual
 FROM (SELECT A.ID_ALMACEN,
  		 A.ID_ARTICULO,
         A.ID_ANHO,
         A.STOCK_ACTUAL
       FROM INVENTARIO_ALMACEN_ARTICULO A
       WHERE A.ESTADO = '1'
   UNION ALL
   SELECT b.id_almacen, A.id_articulo, b.id_anho, 
   COALESCE(A.cantidad, 0)*-1 AS stock_actual
   FROM coti_cotizacion_detalle a
   INNER JOIN coti_cotizacion b ON b.id_cotizacion = A.id_cotizacion
   --INNER JOIN eliseo.process_paso c ON c.ID_PASO = b.ID_PASO_ACTUAL AND c.ORDEN = 4 
   WHERE b.tipo_cotizacion = 'P' AND b.estado = '1' AND b.es_aprobado = 'S'
   AND NOT EXISTS (SELECT 1 FROM eliseo.venta d WHERE d.id_venta =  b.id_venta 
   AND d.estado = 1 AND d.glosa != '<< Anulado>>')
   AND SYSDATE BETWEEN b.FECHA AND b.FECHA + COALESCE(b.VALIDEZ, 0) 
   ) z 
   GROUP BY z.ID_ALMACEN,
  		 z.ID_ARTICULO,
         z.ID_ANHO;

COMMENT ON VIEW vw_inventario_alma_arti_stk  IS E'Vista para el control de stock (stock_actual - stock_reservado); ello nos mostrara el nuevo stock_actual.';

