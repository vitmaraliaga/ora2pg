-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE VIEW vw_colp_ventas_credito_dep (id_venta, id_almacen, id_entidad, id_depto, id_campanha, id_anho, id_voucher, id_cliente, id_comprobante, serie, numero, nro_comprobante, glosa, fecha, total_venta, diezmo, total_libros, amortizado, anulado, pagado) AS SELECT
	lista.ID_VENTA,
	lista.ID_ALMACEN,
	lista.ID_ENTIDAD,
	lista.ID_DEPTO,
	lista.ID_CAMPANHA,
	lista.ID_ANHO,
	lista.ID_VOUCHER,
	lista.ID_CLIENTE,
	lista.ID_COMPROBANTE,
	lista.SERIE,
	lista.NUMERO,
	lista.NRO_COMPROBANTE,
	lista.GLOSA,
	lista.FECHA,
	lista.TOTAL_VENTA,
	lista.DIEZMO,
	lista.TOTAL_LIBROS,
	lista.AMORTIZADO,
	lista.ANULADO,
	(CASE WHEN lista.ANULADO != 'OK' AND ROUND(lista.TOTAL_VENTA,2) = ROUND(lista.AMORTIZADO) THEN '1' ELSE '0' END) AS PAGADO
FROM
	(
		SELECT
			V.ID_VENTA,
			IA.ID_ALMACEN,
			V.ID_ENTIDAD,
			V.ID_DEPTO,
			V.ID_ANHO,
			V.ID_VOUCHER,
			V.ID_CLIENTE,
			V.ID_COMPROBANTE,
			V.SERIE,
			V.NUMERO,
			TC.NOMBRE_CORTO || ' ' || V.SERIE || ' - ' || V.NUMERO AS NRO_COMPROBANTE,
			V.GLOSA,
			V.FECHA,
			V.TOTAL AS TOTAL_VENTA,
			V.TOTAL * (0.1) AS DIEZMO,
			(
				SELECT SUM(CANTIDAD) FROM VENTA_DETALLE WHERE ID_VENTA = V.ID_VENTA
			) AS TOTAL_LIBROS,
			(
				SELECT ID_CAMPANHA FROM COLP_VENTA WHERE ID_VENTA = V.ID_VENTA
			) AS ID_CAMPANHA,
			(
				SELECT NVL (SUM(CDD.IMPORTE), 0)
				FROM CAJA_DEPOSITO_DETALLE CDD
				INNER JOIN CAJA_DEPOSITO CD ON CDD.ID_DEPOSITO = CD.ID_DEPOSITO
				WHERE CDD.ID_VENTA = V.ID_VENTA AND CD.IMPORTE <> 0
			) AS AMORTIZADO,
			NVL((SELECT DECODE(X.ESTADO,'1','S','2','OK','N') 
				FROM ARREGLO X 
				WHERE X.ID_ENTIDAD = V.ID_ENTIDAD AND X.ID_DEPTO = V.ID_DEPTO 
					AND X.ID_ORIGEN = V.ID_VENTA AND X.ID_TIPOORIGEN = 1 GROUP BY X.ESTADO),'N') AS ANULADO
		FROM
			VENTA V
		INNER JOIN TIPO_COMPROBANTE TC ON TC.ID_COMPROBANTE = V.ID_COMPROBANTE
		INNER JOIN INVENTARIO_ALMACEN IA ON IA.ID_DEPTO = V.ID_DEPTO
		WHERE
			V.ID_CREDITO = 2
		AND V.ID_ENTIDAD = 17114
		AND V.ESTADO = '1'
	) lista;

