-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

function        FC_OBT_RESP_ENTIDAD_DEPTO(P_ID_ENTIDAD NUMBER, P_ID_DEPTO VARCHAR2, P_ID_MES NUMBER, P_ID_ANHO NUMBER) RETURN VARCHAR2
IS
l_dato VARCHAR2(200);
l_contar int:=0;
l_id_virtual number;
l_date_ number;
l_fec_inicio DATE; 
l_id_persona number;
BEGIN

  	SELECT P_ID_ANHO ||''|| LPAD(P_ID_MES,2,0) INTO l_date_  FROM DUAL;
  
  	SELECT COUNT(ID_PERSONA) INTO l_contar
	FROM CONTA_ENTIDAD_DEPTO_RESP WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND  TO_CHAR(FEC_INICIO, 'YYYYMM') <= l_date_ AND (TO_CHAR(FEC_TERMINO, 'YYYYMM') >= l_date_ OR FEC_TERMINO IS NULL);
	IF l_contar > 0 THEN
		IF l_contar = 1 THEN
		
			SELECT ID_PERSONA INTO l_id_persona FROM CONTA_ENTIDAD_DEPTO_RESP  WHERE ID_ENTIDAD = P_ID_ENTIDAD 
					AND ID_DEPTO = P_ID_DEPTO AND TO_CHAR(FEC_INICIO, 'YYYYMM') <= l_date_ AND (TO_CHAR(FEC_TERMINO, 'YYYYMM') >= l_date_ OR FEC_TERMINO IS NULL);
			SELECT P.PATERNO ||''|| P.MATERNO ||','|| P.NOMBRE INTO l_dato FROM MOISES.PERSONA P 
			WHERE P.ID_PERSONA = l_id_persona;
		ELSE
			SELECT MAX(FEC_INICIO) INTO l_fec_inicio  FROM CONTA_ENTIDAD_DEPTO_RESP WHERE ID_ENTIDAD = P_ID_ENTIDAD 
			AND ID_DEPTO = P_ID_DEPTO AND TO_CHAR(FEC_INICIO, 'YYYYMM') <= l_date_ AND (TO_CHAR(FEC_TERMINO, 'YYYYMM') >= l_date_ OR FEC_TERMINO IS NULL);
		
			SELECT P.PATERNO ||''|| P.MATERNO ||','|| P.NOMBRE  INTO l_dato FROM MOISES.PERSONA  P
			WHERE P.ID_PERSONA = (SELECT ID_PERSONA FROM CONTA_ENTIDAD_DEPTO_RESP WHERE ID_ENTIDAD = P_ID_ENTIDAD AND ID_DEPTO = P_ID_DEPTO AND FEC_INICIO = l_fec_inicio);
		END IF;
	ELSE
		l_dato	:='Sin administrador';
	END IF;

	RETURN(l_dato);
END;

