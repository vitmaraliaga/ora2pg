-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

FUNCTION FC_IMPRIMIR(P_ID_PERSONA in INT )
RETURN varchar2 IS

	   t_texto 	varchar2(300);
	   texto1	varchar2(4000);
	   texto2	varchar2(4000);
	   num_filas number(3);
	   t_fila	number(3);
	   contador number(3);

	   -- extrae datos
	   cursor datos is
       SELECT
	   		 texto
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA
	   ORDER BY FILA;

	   -- indica maximo de filas
	   cursor filas is
       SELECT
	   		 max(fila)
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA;

	   -- verifica existencia de fila
	   cursor verfila is
	   SELECT
	   		 fila
	   FROM CONTA_DOCUMENTO_TEMPORAL
	   WHERE ID_PERSONA = P_ID_PERSONA
	   AND FILA = contador;

BEGIN
     texto1 := '';
	 texto2 := '';
	 t_fila := 0;

	 open filas;
	 fetch filas into num_filas;
	 close filas;

	 -- ingresa filas vacias
	 contador := 1;
	 while contador<=num_filas loop
	 	   open verfila;
		   fetch verfila into t_fila;
		   if not verfila%found then
		   	  INSERT INTO CONTA_DOCUMENTO_TEMPORAL values ( P_ID_PERSONA, contador, ' ');
		   end if;
		   close verfila;
		   contador := contador + 1;
	 end loop;

	 -- descarga los datos
	 open datos;
	 fetch datos into t_texto;
	 while datos%found loop
	 	   if length(texto1||rtrim(t_texto)||'~')<4000 then
		   		   texto1 := texto1||rtrim(t_texto)||'~';
		   else
		   		   texto2 := texto2||rtrim(t_texto)||'~';
		   end if;
		   fetch datos into t_texto;
	 end loop;
	 close datos;

	RETURN ( texto1 );
END;

