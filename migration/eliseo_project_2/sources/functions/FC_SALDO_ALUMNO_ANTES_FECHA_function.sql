-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

FUNCTION               FC_SALDO_ALUMNO_ANTES_FECHA(P_ID_PERSONA INTEGER, P_FECHA VARCHAR2,P_ID_DEPTO VARCHAR2)
    RETURN NUMBER IS
    SALDO	  NUMBER(10,2);		

    BEGIN

        select  sum(z.importe) into SALDO


        from
        (
        select  '02' orden,
                c.id_depto,
                c.id_deposito  id_documento,   
                c.id_cliente id_cliente,        
                --eliseo.fc_codigo_alumno(c.id_cliente) codigo,
                'DEPOSITO' TIPO_MOV,
                --eliseo.FC_NOMBRE_PERSONA(c.id_cliente) estudiante,
                to_char(c.fecha,'dd/mm/yyyy') fecha,
                to_char(c.fecha,'yyyy mm') mes,
                c.serie||'-'||c.numero documento,
                c.glosa,
                c.importe*(-1) importe

        from ELISEO.caja_deposito c
        where c.id_entidad = 7124
          and c.id_anho = substr(P_FECHA,1,4) 
          and c.id_depto = P_ID_DEPTO
          AND c.ID_CLIENTE = P_ID_PERSONA
          and c.id_tipodeposito in (1,2,3)
          and c.id_vale is null
          and c.importe <> 0
          and c.estado = 1
          and to_char(nvl(c.fecha_operacion, c.fecha), 'yyyymmddhh24mi') <= P_FECHA  --MODIFICAR FECHA
          --and to_char(c.fecha, 'yyyymmdd') <= '20230628'  --MODIFICAR FECHA
        union all

        select  '02' orden,
                c.id_depto,
                c.id_pago  id_documento,   
                cpg.id_cliente id_cliente,
                --eliseo.fc_codigo_alumno(cpg.id_cliente) codigo,
                'DEPOSITO' TIPO_MOV,
                --eliseo.FC_NOMBRE_PERSONA(cpg.id_cliente) estudiante,
                to_char(c.fecha,'dd/mm/yyyy') fecha,
                to_char(c.fecha,'yyyy mm') mes,
                c.numero documento,
                cpg.detalle glosa,
                cpg.importe importe

        from ELISEO.caja_pago c, eliseo.caja_pago_venta cpg
        where c.id_entidad = 7124
          and c.id_anho = substr(P_FECHA,1,4) 
          and c.id_depto = P_ID_DEPTO
          and c.id_pago = cpg.id_pago
          AND cpg.ID_CLIENTE = P_ID_PERSONA
          and cpg.importe <> 0
          and c.estado = 1
          and to_char(c.fecha, 'yyyymmddhh24mi') <= P_FECHA  --MODIFICAR FECHA
        union all

        select  '01' orden,
                v.id_depto,
                v.id_venta  id_documento,   
                v.id_cliente id_cliente,
                --eliseo.fc_codigo_alumno(v.id_cliente) codigo,
                'COBRANZA' TIPO_MOV,
                --eliseo.FC_NOMBRE_PERSONA(v.id_cliente) estudiante,
                to_char(v.fecha,'dd/mm/yyyy') fecha,
                to_char(v.fecha,'yyyy mm') mes,
                v.serie||'-'||v.numero documento,
                v.glosa,
                v.total*decode(v.id_comprobante,'07',-1,1) importe

        from ELISEO.venta v
        where v.id_entidad = 7124
          and v.id_anho = substr(P_FECHA,1,4) 
          and v.id_depto = P_ID_DEPTO
          AND v.ID_CLIENTE = P_ID_PERSONA
          and v.id_tipoventa not in (5,6)
          and v.total <> 0
          and v.estado = 1
          and to_char(v.fecha, 'yyyymmddhh24mi') <= P_FECHA  --MODIFICAR FECHA
        union all

        select  '01' orden,
                vt.id_depto,
                vt.id_transferencia  ,   
                vt.id_cliente,
                --eliseo.fc_codigo_alumno(id_cliente) codigo,
                'COBRANZA' TIPO_MOV,
                --eliseo.FC_NOMBRE_PERSONA(id_cliente) estudiante,
                to_char(vt.fecha,'dd/mm/yyyy') fecha,
                to_char(vt.fecha,'yyyy mm') mes,
                vt.serie||'-'||vt.numero documento,
                vtd.detalle,
                sum(vtd.importe*decode(vtd.DC, 'D', 1, -1)) importe

        from ELISEO.venta_transferencia vt, eliseo.venta_transferencia_detalle vtd
        where vt.id_transferencia = vtd.id_transferencia
          and vt.id_entidad = 7124
          and vt.id_anho = substr(P_FECHA,1,4) 
          and vt.id_depto = P_ID_DEPTO
          AND vt.ID_CLIENTE = P_ID_PERSONA
          --and vt.serie = 'T600'
          and nvl(vt.id_tipotransaccion, 0) not in (173,174,177)
          and vt.importe <> 0
          and vt.estado = 1
          and to_char(vt.fecha, 'yyyymmddhh24mi') <= P_FECHA  --MODIFICAR FECHA
        group by vt.id_depto,
                vt.id_transferencia  ,   
                vt.id_cliente,
                --eliseo.fc_codigo_alumno(id_cliente) ,
                'COBRANZA',
                --eliseo.FC_NOMBRE_PERSONA(id_cliente) ,
                to_char(vt.fecha,'dd/mm/yyyy') ,
                to_char(vt.fecha,'yyyy mm') ,
                vt.serie||'-'||vt.numero ,
                vtd.detalle

        union all

        select  '00' orden,
                vs.id_depto,
                vs.id_venta,   
                vs.id_cliente,
                --eliseo.fc_codigo_alumno(vs.id_cliente) codigo,
                'SALDO ANTERIOR' TIPO_MOV,
                --eliseo.FC_NOMBRE_PERSONA(vs.id_cliente) estudiante,
                to_char(vs.fecha,'dd/mm/yyyy') fecha,
                --to_char(vs.fecha,'yyyy mm') mes,
                vs.id_anho||' '||lpad(id_mes, 2, '0') mes,
                vs.serie||'-'||vs.numero documento,
                vs.detalle glosa,
                vs.total

        from ELISEO.venta_saldo vs
        where vs.id_entidad = 7124
          and vs.id_anho = substr(P_FECHA,1,4) 
          and vs.id_depto = P_ID_DEPTO
          AND vs.ID_CLIENTE = P_ID_PERSONA
          and vs.total <> 0


        order by 4, 1, 6 asc

        ) z

        where z.id_depto = P_ID_DEPTO
        ;

        RETURN SALDO;

END;

