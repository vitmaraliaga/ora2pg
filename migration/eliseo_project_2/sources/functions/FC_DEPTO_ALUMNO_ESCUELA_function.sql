-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

FUNCTION        FC_DEPTO_ALUMNO_ESCUELA(P_ID_CLIENTE NUMBER, P_ID_DEPTO VARCHAR) RETURN VARCHAR2 AS
  l_depto VARCHAR2(10);
  l_contar number;
  l_id_sedearea number;
BEGIN

  select count(1) into l_contar
  FROM DAVID.VW_ALUMNO_PLAN_PROGRAMA A
  WHERE A.ID_PERSONA = P_ID_CLIENTE  
    AND A.ID_SEDE = DECODE(P_ID_DEPTO, '1', 1, '5', 2, '6', 3, '8', 4)

  ;

  if l_contar > 0 then

    SELECT X.ID_SEDEAREA INTO l_id_sedearea
    FROM (
        SELECT ID_SEDEAREA 
        FROM DAVID.VW_ALUMNO_PLAN_PROGRAMA
        WHERE ID_PERSONA = P_ID_CLIENTE
          AND ID_SEDE = DECODE(P_ID_DEPTO, '1', 1, '5', 2, '6', 3, '8', 4)
        ORDER BY ESTADO DESC, ID_NIVEL_ENSENANZA ASC, NOMBRE_PLAN DESC
        ) X
    WHERE ROWNUM = 1
    ;

    SELECT NVL(ID_DEPTO_GENERAL,ID_DEPTO) INTO l_depto
    FROM ORG_SEDE_AREA
    WHERE ID_SEDEAREA = l_id_sedearea
    ;

  else

    l_depto := P_ID_DEPTO||'1010101';

  end if;

  return l_depto;

END;

