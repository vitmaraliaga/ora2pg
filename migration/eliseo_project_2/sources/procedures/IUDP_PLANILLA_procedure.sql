-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        iudp_Planilla(
    v_Modo               IN NUMBER,
    v_ID_ENTIDAD         IN NUMBER,
    v_ID_ANHO            IN NUMBER,
    v_ID_MES             IN NUMBER,
    v_ID_CONTRATO        IN NUMBER DEFAULT NULL ,
    v_ID_DEPARTAMENTO    IN VARCHAR2 DEFAULT NULL ,
    v_COD_TIPOSTATUS     IN VARCHAR2 DEFAULT NULL ,
    iv_ID_SISTEMAPENSION IN NUMBER DEFAULT NULL ,
    v_ES_MISIONERO       IN NUMBER DEFAULT NULL ,
    v_ES_CONFIANZA       IN NUMBER DEFAULT NULL ,
    v_NUM_DIAS           IN NUMBER DEFAULT NULL ,
    v_NUM_HORAS          IN NUMBER DEFAULT NULL ,
    v_NUM_HORASEXTRA     IN NUMBER DEFAULT NULL ,
    v_NUM_DIASVAC        IN NUMBER DEFAULT NULL ,
    v_NOM_CARGO          IN VARCHAR2 DEFAULT NULL ,
    v_FMR                IN NUMBER DEFAULT NULL,
    v_ID_CARGO           IN NUMBER DEFAULT NULL)
AS
  v_ID_SISTEMAPENSION NUMBER(10,0) := iv_ID_SISTEMAPENSION;
   l_contar number;
BEGIN
  IF v_Modo = 1 THEN
    BEGIN
      DELETE Aps_Planilla_Detalle
      WHERE ID_ENTIDAD = v_ID_ENTIDAD
      AND ID_ANHO      = v_ID_ANHO
      AND v_ID_MES    IN ( -1,ID_MES ) ;
      
      --DELETE Aps_Planilla
      --WHERE ID_ENTIDAD = v_ID_ENTIDAD
      --AND ID_ANHO      = v_ID_ANHO
      --AND v_ID_MES    IN ( -1,ID_MES ) ;
      
    END;
  ELSE
    DECLARE
      v_ID_PERSONA     NUMBER(10,0) := 0;
      v_ID_TIPOESTATUS NUMBER(10,0);
    BEGIN
      SELECT MAX(ID_PERSONA)
      INTO v_ID_PERSONA
      FROM Aps_Empleado
      WHERE ID_ENTIDAD = v_ID_ENTIDAD
      AND ID_CONTRATO  = v_ID_CONTRATO;
      
      IF v_ID_PERSONA  > 0 THEN
        DECLARE
          v_temp NUMBER(1, 0) := 0;
        BEGIN
          SELECT max(ID_TIPOESTATUS)
          INTO v_ID_TIPOESTATUS
          FROM Tipo_Estatus
          WHERE SIGLAS = v_COD_TIPOSTATUS;
          
          SELECT nvl(max(ID_SISTEMAPENSION),0)
          INTO v_ID_SISTEMAPENSION
          FROM Aps_Sistema_Pension
          WHERE COD_APS = v_ID_SISTEMAPENSION;
          BEGIN
            SELECT 1
            INTO v_temp
            FROM DUAL
            WHERE NOT EXISTS
              (SELECT ID_PERSONA
              FROM Aps_Planilla
              WHERE ID_ENTIDAD = v_ID_ENTIDAD
              AND ID_ANHO      = v_ID_ANHO
              AND ID_MES       = v_ID_MES
              AND ID_PERSONA   = v_ID_PERSONA
              AND ID_CONTRATO  = v_ID_CONTRATO
              AND ROWNUM      <= 1
              );
          EXCEPTION
          WHEN OTHERS THEN
            NULL;
          END;
          IF v_temp = 1 THEN
            INSERT
            INTO Aps_Planilla
              (
                ID_ENTIDAD,
                ID_ANHO,
                ID_MES,
                ID_PERSONA,
                ID_CONTRATO,
                ID_DEPTO,
                ID_TIPOESTATUS,
                ID_SISTEMAPENSION,
                ES_MISIONERO,
                ES_CONFIANZA,
                NUM_DIAS,
                NUM_HORAS,
                NUM_HORASEXTRA,
                NUM_DIASVAC,
                NOM_CARGO,
                FMR,
                ID_CARGO
              )
              VALUES
              (
                v_ID_ENTIDAD,
                v_ID_ANHO,
                v_ID_MES,
                v_ID_PERSONA,
                v_ID_CONTRATO,
                v_ID_DEPARTAMENTO,
                v_ID_TIPOESTATUS,
                NULLIF(v_ID_SISTEMAPENSION, 0),
                v_ES_MISIONERO,
                v_ES_CONFIANZA,
                v_NUM_DIAS,
                v_NUM_HORAS,
                v_NUM_HORASEXTRA,
                v_NUM_DIASVAC,
                v_NOM_CARGO,
                v_FMR,
                v_ID_CARGO
              );
          ELSE
            UPDATE Aps_Planilla
            SET ID_DEPTO = v_ID_DEPARTAMENTO,
              ID_TIPOESTATUS    = v_ID_TIPOESTATUS,
              ID_SISTEMAPENSION = NULLIF(v_ID_SISTEMAPENSION, 0),
              ES_MISIONERO      = NVL(v_ES_MISIONERO, 0),
              ES_CONFIANZA      = NVL(v_ES_CONFIANZA, 0),
              NUM_DIAS          = NVL(NULLIF(v_NUM_DIAS, 0), NUM_DIAS),
              NUM_HORAS         = NVL(NULLIF(v_NUM_HORAS, 0), NUM_HORAS),
              NUM_HORASEXTRA    = NVL(NULLIF(v_NUM_HORASEXTRA, 0), NUM_HORASEXTRA),
              NUM_DIASVAC       = NVL(NULLIF(v_NUM_DIASVAC, 0), NUM_DIASVAC),
              NOM_CARGO         = NVL(NULLIF(v_NOM_CARGO, ' '), NOM_CARGO),
              FMR               = v_FMR,
              ID_CARGO          = v_ID_CARGO
            WHERE ID_ENTIDAD    = v_ID_ENTIDAD
            AND ID_ANHO         = v_ID_ANHO
            AND ID_MES          = v_ID_MES
            AND ID_PERSONA      = v_ID_PERSONA
            AND ID_CONTRATO     = v_ID_CONTRATO;
          END IF;
          
          select count(*) into l_contar from aps_cargo where id_cargo=v_ID_CARGO;
          if l_contar=0 then
            insert into aps_cargo(id_cargo,nombre,estado) values(v_ID_CARGO,v_NOM_CARGO,'1');
          else
            update aps_cargo set nombre = v_NOM_CARGO, estado = '1' where id_cargo = v_ID_CARGO;
          end if;
            update aps_trabajador set id_cargo=v_ID_CARGO where id_persona=v_ID_PERSONA;
        END;
      END IF;
    END;
  END IF;
END;

