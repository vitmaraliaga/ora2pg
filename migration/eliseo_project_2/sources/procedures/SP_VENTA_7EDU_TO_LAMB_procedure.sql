-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        SP_VENTA_7EDU_TO_LAMB
IS
    L_CANT NUMBER;
   	L_ID_CLIENTE_NEW NUMBER:= null;
   	L_ID_CLIENTE_LEGAL_NEW NUMBER:= null;
   	L_NO_EXISTE_PERSONA NUMBER;
   	L_ID_VOUCHER NUMBER;
   	L_ID_VENTA_NEW NUMBER;
   	L_ACTIVO VARCHAR2(1):='S';
   	L_NUM_DOCUMENTO VARCHAR(20):= NULL;
   	L_ID_RUC VARCHAR(20):= NULL;
   	L_NOMBRE VARCHAR(200):= NULL;
   	L_PATERNO VARCHAR(200):= NULL;
   	L_MATERNO VARCHAR(200):= NULL;

    CURSOR VENTAS IS	
    SELECT * FROM ELISEO.VENTA_TO_LAMB WHERE ID_VENTA_LAMB IS null ;

    BEGIN
        FOR venta_item IN VENTAS
		LOOP
			--Validar si existe la venta

			L_CANT := 0;
			dbms_output.put_line('List '||venta_item.id_venta||' row');
			IF L_CANT = 0 THEN 
				L_NO_EXISTE_PERSONA := 0;
				SELECT COUNT(1) INTO L_CANT FROM moises.PERSONA_DOCUMENTO pd 
				WHERE num_documento = venta_item.num_documento_cliente;
				IF L_CANT > 0 THEN 
					SELECT ID_PERSONA INTO L_ID_CLIENTE_NEW FROM moises.PERSONA_DOCUMENTO pd 
					WHERE num_documento = venta_item.num_documento_cliente AND rownum = 1;
				ELSE 
					SELECT COUNT(1) INTO L_CANT FROM moises.PERSONA_NATURAL pd 
					WHERE num_documento = venta_item.num_documento_cliente;
					IF L_CANT > 0 THEN 
						SELECT ID_PERSONA INTO L_ID_CLIENTE_NEW FROM moises.PERSONA_NATURAL pd 
						WHERE num_documento = venta_item.num_documento_cliente AND rownum = 1;
						UPDATE ELISEO.VENTA_TO_LAMB SET NO_EXISTE_CLIENTE = 0 WHERE ID_VENTA = venta_item.ID_VENTA;
					ELSE 
						SELECT COUNT(1) INTO L_CANT FROM moises.PERSONA_JURIDICA pd 
						WHERE id_ruc = venta_item.num_documento_cliente;
						IF L_CANT > 0 THEN 
							SELECT ID_PERSONA INTO L_ID_CLIENTE_NEW FROM moises.PERSONA_JURIDICA pd 
							WHERE id_ruc = venta_item.num_documento_cliente AND rownum = 1;
							UPDATE ELISEO.VENTA_TO_LAMB SET NO_EXISTE_CLIENTE = 0 WHERE ID_VENTA = venta_item.ID_VENTA;
						ELSE 
							--L_NO_EXISTE_PERSONA := 1;

							--UPDATE ELISEO.VENTA_TO_LAMB SET NO_EXISTE_CLIENTE = 1 WHERE ID_VENTA = venta_item.ID_VENTA;

							SELECT COUNT(1) INTO L_CANT FROM eliseo.venta_persona_to_lamb pd 
							WHERE id_persona = venta_item.id_cliente;
							IF L_CANT > 0 THEN 
								SELECT nombre,paterno,materno,num_documento,id_ruc INTO L_NOMBRE,L_PATERNO,L_MATERNO,L_NUM_DOCUMENTO,L_ID_RUC 
								FROM eliseo.venta_persona_to_lamb pd 
								WHERE id_persona = venta_item.id_cliente AND rownum =1;
								IF L_NUM_DOCUMENTO IS NOT NULL THEN 
								SELECT MAX(id_persona) +1 INTO L_ID_CLIENTE_NEW FROM moises.persona; 
									INSERT INTO moises.persona (id_persona,nombre,paterno,materno) 
									VALUES (L_ID_CLIENTE_NEW,L_NOMBRE,L_PATERNO,L_MATERNO);
									INSERT INTO moises.persona_natural
									(id_persona,id_tipopais,id_tiporeligion,id_tipodocumento,num_documento,sexo,celular,fec_nacimiento,correo)
									SELECT L_ID_CLIENTE_NEW AS id_persona,id_tipopais,id_tiporeligion,id_tipodocumento,num_documento,sexo,celular,fec_nacimiento,correo
									FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente;
									INSERT INTO moises.persona_documento
									(id_persona,id_tipodocumento,num_documento,es_activo)
									SELECT L_ID_CLIENTE_NEW AS id_persona,id_tipodocumento,num_documento,1
									FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente;
								ELSIF L_ID_RUC IS NOT NULL THEN 
									SELECT MAX(id_persona) +1 INTO L_ID_CLIENTE_NEW FROM moises.persona;
									INSERT INTO moises.persona (id_persona,nombre,paterno,materno) 
									VALUES (L_ID_CLIENTE_NEW,L_NOMBRE,L_PATERNO,L_MATERNO);
									INSERT INTO moises.PERSONA_JURIDICA
									(id_ruc,id_persona,id_tipoestado,id_tipocondicion,id_tipocontribuyente,id_tipoactividadeconomica,id_tipopais)
									SELECT id_ruc,L_ID_CLIENTE_NEW AS id_persona,id_tipoestado,id_tipocondicion,id_tipocontribuyente,id_tipoactividadeconomica,id_tipopais
									FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente;
									INSERT INTO moises.persona_documento
									(id_persona,id_tipodocumento,num_documento,es_activo)
									SELECT L_ID_CLIENTE_NEW AS id_persona,id_tipodocumento,id_ruc,1
									FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente;
								ELSE 
									L_NO_EXISTE_PERSONA := 1;
								END IF;
							ELSE 
								L_NO_EXISTE_PERSONA := 1;
							END IF;
						END IF;
					END IF;
				END IF;
				SELECT COUNT(1) INTO L_CANT FROM moises.PERSONA_DOCUMENTO pd 
				WHERE num_documento = venta_item.num_documento_cliente_legal;
				IF L_CANT > 0 THEN 
					SELECT ID_PERSONA INTO L_ID_CLIENTE_LEGAL_NEW FROM moises.PERSONA_DOCUMENTO pd 
					WHERE num_documento = venta_item.num_documento_cliente_legal AND rownum = 1;
				ELSE 
					IF venta_item.id_cliente_legal IS NOT NULL THEN 
						SELECT COUNT(1) INTO L_CANT FROM moises.PERSONA_NATURAL pd 
						WHERE num_documento = venta_item.num_documento_cliente_legal;
						IF L_CANT > 0 THEN 
							SELECT ID_PERSONA INTO L_ID_CLIENTE_LEGAL_NEW FROM moises.PERSONA_NATURAL pd 
							WHERE num_documento = venta_item.num_documento_cliente_legal AND rownum = 1;
							UPDATE ELISEO.VENTA_TO_LAMB SET NO_EXISTE_CLIENTE_LEGAL = 0 WHERE ID_VENTA = venta_item.ID_VENTA;
						ELSE 
							SELECT COUNT(1) INTO L_CANT FROM moises.PERSONA_JURIDICA pd 
							WHERE id_ruc = venta_item.num_documento_cliente_legal;
							IF L_CANT > 0 THEN 
								SELECT ID_PERSONA INTO L_ID_CLIENTE_LEGAL_NEW FROM moises.PERSONA_JURIDICA pd 
								WHERE id_ruc = venta_item.num_documento_cliente_legal AND rownum = 1;
								UPDATE ELISEO.VENTA_TO_LAMB SET NO_EXISTE_CLIENTE_LEGAL = 0 WHERE ID_VENTA = venta_item.ID_VENTA;
							ELSE 
								--L_NO_EXISTE_PERSONA := 1;

								--UPDATE ELISEO.VENTA_TO_LAMB SET NO_EXISTE_CLIENTE_LEGAL = 1 WHERE ID_VENTA = venta_item.ID_VENTA;

								SELECT COUNT(1) INTO L_CANT FROM eliseo.venta_persona_to_lamb pd 
								WHERE id_persona = venta_item.id_cliente_legal;
								IF L_CANT > 0 THEN 
									SELECT nombre,paterno,materno,num_documento,id_ruc INTO L_NOMBRE,L_PATERNO,L_MATERNO,L_NUM_DOCUMENTO,L_ID_RUC 
									FROM eliseo.venta_persona_to_lamb pd 
									WHERE id_persona = venta_item.id_cliente_legal AND rownum =1;
									IF L_NUM_DOCUMENTO IS NOT NULL THEN 
									SELECT MAX(id_persona) +1 INTO L_ID_CLIENTE_LEGAL_NEW FROM moises.persona; 
										INSERT INTO moises.persona (id_persona,nombre,paterno,materno) 
										VALUES (L_ID_CLIENTE_LEGAL_NEW,L_NOMBRE,L_PATERNO,L_MATERNO);
										INSERT INTO moises.persona_natural
										(id_persona,id_tipopais,id_tiporeligion,id_tipodocumento,num_documento,sexo,celular,fec_nacimiento,correo)
										SELECT L_ID_CLIENTE_LEGAL_NEW AS id_persona,id_tipopais,id_tiporeligion,id_tipodocumento,num_documento,sexo,celular,fec_nacimiento,correo
										FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente_legal;
										INSERT INTO moises.persona_documento
										(id_persona,id_tipodocumento,num_documento,es_activo)
										SELECT L_ID_CLIENTE_LEGAL_NEW AS id_persona,id_tipodocumento,num_documento,1
										FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente_legal;
									ELSIF L_ID_RUC IS NOT NULL THEN 
									SELECT MAX(id_persona) +1 INTO L_ID_CLIENTE_LEGAL_NEW FROM moises.persona;
										INSERT INTO moises.persona (id_persona,nombre,paterno,materno) 
										VALUES (L_ID_CLIENTE_LEGAL_NEW,L_NOMBRE,L_PATERNO,L_MATERNO);
										INSERT INTO moises.PERSONA_JURIDICA
										(id_ruc,id_persona,id_tipoestado,id_tipocondicion,id_tipocontribuyente,id_tipoactividadeconomica,id_tipopais)
										SELECT id_ruc,L_ID_CLIENTE_LEGAL_NEW AS id_persona,id_tipoestado,id_tipocondicion,id_tipocontribuyente,id_tipoactividadeconomica,id_tipopais
										FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente_legal;
										INSERT INTO moises.persona_documento
										(id_persona,id_tipodocumento,num_documento,es_activo)
										SELECT L_ID_CLIENTE_LEGAL_NEW AS id_persona,id_tipodocumento,id_ruc,1
										FROM eliseo.venta_persona_to_lamb WHERE id_persona = venta_item.id_cliente_legal;
									ELSE 
									L_NO_EXISTE_PERSONA := 1;
									END IF;
								ELSE 
									L_NO_EXISTE_PERSONA := 1;
								END IF;
							END IF;
						END IF;
					END IF;
				END IF;
				
				IF L_NO_EXISTE_PERSONA = 0 THEN 
					BEGIN ELISEO.PKG_ACCOUNTING.SP_CREAR_VOUCHER_CARGO_CUOTA (
	                venta_item.id_entidad,
	                venta_item.ID_DEPTO,
	                venta_item.ID_ANHO,
	                venta_item.ID_MES,
	                venta_item.FECHA,
	                venta_item.ID_TIPOASIENTO,
	                venta_item.ID_TIPOVOUCHER,
	                null,
	                L_ACTIVO,
	                venta_item.id_persona,
	                L_ID_VOUCHER
	                );
	                END;
	               	
	               INSERT INTO eliseo.VENTA 
	               (
	               id_entidad,
	               id_depto,
	               id_anho,
	               id_mes,
	               id_persona,
	               id_cliente,
	               id_cliente_legal,
	               id_voucher,
	               id_comprobante,
	               id_tiponota,
	               id_igv,
	               id_moneda,
	               tipocambio,
	               id_leyenda,
	               id_comprobante_ref,
	               serie,
	               serie_ref,
	               numero,
	               numero_ref,
	               fecha,
	               glosa,
	               gravada,
	               inafecta,
	               exonerada,
	               gratuita,
	               descuento,
	               descuento_global,
	               descuento_porcentaje,
	               importe_adescontar,
	               igv,
	               total,
	               estado,
	               otros_cargos,
	               id_tipoventa,
	               fecha_ref,
	               id_tipodocumento_cli,
	               nro_doc_cli,
	               razon_social_cli,
	               direccion_cli
	               )
	               VALUES (
	               venta_item.id_entidad,
	               venta_item.id_depto,
	               venta_item.id_anho,
	               venta_item.id_mes,
	               venta_item.id_persona,
	               L_ID_CLIENTE_NEW,
	               L_ID_CLIENTE_LEGAL_NEW,
	               L_ID_VOUCHER,
	               venta_item.id_comprobante,
	               venta_item.id_tiponota,
	               venta_item.id_igv,
	               venta_item.id_moneda,
	               venta_item.tipocambio,
	               venta_item.id_leyenda,
	               venta_item.id_comprobante_ref,
	               venta_item.serie,
	               venta_item.serie_ref,
	               venta_item.numero,
	               venta_item.numero_ref,
	               venta_item.fecha,
	               venta_item.glosa,
	               venta_item.gravada,
	               venta_item.inafecta,
	               venta_item.exonerada,
	               venta_item.gratuita,
	               venta_item.descuento,
	               venta_item.descuento_global,
	               venta_item.descuento_porcentaje,
	               venta_item.importe_adescontar,
	               venta_item.igv,
	               venta_item.total,
	               venta_item.estado,
	               venta_item.otros_cargos,
	               venta_item.id_tipoventa,
	               venta_item.fecha_ref,
	               venta_item.id_tipodocumento_cli,
	               venta_item.nro_doc_cli,
	               venta_item.razon_social_cli,
	               venta_item.direccion_cli
	               )
	               returning id_venta into L_ID_VENTA_NEW;
	              
	              UPDATE eliseo.VENTA_TO_LAMB SET ID_VENTA_LAMB = L_ID_VENTA_NEW WHERE ID_VENTA = venta_item.ID_VENTA;
	             
	             INSERT INTO eliseo.VENTA_DETALLE 
	             (
	             id_venta,id_tipoigv,id_tipoorigen,detalle,cantidad,precio,precio_base,base,igv,descuento,importe
	             )
	             SELECT L_ID_VENTA_NEW AS id_venta,id_tipoigv,id_tipoorigen,detalle,cantidad,precio,precio_base,base,igv,descuento,importe
	            	FROM ELISEO.VENTA_DETALLE_TO_LAMB vdtl WHERE ID_VENTA = venta_item.ID_VENTA;
	            	
	           		
					IF venta_item.tipoemisorid = 'NUBE' THEN 
		           		UPDATE eliseo.VENTA_ELECTRONICA_NUBE SET ORIGENID = L_ID_VENTA_NEW WHERE ID = venta_item.id_lamb;
		           	END IF;
		           	IF venta_item.tipoemisorid = 'BIZLINKS' THEN 
		           		UPDATE eliseo.VENTA_ELECTRONICA_BIZLINKS SET ORIGENID = L_ID_VENTA_NEW WHERE ID = venta_item.id_lamb;
		           	END IF;
		           	IF venta_item.tipoemisorid = 'UPEU' THEN 
		           		UPDATE eliseo.VENTA_ELECTRONICA SET ORIGENID = L_ID_VENTA_NEW WHERE ID = venta_item.id_lamb;
					END IF;
			
				END IF;
			ELSE 
				UPDATE ELISEO.VENTA_TO_LAMB SET EXISTE_VENTA = 1 WHERE ID_VENTA = venta_item.ID_VENTA;
			END IF;
		END LOOP;
END SP_VENTA_7EDU_TO_LAMB;

