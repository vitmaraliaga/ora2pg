-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE TEMP_SP_CREAR_AJUSTE(P_ID_ENTIDAD NUMBER,P_ID_DEPTO VARCHAR2,P_ID_ANHO NUMBER,P_ID_MES NUMBER,P_ID_PERSONA NUMBER,P_ID_COMPRA NUMBER, ID_DINAMICA NUMBER,P_ID_VOUCHER NUMBER,P_FECHA DATE, P_IMPORTE NUMBER,P_IMPORTE_ME NUMBER,P_DC VARCHAR2, P_ID_AJUSTE OUT NUMBER,P_ERROR OUT NUMBER,P_ESTADO VARCHAR2 default '1',P_ID_PROVEEDOR NUMBER DEFAULT NULL) IS
        L_AJUSTE NUMBER;	
        L_ID_PROVEEDOR NUMBER;
        L_ID_MONEDA NUMBER;
        L_NUMERO VARCHAR2(8);
        L_TIPOORIGEN NUMBER :=4; --COMPRA TRANSFERENCIA O AJUS
        L_CANT NUMBER := 0; 
        L_ID_COMPRA NUMBER;
        L_ID_SALDO NUMBER;

        BEGIN
            P_ERROR :=0;  
            --BORRAS OPER CON ESTADO 0
            IF P_ID_ENTIDAD = 7124 THEN --UPN HACE OTRO PROCESO
                SELECT COUNT(ID_AJUSTE) INTO L_CANT FROM COMPRA_AJUSTE WHERE ID_PERSONA = P_ID_PERSONA AND ESTADO = '0';
                IF L_CANT > 0 THEN
                    SELECT ID_AJUSTE INTO L_AJUSTE FROM COMPRA_AJUSTE WHERE ID_PERSONA = P_ID_PERSONA AND ESTADO = '0';
                    DELETE CONTA_ASIENTO WHERE ID_TIPOORIGEN = L_TIPOORIGEN AND ID_ORIGEN = L_AJUSTE AND VOUCHER IS NULL;
                    DELETE COMPRA_AJUSTE WHERE ID_PERSONA = P_ID_PERSONA AND ESTADO = '0';
                END IF;
            END IF;

            SELECT COALESCE(MAX(ID_AJUSTE),0)+1 INTO L_AJUSTE FROM COMPRA_AJUSTE;


            SELECT COUNT(1) INTO L_CANT FROM COMPRA
            WHERE ID_COMPRA = P_ID_COMPRA
            AND ID_PROVEEDOR = P_ID_PROVEEDOR
            AND ID_ANHO = P_ID_ANHO;
            
DBMS_OUTPUT.put_line('----> P_ID_COMPRA = '||P_ID_COMPRA);
DBMS_OUTPUT.put_line('----> P_ID_PROVEEDOR = '||P_ID_PROVEEDOR);
DBMS_OUTPUT.put_line('----> P_ID_ANHO = '||P_ID_ANHO);
DBMS_OUTPUT.put_line('----> L_CANT = '||L_CANT);

            IF L_CANT > 0 THEN
                SELECT ID_PROVEEDOR,ID_MONEDA INTO L_ID_PROVEEDOR, L_ID_MONEDA FROM COMPRA
                WHERE ID_COMPRA = P_ID_COMPRA
                AND ID_PROVEEDOR = case when P_ID_PROVEEDOR is null then ID_PROVEEDOR else P_ID_PROVEEDOR end 
                AND ID_ANHO = P_ID_ANHO;
                L_ID_COMPRA := P_ID_COMPRA;
                L_ID_SALDO := NULL;
            ELSE
                SELECT COUNT(1) INTO L_CANT FROM COMPRA_SALDO
                WHERE ID_SALDO = P_ID_COMPRA
                AND ID_PROVEEDOR = case when P_ID_PROVEEDOR is null then ID_PROVEEDOR else P_ID_PROVEEDOR end 
                AND ID_ANHO = P_ID_ANHO;
                IF L_CANT > 0 THEN
                    SELECT ID_PROVEEDOR,ID_MONEDA INTO L_ID_PROVEEDOR, L_ID_MONEDA FROM COMPRA_SALDO
                    WHERE ID_SALDO = P_ID_COMPRA
                    AND ID_PROVEEDOR = case when P_ID_PROVEEDOR is null then ID_PROVEEDOR else P_ID_PROVEEDOR end 
                    AND ID_ANHO = P_ID_ANHO;
                    L_ID_SALDO := P_ID_COMPRA;
                    L_ID_COMPRA := NULL;
                ELSE
                    P_ERROR:=1;
                END IF;
            END IF;

            IF P_ERROR = 0 THEN
                SELECT LPAD(COALESCE(MAX(TO_NUMBER(NUMERO)),0)+1,8,0) INTO L_NUMERO FROM COMPRA_AJUSTE
                WHERE ID_ENTIDAD = P_ID_ENTIDAD
                AND ID_DEPTO = P_ID_DEPTO;

                INSERT INTO COMPRA_AJUSTE(
                        ID_AJUSTE, 
                        ID_ENTIDAD,
                        ID_DEPTO,
                        ID_ANHO,
                        ID_MES,
                        ID_COMPRA,
                        ID_PERSONA,
                        ID_PROVEEDOR,
                        ID_DINAMICA,
                        ID_MONEDA,
                        ID_VOUCHER,
                        ID_TIPOORIGEN,
                        FECHA, 
                        NUMERO, 
                        IMPORTE,
                        IMPORTE_ME,
                        DC, 
                        ESTADO,
                        ID_SALDO
                )VALUES(
                        L_AJUSTE,
                        P_ID_ENTIDAD,
                        P_ID_DEPTO,
                        P_ID_ANHO,
                        P_ID_MES,
                        L_ID_COMPRA,
                        P_ID_PERSONA,
                        L_ID_PROVEEDOR,
                        ID_DINAMICA,
                        L_ID_MONEDA,
                        P_ID_VOUCHER,
                        L_TIPOORIGEN,
                        P_FECHA,
                        L_NUMERO,
                        P_IMPORTE,
                        P_IMPORTE_ME,
                        P_DC,
                        P_ESTADO,
                        L_ID_SALDO
                );
                P_ID_AJUSTE := L_AJUSTE;
                /*
                IF P_ID_ENTIDAD = 7124 THEN
                    P_ERROR:=0;
                    --GENERA ASIENTO CONTABLE
                END IF;
                */
                P_ERROR:=0;
            END IF;

    END TEMP_SP_CREAR_AJUSTE;

