-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_mobile_user_data (
    p_id_persona           int,
    cursor       OUT SYS_REFCURSOR
)
IS

    l_total_diezmo number(38,2);
    l_total_gasto number(38,2);
    l_tipo_admin number(38,2);
    l_tienepptodepartamentos varchar2(10);
    l_tienepptoviajes varchar2(10);
    l_id_entidad number(38,2);
    

BEGIN
    DELETE FROM TT_TABLE_AUX;
    
    l_tipo_admin := '1'; --Usuario Normal --2 Usuario Entidad -- 3 SuperUsuario
    
    select 
    coalesce(max(id_typeadmin),1)
    -- ,coalesce(max(id_entidad),1)
    into l_tipo_admin
    -- , l_id_entidad
    from users_details
    where id = p_id_persona ;
  
    select coalesce((
    select 'S'
    from dual
    where
    exists(
    select id_depto from CONTA_ENTIDAD_DEPTO_RESP where id_persona = p_id_persona 
    )
    ),'N') into l_tienepptodepartamentos from dual;
    
    OPEN cursor FOR 
    select    id_persona as id, 
              num_documento as doc_number, 
              nom_persona as name, 
              (SELECT 'https://api-lamb.upeu.edu.pe/'||COALESCE(MAX(IMAGEN_URL),'') FROM USERS WHERE ID= id_persona)  AS foto_url,
              -- 'https://api-lamb.upeu.edu.pe/setup_files/users/7677.JPEG'
              --'http://intranet.educacionadventista.org.pe/fotos_upn/'||num_documento||'.png' AS foto_url,
              -- decode(l_id_entidad,1,id_entidad, l_id_entidad) as entity,
              id_entidad AS entity,
              l_tipo_admin as admin,
              l_tienepptodepartamentos as tienepptodepartamentos,
              (select coalesce((
                select 'S' from dual 
                where exists(
                    select
                        COS_VALOR
                        from vw_conta_Presupuesto p
                        where p.ID_ENTIDAD = id_entidad
                        and p.ID_CTACTE=num_documento
                        -- and p.ID_ANHO >= EXTRACT(year FROM current_timestamp - interval '1' month)
                        and p.ID_ANHO >= EXTRACT(year FROM current_timestamp)
                        and p.ID_CUENTAAASI  in (4111022,4111023,4111070,4111071,4111073,4113023,4121029,4113093)
                        and p.ID_DEPTO = 396119
                        )
                ),'N') from dual ) as tienepptoviajes
      from 
    (select id_persona, num_documento, nom_persona, id_entidad
    from VW_APS_EMPLEADO
    where id_persona = p_id_persona
    AND FEC_TERMINO IS NULL
    order by FEC_INICIO desc
    ) a
     where ROWNUM <= 1             
    ;
END;

