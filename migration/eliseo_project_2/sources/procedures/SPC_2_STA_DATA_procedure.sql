-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_2_sta_data (
    p_id_entidad           int,
    p_id_anho           int,
    p_id_mes           int,
    p_id_persona       int,
    p_id_cta_cte       varchar2,
    cursor       OUT SYS_REFCURSOR
)
IS 

    l_ingresos number(38,2);
    l_descuentos number(38,2);
    l_descuentos_adelantos number(38,2);
    l_ingresos_ayudas number(38,2);
    l_ingresos_viajes number(38,2);
    l_descuentos_ayudas number(38,2);
    l_descuentos_viajes number(38,2);
    l_sueldo_depositado number(38,2);
    
    l_saldo_viajes number(38,2);
    l_saldo_ayudas number(38,2);

    l_adelanto_ayudas number(38,2);
    l_adelanto_gratificaciones number(38,2);
    l_a_rendir number(38,2);

    l_adelanto_ayudas_c number(38,2);
    l_adelanto_gratificaciones_c number(38,2);
    l_a_rendir_c number(38,2);
   
    l_fecha_desde varchar2(10) := '01';
    l_fecha_hasta varchar2(10) := '25';
    
    l_descuento_extraordinario number(38,2);

BEGIN
    DELETE FROM TT_TABLE_AUX;
    l_ingresos:= 0;
    l_descuentos:= 0;
    l_descuentos_adelantos:= 0;
    l_ingresos_ayudas:= 0;
    l_ingresos_viajes:= 0;
    l_descuentos_ayudas:= 0;
    l_descuentos_viajes:= 0;
    l_sueldo_depositado:= 0;
    l_adelanto_ayudas:= 0;
    l_adelanto_gratificaciones:= 0;
    l_a_rendir:= 0;
    l_descuento_extraordinario := 0;
    
    select nvl(sum(COS_VALOR),0) into l_descuento_extraordinario from VW_CONTA_DIARIO
          where ID_CUENTAAASI = '2135001'
          and id_entidad = 17112
          and ID_ANHO = 2017
          and ID_MES = 7
          and ID_TIPOASIENTO = 'MI'
          and COD_AASI = 3
          and id_entidad = p_id_entidad
          and ID_ANHO = p_id_anho
          and id_mes = p_id_mes
          and ID_CTACTE = p_id_cta_cte;
       
    select 
      nvl(sum(p.COS_VALOR),0) into l_ingresos
      from
      VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
      where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
      and p.ID_ENTIDAD=p_id_entidad
      and p.ID_ANHO=p_id_anho
      and p.ID_MES= p_id_mes
      and p.ID_PERSONA=p_id_persona
      and a.ID_TIPOCONCEPTOAPS NOT IN (100,200)
      and (
        P.ID_CONCEPTOAPS like '10%'
        or P.ID_CONCEPTOAPS like '11%'
        or P.ID_CONCEPTOAPS like '12%'
        or P.ID_CONCEPTOAPS like '13%'
        or P.ID_CONCEPTOAPS like '14%'
        or P.ID_CONCEPTOAPS like '2%'
        or P.ID_CONCEPTOAPS like '3%'
        or P.ID_CONCEPTOAPS like '7%'
        --or P.ID_CONCEPTOAPS like '1557%'
        --or P.ID_CONCEPTOAPS like '1558%'        
      )
      and not P.ID_CONCEPTOAPS like '7600%'  
      AND ID_TIPOPLANILLA NOT IN (98628)  -- fue descomentado: y cambiado de 106791 a 98628
      AND p.FEC_SALIDA IS NULL 
      ;
      
select 
                nvl(sum(p.COS_VALOR),0)  into l_descuentos
                from
                VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
                where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
                and p.ID_ENTIDAD=p_id_entidad
                and p.ID_ANHO=p_id_anho
                and p.ID_MES= p_id_mes
                and p.ID_PERSONA=p_id_persona
                and (
                  P.ID_CONCEPTOAPS like '15%'
                  or P.ID_CONCEPTOAPS like '7600%'
                )
                and not P.ID_CONCEPTOAPS like '1552%'
                and not P.ID_CONCEPTOAPS like '1556%'
                --and not P.ID_CONCEPTOAPS like '1557%'
                --and not P.ID_CONCEPTOAPS like '1558%'
;


---------------------------------------------------------
-- AYUDAS INFORMADOS
SELECT abs(nvl(sum(valor),0)) into l_ingresos_ayudas FROM (
 	/*
	SELECT A.COS_VALOR FROM VW_APS_PLANILLA A 
        INNER JOIN APS_CONCEPTO_PLANILLA B ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
		WHERE A.ID_ENTIDAD = p_id_entidad
		AND A.ID_ANHO = p_id_anho
		AND A.ID_MES = p_id_mes
		AND A.ID_PERSONA = p_id_persona
		AND A.ID_TIPOPLANILLA in (98634) -- Reintegro de gastos
		AND B.ID_TIPOCONCEPTOAPS = '100'
       UNION    
  	select 
		cos_valor
	from VW_CONTA_DIARIO
	where id_entidad = p_id_entidad
	and ID_CUENTAAASI = 1135005
	and ID_CTACTE = p_id_cta_cte
	and ID_MES = p_id_mes
	and ID_ANHO = p_id_anho
	AND NOT COMENTARIO LIKE 'APS%'
    AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
	AND DEBE=0
	*/
	SELECT A.COS_VALOR as valor FROM VW_APS_PLANILLA A 
    INNER JOIN APS_CONCEPTO_PLANILLA B ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
	WHERE ID_ENTIDAD = p_id_entidad
	AND ID_ANHO = p_id_anho
	AND ID_MES = p_id_mes
	AND ID_PERSONA = p_id_persona
	AND ID_TIPOPLANILLA IN (98634) -- Reintegro de gastos
	AND ID_TIPOCONCEPTOAPS = '100'
	union
    select 
        abs(COS_VALOR) valor
    from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135005
    and ID_CTACTE = p_id_cta_cte
    and ID_MES = p_id_mes
    and ID_ANHO = p_id_anho
    AND NOT COMENTARIO LIKE 'APS%'
    AND DEBE=0
    AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
    ) X 
    ;
      
-- AYUDAS SALDO FINAL
select 
	nvl(sum(cos_valor),0) INTO l_saldo_ayudas
from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135005
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
-- AND NOT COMENTARIO LIKE 'APS%'
;

-- ADELANTO AYUDAS
/*select nvl(sum(COS_VALOR),0) into l_descuentos_ayudas from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135005
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
--and not ID_TIPOASIENTO = 'RH'
AND HABER = 0
AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
*/
select nvl(sum(COS_VALOR),0) into l_descuentos_ayudas from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135005
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
AND NOT COMENTARIO LIKE 'APS%'
AND HABER=0
AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
;
-----------------------------------------------------------------
----------------------------------------------------------------
-- VIAJES INFORMADOS
SELECT abs(nvl(sum(valor),0)) into l_ingresos_viajes FROM (
	/*
    SELECT A.COS_VALOR FROM VW_APS_PLANILLA A 
        INNER JOIN APS_CONCEPTO_PLANILLA B ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
		WHERE A.ID_ENTIDAD = p_id_entidad
		AND A.ID_ANHO = p_id_anho
		AND A.ID_MES = p_id_mes
		AND A.ID_PERSONA = p_id_persona
		AND A.ID_TIPOPLANILLA in (106791) -- Reintegro de gastos de viajes
		AND B.ID_TIPOCONCEPTOAPS = '200'
    UNION
  	select 
		abs(cos_valor) COS_VALOR
	from VW_CONTA_DIARIO
	where id_entidad = p_id_entidad
	and ID_CUENTAAASI = 1135010
	and ID_CTACTE = p_id_cta_cte
	and ID_MES = p_id_mes
	and ID_ANHO = p_id_anho
	AND NOT COMENTARIO LIKE 'APS%'
    AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
	AND DEBE=0
	*/
	SELECT A.COS_VALOR as valor FROM VW_APS_PLANILLA A 
    INNER JOIN APS_CONCEPTO_PLANILLA B ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
	WHERE ID_ENTIDAD = p_id_entidad
	AND ID_ANHO = p_id_anho
	AND ID_MES = p_id_mes
	AND ID_PERSONA = p_id_persona
	AND ID_TIPOPLANILLA in (106791) -- Reintegro de gastos de viajes
	AND ID_TIPOCONCEPTOAPS = '200'
	union
    SELECT ABS(COS_VALOR) as valor
    from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135010
    and ID_CTACTE = p_id_cta_cte
    and ID_MES = p_id_mes
    and ID_ANHO = p_id_anho
    AND NOT COMENTARIO LIKE 'APS%'
    AND DEBE=0
    AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta) 
	) X
;

-- VIAJES SALDO FINAL
select 
	nvl(sum(cos_valor),0) INTO l_saldo_viajes
from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135010
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
-- AND NOT COMENTARIO LIKE 'APS%'
;

-- ADELANTO VIAJES
/*
select nvl(sum(COS_VALOR),0) into l_descuentos_viajes from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135010
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
-- and not ID_TIPOASIENTO = 'RH'
AND HABER = 0
AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
*/
select nvl(SUM(COS_VALOR),0) into l_descuentos_viajes from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135010
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
AND NOT COMENTARIO LIKE 'APS%'
AND HABER=0
AND (TO_CHAR(FEC_ASIENTO, 'DD') BETWEEN l_fecha_desde AND l_fecha_hasta)
;

--------------------------------------------------------------------------
select nvl(sum(COS_VALOR),0) into l_descuentos_adelantos from VW_CONTA_DIARIO
where id_entidad = p_id_entidad
and ID_CUENTAAASI = 1135001
and ID_CTACTE = p_id_cta_cte
and ID_MES = p_id_mes
and ID_ANHO = p_id_anho
and not ID_TIPOASIENTO = 'RH'
;



--PRESTAMOS
    select nvl(sum(COS_VALOR),0), count(*) into l_adelanto_ayudas, l_adelanto_ayudas_c from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135061
    and ID_CTACTE = p_id_cta_cte
    and ID_MES <= p_id_mes
    and ID_ANHO = p_id_anho
    ;
--ADELANTO GRAT
    select nvl(sum(COS_VALOR),0), count(*) into l_adelanto_gratificaciones, l_adelanto_gratificaciones_c from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135016
    and ID_CTACTE = p_id_cta_cte
    and ID_MES <= p_id_mes
    and ID_ANHO = p_id_anho
    ;
    select nvl(sum(COS_VALOR),0), count(*) into l_a_rendir, l_a_rendir_c from VW_CONTA_DIARIO
    where id_entidad = p_id_entidad
    and ID_CUENTAAASI = 1135007
    and ID_CTACTE = p_id_cta_cte
    and ID_MES <= p_id_mes
    and ID_ANHO = p_id_anho
    ;      

    
    DBMS_OUTPUT.PUT_LINE('l_ingresos');
    DBMS_OUTPUT.PUT_LINE(l_ingresos);

    DBMS_OUTPUT.PUT_LINE('l_descuentos');
    DBMS_OUTPUT.PUT_LINE(l_descuentos);

    DBMS_OUTPUT.PUT_LINE('l_descuentos_ayudas');
    DBMS_OUTPUT.PUT_LINE(l_descuentos_ayudas);

    DBMS_OUTPUT.PUT_LINE('l_descuentos_viajes');
    DBMS_OUTPUT.PUT_LINE(l_descuentos_viajes);


    l_sueldo_depositado := l_ingresos - (l_descuentos + l_descuento_extraordinario + l_descuentos_adelantos);    
    -- l_sueldo_depositado := l_ingresos - (l_descuentos + l_descuento_extraordinario + l_descuentos_adelantos);    
    
   	DBMS_OUTPUT.PUT_LINE('l_sueldo_depositado');
    DBMS_OUTPUT.PUT_LINE(l_sueldo_depositado);
    INSERT INTO TT_TABLE_AUX(NUM_1, NUM_2, NUM_3, NUM_4) 
    VALUES(l_sueldo_depositado, l_adelanto_ayudas, l_adelanto_gratificaciones,l_a_rendir);
 
    OPEN cursor FOR 
    SELECT 
      l_sueldo_depositado as sueldo_depositado,
      
      l_saldo_viajes AS viajes_saldo,
      l_ingresos_viajes-l_descuentos_viajes as viajes,
      l_ingresos_viajes as viajes_ingresos,
      l_descuentos_viajes as viajes_descuentos,
      
      l_saldo_ayudas AS ayudas_saldo,
      l_ingresos_ayudas-l_descuentos_ayudas AS ayudas,
      l_ingresos_ayudas AS ayudas_ingresos,
      l_descuentos_ayudas AS ayudas_descuentos,

      l_adelanto_ayudas as adelanto_ayudas,
      l_adelanto_gratificaciones as adelanto_gratificaciones,
      l_a_rendir as a_rendir,
      ABS(l_ingresos_ayudas) + ABS(l_descuentos_ayudas) AS ayudas_c,
      ABS(l_ingresos_viajes) + ABS(l_descuentos_viajes) AS viajes_c,
      l_adelanto_ayudas_c as adelanto_ayudas_c,
      l_adelanto_gratificaciones_c as adelanto_gratificaciones_c,
      l_a_rendir_c as a_rendir_c
    from dual 
    ;
  
END;

