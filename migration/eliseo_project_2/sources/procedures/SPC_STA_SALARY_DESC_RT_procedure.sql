-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_sta_salary_desc_rt (
    p_id_entidad           int,
    p_id_entidad_assinet  int,
    p_id_anho           int,
    p_id_mes           int,
    p_id_persona       int,
    p_id_ctacte       varchar2,
    cursor       OUT SYS_REFCURSOR
)
IS

    l_ingresos number(38,2);
    l_codigo_assinet varchar2(20):='';

BEGIN
    DELETE FROM TT_TABLE_AUX;

	SELECT MAX(CODIGO_ASSINET) INTO l_codigo_assinet
  	FROM moises.PERSONA_NATURAL pn WHERE ID_PERSONA = p_id_persona;
  
    OPEN cursor FOR 
    select TO_CHAR(fecha, 'DD/MM/YY') AS fecha, comentario, sum(valor) as valor from 
    (select 
               	case p.ID_CONCEPTOAPS
                when 1500 then 1500
                when 1501 then 1500
                when 1508 then 1500 
                when 3000 then 3000 
                when 3079 then 3000 
                when 3080 then 3000
                when 3090 then 3000 
                when 3095 then 3000 
                when 3097 then 3000 
                when 3100 then 3000 
                when 3102 then 3000 
                when 3121 then 3000 
                when 3122 then 3000 
                when 3126 then 3000 
                when 3145 then 3000 
                when 3151 then 3000 
                when 3156 then 3000 
                when 3157 then 3000 
                when 3170 then 3000 
                when 3171 then 3000 
                when 3212 then 3000 
                when 3216 then 3000 
                when 3220 then 3000 
                when 3222 then 3000 
                when 3224 then 3000 
                when 3228 then 3000 
                when 3246 then 3000 
                else a.ID_CONCEPTOAPS end as codigo, 
                p.fec_pago as fecha,                 
                case p.ID_CONCEPTOAPS
                when 1500 then 'AFP' 
                when 1501 then 'AFP' 
                when 1508 then 'AFP' 
                when 1126 then 'Depreciación' 
                when 1147 then 'Bono de Alimentos' 
                when 7600 then 'Des. Ayuda alquiler' 
                
                when 3000 then 'Gratificación' 
                when 3079 then 'Gratificación' 
                when 3080 then 'Gratificación' 
                when 3090 then 'Gratificación' 
                when 3095 then 'Gratificación' 
                when 3097 then 'Gratificación' 
                when 3100 then 'Gratificación' 
                when 3102 then 'Gratificación' 
                when 3121 then 'Gratificación' 
                when 3122 then 'Gratificación' 
                when 3126 then 'Gratificación' 
                when 3145 then 'Gratificación' 
                when 3151 then 'Gratificación' 
                when 3156 then 'Gratificación' 
                when 3157 then 'Gratificación' 
                when 3170 then 'Gratificación' 
                when 3171 then 'Gratificación' 
                when 3212 then 'Gratificación' 
                when 3216 then 'Gratificación' 
                when 3220 then 'Gratificación' 
                when 3222 then 'Gratificación' 
                when 3224 then 'Gratificación' 
                when 3228 then 'Gratificación' 
                when 3246 then 'Gratificación' 
                else a.NOMBRE end as comentario, 
                p.COS_VALOR as valor
                from
                VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
                where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
                and p.ID_ENTIDAD=p_id_entidad
                and p.ID_ANHO=p_id_anho
                and p.ID_MES= p_id_mes
                and p.ID_PERSONA=p_id_persona
                and (
                  P.ID_CONCEPTOAPS like '15%'
                  or P.ID_CONCEPTOAPS like '7600%'
                )
                and not P.ID_CONCEPTOAPS like '1552%'
                and not P.ID_CONCEPTOAPS like '1556%'
                and not P.ID_CONCEPTOAPS like '1557%'
                and not P.ID_CONCEPTOAPS like '1558%'
                and not P.ID_CONCEPTOAPS like '4556%'
        ) a 
        group by codigo, fecha, comentario
    	union ALL
    	select 
                to_char(FEC_ASIENTO,'dd/mm/yy') AS FECHA,
                    COMENTARIO,
                    COS_VALOR as valor
                from VW_CONTA_DIARIO
                where id_entidad = p_id_entidad_assinet
                and ID_CUENTAAASI = '1135001'
                and (ID_CTACTE = p_id_ctacte OR ID_CTACTE = l_codigo_assinet)
                and ID_MES = p_id_mes
                and ID_ANHO = p_id_anho
		        AND NOT COMENTARIO LIKE 'APS%'
		        AND HABER=0
                UNION all
                SELECT TO_CHAR(A.FEC_PAGO,'dd/mm/yy') AS FECHA, B.NOMBRE AS COMENTARIO,
                A.COS_VALOR AS valor
                FROM VW_APS_PLANILLA A INNER JOIN APS_CONCEPTO_PLANILLA B
                 ON A.ID_CONCEPTOAPS = B.ID_CONCEPTOAPS 
				WHERE A.ID_ENTIDAD = p_id_entidad
				AND A.ID_ANHO = p_id_anho
				AND A.ID_MES = p_id_mes
				AND A.ID_PERSONA = p_id_persona
				AND A.ID_CONCEPTOAPS IN (1557, 1558, 4556);
END;

