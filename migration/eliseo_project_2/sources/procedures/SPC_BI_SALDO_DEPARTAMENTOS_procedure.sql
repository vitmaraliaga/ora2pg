-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_bi_saldo_departamentos (
    p_id_entidad           int,
    p_id_anho           int,
    cursor       OUT SYS_REFCURSOR
)
IS
    l_num_documento varchar2(100);

BEGIN
    l_num_documento:= ''; 


    OPEN cursor FOR 
    
    select 
    id_mes,
    id AS id_depto, 
    name AS nombre,
    (select fc_nombre_persona(max(h.id_persona)) from CONTA_ENTIDAD_DEPTO_RESP h where h.id_depto = Y.id and h.id_entidad = p_id_entidad ) as responsable,
    round(saldo_inicial) AS saldo_inicial,
    round(ppto) AS ppto,
    round(ingreso) AS ingreso,
    round(realizado) AS realizado,
    round(total_ppto) AS total_ppto,
    round(saldo) AS saldo,
    porc
    from (
    
    Select
                1 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 1
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 1
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 1
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 1
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE
UNION ALL 

    Select
                2 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 2
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 2
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 2
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 2
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE
UNION ALL 

    Select
                3 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 3
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 3
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 3
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 3
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE
UNION ALL 

    Select
                4 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 4
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 4
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 4
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 4
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE
UNION ALL 

    Select
                5 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 5
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 5
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 5
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 5
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE
UNION ALL 

    Select
                6 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 6
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 6
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 6
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 6
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE
UNION ALL 
    Select
                7 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 7
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 6
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 7
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 7
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE        
UNION ALL 

    Select
                8 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 8
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 8
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 8
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 8
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE   
        
UNION ALL 

    Select
                9 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 9
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 9
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 9
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 9
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE       
UNION ALL 

    Select
                10 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 10
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 10
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 10
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 10
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE  
UNION ALL 

    Select
                11 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 11
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 11
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 11
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 11
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE        
UNION ALL 

    Select
                12 as id_mes,
                X.Dpto as id,
                ed.NOMBRE as name,
                sum(X.Saldo_Inicial) saldo_inicial,
                ABS(sum(X.Previsto)) ppto,
                ABS(sum(X.Ingreso)) ingreso,
                ABS(sum(X.Realizado)) realizado,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso))  as total_ppto,
                sum(X.Saldo_Inicial) +ABS(sum(X.Previsto)) +ABS(sum(X.Ingreso)) - sum(X.Realizado) as saldo,
                round((ABS(sum(X.Realizado))/
                decode((sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))), 0 ,1,(sum(X.Saldo_Inicial)+ABS(sum(X.Previsto))+ABS(sum(X.Ingreso))))
                )*100,2) porc
            from (
            Select
                ID_DEPTO Dpto,
                case when ID_CUENTAAASI = '2317005' and ID_DEPTO = '910111' then sum(COS_VALOR*-1) else sum(COS_VALOR*-1) end Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO 
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 12
            and ID_CUENTAAASI in ('2317001','2317005','2317010')
            group by ID_DEPTO,ID_ENTIDAD,ID_CUENTAAASI
            UNION
            select
                    ID_DEPTO Dpto,
                    0 Saldo_Inicial,
                    sum(COS_VALOR) Previsto,
                    0 Ingreso,
                    0 Realizado
            from VW_CONTA_PRESUPUESTO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 12
            and ID_CUENTAAASI like '6%'
            group by ID_DEPTO,ID_ENTIDAD
            Union
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                sum(COS_VALOR) Ingreso,
                0 Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 12
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 1
              )  
              and not ID_TIPOASIENTO = 'IN'
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            UNION
            select
                ID_DEPTO Dpto,
                0 Saldo_Inicial,
                0 Previsto,
                0 Ingreso,
                sum(COS_VALOR) Realizado
            from VW_CONTA_DIARIO
            where ID_ENTIDAD = p_id_entidad
            and ID_ANHO = p_id_anho
            and ID_MES between 1 and 12
            and (
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '3%' 
                  --and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '4%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )
              or 
              (id_cuentaaasi in (
                select id_cuentaaasi from CONTA_CTA_DENOMINACIONAL
                  where id_cuentaaasi like '6%' 
                  and es_grupo = 0
                  and ES_ACREEDORA = 0
              )  
              and not ID_TIPOASIENTO in ('IN','EA')
              )
            )
            group by ID_DEPTO,ID_ENTIDAD
            ) X
        INNER JOIN Conta_Entidad_Depto ed ON 
        X.Dpto = ed.ID_DEPTO
        where ed.ID_ENTIDAD = p_id_entidad
        group by X.Dpto,ed.NOMBRE        
) Y        
order by id_mes, name
        ;
  
END;

