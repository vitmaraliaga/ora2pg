-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        SP_FINANCIAL_ANALYSIS (p_id_entidad int,p_id_anho int,p_id_mes int, cursor OUT SYS_REFCURSOR)IS
BEGIN
    
    INSERT INTO TT_FINANCIAL_ANALYSIS(ID_ENTIDAD,ID_DEPTO,NUM_2,NUM_3)
    SELECT A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,1) DEPTO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '3000000' AND '3999999' THEN A.COS_VALOR ELSE 0 END)) INGRESO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '4110000' AND '4999999' THEN A.COS_VALOR ELSE 0 END)) GASTOS
    FROM VW_CONTA_DIARIO A
    WHERE A.ID_ENTIDAD = p_id_entidad
    AND A.ID_ANHO = p_id_anho
    AND A.ID_MES BETWEEN 1 AND p_id_mes
    GROUP BY A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,1)
    UNION ALL
    SELECT A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,2) DEPTO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '3000000' AND '3999999' THEN A.COS_VALOR ELSE 0 END)) INGRESO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '4110000' AND '4999999' THEN A.COS_VALOR ELSE 0 END)) GASTOS
    FROM VW_CONTA_DIARIO A
    WHERE A.ID_ENTIDAD = p_id_entidad
    AND A.ID_ANHO = p_id_anho
    AND A.ID_MES BETWEEN 1 AND p_id_mes
    GROUP BY A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,2)
    UNION ALL
    SELECT A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,4) DEPTO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '3000000' AND '3999999' THEN A.COS_VALOR ELSE 0 END)) INGRESO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '4110000' AND '4999999' THEN A.COS_VALOR ELSE 0 END)) GASTOS
    FROM VW_CONTA_DIARIO A
    WHERE A.ID_ENTIDAD = p_id_entidad
    AND A.ID_ANHO = p_id_anho
    AND A.ID_MES BETWEEN 1 AND p_id_mes
    GROUP BY A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,4)
    UNION ALL
    SELECT A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,6) DEPTO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '3000000' AND '3999999' THEN A.COS_VALOR ELSE 0 END)) INGRESO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '4110000' AND '4999999' THEN A.COS_VALOR ELSE 0 END)) GASTOS
    FROM VW_CONTA_DIARIO A
    WHERE A.ID_ENTIDAD = p_id_entidad
    AND A.ID_ANHO = p_id_anho
    AND A.ID_MES BETWEEN 1 AND p_id_mes
    GROUP BY A.ID_ENTIDAD,SUBSTR(A.ID_DEPTO,1,6)
    UNION ALL 
    SELECT A.ID_ENTIDAD,A.ID_DEPTO DEPTO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '3000000' AND '3999999' THEN A.COS_VALOR ELSE 0 END)) INGRESO,
            SUM((CASE WHEN A.ID_CUENTAAASI BETWEEN '4110000' AND '4999999' THEN A.COS_VALOR ELSE 0 END)) GASTOS
    FROM VW_CONTA_DIARIO A
    WHERE A.ID_ENTIDAD = p_id_entidad
    AND A.ID_ANHO = p_id_anho
    AND A.ID_MES BETWEEN 1 AND p_id_mes
    GROUP BY A.ID_ENTIDAD,A.ID_DEPTO
    ORDER BY DEPTO;

    OPEN cursor FOR 
        SELECT
        A.ID_DEPTO,B.NOMBRE,A.NUM_2,A.NUM_3
        FROM TT_FINANCIAL_ANALYSIS A, CONTA_ENTIDAD_DEPTO B
        WHERE A.ID_ENTIDAD = B.ID_ENTIDAD
        AND A.ID_DEPTO = B.ID_DEPTO
        ORDER BY A.ID_DEPTO asc; 
END SP_FINANCIAL_ANALYSIS;

