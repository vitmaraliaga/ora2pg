-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE        spc_sta_salary_desc (
    p_id_entidad           int,
    p_id_anho           int,
    p_id_mes           int,
    p_id_persona       int,
    p_tipo       varchar2,
    cursor       OUT SYS_REFCURSOR
)
IS

    l_ingresos number(38,2);
    l_num_documento varchar2(100);

BEGIN
    DELETE FROM TT_TABLE_AUX;
l_num_documento:= '';

    select max(num_documento) into l_num_documento from (
    select num_documento from persona_documento
    where id_persona = p_id_persona
    order by id_persona desc
    ) b
    where ROWNUM = 1;


    OPEN cursor FOR 
    select TO_CHAR(fecha, 'DD/MM/YY') AS fecha, comentario, sum(valor) as valor from 
    (select 
                case p.ID_CONCEPTOAPS
                when 1500 then 1500
                when 1501 then 1500
                when 1508 then 1500 
                when 3000 then 3000 
                when 3079 then 3000 
                when 3080 then 3000
                when 3090 then 3000 
                when 3095 then 3000 
                when 3097 then 3000 
                when 3100 then 3000 
                when 3102 then 3000 
                when 3121 then 3000 
                when 3122 then 3000 
                when 3126 then 3000 
                when 3145 then 3000 
                when 3151 then 3000 
                when 3156 then 3000 
                when 3157 then 3000 
                when 3170 then 3000 
                when 3171 then 3000 
                when 3212 then 3000 
                when 3216 then 3000 
                when 3220 then 3000 
                when 3222 then 3000 
                when 3224 then 3000 
                when 3228 then 3000 
                when 3246 then 3000 
                else a.ID_CONCEPTOAPS end as codigo, 
                p.fec_pago as fecha,                 
                case p.ID_CONCEPTOAPS
                when 1500 then 'AFP' 
                when 1501 then 'AFP' 
                when 1508 then 'AFP' 
                when 1126 then 'Depreciación' 
                when 1147 then 'Bono de Alimentos' 
                when 7600 then 'Des. Ayuda alquiler' 
                
                when 3000 then 'Gratificación' 
                when 3079 then 'Gratificación' 
                when 3080 then 'Gratificación' 
                when 3090 then 'Gratificación' 
                when 3095 then 'Gratificación' 
                when 3097 then 'Gratificación' 
                when 3100 then 'Gratificación' 
                when 3102 then 'Gratificación' 
                when 3121 then 'Gratificación' 
                when 3122 then 'Gratificación' 
                when 3126 then 'Gratificación' 
                when 3145 then 'Gratificación' 
                when 3151 then 'Gratificación' 
                when 3156 then 'Gratificación' 
                when 3157 then 'Gratificación' 
                when 3170 then 'Gratificación' 
                when 3171 then 'Gratificación' 
                when 3212 then 'Gratificación' 
                when 3216 then 'Gratificación' 
                when 3220 then 'Gratificación' 
                when 3222 then 'Gratificación' 
                when 3224 then 'Gratificación' 
                when 3228 then 'Gratificación' 
                when 3246 then 'Gratificación' 

                else a.NOMBRE end as comentario, 
                p.COS_VALOR as valor
                from
                VW_APS_PLANILLA p, APS_CONCEPTO_PLANILLA a
                where p.ID_CONCEPTOAPS=a.ID_CONCEPTOAPS
                and p.ID_ENTIDAD=p_id_entidad
                and p.ID_ANHO=p_id_anho
                and p.ID_MES= p_id_mes
                and p.ID_PERSONA=p_id_persona
                and (
                  P.ID_CONCEPTOAPS like '15%'
                  or P.ID_CONCEPTOAPS like '7600%'
                )
                and not P.ID_CONCEPTOAPS like '1552%'
                and not P.ID_CONCEPTOAPS like '1556%'
                and not P.ID_CONCEPTOAPS like '1557%'
                and not P.ID_CONCEPTOAPS like '1558%'
    union all
    select 9999, FEC_ASIENTO as fecha, COMENTARIO, COS_VALOR as valor from VW_CONTA_DIARIO
                where ID_CUENTAAASI = '2135001'
                and id_entidad = 17112
                and ID_ANHO = 2017
                and ID_MES = 7
                and ID_TIPOASIENTO = 'MI'
                and COD_AASI = 3
                and id_entidad = p_id_entidad
                and ID_ANHO = p_id_anho
                and id_mes = p_id_mes
                and ID_CTACTE = l_num_documento
        ) a 
        group by codigo, fecha, comentario
        order by codigo;
  
END;

