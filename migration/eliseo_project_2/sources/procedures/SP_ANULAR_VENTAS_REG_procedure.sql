-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

PROCEDURE SP_ANULAR_VENTAS_REG(P_ID_VENTA NUMBER, P_ID_PERSONA NUMBER, P_MOTIVO VARCHAR2, P_ERROR OUT NUMBER, P_MSGERROR OUT VARCHAR2) IS
        L_ID_VOUCHER NUMBER;
        L_ACTIVO VARCHAR2(1);
        L_ID_KARDEX NUMBER;
        L_ID_ALMACEN NUMBER;
        L_ID_ARTICULO NUMBER;
        L_ID_ANHO NUMBER;
        L_ID_TIPOORIGEN NUMBER := 1;
        L_ID_ASIENTO NUMBER;
        L_DATA VARCHAR2(255);

        L_ID_DEPOSITO NUMBER;
        L_ID_VOUCHER_DEP NUMBER;
        L_ID_TIPOORIGEN_DEP NUMBER;
        L_CANT NUMBER;

        CURSOR articulos IS	
        SELECT 
                ID_KARDEX,A.ID_ALMACEN,A.ID_ARTICULO,A.ID_ANHO 
        FROM INVENTARIO_KARDEX A JOIN VENTA_DETALLE B
        ON A.ID_ORIGEN = B.ID_VDETALLE 
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND B.ID_VENTA = P_ID_VENTA;

        CURSOR asientos IS
        SELECT 
                ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN VENTA_DETALLE B
        ON A.ID_ORIGEN = B.ID_VDETALLE
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN
        AND B.ID_VENTA = P_ID_VENTA
        AND A.VOUCHER = L_ID_VOUCHER;

        CURSOR asientos_dep is
        SELECT 
                A.ID_ASIENTO
        FROM CONTA_ASIENTO A JOIN CAJA_DEPOSITO B
        ON A.ID_ORIGEN = B.ID_DEPOSITO
        WHERE A.ID_TIPOORIGEN = L_ID_TIPOORIGEN_DEP
        AND A.ID_ORIGEN = L_ID_DEPOSITO
        AND A.VOUCHER = L_ID_VOUCHER_DEP;

        BEGIN
            SELECT ID_VOUCHER, 'SERIE: '||SERIE||', NUMERO: '||NUMERO||'GRAVADA: '||GRAVADA||', INAFECTA: '||INAFECTA||', EXONERADA: '||EXONERADA||', DESCUENTO: '||DESCUENTO||', IGV: '||IGV||', TOTAL: '||TOTAL 
            INTO L_ID_VOUCHER, L_DATA
            FROM VENTA WHERE ID_VENTA = P_ID_VENTA;
            
            SELECT ACTIVO INTO L_ACTIVO FROM CONTA_VOUCHER  WHERE ID_VOUCHER = L_ID_VOUCHER;
            IF L_ACTIVO = 'S' THEN
                    Insert into ARREGLO (
                    ID_ENTIDAD, ID_DEPTO, ID_TIPOARREGLO, ID_PERSONA, ID_MODULO, ID_ORIGEN, ID_TIPOORIGEN, 
                    MOTIVO, FECHA, INFO_BACKUP, ESTADO
                    ) 
                    select ID_ENTIDAD, id_depto, 1 as id_tipoarreglo, P_ID_PERSONA, 13, id_venta, id_tipoorigen, P_MOTIVO, sysdate, 
                    'IMPORTE: '||total||' Glosa: '||glosa, 1
                    from VENTA 
                    where id_venta = P_ID_VENTA;
            
                --ANULA KARDEX
                OPEN articulos;
                  FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO;
                    WHILE articulos%FOUND LOOP

                        UPDATE INVENTARIO_KARDEX SET CANTIDAD = 0, COSTO_UNITARIO = 0, COSTO_TOTAL = 0
                        WHERE ID_KARDEX = L_ID_KARDEX;

                        UPDATE INVENTARIO_ALMACEN_ARTICULO SET ESTADO = '1'
                        WHERE ID_ALMACEN = L_ID_ALMACEN
                        AND ID_ARTICULO = L_ID_ARTICULO
                        AND ID_ANHO = L_ID_ANHO;

                        FETCH articulos INTO L_ID_KARDEX,L_ID_ALMACEN,L_ID_ARTICULO,L_ID_ANHO;
                    END LOOP;
                CLOSE articulos;
                --ANULA ASIENTO DE LA VENTA
                OPEN asientos;
                  FETCH asientos INTO L_ID_ASIENTO;
                    WHILE asientos%FOUND LOOP

                        UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                        WHERE ID_ASIENTO = L_ID_ASIENTO;

                        FETCH asientos INTO L_ID_ASIENTO;
                    END LOOP;
                CLOSE asientos;
                --ANULAR DEPOSITO
                /*
                SELECT COUNT(1) INTO L_CANT FROM CAJA_DEPOSITO_DETALLE
                WHERE ID_VENTA = P_ID_VENTA;

                IF L_CANT > 0 THEN

                    SELECT ID_DEPOSITO INTO L_ID_DEPOSITO FROM CAJA_DEPOSITO_DETALLE
                    WHERE ID_VENTA = P_ID_VENTA;
                    SELECT ID_VOUCHER,ID_TIPOORIGEN INTO L_ID_VOUCHER_DEP,L_ID_TIPOORIGEN_DEP
                    FROM CAJA_DEPOSITO
                    WHERE ID_DEPOSITO = L_ID_DEPOSITO;

                    OPEN asientos_dep;
                      FETCH asientos_dep INTO L_ID_ASIENTO;
                        WHILE asientos_dep%FOUND LOOP

                            UPDATE CONTA_ASIENTO SET IMPORTE = 0, DESCRIPCION = '<< Anulado>>', IMPORTE_ME = 0
                            WHERE ID_ASIENTO = L_ID_ASIENTO;

                            FETCH asientos_dep INTO L_ID_ASIENTO;
                        END LOOP;
                    CLOSE asientos_dep;

                    UPDATE CAJA_DEPOSITO_DETALLE SET IMPORTE = 0, IMPORTE_ME = 0
                    WHERE ID_DEPOSITO = L_ID_DEPOSITO;

                    UPDATE CAJA_DEPOSITO SET IMPORTE = 0, IMPORTE_ME = 0, GLOSA = '<< Anulado >>'
                    WHERE ID_DEPOSITO = L_ID_DEPOSITO;
                END IF;
                */
                --ANULAR VENTA
                UPDATE VENTA_DETALLE SET    DETALLE = '<< Anulado>>',CANTIDAD = 0,PRECIO = 0,PRECIO_BASE = 0,PRECIO_ALM = 0,BASE = 0,IGV = 0,DESCUENTO = 0,IMPORTE = 0,IMPORTE_ADESCONTAR = 0,OTROS_CARGOS = 0,
                                            PRECIO_ME = 0,PRECIO_BASE_ME = 0,PRECIO_ALM_ME = 0,BASE_ME = 0,IGV_ME = 0,DESCUENTO_ME = 0,IMPORTE_ME = 0,OTROS_CARGOS_ME = 0
                WHERE ID_VENTA = P_ID_VENTA;

                UPDATE VENTA SET    GLOSA = '<< Anulado>>', GRAVADA = 0,INAFECTA = 0,EXONERADA = 0,GRATUITA = 0,DESCUENTO = 0,IGV = 0,TOTAL = 0,DESCUENTO_GLOBAL = 0,IMPORTE_ADESCONTAR = 0,OTROS_CARGOS = 0,
                                    GRAVADA_ME = 0,INAFECTA_ME = 0,EXONERADA_ME = 0,GRATUITA_ME = 0,DESCUENTO_ME = 0,IGV_ME = 0,TOTAL_ME = 0,DESCUENTO_GLOBAL_ME = 0,IMPORTE_ADESCONTAR_ME = 0,OTROS_CARGOS_ME = 0
                WHERE ID_VENTA = P_ID_VENTA;

                UPDATE ARREGLO SET ESTADO = '2',INFO_BACKUP = L_DATA
                WHERE ID_ORIGEN = P_ID_VENTA
                AND ID_TIPOORIGEN = L_ID_TIPOORIGEN
                AND ESTADO = '1';
                P_ERROR := 0;
                P_MSGERROR := 'OK: Anulado con Exito';
            ELSE
                P_ERROR := 1;
                P_MSGERROR := 'El Voucher ya esta CONTABILIZADO';
            END IF;
    END SP_ANULAR_VENTAS_REG;

