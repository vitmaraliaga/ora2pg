-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = eliseo,public;
\set ON_ERROR_STOP ON

DROP TRIGGER IF EXISTS tr_inventario_stock_articulo ON inventario_almacen_articulo CASCADE;
CREATE OR REPLACE FUNCTION eliseo.trigger_fct_tr_inventario_stock_articulo() RETURNS trigger AS $BODY$
DECLARE 
L_CANTIDAD NUMBER(16,4) :=0;
L_COSTO NUMBER(16,4) :=0;
L_COSTO_TOTAL NUMBER(16,4) :=0;
BEGIN

        SELECT NVL(SUM(CANTIDAD),0),NVL(SUM(COSTO_TOTAL),0), NVL(ROUND(DECODE(SUM(CANTIDAD),0,0,SUM(COSTO_TOTAL)/SUM(CANTIDAD)),4),0)
                INTO L_CANTIDAD,L_COSTO_TOTAL,L_COSTO 
        FROM INVENTARIO_KARDEX
        WHERE ID_ANHO = :OLD.ID_ANHO
        AND ID_ALMACEN = :OLD.ID_ALMACEN
        AND ID_ARTICULO = :OLD.ID_ARTICULO;

        IF L_COSTO <= 0 THEN
            :NEW.COSTO := :OLD.COSTO;
        ELSE
            :NEW.COSTO := L_COSTO;
        END IF;
        
        IF L_CANTIDAD = 0 THEN
            L_COSTO_TOTAL := 0;
        END IF;

        :NEW.STOCK_ACTUAL := L_CANTIDAD;
        :NEW.COSTO_TOTAL := L_COSTO_TOTAL;
END
$BODY$
 LANGUAGE 'plpgsql' SECURITY DEFINER;
-- REVOKE ALL ON FUNCTION eliseo.trigger_fct_tr_inventario_stock_articulo() FROM PUBLIC;

DROP TRIGGER IF EXISTS tr_inventario_stock_articulo ON inventario_almacen_articulo;
CREATE TRIGGER tr_inventario_stock_articulo
	BEFORE UPDATE OF estado ON inventario_almacen_articulo 
 FOR EACH ROW
	EXECUTE PROCEDURE eliseo.trigger_fct_tr_inventario_stock_articulo();

