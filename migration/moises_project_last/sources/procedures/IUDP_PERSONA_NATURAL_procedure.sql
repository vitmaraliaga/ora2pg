-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = moises,public;
\set ON_ERROR_STOP ON

PROCEDURE        IUDP_PERSONA_NATURAL (

P_Modo int, P_NUM_DOCUMENTO varchar2, P_ID_TIPODOCUMENTO int, P_NOMBRE varchar2, P_PATERNO varchar2, P_MATERNO varchar2, P_ID_ESTADOCIVIL int, P_ID_TIPOTRATAMIENTO int,
P_ID_PAIS int, P_ID_NACIONALIDAD int, P_ID_TIPOSANGRE int, P_SEXO VARCHAR2, P_FEC_NACIMIENTO varchar2, P_FEC_DEFUNCION varchar2, P_ID_PERSONA OUT int

) AS
  S_ID_PERSONANATURAL int;
  S_ID_PERSONADOCUMENTO int;
  S_NUM_DOCUMENTO VARCHAR2(100);
  S_ID_PAIS int;
  S_ID_NACIONALIDAD int;
BEGIN
	P_ID_PERSONA := 0;  
	S_ID_PERSONANATURAL := 0;
	S_ID_PERSONADOCUMENTO := 0;
	S_NUM_DOCUMENTO := NULLIF(TRIM(P_NUM_DOCUMENTO),'');
  
	
  
	IF P_Modo = 0 THEN
  
		SELECT nvl (
				(SELECT 
					      NVL(Persona.ID_PERSONA, 0)
					    FROM PERSONA
					    LEFT JOIN moises.Persona_Natural ON
					      Persona.ID_PERSONA = Persona_Natural.ID_PERSONA
					    LEFT JOIN moises.Persona_Documento ON
					      Persona.ID_PERSONA = Persona_Documento.ID_PERSONA
					    WHERE Persona_Documento.NUM_DOCUMENTO = S_NUM_DOCUMENTO)
				,0) INTO P_ID_PERSONA FROM dual;
                
	SELECT nvl (
				(SELECT  
					      NVL(Persona_Natural.ID_PERSONA, 0)
					    FROM PERSONA
					    LEFT JOIN moises.Persona_Natural ON
					      Persona.ID_PERSONA = Persona_Natural.ID_PERSONA
					    LEFT JOIN moises.Persona_Documento ON
					      Persona.ID_PERSONA = Persona_Documento.ID_PERSONA
					    WHERE Persona_Documento.NUM_DOCUMENTO = S_NUM_DOCUMENTO)
				,0) INTO S_ID_PERSONANATURAL FROM dual;
	SELECT nvl (
				(SELECT  
					      NVL(Persona_Documento.ID_PERSONA, 0)
					    FROM PERSONA
					    LEFT JOIN moises.Persona_Natural ON
					      Persona.ID_PERSONA = Persona_Natural.ID_PERSONA
					    LEFT JOIN moises.Persona_Documento ON
					      Persona.ID_PERSONA = Persona_Documento.ID_PERSONA
					    WHERE Persona_Documento.NUM_DOCUMENTO = S_NUM_DOCUMENTO)
				,0) INTO S_ID_PERSONADOCUMENTO FROM dual;

	      
	    IF P_ID_PERSONA <= 0 THEN
	    
	      IF NOT S_NUM_DOCUMENTO IS NULL THEN
	        SELECT MAX(ID_PERSONA) INTO P_ID_PERSONA FROM Persona;
	        P_ID_PERSONA := NVL(P_ID_PERSONA, 0) + 1;
	        
	        INSERT INTO moises.Persona (ID_PERSONA, NOMBRE, PATERNO, MATERNO)
	          VALUES (P_ID_PERSONA, P_NOMBRE, P_PATERNO, P_MATERNO);
          END IF;  
        
      ELSE
		      UPDATE moises.Persona SET
		        NOMBRE  = P_NOMBRE,
		        PATERNO = P_PATERNO,
		        MATERNO = P_MATERNO 
		      WHERE ID_PERSONA = P_ID_PERSONA;      
      END IF;
	      
	      IF S_ID_PERSONADOCUMENTO = 0 AND NOT S_NUM_DOCUMENTO IS NULL THEN 
			      INSERT INTO moises.Persona_Documento (ID_PERSONA, ID_TIPODOCUMENTO, NUM_DOCUMENTO, IMG_DOCUMENTO)
			        VALUES (P_ID_PERSONA, P_ID_TIPODOCUMENTO, S_NUM_DOCUMENTO, NULL);     
	      END IF;
	      
          --DBMS_OUTPUT.PUT_LINE('P_ID_PAIS');
          --DBMS_OUTPUT.PUT_LINE(P_ID_PAIS);
          --DBMS_OUTPUT.PUT_LINE(S_ID_PAIS);
	      IF P_ID_PAIS > 1000 THEN
          --DBMS_OUTPUT.PUT_LINE('en el if');
      		SELECT
	        ID_TIPOPAIS INTO S_ID_PAIS
	      FROM MOISES.Tipo_Pais
	      WHERE COD_SUNAT = P_ID_PAIS;   
	      END IF;

          --DBMS_OUTPUT.PUT_LINE(S_ID_PAIS);
	      IF S_ID_NACIONALIDAD > 1000 THEN
			SELECT
			  ID_TIPOPAIS INTO S_ID_NACIONALIDAD
			FROM moises.Tipo_Pais
			WHERE COD_SUNAT = P_ID_NACIONALIDAD;
	      END IF;
	       
		IF S_ID_PERSONANATURAL = 0 THEN
		      IF P_ID_PERSONA > 0  THEN 
		      --DBMS_OUTPUT.PUT_LINE(S_ID_PAIS); 
		      	INSERT INTO moises.Persona_Natural (ID_PERSONA, ID_TIPOESTADOCIVIL, ID_TIPOTRATAMIENTO, ID_TIPOPAIS, ID_NACIONALIDAD, ID_TIPOSANGRE, SEXO, FEC_NACIMIENTO, FEC_DEFUNCION)
		        VALUES (P_ID_PERSONA, P_ID_ESTADOCIVIL, NVL(P_ID_TIPOTRATAMIENTO, 1), NULLIF(S_ID_PAIS, 0), NULLIF(S_ID_NACIONALIDAD, 0), NULLIF(P_ID_TIPOSANGRE, 0), P_SEXO, to_date(P_FEC_NACIMIENTO,'yyyy-mm-dd'), to_date(P_FEC_DEFUNCION,'yyyy-mm-dd'));
		      END IF;
	      ELSE
		      UPDATE moises.Persona_Natural SET
		        ID_TIPOESTADOCIVIL     = NVL(NULLIF(P_ID_ESTADOCIVIL, 0), ID_TIPOESTADOCIVIL),
		        ID_TIPOTRATAMIENTO = NVL(NULLIF(P_ID_TIPOTRATAMIENTO, 0), ID_TIPOTRATAMIENTO),
		        ID_TIPOPAIS            = NVL(NULLIF(S_ID_PAIS, 0), ID_TIPOPAIS),
		        ID_NACIONALIDAD    = NVL(NULLIF(S_ID_NACIONALIDAD, 0), ID_NACIONALIDAD),
		        ID_TIPOSANGRE      = NVL(NULLIF(P_ID_TIPOSANGRE, 0), ID_TIPOSANGRE),
		        SEXO               = NVL(P_SEXO, SEXO),
		        FEC_NACIMIENTO     = to_date(P_FEC_NACIMIENTO,'yyyy-mm-dd'),
		        FEC_DEFUNCION      = to_date(P_FEC_DEFUNCION,'yyyy-mm-dd')
		      WHERE ID_PERSONA = P_ID_PERSONA;
	    END IF; 
  END IF; 
END;

