-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = moises,public;
\set ON_ERROR_STOP ON

PROCEDURE iudp_Persona_Telefono (
  P_Modo IN varchar2, 
  P_ID_PERSONA IN int, 
  P_ID_TELEFONO IN int, 
  P_ID_TIPOTELEFONO IN int DEFAULT NULL, 
  P_NUM_TELEFONO IN varchar2 DEFAULT NULL, 
  P_ES_ACTIVO IN int, 
  P_ES_PRIVADO IN int, 
  P_COMENTARIO IN varchar2 DEFAULT NULL
  ) AS
  S_bExiste VARCHAR2(1) := '0';
  S_ID_TELEFONO INT;
  S_NUM_TELEFONO VARCHAR2(100);
BEGIN
  
  
  IF P_Modo = 0 THEN
    S_NUM_TELEFONO := TRIM(NVL(P_NUM_TELEFONO, ''));
    S_ID_TELEFONO := TRIM(NVL(P_ID_TELEFONO, ''));

  
    IF not (S_NUM_TELEFONO is null) THEN
      IF S_ID_TELEFONO = 0 THEN
        SELECT 
          coalesce(max(ID_TELEFONO),0) INTO S_ID_TELEFONO
        FROM Persona_TELEFONO
        WHERE ID_PERSONA = P_ID_PERSONA
          AND ID_TIPOTELEFONO = P_ID_TIPOTELEFONO
          AND NUM_TELEFONO = S_NUM_TELEFONO;
        
        IF S_ID_TELEFONO = 0 THEN
          SELECT
            MAX(ID_TELEFONO) INTO S_ID_TELEFONO
          FROM Persona_TELEFONO
          WHERE ID_PERSONA = P_ID_PERSONA;
          
          S_ID_TELEFONO := NVL(S_ID_TELEFONO, 0) + 1;
          DBMS_OUTPUT.PUT_LINE(P_ID_PERSONA);
          DBMS_OUTPUT.PUT_LINE(P_ID_PERSONA);
           
          INSERT INTO Persona_TELEFONO (ID_TELEFONO, ID_PERSONA, ID_TIPOTELEFONO, NUM_TELEFONO, ES_ACTIVO, ES_PRIVADO, COMENTARIO)
            VALUES (S_ID_TELEFONO, P_ID_PERSONA, P_ID_TIPOTELEFONO, S_NUM_TELEFONO, P_ES_ACTIVO, P_ES_PRIVADO, P_COMENTARIO);
        ELSE
          S_bExiste := '1';
        END IF;
      
      ELSE 
        S_bExiste := '1';
      END IF;
      
      IF S_bExiste = 1 THEN
        UPDATE Persona_TELEFONO SET
          COMENTARIO = P_COMENTARIO
        WHERE ID_PERSONA = P_ID_PERSONA
        AND ID_TELEFONO = S_ID_TELEFONO;
      END IF;
    END IF;
  
  ELSE
    DELETE FROM Persona_TELEFONO WHERE ID_PERSONA = P_ID_PERSONA AND ID_TELEFONO = S_ID_TELEFONO;
  END IF; 

END;

