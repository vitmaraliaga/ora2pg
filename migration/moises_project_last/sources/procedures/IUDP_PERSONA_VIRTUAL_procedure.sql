-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = moises,public;
\set ON_ERROR_STOP ON

PROCEDURE        iudp_Persona_Virtual (P_Modo IN varchar2, P_ID_PERSONA IN int, P_ID_VIRTUAL IN int, P_ID_TIPOVIRTUAL IN int DEFAULT NULL, P_DIRECCION IN varchar2 DEFAULT NULL, P_COMENTARIO IN varchar2 DEFAULT NULL) AS
  S_bExiste VARCHAR2(1) := '0';
  S_ID_VIRTUAL INT;
  S_DIRECCION VARCHAR2(100);
BEGIN
  
  
  IF P_Modo = 0 THEN
    S_DIRECCION := TRIM(NVL(P_DIRECCION, ''));
    S_ID_VIRTUAL := TRIM(NVL(P_ID_VIRTUAL, ''));

  
    IF not (S_DIRECCION is null) THEN
      IF S_ID_VIRTUAL = 0 THEN
        SELECT 
          coalesce(max(ID_VIRTUAL),0) INTO S_ID_VIRTUAL
        FROM Persona_Virtual
        WHERE ID_PERSONA = P_ID_PERSONA
          AND ID_TIPOVIRTUAL = P_ID_TIPOVIRTUAL
          AND DIRECCION = S_DIRECCION;
        
        IF S_ID_VIRTUAL = 0 THEN
          SELECT
            MAX(ID_VIRTUAL) INTO S_ID_VIRTUAL
          FROM Persona_Virtual
          WHERE ID_PERSONA = P_ID_PERSONA;
          
          S_ID_VIRTUAL := NVL(S_ID_VIRTUAL, 0) + 1;
          DBMS_OUTPUT.PUT_LINE(P_ID_PERSONA);
          DBMS_OUTPUT.PUT_LINE(P_ID_PERSONA);
           
          INSERT INTO Persona_Virtual (ID_PERSONA, ID_VIRTUAL, ID_TIPOVIRTUAL, DIRECCION, COMENTARIO)
            VALUES (P_ID_PERSONA, S_ID_VIRTUAL, P_ID_TIPOVIRTUAL, S_DIRECCION, P_COMENTARIO);
        ELSE
          S_bExiste := '1';
        END IF;
      
      ELSE 
        S_bExiste := '1';
      END IF;
      
      IF S_bExiste = 1 THEN
        UPDATE Persona_Virtual SET
          COMENTARIO = P_COMENTARIO
        WHERE ID_PERSONA = P_ID_PERSONA
        AND ID_VIRTUAL = S_ID_VIRTUAL;
      END IF;
    END IF;
  
  ELSE
    DELETE FROM Persona_Virtual WHERE ID_PERSONA = P_ID_PERSONA AND ID_VIRTUAL = S_ID_VIRTUAL;
  END IF; 

END;

