-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_registrar_asis_docente ( P_ID_ASISTENCIA_CARGA bigint, P_FECHA timestamp(0), P_TIPO text,--E: ENTRADA, S:SALIDA
 P_ID_USER bigint, P_TIPO_MAR text, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

     l_error bigint:=0;
     l_msgerror varchar(200):='';
     l_contar bigint;
     l_fecha timestamp(0);
     l_id_trabajador bigint;
     l_id_depto varchar(10);
     L_ASIST_RANGO bigint;
     l_desde timestamp(0);
     l_hasta timestamp(0);
     l_prog_desde timestamp(0);
     l_prog_hasta timestamp(0);
     l_fec_actual timestamp(0);
     l_id_entidad bigint:=7124;
     l_id_anho bigint;

BEGIN
      
      select to_date(to_char(P_FECHA,'YYYY-MM-DD'),'YYYY-MM-DD'),to_char(clock_timestamp(),'YYYY-MM-DD'),(to_char(P_FECHA,'YYYY'))::numeric  into STRICT l_fecha,l_fec_actual,l_id_anho;

      select a.id_trabajador,c.id_depto_padre,a.desde_prog,a.hasta_prog 
      into STRICT 
      l_id_trabajador,l_id_depto, l_prog_desde,l_prog_hasta
      FROM  ENOC.PLLA_ASISTENCIA_CARGA  a , moises.trabajador t, ENOC.VW_ENT_DEP_AREA_CCOSTO C
      WHERE  a.id_trabajador=t.id_trabajador
      and t.id_sedearea = c.id_sedearea
      and a.ID_ASISTENCIA_CARGA= P_ID_ASISTENCIA_CARGA;

      select count(*) into STRICT l_contar from plla_parametros_valor  a, plla_parametros b
      where b.id_parametro=a.id_parametro
      and a.id_entidad=l_id_entidad
      and a.id_anho=l_id_anho;

      
       IF l_contar=0 then
        l_error:=1;
        l_msgerror:='Falta configurar parametros para el año '||l_id_anho::text;
--         GOTO SALIDA;
      end if;

      select coalesce(a.importe,0) into STRICT L_ASIST_RANGO from plla_parametros_valor  a, plla_parametros b
      where b.id_parametro=a.id_parametro
      and b.codigo='PARAM_ASIST_DOC_RANG'
      and a.id_entidad=l_id_entidad
      and a.id_anho=l_id_anho;


      IF P_TIPO='S' THEN
      
        if l_fecha <> l_fec_actual then
             l_error:=1;
             l_msgerror:='Registre su asistencia en la fecha '||to_char(l_fecha,'DD/MM/YYYY');
--              GOTO SALIDA;
        end if;

        if P_FECHA < l_prog_desde then
             l_error:=1;
             l_msgerror:='Registre su salida despues de '||to_char(l_prog_desde,'DD/MM/YYYY');
--              GOTO SALIDA;
        end if;

        
        l_hasta := l_prog_hasta + L_ASIST_RANGO / 1440;

        if P_FECHA > l_hasta then 
           l_error:=1;
           l_msgerror:='Registre su asistencia antes de '||to_char(l_hasta,'HH24:MI');
--            GOTO SALIDA;
        end if;

        UPDATE ENOC.PLLA_ASISTENCIA_CARGA SET
          HASTA_REAL=P_FECHA,
          ID_USER_MOD=P_ID_USER,
          FECHA_MOD= clock_timestamp()
        WHERE ID_ASISTENCIA_CARGA= P_ID_ASISTENCIA_CARGA;
      ELSE


        
        l_desde := l_prog_desde - L_ASIST_RANGO / 1440;

        if P_FECHA < l_desde then
           l_error:=1;
           l_msgerror:='Registre su asistencia después de '||to_char(l_desde,'HH24:MI');
--            GOTO SALIDA;
        end if;

        if P_FECHA > l_prog_hasta then
           l_error:=1;
           l_msgerror:='Registre su asistencia antes de '||to_char(l_prog_hasta,'HH24:MI');
--            GOTO SALIDA;
        end if;

        UPDATE ENOC.PLLA_ASISTENCIA_CARGA SET
          DESDE_REAL=P_FECHA,
          TIPO_MAR=P_TIPO_MAR,
          ID_USER_MOD=P_ID_USER,
          FECHA_MOD= clock_timestamp()
        WHERE ID_ASISTENCIA_CARGA= P_ID_ASISTENCIA_CARGA;
      END IF;

      CALL enoc.pkg_assistance_sp_procesar_asis_docente(
         l_fecha,--SI P_TIPO=FE OBLIAGATORIO
         l_id_depto,
         0,
         null,
         l_id_trabajador,
         'N',
         0,
         'FE',--AM: Año y Mes,FE: por fecha
         0, --SI P_TIPO=AM OBLIAGATORIO
         0, --SI P_TIPO=AM OBLIAGATORIO
         P_ID_USER,
         l_error,
         l_msgerror
       );

--       <<SALIDA>>  
      P_ERROR:=l_error;
      P_MSGERROR := l_msgerror;
   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_registrar_asis_docente ( P_ID_ASISTENCIA_CARGA bigint, P_FECHA timestamp(0), P_TIPO text, P_ID_USER bigint, P_TIPO_MAR text, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
