-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_validar_coordenada_asist ( P_ID_TRABAJADOR bigint, P_LAT bigint, P_LNG bigint, P_RESULTADO OUT bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

   l_error bigint:=0;
   l_msgerror varchar(200):='';
   l_resultado bigint:=0;
   l_id_area bigint;
   l_id_entidad bigint;
   l_id_depto varchar(10);

   
BEGIN
   select 
   a.id_entidad,
   b.id_area,
   b.id_depto_padre
   into STRICT
   l_id_entidad,
   l_id_area,
   l_id_depto
   from moises.trabajador a, ENOC.vw_ent_dep_area_ccosto b 
   where a.id_sedearea=b.id_sedearea
   and a.id_trabajador=P_ID_TRABAJADOR;


  SELECT count(*) into STRICT l_resultado
  FROM ENOC.plla_mapa_coordenada a, enoc.PLLA_MAPA_POLIGONO b 
  WHERE a.id_mapa_poligono=b.id_mapa_poligono
  and (ENOC.FC_DISTANCIA_PUNTOS(a.latn,a.lngn, coalesce(P_LAT,0), coalesce(P_LNG,0))+0.18)<=coalesce(a.radiome,0)
  and b.vigencia=1
  and a.ID_MAPA_POLIGONO in (
     SELECT
     ID_MAPA_POLIGONO
     from enoc.PLLA_MAPA_TRABAJADOR
     where id_trabajador=P_ID_TRABAJADOR
     
union

     SELECT
     ID_MAPA_POLIGONO
     from enoc.PLLA_MAPA_AREA
     where ID_ENTIDAD=l_id_entidad
     and id_area=l_id_area
     and ID_DEPTO=l_id_depto
   );

   P_RESULTADO:=l_resultado;
   P_ERROR:=l_error;
   P_MSGERROR := l_msgerror;

   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_validar_coordenada_asist ( P_ID_TRABAJADOR bigint, P_LAT bigint, P_LNG bigint, P_RESULTADO OUT bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
