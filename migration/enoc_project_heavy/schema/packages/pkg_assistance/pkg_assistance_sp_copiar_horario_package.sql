-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_copiar_horario (P_IDS_TIPO_HORARIO text,P_ID_ENTIDAD_TO bigint,P_ID_DEPTO_TO text,P_ID_USER bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

		L_ERROR bigint:=0;
		L_MSGERROR varchar(5000):='';
		ID_TIPO_HORARIO_MAX bigint:=0;
		L_CONTAR bigint:=0;
	
  TIPOHORARIO RECORD;
  ITEM RECORD;
  DETAIL RECORD;

BEGIN
	
		 FOR TIPOHORARIO IN (WITH RECURSIVE cte AS (

		   		SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) ID
				
				(SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) IS NOT NULL  UNION ALL

		   		SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) ID
				
				(SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) IS NOT NULL JOIN cte c ON ()

) SELECT * FROM cte)
		 LOOP
			
			FOR ITEM IN (
				SELECT C.* FROM (SELECT A.ID_ENTIDAD,A.ID_DEPTO,B.*
				FROM (SELECT DISTINCT D.ID_ENTIDAD,D.ID_DEPTO
					FROM ELISEO.CONTA_ENTIDAD_DEPTO D
					INNER JOIN ELISEO.VW_SEDE_AREA E ON D.ID_ENTIDAD = E.ID_ENTIDAD AND D.ID_DEPTO = E.ID_DEPTO_PADRE 
					WHERE D.ID_ENTIDAD = 17112 AND D.ES_GRUPO = '1' AND LENGTH(D.ID_DEPTO) = 1 ) A, 
				(SELECT NOMBRE,DESCRIPCION,VIGENCIA,ID_TIPO_CONFIG_HORARIO,CODIGO,CONTROL_CULTO FROM ENOC.PLLA_TIPO_HORARIO WHERE ID_TIPO_HORARIO = TIPOHORARIO.ID) B
				WHERE 1=1 AND 1 = (CASE WHEN P_ID_DEPTO_TO = '0' THEN 1 ELSE CASE WHEN ID_DEPTO = P_ID_DEPTO_TO THEN 1 ELSE 0 END END) )C 
				WHERE C.ID_DEPTO <> '0'
			)
		 	LOOP
			 	SELECT COUNT(*) INTO STRICT L_CONTAR FROM ENOC.PLLA_TIPO_HORARIO 
			 	WHERE UPPER(trim(both NOMBRE)) = UPPER(trim(both ITEM.NOMBRE)) AND ID_ENTIDAD = P_ID_ENTIDAD_TO AND ID_DEPTO = ITEM.ID_DEPTO;
			 	IF L_CONTAR = 0 THEN
				 	select coalesce(max(ID_TIPO_HORARIO),0)+1 into STRICT ID_TIPO_HORARIO_MAX from enoc.PLLA_TIPO_HORARIO;
				 	INSERT INTO ENOC.PLLA_TIPO_HORARIO(ID_TIPO_HORARIO,ID_ENTIDAD,ID_DEPTO,NOMBRE,DESCRIPCION,VIGENCIA,ID_TIPO_CONFIG_HORARIO,CODIGO,CONTROL_CULTO)
				 	VALUES (ID_TIPO_HORARIO_MAX,ITEM.ID_ENTIDAD,ITEM.ID_DEPTO,ITEM.NOMBRE,ITEM.DESCRIPCION,ITEM.VIGENCIA,ITEM.ID_TIPO_CONFIG_HORARIO,ITEM.CODIGO,ITEM.CONTROL_CULTO);
			 	ELSE
			 		SELECT ID_TIPO_HORARIO INTO STRICT ID_TIPO_HORARIO_MAX FROM ENOC.PLLA_TIPO_HORARIO 
			 		WHERE UPPER(trim(both NOMBRE)) = UPPER(trim(both ITEM.NOMBRE)) AND ID_ENTIDAD = P_ID_ENTIDAD_TO AND ID_DEPTO = ITEM.ID_DEPTO   LIMIT 1;
					UPDATE ENOC.PLLA_TIPO_HORARIO SET ID_TIPO_CONFIG_HORARIO = ITEM.ID_TIPO_CONFIG_HORARIO,
					 DESCRIPCION = ITEM.DESCRIPCION, CODIGO = ITEM.CODIGO , CONTROL_CULTO = ITEM.CONTROL_CULTO
					WHERE ID_TIPO_HORARIO = ID_TIPO_HORARIO_MAX;
			 	END IF;
			
			 	FOR DETAIL IN (
					SELECT ID_DIA,ID_TIPO_HORARIO_MAX AS ID_TIPO_HORARIO,ID_CONTROL_ASIST,ID_HORAS_REF,HORA_ENTRADA,HORA_SALIDA,HORA_ENTRADA_REF,
					HORA_SALIDA_REF,SAL_DIASIG,HORAS,NUM_HORAS,P_ID_USER AS ID_USER_REG,CURRENT_DATE AS FECHA_REG 
					FROM ENOC.PLLA_HORARIO_DETALLE WHERE ID_TIPO_HORARIO = TIPOHORARIO.ID
				)
			 	LOOP
				 	
				 	SELECT COUNT(*) INTO STRICT L_CONTAR FROM ENOC.PLLA_HORARIO_DETALLE WHERE ID_TIPO_HORARIO = ID_TIPO_HORARIO_MAX AND ID_DIA = DETAIL.ID_DIA;
				 	IF L_CONTAR > 0 THEN
				 		UPDATE ENOC.PLLA_HORARIO_DETALLE SET ID_CONTROL_ASIST = DETAIL.ID_CONTROL_ASIST,ID_HORAS_REF = DETAIL.ID_HORAS_REF,
				 		HORA_ENTRADA = DETAIL.HORA_ENTRADA, HORA_SALIDA = DETAIL.HORA_SALIDA, HORA_ENTRADA_REF = DETAIL.HORA_ENTRADA_REF,
				 		HORA_SALIDA_REF = DETAIL.HORA_SALIDA_REF, SAL_DIASIG = DETAIL.SAL_DIASIG, HORAS = DETAIL.HORAS, NUM_HORAS = DETAIL.NUM_HORAS,
				 		ID_USER_MOD = P_ID_USER, FECHA_MOD = CURRENT_DATE
				 		WHERE ID_DIA = DETAIL.ID_DIA AND ID_TIPO_HORARIO = ID_TIPO_HORARIO_MAX;
				 	ELSE
					 	INSERT INTO ENOC.PLLA_HORARIO_DETALLE(ID_DIA,ID_TIPO_HORARIO,ID_CONTROL_ASIST,ID_HORAS_REF,HORA_ENTRADA,HORA_SALIDA,
					 	HORA_ENTRADA_REF,HORA_SALIDA_REF,SAL_DIASIG,HORAS,NUM_HORAS,ID_USER_REG,FECHA_REG)
					 	VALUES (DETAIL.ID_DIA,ID_TIPO_HORARIO_MAX,DETAIL.ID_CONTROL_ASIST,DETAIL.ID_HORAS_REF,DETAIL.HORA_ENTRADA,
					 	DETAIL.HORA_SALIDA,DETAIL.HORA_ENTRADA_REF,DETAIL.HORA_SALIDA_REF,DETAIL.SAL_DIASIG,DETAIL.HORAS,DETAIL.NUM_HORAS,
					 	P_ID_USER,CURRENT_DATE);
				 	END IF;
			 		
			 	END LOOP;
		 		
		 	END LOOP;
		 	
			
		 END LOOP;
		
-- 		<<salida_val>> 
	    P_ERROR:= L_ERROR;
	    P_MSGERROR:= L_MSGERROR;
	END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_copiar_horario (P_IDS_TIPO_HORARIO text,P_ID_ENTIDAD_TO bigint,P_ID_DEPTO_TO text,P_ID_USER bigint, P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
