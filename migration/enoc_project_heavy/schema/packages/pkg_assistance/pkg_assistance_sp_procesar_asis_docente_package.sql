-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_procesar_asis_docente ( P_FECHA timestamp(0),--SI P_TIPO=FE OBLIAGATORIO
 P_ID_DEPTO text, P_ID_AREA bigint, P_ID_AREAS text, P_ID_TRABAJADOR bigint, P_RESTRINGIDO text, P_ID_TIPO_NIVEL_VISTA bigint, P_TIPO text,--AM: Año y Mes,FE: por fecha
 P_ID_ANHO bigint, --SI P_TIPO=AM OBLIAGATORIO
 P_ID_MES bigint, --SI P_TIPO=AM OBLIAGATORIO
 P_ID_USER bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;

    l_total bigint:=0;
    l_num_dia bigint;
    l_i bigint:=0;

    l_insert bigint:=0;
    n_horas bigint:=0;

    l_query varchar(4000):='';

    L_NUM_TOLE_TAR bigint;
    l_id_entidad bigint:=7124;
    l_id_anho bigint;
    l_inicio timestamp(0);
    l_fin timestamp(0);


BEGIN
    
      
      
      if P_TIPO='AM' then
        l_inicio:=to_date(P_ID_ANHO::text||'-'||P_ID_MES::text||'-01','YYYY-MM-DD');
        l_fin:= date_trunc('day', ((date_trunc('month',(l_inicio)::timestamp + interval '1 month'))::timestamp(0) - 1));
        l_id_anho:=P_ID_ANHO;
      else
        l_inicio:=P_FECHA;
        l_fin:= P_FECHA;
        select
        (to_char(P_FECHA,'YYYY'))::numeric
        into STRICT
        l_id_anho
;
      end if;

      
      DELETE FROM ENOC.TT_CARGA_DOCENTE_HORARIO;

      
      l_query:='INSERT INTO ENOC.TT_CARGA_DOCENTE_HORARIO(ID_CARGA_CURSO) ';
      l_query:=l_query||'SELECT ';
      l_query:=l_query||'distinct a.ID_CARGA_CURSO ';
      l_query:=l_query||'FROM  ENOC.PLLA_ASISTENCIA_CARGA  a , moises.trabajador t, ENOC.VW_ENT_DEP_AREA_CCOSTO C ';
      l_query:=l_query||'WHERE  a.id_trabajador=t.id_trabajador ';
      l_query:=l_query||'and t.id_sedearea = c.id_sedearea ';
      l_query:=l_query||'and t.id_entidad = 7124 ';
      l_query:=l_query||'and c.id_depto_padre = :p_depto ';
      IF P_ID_TRABAJADOR>0 THEN
        l_query:=l_query||'and t.id_trabajador = '||P_ID_TRABAJADOR||' ';
      END IF;
      IF P_ID_AREA>0 THEN
        l_query:=l_query||'and c.id_area = '||P_ID_AREA||' ';
      END IF;
      l_query:=l_query||'and a.fecha BETWEEN :F_INI AND :F_FIN ';

      if (P_RESTRINGIDO = 'S') then
            if P_ID_TIPO_NIVEL_VISTA = 4 THEN
               l_query:=l_query||'and c.id_area in( '||P_ID_AREAS||') ';
            END IF;
            if P_ID_TIPO_NIVEL_VISTA = 5 THEN
                l_query:=l_query||'and t.id_persona = '||P_ID_USER||' ';
            end if;
      end if;

      if P_RESTRINGIDO = 'U' then
            l_query:=l_query||'and t.id_persona = '||P_ID_USER||' ';
      end if;

      
      EXECUTE l_query USING P_ID_DEPTO,l_inicio,l_fin;

      
      select count(*) into STRICT l_contar from plla_parametros_valor  a, plla_parametros b
      where b.id_parametro=a.id_parametro
      and a.id_entidad=l_id_entidad
      and a.id_anho=l_id_anho;

      IF l_contar=0 then
        l_error:=1;
        l_msgerror:='Falta configurar parametros para el año '||l_id_anho::text;
--         GOTO SALIDA;
      end if;

      
      select coalesce(a.importe,0) into STRICT L_NUM_TOLE_TAR from plla_parametros_valor  a, plla_parametros b
          where b.id_parametro=a.id_parametro
          and b.codigo='TOLE_HORA_ENT'
          and a.id_entidad=l_id_entidad
          and a.id_anho=l_id_anho;

      ---motivo asistencia
      MERGE INTO ENOC.PLLA_ASISTENCIA_CARGA S 
          USING(
            SELECT
              a.ID_ASISTENCIA_CARGA,
              a.ID_CARGA_CURSO,
              a.ID_PERSONA,
              a.ID_SEMESTRE,
              t.id_trabajador,
              T.ID_SEDEAREA,
              ENOC.FC_MOTIVO_ASIST_DOCENTE(t.ID_TRABAJADOR,t.ID_SEDEAREA,a.desde_prog,a.hasta_prog) as ID_MOTIVO_ASIST
           FROM  ENOC.PLLA_ASISTENCIA_CARGA  a , moises.trabajador t
           WHERE  a.id_trabajador=t.id_trabajador
           and t.id_entidad = 7124
           and a.ID_CARGA_CURSO in (SELECT ID_CARGA_CURSO from ENOC.TT_CARGA_DOCENTE_HORARIO) 
      )T ON (T.ID_ASISTENCIA_CARGA=S.ID_ASISTENCIA_CARGA)
      WHEN  MATCHED THEN UPDATE SET  
      S.ID_MOTIVO_ASIST=T.ID_MOTIVO_ASIST,
      S.NUM_TOLE_TAR=L_NUM_TOLE_TAR,
      S.ID_USER_MOD=P_ID_USER,
      S.FECHA_MOD= clock_timestamp();

      MERGE INTO ENOC.PLLA_ASISTENCIA_CARGA S 
          USING(
            SELECT
              a.ID_ASISTENCIA_CARGA,
              a.ID_CARGA_CURSO,
              a.ID_PERSONA,
              a.ID_SEMESTRE,
              t.id_trabajador,
              T.ID_SEDEAREA,
              ENOC.FC_MOTIVO_ASIST_DOCENTE(t.ID_TRABAJADOR,t.ID_SEDEAREA,a.desde_prog,a.hasta_prog) as ID_MOTIVO_ASIST
           FROM  ENOC.PLLA_ASISTENCIA_CARGA  a , moises.trabajador t
           WHERE  a.id_trabajador=t.id_trabajador
           and t.id_entidad = 7124
           and a.ID_CARGA_CURSO in (SELECT ID_CARGA_CURSO from ENOC.TT_CARGA_DOCENTE_HORARIO)
           and coalesce(a.tipo,'N')='N' 
      )T ON (T.ID_ASISTENCIA_CARGA=S.ID_ASISTENCIA_CARGA)
      WHEN  MATCHED THEN UPDATE SET  
      S.TARDANZA=0,
      S.TIPO = NULL;

      --CALCULO TARDANZA FALTA
       MERGE INTO  ENOC.PLLA_ASISTENCIA_CARGA S 
          USING(
            SELECT
              a.ID_ASISTENCIA_CARGA,
              a.ID_CARGA_CURSO,
              a.ID_PERSONA,
              a.ID_SEMESTRE,
              t.id_trabajador,
              T.ID_SEDEAREA,
              A.ID_MOTIVO_ASIST,
              A.tipo,
              a.TARDANZA,
              case when (a.DESDE_REAL IS NOT NULL AND a.DESDE_REAL::text <> '') then (a.DESDE_REAL - A.NUM_TOLE_TAR / 1440) else null end as f_ini_cal
           FROM  ENOC.PLLA_ASISTENCIA_CARGA  a , moises.trabajador t
           WHERE  a.id_trabajador=t.id_trabajador
           and t.id_entidad = 7124
           and a.ID_CARGA_CURSO in (SELECT ID_CARGA_CURSO from ENOC.TT_CARGA_DOCENTE_HORARIO)
           and a.desde_prog<= clock_timestamp() 
      )T ON (T.ID_ASISTENCIA_CARGA=S.ID_ASISTENCIA_CARGA)
      WHEN  MATCHED THEN UPDATE SET  
      S.ID_MOTIVO_ASIST=T.ID_MOTIVO_ASIST,
      S.TARDANZA=CASE WHEN t.ID_MOTIVO_ASIST='A' THEN 
              CASE WHEN (S.DESDE_REAL IS NOT NULL AND S.DESDE_REAL::text <> '') THEN 
                case when t.tipo='J' then
                  0
                else
                  case when T.f_ini_cal>S.DESDE_PROG THEN
                    round((T.f_ini_cal - S.DESDE_PROG)*1440,2)
                  ELSE
                    0
                  END
                end 
              ELSE 
                0 
              END 
            ELSE 
              0 
            END,
            
      S.TIPO=CASE WHEN t.ID_MOTIVO_ASIST='A' THEN 
              CASE WHEN S.DESDE_REAL = NULL THEN 
                case when t.tipo='J' then
                  'J'
                else
                  'F'
                end 
              ELSE
                  case when t.tipo='J' then
                    'J'
                   ELSE
                    NULL
                   END
             END 
            ELSE 
              NULL 
            END,
      S.ID_USER_MOD=P_ID_USER,
      S.FECHA_MOD= clock_timestamp();

--       <<SALIDA>>  
      P_ERROR:=l_error;
      P_MSGERROR := l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_procesar_asis_docente ( P_FECHA timestamp(0), P_ID_DEPTO text, P_ID_AREA bigint, P_ID_AREAS text, P_ID_TRABAJADOR bigint, P_RESTRINGIDO text, P_ID_TIPO_NIVEL_VISTA bigint, P_TIPO text, P_ID_ANHO bigint, P_ID_MES bigint, P_ID_USER bigint, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
