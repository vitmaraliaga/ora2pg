-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_control_generar_falta (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_id_motivo_asist varchar(2):='FA';
        l_item bigint;
        l_id_tipo_suspension bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';

BEGIN
      
      /*
        delete from PLLA_FALTAS where to_number(to_char(FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(FECHA,'MM'))=P_ID_MES
        AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR
        AND ID_SEDEAREA IN(
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        ); 
      */
        --select coalesce(max(ITEM),0)  into l_item from PLLA_FALTAS where to_number(to_char(FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(FECHA,'MM'))=P_ID_MES;
        
        select id_tipo_suspension into STRICT l_id_tipo_suspension from plla_tipo_suspension where codsunat='07';

        /*
        INSERT INTO PLLA_FALTAS(
            ID_FALTAS,
            ITEM,
            ID_TRABAJADOR,
            ID_TIPO_SUSPENSION,
            ID_SEDEAREA,
            FECHA,
            ID_USER_REG,
            FECHA_REG
          )
      
        SELECT 
         to_char(FECHA,'YYYYMMDD')||l_id_motivo_asist||to_char((row_number() OVER(PARTITION BY A.FECHA  ORDER BY A.ID_ASISTENCIA ASC ))+l_item) AS ID_CONTROL_ASISTENCIA,
         (row_number() OVER( PARTITION BY A.FECHA  ORDER BY A.ID_ASISTENCIA ASC ))+l_item AS ITEM,
         A.ID_TRABAJADOR,
         l_id_tipo_suspension,
         A.ID_SEDEAREA,
         A.FECHA,
         P_ID_USER_REG,
         SYSDATE
        FROM VW_ASISTENCIA A 
        WHERE A.ID_MOTIVO_ASIST='A'
        AND to_number(to_char(A.FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(A.FECHA,'MM'))=P_ID_MES
        AND A.HORA_BASE_ENT IS NOT NULL
        AND A.ID_TRABAJADOR NOT IN(
          SELECT b.ID_TRABAJADOR from  PLLA_CONTROL_ASISTENCIA  b
          where to_char(b.FECHA,'YYYY-MM-DD')=to_char(A.FECHA,'YYYY-MM-DD')
          and b.ID_MOTIVO_ASIST in('V','PL','A')
        ) AND to_char(A.FECHA,'YYYY-MM-DD') NOT IN(
          SELECT to_char(X.FECHA,'YYYY-MM-DD') FROM PLLA_FERIADOS X
        ) AND A.ENTRADA IS NULL 
        AND A.SALIDA IS NULL
        AND COALESCE(A.NUM_HORAS_FINAL,0)=0
        AND A.ID_TIPO_CONTROL_PERSONAL=3 --FISCALIZABLE
        AND case when P_ID_TRABAJADOR=0 then 0 else A.ID_TRABAJADOR end = P_ID_TRABAJADOR 
        ORDER BY A.ID_ASISTENCIA;
        */
        
        delete from PLLA_CONTROL_ASISTENCIA where (to_char(FECHA,'YYYY'))::numeric =P_ID_ANHO and (to_char(FECHA,'MM'))::numeric =P_ID_MES
        and ID_MOTIVO_ASIST = l_id_motivo_asist AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR
        AND ID_SEDEAREA IN (
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        );
      /*
        insert into PLLA_CONTROL_ASISTENCIA(
            ID_CONTROL_ASISTENCIA,
            ITEM,
            ID_TRABAJADOR,
            ID_SEDEAREA,
            ID_MOTIVO_ASIST,
            FECHA,
            ID_FALTAS,
            ID_USER_REG,
            FECHA_REG
              )
        SELECT 
        ID_FALTAS,
        ITEM,
        ID_TRABAJADOR,
        ID_SEDEAREA,
        l_id_motivo_asist,
        FECHA,
        ID_FALTAS,
        P_ID_USER_REG,
        SYSDATE
        FROM PLLA_FALTAS
        WHERE to_number(to_char(FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(FECHA,'MM'))=P_ID_MES
        AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR
        AND ID_SEDEAREA IN(
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        );
              
        update PLLA_ASISTENCIA 
        set  ID_MOTIVO_ASIST = l_id_motivo_asist
        where ID_TRABAJADOR IN(
          SELECT X.ID_TRABAJADOR FROM PLLA_CONTROL_ASISTENCIA X
          WHERE to_char(X.FECHA,'YYYY-MM-DD')=to_char(FECHA,'YYYY-MM-DD')
          and x.ID_FALTAS is not null
          and X.ID_MOTIVO_ASIST = l_id_motivo_asist
        )
        AND ID_SEDEAREA IN(
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        )
        AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR;
        */
        P_ERROR:=l_error;
        P_MSGERROR:= l_msgerror;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_control_generar_falta (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
