-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_copiar_horario_bloque (P_ID_HORARIO_BLOQUE bigint,P_ID_ENTIDAD_TO bigint,P_ID_DEPTO_TO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

		L_ERROR bigint:=0;
		L_MSGERROR varchar(5000):='';
		L_CONTAR bigint:=0;
		L_ID_HORARIO_BLOQUE bigint:=0;
		L_CODIGO varchar(200):='';
		L_ID_ENTIDAD bigint:=0;
		L_ID_DEPTO varchar(10):='';
		L_CONTAR_REG bigint:=0;
	
  ITEM RECORD;

BEGIN
		-- ha tener en cuenta que s칩lo se copiar치 a los deptos padres que estan dentro de la tabla ELISEO.ORG_SEDE_AREA
		 FOR ITEM IN (
		   		SELECT DISTINCT A.ID_ENTIDAD,A.ID_DEPTO FROM ELISEO.CONTA_ENTIDAD_DEPTO A
				INNER JOIN ELISEO.VW_SEDE_AREA B ON A.ID_ENTIDAD = B.ID_ENTIDAD AND A.ID_DEPTO = B.ID_DEPTO_PADRE
				WHERE A.ID_ENTIDAD = P_ID_ENTIDAD_TO AND A.ES_GRUPO = '1' AND LENGTH(A.ID_DEPTO) = 1
				AND 1 = (CASE WHEN P_ID_DEPTO_TO = '0' THEN 1 ELSE CASE WHEN A.ID_DEPTO = P_ID_DEPTO_TO THEN 1 ELSE 0 END END)
				AND A.ID_DEPTO <> '0' )
		 LOOP
			 L_CONTAR_REG := L_CONTAR_REG + 1;
			 SELECT CODIGO,ID_ENTIDAD,ID_DEPTO INTO STRICT L_CODIGO,L_ID_ENTIDAD,L_ID_DEPTO
			 FROM ENOC.PLLA_HORARIO_BLOQUE WHERE ID_HORARIO_BLOQUE = P_ID_HORARIO_BLOQUE  LIMIT 1;
					
			 IF (ITEM.ID_ENTIDAD = L_ID_ENTIDAD AND ITEM.ID_DEPTO <> L_ID_DEPTO ) OR ITEM.ID_ENTIDAD <> L_ID_ENTIDAD THEN
				
				 SELECT COUNT(*) INTO STRICT L_CONTAR FROM ENOC.PLLA_HORARIO_BLOQUE 
				 WHERE UPPER(trim(both CODIGO)) = UPPER(trim(both L_CODIGO)) AND ID_ENTIDAD = ITEM.ID_ENTIDAD AND ID_DEPTO = ITEM.ID_DEPTO;
				 
				IF L_CONTAR > 0 THEN 
					L_ERROR := 1;
					L_MSGERROR := 'Ya existe registrado "'||L_CODIGO||'" con el mismo c칩digo en la entidad  "'||ITEM.ID_ENTIDAD||'".';
-- 					GOTO salida_val;
				END IF;
				
				select coalesce(max(ID_HORARIO_BLOQUE),0)+1 into STRICT L_ID_HORARIO_BLOQUE from enoc.PLLA_HORARIO_BLOQUE;
				
				 INSERT INTO ENOC.PLLA_HORARIO_BLOQUE(ID_HORARIO_BLOQUE,ID_ENTIDAD,ID_DEPTO,NOMBRE,CODIGO,DESCRIPCION,ID_CONTROL_ASIST,
				 ID_HORAS_REF,HORA_ENTRADA,HORA_SALIDA,HORA_ENTRADA_REF,HORA_SALIDA_REF,SAL_DIASIG,HORAS,NUM_HORAS,
				 ID_USER_REG,FECHA_REG,VIGENCIA)
				 SELECT L_ID_HORARIO_BLOQUE AS ID_HORARIO_BLOQUE,ITEM.ID_ENTIDAD AS ID_ENTIDAD,ITEM.ID_DEPTO AS ID_DEPTO,
				 NOMBRE,CODIGO,DESCRIPCION,ID_CONTROL_ASIST,ID_HORAS_REF,HORA_ENTRADA,HORA_SALIDA,HORA_ENTRADA_REF,HORA_SALIDA_REF,SAL_DIASIG,HORAS,NUM_HORAS,
				P_ID_USER AS ID_USER_REG,CURRENT_DATE AS FECHA_REG, VIGENCIA
				FROM ENOC.PLLA_HORARIO_BLOQUE WHERE ID_HORARIO_BLOQUE = P_ID_HORARIO_BLOQUE;
			END IF;
		 END LOOP;
		
		IF L_CONTAR_REG = 0 THEN
			L_ERROR := 2;
			L_MSGERROR := 'No se ha copiado. S칩lo se permite copiar a los deptos padres, de los centros de costo registrados.';
		END IF;
		
-- 		<<salida_val>> 
	    P_ERROR:= L_ERROR;
	    P_MSGERROR:= L_MSGERROR;
	END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_copiar_horario_bloque (P_ID_HORARIO_BLOQUE bigint,P_ID_ENTIDAD_TO bigint,P_ID_DEPTO_TO text, P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
