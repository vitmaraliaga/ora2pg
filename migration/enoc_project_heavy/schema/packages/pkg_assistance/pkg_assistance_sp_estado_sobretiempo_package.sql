-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_estado_sobretiempo (P_ID_SOBRETIEMPO bigint, P_ID_ESTADO_SOBRETIEMPO text, P_COMENTARIO text,P_ID_USER bigint, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_contar bigint;
        l_id bigint;
        l_id_trabajador bigint;
        l_id_situacion_especial bigint;

BEGIN
      
       select coalesce(max(ID_SOBRETIEMPO_ESTADO),0)+1 into STRICT l_id from enoc.PLLA_SOBRETIEMPO_ESTADO;

       select id_trabajador into STRICT l_id_trabajador from ENOC.PLLA_SOBRETIEMPO where ID_SOBRETIEMPO=P_ID_SOBRETIEMPO;

       insert into ENOC.PLLA_SOBRETIEMPO_ESTADO(
        ID_SOBRETIEMPO_ESTADO,
        ID_SOBRETIEMPO,
        ID_ESTADO_SOBRETIEMPO,
        COMENTARIO,
        ID_USER_REG,
        FECHA_REG
        )values (
          l_id,
          P_ID_SOBRETIEMPO,
          P_ID_ESTADO_SOBRETIEMPO,
          P_COMENTARIO,
          P_ID_USER,
          clock_timestamp()
        );

        update ENOC.PLLA_SOBRETIEMPO SET
        ID_ESTADO_SOBRETIEMPO=P_ID_ESTADO_SOBRETIEMPO,
        ID_USER_MOD = P_ID_USER,
        FECHA_MOD =clock_timestamp()
        WHERE ID_SOBRETIEMPO=P_ID_SOBRETIEMPO;

        
        IF P_ID_ESTADO_SOBRETIEMPO = '05' THEN
        
         select count(*) into STRICT l_contar from MOISES.TRABAJADOR_SIT_ESP WHERE ID_TRABAJADOR = id_trabajador and vigencia=1;

         if l_contar=1 then
          select ID_SITUACION_ESPECIAL into STRICT l_id_situacion_especial from MOISES.TRABAJADOR_SIT_ESP WHERE ID_TRABAJADOR = id_trabajador and vigencia=1;
         end if;
          MERGE INTO ENOC.PLLA_SOBRETIEMPO C 
                USING(
                  SELECT 
                  A.ID_SOBRETIEMPO,
                  B.ID_TIPO_CONTROL_PERSONAL,
                  B.ID_TIPO_HORARIO,
                  B.ID_CONDICION_LABORAL,
                  B.ID_SEDEAREA,
                  B.ID_PERFIL_PUESTO
                  FROM ENOC.PLLA_SOBRETIEMPO A,MOISES.TRABAJADOR B
                  WHERE A.ID_TRABAJADOR=B.ID_TRABAJADOR
                  AND A.ID_SOBRETIEMPO=P_ID_SOBRETIEMPO
          )Y
           ON (C.ID_SOBRETIEMPO=Y.ID_SOBRETIEMPO )
          WHEN  MATCHED THEN UPDATE SET 
          C.ID_TIPO_CONTROL_PERSONAL=Y.ID_TIPO_CONTROL_PERSONAL,
          C.ID_TIPO_HORARIO=Y.ID_TIPO_HORARIO,
          C.ID_CONDICION_LABORAL=Y.ID_CONDICION_LABORAL,
          C.ID_SEDEAREA=Y.ID_SEDEAREA,
          C.ID_PERFIL_PUESTO=Y.ID_PERFIL_PUESTO,
          C.ID_SITUACION_ESPECIAL=l_id_situacion_especial,
          C.ID_USER_MOD = P_ID_USER,
          C.FECHA_MOD =clock_timestamp();

        END IF;

   
         
         P_ERROR:=l_error;
         P_MSGERROR:= l_msgerror;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_estado_sobretiempo (P_ID_SOBRETIEMPO bigint, P_ID_ESTADO_SOBRETIEMPO text, P_COMENTARIO text,P_ID_USER bigint, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
