-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_procesar_no_fiscalizable ( P_ID_TRABAJADOR bigint, P_FECHA timestamp(0), P_ID_TIPO_HORARIO bigint, P_ID_SEDEAREA bigint, P_ID_MOTIVO_ASIST text, P_ID_USER bigint ) AS $body$
DECLARE


      l_control bigint:=0;
      f_hora_entrada timestamp(0);
      f_hora_salida timestamp(0);
      f_hora_entrada_ref timestamp(0);
      f_hora_salida_ref timestamp(0);
      l_hora_entrada varchar(10);
      l_hora_salida varchar(10);
      l_hora_entrada_ref varchar(10);
      l_hora_salida_ref varchar(10);
      l_anho bigint:=0;
      l_mes bigint:=0;
      l_dia bigint:=0;
      l_nrodia bigint:=0;
      l_codigo varchar(10);
      l_codigo_asist varchar(10);
      l_contar bigint;
      l_id_tipo_horario bigint;
      l_sal_diasig bigint;
      l_id_entidad bigint;

BEGIN
      
       
        SELECT 
        ID_ENTIDAD
        into STRICT
        l_id_entidad
        FROM eliseo.vw_sede_area
        WHERE ID_SEDEAREA=P_ID_SEDEAREA;

        if P_ID_MOTIVO_ASIST = 'A' then
          l_control:=1;
        else
          if P_ID_MOTIVO_ASIST in ('FN', 'FNL','FI','SA','DO') then
             select count(*) into STRICT l_contar  from enoc.plla_marcacion
             where id_trabajador=P_ID_TRABAJADOR
             and coalesce(fechahora,fechahora_manual) = P_FECHA;

             if l_contar>0 then
                l_control:=1;
             end if;
          end if;
        end if;

        if l_control=1 then
        
           select 
           (to_char(P_FECHA,'YYYY'))::numeric ,(to_char(P_FECHA,'MM'))::numeric ,(to_char(P_FECHA,'DD'))::numeric , (TO_CHAR(P_FECHA, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))::numeric 
           into STRICT 
           l_anho,l_mes,l_dia,l_nrodia 
;

           select b.codigo into STRICT l_codigo from enoc.plla_tipo_horario a, ENOC.PLLA_TIPO_CONFIG_HORARIO b
           where a.ID_TIPO_CONFIG_HORARIO=b.ID_TIPO_CONFIG_HORARIO
           and a.id_tipo_horario = P_ID_TIPO_HORARIO;

           if l_codigo ='HM' then
           
             l_control:=0;

           else
             select  
             c.codigo, 
             a.HORA_ENTRADA,
             a.HORA_SALIDA,
             a.HORA_ENTRADA_REF,
             a.HORA_SALIDA_REF,
             a.SAL_DIASIG
             into STRICT
             l_codigo_asist,
             l_hora_entrada,
             l_hora_salida,
             l_hora_entrada_ref,
             l_hora_salida_ref,
             l_sal_diasig
             from enoc.plla_horario_detalle a, enoc.plla_control_asist c
             where  a.id_control_asist=c.id_control_asist
             and a.id_tipo_horario=P_ID_TIPO_HORARIO
             and a.id_dia=l_nrodia;
           end if;

           if l_control=1 then
             --entrada
             f_hora_entrada := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada,'YYYY-MM-DD HH24:MI:SS');

             if l_codigo_asist in ('REFCMA','DOTU') then
               --salida ref
               f_hora_salida_ref := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida_ref,'YYYY-MM-DD HH24:MI:SS');
               --entrada ref
               f_hora_entrada_ref := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_entrada_ref,'YYYY-MM-DD HH24:MI:SS');
             end if;

             --salida
             if l_sal_diasig=1 then
              f_hora_salida := to_date(TO_CHAR(P_FECHA + 1, 'YYYY-MM-DD')||' '||l_hora_salida,'YYYY-MM-DD HH24:MI:SS');
             else
              f_hora_salida := to_date(TO_CHAR(P_FECHA, 'YYYY-MM-DD')||' '||l_hora_salida,'YYYY-MM-DD HH24:MI:SS');
             end if;
          end if;
        end if;

        CALL ENOC.pkg_assistance_sp_registrar_asistencia(
                                  l_id_entidad,
                                  P_ID_TRABAJADOR,
                                  P_ID_SEDEAREA,
                                  P_ID_TIPO_HORARIO,
                                  P_ID_MOTIVO_ASIST,
                                  P_FECHA,
                                  f_hora_entrada,
                                  f_hora_salida,
                                  f_hora_entrada_ref,
                                  f_hora_salida_ref,
                                  'N',
                                  P_ID_USER
                                  );

      
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_procesar_no_fiscalizable ( P_ID_TRABAJADOR bigint, P_FECHA timestamp(0), P_ID_TIPO_HORARIO bigint, P_ID_SEDEAREA bigint, P_ID_MOTIVO_ASIST text, P_ID_USER bigint ) FROM PUBLIC;
