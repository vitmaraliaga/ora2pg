-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;

  	--ID MAPA POLIGONO POR ID TRABAJADOR
CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_idmapapoligono_trabajador ( P_ID_TRABAJADOR bigint, P_ID_MAPA_POLIGONO OUT bigint) AS $body$
DECLARE

	L_ID_ENTIDAD bigint;
  	L_ID_DEPTO varchar(10);
	L_ID_AREA bigint;
	L_CONTAR bigint;
	
BEGIN
	P_ID_MAPA_POLIGONO:=NULL;

	SELECT T.ID_ENTIDAD,SUBSTR(OSA.ID_DEPTO,1,1) AS ID_DEPTO,osa.ID_AREA INTO STRICT L_ID_ENTIDAD,L_ID_DEPTO,L_ID_AREA
	FROM (SELECT ID_ENTIDAD,ID_SEDEAREA FROM MOISES.TRABAJADOR WHERE ID_TRABAJADOR = P_ID_TRABAJADOR ORDER BY FECHA_INICIO DESC)t
	INNER JOIN ELISEO.ORG_SEDE_AREA osa ON osa.ID_SEDEAREA = t.ID_SEDEAREA LIMIT 1;

	SELECT COUNT(*) INTO STRICT L_CONTAR FROM (SELECT ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_POLIGONO
	WHERE ID_ENTIDAD = L_ID_ENTIDAD AND VIGENCIA = '1' AND ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
			INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO
			WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric  )
			AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
			AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1 ) ) A 
	INNER JOIN(SELECT ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_TRABAJADOR WHERE ID_TRABAJADOR = P_ID_TRABAJADOR) B ON B.ID_MAPA_POLIGONO = A.ID_MAPA_POLIGONO LIMIT 1;

	IF L_CONTAR<=0 THEN
		SELECT COUNT(*) INTO STRICT L_CONTAR
		FROM (SELECT ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD AND CASE WHEN ID_DEPTO = '0' THEN 1 WHEN ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END =1 AND ID_AREA = L_ID_AREA) A 
		INNER JOIN(SELECT ID_MAPA_POLIGONO,FECHA_REG FROM ENOC.PLLA_MAPA_POLIGONO 
		WHERE ID_ENTIDAD = L_ID_ENTIDAD AND VIGENCIA = '1' AND ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
			INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO 
			WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric  )
			AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
			AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1 ) ) B ON A.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO;
		IF L_CONTAR=0 THEN
			SELECT COUNT(*) INTO STRICT L_CONTAR FROM (WITH RECURSIVE cte AS (

			SELECT ID_AREA,ID_PARENT,1 AS NIVEL
			FROM (SELECT ID_AREA,ID_PARENT FROM ELISEO.ORG_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD) alias1  WHERE ID_AREA = L_ID_AREA
  UNION ALL

			SELECT ID_AREA,ID_PARENT,(c.level+1) AS NIVEL
			FROM (SELECT ID_AREA,ID_PARENT FROM ELISEO.ORG_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD) JOIN cte c ON (c.ID_PARENT = ID_AREA)

) SELECT * FROM cte  WHERE LEVEL > 1) A
			INNER JOIN(SELECT ID_AREA,ID_MAPA_POLIGONO,FECHA_REG FROM ENOC.PLLA_MAPA_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD AND CASE WHEN ID_DEPTO = '0' THEN 1 WHEN ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END =1) B ON A.ID_AREA = B.ID_AREA
			INNER JOIN(SELECT ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_POLIGONO 
			WHERE ID_ENTIDAD = L_ID_ENTIDAD 
			AND CASE WHEN ID_DEPTO = '0' THEN 1 WHEN ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END =1 
			AND VIGENCIA = '1' AND ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
			INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO 
			WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric ) 
			AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
			AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1) )  C ON C.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO;
	  		IF L_CONTAR=0 THEN
				SELECT COUNT(*) INTO STRICT L_CONTAR FROM ENOC.PLLA_MAPA_POLIGONO
				WHERE ID_ENTIDAD = L_ID_ENTIDAD AND ID_DEPTO = L_ID_DEPTO AND VIGENCIA = '1';
				IF L_CONTAR=0 THEN
					SELECT COUNT(*) INTO STRICT L_CONTAR FROM ENOC.PLLA_MAPA_POLIGONO T
					WHERE T.ID_ENTIDAD = L_ID_ENTIDAD AND T.ID_DEPTO = '0' AND T.VIGENCIA = '1';
					IF L_CONTAR>0 THEN
						SELECT ID_MAPA_POLIGONO INTO STRICT P_ID_MAPA_POLIGONO FROM (SELECT MP.ID_MAPA_POLIGONO,
						(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_TRABAJADOR MT WHERE MT.ID_MAPA_POLIGONO = MP.ID_MAPA_POLIGONO) AS CANTIDAD,
						(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_AREA MA WHERE MA.ID_MAPA_POLIGONO = MP.ID_MAPA_POLIGONO) AS CANTIDAD_AREA
						FROM ENOC.PLLA_MAPA_POLIGONO MP
						WHERE MP.ID_ENTIDAD = L_ID_ENTIDAD AND MP.ID_DEPTO = '0'
						AND MP.ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
						INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO 
						WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric  )
						AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
						AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1 ) 
						ORDER BY CANTIDAD ASC,CANTIDAD_AREA ASC,MP.FECHA_REG DESC) alias9 LIMIT 1;
					END IF;
				ELSE
					SELECT ID_MAPA_POLIGONO INTO STRICT P_ID_MAPA_POLIGONO FROM (SELECT MP.ID_MAPA_POLIGONO,
					(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_TRABAJADOR MT WHERE MT.ID_MAPA_POLIGONO = MP.ID_MAPA_POLIGONO) AS CANTIDAD,
					(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_AREA MA WHERE MA.ID_MAPA_POLIGONO = MP.ID_MAPA_POLIGONO) AS CANTIDAD_AREA
					FROM ENOC.PLLA_MAPA_POLIGONO MP
					WHERE MP.ID_ENTIDAD = L_ID_ENTIDAD AND MP.ID_DEPTO = L_ID_DEPTO 
					AND MP.ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
					INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO 
					WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric  )
					AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
					AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1 ) 
					ORDER BY CANTIDAD ASC,CANTIDAD_AREA ASC,MP.FECHA_REG DESC) alias9 LIMIT 1;
				END IF;
			ELSE
				SELECT ID_MAPA_POLIGONO INTO STRICT P_ID_MAPA_POLIGONO FROM (SELECT A.ID_AREA,B.ID_MAPA_POLIGONO,
				(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_TRABAJADOR MT WHERE MT.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO) AS CANTIDAD ,
				(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_AREA MA WHERE MA.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO) AS CANTIDAD_AREA
				FROM (WITH RECURSIVE cte AS (

				SELECT ID_AREA,ID_PARENT,1 AS NIVEL
				FROM (SELECT ID_AREA,ID_PARENT FROM ELISEO.ORG_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD) alias4  WHERE ID_AREA = L_ID_AREA
  UNION ALL

				SELECT ID_AREA,ID_PARENT,(c.level+1) AS NIVEL
				FROM (SELECT ID_AREA,ID_PARENT FROM ELISEO.ORG_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD) JOIN cte c ON (c.ID_PARENT = ID_AREA)

) SELECT * FROM cte  WHERE LEVEL > 1) A
				INNER JOIN(SELECT ID_AREA,ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD AND CASE WHEN ID_DEPTO = '0' THEN 1 WHEN ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END =1) B ON A.ID_AREA = B.ID_AREA
				INNER JOIN(SELECT ID_MAPA_POLIGONO,FECHA_REG FROM ENOC.PLLA_MAPA_POLIGONO 
				WHERE ID_ENTIDAD = L_ID_ENTIDAD AND VIGENCIA = '1'
				AND ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
				INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO 
				WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric ) 
				AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
				AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1) )  C ON C.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO 
				ORDER BY A.NIVEL ASC,CANTIDAD ASC,CANTIDAD_AREA ASC,C.FECHA_REG DESC) alias13 LIMIT 1;
			END IF;
		ELSE
			SELECT ID_MAPA_POLIGONO INTO STRICT P_ID_MAPA_POLIGONO FROM (SELECT A.ID_MAPA_POLIGONO,
			(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_TRABAJADOR MT WHERE MT.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO) AS CANTIDAD ,
			(SELECT COUNT(*) FROM ENOC.PLLA_MAPA_AREA MA WHERE MA.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO) AS CANTIDAD_AREA
			FROM (SELECT ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_AREA WHERE ID_ENTIDAD = L_ID_ENTIDAD AND CASE WHEN ID_DEPTO = '0' THEN 1 WHEN ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END =1 AND ID_AREA = L_ID_AREA) A 
			INNER JOIN(SELECT ID_MAPA_POLIGONO,FECHA_REG FROM ENOC.PLLA_MAPA_POLIGONO 
			WHERE ID_ENTIDAD = L_ID_ENTIDAD AND VIGENCIA = '1' AND ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
			INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO 
			WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric  )
			AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
			AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1 ) ) B ON A.ID_MAPA_POLIGONO = B.ID_MAPA_POLIGONO 
			ORDER BY CANTIDAD ASC,CANTIDAD_AREA ASC,B.FECHA_REG DESC) alias11 LIMIT 1;
  		END IF;
	ELSE
		SELECT ID_MAPA_POLIGONO INTO STRICT P_ID_MAPA_POLIGONO FROM (SELECT A.ID_MAPA_POLIGONO FROM (SELECT ID_MAPA_POLIGONO,FECHA_REG FROM ENOC.PLLA_MAPA_POLIGONO 
		WHERE ID_ENTIDAD = L_ID_ENTIDAD AND VIGENCIA = '1' AND ID_MAPA_POLIGONO NOT IN (SELECT B1.ID_MAPA_POLIGONO FROM enoc.PLLA_MAPA_DIA A1
		INNER JOIN ENOC.PLLA_MAPA_POLIGONO B1 ON A1.ID_MAPA_POLIGONO = B1.ID_MAPA_POLIGONO 
		WHERE A1.ID_MAPA_POLIGONO NOT IN (SELECT T.ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_DIA T
							WHERE T.ID_DIA = (TO_CHAR(clock_timestamp(),'D','NLS_DATE_LANGUAGE=ENGLISH'))::numeric  )
		AND B1.ID_ENTIDAD = L_ID_ENTIDAD 
		AND CASE WHEN B1.ID_DEPTO = '0' THEN 1 WHEN B1.ID_DEPTO = L_ID_DEPTO THEN 1 ELSE 0 END = 1 ) ) A 
		INNER JOIN(SELECT ID_MAPA_POLIGONO FROM ENOC.PLLA_MAPA_TRABAJADOR WHERE ID_TRABAJADOR = P_ID_TRABAJADOR) B ON B.ID_MAPA_POLIGONO = A.ID_MAPA_POLIGONO  
		ORDER BY A.FECHA_REG DESC) alias7 LIMIT 1;
  	END IF;
	END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_idmapapoligono_trabajador ( P_ID_TRABAJADOR bigint, P_ID_MAPA_POLIGONO OUT bigint) FROM PUBLIC;
