-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_horario_programado (P_ID_TRABAJADOR bigint,P_FECHA timestamp(0), OUT CURSOR REFCURSOR) AS $body$
DECLARE

          l_contar bigint;
          l_id_anho bigint;
          l_id_mes bigint;
          l_id_dia bigint;
          l_nro_dia bigint;


          L_ID_TIPO_HORARIO	bigint;
          L_ID_SEDEAREA bigint;

          l_id_entidad bigint;
          l_id_depto_padre varchar(10);
          l_tipo_hora varchar(15);
          l_id_tiempo_trabajado bigint;
          l_id_tipo_control_personal  bigint;


          L_SAL_DIASIG bigint:=0;

          l_id_horario_bloque bigint;

          S_HORA_ENTRADA	varchar(10);
          S_HORA_SALIDA	varchar(10);
          S_HORA_ENTRADA_REF	varchar(10);
          S_HORA_SALIDA_REF	varchar(10);
          S_SAL_DIASIG	decimal(10,2);
          S_HORAS	varchar(10);
          S_NUM_HORAS	decimal(10,2);
          S_ID_CONTROL_ASIST	bigint;

          l_tipo_tiempo_trabajao varchar(200);
          l_tipo_control_personal varchar(200);
          l_marcacion 	varchar(10);
          L_CONTROL_ASIST varchar(200);
          l_fecha timestamp(0);
          l_max_hora_ext bigint:=0;


BEGIN
      
         select 
         (to_char(P_FECHA,'YYYY'))::numeric , 
         (to_char(P_FECHA,'MM'))::numeric ,
         (to_char(P_FECHA,'DD'))::numeric ,
         (TO_CHAR(P_FECHA, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))::numeric  
         into STRICT l_id_anho,l_id_mes,l_id_dia,l_nro_dia;

       
          select 
          A.ID_ENTIDAD,
          A.ID_TIPO_HORARIO,
          A.ID_TIPO_TIEMPO_TRABAJO,
          A.ID_TIPO_CONTROL_PERSONAL,
          A.ID_SEDEAREA,
          b.nombre,
          c.nombre,
          C.MARCACION
          into STRICT
          l_id_entidad,
          L_ID_TIPO_HORARIO,
          l_id_tiempo_trabajado,
          l_id_tipo_control_personal,
          L_ID_SEDEAREA,          
          l_tipo_tiempo_trabajao,
          l_tipo_control_personal,
          l_marcacion
          from enoc.vw_trabajador A ,MOISES.TIPO_TIEMPO_TRABAJO B,MOISES.TIPO_CONTROL_PERSONAL c
          where A.ID_TIPO_TIEMPO_TRABAJO=B.ID_TIPO_TIEMPO_TRABAJO
          and A.ID_TIPO_CONTROL_PERSONAL=C.ID_TIPO_CONTROL_PERSONAL
          AND A.id_trabajador=P_ID_TRABAJADOR;


          

          select id_depto_padre into STRICT l_id_depto_padre from eliseo.VW_SEDE_AREA where ID_SEDEAREA=L_ID_SEDEAREA;

          
          
          select count(*) into STRICT l_contar from plla_parametros_valor  a, plla_parametros b
          where b.id_parametro=a.id_parametro
          and a.id_entidad=l_id_entidad
          and a.id_anho=l_id_anho;

          IF l_contar>0 then
            select coalesce(a.importe,0) into STRICT l_max_hora_ext from plla_parametros_valor  a, plla_parametros b
            where b.id_parametro=a.id_parametro
            and b.codigo='HORA_EXT_DIA'
            and a.id_entidad=l_id_entidad
            and a.id_anho=l_id_anho;
          end if;

          
          
          select b.CODIGO into STRICT l_tipo_hora from enoc.plla_tipo_horario a, enoc.PLLA_TIPO_CONFIG_HORARIO b
          where a.ID_TIPO_CONFIG_HORARIO=b.ID_TIPO_CONFIG_HORARIO
          and a.id_tipo_horario =  L_ID_TIPO_HORARIO;

          if l_tipo_hora='HM' then
 
              select count(*) into STRICT l_contar from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B
              where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
              AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
              AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
              AND A.ID_ANHO=l_id_anho
              AND A.ID_MES=l_id_mes
              AND B.ID_DIA=l_id_dia;

              if l_contar = 0 then
                l_fecha:= P_FECHA - 1;
                select
                 (to_char(l_fecha,'YYYY'))::numeric , 
                 (to_char(l_fecha,'MM'))::numeric ,
                 (to_char(l_fecha,'DD'))::numeric ,
                 (TO_CHAR(l_fecha, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))::numeric  
                 into STRICT l_id_anho,l_id_mes,l_id_dia,l_nro_dia;

                  select count(*) into STRICT l_contar from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B
                  where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
                  AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
                  AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
                  AND A.ID_ANHO=l_id_anho
                  AND A.ID_MES=l_id_mes
                  AND B.ID_DIA=l_id_dia;

                  if l_contar = 1 then
                    select b.id_horario_bloque into STRICT l_id_horario_bloque from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B
                    where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
                    AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
                    AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
                    AND A.ID_ANHO=l_id_anho
                    AND A.ID_MES=l_id_mes
                    AND B.ID_DIA=l_id_dia;

                    select coalesce(SAL_DIASIG,0) into STRICT S_SAL_DIASIG  from enoc.plla_horario_bloque where id_horario_bloque=l_id_horario_bloque;

                    if S_SAL_DIASIG=0 then
                      l_contar:=0;
                    end if;
                  end if;

              end if;
              if l_contar = 1 then
                select b.id_horario_bloque into STRICT l_id_horario_bloque from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B
                where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
                AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
                AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
                AND A.ID_ANHO=l_id_anho
                AND A.ID_MES=l_id_mes
                AND B.ID_DIA=l_id_dia;

                select 
                  A.HORA_ENTRADA,
                  A.HORA_SALIDA,
                  A.HORA_ENTRADA_REF,
                  A.HORA_SALIDA_REF,
                  A.SAL_DIASIG,
                  A.HORAS,
                  A.NUM_HORAS,
                  A.ID_CONTROL_ASIST,
                  B.NOMBRE 
                  into STRICT 
                  S_HORA_ENTRADA,
                  S_HORA_SALIDA,
                  S_HORA_ENTRADA_REF,
                  S_HORA_SALIDA_REF,
                  S_SAL_DIASIG,
                  S_HORAS,
                  S_NUM_HORAS,
                  S_ID_CONTROL_ASIST,
                  L_CONTROL_ASIST
                  from enoc.plla_horario_bloque A, ENOC.PLLA_CONTROL_ASIST B
                  where A.ID_CONTROL_ASIST=B.ID_CONTROL_ASIST
                  AND A.id_horario_bloque= l_id_horario_bloque;

              end if;
          else

                  
            select COUNT(*) into STRICT l_contar from enoc.plla_horario_detalle where id_tipo_horario=L_ID_TIPO_HORARIO and id_dia=l_nro_dia;
            if l_contar=0 then
                l_fecha:= P_FECHA - 1;
                select
                 (to_char(l_fecha,'YYYY'))::numeric , 
                 (to_char(l_fecha,'MM'))::numeric ,
                 (to_char(l_fecha,'DD'))::numeric ,
                 (TO_CHAR(l_fecha, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))::numeric  
                 into STRICT l_id_anho,l_id_mes,l_id_dia,l_nro_dia;

                 select COUNT(*) into STRICT l_contar from enoc.plla_horario_detalle where id_tipo_horario=L_ID_TIPO_HORARIO and id_dia=l_nro_dia;

                  if l_contar = 1 then
                                        
                    select coalesce(SAL_DIASIG,0) into STRICT S_SAL_DIASIG  from enoc.plla_horario_detalle where id_tipo_horario=L_ID_TIPO_HORARIO and id_dia=l_nro_dia;

                    if S_SAL_DIASIG=0 then
                      l_contar:=0;
                    end if;
                  end if;
            end if;
            if l_contar=1 then
               select
                A.HORA_ENTRADA,
                A.HORA_SALIDA,
                A.HORA_ENTRADA_REF,
                A.HORA_SALIDA_REF,
                A.SAL_DIASIG,
                A.HORAS,
                A.NUM_HORAS,
                A.ID_CONTROL_ASIST,
                B.NOMBRE
                into STRICT 
                S_HORA_ENTRADA,
                S_HORA_SALIDA,
                S_HORA_ENTRADA_REF,
                S_HORA_SALIDA_REF,
                S_SAL_DIASIG,
                S_HORAS,
                S_NUM_HORAS,
                S_ID_CONTROL_ASIST,
                L_CONTROL_ASIST
                from enoc.plla_horario_detalle A , ENOC.PLLA_CONTROL_ASIST B
                where A.ID_CONTROL_ASIST=B.ID_CONTROL_ASIST
                AND  A.id_tipo_horario=L_ID_TIPO_HORARIO 
                and A.id_dia=l_nro_dia;
            end if;
          END IF;

           OPEN CURSOR FOR  SELECT
                            S_HORA_ENTRADA AS HORA_ENTRADA,
                            S_HORA_SALIDA AS HORA_SALIDA,
                            S_HORA_ENTRADA_REF AS HORA_ENTRADA_REF,
                            S_HORA_SALIDA_REF AS HORA_SALIDA_REF,
                            S_SAL_DIASIG AS SAL_DIASIG,
                            S_HORAS AS HORAS,
                            S_NUM_HORAS AS NUM_HORAS,
                            l_tipo_hora AS TIPO_HORA,
                            L_ID_TIPO_HORARIO AS ID_TIPO_HORARIO,
                            l_id_entidad AS ID_ENTIDAD,
                            l_id_depto_padre AS ID_DEPTO_PADRE,
                            l_nro_dia AS NRO_DIA,
                            l_id_tipo_control_personal as ID_TIPO_CONTROL_PERSONAL,
                            l_id_tiempo_trabajado AS ID_TIPO_TIEMPO_TRABAJO,
                            L_ID_SEDEAREA AS ID_SEDEAREA,          
                            l_tipo_tiempo_trabajao AS TIPO_TIEMPO_TRABAJO,
                            l_tipo_control_personal AS TIPO_CONTROL_PERSONAL,
                            l_marcacion AS MARCACION,
                            L_CONTROL_ASIST AS CONTROL_ASIST,
                            case when S_SAL_DIASIG=1 then 'Si' else 'No' end as SALIDA_SIG,
                            case when coalesce(S_HORA_ENTRADA::text, '') = '' then 'N' else 'S' end as TIENE_HORARIO,
                            l_max_hora_ext as MAX_HORA_EXT
;

   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_horario_programado (P_ID_TRABAJADOR bigint,P_FECHA timestamp(0), OUT CURSOR REFCURSOR) FROM PUBLIC;
