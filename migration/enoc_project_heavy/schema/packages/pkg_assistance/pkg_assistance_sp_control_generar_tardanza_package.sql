-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_control_generar_tardanza (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE


        l_item bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';

      
BEGIN
      
      
        delete from PLLA_TARDANZA where (to_char(FECHA,'YYYY'))::numeric =P_ID_ANHO and (to_char(FECHA,'MM'))::numeric =P_ID_MES
        AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR
        AND ID_SEDEAREA IN (
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        );
      
        select coalesce(max(ITEM),0)  into STRICT l_item from PLLA_TARDANZA where (to_char(FECHA,'YYYY'))::numeric =P_ID_ANHO and (to_char(FECHA,'MM'))::numeric =P_ID_MES;

      
        /*
        INSERT INTO PLLA_TARDANZA(
            ID_TARDANZA,
            ITEM,
            ID_TRABAJADOR,
            ID_SEDEAREA,
            FECHA,
            ENTRADA_BASE,
            ENTRADA,
            ENTRADA_REF_BASE,
            ENTRADA_REF,
            NUM_TOLE_TAR,
            NUM_MINUTOS_TAR,
            NUM_TOLE_TAR_REF,
            NUM_MINUTOS_TAR_REF,
            ID_USER_REG,
            FECHA_REG,
            ID_ASISTENCIA
          )
      
        SELECT 
         to_char(FECHA,'YYYYMMDD')||'TA'||to_char((row_number() OVER(PARTITION BY A.FECHA  ORDER BY A.ID_ASISTENCIA ASC ))+l_item) AS ID_CONTROL_ASISTENCIA,
         (row_number() OVER( PARTITION BY A.FECHA  ORDER BY A.ID_ASISTENCIA ASC ))+l_item AS ITEM,
         A.ID_TRABAJADOR ,
         A.ID_SEDEAREA,
         A.FECHA,
         A.HORA_BASE_ENT,
         A.ENTRADA,
         A.HORA_BASE_ENT_REF,
         COALESCE(A.HORA_ENTRADA_REF_MOD,A.HORA_ENTRADA_REF),
         A.NUM_TOLE_TAR,
         A.NUM_MINUTOS_TAR,
         A.NUM_TOLE_TAR_REF,
         A.NUM_MINUTOS_TAR_REF,
         P_ID_USER_REG,
         SYSDATE,
         A.ID_ASISTENCIA
        FROM VW_ASISTENCIA A 
        WHERE A.ID_MOTIVO_ASIST='A'
        AND ID_SEDEAREA IN(
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        )
        AND to_number(to_char(A.FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(A.FECHA,'MM'))=P_ID_MES
        AND (A.ENTRADA IS NOT NULL OR COALESCE(A.HORA_ENTRADA_REF_MOD,A.HORA_ENTRADA_REF) IS NOT NULL)
        AND (COALESCE(A.NUM_MINUTOS_TAR,0)>0  OR COALESCE(A.NUM_MINUTOS_TAR_REF,0)>0)
        AND A.ID_TIPO_CONTROL_PERSONAL=3 --FISCALIZABLE
        AND case when P_ID_TRABAJADOR=0 then 0 else A.ID_TRABAJADOR  end = P_ID_TRABAJADOR 
        ORDER BY A.ID_ASISTENCIA;
        */
        --justificacion
        MERGE INTO PLLA_TARDANZA C 
                USING(
                  SELECT L.ID_LICENCIA_PERMISO,T.ID_TARDANZA,S.TIPO 
                  FROM PLLA_TARDANZA T,ENOC.VW_LICENCIA_PERMISO L, PLLA_TIPO_SUSPENSION S
                  WHERE L.ID_TIPO_SUSPENSION=S.ID_TIPO_SUSPENSION
                  AND T.ID_TRABAJADOR=L.ID_TRABAJADOR
                  AND to_char(T.FECHA,'YYYY-MM-DD')=to_char(L.FECHA_DESDE,'YYYY-MM-DD')
                  AND (to_char(L.FECHA_DESDE,'YYYY'))::numeric =P_ID_ANHO 
                  and (to_char(L.FECHA_DESDE,'MM'))::numeric =P_ID_MES
                  AND L.PERIODO='H'
                  AND L.ID_ESTADO_LICA_PER='02'
                  --AND L.TIEMPO IN('E')
                  AND T.NUM_MINUTOS_TAR>0
                  AND T.ID_SEDEAREA IN (
                    SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
                  )
                  AND case when P_ID_TRABAJADOR=0 then 0 else L.ID_TRABAJADOR  end = P_ID_TRABAJADOR  
            )Y
        ON (C.ID_TARDANZA=Y.ID_TARDANZA)
        WHEN  MATCHED THEN UPDATE SET 
          C.ID_LICENCIA_PERMISO = Y.ID_LICENCIA_PERMISO,
          C.ESTADO=CASE WHEN Y.TIPO='SI' THEN 'J' ELSE NULL END,
          C.ID_USER_REG=P_ID_USER_REG,
          C.FECHA_REG=clock_timestamp();

        
        MERGE INTO PLLA_TARDANZA C 
                USING(
                  SELECT  L.ID_LICENCIA_PERMISO,T.ID_TARDANZA,S.TIPO 
                  FROM PLLA_TARDANZA T,ENOC.VW_LICENCIA_PERMISO L,PLLA_TIPO_SUSPENSION S
                  WHERE  L.ID_TIPO_SUSPENSION=S.ID_TIPO_SUSPENSION
                  AND T.ID_TRABAJADOR=L.ID_TRABAJADOR
                  AND to_char(T.FECHA,'YYYY-MM-DD')=to_char(L.FECHA_DESDE,'YYYY-MM-DD')
                  AND (to_char(L.FECHA_DESDE,'YYYY'))::numeric =P_ID_ANHO 
                  and (to_char(L.FECHA_DESDE,'MM'))::numeric =P_ID_MES
                  AND L.PERIODO='H'
                  AND L.ID_ESTADO_LICA_PER='02'
                 -- AND L.TIEMPO IN('ER')
                  AND T.NUM_MINUTOS_TAR_REF>0
                  AND T.ID_SEDEAREA IN (
                    SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
                  )
                  AND case when P_ID_TRABAJADOR=0 then 0 else L.ID_TRABAJADOR end = P_ID_TRABAJADOR 
            )Y
        ON (C.ID_TARDANZA=Y.ID_TARDANZA)
        WHEN  MATCHED THEN UPDATE SET 
          C.ID_LICENCIA_PERMISO_REF = Y.ID_LICENCIA_PERMISO,
          C.ESTADO=CASE WHEN Y.TIPO='SI' THEN 'J' ELSE NULL END,
          C.ID_USER_REG=P_ID_USER_REG,
          C.FECHA_REG=clock_timestamp();

        
       /*
        UPDATE PLLA_ASISTENCIA SET
        JUSTIFICADO=NULL,
        ID_USER_REG=P_ID_USER_REG,
        FECHA_REG=SYSDATE
        WHERE JUSTIFICADO='J'
        AND ID_SEDEAREA IN(
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        )
        AND to_number(to_char(FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(FECHA,'MM'))=P_ID_MES
        AND ID_TIPO_CONTROL_PERSONAL=3 --FISCALIZABLE
        AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR;
       
        UPDATE PLLA_ASISTENCIA SET
        JUSTIFICADO='S',
        ID_USER_REG=P_ID_USER_REG,
        FECHA_REG=SYSDATE
        WHERE ID_MOTIVO_ASIST='A'
        AND ID_SEDEAREA IN(
          SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
        )
        AND ID_ASISTENCIA IN(
          SELECT ID_ASISTENCIA from PLLA_TARDANZA where to_number(to_char(FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(FECHA,'MM'))=P_ID_MES
          AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR
          AND ID_SEDEAREA IN(
            SELECT ID_SEDEAREA FROM ELISEO.ORG_SEDE_AREA WHERE ID_ENTIDAD=P_ID_ENTIDAD AND ID_DEPTO LIKE P_ID_DEPTO||'%'
          ) AND ESTADO='J'
        )
        AND to_number(to_char(FECHA,'YYYY'))=P_ID_ANHO and to_number(to_char(FECHA,'MM'))=P_ID_MES
        AND (COALESCE(HORA_ENTRADA_MOD,HORA_ENTRADA) IS NOT NULL OR COALESCE(HORA_ENTRADA_REF_MOD,HORA_ENTRADA_REF) IS NOT NULL)
        AND (COALESCE(NUM_MINUTOS_TAR,0)>0  OR COALESCE(NUM_MINUTOS_TAR_REF,0)>0)
        AND ID_TIPO_CONTROL_PERSONAL=3 --FISCALIZABLE
        AND case when P_ID_TRABAJADOR=0 then 0 else ID_TRABAJADOR end = P_ID_TRABAJADOR;
        */
        
        
        P_ERROR:=l_error;
        P_MSGERROR:= l_msgerror;
        
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_control_generar_tardanza (P_ID_ENTIDAD bigint,P_ID_DEPTO text,P_ID_ANHO bigint,P_ID_MES bigint,P_ID_TRABAJADOR bigint,P_ID_USER_REG bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
