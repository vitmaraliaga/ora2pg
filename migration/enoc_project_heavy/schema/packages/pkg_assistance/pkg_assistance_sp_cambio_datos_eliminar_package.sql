-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_cambio_datos_eliminar ( P_ID bigint, P_ID_USER bigint, P_TIPO text, P_ERROR OUT bigint, P_MSGERROR OUT text) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;
    l_id_ant bigint;
    l_id_tipo_horario_ant bigint;
    l_id_trabajador bigint;
    l_id_control_personal_ant bigint;
    l_id_situacion_especial_ant varchar(5);
    l_desde_ant timestamp(0);
    l_fec_actual timestamp(0);
    l_desde timestamp(0);

BEGIN
    
    l_fec_actual:= to_date(TO_CHAR(clock_timestamp(), 'YYYY-MM-DD'),'YYYY-MM-DD');
    case P_TIPO

      when 'TH' then

       select ID_TIPO_HORARIO_TRAB_ANT, ID_TRABAJADOR,DESDE into STRICT l_id_ant,l_id_trabajador,l_desde from ENOC.PLLA_TIPO_HORARIO_TRAB
       where ID_TIPO_HORARIO_TRAB=P_ID;

       if (l_id_ant IS NOT NULL AND l_id_ant::text <> '') then
        
        
        select id_tipo_horario, desde into STRICT l_id_tipo_horario_ant,l_desde_ant
        from ENOC.PLLA_TIPO_HORARIO_TRAB
        where ID_TIPO_HORARIO_TRAB=l_id_ant;

        IF l_desde<=l_fec_actual THEN
          if to_char(l_fec_actual,'MMYYY')<> to_char(l_desde,'MMYYY') then
              l_error:=1;
              l_msgerror:='No se puede eliminar, fecha desde tiene que ser del mes actual';
--               GOTO salida_final;
          end if;
        END IF;
        update ENOC.PLLA_TIPO_HORARIO_TRAB set
          HASTA = NULL,
          ID_USER_MOD = P_ID_USER,
          FECHA_MOD =clock_timestamp()
        where ID_TIPO_HORARIO_TRAB=l_id_ant;

        UPDATE MOISES.TRABAJADOR SET 
          ID_TIPO_HORARIO=l_id_tipo_horario_ant
        WHERE ID_TRABAJADOR=l_id_trabajador;

       end if;

       DELETE FROM ENOC.PLLA_TIPO_HORARIO_TRAB WHERE ID_TIPO_HORARIO_TRAB=P_ID;

      
      when 'TP' then
      
       select ID_CONTROL_PERSONAL_TRAB_ANT, ID_TRABAJADOR into STRICT l_id_ant,l_id_trabajador from ENOC.PLLA_CONTROL_PERSONAL_TRAB
       where ID_CONTROL_PERSONAL_TRAB=P_ID;

       if (l_id_ant IS NOT NULL AND l_id_ant::text <> '') then
        
        
        select ID_TIPO_CONTROL_PERSONAL into STRICT l_id_control_personal_ant
        from ENOC.PLLA_CONTROL_PERSONAL_TRAB
        where ID_CONTROL_PERSONAL_TRAB=l_id_ant;

         
        update ENOC.PLLA_CONTROL_PERSONAL_TRAB set
          HASTA = NULL,
          ID_USER_MOD = P_ID_USER, 
          FECHA_MOD =clock_timestamp()
        where ID_CONTROL_PERSONAL_TRAB=l_id_ant;

        UPDATE MOISES.TRABAJADOR SET 
          ID_TIPO_CONTROL_PERSONAL=l_id_control_personal_ant
        WHERE ID_TRABAJADOR=l_id_trabajador;

       end if;

       DELETE FROM ENOC.PLLA_CONTROL_PERSONAL_TRAB WHERE ID_CONTROL_PERSONAL_TRAB=P_ID;

      
      when 'TM' then
       select ID_TRABAJADOR_SIT_ESP_ANT, ID_TRABAJADOR into STRICT l_id_ant,l_id_trabajador from moises.TRABAJADOR_SIT_ESP
       where ID_TRABAJADOR_SIT_ESP=P_ID;

       if (l_id_ant IS NOT NULL AND l_id_ant::text <> '') then
        
        
        select ID_SITUACION_ESPECIAL into STRICT l_id_situacion_especial_ant
        from moises.TRABAJADOR_SIT_ESP
        where ID_TRABAJADOR_SIT_ESP=l_id_ant;

         
        update moises.TRABAJADOR_SIT_ESP set
          HASTA = NULL,
          ID_USER_MOD = P_ID_USER, 
          FECHA_MOD =clock_timestamp()
        where ID_TRABAJADOR_SIT_ESP=l_id_ant;

        UPDATE MOISES.TRABAJADOR SET 
          ID_SITUACION_ESPECIAL=l_id_situacion_especial_ant
        WHERE ID_TRABAJADOR=l_id_trabajador;

       end if;

       DELETE FROM moises.TRABAJADOR_SIT_ESP WHERE ID_TRABAJADOR_SIT_ESP=P_ID;

    end case;
--     <<salida_final>>
    P_ERROR:=l_error;
		P_MSGERROR := l_msgerror;
   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_cambio_datos_eliminar ( P_ID bigint, P_ID_USER bigint, P_TIPO text, P_ERROR OUT bigint, P_MSGERROR OUT text) FROM PUBLIC;
