-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_assistance,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_assistance_sp_validar_boton_marcacion ( P_ID_TRABAJADOR bigint, P_LAT bigint, P_LNG bigint, P_ID_MAPA_POLIGONO OUT bigint, P_CODIGO_TIPO_MODALIDAD OUT text, P_FECHA OUT text, P_ERROR OUT bigint, P_MSGERROR OUT text ) AS $body$
DECLARE

    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_contar bigint;
    l_items bigint;
    l_id_anho bigint;
    l_id_mes bigint;
    l_id_dia bigint;
    l_nro_dia bigint;

    L_ID_MAPA_POLIGONO	bigint:=0;
    L_ID_SITUACION_ESPECIAL	varchar(2);
    L_ID_TIPO_CONTROL_PERSONAL	bigint;
    L_ID_TIPO_HORARIO	bigint;
    L_ID_CONDICION_LABORAL	varchar(10);
    L_ID_SEDEAREA	bigint;
    L_ID_PERFIL_PUESTO	bigint;
    L_ID_USERDEVICE	bigint;
    L_ID_HORARIO_MENSUAL_DET	bigint;

    l_id_mapa_trabajador bigint;
    l_id_mapa_area bigint;
    l_id_entidad bigint;
    l_id_depto_padre varchar(10);
    l_codigo_tipo_modalidad  varchar(10);
    l_id_area bigint;
    l_id_persona bigint;
    l_id_situacion_trabajador varchar(5);
    l_tipo_hora varchar(15);
    l_id_tiempo_trabajado bigint;

    l_id_horario_bloque bigint;
    l_id_dia_th bigint;
    l_fec_actual timestamp(0);
    l_fecha_reg timestamp(0);
    l_fecha_ult varchar(50);

    l_fec_ayer timestamp(0);
    l_id_anho_ayer bigint;
    l_id_mes_ayer bigint;
    l_id_dia_ayer bigint;
    l_resultado bigint:=0;

BEGIN
     l_fec_actual:= to_date(TO_CHAR(clock_timestamp(), 'YYYY-MM-DD'),'YYYY-MM-DD');
     l_fecha_reg:= l_fec_actual;

         
    select 
         (to_char(l_fec_actual,'YYYY'))::numeric , 
         (to_char(l_fec_actual,'MM'))::numeric ,
         (to_char(l_fec_actual,'DD'))::numeric ,
         (TO_CHAR(l_fec_actual, 'D', 'NLS_DATE_LANGUAGE=ENGLISH'))::numeric  
         into STRICT l_id_anho,l_id_mes,l_id_dia,l_nro_dia;

         
         select 
            ID_ENTIDAD,
            ID_CONDICION_LABORAL,
            ID_SEDEAREA,
            ID_PERFIL_PUESTO,
            id_persona,
            id_situacion_trabajador,
            ID_TIPO_TIEMPO_TRABAJO
            into STRICT
            l_id_entidad,
            L_ID_CONDICION_LABORAL,
            L_ID_SEDEAREA,
            L_ID_PERFIL_PUESTO,
            l_id_persona,
            l_id_situacion_trabajador,
            l_id_tiempo_trabajado
            from enoc.vw_trabajador where id_trabajador=P_ID_TRABAJADOR;

          if l_id_situacion_trabajador not in ('1') then
                l_error:=1;
                l_msgerror:='Trabajdor no está activo';
--                 GOTO salida_final;
          end if;

         
         --vacacion
          
          select count(*) into STRICT l_contar from ENOC.vw_rol_vacacional where id_trabajador=P_ID_TRABAJADOR and (l_fec_actual between fecha_ini and fecha_fin) and condicion='P';
          if l_contar > 0 then
            l_error:=1;
            l_msgerror:='El trabajador está de vacaciones en la fecha '||to_char(l_fec_actual,'DD/MM/YYYY');
--             GOTO salida_final;
          end if;

           --permisos
          select count(*) into STRICT l_contar from (
            SELECT ID_LICENCIA_PERMISO from ENOC.vw_LICENCIA_PERMISO where id_trabajador=P_ID_TRABAJADOR and (l_fec_actual between fecha_desde and fecha_hasta) and engrupo='N' and id_estado_lica_per not in ('00','04') 
            
union

            SELECT a.ID_LICENCIA_PERMISO from ENOC.vw_LICENCIA_PERMISO a, enoc.plla_LICENCIA_PERMISO_DET b where a.ID_LICENCIA_PERMISO=b.ID_LICENCIA_PERMISO and b.id_trabajador=P_ID_TRABAJADOR 
            and (l_fec_actual between a.fecha_desde and a.fecha_hasta) and a.engrupo='S' and a.id_estado_lica_per not in ('00','04') 
          ) alias5;

          if l_contar > 0 then
            l_error:=1;
            l_msgerror:='El trabajador está de permiso y/o licencia en la fecha '||to_char(l_fec_actual,'DD/MM/YYYY');
--             GOTO salida_final;
          end if;

        
          ------
         select count(1) into STRICT l_contar from ENOC.PLLA_TIPO_HORARIO_TRAB
         where id_trabajador= P_ID_TRABAJADOR
         and l_fecha_reg between desde and coalesce(hasta,l_fec_actual);

         if l_contar<>1 then
            l_error:=1;
            l_msgerror:='Verificar configuración de asignacion de tipo horario';
--             GOTO salida_final;
         end if;

         select id_tipo_horario into STRICT L_ID_TIPO_HORARIO from ENOC.PLLA_TIPO_HORARIO_TRAB
         where id_trabajador= P_ID_TRABAJADOR
         and l_fecha_reg between desde and coalesce(hasta,l_fec_actual);

          ------
         select count(1) into STRICT l_contar from ENOC.PLLA_CONTROL_PERSONAL_TRAB
         where id_trabajador= P_ID_TRABAJADOR
         and l_fecha_reg between desde and coalesce(hasta,l_fec_actual);

         if l_contar<>1 then
            l_error:=1;
            l_msgerror:='Verificar configuración de asignacion de tipo control personal';
--             GOTO salida_final;
         end if;

         select ID_TIPO_CONTROL_PERSONAL into STRICT L_ID_TIPO_CONTROL_PERSONAL from ENOC.PLLA_CONTROL_PERSONAL_TRAB
         where id_trabajador= P_ID_TRABAJADOR
         and l_fecha_reg between desde and coalesce(hasta,l_fec_actual);
         ----
         
         select count(1) into STRICT l_contar from  MOISES.TRABAJADOR_SIT_ESP a,  ENOC.PLLA_TIPO_MODALIDAD_TRAB b, MOISES.SITUACION_ESPECIAL c
         where a.ID_SITUACION_ESPECIAL=C.ID_SITUACION_ESPECIAL
         and b.ID_TIPO_MODALIDAD_TRAB = c.ID_TIPO_MODALIDAD_TRAB
         and a.id_trabajador= P_ID_TRABAJADOR
         and l_fecha_reg between a.desde and coalesce(a.hasta,l_fec_actual);

         if l_contar<>1 then
            l_error:=1;
            l_msgerror:='Verificar configuración de asignacion de modalidad';
--             GOTO salida_final;
         end if;

         select b.codigo into STRICT l_codigo_tipo_modalidad from  MOISES.TRABAJADOR_SIT_ESP a,  ENOC.PLLA_TIPO_MODALIDAD_TRAB b, MOISES.SITUACION_ESPECIAL c
         where a.ID_SITUACION_ESPECIAL=C.ID_SITUACION_ESPECIAL
         and b.ID_TIPO_MODALIDAD_TRAB = c.ID_TIPO_MODALIDAD_TRAB
         and a.id_trabajador= P_ID_TRABAJADOR
         and l_fecha_reg between a.desde and coalesce(a.hasta,l_fec_actual);

         
          ----------
         
          select count(*) into STRICT l_contar from plla_parametros_valor  a, plla_parametros b
          where b.id_parametro=a.id_parametro
          and a.id_entidad=l_id_entidad
          and a.id_anho=l_id_anho;

          IF l_contar=0 then
            l_error:=1;
            l_msgerror:='Falta configurar parametros para el año '||l_id_anho::text;
--             GOTO salida_final;
          end if;

          select b.CODIGO into STRICT l_tipo_hora from enoc.plla_tipo_horario a, enoc.PLLA_TIPO_CONFIG_HORARIO b
          where a.ID_TIPO_CONFIG_HORARIO=b.ID_TIPO_CONFIG_HORARIO
          and a.id_tipo_horario =  L_ID_TIPO_HORARIO;

          
          if l_tipo_hora='HM' then
   
              select count(*) into STRICT l_contar from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B
              where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
              AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
              AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
              AND A.ID_ANHO=l_id_anho
              AND A.ID_MES=l_id_mes
              AND B.ID_DIA=l_id_dia;

              if l_contar = 1 then
                select B.ID_HORARIO_MENSUAL_DET, b.id_horario_bloque into STRICT L_ID_HORARIO_MENSUAL_DET,l_id_horario_bloque from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B
                where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
                AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
                AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
                AND A.ID_ANHO=l_id_anho
                AND A.ID_MES=l_id_mes
                AND B.ID_DIA=l_id_dia;

                
              else
              
                 select l_fec_actual-1 into STRICT l_fec_ayer;

                 select 
                 (to_char(l_fec_ayer,'YYYY'))::numeric , 
                 (to_char(l_fec_ayer,'MM'))::numeric ,
                 (to_char(l_fec_ayer,'DD'))::numeric 
                 into STRICT l_id_anho_ayer,l_id_mes_ayer,l_id_dia_ayer;

                 select count(*) into STRICT l_contar from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B,ENOC.PLLA_horario_bloque HB
                 where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
                 AND b.id_horario_bloque=Hb.id_horario_bloque
                 AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
                 AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
                 AND A.ID_ANHO=l_id_anho_ayer
                 AND A.ID_MES=l_id_mes_ayer
                 AND B.ID_DIA=l_id_dia_ayer
                 AND COALESCE(HB.sal_diasig,0)=1;
                 if l_contar = 1 then
                  select B.ID_HORARIO_MENSUAL_DET, b.id_horario_bloque into STRICT L_ID_HORARIO_MENSUAL_DET,l_id_horario_bloque from ENOC.PLLA_HORARIO_MENSUAL A, ENOC.PLLA_HORARIO_MENSUAL_DET B
                  where A.ID_HORARIO_MENSUAL = B.ID_HORARIO_MENSUAL
                  AND A.ID_TRABAJADOR = P_ID_TRABAJADOR
                  AND A.ID_TIPO_HORARIO=L_ID_TIPO_HORARIO
                  AND A.ID_ANHO=l_id_anho_ayer
                  AND A.ID_MES=l_id_mes_ayer
                  AND B.ID_DIA=l_id_dia_ayer;
                 else
                  l_error:=1;
                  l_msgerror:='Horario mensual: No esta configurado para la fecha: '||to_char(l_fec_actual,'DD/MM/YYYY');
--                   GOTO salida_final;
                 end if;

                
                
              end if;

          else
            if l_tipo_hora<>'SH' then
              select COUNT(*) into STRICT l_contar from enoc.plla_horario_detalle where id_tipo_horario=L_ID_TIPO_HORARIO and id_dia=l_nro_dia;

              l_id_dia_th:=l_nro_dia;
              if l_contar=0 then
                 l_error:=1;
                 l_msgerror:='Horario fijo: No esta configurado para la fecha: '||to_char(l_fec_actual,'DD/MM/YYYY');
--                  GOTO salida_final;

              end if;
            end if;
          END IF;

          if l_tipo_hora<>'SH' then
                if l_codigo_tipo_modalidad='TP' THEN
                    select id_depto_padre,id_area into STRICT l_id_depto_padre,l_id_area from eliseo.VW_SEDE_AREA where ID_SEDEAREA=L_ID_SEDEAREA;

                    select count(*) into STRICT l_contar from (
                      SELECT x.id_mapa_poligono from enoc.plla_mapa_trabajador x
                      where x.id_trabajador=P_ID_TRABAJADOR 
                      
union

                      SELECT y.id_mapa_poligono from enoc.plla_mapa_area y
                      where y.id_entidad=l_id_entidad 
                      and y.id_depto=l_id_depto_padre 
                      and y.id_area =l_id_area
                    ) alias1;
                    if l_contar=0 THEN
                       l_error:=1;
                       l_msgerror:='No esta asignado a polígono de marcación';
--                        GOTO salida_final;
                    END IF;
                    /*enoc.pkg_assistance_sp_validar_coordenada_asist(
                       P_ID_TRABAJADOR,
                       P_LAT,
                       P_LNG,
                       l_resultado,
                       l_error,
                       l_msgerror
                     );
                     if l_resultado=0 then
                       l_error:=1;
                       l_msgerror:='Está fuera del Área del trabajo';
--                        GOTO salida_final;
                     end if;*/
                end if;
          end if;

          
          select coalesce(to_char(max(fechahora),'DD/MM/YYYY HH24:MI:SS'),'-') into STRICT l_fecha_ult from enoc.plla_marcacion where id_trabajador=P_ID_TRABAJADOR and to_char(fechahora,'DDMMYYYY')= to_char(l_fec_actual,'DDMMYYYY');

--     <<salida_final>>
    P_ID_MAPA_POLIGONO:=L_ID_MAPA_POLIGONO;
	  P_CODIGO_TIPO_MODALIDAD:=l_codigo_tipo_modalidad;
    P_FECHA:=l_fecha_ult;
    P_ERROR:=l_error;
		P_MSGERROR := l_msgerror;
   END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_assistance_sp_validar_boton_marcacion ( P_ID_TRABAJADOR bigint, P_LAT bigint, P_LNG bigint, P_ID_MAPA_POLIGONO OUT bigint, P_CODIGO_TIPO_MODALIDAD OUT text, P_FECHA OUT text, P_ERROR OUT bigint, P_MSGERROR OUT text ) FROM PUBLIC;
