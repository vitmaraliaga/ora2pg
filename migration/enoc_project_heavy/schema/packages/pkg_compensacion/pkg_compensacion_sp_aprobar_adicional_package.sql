-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_aprobar_adicional (P_ID_ADICIONAL bigint,P_ID_ESTADO_ADICIONAL text,P_ID_CONCEPTO_PLANILLA bigint,P_OBSERVACION text,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_adicional_estado bigint;
        l_id_tipo_concep_adic bigint;
        l_estado_adicional varchar(5);
        l_finalizado bigint:=0;

BEGIN
        
        select coalesce(max(ID_ADICIONAL_ESTADO),0)+1 into STRICT l_id_adicional_estado from ENOC.PLLA_ADICIONAL_ESTADO;

        SELECT ID_TIPO_CONCEP_ADIC INTO STRICT l_id_tipo_concep_adic FROM ENOC.VW_ADICIONAL WHERE ID_ADICIONAL=P_ID_ADICIONAL;

        SELECT MAX(ID_ESTADO_ADICIONAL) into STRICT l_estado_adicional FROM ENOC.PLLA_TIPO_CONCEP_ADIC_EST WHERE ID_TIPO_CONCEP_ADIC=l_id_tipo_concep_adic AND ID_ESTADO_ADICIONAL NOT IN ('05','00');

        if l_estado_adicional = P_ID_ESTADO_ADICIONAL then
          l_finalizado:=1;
        end if;

        
        IF P_ID_ESTADO_ADICIONAL NOT IN ('00','05') AND P_ID_CONCEPTO_PLANILLA > 0 THEN
          update ENOC.PLLA_ADICIONAL set
          ID_CONCEPTO_PLANILLA=P_ID_CONCEPTO_PLANILLA
          where id_adicional=P_ID_ADICIONAL
          AND coalesce(ID_CONCEPTO_PLANILLA::text, '') = '';
        END IF;

        update ENOC.PLLA_ADICIONAL set
        ID_ESTADO_ADICIONAL=P_ID_ESTADO_ADICIONAL,
        FINALIZADO = l_finalizado
        where id_adicional=P_ID_ADICIONAL;

        insert into ENOC.PLLA_ADICIONAL_ESTADO(
          ID_ADICIONAL_ESTADO,
          ID_ESTADO_ADICIONAL,
          ID_ADICIONAL,
          ID_USER,
          FECHA,
          OBSERVACION
        )values (
          l_id_adicional_estado,
          P_ID_ESTADO_ADICIONAL,
          P_ID_ADICIONAL,
          P_ID_USER_REG,
          clock_timestamp(),
          P_OBSERVACION
        );

--         <<salida_approve_adicional>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_aprobar_adicional (P_ID_ADICIONAL bigint,P_ID_ESTADO_ADICIONAL text,P_ID_CONCEPTO_PLANILLA bigint,P_OBSERVACION text,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) FROM PUBLIC;
