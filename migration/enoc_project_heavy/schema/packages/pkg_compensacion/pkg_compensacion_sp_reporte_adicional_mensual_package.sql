-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_reporte_adicional_mensual (P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint,P_ANHO_ID bigint, P_ID_MES bigint, P_ID_TRABAJADOR bigint,P_ID_CONDICION_LABORAL text,P_ID_TIPO_TIEMPO_TRABAJO bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE

  l_query varchar(4000):='';
  l_campos varchar(2000):='';
  l_values varchar(2000):='';
  l_groups varchar(2000):='';
  l_id_concepto_planilla bigint;
  l_mes varchar(50);
  l_id_conceptoaps bigint;
  l_nombre varchar(500);
  l_codigo varchar(25);

BEGIN
  
    delete from enoc.tt_rep_sueldo_mensual;

    select id_concepto_planilla,id_conceptoaps,nombre, codigo into STRICT l_id_concepto_planilla, l_id_conceptoaps, l_nombre, l_codigo  from ENOC.plla_concepto_planilla where codigo='REM_BAS';

    
    l_campos:='ID_PERSONA,ID_TRABAJADOR,ID_CONTRATO,APELLIDONOMBRE,NUM_DOCUMENTO,SIGLAS,AREA,PUESTO,ID_ANHO,MES,ID_DEPTO,CCOSTO,ID_AREA,ID_ENTIDAD,ID_DEPTO_PADRE,IMPORTE,ADICIONAL,ID_CONCEPTO_PLANILLA,ID_CONCEPTOAPS,CONCEPTO_PLANILLA,CODIGO_PLLA,CONCEPTO_ADICIONAL,ESTADO,ID_ADICIONAL,id_condicion_laboral';

    
    select id_concepto_planilla into STRICT l_id_concepto_planilla from ENOC.plla_concepto_planilla where codigo='REM_BAS';

    --adicional por trabajador
    l_groups:='group by  A.ID_PERSONA,A.ID_TRABAJADOR,A.ID_CONTRATO,A.APELLIDONOMBRE,A.NUM_DOCUMENTO,A.SIGLAS,A.AREA,A.PUESTO,A.ID_ANHO,A.MES,A.ID_DEPTO,A.CCOSTO,A.ID_AREA,A.ID_ENTIDAD,A.ID_DEPTO_PADRE,A.ID_CONCEPTO_PLANILLA,B.ID_CONCEPTOAPS,B.NOMBRE,B.CODIGO,A.CONCEPTO_ADICIONAL,e.nombre,A.ID_ADICIONAL,a.id_condicion_laboral ';
    l_values:='A.ID_PERSONA,A.ID_TRABAJADOR,A.ID_CONTRATO,A.APELLIDONOMBRE,A.NUM_DOCUMENTO,A.SIGLAS,A.AREA,A.PUESTO,A.ID_ANHO,A.MES,A.ID_DEPTO,A.CCOSTO,A.ID_AREA,A.ID_ENTIDAD,A.ID_DEPTO_PADRE, to_number(0.00) as importe, coalesce(sum(A.IMPORTE),0) as ADICIONAL,A.ID_CONCEPTO_PLANILLA,B.ID_CONCEPTOAPS,B.NOMBRE,B.CODIGO,A.CONCEPTO_ADICIONAL, e.nombre,A.ID_ADICIONAL,a.id_condicion_laboral ';
    l_query:='insert into enoc.tt_rep_sueldo_mensual('||l_campos||') ';
    l_query:=l_query||'select '||l_values||' from enoc.vw_adicional_det A inner join ENOC.PLLA_ESTADO_ADICIONAL e on e.id_estado_adicional=a.id_estado_adicional  left join enoc.plla_concepto_planilla B on a.id_concepto_planilla= b.id_concepto_planilla';
    l_query:=l_query||' where a.id_entidad=:s_id_entidad';
    l_query:=l_query||' and a.id_anho=:s_id_anho';
    l_query:=l_query||' and a.id_mes=:s_id_mes';
    l_query:=l_query||' and a.vigencia=1';
    l_query:=l_query||' and a.id_estado_adicional not in(''00'',''05'') ';
    if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
      l_query:=l_query||' and a.id_depto_padre='''||P_ID_DEPTO||''' ';
    end if;
    if P_ID_AREA<>0 then
      l_query:=l_query||' and a.id_area='||P_ID_AREA::text;
    end if;
    if P_ID_TRABAJADOR<>0 then
      l_query:=l_query||' and a.id_trabajador='||P_ID_TRABAJADOR::text;
    end if;
    if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
      l_query:=l_query||' and a.ID_CONDICION_LABORAL='''||P_ID_CONDICION_LABORAL||''' ';
    end if;
    if P_ID_TIPO_TIEMPO_TRABAJO <> 0 then
      l_query:=l_query||' and a.ID_TIPO_TIEMPO_TRABAJO='||P_ID_TIPO_TIEMPO_TRABAJO::text;
    end if;
    --l_query:=l_query||' and id_concepto_planilla='||to_char(l_id_concepto_planilla);
    l_query:=l_query||' '||l_groups;

     EXECUTE l_query USING P_ID_ENTIDAD,P_ANHO_ID,P_ID_MES;
    --adicional grupal
    l_values:='a.ID_PERSONA,a.ID_TRABAJADOR,a.ID_CONTRATO,a.APELLIDONOMBRE,a.NUM_DOCUMENTO,a.SIGLAS,a.AREA,a.PUESTO,a.ID_ANHO,MES,a.ID_DEPTO,a.CCOSTO,a.ID_AREA,a.ID_ENTIDAD,a.ID_DEPTO_PADRE, to_number(0.00) as importe, coalesce(sum(a.IMPORTE),0) as ADICIONAL,a.ID_CONCEPTO_PLANILLA,b.ID_CONCEPTOAPS,b.nombre,b.CODIGO,a.CONCEPTO_ADICIONAL,e.nombre,A.ID_ADICIONAL,a.id_condicion_laboral ';
    l_query:='insert into enoc.tt_rep_sueldo_mensual('||l_campos||') ';
    l_query:=l_query||'select '||l_values||' from enoc.vw_adicional_grupo A inner join ENOC.PLLA_ESTADO_ADICIONAL e on e.id_estado_adicional=a.id_estado_adicional  left join enoc.plla_concepto_planilla B on a.id_concepto_planilla= b.id_concepto_planilla ';
    l_query:=l_query||' where a.id_entidad=:s_id_entidad';
    l_query:=l_query||' and a.id_anho=:s_id_anho';
    l_query:=l_query||' and a.id_mes=:s_id_mes';
    l_query:=l_query||' and a.vigencia=1';
    l_query:=l_query||' and a.id_estado_adicional not in(''00'',''05'') ';
    if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
      l_query:=l_query||' and a.id_depto_padre='''||P_ID_DEPTO||''' ';
    end if;
    if P_ID_AREA<>0 then
      l_query:=l_query||' and a.id_area='||P_ID_AREA::text;
    end if;
    if P_ID_TRABAJADOR<>0 then
      l_query:=l_query||' and id_trabajador='||P_ID_TRABAJADOR::text;
    end if;
    if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
      l_query:=l_query||' and a.ID_CONDICION_LABORAL='''||P_ID_CONDICION_LABORAL||''' ';
    end if;
    if P_ID_TIPO_TIEMPO_TRABAJO <> 0 then
      l_query:=l_query||' and a.ID_TIPO_TIEMPO_TRABAJO='||P_ID_TIPO_TIEMPO_TRABAJO::text;
    end if;
    --l_query:=l_query||' and id_concepto_planilla='||to_char(l_id_concepto_planilla);
    l_query:=l_query||' '||l_groups;

    --DBMS_OUTPUT.PUT_LINE(l_query);
    EXECUTE l_query USING P_ID_ENTIDAD,P_ANHO_ID,P_ID_MES;

    MERGE INTO enoc.tt_rep_sueldo_mensual S 
    USING( 
      SELECT 
      ID_TRABAJADOR, 
      SUELDO 
      from enoc.VW_REMUNERACION 
      where tipo_pago='F' 
      AND VIGENCIA=1
      and id_trabajador in (
        SELECT id_trabajador from enoc.tt_rep_sueldo_mensual
      ) 
    )T ON (T.ID_TRABAJADOR=S.ID_TRABAJADOR)
    WHEN  MATCHED THEN UPDATE SET  
    S.IMPORTE=T.SUELDO;

    
    MERGE INTO enoc.tt_rep_sueldo_mensual S 
    USING( 
      SELECT 
      ID_TRABAJADOR, 
      COALESCE(SUM(IMPORTE),0) AS SUELDO 
      from enoc.VW_REMUNERACION_DET 
      where tipo_pago='H' 
      AND ID_ANHO=P_ANHO_ID
      AND ID_MES=P_ID_MES
      and vigencia_det=1
      and id_trabajador in (
        SELECT id_trabajador from enoc.tt_rep_sueldo_mensual
      ) 
      group by ID_TRABAJADOR
    )T ON (T.ID_TRABAJADOR=S.ID_TRABAJADOR)
    WHEN  MATCHED THEN UPDATE SET  
    S.IMPORTE=T.SUELDO;

    MERGE INTO enoc.tt_rep_sueldo_mensual S 
    USING(
    SELECT ID_TRABAJADOR, 
    sum(coalesce(importe,0)+ coalesce(adicional,0)) as total 
    from enoc.tt_rep_sueldo_mensual 
    group by ID_TRABAJADOR
    )T ON (T.ID_TRABAJADOR=S.ID_TRABAJADOR)
    WHEN  MATCHED THEN UPDATE SET  
    S.TOTAL=T.total;

    
    OPEN CURSOR FOR  
    SELECT
    a.ID_PERSONA,a.ID_TRABAJADOR,0 as ID_CONTRATO,a.APELLIDONOMBRE,a.NUM_DOCUMENTO,a.SIGLAS,a.AREA,a.PUESTO,a.ID_ANHO,a.MES,a.ID_DEPTO,a.CCOSTO,a.ID_AREA,a.ID_ENTIDAD,a.ID_DEPTO_PADRE,coalesce(sum(a.IMPORTE),0) as importe,
    coalesce(sum(a.ADICIONAL),0) as adicional, a.TOTAL,b.nombre as deptopadre,
    a.ID_CONCEPTO_PLANILLA,a.ID_CONCEPTOAPS,a.CONCEPTO_PLANILLA,a.CODIGO_PLLA,a.CONCEPTO_ADICIONAL,a.estado, a.id_adicional,a.id_condicion_laboral, c.nombre as condicion_laboral, t.id_situacion_trabajador, st.nombre_corto as situacion_trabajador,
    t.ID_TIPO_TIEMPO_TRABAJO,tt.nombre as TIPO_TIEMPO_TRABAJO
    from enoc.tt_rep_sueldo_mensual a, eliseo.conta_entidad_depto b, moises.condicion_laboral c, moises.trabajador t, moises.situacion_trabajador st, moises.tipo_tiempo_trabajo tt
    where a.id_entidad=b.id_entidad
    and a.ID_DEPTO_PADRE=b.id_depto
    and a.id_condicion_laboral=c.id_condicion_laboral
    and a.id_trabajador=t.id_trabajador
    and t.id_situacion_trabajador=st.id_situacion_trabajador
    and t.id_tipo_tiempo_trabajo=tt.id_tipo_tiempo_trabajo
    group by a.ID_PERSONA,a.ID_TRABAJADOR,a.APELLIDONOMBRE,a.NUM_DOCUMENTO,a.SIGLAS,a.AREA,a.PUESTO,a.ID_ANHO,a.MES,a.ID_DEPTO,a.CCOSTO,a.ID_AREA,a.ID_ENTIDAD,a.ID_DEPTO_PADRE, a.TOTAL,b.nombre,a.ID_CONCEPTO_PLANILLA,
    a.ID_CONCEPTOAPS,a.CONCEPTO_PLANILLA,a.CODIGO_PLLA,a.CONCEPTO_ADICIONAL,a.estado, a.id_adicional,a.id_condicion_laboral, c.nombre,t.id_situacion_trabajador, st.nombre_corto,t.ID_TIPO_TIEMPO_TRABAJO,tt.nombre
    order by a.APELLIDONOMBRE,a.ID_CONCEPTO_PLANILLA;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_reporte_adicional_mensual (P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_AREA bigint,P_ANHO_ID bigint, P_ID_MES bigint, P_ID_TRABAJADOR bigint,P_ID_CONDICION_LABORAL text,P_ID_TIPO_TIEMPO_TRABAJO bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
