-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_reporte_general ( P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, P_ID_DEPTO text, P_ID_AREA text, P_SEXO text, P_ID_SITUACION_TRABAJADOR text, P_ID_TIPOESTADOCIVIL text, P_ID_SITUACION_EDUCATIVO text, P_ID_TIPORELIGION text, P_ID_TIPOPAIS text, P_ID_TIPODOCUMENTO text, P_ID_REGIMEN_PENSIONARIA text, P_ID_TIPO_CONTROL_PERSONAL text, P_ID_CONDICION_LABORAL text, P_ID_TIPO_CONTRATO text, P_ID_TIPO_TIEMPO_TRABAJO text, P_ID_TIPO_JEFE text, P_ID_PUESTO bigint, P_TIPO_REP text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREAS_USER text, P_ID_USER bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE

      l_FMR decimal(10,2):=0;
      l_contar bigint;
      l_query varchar(4000):='';
      l_id_anho bigint;
      l_id_tipo_nivel_vista bigint;
      L_FMR_ACT bigint:=0;
      l_error bigint:=0;

BEGIN
      
      select count(*) into STRICT  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= P_ID_ENTIDAD and codigo='PARAM_FMR_ESCALA' and id_anho=(to_char(clock_timestamp(),'YYYY'))::numeric;
      if l_contar>0 then
        select importe into STRICT l_FMR from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= P_ID_ENTIDAD and codigo='PARAM_FMR_ESCALA' and id_anho=(to_char(clock_timestamp(),'YYYY'))::numeric;
      end if;
      select count(*) into STRICT  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= P_ID_ENTIDAD and codigo='PARAM_FMR' and id_anho=(to_char(clock_timestamp(),'YYYY'))::numeric;
      if l_contar>0 then
        select importe into STRICT L_FMR_ACT from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= P_ID_ENTIDAD and codigo='PARAM_FMR' and id_anho=(to_char(clock_timestamp(),'YYYY'))::numeric;
      end if;

      if P_RESTRINGIDO='S' then
          select id_tipo_nivel_vista into STRICT l_id_tipo_nivel_vista from eliseo.lamb_acceso_nivel where id_acceso_nivel=P_ID_ACCESO_NIVEL;
        end if;

      select (to_char(clock_timestamp(),'YYYY'))::numeric  into STRICT l_id_anho;

      l_query:='insert into ENOC.TT_REPORTE_GENERAL ';
      l_query:=l_query||'select ';
      l_query:=l_query||'a.id_trabajador,';
      l_query:=l_query||'a.id_persona,';
      l_query:=l_query||'a.apellidonombre,';
      l_query:=l_query||'a.nombre,';
      l_query:=l_query||'a.paterno,';
      l_query:=l_query||'a.materno,';
      l_query:=l_query||'b.puesto,';
      l_query:=l_query||'sa.nombre as area,';
      l_query:=l_query||'sa.id_depto,';
      l_query:=l_query||'sa.ccosto,';
      l_query:=l_query||'ed.nombre as deptopadre,';
      l_query:=l_query||'te.nombre as estado_civil,';
      l_query:=l_query||'se.nombre as situacion_educativo,';
      l_query:=l_query||'tr.nombre as tipo_religion,';
      l_query:=l_query||'tp.nombre as pais,';
      l_query:=l_query||'td.siglas,';
      l_query:=l_query||'rp.nombre as rigen_pensionaria,';
      l_query:=l_query||'st.nombre as situacion_trabajador,';
      l_query:=l_query||'tc.nombre as TIPO_CONTROL_PERSONAL,';
      l_query:=l_query||'cl.nombre as condicion_laboral,';
      l_query:=l_query||'tco.nombre as tipo_contrato,';
      l_query:=l_query||'ttt.nombre as TIPO_TIEMPO_TRABAJO,';
      l_query:=l_query||'rem.tipo_pago,';
      l_query:=l_query||'rem.fmr,';
      l_query:=l_query||'rem.sueldo,';
      l_query:=l_query||'a.id_perfil_puesto,';
      l_query:=l_query||'a.id_sedearea,';
      l_query:=l_query||'sa.id_depto_padre,';
      l_query:=l_query||'a.id_situacion_trabajador,';
      l_query:=l_query||'a.ID_TIPOESTADOCIVIL,';
      l_query:=l_query||'a.id_situacion_educativo,';
      l_query:=l_query||'a.id_tiporeligion,';
      l_query:=l_query||'a.id_tipopais,';
      l_query:=l_query||'a.id_tipodocumento,';
      l_query:=l_query||'a.id_regimen_pensionaria,';
      l_query:=l_query||'a.id_tipo_control_personal,';
      l_query:=l_query||'a.id_condicion_laboral,';
      l_query:=l_query||'a.id_tipo_contrato,';
      l_query:=l_query||'a.id_TIPO_TIEMPO_TRABAJO,';
      l_query:=l_query||'rem.id_remuneracion,';
      l_query:=l_query||'rem.ID_ESCALA_SALARIAL,';
      l_query:=l_query||'esa.PUNTMINIMO,';
      l_query:=l_query||'esa.PUNTMAXIMO, ';
      l_query:=l_query||'a.fecha_inicio,';
      l_query:=l_query||'a.fecha_fin_previsto, ';
      l_query:=l_query||'(esa.PUNTMINIMO/100)*:s_fmr as sueldo_min,';
      l_query:=l_query||'(esa.PUNTMAXIMO/100)*:s_fmr as sueldo_max, ';
      l_query:=l_query||'tex.nombre as nom_sexo, ';
      l_query:=l_query||'A.CORREO, ';
      l_query:=l_query||'A.CORREO_INST, ';
      l_query:=l_query||'A.CELULAR, ';
      l_query:=l_query||'B.ID_TIPO_JEFE, ';
      l_query:=l_query||'TJE.NOMBRE AS TIPO_JEFE, ';
      l_query:=l_query||'A.FEC_NACIMIENTO, ';
      l_query:=l_query||'A.NUM_DOCUMENTO ';

  
      l_query:=l_query||'from ENOC.vw_trabajador a ';
      l_query:=l_query||'inner join enoc.vw_perfil_puesto b on ';
      l_query:=l_query||'a.id_perfil_puesto=b.id_perfil_puesto ';
      l_query:=l_query||'inner join eliseo.vw_sede_area sa ';
      l_query:=l_query||'on a.id_sedearea=sa.id_sedearea ';
      l_query:=l_query||'inner join eliseo.conta_entidad_depto ed on ';
      l_query:=l_query||'sa.id_entidad=ed.id_entidad ';
      l_query:=l_query||'and sa.id_depto_padre=ed.id_depto ';
      l_query:=l_query||'inner join moises.situacion_trabajador st ';
      l_query:=l_query||'on st.id_situacion_trabajador=a.id_situacion_trabajador ';
      l_query:=l_query||'left join moises.TIPO_ESTADO_CIVIL te ';
      l_query:=l_query||'on te.ID_TIPOESTADOCIVIL=a.ID_TIPOESTADOCIVIL ';
      l_query:=l_query||'left join moises.SITUACION_educativa se ';
      l_query:=l_query||'on se.id_situacion_educativo= a.id_situacion_educativo ';
      l_query:=l_query||'left join moises.tipo_religion tr ';
      l_query:=l_query||'on tr.id_tiporeligion=a.id_tiporeligion ';
      l_query:=l_query||'left join moises.tipo_pais tp ';
      l_query:=l_query||'on tp.id_tipopais=a.id_tipopais ';
      l_query:=l_query||'left join moises.tipo_documento td ';
      l_query:=l_query||'on td.id_tipodocumento=a.id_tipodocumento ';
      l_query:=l_query||'left join enoc.plla_regimen_pensionaria rp ';
      l_query:=l_query||'on rp.id_regimen_pensionaria=a.id_regimen_pensionaria ';
      l_query:=l_query||'left join moises.TIPO_CONTROL_PERSONAL tc ';
      l_query:=l_query||'on tc.id_tipo_control_personal=a.id_tipo_control_personal ';
      l_query:=l_query||'left join moises.condicion_laboral cl ';
      l_query:=l_query||'on cl.id_condicion_laboral=a.id_condicion_laboral ';
      l_query:=l_query||'left join enoc.plla_tipo_contrato tco ';
      l_query:=l_query||'on tco.id_tipo_contrato=a.id_tipo_contrato ';
      l_query:=l_query||'left join moises.TIPO_TIEMPO_TRABAJO ttt ';
      l_query:=l_query||'on ttt.id_TIPO_TIEMPO_TRABAJO = a.id_TIPO_TIEMPO_TRABAJO ';
      l_query:=l_query||'left join enoc.plla_remuneracion rem ';
      l_query:=l_query||'on rem.id_trabajador=a.id_trabajador ';
      l_query:=l_query||'and rem.vigencia=1 ';
      l_query:=l_query||'left join enoc.plla_ESCALA_SALARIAL esa ';
      l_query:=l_query||'on esa.ID_GRUPO_ESCALA=B.ID_GRUPO_ESCALA ';
      l_query:=l_query||'and a.id_entidad=esa.id_entidad ';
      l_query:=l_query||'and esa.id_depto =sa.id_depto_padre ';
      l_query:=l_query||'and esa.ID_ANHO=:s_anho ';
      l_query:=l_query||'left join MOISES.TIPO_SEXO tex ';
      l_query:=l_query||'on tex.SEXO=a.SEXO ';
      l_query:=l_query||'left join enoc.PLLA_TIPO_JEFE TJE ';
      l_query:=l_query||'on TJE.ID_TIPO_JEFE=B.ID_TIPO_JEFE ';
      l_query:=l_query||'where a.id_entidad=:s_entidad ';

      if P_ID_PERSONA>0 then
        l_query:=l_query||'and a.id_persona='||P_ID_PERSONA::text||' ';
      end if;
      if (P_SEXO IS NOT NULL AND P_SEXO::text <> '') then
        l_query:=l_query||'and tex.SEXO IN('||P_SEXO||') ';
      end if;
      if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
        l_query:=l_query||'and sa.id_depto_padre='||P_ID_DEPTO||' ';
      end if;
      if (P_ID_AREA IS NOT NULL AND P_ID_AREA::text <> '') then
        l_query:=l_query||'and sa.id_area in('||P_ID_AREA||') ';
      end if;

      if (P_ID_SITUACION_TRABAJADOR IS NOT NULL AND P_ID_SITUACION_TRABAJADOR::text <> '') then
        l_query:=l_query||'and a.id_situacion_trabajador in('||ENOC.FC_REEMPLAZAR_COMA_XDOBLE(P_ID_SITUACION_TRABAJADOR)||') ';
      end if;

      if (P_ID_TIPOESTADOCIVIL IS NOT NULL AND P_ID_TIPOESTADOCIVIL::text <> '') then
        l_query:=l_query||'and a.ID_TIPOESTADOCIVIL in('||P_ID_TIPOESTADOCIVIL||') ';
      end if;

      if (P_ID_SITUACION_EDUCATIVO IS NOT NULL AND P_ID_SITUACION_EDUCATIVO::text <> '') then
        l_query:=l_query||'and a.id_situacion_educativo in('||ENOC.FC_REEMPLAZAR_COMA_XDOBLE(P_ID_SITUACION_EDUCATIVO)||') ';
      end if;

      if (P_ID_TIPORELIGION IS NOT NULL AND P_ID_TIPORELIGION::text <> '') then
        l_query:=l_query||'and a.id_tiporeligion in('||P_ID_TIPORELIGION||') ';
      end if;

      if (P_ID_TIPOPAIS IS NOT NULL AND P_ID_TIPOPAIS::text <> '') then
        l_query:=l_query||'and a.ID_TIPOPAIS in('||P_ID_TIPOPAIS||') ';
      end if;

      if (P_ID_TIPODOCUMENTO IS NOT NULL AND P_ID_TIPODOCUMENTO::text <> '') then
        l_query:=l_query||'and a.ID_TIPODOCUMENTO in('||P_ID_TIPODOCUMENTO||') ';
      end if;

      if (P_ID_REGIMEN_PENSIONARIA IS NOT NULL AND P_ID_REGIMEN_PENSIONARIA::text <> '') then
        l_query:=l_query||'and a.ID_REGIMEN_PENSIONARIA in('||ENOC.FC_REEMPLAZAR_COMA_XDOBLE(P_ID_REGIMEN_PENSIONARIA)||') ';
      end if;

      if (P_ID_REGIMEN_PENSIONARIA IS NOT NULL AND P_ID_REGIMEN_PENSIONARIA::text <> '') then
        l_query:=l_query||'and a.ID_TIPO_CONTROL_PERSONAL in('||P_ID_TIPO_CONTROL_PERSONAL||') ';
      end if;

      if (P_ID_CONDICION_LABORAL IS NOT NULL AND P_ID_CONDICION_LABORAL::text <> '') then
        l_query:=l_query||'and a.ID_CONDICION_LABORAL in('||ENOC.FC_REEMPLAZAR_COMA_XDOBLE(P_ID_CONDICION_LABORAL)||') ';
      end if;

      if (P_ID_TIPO_CONTRATO IS NOT NULL AND P_ID_TIPO_CONTRATO::text <> '') then
        l_query:=l_query||'and a.ID_TIPO_CONTRATO in('||P_ID_TIPO_CONTRATO||') ';
      end if;

      if (P_ID_TIPO_TIEMPO_TRABAJO IS NOT NULL AND P_ID_TIPO_TIEMPO_TRABAJO::text <> '') then
        l_query:=l_query||'and a.ID_TIPO_TIEMPO_TRABAJO in('||P_ID_TIPO_TIEMPO_TRABAJO||') ';
      end if;

      if (P_ID_TIPO_JEFE IS NOT NULL AND P_ID_TIPO_JEFE::text <> '') then
        l_query:=l_query||'and b.ID_TIPO_JEFE in('||P_ID_TIPO_JEFE||') ';
      end if;

      if P_ID_PUESTO >0 then
        l_query:=l_query||'and b.ID_PUESTO ='||P_ID_PUESTO||' ';
      end if;

      case P_TIPO_REP
           WHEN 'CONHIJOS' THEN 
             l_query:=l_query||'and a.id_persona in(select id_persona from MOISES.VINCULO_FAMILIAR where ID_TIPO_VINCULO_FAMILIAR in(''05'',''06'') ) ';
          ELSE
            l_error:=0;
      end case;

      if P_RESTRINGIDO='S' then
            
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and sa.id_depto_padre in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||')';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and sa.id_area in('||P_ID_AREAS_USER||')';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and a.id_trabajador='||P_ID_USER::text||' ';
          end if;
      end if;

      if P_RESTRINGIDO='U' then
          l_query:=l_query||'and a.id_trabajador='||P_ID_USER::text||' ';
      end if;

      
      EXECUTE l_query USING l_FMR,l_FMR, l_id_anho,P_ID_ENTIDAD;
      --open cursor for select l_query as q from dual;
      OPEN CURSOR FOR
      SELECT 
      ID_TRABAJADOR,
      ID_PERSONA,
      APELLIDONOMBRE,
      NOMBRE,
      PATERNO,
      MATERNO,
      PUESTO,
      AREA,
      ID_DEPTO,
      CCOSTO,
      DEPTOPADRE,
      ESTADO_CIVIL,
      SITUACION_EDUCATIVO,
      TIPO_RELIGION,
      PAIS,
      SIGLAS,
      RIGEN_PENSIONARIA,
      SITUACION_TRABAJADOR,
      TIPO_CONTROL_PERSONAL,
      CONDICION_LABORAL,
      TIPO_CONTRATO,
      TIPO_TIEMPO_TRABAJO,
      TIPO_PAGO,
      FMR *100 as FMR,
      SUELDO,
      ID_PERFIL_PUESTO,
      ID_SEDEAREA,
      ID_DEPTO_PADRE,
      ID_SITUACION_TRABAJADOR,
      ID_TIPOESTADOCIVIL,
      ID_SITUACION_EDUCATIVO,
      ID_TIPORELIGION,
      ID_TIPOPAIS,
      ID_TIPODOCUMENTO,
      ID_REGIMEN_PENSIONARIA,
      ID_TIPO_CONTROL_PERSONAL,
      ID_CONDICION_LABORAL,
      ID_TIPO_CONTRATO,
      ID_TIPO_TIEMPO_TRABAJO,
      ID_REMUNERACION,
      ID_ESCALA_SALARIAL,
      PUNTMINIMO,
      PUNTMAXIMO,
      to_char(FECHA_INICIO,'DD/MM/YYYY') as FECHA_INICIO,
      to_char(FECHA_FIN_PREVISTA,'DD/MM/YYYY') as FECHA_FIN_PREVISTA,
      SUELDO_MIN,
      SUELDO_MAX,
      NOM_SEXO,
      CORREO,
      CORREO_INST,
      CELULAR,
      ID_TIPO_JEFE,
      TIPO_JEFE,
      to_char(FEC_NACIMIENTO,'DD/MM/YYYY') as FEC_NACIMIENTO,
      NUM_DOCUMENTO,
      L_FMR_ACT AS FMR_ACTUAL
      FROM ENOC.TT_REPORTE_GENERAL
      order by APELLIDONOMBRE;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_reporte_general ( P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, P_ID_DEPTO text, P_ID_AREA text, P_SEXO text, P_ID_SITUACION_TRABAJADOR text, P_ID_TIPOESTADOCIVIL text, P_ID_SITUACION_EDUCATIVO text, P_ID_TIPORELIGION text, P_ID_TIPOPAIS text, P_ID_TIPODOCUMENTO text, P_ID_REGIMEN_PENSIONARIA text, P_ID_TIPO_CONTROL_PERSONAL text, P_ID_CONDICION_LABORAL text, P_ID_TIPO_CONTRATO text, P_ID_TIPO_TIEMPO_TRABAJO text, P_ID_TIPO_JEFE text, P_ID_PUESTO bigint, P_TIPO_REP text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREAS_USER text, P_ID_USER bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
