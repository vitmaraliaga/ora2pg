-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_compensacion,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_compensacion_sp_registrar_cambio_sueldo ( P_ID_CAMBIOS bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONCEPTO_CAMBIO bigint, P_ID_TRABAJADOR bigint, P_FEC_DESDE timestamp(0), P_ID_ESCALA_SALARIAL bigint, P_INCR_SUELDO bigint, P_INCR_FMR bigint, P_SUELDO bigint, P_PJE_FMR bigint, P_COMENTARIO text, P_ID_USER bigint, D_ID_TRABAJADOR text, D_ID_ESCALA_SALARIAL text, D_INCR_SUELDO text, D_INCR_FMR text, D_SUELDO text, D_PJE_FMR text, P_ID_CAMBIO OUT bigint, P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_codigo varchar(20);
        l_id_cambios bigint;
        l_id_sede_area bigint;
        l_id_perfil_puesto bigint;
        l_id_condicion_laboral varchar(10);
        l_id_tipo_contrato  varchar(10);
        l_id_tipo_tiempo_trabajo bigint;
        l_id_estado_cambios varchar(5);
        l_sueldo decimal(10,2):=0;
        l_pje_fmr decimal(10,2):=0;
        l_proceso_fin varchar(1):='N';

        l_id bigint;

        a_trabajador TABLASTRING;
        a_escala_salarial TABLASTRING;
        a_inc_sueldo TABLASTRING;
        a_inc_fmr TABLASTRING;
        a_sueldo TABLASTRING;
        a_pje_fmr TABLASTRING;

BEGIN
      
        SELECT CODIGO INTO STRICT l_codigo FROM enoc.PLLA_CONCEPTO_CAMBIO WHERE ID_CONCEPTO_CAMBIO=P_ID_CONCEPTO_CAMBIO;

          
        IF l_codigo ='INCSI' THEN  
        
          select 
          id_sedearea,id_perfil_puesto, id_condicion_laboral,id_tipo_contrato,id_tipo_tiempo_trabajo 
          into STRICT 
          l_id_sede_area, l_id_perfil_puesto,l_id_condicion_laboral,l_id_tipo_contrato,l_id_tipo_tiempo_trabajo 
          from moises.trabajador 
          where id_trabajador=P_ID_TRABAJADOR;

          select sueldo, fmr into STRICT l_sueldo,l_pje_fmr  from ENOC.plla_remuneracion where id_trabajador=P_ID_TRABAJADOR and vigencia=1;
        END IF;


        if P_ID_CAMBIOS=0 then
        
          select coalesce(max(id_cambios),0) + 1 into STRICT l_id_cambios from PLLA_CAMBIOS;

          insert into enoc.PLLA_CAMBIOS(
              ID_CAMBIOS,
              ID_ENTIDAD,
              ID_DEPTO,
              ID_CONCEPTO_CAMBIO,
              ID_TRABAJADOR,
              FEC_DESDE,
              MOD_FMR_SUELDO,
              ID_ESCALA_SALARIAL,
              SUELDO,
              PJE_FMR,
              COMENTARIO,
              ACT_INS,
              PROCESO_FIN,
              APS,
              ID_ESTADO_CAMBIO,
              ID_USER_REG,
              FECHA_REG,
              ID_SEDEAREAA,
              ID_PERFIL_PUESTOA,
              ID_CONDICION_LABORALA,
              ID_TIPO_CONTRATOA,
              ID_TIPO_TIEMPO_TRABAJOA,
              SUELDOA,
              PJE_FMRA,
              INCR_SUELDO,
              INCR_FMR
            )values (
              l_id_cambios,
              P_ID_ENTIDAD,
              P_ID_DEPTO,
              P_ID_CONCEPTO_CAMBIO,
              P_ID_TRABAJADOR,
              P_FEC_DESDE,
              'S',
              case when P_ID_ESCALA_SALARIAL=0 then null else P_ID_ESCALA_SALARIAL end,
              P_SUELDO,
              P_PJE_FMR,
              P_COMENTARIO,
              'I',
              l_proceso_fin,
              '0',
              '01',
              P_ID_USER,
              clock_timestamp(),
              l_id_sede_area,
              l_id_perfil_puesto,
              l_id_condicion_laboral,
              l_id_tipo_contrato,
              l_id_tipo_tiempo_trabajo,
              l_sueldo,
              l_pje_fmr,
              P_INCR_SUELDO,
              P_INCR_FMR
            );
        else
          SELECT ID_ESTADO_CAMBIO INTO STRICT l_id_estado_cambios FROM enoc.PLLA_CAMBIOS WHERE ID_CAMBIOS = P_ID_CAMBIOS;
          if l_id_estado_cambios not in ('01','07') then
            l_error:=1;
            l_msgerror:='Si modifica s√≥lo con estado registrado';
--             goto salida_reg_cambio;
          end if;
          update enoc.PLLA_CAMBIOS set
              FEC_DESDE=P_FEC_DESDE,
              SUELDO=P_SUELDO,
              PJE_FMR=P_PJE_FMR,
              COMENTARIO=P_COMENTARIO,
              PROCESO_FIN=l_proceso_fin,
              ID_USER_MOD= P_ID_USER,
              FECHA_MOD=clock_timestamp(),
              ID_SEDEAREAA= l_id_sede_area,
              ID_PERFIL_PUESTOA=l_id_perfil_puesto,
              ID_CONDICION_LABORALA=l_id_condicion_laboral,
              ID_TIPO_CONTRATOA=l_id_tipo_contrato,
              ID_TIPO_TIEMPO_TRABAJOA=l_id_tipo_tiempo_trabajo,
              SUELDOA=l_sueldo,
              PJE_FMRA=l_pje_fmr,
              INCR_SUELDO=P_INCR_SUELDO,
              INCR_FMR=P_INCR_FMR
          where ID_CAMBIOS=P_ID_CAMBIOS;

          l_id_cambios:=P_ID_CAMBIOS;
        end if;

        IF l_codigo ='INCSG' THEN 
          select ENOC.FC_SPLIT(D_ID_TRABAJADOR,'|') into STRICT a_trabajador;
          select ENOC.FC_SPLIT(D_ID_ESCALA_SALARIAL,'|') into STRICT a_escala_salarial;
          select ENOC.FC_SPLIT(D_INCR_SUELDO,'|') into STRICT a_inc_sueldo;
          select ENOC.FC_SPLIT(D_INCR_FMR,'|') into STRICT a_inc_fmr;
          select ENOC.FC_SPLIT(D_SUELDO,'|') into STRICT a_sueldo;
          select ENOC.FC_SPLIT(D_PJE_FMR,'|') into STRICT a_pje_fmr;
          
          
         delete from ENOC.PLLA_CAMBIOS_DET where id_cambios= l_id_cambios;


          FOR i IN a_trabajador.FIRST .. a_trabajador.LAST
          LOOP
            
            
            select sueldo, fmr into STRICT l_sueldo,l_pje_fmr  from ENOC.plla_remuneracion where id_trabajador=(a_trabajador(i))::numeric  and vigencia=1;

            select coalesce(max(ID_CAMBIOS_DET),0)+1 into STRICT l_id from ENOC.PLLA_CAMBIOS_DET;

            insert into ENOC.PLLA_CAMBIOS_DET(
              ID_CAMBIOS_DET,
              ID_CAMBIOS,
              ID_TRABAJADOR,
              ID_ESCALA_SALARIAL,
              INCR_SUELDO,
              INCR_FMR,
              SUELDO,
              PJE_FMR,
              SUELDOA,
              PJE_FMRA,
              ID_USER_REG,
              FECHA_REG
            )values (
              l_id,
              l_id_cambios,
              (a_trabajador(i))::numeric ,
              (a_escala_salarial(i))::numeric ,
              (a_inc_sueldo(i))::numeric ,
              (a_inc_fmr(i))::numeric ,
              (a_sueldo(i))::numeric ,
              (a_pje_fmr(i))::numeric ,
              l_sueldo,
              l_pje_fmr,
              P_ID_USER,
              clock_timestamp()
            );

          END  LOOP;
       END IF;
           
--        <<salida_reg_cambio>>
        P_ID_CAMBIO:=l_id_cambios;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_compensacion_sp_registrar_cambio_sueldo ( P_ID_CAMBIOS bigint, P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONCEPTO_CAMBIO bigint, P_ID_TRABAJADOR bigint, P_FEC_DESDE timestamp(0), P_ID_ESCALA_SALARIAL bigint, P_INCR_SUELDO bigint, P_INCR_FMR bigint, P_SUELDO bigint, P_PJE_FMR bigint, P_COMENTARIO text, P_ID_USER bigint, D_ID_TRABAJADOR text, D_ID_ESCALA_SALARIAL text, D_INCR_SUELDO text, D_INCR_FMR text, D_SUELDO text, D_PJE_FMR text, P_ID_CAMBIO OUT bigint, P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
