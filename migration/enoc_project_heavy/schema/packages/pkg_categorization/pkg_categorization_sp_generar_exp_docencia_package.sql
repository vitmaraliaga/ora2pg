-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_categorization,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_categorization_sp_generar_exp_docencia (P_ID_PERSONA bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

 L_ID bigint:=0;
 l_error bigint:=0;
 l_msgerror varchar(200):='';

BEGIN

    select coalesce(max(Id_Experiencia),0) INTO STRICT  L_ID from moises.PERSONA_ACAD_EXP_DOCENCIA;

      INSERT INTO moises.PERSONA_ACAD_EXP_DOCENCIA(
        Id_Experiencia,
        id_persona,
        institucion,
        ciclo,
        fecha_inicio,
        fecha_fin,
        pregrado,
        maestria,
        doctorado,
        especialidad,
        estado,
        tipo,
        archivo,
        ID_SEMESTRE,
        ID_USUARIO_REG, 
	      FECHA_REGISTRO 
        )
        SELECT (row_number() OVER ( ORDER BY aca.id_semestre ASC )) + L_ID as Id_Experiencia ,
        ACCD.ID_PERSONA,
        'Universidad Peruana Unión' AS institucion,
        aca.semestre AS ciclo,
        Amd.Fecha_Inicio,
        Amd.Fecha_Fin,
        max(case when aca.id_tipo_contrato in (1,2,29,28,14,13,12,11,10,9) then 'S' else 'N' end) pregrado,
        max(case when aca.id_tipo_contrato in (4) then 'S' else 'N' end) maestria,
        max(case when aca.id_tipo_contrato in (5) then 'S' else 'N' end) doctorado,
        max(case when aca.id_tipo_contrato in (6) then 'S' else 'N' end) especialidad,
        '1' AS estado,
        null AS tipo,
        null AS archivo,
        aca.id_semestre,
        P_ID_USER,
        clock_timestamp()
        FROM DAVID.ACAD_CARGA_CURSO_DOCENTE ACCD INNER JOIN DAVID.VW_ACAD_CARGA_ACADEMICA ACA ON Aca.Id_Carga_Curso=Accd.Id_Carga_Curso AND ACA.ORIGEN='O'
        left join DAVID.Acad_Modulo_Detalle amd on Amd.Id_Modulo_Detalle=Accd.Id_Modulo_Detalle
        WHERE ACCD.ID_PERSONA=  P_ID_PERSONA
        and aca.id_tipo_contrato in (1,2,29,28,14,13,12,11,10,9,4,5,6)
        AND aca.id_semestre NOT IN (
          SELECT COALESCE(id_semestre,0) FROM  moises.PERSONA_ACAD_EXP_DOCENCIA
          WHERE ID_PERSONA=P_ID_PERSONA
        ) 
        group by ACCD.ID_PERSONA,'Universidad Peruana Unión',aca.semestre ,Amd.Fecha_Inicio,Amd.Fecha_Fin,aca.id_semestre
        order by ciclo desc;

    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_categorization_sp_generar_exp_docencia (P_ID_PERSONA bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
