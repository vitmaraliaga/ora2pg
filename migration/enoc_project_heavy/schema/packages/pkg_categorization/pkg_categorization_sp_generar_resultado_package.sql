-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_categorization,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_categorization_sp_generar_resultado (P_ID_CUESTIONARIO bigint,P_COD_TIPO_INT text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

 l_contar bigint:=0;
 l_error bigint:=0;
 l_msgerror varchar(200):='';
 l_id_docente bigint;
 l_id_categorizacion bigint;
 l_id_categoria_docente bigint;
 l_id_tipo_eval_instrumento bigint;
 l_tipo varchar(5);
 l_id_persona bigint;
 l_id_instrumento bigint;
 l_id_sala bigint;
 l_id_evaluador bigint;
 l_id_docente_evaluador bigint;

BEGIN

  SELECT ID_INSTRUMENTO,ID_SALA,ID_PERSONA,ID_EVALUADOR INTO STRICT l_id_instrumento,l_id_sala,l_id_persona,l_id_evaluador FROM LUCAS.INSTRUMENTO_CUESTIONARIO WHERE ID_CUESTIONARIO=P_ID_CUESTIONARIO;
  --calculo por persona
  LUCAS.pcd_calc_cuest_person_likert(
    l_id_instrumento,
    l_id_sala,
    l_id_persona
  );

   
  SELECT ID_CATEGORIZACION INTO STRICT l_id_categorizacion from enoc.cat_evaluador where id_evaluador=l_id_evaluador;

  SELECT ID_DOCENTE,ID_CATEGORIA_DOCENTE INTO STRICT l_id_docente,l_id_categoria_docente from enoc.cat_docente where ID_PERSONA=l_id_persona AND ID_CATEGORIZACION=l_id_categorizacion;

  SELECT count(1) into STRICT  l_contar FROM ENOC.CAT_DOCENTE_EVALUADOR A, ENOC.CAT_EVALUADOR_DET B, ENOC.CAT_TIPO_EVAL_INSTRUMENTO C
  WHERE A.ID_EVALUADOR_DET=B.ID_EVALUADOR_DET
  AND A.ID_TIPO_EVAL_INSTRUMENTO=C.ID_TIPO_EVAL_INSTRUMENTO
  AND B.ID_EVALUADOR=l_id_evaluador
  AND C.ID_SALA=l_id_sala
  AND A.ID_DOCENTE=l_id_docente
  and c.id_instrumento=l_id_instrumento;

  if l_contar = 0 or l_contar > 1  then
    l_error:=1;
    l_msgerror:='1-No procesa';
--     goto salida;
  end if;

  SELECT a.ID_TIPO_EVAL_INSTRUMENTO, a.ID_DOCENTE_EVALUADOR into STRICT l_id_tipo_eval_instrumento,l_id_docente_evaluador FROM ENOC.CAT_DOCENTE_EVALUADOR A, ENOC.CAT_EVALUADOR_DET B, ENOC.CAT_TIPO_EVAL_INSTRUMENTO C
  WHERE A.ID_EVALUADOR_DET=B.ID_EVALUADOR_DET
  AND A.ID_TIPO_EVAL_INSTRUMENTO=C.ID_TIPO_EVAL_INSTRUMENTO
  AND B.ID_EVALUADOR=l_id_evaluador
  AND C.ID_SALA=l_id_sala
  AND A.ID_DOCENTE=l_id_docente
  and c.id_instrumento=l_id_instrumento;

   
  update ENOC.CAT_DOCENTE_EVALUADOR set finalizado='S' where  ID_DOCENTE_EVALUADOR = l_id_docente_evaluador;

  select count(1) into STRICT  l_contar from enoc.vw_cat_item where id_item in (
    SELECT ID_ITEM from ENOC.CAT_ITEM_CATEGORIA where ID_CATEGORIZACION=l_id_categorizacion and ID_CATEGORIA_DOCENTE=l_id_categoria_docente and ID_TIPO_EVAL_INSTRUMENTO=l_id_tipo_eval_instrumento 
   LIMIT 1);

  if l_contar = 0 or l_contar > 1  then
    l_error:=1;
    l_msgerror:='2-No procesa';
--     goto salida;
  end if;


  select tipo into STRICT l_tipo  from enoc.vw_cat_item where id_item in (
    SELECT ID_ITEM from ENOC.CAT_ITEM_CATEGORIA where ID_CATEGORIZACION=l_id_categorizacion and ID_CATEGORIA_DOCENTE=l_id_categoria_docente and ID_TIPO_EVAL_INSTRUMENTO=l_id_tipo_eval_instrumento 
   LIMIT 1);
  if coalesce(l_tipo::text, '') = '' then
    l_error:=1;
    l_msgerror:='3-No procesa';
--     goto salida;
  end if;
  --
  CALL enoc.pkg_categorization_sp_procesar_item_encuesta(
      l_id_categorizacion,
      0,
      '',
      0,
      l_id_docente,
      0,
      l_tipo,
      'E',
      l_id_persona,
      l_error,
      l_msgerror
    );
--    <<salida>>
  P_ERROR:=l_error;
  P_MSGERROR:=l_msgerror;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_categorization_sp_generar_resultado (P_ID_CUESTIONARIO bigint,P_COD_TIPO_INT text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
