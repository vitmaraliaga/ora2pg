-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_planilla_proc,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_planilla_proc_sp_i_asig_familiar (P_ID_PLANILLA_TRAB text,P_ID_CONFIG_PLANILLA_CONCEPTO bigint, P_IMPORTE OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

  l_contar bigint;
  l_error bigint:=0;
  l_msgerror varchar(200):='';
  l_importe decimal(10,2):=0;
  l_id_trabajador bigint;
  l_id_anho bigint;
  l_id_mes bigint;
  l_num_dias bigint;
  l_id_condicion_laboral varchar(5);
  l_id_concepto_planilla bigint;
  l_id_persona bigint;
  l_fecha_mes_fin timestamp(0);
  l_fecha_mes_ini timestamp(0);
  l_id_entidad bigint;
  l_asig_fam decimal(10,2):=0;
  l_porc decimal(10,2):=0;

BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO STRICT
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;

    SELECT to_date('01/'||l_id_mes::text||'/'||l_id_anho::text,'DD/MM/YYYY'),
    ((date_trunc('month',(to_date('01/'||l_id_mes::text||'/'||l_id_anho::text,'DD/MM/YYYY'))::timestamp + interval '1 month'))::timestamp(0) - 1) 
    into STRICT l_fecha_mes_ini,l_fecha_mes_fin 
;

    select 
    id_condicion_laboral,
    id_persona
    into STRICT 
    l_id_condicion_laboral,
    l_id_persona
    from moises.trabajador where id_trabajador=l_id_trabajador;

    select id_concepto_planilla into STRICT l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;

    IF l_id_condicion_laboral NOT IN ('M') and l_num_dias>0 THEN
    
      select count(1) into STRICT l_contar from (
        SELECT A.id_registrado
        from moises.vinculo_familiar a, moises.persona_natural b
        where A.id_registrado=b.id_persona
        and a.id_persona=l_id_persona
        and a.ID_TIPO_VINCULO_FAMILIAR='05'
        and a.ID_TIPO_ESTADO_VINCULO='02' --aprobado
        and FLOOR(MONTHS_BETWEEN(l_fecha_mes_fin, b.fec_nacimiento ) / 12)<=18   --05	HIJO(A),06	HIJO MAYOR DE EDAD INCAPACITADO PERMANENTE
 
        
union

        SELECT A.id_registrado
        from moises.vinculo_familiar a, moises.persona_natural b
        where A.id_registrado=b.id_persona
        and a.id_persona=l_id_persona
        and a.ID_TIPO_ESTADO_VINCULO='02' --aprobado
        and a.ID_TIPO_VINCULO_FAMILIAR='06'
      ) alias4;

      if l_contar=0 then

        select count(1) into STRICT l_contar 
        from  "MOISES"."VINCULO_FAMILIAR_SUPERIOR" 
        where ID_TIPO_ESTADO_VINCULO='02' --aprobado
        and ((DESDE between l_fecha_mes_ini and l_fecha_mes_fin) or (HASTA between l_fecha_mes_ini and l_fecha_mes_fin))
        and id_VINCULO_FAMILIAR in (
          SELECT id_VINCULO_FAMILIAR
          from moises.vinculo_familiar a, moises.persona_natural b
          where A.id_registrado=b.id_persona
          and a.id_persona=l_id_persona
          and a.ID_TIPO_VINCULO_FAMILIAR='05'
          and a.ID_TIPO_ESTADO_VINCULO='02' --aprobado
          and FLOOR(MONTHS_BETWEEN(l_fecha_mes_fin, b.fec_nacimiento ) / 12)>18 
        );

      end if;

      if l_contar>0 then
         
         
         select count(*) into STRICT  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_PJEAF' and id_anho=l_id_anho;
         if l_contar=1 then
            select importe into STRICT l_porc from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_PJEAF' and id_anho=l_id_anho;
         end if;

         select count(*) into STRICT  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_AF' and id_anho=l_id_anho;
         if l_contar=0 then
            l_error:=1;
            l_msgerror:='Falta configurar parametro asig. familiar';
--             goto salida;
         end if;

         select importe into STRICT l_importe from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_AF' and id_anho=l_id_anho;

         CALL pkg_planilla_sp_insmod_planilla_trab_det(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            0,
            l_porc,
            0
        );

      end if;

    END IF;
--     <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_planilla_proc_sp_i_asig_familiar (P_ID_PLANILLA_TRAB text,P_ID_CONFIG_PLANILLA_CONCEPTO bigint, P_IMPORTE OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
