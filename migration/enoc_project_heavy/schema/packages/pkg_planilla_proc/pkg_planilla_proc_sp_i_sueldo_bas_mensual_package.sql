-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_planilla_proc,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_planilla_proc_sp_i_sueldo_bas_mensual (P_ID_PLANILLA_TRAB text,P_ID_CONFIG_PLANILLA_CONCEPTO bigint, P_IMPORTE OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

  l_contar bigint;
  l_error bigint:=0;
  l_msgerror varchar(200):='';
  l_importe decimal(10,2):=0;
  l_id_trabajador bigint;
  l_id_anho bigint;
  l_id_mes bigint;
  l_num_dias bigint;
  l_id_condicion_laboral varchar(5);
  l_tipo_pago varchar(5);
  l_sueldo decimal(10,2):=0;
  l_id_remuneracion bigint;
  l_id_concepto_planilla bigint;
  l_adicionales decimal(10,2);
  l_imp_pago decimal(10,2);

BEGIN
  
  select 
  id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0)
  INTO STRICT
  l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias
  FROM ENOC.VW_PLANILLA_TRAB
  WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;

  select 
  id_condicion_laboral  
  into STRICT 
  l_id_condicion_laboral 
  from moises.trabajador where id_trabajador=l_id_trabajador;

  select id_concepto_planilla into STRICT l_id_concepto_planilla 
  from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
  where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;

  if l_id_condicion_laboral in ('E','C') and l_num_dias>0 then
  
    select count(1) into STRICT l_contar
    from enoc.plla_remuneracion 
    where id_trabajador=l_id_trabajador
    and vigencia=1;

    if l_contar=0 then
      l_error:=1;
      l_msgerror:='No esta registrado sueldo';
--       goto salida;
    end if;
    if l_contar>1 then
      l_error:=1;
      l_msgerror:='Mas de una configuración de sueldo';
--       goto salida;
    end if;

    select id_remuneracion,tipo_pago,coalesce(sueldo,0)
    into STRICT
    l_id_remuneracion,l_tipo_pago,l_sueldo
    from enoc.plla_remuneracion 
    where id_trabajador=l_id_trabajador
    and vigencia=1;

    if l_tipo_pago='H' then
      select coalesce(sum(importe),0) into STRICT l_sueldo
      from ENOC.plla_remuneracion_det 
      where id_remuneracion=l_id_remuneracion 
      and id_anho=l_id_anho 
      and id_mes=l_id_mes;

      l_imp_pago:=l_sueldo;
    else
      l_imp_pago:=(l_sueldo*l_num_dias)/30;
    end if;


    --adicionales
     select coalesce(SUM(IMPORTE),0) into STRICT l_adicionales  
     from  ENOC.VW_ADICIONAL_PAGO
     where id_trabajador=l_id_trabajador
     and id_anho=l_id_anho 
     and id_mes=l_id_mes
     and id_concepto_planilla=l_id_concepto_planilla
     and id_estado_adicional in ('04','03')--03:Aprobación financiera, 04:Aprobación de GTH
     and coalesce(finalizado,0)=1
     and vigencia=1;

     l_importe:= l_imp_pago + l_adicionales;

     if l_importe>0 then
    
        CALL pkg_planilla_sp_insmod_planilla_trab_det(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            0,
            0,
            l_sueldo
        );

      end if;

  end if;


--   <<salida>>
  P_IMPORTE:=l_importe;
  P_ERROR:=l_error;
  P_MSGERROR:=l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_planilla_proc_sp_i_sueldo_bas_mensual (P_ID_PLANILLA_TRAB text,P_ID_CONFIG_PLANILLA_CONCEPTO bigint, P_IMPORTE OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
