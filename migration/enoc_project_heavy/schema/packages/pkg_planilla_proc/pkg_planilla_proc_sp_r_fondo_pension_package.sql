-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_planilla_proc,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_planilla_proc_sp_r_fondo_pension (P_ID_PLANILLA_TRAB text,P_ID_CONFIG_PLANILLA_CONCEPTO bigint, P_IMPORTE OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

  l_contar bigint;
  l_error bigint:=0;
  l_msgerror varchar(200):='';
  l_importe decimal(10,2):=0;
  l_id_trabajador bigint;
  l_id_anho bigint;
  l_id_mes bigint;
  l_num_dias bigint;

  l_id_concepto_planilla bigint;
  l_id_persona bigint;
  l_id_entidad bigint;
  l_regimen_pensionaria varchar(5);
  l_tipo varchar(5);
  l_id_tipo_comision_pens bigint;
  l_porc decimal(10,3):=0;
  l_importe_cal decimal(10,2):=0;


BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO STRICT
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;

    select 
    b.id_persona,
    a.id_regimen_pensionaria,
    a.ID_TIPO_COMISION_PENS
    into STRICT 
    l_id_persona,
    l_regimen_pensionaria,
    l_id_tipo_comision_pens
    from moises.PERSONA_NATURAL_TRABAJADOR a,
    moises.trabajador b 
    where a.id_persona=b.id_persona
    and b.id_trabajador=l_id_trabajador;

    select id_concepto_planilla into STRICT l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;

    select  count(*) into STRICT  l_contar from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in ('PU','PR');
    if l_contar=0 then
        l_error:=1;
        l_msgerror:='No tiene asignado régimen pensionaria';
--         goto salida;
    end if;

    select  tipo into STRICT  l_tipo from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in ('PU','PR');

    if l_tipo='PR' then
      select count(*) into STRICT  l_contar from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;

      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Falta configurar régimen pensionaria para el periodo a procesar';
--           goto salida;
      end if;

      select round((fondo/100.000)::numeric,3) into STRICT  l_porc from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;

       if l_porc<=0 then
          l_error:=1;
          l_msgerror:='Fondo de régimen pensionaria es cero';
--           goto salida;
      end if;

     
      select coalesce(sum(importe),0) into STRICT l_importe_cal from VW_PLLA_PLANILLA_TRAB_DET 
      where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB
      and id_tipo_concepto='I'
      and coalesce(TRA_SPP,'0')='1';

      l_importe:= round((l_importe_cal*l_porc)::numeric,2);

      CALL pkg_planilla_sp_insmod_planilla_trab_det(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            l_importe_cal,
            l_porc,
            0
        );
     end if;
--     <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_planilla_proc_sp_r_fondo_pension (P_ID_PLANILLA_TRAB text,P_ID_CONFIG_PLANILLA_CONCEPTO bigint, P_IMPORTE OUT bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
