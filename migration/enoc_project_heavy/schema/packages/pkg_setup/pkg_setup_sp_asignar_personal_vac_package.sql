-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_setup,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_setup_sp_asignar_personal_vac (P_COD_CUESTIONARIO text,P_ID_ENTIDAD bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      l_contar bigint;
      l_error bigint:=0;
      l_msgerror varchar(200):='';
      l_id_cuestionario bigint;
      l_num bigint:=0;

    
BEGIN
      SELECT COUNT(1) INTO STRICT l_contar FROM ENOC.QUIZ_CUESTIONARIO WHERE CODIGO=P_COD_CUESTIONARIO;
      IF l_contar=0 THEN
        l_error:=1;
        l_msgerror:='No hay cuestionario para asignar';
--         goto salida;
      END IF;
      SELECT id_cuestionario INTO STRICT l_id_cuestionario FROM ENOC.QUIZ_CUESTIONARIO WHERE CODIGO=P_COD_CUESTIONARIO;

      select coalesce(max(id_cuestionario_asig),0) into STRICT  l_num from ENOC.QUIZ_CUESTIONARIO_ASIG;

      
      insert into ENOC.QUIZ_CUESTIONARIO_ASIG(
      id_cuestionario_asig,
      id_cuestionario,
      id_entidad,
      id_depto,
      id_area,
      id_persona,
      desde,
      hasta,
      id_trabajador,
      respuesta,
      total_respuestas,
      ID_ROL_VACACION,
      id_anho_asig,
      id_mes_asig,
      fecha_asig,
      vigencia,
      id_user_reg,
      fecha_reg
      )
      SELECT (row_number() OVER ( ORDER BY t.id_trabajador ASC )) + l_num as id_cuestionario_asig,
      l_id_cuestionario,
      t.id_entidad,
      ar.ID_DEPTO_PADRE as id_depto,
      ar.id_area,
      t.id_persona,
      a.fecha_fin +1 as desde,
      null as hasta,
      t.id_trabajador,
      0 as respuesta,
      0 as total_respuestas,
      a.ID_ROL_VACACION,
      (to_char(clock_timestamp() + interval '1 days','YYYY'))::numeric  as id_anho_asig,
      (to_char(clock_timestamp() + interval '1 days','MM'))::numeric  as id_mes_asig,
      clock_timestamp() as fecha_asig,
      1 as vigencia,
      4 as id_user_reg,
      clock_timestamp() as fecha_reg
      from enoc.vw_aviso_vacacion a,PLLA_PERIODO_VAC_TRAB b, moises.trabajador t, VW_ENT_DEP_AREA_CCOSTO ar
      where a.ID_PERIODO_VAC_TRAB=b.ID_PERIODO_VAC_TRAB
      and b.ID_TRABAJADOR=t.ID_TRABAJADOR
      and t.ID_SEDEAREA=ar.ID_SEDEAREA
      and t.id_entidad=P_ID_ENTIDAD
      and a.ndias=7
      and a.ID_ROL_VACACION not in (
        SELECT x.ID_ROL_VACACION from ENOC.QUIZ_CUESTIONARIO_ASIG x
        where x.id_trabajador=t.id_trabajador
      ) 
      order by t.id_trabajador;

--       <<salida>>
      P_ERROR:=l_error;
      P_MSGERROR:=l_msgerror;
    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_setup_sp_asignar_personal_vac (P_COD_CUESTIONARIO text,P_ID_ENTIDAD bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
