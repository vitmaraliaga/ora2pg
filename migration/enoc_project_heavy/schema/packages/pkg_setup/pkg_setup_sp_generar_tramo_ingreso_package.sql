-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_setup,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_setup_sp_generar_tramo_ingreso (P_ID_ANHO bigint,P_ID_USER bigint) AS $body$
DECLARE


     l_anho_ant bigint;
     l_fec_ant timestamp(0);
     l_id bigint;
     l_contar bigint;
     l_fondo decimal(10,4):=0;
     l_seguro decimal(10,4):=0;
     l_rem_max_ase decimal(10,2):=0;
     l_id_comision_pensionaria_ant bigint:=0;
     l_id_c bigint;

BEGIN
    select  to_date(P_ID_ANHO::text||'-01-01','YYYY-MM-DD') + -12*'1 month'::interval into STRICT l_fec_ant;

    select (to_char(l_fec_ant,'YYYY'))::numeric  into STRICT l_anho_ant;


    
    select coalesce(max(ID_TRAMO_INGRESO),0)   into STRICT l_id from enoc.PLLA_TRAMO_INGRESO;

    insert into enoc.PLLA_TRAMO_INGRESO(
      ID_TRAMO_INGRESO,
      ID_TIPO_TRAMO,
      ID_ANHO,
      DESDE,
      HASTA,
      PORCENTAJE,
      ID_USER_REG,
      FECHA_REG
    )
    SELECT (row_number() OVER ( ORDER BY a.ID_TIPO_TRAMO ASC )) + l_id, 
     a.ID_TIPO_TRAMO,
     P_ID_ANHO,
     b.DESDE,
     b.HASTA,
     b.PORCENTAJE,
     P_ID_USER,
     clock_timestamp()
     from ENOC.PLLA_TIPO_TRAMO a left join enoc.PLLA_TRAMO_INGRESO b
     on a.ID_TIPO_TRAMO=b.ID_TIPO_TRAMO
     and b.ID_ANHO=l_anho_ant
     where a.vigencia=1
     and a.ID_TIPO_TRAMO not in (
      SELECT x.ID_TIPO_TRAMO from enoc.PLLA_TRAMO_INGRESO x
      where x.id_anho=P_ID_ANHO
     ) 
     order by a.orden;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_setup_sp_generar_tramo_ingreso (P_ID_ANHO bigint,P_ID_USER bigint) FROM PUBLIC;
