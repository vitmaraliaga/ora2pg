-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_setup,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_setup_sp_generar_parametros (P_ID_ENTIDAD bigint, P_ID_ANHO bigint) AS $body$
DECLARE


        cur CURSOR FOR SELECT  ID_PARAMETRO,   FORMULA from plla_parametros ORDER BY orden;
        l_id_parametro bigint;
        l_codigo varchar(25);
        l_formula varchar(200);
        l_importe decimal(20,14);
        l_contar bigint;
        l_id_anho bigint;

        cur1 CURSOR FOR SELECT  ID_PARAMETRO,   EJE_FORMULA from plla_parametros_valor where ID_ANHO=P_ID_ANHO AND ID_ENTIDAD=P_ID_ENTIDAD AND (EJE_FORMULA IS NOT NULL AND EJE_FORMULA::text <> '')  ORDER BY ID_PARAMETRO;

BEGIN
            
            select coalesce( max(id_anho), 0) into STRICT l_id_anho from plla_parametros_valor where ID_ANHO<P_ID_ANHO AND ID_ENTIDAD=P_ID_ENTIDAD;
            
             INSERT INTO plla_parametros_valor(ID_PARAMETRO_VALOR, ID_PARAMETRO,ID_ENTIDAD,ID_ANHO,EJE_FORMULA,IMPORTE)
              SELECT 
              TO_CHAR(clock_timestamp(), 'YYYYMMDDHH24MISS')||p.ID_PARAMETRO::text,  
              p.ID_PARAMETRO,
              P_ID_ENTIDAD, 
              P_ID_ANHO,  
              p.FORMULA,  
              coalesce((
                SELECT x.importe from plla_parametros_valor x 
                where x.ID_ENTIDAD=P_ID_ENTIDAD 
                and x.ID_ANHO=P_ID_ANHO 
                and x.ID_PARAMETRO=p.ID_PARAMETRO
                ) ,p.IMPORTE) as importe
              from plla_parametros p
              WHERE p.ID_PARAMETRO NOT IN (
                SELECT ID_PARAMETRO FROM plla_parametros_valor
                WHERE ID_ANHO=P_ID_ANHO
                AND ID_ENTIDAD=P_ID_ENTIDAD
              )  ORDER BY p.orden;


              MERGE INTO plla_parametros_valor C
              USING(
                SELECT 
                A.ID_PARAMETRO,
                B.FORMULA,
                A.ID_ANHO,
                B.IMPORTE,
                a.importe as importe_val
                FROM plla_parametros_valor A,plla_parametros B
                WHERE A.ID_PARAMETRO=B.ID_PARAMETRO
                AND A.ID_ANHO=P_ID_ANHO
                AND A.ID_ENTIDAD=P_ID_ENTIDAD
              )t ON (C.ID_PARAMETRO=t.ID_PARAMETRO AND C.ID_ANHO=t.ID_ANHO and C.ID_ANHO=P_ID_ANHO AND C.ID_ENTIDAD=P_ID_ENTIDAD)
              WHEN  MATCHED THEN UPDATE SET  C.EJE_FORMULA=t.FORMULA,C.IMPORTE=case when coalesce(t.importe_val,0)<>0 then t.importe_val  else t.IMPORTE end;



              OPEN cur;
                FETCH cur INTO l_id_parametro,l_formula;

                WHILE cur%FOUND LOOP

                    select  CODIGO into STRICT l_codigo from plla_parametros where id_parametro = l_id_parametro;

                  select IMPORTE into STRICT l_importe from plla_parametros_valor
                  where ID_PARAMETRO=l_id_parametro
                  and ID_ANHO=P_ID_ANHO
                  AND ID_ENTIDAD=P_ID_ENTIDAD;


                  select count(*) into STRICT l_contar from plla_parametros_valor
                  where EJE_FORMULA LIKE '%'||l_codigo||'%'
                  and ID_ANHO=P_ID_ANHO
                  AND ID_ENTIDAD=P_ID_ENTIDAD
                  AND (EJE_FORMULA IS NOT NULL AND EJE_FORMULA::text <> '');


                  IF l_contar>0 THEN

                    UPDATE plla_parametros_valor
                    SET EJE_FORMULA=REPLACE(EJE_FORMULA,l_codigo,REPLACE(l_importe::text,',','.'))
                    WHERE EJE_FORMULA LIKE '%'||l_codigo||'%'
                    AND ID_ANHO=P_ID_ANHO
                    AND ID_ENTIDAD=P_ID_ENTIDAD
                    AND (EJE_FORMULA IS NOT NULL AND EJE_FORMULA::text <> '');


                  END IF;

                  FETCH cur INTO l_id_parametro,l_formula;

                 END LOOP;
                CLOSE cur;


                --ejecutar
                OPEN cur1;
                FETCH cur1 INTO l_id_parametro,l_formula;

                WHILE cur1%FOUND LOOP

                    EXECUTE 'UPDATE plla_parametros_valor SET IMPORTE='||l_formula||' WHERE ID_PARAMETRO=:PARAMETRO AND ID_ANHO=:ANHO AND ID_ENTIDAD=:ID_ENTIDAD'
                    USING l_id_parametro,P_ID_ANHO,P_ID_ENTIDAD;

                FETCH cur1 INTO l_id_parametro,l_formula;

                END LOOP;
                CLOSE cur1;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_setup_sp_generar_parametros (P_ID_ENTIDAD bigint, P_ID_ANHO bigint) FROM PUBLIC;
