-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_finalizar_renocion (P_ID_CONTRATO bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_persona bigint;
        l_id_entidad bigint;
        l_id_trabajador bigint;
        l_id bigint;
        l_id_perfil_puesto bigint:=0;
        l_id_perfil_puesto_c bigint;
        l_id_max bigint;
        l_fecha_ini timestamp(0);
        l_cambio_sueldo varchar(2);
        l_id_remuneracion bigint;
        l_sueldo decimal(10,2);
        l_pje_frm decimal(10,2);
        l_id_escala_salarial bigint;

BEGIN
      
       select id_persona,id_entidad,id_perfil_puesto,fecha_ini,CAMBIO_SUELDO ,SUELDO,PJE_FMR,id_escala_salarial
       into STRICT l_id_persona, l_id_entidad, l_id_perfil_puesto_c,l_fecha_ini,l_cambio_sueldo,l_sueldo, l_pje_frm,l_id_escala_salarial
       from plla_contrato where id_contrato=P_ID_CONTRATO;

       SELECT ID_TRABAJADOR INTO STRICT l_id_trabajador FROM MOISES.TRABAJADOR WHERE ID_PERSONA=l_id_persona AND ID_ENTIDAD=l_id_entidad;

      MERGE INTO MOISES.TRABAJADOR S 
       USING(
         SELECT
            A.ID_CONTRATO,
            A.ID_ENTIDAD,
            A.ID_DEPTO,
            A.ID_PERSONA,
            A.ID_SEDEAREA,
            A.ID_PERFIL_PUESTO,
            A.ID_TIPO_TIEMPO_TRABAJO,
            A.ID_CONDICION_LABORAL,
            A.FECHA_INI,
            A.FECHA_FIN,
            A.MENOREDAD,
            A.MENOREDAD_URL,
            A.ID_TIPO_OCUPACION,
            A.ID_SITUACION_TRABAJADOR,
            B.ID_PUESTO,
            B.ID_TIPO_CONTROL_PERSONAL,
            B.ID_TIPO_HORARIO,
            A.FECHA_INICIO_MISIONERO,
            A.MISIONERO_URL,
            A.ID_TIPO_STATUS,
            A.ID_PERIODO_REMU,
            A.ID_TIPO_CONTRATO,
            A.ID_GRUPO_PLANILLA,
            A.ID_TIPO_TIEMPO_REGIMEN
          FROM PLLA_CONTRATO A , PLLA_PERFIL_PUESTO B
          WHERE A.ID_PERFIL_PUESTO=B.ID_PERFIL_PUESTO
          AND A.ID_CONTRATO=P_ID_CONTRATO
        )T ON (T.ID_PERSONA=S.ID_PERSONA AND T.ID_ENTIDAD=S.ID_ENTIDAD)
        WHEN  MATCHED THEN UPDATE SET  
        S.ID_TIPO_CONTROL_PERSONAL=T.ID_TIPO_CONTROL_PERSONAL,
        S.FECHA_FIN_PREVISTO=T.FECHA_FIN,
        S.FECHA_FIN_EFECTIVO = NULL,
        S.ID_PUESTO=T.ID_PUESTO,
        S.ID_PERFIL_PUESTO=T.ID_PERFIL_PUESTO,
        S.ID_CONTRATO=T.ID_CONTRATO;

      
       SELECT coalesce(MAX(ID_TRABAJADOR_PUESTO),0) INTO STRICT l_id_max FROM MOISES.TRABAJADOR_PUESTO WHERE ID_TRABAJADOR=l_id_trabajador;

       if l_id_max>0 then
        SELECT ID_PERFIL_PUESTO INTO STRICT l_id_perfil_puesto FROM MOISES.TRABAJADOR_PUESTO WHERE ID_TRABAJADOR_PUESTO=l_id_max;
       end if;
        if  l_id_perfil_puesto <> l_id_perfil_puesto_c then    
            
            --puesto trabajador
            select coalesce(max(ID_TRABAJADOR_PUESTO),0) + 1 into STRICT l_id  from MOISES.TRABAJADOR_PUESTO;
            insert into MOISES.TRABAJADOR_PUESTO(
              ID_TRABAJADOR_PUESTO,
              ID_TRABAJADOR,
              ID_PERFIL_PUESTO,
              ID_PUESTO,
              DESDE,
              HASTA,
              ID_USER_REG,
              FECHA_REG,
              ID_USER_MOD,
              FECHA_MOD
              )
              SELECT
              l_id,
              id_trabajador,
              ID_PERFIL_PUESTO,
              id_puesto,
              l_fecha_ini,
              null,
              P_ID_USER,
              clock_timestamp(),
              null,
              null
              from MOISES.TRABAJADOR
              where id_trabajador=l_id_trabajador;

              
              update MOISES.TRABAJADOR_PUESTO set
              HASTA=l_fecha_ini-1,
              ID_USER_MOD=P_ID_USER
              where ID_TRABAJADOR_PUESTO=l_id_max;

  
        end if;

        if l_cambio_sueldo = '1' then
        
          UPDATE PLLA_REMUNERACION SET VIGENCIA=0 WHERE id_trabajador = l_id_trabajador AND VIGENCIA=1;

          select coalesce(max(ID_REMUNERACION),0) + 1  into STRICT l_id_remuneracion  from  PLLA_REMUNERACION;

          INSERT INTO PLLA_REMUNERACION(
            ID_REMUNERACION,
            ID_TRABAJADOR,
            ID_CONTRATO,
            REFERENCIA,
            REFERENCIA_URL,
            FEC_EFECTIVO,
            TIPO_PAGO,
            FMR,
            SUELDO,
            BONIFICACION,
            OBSERVACION,
            ID_ESTADO_REMUNE,
            VIGENCIA,
            ID_USER_REG,
            FECHA_REG,
            ID_ESCALA_SALARIAL
          )values (
            l_id_remuneracion,
            l_id_trabajador,
            P_ID_CONTRATO,
            'Renovación',
            NULL,
            l_fecha_ini,
            'F',
            l_pje_frm,
            l_sueldo,
            0,
            'Renovación',
            '04',
            1,
            P_ID_USER,
            clock_timestamp(),
            l_id_escala_salarial
          );

        end if;

--         <<salida_fin_renovacion>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_finalizar_renocion (P_ID_CONTRATO bigint,P_ID_USER bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
