-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_datos_docente ( P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE

        l_contar bigint;
        l_id_situacion_trabajador varchar(5):='0';
        l_id_tipo_control_personal bigint;
        l_id_condicion_laboral varchar(5);
        l_id_sede bigint;
        l_id_situacion_educativo  varchar(5);
        l_id_tiporeligion bigint;
        l_feligresia varchar(5);
        l_id_categoria_docente bigint;
        l_id_solic_req_candidato bigint;
        l_id_tipo_tiempo_trabajo bigint;
        l_error bigint:=0;
        l_msgerror varchar(3000):='OK';
        l_msg varchar(3000):='-';
        l_cod_academico varchar(10);
        l_nom_grado varchar(200);

    
BEGIN
      SELECT COUNT(*) INTO STRICT l_contar FROM MOISES.TRABAJADOR WHERE ID_PERSONA=P_ID_PERSONA AND  ID_ENTIDAD=P_ID_ENTIDAD;

    if l_contar>0 then
      SELECT coalesce(id_situacion_trabajador,'0') INTO STRICT l_id_situacion_trabajador FROM MOISES.TRABAJADOR WHERE ID_PERSONA=P_ID_PERSONA AND  ID_ENTIDAD=P_ID_ENTIDAD;
    end if;

    if l_id_situacion_trabajador not in ('1','3') then
    
      select coalesce(max(id_solic_req_candidato),0) into STRICT l_id_solic_req_candidato from enoc.plla_solic_req_candidato where id_persona=P_ID_PERSONA and ID_ESTADO_REQ_CAND='06';
    
      if l_id_solic_req_candidato>0 then
    
        select 
        a.id_condicion_laboral,
        a.id_tipo_tiempo_trabajo,
        sa.id_sede,
        a.ID_TIPO_TIEMPO_TRABAJO
        into STRICT
        l_id_condicion_laboral,
        l_id_tipo_control_personal,
        l_id_sede,
        l_id_tipo_tiempo_trabajo
        from enoc.plla_solic_reque a, enoc.plla_solic_req_candidato b, eliseo.vw_sede_area sa
        where a.id_solic_reque=  b.id_solic_reque
        and a.id_sedearea=sa.id_sedearea
        and b.id_persona=P_ID_PERSONA
        and b.id_solic_req_candidato=l_id_solic_req_candidato;


      end if;
    else
          select
          a.ID_CONDICION_LABORAL,
          a.ID_TIPO_CONTROL_PERSONAL,
          sa.id_sede,
          a.ID_TIPO_TIEMPO_TRABAJO
          into STRICT
          l_id_condicion_laboral,
          l_id_tipo_control_personal,
          l_id_sede,
          l_id_tipo_tiempo_trabajo
          from moises.trabajador a, eliseo.vw_sede_area sa
          where a.id_sedearea=sa.id_sedearea
          and a.id_entidad=P_ID_ENTIDAD
          and a.id_persona=P_ID_PERSONA;
    end if;

    select
    a.ID_SITUACION_EDUCATIVO,
    a.ID_TIPORELIGION,
    case when a.id_tiporeligion=1 then 'S' else 'N' end as feligresia,
    coalesce((select x.id_categoria_docente from moises.persona_acad_categoria x
      where x.id_categoria in (
        select max(z.id_categoria) from moises.persona_acad_categoria z
        where z.id_persona=a.id_persona
        and z.ESTADO='1'
      ) and x.ESTADO='1' 
    ),11) as id_categoria_docente
    into STRICT
    l_id_situacion_educativo,
    l_id_tiporeligion,
    l_feligresia,
    l_id_categoria_docente
    from moises.persona_natural a
    where a.id_persona=P_ID_PERSONA;

    if coalesce(l_id_condicion_laboral::text, '') = '' then
        l_error:=1;
        l_msgerror:='Falta registrar condición laboral. ';
    end if;

    if coalesce(l_id_situacion_educativo::text, '') = '' then
        l_error:=1;
        l_msgerror:=l_msg||'Falta registrar grado académico. ';
    else
       select cod_academico, nombre into STRICT l_cod_academico,l_nom_grado from MOISES.SITUACION_EDUCATIVA where id_situacion_educativo = l_id_situacion_educativo;-- and  tipo=2;
       if coalesce(l_cod_academico::text, '') = '' then
        l_msg:=l_msg||'No tiene grado. Situación educativo actual: '||l_nom_grado||'. ';
        l_error:=1;
       end if;
    end if;

    if coalesce(l_id_categoria_docente::text, '') = '' then
        l_error:=1;
        l_msgerror:=l_msg||'Falta registrar categoría docente. ';
    end if;

    if coalesce(l_id_tipo_tiempo_trabajo::text, '') = '' then
        l_error:=1;
        l_msgerror:=l_msg||'Falta registrar jornada laboral. ';
    end if;

    if l_error=1 then
          l_msgerror:='MENSAJE5: '||l_msg;
    end if;

    OPEN CURSOR FOR
    SELECT 
    P_ID_PERSONA as id_persona,
    l_id_condicion_laboral as id_condicion_laboral,
    l_id_tipo_control_personal as id_tipo_control_personal,
    l_id_sede as id_sede,
    l_cod_academico as id_situacion_educativo,
    l_id_tiporeligion as id_tiporeligion,
    l_feligresia as feligresia,
    l_id_categoria_docente as id_categoria_docente,
    l_id_tipo_tiempo_trabajo as id_tipo_tiempo_trabajo,
    l_error as nerror,
    l_msgerror as mensaje
;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_datos_docente ( P_ID_ENTIDAD bigint, P_ID_PERSONA bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
