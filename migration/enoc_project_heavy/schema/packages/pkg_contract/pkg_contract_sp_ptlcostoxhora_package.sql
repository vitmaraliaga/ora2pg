-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_ptlcostoxhora (P_ID_CONTRATO bigint, P_PARAMETRO text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_parametro text:='';
        l_id_persona bigint;
        l_id_docente_costoxhora bigint;

        curCab CURSOR FOR
        SELECT 
        a.id_anho,
        a.id_mes, 
        a.costohora,
        a.horas,
        a.importe,
        b.nombre as programa,
        c.nombre as tipo_pago,
        d.nombre as mes
        from enoc.plla_contrato_det a, david.acad_programa_estudio b, enoc.plla_tipo_hora_pago c, eliseo.conta_mes d
        where a.id_programa_estudio=b.id_programa_estudio
        and a.id_tipo_hora_pago=c.id_tipo_hora_pago
        and a.id_mes=d.id_mes
        and a.id_contrato=P_ID_CONTRATO
        order by a.id_anho,
        a.id_mes,a.id_tipo_hora_pago;

        
        curMan CURSOR FOR
        SELECT 
        a.id_anho,
        a.id_mes, 
        a.costohora,
        a.horas,
        a.importe,
        b.id_depto||' - '||b.ccosto as programa,
        c.nombre as tipo_pago,
        d.nombre as mes
        from enoc.plla_contrato_det a, eliseo.vw_sede_area b, enoc.plla_tipo_cantidad c, eliseo.conta_mes d
        where a.id_sedearea=b.id_sedearea
        and a.id_tipo_cantidad=c.id_tipo_cantidad
        and a.id_mes=d.id_mes
        and a.id_contrato=P_ID_CONTRATO
        order by a.id_anho,
        a.id_mes;

        l_id_mes bigint:=0;
        l_j bigint:=0;
        l_total decimal(10,2):=0;
        l_totalacu decimal(10,2):=0;
        l_i bigint:=0;
        l_modo_pago varchar(2);
        l_contrato_mensual bigint:=0;


BEGIN
         
        SELECT id_persona, coalesce(modo_pago,'N'),coalesce(contrato_mensual,0) into STRICT l_id_persona,l_modo_pago,l_contrato_mensual from plla_contrato where id_contrato=P_ID_CONTRATO;

        if l_modo_pago='M' then
          l_parametro:='<table class="table table-sm">
            <tr>
              <th>Año</th>
              <th>Mes</th>
              <th>C.Costo</th>
              <th>Cantidad</th>
              <th>Tipo</th>
              <th>Costo</th>
              <th>RB por Mes</th>
            </tr>';
           
          FOR cur in curMan LOOP
          BEGIN
              if l_id_mes<>cur.id_mes then
                  if l_j>0 then
                  
                    l_parametro:=l_parametro||'</tr>';

                    if l_i>1 then
                      l_parametro:=l_parametro||'<tr>';
                      l_parametro:=l_parametro||'<td colspan="6" style="text-align: right;font-weight: bold;">Total Mes:</td>
                      <td style="text-align: right;font-weight: bold;">'||to_char(l_total,'99999.99')||'</td>';
                      l_parametro:=l_parametro||'</tr>';
                    end if;
                    l_total:=0;
                    l_i:=0;
                  end if;
                  l_parametro:=l_parametro||'<tr>';
              else
                l_parametro:=l_parametro||'</tr>';
                l_parametro:=l_parametro||'<tr>';
              end if;

              l_parametro:=l_parametro||'<td>'||cur.id_anho::text||'</td>
              <td>'||cur.mes||'</td>
              <td>'||cur.programa||'</td>
              <td style="text-align: right;">'||to_char(cur.horas,'99999.99')||'</td>
              <td>'||cur.tipo_pago||'</td>
              <td style="text-align: right;">'||to_char(cur.costohora,'99999.99')||'</td>
              <td style="text-align: right;">'||to_char(cur.importe,'99999.99')||'</td>';
              l_total:=l_total+cur.importe;
              l_id_mes:=cur.id_mes;
              l_totalacu:=l_totalacu+cur.importe;
              l_j:=l_j +1;
              l_i:=l_i +1;

              
          END;
          END LOOP;

          if l_j=0 then
            l_parametro:='';
          else
            l_parametro:=l_parametro||'</tr>';
            if l_i>1 then
              l_parametro:=l_parametro||'<tr>';
              l_parametro:=l_parametro||'<td colspan="6" style="text-align: right;font-weight: bold;">Total Mes:</td>
              <td style="text-align: right;font-weight: bold;">'||to_char(l_total,'99999.99')||'</td>';
              l_parametro:=l_parametro||'</tr>';
            end if;
            l_parametro:=l_parametro||'<tr>';
            l_parametro:=l_parametro||'<td colspan="6" style="text-align: right;font-weight: bold;">Total:</td>
            <td style="text-align: right;font-weight: bold;">'||to_char(l_totalacu,'99999.99')||'</td>';
            l_parametro:=l_parametro||'</tr>';
            l_parametro:=l_parametro||'</table>';
          end if;
        else
          l_parametro:='<table  class="table table-sm">
            <tr>
              <th>Año</th>
              <th>Mes</th>
              <th>Programa</th>
              <th>Tipo de Hora</th>
              <th>Conto x Hora</th>
              <th>Horas al Mes</th>
              <th>RB por Mes</th>
            </tr>';
           
          FOR cur in curCab LOOP
          BEGIN
              if l_id_mes<>cur.id_mes then
                  if l_j>0 then
                  
                    l_parametro:=l_parametro||'</tr>';

                    if l_i>1 then
                      l_parametro:=l_parametro||'<tr>';
                      l_parametro:=l_parametro||'<td colspan="6" style="text-align: right;font-weight: bold;">Total Mes:</td>
                      <td style="text-align: right;font-weight: bold;">'||to_char(l_total,'99999.99')||'</td>';
                      l_parametro:=l_parametro||'</tr>';
                    end if;
                    l_total:=0;
                    l_i:=0;
                  end if;
                  l_parametro:=l_parametro||'<tr>';
              else
                l_parametro:=l_parametro||'</tr>';
                l_parametro:=l_parametro||'<tr>';
              end if;

              l_parametro:=l_parametro||'<td>'||cur.id_anho::text||'</td>
              <td>'||cur.mes||'</td>
              <td>'||cur.programa||'</td>
              <td>'||cur.tipo_pago||'</td>
              <td style="text-align: right;">'||to_char(cur.costohora,'99999.99')||'</td>
              <td style="text-align: right;">'||to_char(cur.horas,'99999.99')||'</td>
              <td style="text-align: right;">'||to_char(cur.importe,'99999.99')||'</td>';
              l_total:=l_total+cur.importe;
              l_id_mes:=cur.id_mes;
              l_totalacu:=l_totalacu+cur.importe;
              l_j:=l_j +1;
              l_i:=l_i +1;

              
          END;
          END LOOP;

          if l_j=0 then
            l_parametro:='';
          else
            l_parametro:=l_parametro||'</tr>';
            if l_i>1 then
              l_parametro:=l_parametro||'<tr>';
              l_parametro:=l_parametro||'<td colspan="6" style="text-align: right;font-weight: bold;">Total Mes:</td>
              <td style="text-align: right;font-weight: bold;">'||to_char(l_total,'99999.99')||'</td>';
              l_parametro:=l_parametro||'</tr>';
            end if;
            l_parametro:=l_parametro||'<tr>';
            l_parametro:=l_parametro||'<td colspan="6" style="text-align: right;font-weight: bold;">Total:</td>
            <td style="text-align: right;font-weight: bold;">'||to_char(l_totalacu,'99999.99')||'</td>';
            l_parametro:=l_parametro||'</tr>';
            l_parametro:=l_parametro||'</table>';
          end if;
        end if;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        P_PARAMETRO_RET:=l_parametro;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_ptlcostoxhora (P_ID_CONTRATO bigint, P_PARAMETRO text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
