-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_ptlacademico (P_ID_CONTRATO bigint, P_PARAMETRO text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_parametro text:='';
        l_id_solic_reque bigint:=0;
        l_id_semestre bigint;

BEGIN
      
        case P_PARAMETRO
           when 'ESCUELA_PROG' then 
--             <<FIND_DATOS>>
			BEGIN
	             select string_agg(x.nombre,', ' ORDER BY x.id_programa_estudio) into STRICT l_parametro
	             from (
	              SELECT b.nombre,b.id_programa_estudio from enoc.plla_contrato_det a,david.acad_programa_estudio b 
	              where a.id_programa_estudio=b.id_programa_estudio
	              and a.id_contrato=P_ID_CONTRATO
	              group by b.nombre,b.id_programa_estudio
	            )x  order by x.id_programa_estudio;
           	EXCEPTION WHEN no_data_found THEN
	            l_parametro := '';
	        END;
          when 'CICLO_ACAD' then
             select string_agg(x.semestre,', ' ORDER BY x.id_semestre) into STRICT l_parametro
             from (
              SELECT b.semestre,b.id_semestre from enoc.plla_contrato_det a,david.acad_semestre b 
              where a.id_semestre=b.id_semestre
              and a.id_contrato=P_ID_CONTRATO
              group by b.semestre,b.id_semestre
            )x  order by x.id_semestre;

            if coalesce(l_parametro::text, '') = '' then
              select id_solic_reque into STRICT l_id_solic_reque from enoc.plla_contrato where id_contrato=P_ID_CONTRATO;
--              	<<FIND_DATOS>>
				BEGIN
             	select id_semestre into STRICT l_id_semestre from ENOC.PLLA_SOLIC_REQUE where id_solic_reque=l_id_solic_reque;
             	EXCEPTION WHEN no_data_found THEN
		            l_parametro := null;
		        END;
              if (l_id_semestre IS NOT NULL AND l_id_semestre::text <> '') THEN
                	select semestre into STRICT l_parametro from david.acad_semestre where id_semestre=l_id_semestre;
              end if;
            end if;
          WHEN 'CURSOS' THEN
--           	<<FIND_DATOS>>
			BEGIN
	            SELECT
	            '<table border="1">
	            <tr>
	              <th>Programa</th>
	              <th>Curso</th>
	              <th>Ciclo</th>
	              <th>Grupo</th>
	            </tr>'
	            ||string_agg('<tr><td>'||X.NOMBRE||'</td>
	              <td>'||X.CURSO||'</td>
	              <td>'||X.CICLO||'</td>
	              <td>'||X.GRUPO||'</td>
	            </tr>', '' ORDER BY X.ID_PROGRAMA_ESTUDIO)||'</table>'  INTO STRICT  l_parametro
	            FROM (
	            SELECT 
	            A.ID_PROGRAMA_ESTUDIO,
	            B.NOMBRE,
	            A.CURSO,
	            A.ID_CARGA_CURSO,
	            A.CICLO,
	            coalesce(A.GRUPO,'-') AS GRUPO
	            from enoc.PLLA_COSTOXHORA_CARGA A,DAVID.ACAD_PROGRAMA_ESTUDIO B
	            where A.ID_PROGRAMA_ESTUDIO=B.ID_PROGRAMA_ESTUDIO
	            AND A.id_contrato=P_ID_CONTRATO
	            GROUP BY 
	            A.ID_PROGRAMA_ESTUDIO,
	            B.NOMBRE,
	            A.CURSO,
	            A.ID_CARGA_CURSO,
	            A.CICLO,
	            A.GRUPO
	            ORDER BY A.ID_PROGRAMA_ESTUDIO, A.ID_CARGA_CURSO,A.CICLO,A.GRUPO
	            )X;
           	EXCEPTION WHEN no_data_found THEN
	            l_parametro := '';
	        END;
          else
            l_parametro:='';
        end case;

       
      
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        P_PARAMETRO_RET:=l_parametro;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_ptlacademico (P_ID_CONTRATO bigint, P_PARAMETRO text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
