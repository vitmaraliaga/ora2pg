-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_gen_plantilla_cont (P_ID_CONTARTO bigint,P_ID_USER bigint,P_DIR_FIRMA text,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_plantilla text:='';
        l_contrato text:='';
        l_parametro  text:='';
        l_longitud bigint:=0;
        l_id_plantilla_contrato bigint;
        l_url_firma varchar(300);
        curpara CURSOR FOR
        SELECT 
          ID_CONTRATO_PARAMETRO,
          TIPO,
          PARAMETRO,
          SIGNIFICADO,
          COMENTARIO,
          CAMPO,
          PROCESO,
          VIGENCIA
        from PLLA_CONTRATO_PARAMETRO
        ORDER BY ID_CONTRATO_PARAMETRO;

      
BEGIN
      
        select ID_CONTRATO_PLANTILLA INTO STRICT l_id_plantilla_contrato from PLLA_CONTRATO WHERE ID_CONTRATO=P_ID_CONTARTO;

        --l_id_plantilla_contrato:=5;
        
        SELECT COUNT(*) INTO STRICT l_contar  from PLLA_CONTRATO_PLANTILLA where ID_CONTRATO_PLANTILLA=l_id_plantilla_contrato;

        IF l_contar=0 THEN
            l_error:=1;
            l_msgerror:='No esta configurado plantilla';
--             goto salida_genptlcont;
        END IF;

        select PLANTILLA,coalesce(length(PLANTILLA),0) INTO STRICT l_plantilla,l_longitud from PLLA_CONTRATO_PLANTILLA where ID_CONTRATO_PLANTILLA=l_id_plantilla_contrato;

        
        /*IF l_longitud<500 THEN
            l_error:=1;
            l_msgerror:='No esta configurado plantilla';
--             goto salida_genptlcont;
        END IF;*/
        
        FOR cur in curpara LOOP
        BEGIN
          if cur.tipo='F' then
             EXECUTE 'SELECT '||cur.campo||'  from ENOC.VW_CONTRATO_PLANTILLA a where a.id_contrato=:P_ID_CONTRATO' into STRICT l_parametro USING P_ID_CONTARTO;
             if cur.parametro='SUELDO' then
                l_parametro:= to_char((l_parametro)::numeric ,'99999.99');
             end if;

             
          else
          
            EXECUTE 'BEGIN PKG_CONTRACT.'||cur.proceso||'(:P_ID_CONTRATO,:P_PARAMETRO,:l_parametro,:l_error,:l_msgerror); end;'
            USING P_ID_CONTARTO,cur.parametro,IN OUT l_parametro,IN OUT l_error,IN OUT l_msgerror;

            if cur.parametro ='REP_FIRMA' then
              if (l_parametro IS NOT NULL AND l_parametro::text <> '') then
                /*l_url_firma:=P_DIR_FIRMA||'/'||l_parametro;
                l_url_firma:='<img src="'||l_url_firma||'"  height="100px">';*/
                l_parametro:='';
              end if;

            end if;
            --if l_error=1 then
            --  Exit when l_error=1;
            --end if;
          end if;
          --dbms_output.put_line(l_plantilla||' '||cur.parametro||'='||l_parametro||'-'||l_error);
          if coalesce(l_parametro::text, '') = '' then
            l_parametro:='{'||cur.parametro||'}';
          end if;
          l_plantilla:=replace(l_plantilla,'['||cur.parametro||']',l_parametro);
        END;
        END LOOP;

        IF l_error=0 THEN
          UPDATE PLLA_CONTRATO SET
          CONTRATO = l_plantilla
          WHERE ID_CONTRATO=P_ID_CONTARTO;
        END IF;

--         <<salida_genptlcont>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_gen_plantilla_cont (P_ID_CONTARTO bigint,P_ID_USER bigint,P_DIR_FIRMA text,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
