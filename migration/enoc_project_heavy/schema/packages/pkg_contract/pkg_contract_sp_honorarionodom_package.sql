-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_contract,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_contract_sp_honorarionodom (P_ID_CONTRATO bigint, P_PARAMETRO text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_parametro text:='';
        l_id_persona bigint;
        l_id_entidad bigint;
        l_id_anho bigint;
        l_total decimal(10,2):=0;
        l_deduccion decimal(10,2):=0;
        l_recibe decimal(10,2):=0;
        l_porc_deduccion decimal(10,4):=0;
        l_porc_renta decimal(10,4):=0;
        l_base bigint:=0;

BEGIN
      
        SELECT id_persona, id_entidad into STRICT l_id_persona,l_id_entidad from plla_contrato where id_contrato=P_ID_CONTRATO;
        select (to_char(clock_timestamp(),'YYYY'))::numeric  into STRICT l_id_anho;

        select coalesce(sum(importe),0) into STRICT l_total from  enoc.plla_contrato_det where id_contrato=P_ID_CONTRATO;

        if P_PARAMETRO in ('DED_IMP_RENTA','TOTAL_REM_NODM') then
          select count(*) into STRICT l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where codigo='DED_LEY_NDOM'
          and id_entidad=l_id_entidad
          and id_anho=l_id_anho;

          if l_contar>0 then
            select importe into STRICT l_porc_deduccion from ENOC.VW_PLLA_PARAMETROS_VALOR where codigo='DED_LEY_NDOM'
            and id_entidad=l_id_entidad
            and id_anho=l_id_anho;
          end if;

          select count(*) into STRICT l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where codigo='IMP_REN_NDOM'
          and id_entidad=l_id_entidad
          and id_anho=l_id_anho;

          if l_contar>0 then
            select importe into STRICT l_porc_renta from ENOC.VW_PLLA_PARAMETROS_VALOR where codigo='IMP_REN_NDOM'
            and id_entidad=l_id_entidad
            and id_anho=l_id_anho;
          end if;
        end if;


        case P_PARAMETRO
           when 'TOTAL_HONO_NODOM' then 
            l_parametro:=to_char(l_total,'99999.99');
           when 'DED_IMP_RENTA' then
            l_base:= l_total-round((l_total*l_porc_deduccion)::numeric,2);
            l_deduccion:=round((l_base*l_porc_renta)::numeric,2);
            l_parametro:=to_char(l_deduccion,'99999.99');
           when 'TOTAL_REM_NODM' then
            l_base:= l_total-round((l_total*l_porc_deduccion)::numeric,2);
            l_deduccion:=round((l_base*l_porc_renta)::numeric,2);
            l_recibe:= l_total - l_deduccion;
            l_parametro:=to_char(l_recibe,'99999.99');
           else
            l_parametro:='';
        end case;
        
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
        P_PARAMETRO_RET:=l_parametro;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_contract_sp_honorarionodom (P_ID_CONTRATO bigint, P_PARAMETRO text,P_PARAMETRO_RET OUT text, P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
