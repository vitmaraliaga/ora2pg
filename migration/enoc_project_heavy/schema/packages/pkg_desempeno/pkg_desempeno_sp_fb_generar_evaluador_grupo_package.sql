-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_desempeno,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_desempeno_sp_fb_generar_evaluador_grupo (P_ID_DESEMPENO bigint,P_ID_ENTIDAD bigint, P_ID_DEPTO text,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_evaluador bigint;

        l_query varchar(4000):='';
        l_id_depto varchar(2000):='';


BEGIN
      
        delete from enoc.TT_LISTAR_PARAM_PART;

        l_id_depto:=''''||REPLACE(P_ID_DEPTO, '*', ''',''')||'''';

    
        l_query:='insert into  enoc.TT_LISTAR_PARAM_PART(ID_CAMPO_NUM,ID_CAMPO_VAR,TIPO) ';
        l_query:=l_query||'select null,id_depto,''D'' from eliseo.conta_entidad_depto where id_depto in('||l_id_depto||') and id_entidad=:p1 ';

        EXECUTE l_query USING P_ID_ENTIDAD;

   
        select coalesce(max(ID_EVALUADOR),0)  into STRICT l_id_evaluador from enoc.DES_FB_EVALUADOR;

        insert into ENOC.DES_FB_EVALUADOR(
          ID_EVALUADOR,
          ID_DESEMPENO,
          ID_TRABAJADOR,
          ID_SEDEAREA,
          ID_PERFIL_PUESTO,
          ID_CONDICION_LABORAL,
          ID_TIPO_TIEMPO_TRABAJO,
          ID_USER_REG,
          FECHA_REG
        )
        SELECT (row_number() OVER ( ORDER BY x.ID_TRABAJADOR ASC )) + l_id_evaluador as ID_PARTICIPANTE,
        P_ID_DESEMPENO as ID_DESEMPENO,
        x.ID_TRABAJADOR,
        x.ID_SEDEAREA,
        x.ID_PERFIL_PUESTO,
        x.ID_CONDICION_LABORAL,
        x.ID_TIPO_TIEMPO_TRABAJO,
        P_ID_USER_REG,
        clock_timestamp()
        from (
          SELECT 
          a.ID_TRABAJADOR,
          a.ID_SEDEAREA,
          a.ID_PERFIL_PUESTO,
          a.ID_CONDICION_LABORAL,
          a.ID_TIPO_TIEMPO_TRABAJO
          from moises.trabajador a,enoc.vw_ent_dep_area_ccosto b
          where a.ID_SEDEAREA=b.ID_SEDEAREA
          and a.id_situacion_trabajador='1'
          and a.id_entidad=P_ID_ENTIDAD
          and b.ID_DEPTO_PADRE in (
            select ID_CAMPO_VAR from enoc.TT_LISTAR_PARAM_PART where tipo='D' 
          )
          and a.ID_TRABAJADOR not in (
            select ID_TRABAJADOR from enoc.DES_FB_EVALUADOR
            where ID_DESEMPENO=P_ID_DESEMPENO
          )
          and a.id_perfil_puesto in (
            select id_perfil_puesto_jefe from enoc.plla_perfil_puesto
            where id_entidad=P_ID_ENTIDAD
            and id_depto in (
              select ID_CAMPO_VAR from enoc.TT_LISTAR_PARAM_PART where tipo='D' 
            ) 
          ) 
                             
        )x;

--         <<salida>>
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_desempeno_sp_fb_generar_evaluador_grupo (P_ID_DESEMPENO bigint,P_ID_ENTIDAD bigint, P_ID_DEPTO text,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
