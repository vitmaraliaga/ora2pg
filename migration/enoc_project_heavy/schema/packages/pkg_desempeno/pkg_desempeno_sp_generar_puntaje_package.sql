-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_desempeno,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_desempeno_sp_generar_puntaje (P_ID_PARTICIPANTE bigint,P_ID_TIPO text,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_id_desempeno bigint;
        l_puntaje bigint;
        l_puntaje_dec decimal(10,2);
        l_puntos bigint;
        l_id_tipo_calculo bigint;
        l_base decimal(10,2);
        l_id_escala bigint;
        l_id_perfil_puesto bigint;
         l_puntosq bigint;
        l_puntajeq_dec decimal(10,2);
        l_puntajeq bigint;
        l_tipo_eval varchar(2);

BEGIN 
      
        select id_desempeno,id_perfil_puesto into STRICT l_id_desempeno,l_id_perfil_puesto from enoc.des_participante where id_participante=P_ID_PARTICIPANTE;

        select id_tipo_calculo,coalesce(TIPO_EVAL,'P') into STRICT l_id_tipo_calculo,l_tipo_eval  from enoc.des_desempeno where id_desempeno=l_id_desempeno;

        select base into STRICT l_base from enoc.des_tipo_calculo where id_tipo_calculo=l_id_tipo_calculo;

        if l_tipo_eval='Q' then
          select coalesce(avg(puntaje),0) into STRICT l_puntosq from  ENOC.DES_PARTICIPANTE_EVALUADOR 
          where id_participante=P_ID_PARTICIPANTE
          and coalesce(TIPO_EVAL,'P')='Q';

          l_puntaje_dec:=round((l_puntosq)::numeric,2);
          l_puntaje:=round((l_puntosq)::numeric,0);
        else

          SELECT coalesce(SUM(coalesce(PUNTOS,0)),0) into STRICT  l_puntos
          FROM ENOC.VW_DES_RESULTADO_MODELO_SUM 
          where ID_PARTICIPANTE=P_ID_PARTICIPANTE
          and id_perfil_puesto=l_id_perfil_puesto;

          l_puntaje_dec:=ROUND((l_puntos*l_base)/100,2);
          l_puntaje:=ROUND((l_puntos*l_base)/100,0);
        end if;
        if l_puntaje_dec>0 then
          select count(1) into STRICT l_contar from enoc.des_desempeno_escala where id_desempeno=l_id_desempeno and (l_puntaje between desde and hasta);
          if l_contar=1 then
            select id_escala into STRICT l_id_escala from enoc.des_desempeno_escala where id_desempeno=l_id_desempeno and (l_puntaje between desde and hasta);
          end if;
        end if;

        if P_ID_TIPO='C' then  --C.puntaje y cierre, P: solo puntaje
            update enoc.des_participante set
              id_escala=l_id_escala,
              puntaje=l_puntaje_dec,
              CERRADO=1,
              id_user_mod=P_ID_USER_REG,
              fecha_mod=clock_timestamp()
            where id_participante=P_ID_PARTICIPANTE;
          else
            update enoc.des_participante set
              id_escala=l_id_escala,
              puntaje=l_puntaje_dec,
              id_user_mod=P_ID_USER_REG,
              fecha_mod=clock_timestamp()
            where id_participante=P_ID_PARTICIPANTE;
          end if;

        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_desempeno_sp_generar_puntaje (P_ID_PARTICIPANTE bigint,P_ID_TIPO text,P_ID_USER_REG bigint,P_ERROR OUT bigint, P_MSGERROR out text) FROM PUBLIC;
