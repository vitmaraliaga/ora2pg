-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_reporte_permiso_lic_det ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONCEPTO_PERM_LIC bigint, P_ID_TIPO_SUSPENSION bigint, P_ID_TRABAJADOR bigint, P_TIPO text, P_ID_ANHO bigint, P_ID_MES bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), P_PERIODO text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREA text, P_ID_USER bigint, OUT CURSOR REFCURSOR ) AS $body$
DECLARE

         l_desdes timestamp(0);
          l_hasta timestamp(0);
          l_mes varchar(5);
          l_trab varchar(100):='';
          l_columna varchar(1500):='';
          l_query varchar(4000):='';
          l_where varchar(1500):='';
          l_id_tipo_nivel_vista bigint;

BEGIN
      
      IF P_TIPO='RA' THEN
        l_desdes:=P_FECHA_DESDE;
        l_hasta:=P_FECHA_HASTA;
      ELSE
        select to_date('01-'||P_ID_MES::text||'-'||P_ID_ANHO::text,'dd/mm/yyyy'),  date_trunc('day', ((date_trunc('month',(to_date('01-'||P_ID_MES::text||'-'||P_ID_ANHO::text,'dd/mm/yyyy'))::timestamp + interval '1 month'))::timestamp(0) - 1))
        into STRICT l_desdes,l_hasta
;

        if P_ID_MES <10 then
          l_mes:='0'||P_ID_MES::text;
        else
          l_mes:=P_ID_MES::text;
        end if;

      END IF;

        if P_RESTRINGIDO='S' then
          select id_tipo_nivel_vista into STRICT l_id_tipo_nivel_vista from eliseo.lamb_acceso_nivel where id_acceso_nivel=P_ID_ACCESO_NIVEL;
        end if;

      
        l_trab:='a.id_trabajador,';
        l_columna:='a.id_licencia_permiso,';
        l_columna:=l_columna|| 'a.id_tipo_perm_lic,';
        l_columna:=l_columna|| 'a.id_concepto_perm_lic,';
        l_columna:=l_columna|| 'a.tipo_perm_lic,';
        l_columna:=l_columna|| 'a.nombre, ';
        l_columna:=l_columna|| 'a.codsunat,';
        l_columna:=l_columna|| 'a.periodo,';
        l_columna:=l_columna|| 'a.id_estado_lica_per,';
        l_columna:=l_columna|| 'a.fecha_desde_real,';
        l_columna:=l_columna|| 'a.fecha_hasta_real,';
        --l_columna:=l_columna|| 'CASE WHEN a.fecha_desde<:S_DESDE THEN :S_DESDE ELSE a.fecha_desde END,';
        --l_columna:=l_columna|| 'CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END,';
        l_columna:=l_columna|| 'CASE WHEN a.fecha_desde<:S_DESDE THEN :S_DESDE ELSE a.fecha_desde END,';
        l_columna:=l_columna|| 'CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END,';
        l_columna:=l_columna|| 'a.dias_real,';
        l_columna:=l_columna|| 'a.horas,';
        --l_columna:=l_columna|| 'CASE WHEN a.periodo=''H'' THEN 0 ELSE ';
        l_columna:=l_columna|| '((CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END) -  (CASE WHEN a.fecha_hasta>:S_HASTA THEN :S_HASTA ELSE a.fecha_hasta END))+1, ';
        --l_columna:=l_columna|| 'END,';
        l_columna:=l_columna|| 'a.horas, ';
        l_columna:=l_columna|| 'a.ADJUNTO, ';
        l_columna:=l_columna|| 'a.ADJUNTOCITT, ';
        l_columna:=l_columna|| 'a.ADJUNTOVOUCHER, ';
        l_columna:=l_columna|| 'a.ADJUNTONIT, ';
        l_columna:=l_columna|| 'a.ADJUNTOVIVA, ';
        l_columna:=l_columna|| 'a.ADJUNTOPAGO ';


        if (P_ID_DEPTO IS NOT NULL AND P_ID_DEPTO::text <> '') then
          l_where:=l_where||'and a.id_depto='''||P_ID_DEPTO||''' ';
        end if;
        if P_ID_CONCEPTO_PERM_LIC>0 then
          l_where:=l_where||'and a.id_concepto_perm_lic in('||P_ID_CONCEPTO_PERM_LIC::text||') ';
        end if;

         if P_ID_TIPO_SUSPENSION>0 then
          l_where:=l_where||'and a.ID_TIPO_SUSPENSION in('||P_ID_TIPO_SUSPENSION::text||') ';
        end if;

        if (P_PERIODO IS NOT NULL AND P_PERIODO::text <> '') then
          l_where:=l_where||'and a.PERIODO in('''||P_PERIODO::text||''') ';
        end if;

        
 
       l_query:='insert into ENOC.TT_LICENCIA_PERMISO(';
       l_query:=l_query|| 'ID_TRABAJADOR,ID_LICENCIA_PERMISO,ID_TIPO_PERM_LIC,ID_CONCEPTO_PERM_LIC,TIPO_PERM_LIC,NOMBRE,CODSUNAT,PERIODO,ID_ESTADO_LICA_PER,FECHA_DESDE,FECHA_HASTA, FECHA_DESDE_PROC,FECHA_HASTA_PROC,';
       l_query:=l_query|| 'DIAS,HORAS,DIAS_PROC,HORAS_PROC,ADJUNTO,ADJUNTOCITT,ADJUNTOVOUCHER,ADJUNTONIT,ADJUNTOVIVA,ADJUNTOPAGO) ';
       l_query:=l_query|| 'select ';
       l_query:=l_query|| l_trab || l_columna;
       l_query:=l_query|| 'from ENOC.VW_LICENCIA_PERMISO_REP a, moises.trabajador t, eliseo.vw_sede_area sa ';
       l_query:=l_query|| 'where a.id_trabajador=t.id_trabajador ';
       l_query:=l_query|| 'and t.id_sedearea=sa.id_sedearea ';
       l_query:=l_query|| 'and a.id_entidad=:S_ID_ENTIDAD ';
       l_query:=l_query|| 'and a.engrupo=''N'' ';
       l_query:=l_query|| 'and a.id_estado_lica_per not in(''00'',''04'') ';
       if P_ID_TRABAJADOR > 0 then
          l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';
       end if;
       l_query:=l_query|| l_where;
       --IF P_TIPO='RA' THEN
        --l_query:=l_query||'and ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) ';
        --l_query:=l_query||'and ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ';
       /*ELSE
        l_query:=l_query||'and (to_char(a.fecha_desde,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''' or to_char(a.fecha_hasta,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''') ';
       END IF;*/
        l_query:=l_query||'and ( ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) or ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ) ';

       if P_RESTRINGIDO='S' then
            
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and sa.id_depto_padre in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||')';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and sa.id_area in('||P_ID_AREA||')';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';
          end if;
        end if;

        if P_RESTRINGIDO='U' then
          l_query:=l_query||'and a.id_trabajador='||P_ID_TRABAJADOR::text||' ';
        end if;

       
       l_query:=l_query|| ' union all ';
       l_trab:='b.id_trabajador,';
       l_query:=l_query|| 'select ';
       l_query:=l_query|| l_trab || l_columna;
       l_query:=l_query|| 'from ENOC.VW_LICENCIA_PERMISO_REP a, enoc.plla_licencia_permiso_det b, moises.trabajador t, eliseo.vw_sede_area sa  ';
       l_query:=l_query|| 'where a.id_licencia_permiso=b.id_licencia_permiso ';
       l_query:=l_query|| 'and b.id_trabajador=t.id_trabajador ';
       l_query:=l_query|| 'and t.id_sedearea=sa.id_sedearea ';
       l_query:=l_query|| 'and a.id_entidad=:S_ID_ENTIDAD ';
       l_query:=l_query|| 'and a.engrupo=''S'' ';
       l_query:=l_query|| 'and a.id_estado_lica_per not in(''00'',''04'') ';
       if P_ID_TRABAJADOR > 0 then
          l_query:=l_query||'and b.id_trabajador='||P_ID_TRABAJADOR::text||' ';
       end if;
       l_query:=l_query|| l_where;
       --IF P_TIPO='RA' THEN
        --l_query:=l_query||'and ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) ';
        --l_query:=l_query||'and ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ';
       /*ELSE
        l_query:=l_query||'and (to_char(a.fecha_desde,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''' or to_char(a.fecha_hasta,''MMYYYY'')='''||l_mes||to_char(P_ID_ANHO)||''') ';
       END IF;*/
        l_query:=l_query||'and ( ((a.fecha_desde between :S_DESDE and :S_HASTA) or (a.fecha_hasta between :S_DESDE and :S_HASTA)) or ((:S_DESDE between a.fecha_desde and a.fecha_hasta) or (:S_HASTA between a.fecha_desde and a.fecha_hasta)) ) ';

       if P_RESTRINGIDO='S' then
         
          if l_id_tipo_nivel_vista = 3 then
              l_query:=l_query||'and sa.id_depto_padre in(select id_depto from enoc.vw_acceso_nivel where id_acceso_nivel='||P_ID_ACCESO_NIVEL::text||')';
          end if;
          if l_id_tipo_nivel_vista = 4 then
              l_query:=l_query||'and sa.id_area in('||P_ID_AREA||')';
          end if;
          if l_id_tipo_nivel_vista = 5 then
              l_query:=l_query||'and b.id_trabajador='||P_ID_USER::text||' ';
          end if;
        end if;

        if P_RESTRINGIDO='U' then
          l_query:=l_query||'and b.id_trabajador='||P_ID_USER::text||' ';
        end if;

        EXECUTE l_query USING l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta,l_desdes, l_hasta,
        l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta,l_desdes, l_hasta;

       /*IF P_TIPO='RA' THEN
        EXECUTE IMMEDIATE l_query USING l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta,
        l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,l_desdes, l_hasta,l_desdes, l_hasta;

       else
        EXECUTE IMMEDIATE l_query USING l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD,--l_desdes, l_hasta,
        l_desdes,l_desdes, l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,l_hasta,  P_ID_ENTIDAD;--,l_desdes, l_hasta;

       end if;
       */
      
    
      OPEN CURSOR FOR 
      SELECT
      a.id_licencia_permiso,
      a.id_trabajador,
      a.periodo,
      a.FECHA_DESDE, 
      a.FECHA_HASTA, 
      a.FECHA_DESDE_PROC, 
      a.FECHA_HASTA_PROC, 
      a.horas,
      a.dias,
      a.horas_proc,
      --a.dias_proc,
      a.adjunto,
      a.adjuntocitt, 
      a.adjuntovoucher, 
      a.adjuntonit, 
      a.adjuntoviva, 
      a.adjuntopago,
      case when a.periodo='H' then a.dias else (a.FECHA_HASTA_PROC - a.FECHA_DESDE_PROC)+1
      end as dias_proc
      from ENOC.TT_LICENCIA_PERMISO a
      order by a.FECHA_DESDE;

      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_reporte_permiso_lic_det ( P_ID_ENTIDAD bigint, P_ID_DEPTO text, P_ID_CONCEPTO_PERM_LIC bigint, P_ID_TIPO_SUSPENSION bigint, P_ID_TRABAJADOR bigint, P_TIPO text, P_ID_ANHO bigint, P_ID_MES bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), P_PERIODO text, P_RESTRINGIDO text, P_ID_ACCESO_NIVEL bigint, P_ID_AREA text, P_ID_USER bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
