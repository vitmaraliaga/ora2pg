-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_gen_periodo_vac_masivo_upn (P_ID_ENTIDAD bigint,P_ID_AREA bigint,P_ID_PERFIL_PUESTO bigint, P_ID_PERIODO_VAC bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_error bigint:=0;
        l_msgerror varchar(200):='';
        l_error1 bigint:=0;
        l_msgerror1 varchar(200):='';
        l_i integer:=0;
         curPER CURSOR FOR
         SELECT
              t.ID_TRABAJADOR
            FROM MOISES.TRABAJADOR  t
            WHERE t.ID_SEDEAREA IN (
              SELECT sa.ID_SEDEAREA FROM ELISEO.VW_SEDE_AREA sa
              WHERE CASE WHEN P_ID_AREA = 0 THEN 1 ELSE CASE WHEN sa.ID_AREA=P_ID_AREA THEN 1 ELSE 0 END END = 1
              AND sa.ID_ENTIDAD = CASE WHEN P_ID_ENTIDAD = 0 THEN (SELECT ID_ENTIDAD FROM ENOC.PLLA_PERIODO_VAC WHERE ID_PERIODO_VAC = P_ID_PERIODO_VAC) ELSE P_ID_ENTIDAD END 
            )
            AND t.ID_SITUACION_TRABAJADOR='1'
            AND (t.fecha_inicio IS NOT NULL AND t.fecha_inicio::text <> '')
            AND CASE WHEN P_ID_PERFIL_PUESTO = 0 THEN 1 ELSE CASE WHEN ID_PERFIL_PUESTO = P_ID_PERFIL_PUESTO THEN 1 ELSE 0 END END = 1
            AND NOT EXISTS (
              SELECT 1
              FROM PLLA_PERIODO_VAC_TRAB pvt
              WHERE pvt.ID_PERIODO_VAC=P_ID_PERIODO_VAC
              AND pvt.ID_TRABAJADOR = t.ID_TRABAJADOR
            );

        
BEGIN
          FOR cur in curPER LOOP
            BEGIN
              CALL pkg_benefits_sp_generar_periodo_vac_trab(cur.id_trabajador,P_ID_PERIODO_VAC,l_i,l_error1,l_msgerror1);
              l_i:=l_i + 1;
            END;
          END LOOP;

        if l_i=0 then
          l_error:=1;
          l_msgerror:='No hay datos para generar';
        end if;

        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;

        END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_gen_periodo_vac_masivo_upn (P_ID_ENTIDAD bigint,P_ID_AREA bigint,P_ID_PERFIL_PUESTO bigint, P_ID_PERIODO_VAC bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
