-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_reporte_ayudas_educativas ( P_ID_ENTIDAD bigint, P_ID_SITUACION_TRABAJADOR text, P_ID_CONDICION_LABORAL text, P_DATO text, P_ANHO_DESDES bigint, P_ANHO_HASTA bigint, OUT CURSOR REFCURSOR ) AS $body$
BEGIN

     
    
    OPEN CURSOR FOR  
    SELECT 
    a.id_trabajador,
    a.tipodocresp,
    a.NUM_DOCUMENTO,
    a.APELLIDONOMBRE,
    a.DEPTO_PADRE,
    a.CONDICION_LABORAL,
    a.area,
    a.TIPO_TIEMPO_TRABAJO,
    to_char(a.FECHA_INICIO,'DD/MM/YYYY') as FECHA_INICIO,
    to_char(a.FECHA_FIN_PREVISTO,'DD/MM/YYYY') as FECHA_FIN_PREVISTO,
    a.SITUACION_TRABAJADOR,
    b.id_alumno_contrato,
    b.id_persona as id_alumno,
    b.id_resp_financiero,
    b.TIPO_RESP_FINANCIERO ,
    b.tipodocalum,
    b.num_alumno,
    b.alumno,
    b.semestre,
    b.sede,
    b.NIVEL_ENSENANZA,
    b.MODALIDAD_ESTUDIO,
    b.cod_alumno,
    b.ciclo,
    b.facultad,
    b.programa_estudio,
    b.plan_pago,
    b.anho,
    b.fec_nacimiento,
    b.edad,
    c.ID_CRITERIO_SEMESTRE,
    c.id_criterio, 
    c.descripcion,
    c.IMPORTE,
    c.modo_contrato
    from (
    SELECT 
    t.id_trabajador,
    t.id_persona,
    ttd.SIGLAS as tipodocresp,
    t.NUM_DOCUMENTO,
    t.APELLIDONOMBRE,
    tar.DEPTO_PADRE,
    tcl.nombre as CONDICION_LABORAL,
    tar.area,
    ttt.NOMBRE as TIPO_TIEMPO_TRABAJO,
    t.FECHA_INICIO,
    t.FECHA_FIN_PREVISTO,
    tst.nombre as SITUACION_TRABAJADOR
    from enoc.vw_trabajador t,
    ENOC.VW_ENT_DEP_AREA_CCOSTO tar,
    MOISES.CONDICION_LABORAL tcl, 
    MOISES.SITUACION_TRABAJADOR tst,
    MOISES.TIPO_TIEMPO_TRABAJO ttt,
    ENOC.VW_PERFIL_PUESTO tpp,
    MOISES.TIPO_DOCUMENTO ttd
    where t.ID_SEDEAREA=tar.ID_SEDEAREA
    and t.ID_CONDICION_LABORAL=tcl.ID_CONDICION_LABORAL
    and t.ID_SITUACION_TRABAJADOR=tst.ID_SITUACION_TRABAJADOR
    and t.id_TIPO_TIEMPO_TRABAJO=ttt.ID_TIPO_TIEMPO_TRABAJO
    and t.ID_PERFIL_PUESTO=tpp.ID_PERFIL_PUESTO
    and t.id_entidad=P_ID_ENTIDAD
    and t.id_tipodocumento=ttd.ID_TIPODOCUMENTO
    and t.ID_SITUACION_TRABAJADOR like P_ID_SITUACION_TRABAJADOR
    and t.ID_CONDICION_LABORAL like P_ID_CONDICION_LABORAL
    and (translate(lower(t.APELLIDONOMBRE), 'áéíóúàèìòùãõâêîôôäëïöüçñÁÉÍÓÚÀÈÌÒÙÃÕÂÊÎÔÛÄËÏÖÜÇÑ','aeiouaeiouaoaeiooaeioucnAEIOUAEIOUAOAEIOOAEIOUCN') like translate(lower(P_DATO), 'áéíóúàèìòùãõâêîôôäëïöüçñÁÉÍÓÚÀÈÌÒÙÃÕÂÊÎÔÛÄËÏÖÜÇÑ','aeiouaeiouaoaeiooaeioucnAEIOUAEIOUAOAEIOOAEIOUCN') or t.NUM_DOCUMENTO like P_DATO) 
    )a,
    (
    select 
    c.id_alumno_contrato,
    c.id_persona,
    c.id_resp_financiero,
    trf.nombre as TIPO_RESP_FINANCIERO ,
    tdoc.SIGLAS as tipodocalum,
    pn.NUM_DOCUMENTO as num_alumno,
    pn.APELLIDONOMBRE as alumno,
    se.semestre,
    sed.nombre as sede,
    ne.nombre as NIVEL_ENSENANZA,
    me.nombre as MODALIDAD_ESTUDIO,
    pna.codigo as cod_alumno,
    david.Ft_Calcular_Ciclo_Programa(se.semestre,c.id_persona,c.Id_Plan_Programa) as ciclo,
    sun.nombre as facultad,
    pe.nombre as programa_estudio,
    mpag.nombre as plan_pago,
    (SUBSTR(se.semestre,1,4))::numeric  as anho,
    to_char(pn.fec_nacimiento,'DD/MM/YYYY') as fec_nacimiento,
    floor(months_between( clock_timestamp() ,pn.fec_nacimiento)/12) AS edad
    from david.acad_alumno_contrato c, 
    DAVID.ACAD_SEMESTRE_PROGRAMA sp,
    david.acad_programa_estudio pe, 
    david.acad_semestre se,
    DAVID.TIPO_MODALIDAD_ESTUDIO me,
    DAVID.TIPO_NIVEL_ENSENANZA ne,
    ELISEO.VW_SEDE_AREA sun,
    ELISEO.VW_SEDE_AREA sue,
    eliseo.ORG_SEDE sed,
    moises.persona_natural_alumno pna,
    enoc.vw_persona_natural pn,
    MOISES.TIPO_DOCUMENTO tdoc,
    DAVID.TIPO_RESP_FINANCIERO trf,
    eliseo.MAT_PLANPAGO_SEMESTRE mpp,
    eliseo.MAT_PLANPAGO mpag
    where c.id_SEMESTRE_PROGRAMA=sp.id_SEMESTRE_PROGRAMA
    and sp.ID_PROGRAMA_ESTUDIO=pe.ID_PROGRAMA_ESTUDIO
    and sp.id_semestre=se.ID_SEMESTRE
    and pe.ID_MODALIDAD_ESTUDIO=me.ID_MODALIDAD_ESTUDIO
    and pe.ID_NIVEL_ENSENANZA=ne.ID_NIVEL_ENSENANZA
    and pe.ID_UNIDAD_ACADEMICA=sun.ID_SEDEAREA
    and pe.ID_SEDEAREA=sue.ID_SEDEAREA
    and sue.id_sede=sed.id_sede
    and c.id_persona=pna.id_persona
    and pna.id_persona=pn.id_persona
    and pn.ID_TIPODOCUMENTO=tdoc.ID_TIPODOCUMENTO
    and c.id_tipo_resp_financiero= trf.id_tipo_resp_financiero
    and c.ID_PLANPAGO_SEMESTRE=mpp.ID_PLANPAGO_SEMESTRE
    and mpp.ID_PLANPAGO= mpag.ID_PLANPAGO
    and c.estado='1'
    and (SUBSTR(se.semestre,1,4))::numeric  between P_ANHO_DESDES and P_ANHO_HASTA  
    )b,
    (
    select cde.ID_ALUMNO_CONTRATO,csem.ID_CRITERIO_SEMESTRE,csem.id_criterio, csem.nombre as descripcion,cde.IMPORTE,mcont.nombre as modo_contrato 
    from eliseo.MAT_ALUMNO_CONTRATO_DET cde, eliseo.VW_MAT_CRITERIO_SEMESTRE csem, david.modo_contrato mcont
    where cde.ID_CRITERIO_SEMESTRE=csem.ID_CRITERIO_SEMESTRE
    and csem.id_modo_contrato= mcont.id_modo_contrato
    and csem.dc='C' and csem.codigo in ( 'DESCHMENS','DHP','DSCTOHHPP') 
    )c 
    where a.id_persona=b.id_resp_financiero
    and b.ID_ALUMNO_CONTRATO=c.ID_ALUMNO_CONTRATO
    order by a.APELLIDONOMBRE,b.alumno,b.anho,b.semestre,c.id_criterio;

  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_reporte_ayudas_educativas ( P_ID_ENTIDAD bigint, P_ID_SITUACION_TRABAJADOR text, P_ID_CONDICION_LABORAL text, P_DATO text, P_ANHO_DESDES bigint, P_ANHO_HASTA bigint, OUT CURSOR REFCURSOR ) FROM PUBLIC;
