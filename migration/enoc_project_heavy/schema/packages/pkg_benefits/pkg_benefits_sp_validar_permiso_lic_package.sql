-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_benefits,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_benefits_sp_validar_permiso_lic ( P_ID_ENTIDAD bigint, P_ID_CONCEPTO_PERM_LIC bigint, P_ID_TRABAJADOR bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), OUT CURSOR REFCURSOR ) AS $body$
DECLARE

          l_contar bigint;
          l_dias bigint:=0;
          l_horas bigint:=0;
          l_min_dias bigint:=0;
          l_max_dias bigint:=0;
          l_max_dias_anho bigint:=0;
          l_dias_max bigint:=0;
          l_codigo varchar(10);
          l_dias_desmed bigint:=0;
          l_fecha_fin_desmed timestamp(0);
          l_dias_subs bigint:=0;
          l_fecha_ini_subs timestamp(0);
          l_fecha_fin_subs timestamp(0);
          l_s bigint:=0;

      
BEGIN
        
        SELECT 
        coalesce(MIN_DIAS,0),
        coalesce(MAX_DIAS,0),
        coalesce(MAX_DIAS_ANHO,0),
        CODIGO
        INTO STRICT 
        l_min_dias,
        l_max_dias,
        l_max_dias_anho,
        l_codigo
        FROM PLLA_CONCEPTO_PERM_LIC 
        WHERE ID_CONCEPTO_PERM_LIC= P_ID_CONCEPTO_PERM_LIC;

        IF (P_FECHA_HASTA IS NOT NULL AND P_FECHA_HASTA::text <> '') AND (P_FECHA_DESDE IS NOT NULL AND P_FECHA_DESDE::text <> '') THEN
         select (P_FECHA_HASTA -  P_FECHA_DESDE)+1 into STRICT  l_dias;
        END IF;

        IF (P_FECHA_DESDE IS NOT NULL AND P_FECHA_DESDE::text <> '') THEN
          IF l_codigo IN ('PERM_SGOCE','PERM_COMP') THEN
              select COALESCE(SUM(A.CANTIDAD),0) INTO STRICT l_dias_max  from PLLA_LICENCIA_PERMISO_ANHO A , PLLA_LICENCIA_PERMISO P,PLLA_CONCEPTO_PERM_LIC C  
              WHERE A.ID_LICENCIA_PERMISO=P.ID_LICENCIA_PERMISO 
              AND P.ID_CONCEPTO_PERM_LIC=C.ID_CONCEPTO_PERM_LIC
              AND P.ID_TRABAJADOR = P_ID_TRABAJADOR
              AND P.ID_ENTIDAD = P_ID_ENTIDAD
              AND C.CODIGO IN ('PERM_SGOCE','PERM_COMP')
              AND A.ID_ANHO = (TO_CHAR(P_FECHA_DESDE,'YYYY'))::numeric 
              AND P.ID_ESTADO_LICA_PER NOT IN ('00','04');
          ELSE
              select COALESCE(SUM(A.CANTIDAD),0) INTO STRICT l_dias_max  from PLLA_LICENCIA_PERMISO_ANHO A , PLLA_LICENCIA_PERMISO P
              WHERE A.ID_LICENCIA_PERMISO=P.ID_LICENCIA_PERMISO 
              AND P.ID_TRABAJADOR = P_ID_TRABAJADOR
              AND P.ID_ENTIDAD = P_ID_ENTIDAD
              AND P.ID_CONCEPTO_PERM_LIC= P_ID_CONCEPTO_PERM_LIC
              AND A.ID_ANHO = (TO_CHAR(P_FECHA_DESDE,'YYYY'))::numeric 
              AND P.ID_ESTADO_LICA_PER NOT IN ('00','04');
          END IF;
        END IF;
        IF (P_FECHA_HASTA IS NOT NULL AND P_FECHA_HASTA::text <> '') AND (P_FECHA_DESDE IS NOT NULL AND P_FECHA_DESDE::text <> '') THEN
          IF l_codigo = 'DESC_MED' THEN

            IF (l_dias_max+l_dias)>l_max_dias_anho THEN
            
              l_s := (l_dias_max+l_dias) - l_max_dias_anho;
              l_dias_desmed:= l_dias - l_s;
              l_dias_subs:= l_s;
              if l_dias_desmed<0 then
                l_dias_desmed:= 0;
                l_dias_subs:= l_dias;
              end if;

              l_fecha_ini_subs:= P_FECHA_DESDE+l_dias_desmed;
              l_fecha_fin_subs:= P_FECHA_HASTA;

              if l_dias_desmed>0 then
               l_fecha_fin_desmed:=P_FECHA_HASTA - l_dias_subs;
              end if;

            ELSE
              l_dias_desmed:= l_dias;
              l_dias_subs:= 0;
              l_fecha_fin_desmed:=P_FECHA_HASTA;

            END IF;

         END IF;
       END IF;
       OPEN CURSOR FOR
       SELECT l_dias_max AS DIAS_ACUMULADO,l_dias_desmed AS DIAS_DESMED, l_fecha_fin_desmed AS FECHA_FIN_DESMES,l_dias_subs AS DIAS_SUBS,
       l_fecha_ini_subs AS FECHA_INI_SUBS,l_fecha_fin_subs AS FECHA_FIN_SUBS,l_dias_max+l_dias as TOTAL_DIA ,l_max_dias_anho as MAX_DIAS_ANHO
;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_benefits_sp_validar_permiso_lic ( P_ID_ENTIDAD bigint, P_ID_CONCEPTO_PERM_LIC bigint, P_ID_TRABAJADOR bigint, P_FECHA_DESDE timestamp(0), P_FECHA_HASTA timestamp(0), OUT CURSOR REFCURSOR ) FROM PUBLIC;
