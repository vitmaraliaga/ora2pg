-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_job_analysis,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_job_analysis_sp_copiar_tipo_horario (P_IDS_TIPO_HORARIO text,P_ID_ENTIDAD_TO bigint,P_ID_DEPTO_TO text, P_ERROR OUT bigint,P_MSGERROR OUT text) AS $body$
DECLARE

		L_ERROR bigint:=0;
		L_MSGERROR varchar(5000):='';
		ID_TIPO_HORARIO_MAX bigint:=0;
	
  TIPOHORARIO RECORD;

BEGIN
	
		 FOR TIPOHORARIO IN (WITH RECURSIVE cte AS (

		   		SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) ID
				
				(SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) IS NOT NULL  UNION ALL

		   		SELECT (SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) ID
				
				(SELECT array_to_string(a, '') FROM regexp_matches(P_IDS_TIPO_HORARIO, '[^,]+', 'g') AS foo(a) LIMIT 1 OFFSET (LEVEL - 1) ) IS NOT NULL JOIN cte c ON ()

) SELECT * FROM cte)
		 LOOP
			 select coalesce(max(ID_TIPO_HORARIO),0) into STRICT ID_TIPO_HORARIO_MAX from enoc.PLLA_TIPO_HORARIO;
			
			 INSERT INTO ENOC.PLLA_TIPO_HORARIO(ID_TIPO_HORARIO,ID_ENTIDAD,ID_DEPTO,NOMBRE,DESCRIPCION,VIGENCIA,ID_TIPO_CONFIG_HORARIO,CODIGO,CONTROL_CULTO)
			 SELECTrow_number() over ()+ID_TIPO_HORARIO_MAX AS ID_TIPO_HORARIO,C.* FROM (SELECT A.ID_ENTIDAD,A.ID_DEPTO,B.*
				FROM (SELECT ID_ENTIDAD,ID_DEPTO FROM ELISEO.CONTA_ENTIDAD_DEPTO WHERE ID_ENTIDAD = P_ID_ENTIDAD_TO AND ES_GRUPO = '1' AND LENGTH(ID_DEPTO) = 1 ) A,
				(SELECT NOMBRE,DESCRIPCION,VIGENCIA,ID_TIPO_CONFIG_HORARIO,CODIGO,CONTROL_CULTO FROM ENOC.PLLA_TIPO_HORARIO WHERE ID_TIPO_HORARIO = TIPOHORARIO.ID) B
				WHERE 1=1 AND 1 = (CASE WHEN P_ID_DEPTO_TO = '0' THEN 1 ELSE CASE WHEN ID_DEPTO = P_ID_DEPTO_TO THEN 1 ELSE 0 END END) )C
				LEFT JOIN ENOC.PLLA_TIPO_HORARIO D ON UPPER(trim(both C.NOMBRE)) = UPPER(trim(both D.NOMBRE)) AND D.ID_ENTIDAD = C.ID_ENTIDAD AND D.ID_DEPTO = C.ID_DEPTO
				WHERE coalesce(D.NOMBRE::text, '') = '' AND C.ID_DEPTO <> '0';
			
		 END LOOP;
		
-- 		<<salida_val>> 
	    P_ERROR:= L_ERROR;
	    P_MSGERROR:= L_MSGERROR;
	END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_job_analysis_sp_copiar_tipo_horario (P_IDS_TIPO_HORARIO text,P_ID_ENTIDAD_TO bigint,P_ID_DEPTO_TO text, P_ERROR OUT bigint,P_MSGERROR OUT text) FROM PUBLIC;
