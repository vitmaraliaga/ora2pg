-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_selection,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_selection_sp_reg_estado_candidato ( P_ID_SOLIC_REQ_CANDIDATO bigint, P_ID_ESTADO_REQ_CAND text, P_ID_REQ_CAND_PLANTILLA bigint, P_COMENTARIO text, P_CONSULEDO text, P_SUELDO_SUGERIDO bigint, P_USER bigint, P_ID_NEW out bigint, P_ENVIAR out text, P_ERROR OUT bigint, P_MSGERROR out text ) AS $body$
DECLARE

    l_contar bigint;
    l_error bigint:=0;
    l_msgerror varchar(200):='';
    l_id bigint;
    l_apro bigint;
    l_enviar varchar(1):='-';
    l_correo varchar(300);
    l_id_entidad bigint;
    l_id_persona bigint;
    l_id_situacion_trabajador varchar(5);
    l_id_modalidad_req bigint;

BEGIN
   
   IF P_CONSULEDO='S' THEN
    update enoc.plla_solic_req_candidato set
       ID_ESTADO_REQ_CAND=P_ID_ESTADO_REQ_CAND,
       SUELDO_SUGERIDO=P_SUELDO_SUGERIDO,
       id_user_mod = P_USER,
       fecha_mod= clock_timestamp()
     where ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO;
   ELSE
     update enoc.plla_solic_req_candidato set
       ID_ESTADO_REQ_CAND=P_ID_ESTADO_REQ_CAND,
       id_user_mod = P_USER,
       fecha_mod= clock_timestamp()
     where ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO;
   END IF;

   select pn.correo,r.id_entidad,s.id_persona,r.ID_MODALIDAD_REQ into STRICT l_correo,l_id_entidad,l_id_persona,l_id_modalidad_req from enoc.vw_persona_natural pn, enoc.plla_SOLIC_REQ_CANDIDATO s,enoc.PLLA_SOLIC_REQUE r
   where pn.id_persona=s.id_persona
   and s.ID_SOLIC_REQUE=r.ID_SOLIC_REQUE
   and ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO;

   IF P_ID_ESTADO_REQ_CAND='06' and l_id_modalidad_req=3 THEN
    SELECT COUNt(*) into STRICT l_contar from moises.trabajador where id_entidad=l_id_entidad and id_persona=l_id_persona;
    if l_contar>0 then
      SELECT id_situacion_trabajador into STRICT l_id_situacion_trabajador from moises.trabajador where id_entidad=l_id_entidad and id_persona=l_id_persona;
      if l_id_situacion_trabajador='1' then
        update enoc.plla_solic_req_candidato set
           MODALIDAD='I',
           id_user_mod = P_USER,
           fecha_mod= clock_timestamp()
         where ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO;
      end if;
    end if;
   END IF;

  
   
   select coalesce(max(id_solic_req_candidato_es),0) + 1 into STRICT l_id from enoc.plla_solic_req_candidato_est;

   insert into enoc.plla_solic_req_candidato_est(
     id_solic_req_candidato_es,
     id_solic_req_candidato,
     id_estado_req_cand,
     id_req_cand_plantilla,
     comentario,
     correo,
     id_user_reg,
     fecha_reg
     )values (
     l_id,
     P_ID_SOLIC_REQ_CANDIDATO,
     P_ID_ESTADO_REQ_CAND,
     P_ID_REQ_CAND_PLANTILLA,
     P_COMENTARIO,
     l_correo,
     P_USER,
     clock_timestamp()
   );

   select coalesce(aprobacion,0) into STRICT l_apro from enoc.plla_ESTADO_REQ_CAND where ID_ESTADO_REQ_CAND=P_ID_ESTADO_REQ_CAND;

   if l_apro = 1 then
    CALL enoc.pkg_selection_sp_gen_plantilla_aprob(l_id,l_error,l_msgerror);
    if l_error=0 then
      l_enviar:='S';
    else
      l_enviar:='N';
    end if;
   end if;
--     <<salida_proc>>
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
    P_ENVIAR:= l_enviar;
    P_ID_NEW:= l_id;
  END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_selection_sp_reg_estado_candidato ( P_ID_SOLIC_REQ_CANDIDATO bigint, P_ID_ESTADO_REQ_CAND text, P_ID_REQ_CAND_PLANTILLA bigint, P_COMENTARIO text, P_CONSULEDO text, P_SUELDO_SUGERIDO bigint, P_USER bigint, P_ID_NEW out bigint, P_ENVIAR out text, P_ERROR OUT bigint, P_MSGERROR out text ) FROM PUBLIC;
