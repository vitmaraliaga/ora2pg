-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = enoc,pkg_selection,public;




CREATE OR REPLACE PROCEDURE enoc.pkg_selection_sp_costoxhora_req_cand_asin (P_ID_SOLIC_REQ_CANDIDATO bigint,P_ID_SEMESTRE bigint,P_FECHA_PAGO timestamp(0),P_ID_PERSONA bigint,P_INICIO timestamp(0), P_FIN timestamp(0),P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

        l_contar bigint;
        l_error bigint:=0;
        l_msgerror varchar(200):='ok';

        f_pago timestamp(0);
        l_fecha timestamp(0) := P_INICIO;
        l_fin timestamp(0):=date_trunc('day', ((date_trunc('month',(P_FIN)::timestamp + interval '1 month'))::timestamp(0) - 1));

BEGIN
        
        f_pago:= P_FECHA_PAGO;

        select 
        count(*) into STRICT l_contar
        from enoc.PLLA_COSTOXHORA_CARGA_REQ
        where ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO
        and id_semestre=P_ID_SEMESTRE;

        if l_contar>0 then
          select 
           max(FECHA) as FECHA_FIN
           into STRICT 
           f_pago
          from enoc.PLLA_COSTOXHORA_CARGA_REQ
          where ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO
          and id_semestre=P_ID_SEMESTRE;

        END IF;

        WHILE l_fecha<=l_fin loop
        begin
        
          select 
          count(*) into STRICT l_contar
          from enoc.PLLA_COSTOXHORA_CARGA_REQ
          where ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO
          and id_semestre=P_ID_SEMESTRE
          and to_char(FECHA,'YYYYMM')=to_char(l_fecha,'YYYYMM');

          if l_contar>0 then
            select 
             max(FECHA) as FECHA_FIN
             into STRICT 
             f_pago
            from enoc.PLLA_COSTOXHORA_CARGA_REQ
            where ID_SOLIC_REQ_CANDIDATO=P_ID_SOLIC_REQ_CANDIDATO
            and id_semestre=P_ID_SEMESTRE
            and to_char(FECHA,'YYYYMM')=to_char(l_fecha,'YYYYMM');
          else
            f_pago:=l_fecha;
          END IF;
          INSERT INTO enoc.PLLA_COSTOXHORA_CARGA_REQ(
          ID_CARGA_CURSO,
          ID_SEMESTRE,
          ID_PERSONA,
          ID_TIPO_MODALIDAD_DOCENTE,
          ID_TIPO_HORARIO,
          FECHA,
          HORAS,
          ID_PROGRAMA_ESTUDIO,
          HORARIO,
          ID_SEDEAREA,
          NOMBRE_AREA,
          CURSO,
          CICLO,
          CREDITOS,
          HP,
          HT,
          HNP,
          ID_SOLIC_REQ_CANDIDATO,
          GRUPO,
          HORA_ASIN
        )
          SELECT
          c.ID_CARGA_CURSO,
          f.id_semestre,
          b.id_persona,
          7 as ID_TIPO_MODALIDAD_DOCENTE,
          1 as ID_TIPO_HORARIO,
          f_pago,
          a.HORAS_ASINCRONAS as horas,
          f.id_programa_estudio,
          '-' as horario,
          g.id_sedearea,
          e.nombre_area,
          e.curso,
          e.ciclo,
          e.CREDITO,
          e.HP,
          e.HT,
          e.HNP,
          P_ID_SOLIC_REQ_CANDIDATO,
          c.grupo,
          'S'
          from david.ACAD_CARGA_DOCENTE_DETALLE a,
          david.ACAD_CARGA_DOCENTE b,
          david.acad_carga_curso c,
          david.Acad_Carga_Curso_Det d,
          david.Vw_Acad_Curso_Plan e,
          david.Acad_Semestre_Programa f,
          david.vw_acad_programa_estudio g
          where a.ID_CARGA_DOCENTE=b.ID_CARGA_DOCENTE
          and b.ID_CARGA_CURSO=c.ID_CARGA_CURSO
          and c.ID_CARGA_CURSO=d.ID_CARGA_CURSO
          and d.ID_PLAN_CURSO=e.ID_PLAN_CURSO
          and c.id_semestre_programa=f.id_semestre_programa
          and f.Id_Programa_Estudio = g.Id_Programa_Estudio
          and f.id_semestre=P_ID_SEMESTRE
          and b.id_persona=P_ID_PERSONA
          and d.origen='O'
          and coalesce(a.HORAS_ASINCRONAS,0)>0
          and c.ID_CARGA_CURSO in (
           SELECT cadoc.Id_Carga_Curso from DAVID.ACAD_CARGA_CURSO_DOCENTE cadoc, DAVID.ACAD_MODULO_DETALLE modet
           where modet.id_modulo_detalle= cadoc.id_modulo_detalle
           --and to_char(modet.fecha_fin,'YYYYMM')=to_char(l_fecha,'YYYYMM')
           group by cadoc.Id_Carga_Curso
           having  to_char(max(modet.fecha_fin),'YYYYMM')=to_char(l_fecha,'YYYYMM') 
          ) 
          order by c.ID_CARGA_CURSO;
          l_fecha:= l_fecha + '1 month'::interval;
          end;
        END LOOP;
        P_ERROR:=l_error;
        P_MSGERROR:=l_msgerror;
      END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enoc.pkg_selection_sp_costoxhora_req_cand_asin (P_ID_SOLIC_REQ_CANDIDATO bigint,P_ID_SEMESTRE bigint,P_FECHA_PAGO timestamp(0),P_ID_PERSONA bigint,P_INICIO timestamp(0), P_FIN timestamp(0),P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
