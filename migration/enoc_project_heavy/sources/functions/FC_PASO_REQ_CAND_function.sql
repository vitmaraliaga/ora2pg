-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = enoc,public;
\set ON_ERROR_STOP ON

function                FC_PASO_REQ_CAND(P_ID_SOLIC_REQUE NUMBER,P_ID_PERSONA NUMBER) RETURN NUMBER
IS
l_contar number:=0;
l_id_paso_req number:=null;
l_id_modalidad_req number;
l_esdocente number;
l_id_entidad number;
l_codigo_mod varchar2(20);
l_codigo_paso varchar2(20);
l_id_situacion_trabajador varchar2(10);
l_extint varchar2(5):='E';
BEGIN
    
    select id_modalidad_req, coalesce(esdocente,0),id_entidad
    into l_id_modalidad_req,l_esdocente,l_id_entidad
    from enoc.plla_SOLIC_REQUE where ID_SOLIC_REQUE=P_ID_SOLIC_REQUE;
    
    select codigo into l_codigo_mod from enoc.plla_modalidad_req where id_modalidad_req=l_id_modalidad_req;
    
    case 
        when l_codigo_mod in('CI','CES') then 
          l_codigo_paso:='PSEC';
        when l_codigo_mod in('CE','IN') then 
          if l_esdocente=1 then
            l_codigo_paso:='PCEC';
          else
            l_codigo_paso:='PSEC';
          end if;
        when l_codigo_mod in('TR','ID') then 
            l_codigo_paso:='DIR';
        when l_codigo_mod = 'CM' then 
          select count(1) into l_contar from moises.trabajador where id_persona=P_ID_PERSONA and id_entidad=l_id_entidad;
          if l_contar>0 then
            select id_situacion_trabajador into l_id_situacion_trabajador from moises.trabajador where id_persona=P_ID_PERSONA and id_entidad=l_id_entidad;
            if l_id_situacion_trabajador='0' then
              l_extint:='E';
            else
              l_extint:='I';
            end if;  
          end if;
          if l_extint='I' then
            l_codigo_paso:='PSEC';
          else
            if l_esdocente=1 then
              l_codigo_paso:='PCEC';
            else
              l_codigo_paso:='PSEC';
            end if;
          end if;
    else 
      l_codigo_paso:=null;
    end case;
    
    if l_codigo_paso is not null then
      select ID_PASO_REQUE into l_id_paso_req from ENOC.PLLA_PASO_REQUE where codigo=l_codigo_paso;
    end if;
	RETURN(l_id_paso_req);
END;

