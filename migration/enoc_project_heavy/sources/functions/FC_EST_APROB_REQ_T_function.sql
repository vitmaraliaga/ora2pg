-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = enoc,public;
\set ON_ERROR_STOP ON

function                           FC_EST_APROB_REQ_T(P_ID_SOLIC_REQUE NUMBER, P_ID_ESTADO_REQ VARCHAR2) RETURN VARCHAR2
IS
l_dato VARCHAR2(5):='N';
l_contar int:=0;
l_id_estado_act VARCHAR2(5);
l_id_estado VARCHAR2(5);
l_id_tipo_paso number;
l_orden number;
l_id_entidad number;
BEGIN

     SELECT ID_ESTADO_REQ, ID_PASO_REQUE, ID_ENTIDAD
     INTO l_id_estado, l_id_tipo_paso,l_id_entidad
     FROM enoc.PLLA_SOLIC_REQUE 
     WHERE ID_SOLIC_REQUE=P_ID_SOLIC_REQUE;
     
 
     SELECT COUNT(*) INTO l_contar 
     FROM enoc.PLLA_PASO_REQUE_EST 
     WHERE ID_PASO_REQUE=l_id_tipo_paso
     AND ID_ESTADO_REQ=l_id_estado
     AND ID_ENTIDAD =l_id_entidad ;
     
     IF l_contar>0 THEN
        
       SELECT COUNT(*) INTO l_contar 
       FROM enoc.PLLA_PASO_REQUE_EST 
       WHERE ID_PASO_REQUE=l_id_tipo_paso
       AND ID_ESTADO_REQ=P_ID_ESTADO_REQ
       AND ID_ENTIDAD =l_id_entidad ;
     

       IF l_contar>0 THEN
       
         select orden into l_orden from ENOC.PLLA_ESTADO_REQ
         WHERE ID_ESTADO_REQ=P_ID_ESTADO_REQ;
         
         SELECT COUNT(*) INTO l_contar  
         FROM enoc.VW_PASO_REQUE_EST
         WHERE ID_PASO_REQUE=l_id_tipo_paso
         AND ID_ENTIDAD= l_id_entidad
         AND orden<l_orden
         ORDER BY orden DESC;
        
         IF l_contar>0 THEN
           SELECT max(ID_ESTADO_REQ) INTO l_id_estado_act 
           FROM enoc.VW_PASO_REQUE_EST
           WHERE ID_PASO_REQUE=l_id_tipo_paso
           AND ID_ENTIDAD= l_id_entidad
           AND orden<l_orden
          -- AND  ROWNUM = 1
           ORDER BY orden DESC;
           
           if l_id_estado_act = l_id_estado then
              l_dato:='S';
           end if;
         END IF;
        END IF;
     END IF;
  
	RETURN(l_dato);
END;

