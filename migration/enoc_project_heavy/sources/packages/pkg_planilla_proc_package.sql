-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = enoc,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE                                      PKG_PLANILLA_PROC AS 

  --ingresos 
  PROCEDURE SP_I_SUELDO_BAS_MENSUAL(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_I_SUELDO_BAS_MENSUAL_MIS(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_I_ASIG_FAMILIAR(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_I_ADICIONALES(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  --aprotaciones del trabajador
  PROCEDURE SP_R_FONDO_PENSION(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_R_ONP(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_R_AFP_PRIMA_SEGURO(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  PROCEDURE SP_R_AFP_COMISION(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  --aprotaciones del empleados
  PROCEDURE SP_A_ESSALUD(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  --descuentos
  PROCEDURE SP_D_DONACION_DIEZMO_AUTOR(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2);
  
END PKG_PLANILLA_PROC;


CREATE OR REPLACE PACKAGE BODY                                         PKG_PLANILLA_PROC AS

  PROCEDURE SP_I_SUELDO_BAS_MENSUAL(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2) AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;
  l_id_condicion_laboral varchar2(5);
  l_tipo_pago varchar2(5); 
  l_sueldo number(10,2):=0;
  l_id_remuneracion number;
  l_id_concepto_planilla number;
  l_adicionales number(10,2);
  l_imp_pago number(10,2);
  BEGIN
  
  select 
  id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0)
  INTO
  l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias
  FROM ENOC.VW_PLANILLA_TRAB
  WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
  
  select 
  id_condicion_laboral  
  into 
  l_id_condicion_laboral 
  from moises.trabajador where id_trabajador=l_id_trabajador;
  
  select id_concepto_planilla into l_id_concepto_planilla 
  from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
  where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
  
  if l_id_condicion_laboral in('E','C') and l_num_dias>0 then
  
    select count(1) into l_contar
    from enoc.plla_remuneracion 
    where id_trabajador=l_id_trabajador
    and vigencia=1;
    
    if l_contar=0 then
      l_error:=1;
      l_msgerror:='No esta registrado sueldo';
      goto salida;
    end if;
    if l_contar>1 then
      l_error:=1;
      l_msgerror:='Mas de una configuración de sueldo';
      goto salida;
    end if;
    
    select id_remuneracion,tipo_pago,coalesce(sueldo,0)
    into
    l_id_remuneracion,l_tipo_pago,l_sueldo
    from enoc.plla_remuneracion 
    where id_trabajador=l_id_trabajador
    and vigencia=1;

    if l_tipo_pago='H' then
      select coalesce(sum(importe),0) into l_sueldo 
      from ENOC.plla_remuneracion_det 
      where id_remuneracion=l_id_remuneracion 
      and id_anho=l_id_anho 
      and id_mes=l_id_mes;
      
      l_imp_pago:=l_sueldo;
    else
      l_imp_pago:=(l_sueldo*l_num_dias)/30;
    end if;

    
    --adicionales
     select coalesce(SUM(IMPORTE),0) into l_adicionales  
     from  ENOC.VW_ADICIONAL_PAGO
     where id_trabajador=l_id_trabajador
     and id_anho=l_id_anho 
     and id_mes=l_id_mes
     and id_concepto_planilla=l_id_concepto_planilla
     and id_estado_adicional in('04','03')--03:Aprobación financiera, 04:Aprobación de GTH
     and coalesce(finalizado,0)=1
     and vigencia=1;
     
     l_importe:= l_imp_pago + l_adicionales;
     
     if l_importe>0 then
    
        PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            0,
            0,
            l_sueldo
        );
      
      end if;
     
  end if;

  
  <<salida>>
  P_IMPORTE:=l_importe;
  P_ERROR:=l_error;
  P_MSGERROR:=l_msgerror;
   
  END SP_I_SUELDO_BAS_MENSUAL;
  
  PROCEDURE SP_I_SUELDO_BAS_MENSUAL_MIS(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2) AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;
  l_id_condicion_laboral varchar2(5);
  l_fmr number(10,2):=0;
  l_sueldo number(10,2):=0;
  l_id_remuneracion number;
  l_param_fmr number(10,2);
  l_id_concepto_planilla number;
  l_adicionales number(10,2);
  l_imp_pago number(10,2);
  BEGIN
  
  select 
  id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),PARAM_FMR
  INTO
  l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_param_fmr
  FROM ENOC.VW_PLANILLA_TRAB
  WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
  
  select 
  id_condicion_laboral  
  into 
  l_id_condicion_laboral 
  from moises.trabajador where id_trabajador=l_id_trabajador;
  
  select id_concepto_planilla into l_id_concepto_planilla 
  from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
  where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
  
  if l_id_condicion_laboral in('M') and l_num_dias>0 then
  
    select count(1) into l_contar
    from enoc.plla_remuneracion 
    where id_trabajador=l_id_trabajador
    and vigencia=1;
    
    if l_contar=0 then
      l_error:=1;
      l_msgerror:='No esta registrado sueldo';
      goto salida;
    end if;
    if l_contar>1 then
      l_error:=1;
      l_msgerror:='Mas de una configuración de sueldo';
      goto salida;
    end if;
    
    select id_remuneracion,coalesce(fmr,0)
    into
    l_id_remuneracion,l_fmr
    from enoc.plla_remuneracion 
    where id_trabajador=l_id_trabajador
    and vigencia=1;
    
    
    l_sueldo:= l_param_fmr*l_fmr;
    l_imp_pago:=(l_sueldo*l_num_dias)/30;
    
  
     l_importe:= l_imp_pago ;
     
     if l_importe>0 then
    
        PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            0,
            l_fmr,
            l_sueldo
        );
      
      end if;
     
  end if;

  
  <<salida>>
  P_IMPORTE:=l_importe;
  P_ERROR:=l_error;
  P_MSGERROR:=l_msgerror;
   
  END SP_I_SUELDO_BAS_MENSUAL_MIS;
  
  PROCEDURE SP_I_ASIG_FAMILIAR(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;
  l_id_condicion_laboral varchar2(5);
  l_id_concepto_planilla number;
  l_id_persona number;
  l_fecha_mes_fin date;
  l_fecha_mes_ini date;
  l_id_entidad number;
  l_asig_fam number(10,2):=0;
  l_porc number(10,2):=0;
  BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    SELECT TO_DATE('01/'||to_char(l_id_mes)||'/'||to_char(l_id_anho),'DD/MM/YYYY'),
    LAST_DAY(TO_DATE('01/'||to_char(l_id_mes)||'/'||to_char(l_id_anho),'DD/MM/YYYY')) 
    into l_fecha_mes_ini,l_fecha_mes_fin 
    FROM DUAL;
    
    select 
    id_condicion_laboral,
    id_persona
    into 
    l_id_condicion_laboral,
    l_id_persona
    from moises.trabajador where id_trabajador=l_id_trabajador;
    
    select id_concepto_planilla into l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
    
    IF l_id_condicion_laboral NOT IN('M') and l_num_dias>0 THEN
    
      select count(1) into l_contar from(
        select A.id_registrado
        from moises.vinculo_familiar a, moises.persona_natural b
        where A.id_registrado=b.id_persona
        and a.id_persona=l_id_persona
        and a.ID_TIPO_VINCULO_FAMILIAR='05'
        and a.ID_TIPO_ESTADO_VINCULO='02' --aprobado
        and FLOOR(MONTHS_BETWEEN(l_fecha_mes_fin, b.fec_nacimiento ) / 12)<=18   --05	HIJO(A),06	HIJO MAYOR DE EDAD INCAPACITADO PERMANENTE
        union
        select A.id_registrado
        from moises.vinculo_familiar a, moises.persona_natural b
        where A.id_registrado=b.id_persona
        and a.id_persona=l_id_persona
        and a.ID_TIPO_ESTADO_VINCULO='02' --aprobado
        and a.ID_TIPO_VINCULO_FAMILIAR='06'
      );
      
      if l_contar=0 then

        select count(1) into l_contar 
        from  "MOISES"."VINCULO_FAMILIAR_SUPERIOR" 
        where ID_TIPO_ESTADO_VINCULO='02' --aprobado
        and ((DESDE between l_fecha_mes_ini and l_fecha_mes_fin) or (HASTA between l_fecha_mes_ini and l_fecha_mes_fin))
        and id_VINCULO_FAMILIAR in(
          select id_VINCULO_FAMILIAR
          from moises.vinculo_familiar a, moises.persona_natural b
          where A.id_registrado=b.id_persona
          and a.id_persona=l_id_persona
          and a.ID_TIPO_VINCULO_FAMILIAR='05'
          and a.ID_TIPO_ESTADO_VINCULO='02' --aprobado
          and FLOOR(MONTHS_BETWEEN(l_fecha_mes_fin, b.fec_nacimiento ) / 12)>18
        );
        
      end if;
      
      if l_contar>0 then
         
         
         select count(*) into  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_PJEAF' and id_anho=l_id_anho;
         if l_contar=1 then
            select importe into l_porc from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_PJEAF' and id_anho=l_id_anho;
         end if;
         
         select count(*) into  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_AF' and id_anho=l_id_anho;
         if l_contar=0 then
            l_error:=1;
            l_msgerror:='Falta configurar parametro asig. familiar';
            goto salida;
         end if;
         
         select importe into l_importe from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_AF' and id_anho=l_id_anho;
         
         PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            0,
            l_porc,
            0
        );
        
      end if;
    
    END IF;
    <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_I_ASIG_FAMILIAR;
  
  
  PROCEDURE SP_I_ADICIONALES(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2) AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;

  l_id_remuneracion number;
  l_id_concepto_planilla number;
  l_adicionales number(10,2);

  BEGIN
  
  select 
  id_trabajador,  id_anho,  id_mes, coalesce(num_dias,0)
  INTO
  l_id_trabajador,  l_id_anho,  l_id_mes ,l_num_dias 
  FROM ENOC.VW_PLANILLA_TRAB
  WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
  

  select id_concepto_planilla into l_id_concepto_planilla 
  from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
  where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
  
  
    --adicionales
     select coalesce(SUM(IMPORTE),0) into l_adicionales  
     from  ENOC.VW_ADICIONAL_PAGO
     where id_trabajador=l_id_trabajador
     and id_anho=l_id_anho 
     and id_mes=l_id_mes
     and id_concepto_planilla=l_id_concepto_planilla
     and id_estado_adicional in('04','03')--03:Aprobación financiera, 04:Aprobación de GTH
     and coalesce(finalizado,0)=1
     and vigencia=1;
     
     l_importe:= l_adicionales;
     
     if l_importe>0 then
    
        PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            0,
            0,
            0
        );
      
      end if;
     


  
  <<salida>>
  P_IMPORTE:=l_importe;
  P_ERROR:=l_error;
  P_MSGERROR:=l_msgerror;
   
  END SP_I_ADICIONALES;
  
  PROCEDURE SP_R_FONDO_PENSION(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;

  l_id_concepto_planilla number;
  l_id_persona number;
  l_id_entidad number;
  l_regimen_pensionaria varchar2(5);
  l_tipo varchar2(5);
  l_id_tipo_comision_pens number;
  l_porc number(10,3):=0;
  l_importe_cal number(10,2):=0;

  BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    select 
    b.id_persona,
    a.id_regimen_pensionaria,
    a.ID_TIPO_COMISION_PENS
    into 
    l_id_persona,
    l_regimen_pensionaria,
    l_id_tipo_comision_pens
    from moises.PERSONA_NATURAL_TRABAJADOR a,
    moises.trabajador b 
    where a.id_persona=b.id_persona
    and b.id_trabajador=l_id_trabajador;
    
    select id_concepto_planilla into l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
    
    select  count(*) into  l_contar from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PU','PR') ;
    if l_contar=0 then
        l_error:=1;
        l_msgerror:='No tiene asignado régimen pensionaria';
        goto salida;
    end if;
     
    select  tipo into  l_tipo from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PU','PR') ;
    
    if l_tipo='PR' then
      select count(*) into  l_contar from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;
      
      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Falta configurar régimen pensionaria para el periodo a procesar';
          goto salida;
      end if;
      
      select round((fondo/100.000),3) into  l_porc from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;
      
       if l_porc<=0 then
          l_error:=1;
          l_msgerror:='Fondo de régimen pensionaria es cero';
          goto salida;
      end if;
      
     
      select coalesce(sum(importe),0) into l_importe_cal from VW_PLLA_PLANILLA_TRAB_DET 
      where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB
      and id_tipo_concepto='I'
      and coalesce(TRA_SPP,'0')='1';
      
      l_importe:= round(l_importe_cal*l_porc,2);
             
      PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            l_importe_cal,
            l_porc,
            0
        );
     end if;    
    <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_R_FONDO_PENSION;
  
  PROCEDURE SP_R_ONP(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;

  l_id_concepto_planilla number;
  l_id_persona number;
  l_id_entidad number;
  l_regimen_pensionaria varchar2(5);
  l_tipo varchar2(5);
  l_id_tipo_comision_pens number;
  l_porc number(10,3):=0;
  l_importe_cal number(10,2):=0;

  BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    select 
    b.id_persona,
    a.id_regimen_pensionaria,
    a.ID_TIPO_COMISION_PENS
    into 
    l_id_persona,
    l_regimen_pensionaria,
    l_id_tipo_comision_pens
    from moises.PERSONA_NATURAL_TRABAJADOR a,
    moises.trabajador b 
    where a.id_persona=b.id_persona
    and b.id_trabajador=l_id_trabajador;
    
    select id_concepto_planilla into l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
    
    select  count(*) into  l_contar from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PU','PR') ;
    if l_contar=0 then
        l_error:=1;
        l_msgerror:='No tiene asignado régimen pensionaria';
        goto salida;
    end if;
     
    select  tipo into  l_tipo from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PU','PR') ;
    
    if l_tipo='PU' then
      select count(*) into  l_contar from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;
      
      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Falta configurar régimen pensionaria para el periodo a procesar';
          goto salida;
      end if;
      
      select round((fondo/100.000),3) into  l_porc from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;
      
       if l_porc<=0 then
          l_error:=1;
          l_msgerror:='Fondo de régimen pensionaria es cero';
          goto salida;
      end if;
      
      
      select coalesce(sum(importe),0) into l_importe_cal from VW_PLLA_PLANILLA_TRAB_DET 
      where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB
      and id_tipo_concepto='I'
      and coalesce(TRA_SNP,'0')='1';
      
      
      l_importe:= round(l_importe_cal*l_porc,2);
             
      PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            l_importe_cal,
            l_porc,
            0
        );
    end if;    
    <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_R_ONP;
  
  PROCEDURE SP_R_AFP_PRIMA_SEGURO(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;

  l_id_concepto_planilla number;
  l_id_persona number;
  l_id_entidad number;
  l_regimen_pensionaria varchar2(5);
  l_tipo varchar2(5);
  l_id_tipo_comision_pens number;
  l_porc number(10,3):=0;
  l_importe_cal number(10,2):=0;

  BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    select 

    b.id_persona,
    a.id_regimen_pensionaria,
    a.ID_TIPO_COMISION_PENS
    into 

    l_id_persona,
    l_regimen_pensionaria,
    l_id_tipo_comision_pens
    from moises.PERSONA_NATURAL_TRABAJADOR a,
    moises.trabajador b 
    where a.id_persona=b.id_persona
    and b.id_trabajador=l_id_trabajador;
    
    select id_concepto_planilla into l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
    
    select  count(*) into  l_contar from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PR','PU') ;
    if l_contar=0 then
        l_error:=1;
        l_msgerror:='No tiene asignado régimen pensionaria';
        goto salida;
    end if;
     
    select  tipo into  l_tipo from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PR','PU') ;
    
    if l_tipo='PR' then
      select count(*) into  l_contar from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;
      
      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Falta configurar régimen pensionaria para el periodo a procesar';
          goto salida;
      end if;
      
      select round((seguro/100.00),3) into  l_porc from enoc.plla_comision_pensionaria
      where id_regimen_pensionaria=l_regimen_pensionaria
      and id_anho=l_id_anho
      and id_mes=l_id_mes;
      
       if l_porc<=0 then
          l_error:=1;
          l_msgerror:='Seguro de régimen pensionaria es cero';
          goto salida;
      end if;
    
    
      select coalesce(sum(importe),0) into l_importe_cal from VW_PLLA_PLANILLA_TRAB_DET 
      where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB
      and id_tipo_concepto='I'
      and coalesce(TRA_SPP,'0')='1';
      
      l_importe:= round(l_importe_cal*l_porc,2);
     
      PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            l_importe_cal,
            l_porc,
            0
        );
     end if;
        
    <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_R_AFP_PRIMA_SEGURO;
  
  PROCEDURE SP_R_AFP_COMISION(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;

  l_id_concepto_planilla number;
  l_id_persona number;
  l_id_entidad number;
  l_regimen_pensionaria varchar2(5);
  l_tipo varchar2(5);
  l_id_tipo_comision_pens number;
  l_porc number(10,3):=0;
  l_importe_cal number(10,2):=0;

  BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    select 

    b.id_persona,
    a.id_regimen_pensionaria,
    a.ID_TIPO_COMISION_PENS
    into 

    l_id_persona,
    l_regimen_pensionaria,
    l_id_tipo_comision_pens
    from moises.PERSONA_NATURAL_TRABAJADOR a,
    moises.trabajador b 
    where a.id_persona=b.id_persona
    and b.id_trabajador=l_id_trabajador;
    
    select id_concepto_planilla into l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
    
    select  count(*) into  l_contar from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PR','PU') ;
    if l_contar=0 then
        l_error:=1;
        l_msgerror:='No tiene asignado régimen pensionaria';
        goto salida;
    end if;
     
    select  tipo into  l_tipo from  enoc.plla_regimen_pensionaria 
    where id_regimen_pensionaria=l_regimen_pensionaria
    and tipo in('PR','PU') ;
    
    if l_tipo='PR' then
      select count(*) into  l_contar from enoc.PLLA_REG_PENS_COMISION 
      where id_tipo_comision_pens= l_id_tipo_comision_pens
      and id_comision_pensionaria in(
        select id_comision_pensionaria from enoc.plla_comision_pensionaria
        where id_regimen_pensionaria=l_regimen_pensionaria
        and id_anho=l_id_anho
        and id_mes=l_id_mes
      );
      
      if l_contar=0 then
          l_error:=1;
          l_msgerror:='Falta configurar comisión de régimen pensionaria para el periodo a procesar';
          goto salida;
      end if;
      
      select round((COMISION_FLUJO/100.00),3) into  l_porc from enoc.PLLA_REG_PENS_COMISION 
      where id_tipo_comision_pens= l_id_tipo_comision_pens
      and id_comision_pensionaria in(
        select id_comision_pensionaria from enoc.plla_comision_pensionaria
        where id_regimen_pensionaria=l_regimen_pensionaria
        and id_anho=l_id_anho
        and id_mes=l_id_mes
      );
      
    
      select coalesce(sum(importe),0) into l_importe_cal from enoc.VW_PLLA_PLANILLA_TRAB_DET 
      where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB
      and id_tipo_concepto='I'
      and coalesce(TRA_SPP,'0')='1';
      
      l_importe:=round(l_importe_cal*l_porc,2);
     
      if l_importe>0 then
        PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
              P_ID_PLANILLA_TRAB,
              l_id_concepto_planilla,
              l_importe,
              l_num_dias,
              0,
              0,
              0,
              l_importe_cal,
              l_porc,
              0
          );
       end if;
     end if;
        
    <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_R_AFP_COMISION;
  
   PROCEDURE SP_A_ESSALUD(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;

  l_id_concepto_planilla number;
  l_id_persona number;
  l_id_entidad number;
  l_porc number(10,3):=0;
  l_importe_cal number(10,2):=0;

  BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    select 
    a.id_persona
    into 
    l_id_persona
    from moises.PERSONA_NATURAL_TRABAJADOR a,
    moises.trabajador b 
    where a.id_persona=b.id_persona
    and b.id_trabajador=l_id_trabajador;
    
    select id_concepto_planilla into l_id_concepto_planilla 
    from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
    where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
    
    select count(*) into  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_ESSALUD' and id_anho=l_id_anho;
    if l_contar=0 then
      l_error:=1;
      l_msgerror:='Falta configurar parametro ESSALUD';
      goto salida;
    end if;
    
    if l_contar>0 then
      select importe into l_porc from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_ESSALUD' and id_anho=l_id_anho;
    end if;
    
    if l_porc<=0 then
      l_error:=1;
      l_msgerror:='Parametro ESSALUD es cero';
      goto salida;
    end if;
         
    select coalesce(sum(importe),0) into l_importe_cal from enoc.VW_PLLA_PLANILLA_TRAB_DET 
    where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB
    and id_tipo_concepto='I'
    and coalesce(EMP_ESSALUD,'0')='1';
      
    l_importe:=round(l_importe_cal*l_porc,2);
     
      
    PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
          P_ID_PLANILLA_TRAB,
          l_id_concepto_planilla,
          l_importe,
          l_num_dias,
          0,
          0,
          0,
          l_importe_cal,
          l_porc,
          0
      );
      
    <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_A_ESSALUD;
  
  PROCEDURE SP_D_DONACION_DIEZMO_AUTOR(P_ID_PLANILLA_TRAB VARCHAR2,P_ID_CONFIG_PLANILLA_CONCEPTO number, P_IMPORTE OUT NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
  AS
  l_contar number;
  l_error number:=0;
  l_msgerror varchar2(200):='';
  l_importe number(10,2):=0;
  l_id_trabajador number;
  l_id_anho number;
  l_id_mes number;
  l_num_dias number;

  l_id_concepto_planilla number;
  l_id_persona number;
  l_id_entidad number;
  l_porc number(10,3):=0;
  l_importe_cal number(10,2):=0;
  l_descuentodiezmo varchar2(5);

  BEGIN
    select 
    id_trabajador,  id_anho,  id_mes,  coalesce(num_dias,0),id_entidad
    INTO
    l_id_trabajador,  l_id_anho,  l_id_mes,   l_num_dias,l_id_entidad
    FROM ENOC.VW_PLANILLA_TRAB
    WHERE ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB;
    
    select 
    b.id_persona,
    coalesce(b.descuentodiezmo,'N')
    into 
    l_id_persona,
    l_descuentodiezmo
    from moises.PERSONA_NATURAL_TRABAJADOR a,
    moises.trabajador b 
    where a.id_persona=b.id_persona
    and b.id_trabajador=l_id_trabajador;
    
    if l_descuentodiezmo = 'S' then
      select id_concepto_planilla into l_id_concepto_planilla 
      from ENOC.PLLA_CONFIG_PLANILLA_CONCEPTO 
      where ID_CONFIG_PLANILLA_CONCEPTO=P_ID_CONFIG_PLANILLA_CONCEPTO;
      
      select count(*) into  l_contar from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_DIEZMO' and id_anho=l_id_anho;
      if l_contar=0 then
        l_error:=1;
        l_msgerror:='Falta configurar parametro DIEZMO';
        goto salida;
      end if;
      
      if l_contar>0 then
        select importe into l_porc from ENOC.VW_PLLA_PARAMETROS_VALOR where id_entidad= l_id_entidad and codigo='PARAM_DIEZMO' and id_anho=l_id_anho;
      end if;
      
      if l_porc<=0 then
        l_error:=1;
        l_msgerror:='Parametro DIEZMO es cero';
        goto salida;
      end if;
           
      select coalesce(sum(importe),0) into l_importe_cal from enoc.VW_PLLA_PLANILLA_TRAB_DET 
      where ID_PLANILLA_TRAB=P_ID_PLANILLA_TRAB
      and id_tipo_concepto='I'
      and coalesce(DIEZMO,'0')='1';
        
      l_importe:=round(l_importe_cal*l_porc,2);
       
        
      PKG_PLANILLA.SP_INSMOD_PLANILLA_TRAB_DET(
            P_ID_PLANILLA_TRAB,
            l_id_concepto_planilla,
            l_importe,
            l_num_dias,
            0,
            0,
            0,
            l_importe_cal,
            l_porc,
            0
        );
    end if;  
    <<salida>>
    P_IMPORTE:=l_importe;
    P_ERROR:=l_error;
    P_MSGERROR:=l_msgerror;
  END SP_D_DONACION_DIEZMO_AUTOR;
 

END PKG_PLANILLA_PROC;