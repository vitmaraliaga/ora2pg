-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = moises,public;
\set ON_ERROR_STOP ON

CREATE OR REPLACE PACKAGE        PKG_PERSONA_UTIL
AS
FUNCTION PERSONA_TIPO_DOCUMENTO_DEFAULT(
      p_id_persona in NUMERIC
) return VARCHAR2;

FUNCTION PERSONA_NUM_DOCUMENTO_DEFAULT(
      p_id_persona in NUMERIC
) return VARCHAR2;
   
PROCEDURE SP_SYNC_PERSON_DOC_UNIFIED(
P_ID_PERSONA NUMBER,
P_ERROR OUT number,
P_MSGERROR out varchar2
);

END PKG_PERSONA_UTIL;


CREATE OR REPLACE PACKAGE BODY        PKG_PERSONA_UTIL
AS
FUNCTION PERSONA_TIPO_DOCUMENTO_DEFAULT(
      p_id_persona in NUMERIC
) return VARCHAR2
AS
BEGIN 
	NULL;
END PERSONA_TIPO_DOCUMENTO_DEFAULT;



FUNCTION PERSONA_NUM_DOCUMENTO_DEFAULT(
      p_id_persona in NUMERIC
) return VARCHAR2
AS 

BEGIN 

	NULL;
END PERSONA_NUM_DOCUMENTO_DEFAULT;

PROCEDURE SP_SYNC_PERSON_DOC_UNIFIED(P_ID_PERSONA NUMBER,P_ERROR OUT number,P_MSGERROR out varchar2)
      IS
      	L_ERROR NUMBER:=0;
		L_MSGERROR VARCHAR2(5000):='';
        L_CONTAR NUMBER;
       	L_DOCUMENTO_URL VARCHAR2(150):='';
       	L_DOCUMENTO_URL_OLD VARCHAR2(150):='';
       	L_ID_PERSONA_DOCUMENTO NUMBER;
        cursor CUR_DOCUMENTO is 
        select ID_DOCUMENTO,NOMBRE,CODIGO,QUERY  from MOISES.DOCUMENTO_UNIFICADO
        WHERE QUERY IS NOT NULL
       	ORDER BY ID_DOCUMENTO;
        
      BEGIN
     
        FOR DOC in CUR_DOCUMENTO LOOP
        BEGIN
	        BEGIN 
		     EXECUTE IMMEDIATE DOC.QUERY
		     INTO L_DOCUMENTO_URL USING P_ID_PERSONA;
		    EXCEPTION 
		    	WHEN OTHERS THEN
		    		L_ERROR := 1;
		    		L_MSGERROR := 'No se pudo sincronizar el documento '||DOC.NOMBRE;
		    		GOTO salida_val;
		    END;
		    
		    SELECT COUNT(*) INTO L_CONTAR FROM MOISES.PERSONA_DOCUMENTO_UNIFICADO WHERE ID_PERSONA = P_ID_PERSONA AND ID_DOCUMENTO = DOC.ID_DOCUMENTO;
		   
		   	IF L_CONTAR = 0 THEN 
		   		INSERT INTO MOISES.PERSONA_DOCUMENTO_UNIFICADO(ID_DOCUMENTO,ID_PERSONA,DOCUMENTO_URL,FECHA_REG,ESTADO)
		   		VALUES (DOC.ID_DOCUMENTO,P_ID_PERSONA,L_DOCUMENTO_URL,CURRENT_DATE,1);
		   	ELSE 
		   		SELECT ID_PERSONA_DOCUMENTO,DOCUMENTO_URL INTO L_ID_PERSONA_DOCUMENTO,L_DOCUMENTO_URL_OLD 
		   		FROM MOISES.PERSONA_DOCUMENTO_UNIFICADO WHERE ID_PERSONA = P_ID_PERSONA AND ID_DOCUMENTO = DOC.ID_DOCUMENTO;
		   	
		   		IF L_DOCUMENTO_URL_OLD <> L_DOCUMENTO_URL THEN 
		   			UPDATE MOISES.PERSONA_DOCUMENTO_UNIFICADO SET ESTADO = 0 WHERE ID_PERSONA = P_ID_PERSONA AND ID_DOCUMENTO = DOC.ID_DOCUMENTO;
		   			INSERT INTO MOISES.PERSONA_DOCUMENTO_UNIFICADO(ID_DOCUMENTO,ID_PERSONA,DOCUMENTO_URL,FECHA_REG,ESTADO)
		   			VALUES (DOC.ID_DOCUMENTO,P_ID_PERSONA,L_DOCUMENTO_URL,CURRENT_DATE,1);
		   		END IF;
		   	
		   	END IF;
		    
		    
        END;     
        END LOOP;
        
        <<salida_val>>
        P_ERROR:=L_ERROR;
        P_MSGERROR:=L_MSGERROR;
	END SP_SYNC_PERSON_DOC_UNIFIED;


END PKG_PERSONA_UTIL;