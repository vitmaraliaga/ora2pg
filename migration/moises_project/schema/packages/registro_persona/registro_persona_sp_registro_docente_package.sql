-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = moises,registro_persona,public;




CREATE OR REPLACE PROCEDURE moises.registro_persona_sp_registro_docente (P_ID_PERSONA bigint,P_NOMBRE text, P_PATERNO text, P_MATERNO text, P_EMAIL out text,P_REG_DOCENTE out bigint) AS $body$
DECLARE


    cod_acad varchar(100);
    cont_exi bigint;
    reg_doce bigint;

    has_cod bigint;
    has_dbl bigint;
    has_mail bigint;

    n_email varchar(200):='';

    
BEGIN
    
    select count(*) into STRICT has_cod from moises.persona where id_persona = P_ID_PERSONA and (codigo IS NOT NULL AND codigo::text <> '');

        if has_cod = 0 then
            -- select david.ft_new_codigo_acad(P_ID_PERSONA) into STRICT cod_acad;
            update moises.persona set codigo=cod_acad where id_persona=P_ID_PERSONA;
        else
            select codigo into STRICT cod_acad from moises.persona where id_persona = P_ID_PERSONA;
        end if;

    select count(*) into STRICT cont_exi from MOISES.persona_natural_docente where id_persona = P_ID_PERSONA;
        if cont_exi = 0 then
            update moises.persona set codigo=cod_acad where id_persona=P_ID_PERSONA;
            insert into moises.persona_natural_docente(
                id_persona,
                estado,
                codigo_acad
            ) values (
                P_ID_PERSONA,
                '1',
                cod_acad
            );
            reg_doce := 1;
        else
            update moises.persona_natural_docente set
                codigo_acad = cod_acad
            where id_persona = P_ID_PERSONA;
            reg_doce := 0;
        end if;
        /*
        select count(*) into has_dbl from DATOS_PERSONALES@DBL_NOE where CODIGO_PERSONAL = cod_acad;
        
        if has_dbl = 0 then
            INSERT INTO DATOS_PERSONALES@DBL_NOE(
                CODIGO_PERSONAL,
                DATO_APELLIDO_PATERNO,
                DATO_APELLIDO_MATERNO,
                DATO_NOMBRES,
                DOCUMENTOS_NACIONALIDAD,
                DOMICILIO_DIRECCION,
                DOCUMENTOS_CODUNIV
            ) VALUES (
                cod_acad,
                P_PATERNO,
                P_MATERNO,
                P_NOMBRE,
                'PE',
                '.',
                null
            );
        else
            UPDATE DATOS_PERSONALES@DBL_NOE set
                DATO_APELLIDO_PATERNO = P_PATERNO,
                DATO_APELLIDO_MATERNO = P_MATERNO,
                DATO_NOMBRES = P_NOMBRE
            where  CODIGO_PERSONAL = cod_acad;
        end if;
        */
        -- select count(*) into STRICT has_mail from eliseo.users where id=P_ID_PERSONA;
        if has_mail = 0 then
          n_email:='';
        --    select david.ft_newformat_users(P_ID_PERSONA) into STRICT n_email;
        else
            -- select email into STRICT n_email from eliseo.users where id=P_ID_PERSONA;
        end if;

        P_EMAIL :=n_email;
        P_REG_DOCENTE:=reg_doce;

    END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE moises.registro_persona_sp_registro_docente (P_ID_PERSONA bigint,P_NOMBRE text, P_PATERNO text, P_MATERNO text, P_EMAIL out text,P_REG_DOCENTE out bigint) FROM PUBLIC;
