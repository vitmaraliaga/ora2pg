-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = moises,persona_trabajador,public;

/* TODO enter package declarations (types, exceptions, methods etc) here */
 


CREATE OR REPLACE PROCEDURE persona_trabajador.sp_datos_personales ( P_ID_PERSONA bigint, P_NOMBRE text, P_PATERNO text, P_MATERNO text, P_SEXO text, P_FEC_NACIMIENTO timestamp(0), P_ID_TIPOESTADOCIVIL bigint, P_ID_TIPOPAIS bigint, P_ID_UBIGEO bigint, P_ID_TIPODOCUMENTO bigint, P_NUM_DOCUMENTO text, P_FEC_CADUCIDAD timestamp(0), P_ID_TIPOSANGRE bigint, P_TELEFONO text, P_CELULAR text, P_CORREO text, P_CORREO_INST text, P_IDTIPORELIGION bigint, P_ID_IGLESIA text, P_FECHA_BAUTIZO timestamp(0), P_TIENE_CARGO text, P_CARGO_IGLESIA text, P_ID_TIPOAUTORIDADIGLESIA bigint, P_NOMBRE_AUTORIDAD text, P_TLF_AUTORIDAD text, P_UNAPELLIDO text, P_ID_TIPO_IDENTIDAD_ETNICA bigint, P_EMERGENCIA_PERSONA text, P_EMERGENCIA_TLF text, P_FECHA_INGRESO text, P_ERROR OUT bigint,P_MSGERROR out text,P_ID_PERSONA_NEW out bigint ) AS $body$
DECLARE

  l_id_persona bigint;
  l_error bigint:=0;
  l_msgerror varchar(200):='';
  l_contar bigint;
  l_id_telefono bigint;
  l_id_virtual bigint;

  
BEGIN
     
        update persona set nombre=P_NOMBRE,paterno=P_PATERNO,materno=P_MATERNO,unapellido=P_UNAPELLIDO where id_persona=P_ID_PERSONA;
        l_id_persona:=P_ID_PERSONA;

        update persona_natural set
          SEXO                          =   P_SEXO,
          FEC_NACIMIENTO                =   P_FEC_NACIMIENTO,
          ID_TIPOESTADOCIVIL            =   P_ID_TIPOESTADOCIVIL,
          ID_TIPOPAIS                   =   P_ID_TIPOPAIS,
          ID_UBIGEO                     =   P_ID_UBIGEO,
          ID_TIPODOCUMENTO              =   P_ID_TIPODOCUMENTO, 
          NUM_DOCUMENTO                 =   P_NUM_DOCUMENTO, 
          FEC_CADUCIDAD                 =   P_FEC_CADUCIDAD, 
          TELEFONO                      =   P_TELEFONO, 
          CELULAR                       =   P_CELULAR,
          CORREO                        =   P_CORREO,
          CORREO_INST                   =   P_CORREO_INST,
          ID_TIPORELIGION               =   P_IDTIPORELIGION,
          ID_IGLESIA                    =   P_ID_IGLESIA,
          FECHA_BAUTIZO                 =   P_FECHA_BAUTIZO,
          TIENE_CARGO                   =   P_TIENE_CARGO,
          ID_TIPOSANGRE                 =   P_ID_TIPOSANGRE,
          CARGO_IGLESIA                 =   P_CARGO_IGLESIA,
          ID_TIPOAUTORIDADIGLESIA       =   P_ID_TIPOAUTORIDADIGLESIA,
          NOMBRE_AUTORIDAD              =   P_NOMBRE_AUTORIDAD,
          TLF_AUTORIDAD                 =   P_TLF_AUTORIDAD,
          ID_TIPO_IDENTIDAD_ETNICA      =   P_ID_TIPO_IDENTIDAD_ETNICA,
          EMERGENCIA_PERSONA            =   P_EMERGENCIA_PERSONA,
          EMERGENCIA_TLF                =   P_EMERGENCIA_TLF,
          FECHA_INGRESO                 =   P_FECHA_INGRESO
        WHERE ID_PERSONA=l_id_persona;

     --VERIFICAR TIPO DE DOCUMENTO
      select count(*) into STRICT l_contar from persona_documento where id_persona=l_id_persona and ID_TIPODOCUMENTO=P_ID_TIPODOCUMENTO and NUM_DOCUMENTO=P_NUM_DOCUMENTO;

      if l_contar=0 then
        insert into PERSONA_DOCUMENTO(
          ID_PERSONA ,
          ID_TIPODOCUMENTO,
          NUM_DOCUMENTO
        )values (
          l_id_persona,
          P_ID_TIPODOCUMENTO,
          P_NUM_DOCUMENTO
        );
      end if;
      --verifica persona telefono
      if P_CELULAR is not null then
        select count(*) into STRICT l_contar from PERSONA_TELEFONO where id_persona=l_id_persona and ID_TIPOTELEFONO=5 and NUM_TELEFONO=P_CELULAR;
        if l_contar=0 then
          select coalesce(max(id_telefono),0)+1 into STRICT l_id_telefono from  PERSONA_TELEFONO where id_persona=l_id_persona;
          insert into PERSONA_TELEFONO(
            ID_TELEFONO,
            ID_PERSONA,
            ID_TIPOTELEFONO,
            NUM_TELEFONO,
            ES_ACTIVO,
            ES_PRIVADO,
            GTH
          )values (
            l_id_telefono,
            l_id_persona,
            5,
            P_CELULAR,
            1,
            0,
            1
          );
        end if;
    end if;
    --verifica correo personal
    if P_CORREO is not null then
        select count(*) into STRICT l_contar from PERSONA_VIRTUAL where id_persona=l_id_persona and ID_TIPOVIRTUAL=1 and lower(DIRECCION)=lower(P_CORREO);

        if l_contar=0 then
          select coalesce(max(ID_VIRTUAL),0)+1 into STRICT l_id_virtual from  PERSONA_VIRTUAL where id_persona=l_id_persona;
          insert into PERSONA_VIRTUAL(
            ID_VIRTUAL,
            ID_PERSONA,
            ID_TIPOVIRTUAL,
            DIRECCION,
            GTH,
            ES_ACTIVO
          )values (
            l_id_virtual,
            l_id_persona,
            1,
            P_CORREO,
            1,
            1
          );
        end if;
    end if;

    --verifica correo institucional
    if P_CORREO_INST is not null then
        select count(*) into STRICT l_contar from PERSONA_VIRTUAL where id_persona=l_id_persona and ID_TIPOVIRTUAL=1 and lower(DIRECCION)=lower(P_CORREO_INST);

        if l_contar=0 then
          select coalesce(max(ID_VIRTUAL),0)+1 into STRICT l_id_virtual from  PERSONA_VIRTUAL where id_persona=l_id_persona;
          insert into PERSONA_VIRTUAL(
            ID_VIRTUAL,
            ID_PERSONA,
            ID_TIPOVIRTUAL,
            DIRECCION,
            GTH,
            ES_ACTIVO
          )values (
            l_id_virtual,
            l_id_persona,
            1,
            P_CORREO_INST,
            1,
            0
          );
        end if;
    end if;

     <<salida_final>>
     
     P_ID_PERSONA_NEW :=l_id_persona;

     P_ERROR:=l_error;
     P_MSGERROR:= l_msgerror;

  END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE persona_trabajador.sp_datos_personales ( P_ID_PERSONA bigint, P_NOMBRE text, P_PATERNO text, P_MATERNO text, P_SEXO text, P_FEC_NACIMIENTO timestamp(0), P_ID_TIPOESTADOCIVIL bigint, P_ID_TIPOPAIS bigint, P_ID_UBIGEO bigint, P_ID_TIPODOCUMENTO bigint, P_NUM_DOCUMENTO text, P_FEC_CADUCIDAD timestamp(0), P_ID_TIPOSANGRE bigint, P_TELEFONO text, P_CELULAR text, P_CORREO text, P_CORREO_INST text, P_IDTIPORELIGION bigint, P_ID_IGLESIA text, P_FECHA_BAUTIZO timestamp(0), P_TIENE_CARGO text, P_CARGO_IGLESIA text, P_ID_TIPOAUTORIDADIGLESIA bigint, P_NOMBRE_AUTORIDAD text, P_TLF_AUTORIDAD text, P_UNAPELLIDO text, P_ID_TIPO_IDENTIDAD_ETNICA bigint, P_EMERGENCIA_PERSONA text, P_EMERGENCIA_TLF text, P_FECHA_INGRESO text, P_ERROR OUT bigint,P_MSGERROR out text,P_ID_PERSONA_NEW out bigint ) FROM PUBLIC;
