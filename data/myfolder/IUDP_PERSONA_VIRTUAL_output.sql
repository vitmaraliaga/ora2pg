-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = moises,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE moises.iudp_persona_virtual (P_Modo text, P_ID_PERSONA integer, P_ID_VIRTUAL integer, P_ID_TIPOVIRTUAL integer DEFAULT NULL, P_DIRECCION text DEFAULT NULL, P_COMENTARIO text DEFAULT NULL) AS $body$
DECLARE

  S_bExiste varchar(1) := '0';
  S_ID_VIRTUAL integer;
  S_DIRECCION varchar(100);

BEGIN

  
  IF P_Modo = 0 THEN
    S_DIRECCION := trim(both coalesce(P_DIRECCION, ''));
    S_ID_VIRTUAL := trim(both coalesce(P_ID_VIRTUAL, ''));


    IF not(S_DIRECCION is null) THEN
      IF S_ID_VIRTUAL = 0 THEN
        SELECT 
          coalesce(max(ID_VIRTUAL),0) INTO STRICT S_ID_VIRTUAL
        FROM Persona_Virtual
        WHERE ID_PERSONA = P_ID_PERSONA
          AND ID_TIPOVIRTUAL = P_ID_TIPOVIRTUAL
          AND DIRECCION = S_DIRECCION;

        IF S_ID_VIRTUAL = 0 THEN
          SELECT
            MAX(ID_VIRTUAL) INTO STRICT S_ID_VIRTUAL
          FROM Persona_Virtual
          WHERE ID_PERSONA = P_ID_PERSONA;

          S_ID_VIRTUAL := coalesce(S_ID_VIRTUAL, 0) + 1;
          RAISE NOTICE '%', P_ID_PERSONA;
          RAISE NOTICE '%', P_ID_PERSONA;

          INSERT INTO Persona_Virtual(ID_PERSONA, ID_VIRTUAL, ID_TIPOVIRTUAL, DIRECCION, COMENTARIO)
            VALUES (P_ID_PERSONA, S_ID_VIRTUAL, P_ID_TIPOVIRTUAL, S_DIRECCION, P_COMENTARIO);
        ELSE
          S_bExiste := '1';
        END IF;

      ELSE 
        S_bExiste := '1';
      END IF;

      IF S_bExiste = 1 THEN
        UPDATE Persona_Virtual SET
          COMENTARIO = P_COMENTARIO
        WHERE ID_PERSONA = P_ID_PERSONA
        AND ID_VIRTUAL = S_ID_VIRTUAL;
      END IF;
    END IF;

  ELSE
    DELETE FROM Persona_Virtual WHERE ID_PERSONA = P_ID_PERSONA AND ID_VIRTUAL = S_ID_VIRTUAL;
  END IF;

END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE moises.iudp_persona_virtual (P_Modo text, P_ID_PERSONA integer, P_ID_VIRTUAL integer, P_ID_TIPOVIRTUAL integer DEFAULT NULL, P_DIRECCION text DEFAULT NULL, P_COMENTARIO text DEFAULT NULL) FROM PUBLIC;

