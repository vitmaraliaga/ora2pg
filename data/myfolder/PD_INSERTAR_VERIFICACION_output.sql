-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';

SET search_path = moises,public;
\set ON_ERROR_STOP ON





CREATE OR REPLACE PROCEDURE moises.pd_insertar_verificacion ( P_ID_PERSONA integer, P_VALOR text, P_ESTADO text, P_ID_USUARIO_REG integer, P_FECHA_REGISTRO timestamp(0), P_TIPO text, OUT CURSOR REFCURSOR ) AS $body$
DECLARE


p_res varchar(2);


BEGIN

    select coalesce(ft_verificacion(P_VALOR,'2'),'N') into STRICT p_res
;
    
    IF (SUBSTR(p_res,0,1)='S') THEN
      /*
      IF(SUBSTR(p_res,2)='0') THEN
      
       
        UPDATE VERIFICACION SET 
        ID_PERSONA=P_ID_PERSONA,
        ID_USUARIO_ACT=P_ID_USUARIO_REG,
        FECHA_ACTUALIZACION=P_FECHA_REGISTRO
        WHERE VALOR=P_VALOR;
      
        DBMS_OUTPUT.PUT_LINE('se va a actualizar el valor '||P_VALOR||' a la persona '||P_ID_PERSONA);
        
      ELSE
      
        DBMS_OUTPUT.PUT_LINE('El Valor enviado ya se ha registrado');
      
        
      END IF;*/
        INSERT INTO VERIFICACION(ID_PERSONA,VALOR,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO,TIPO)
        VALUES (P_ID_PERSONA,P_VALOR,P_ESTADO,P_ID_USUARIO_REG,P_FECHA_REGISTRO,P_TIPO);
    END IF;

    IF (SUBSTR(p_res,0,1)='N') THEN
    
      INSERT INTO VERIFICACION(ID_PERSONA,VALOR,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO,TIPO)
      VALUES (P_ID_PERSONA,P_VALOR,P_ESTADO,P_ID_USUARIO_REG,P_FECHA_REGISTRO,P_TIPO);

      RAISE NOTICE 'Se ingresar√° el Nuevo valor %', P_VALOR;

    END IF;

    --COMMIT;
    
    
    OPEN CURSOR FOR 
      SELECT ID_VERIFICACION,ID_PERSONA,VALOR,CODIGO_VERIFICACION,ESTADO,ID_USUARIO_REG,FECHA_REGISTRO,ID_USUARIO_ACT,FECHA_ACTUALIZACION,TIPO
      from verificacion 
      where VALOR=P_VALOR and ID_PERSONA = P_ID_PERSONA;

END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE moises.pd_insertar_verificacion ( P_ID_PERSONA integer, P_VALOR text, P_ESTADO text, P_ID_USUARIO_REG integer, P_FECHA_REGISTRO timestamp(0), P_TIPO text, OUT CURSOR REFCURSOR ) FROM PUBLIC;

