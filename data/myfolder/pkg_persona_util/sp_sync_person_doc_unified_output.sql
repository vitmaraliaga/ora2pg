-- Generated by Ora2Pg, the Oracle database Schema converter, version 25.0
-- Copyright 2000-2025 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=10.174.11.5;sid=upeu;port=1521

SET client_encoding TO 'UTF8';
SET search_path = moises,pkg_persona_util,public;




CREATE OR REPLACE PROCEDURE pkg_persona_util.sp_sync_person_doc_unified (P_ID_PERSONA bigint,P_ERROR OUT bigint,P_MSGERROR out text) AS $body$
DECLARE

      	L_ERROR bigint:=0;
		L_MSGERROR varchar(5000):='';
        L_CONTAR bigint;
       	L_DOCUMENTO_URL varchar(150):='';
       	L_DOCUMENTO_URL_OLD varchar(150):='';
       	L_ID_PERSONA_DOCUMENTO bigint;
        CUR_DOCUMENTO CURSOR FOR
        SELECT ID_DOCUMENTO,NOMBRE,CODIGO,QUERY  from MOISES.DOCUMENTO_UNIFICADO
        WHERE QUERY IS NOT NULL
       	ORDER BY ID_DOCUMENTO;

      
BEGIN
     
        FOR DOC in CUR_DOCUMENTO LOOP
        BEGIN
	        BEGIN 
		     EXECUTE DOC.QUERY
		     INTO STRICT L_DOCUMENTO_URL USING P_ID_PERSONA;
		    EXCEPTION
		    	WHEN OTHERS THEN
		    		L_ERROR := 1;
		    		L_MSGERROR := 'No se pudo sincronizar el documento '||DOC.NOMBRE;
		    		GOTO salida_val;
		    END;
		
		    SELECT COUNT(*) INTO STRICT L_CONTAR FROM MOISES.PERSONA_DOCUMENTO_UNIFICADO WHERE ID_PERSONA = P_ID_PERSONA AND ID_DOCUMENTO = DOC.ID_DOCUMENTO;
		
		   	IF L_CONTAR = 0 THEN 
		   		INSERT INTO MOISES.PERSONA_DOCUMENTO_UNIFICADO(ID_DOCUMENTO,ID_PERSONA,DOCUMENTO_URL,FECHA_REG,ESTADO)
		   		VALUES (DOC.ID_DOCUMENTO,P_ID_PERSONA,L_DOCUMENTO_URL,CURRENT_DATE,1);
		   	ELSE
		   		SELECT ID_PERSONA_DOCUMENTO,DOCUMENTO_URL INTO STRICT L_ID_PERSONA_DOCUMENTO,L_DOCUMENTO_URL_OLD 
		   		FROM MOISES.PERSONA_DOCUMENTO_UNIFICADO WHERE ID_PERSONA = P_ID_PERSONA AND ID_DOCUMENTO = DOC.ID_DOCUMENTO;
		   	
		   		IF L_DOCUMENTO_URL_OLD <> L_DOCUMENTO_URL THEN
		   			UPDATE MOISES.PERSONA_DOCUMENTO_UNIFICADO SET ESTADO = 0 WHERE ID_PERSONA = P_ID_PERSONA AND ID_DOCUMENTO = DOC.ID_DOCUMENTO;
		   			INSERT INTO MOISES.PERSONA_DOCUMENTO_UNIFICADO(ID_DOCUMENTO,ID_PERSONA,DOCUMENTO_URL,FECHA_REG,ESTADO)
		   			VALUES (DOC.ID_DOCUMENTO,P_ID_PERSONA,L_DOCUMENTO_URL,CURRENT_DATE,1);
		   		END IF;
		   	
		   	END IF;
		
		    
        END;
        END LOOP;

        <<salida_val>>
        P_ERROR:=L_ERROR;
        P_MSGERROR:=L_MSGERROR;
	END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE pkg_persona_util.sp_sync_person_doc_unified (P_ID_PERSONA bigint,P_ERROR OUT bigint,P_MSGERROR out text) FROM PUBLIC;
